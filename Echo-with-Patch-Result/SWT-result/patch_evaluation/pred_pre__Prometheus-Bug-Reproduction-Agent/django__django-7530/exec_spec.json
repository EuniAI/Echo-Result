{"instance_id": "django__django-7530", "repo": "django/django", "version": "1.11", "environment_setup_commit": "3545e844885608932a692d952c12cd863e2320b5", "patch_list": ["diff --git a/tests/migrations/test_makemigrations_consistency_check.py b/tests/migrations/test_makemigrations_consistency_check.py\nnew file mode 100644\nindex 0000000000..1e66729192\n--- /dev/null\n+++ b/tests/migrations/test_makemigrations_consistency_check.py\n@@ -0,0 +1,58 @@\n+from io import StringIO\n+from unittest import mock\n+\n+from django.apps import apps\n+from django.conf import settings\n+from django.core.management import call_command\n+from django.db import connections\n+from django.test import TestCase\n+\n+\n+class TestMakemigrationsConsistencyCheck(TestCase):\n+    \"\"\"\n+    This test is a standalone reproduction of a bug related to the\n+    number of times allow_migrate() is called by makemigrations.\n+    The original code was intended to be a method on the\n+    `MakeMigrationsTests` class in `tests/migrations/test_commands.py`.\n+    \"\"\"\n+\n+    def test_makemigrations_consistency_check_call_count(self):\n+        \"\"\"\n+        The history consistency checks in makemigrations should call\n+        router.allow_migrate() once per model, not once per model per app.\n+        \"\"\"\n+        app_labels = ['django.contrib.auth', 'django.contrib.contenttypes']\n+        with self.settings(\n+            DATABASES={\n+                'default': {\n+                    'ENGINE': 'django.db.backends.sqlite3',\n+                    'NAME': ':memory:',\n+                },\n+            },\n+            INSTALLED_APPS=app_labels,\n+            # This specific router's allow_migrate() method always returns\n+            # False, which is crucial for forcing the `any()` generator in\n+            # `makemigrations` to be fully consumed, thus exposing the bug.\n+            DATABASE_ROUTERS=['migrations.test_multidb.MigrateNothingRouter'],\n+        ):\n+            allow_migrate_path = 'migrations.test_multidb.MigrateNothingRouter.allow_migrate'\n+            # The router already returns False, but patching allows us to spy on it.\n+            with mock.patch(allow_migrate_path, return_value=False) as allow_migrate:\n+                call_command('makemigrations', stdout=StringIO())\n+\n+                # The check is run for each database that isn't a dummy DB.\n+                db_count = 0\n+                for alias in settings.DATABASES:\n+                    if connections[alias].settings_dict['ENGINE'] != 'django.db.backends.dummy':\n+                        db_count += 1\n+\n+                # Calculate the total number of models across all configured apps.\n+                # This is the expected number of calls for the *correct* code.\n+                model_count = len(apps.get_models())\n+                expected_call_count = model_count * db_count\n+\n+                # The buggy code will have a call count of roughly\n+                # (len(app_labels) * model_count * db_count), which will fail this\n+                # assertion. For example, if there are 4 models and 2 apps, the\n+                # buggy code makes 8 calls, not 4.\n+                self.assertEqual(allow_migrate.call_count, expected_call_count)\n"], "arch": "x86_64", "base_commit": "f8fab6f90233c7114d642dfe01a4e6d4cb14ee7d", "test_directives": ["migrations.test_makemigrations_consistency_check"], "coverage_files": ["django/core/management/commands/makemigrations.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.5", "packages": "requirements.txt", "pre_install": ["apt-get update && apt-get install -y locales", "echo 'en_US UTF-8' > /etc/locale.gen", "locale-gen en_US.UTF-8"], "install": "python setup.py install", "pip_packages": ["setuptools"], "eval_commands": ["export LANG=en_US.UTF-8", "export LC_ALL=en_US.UTF-8", "export PYTHONIOENCODING=utf8", "export LANGUAGE=en_US:en"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/core/management/commands/makemigrations\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_makemigrations_consistency_check", "req_install_commands": ["conda create -n testbed python=3.5 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nargon2-cffi >= 16.1.0\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow\nPyYAML\npylibmc; sys.platform != 'win32'\npytz\nselenium\nsqlparse\ntblib\n\npython3-memcached\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}