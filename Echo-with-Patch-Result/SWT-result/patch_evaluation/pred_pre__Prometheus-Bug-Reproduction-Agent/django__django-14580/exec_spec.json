{"instance_id": "django__django-14580", "repo": "django/django", "version": "4.0", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "patch_list": ["diff --git a/django/db/migrations/tests/test_writer_bug.py b/django/db/migrations/tests/test_writer_bug.py\nnew file mode 100644\nindex 0000000000..aab2e392c2\n--- /dev/null\n+++ b/django/db/migrations/tests/test_writer_bug.py\n@@ -0,0 +1,51 @@\n+import sys\n+from django.db import migrations, models\n+from django.db.migrations.writer import MigrationWriter\n+from django.test import SimpleTestCase\n+\n+# Define a mixin class directly in the test module to ensure the test is\n+# self-contained and avoids any ModuleNotFoundError issues.\n+# We also need to add it to sys.modules so the `exec` in the test can find it.\n+class MyMixin:\n+    pass\n+\n+sys.modules['migrations.test_writer_bug'] = sys.modules[__name__]\n+\n+class MigrationWriterNameErrorTest(SimpleTestCase):\n+    def test_create_model_with_mixin_and_model_base(self):\n+        \"\"\"\n+        Tests that a CreateModel operation with `models.Model` in a `bases`\n+        tuple generates a valid, executable migration.\n+\n+        The bug is that `models.Model` is serialized without its required\n+        import, leading to a NameError when the migration file is executed.\n+        \"\"\"\n+        operation = migrations.CreateModel(\n+            name='MyModel',\n+            fields=[],  # No fields are needed to reproduce the bug.\n+            bases=(MyMixin, models.Model),\n+        )\n+        migration = type('Migration', (migrations.Migration,), {\n+            'app_label': 'migrations',\n+            'operations': [operation],\n+            'dependencies': [],\n+        })\n+\n+        writer = MigrationWriter(migration)\n+        output = writer.as_string()\n+\n+        # Execute the generated migration code in an empty scope.\n+        # On the buggy version, this will fail with a NameError because\n+        # 'models' is not defined.\n+        # On the fixed version, the import will be present and it will pass.\n+        scope = {}\n+        try:\n+            exec(output, scope)\n+        except NameError:\n+            self.fail(\n+                \"Executing the generated migration failed with a NameError. \"\n+                \"This confirms the bug where 'models.Model' is used in `bases` \"\n+                \"without the corresponding 'models' import.\"\n+            )\n+        # A minimal assertion to confirm the migration class was created in the scope.\n+        self.assertIn('Migration', scope)\n"], "arch": "x86_64", "base_commit": "36fa071d6ebd18a61c4d7f1b5c9d17106134bd44", "test_directives": ["django.db.migrations.tests.test_writer_bug"], "coverage_files": ["django/db/migrations/serializer.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.8", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/serializer\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 django.db.migrations.tests.test_writer_bug", "req_install_commands": ["conda create -n testbed python=3.8 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}