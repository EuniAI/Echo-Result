{"instance_id": "django__django-16333", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/tests/test_m2m_user_creation_form.py b/tests/test_m2m_user_creation_form.py\nnew file mode 100644\nindex 0000000000..c60f888a34\n--- /dev/null\n+++ b/tests/test_m2m_user_creation_form.py\n@@ -0,0 +1,80 @@\n+from django import forms\n+from django.contrib.auth.forms import UserCreationForm\n+from django.contrib.auth.models import AbstractUser, Group, Permission\n+from django.db import models\n+from django.test import TestCase, override_settings\n+\n+\n+# Models required for the test\n+class Organization(models.Model):\n+    name = models.CharField(max_length=255)\n+\n+    class Meta:\n+        app_label = \"auth\"\n+\n+    def __str__(self):\n+        return self.name\n+\n+\n+class CustomUserWithM2M(AbstractUser):\n+    # Redefine groups and user_permissions to avoid clashes with the default\n+    # User model when running tests.\n+    groups = models.ManyToManyField(\n+        Group,\n+        verbose_name=\"groups\",\n+        blank=True,\n+        help_text=(\n+            \"The groups this user belongs to. A user will get all permissions \"\n+            \"granted to each of their groups.\"\n+        ),\n+        related_name=\"customuserwithm2m_set\",\n+        related_query_name=\"user\",\n+    )\n+    user_permissions = models.ManyToManyField(\n+        Permission,\n+        verbose_name=\"user permissions\",\n+        blank=True,\n+        help_text=\"Specific permissions for this user.\",\n+        related_name=\"customuserwithm2m_permissions_set\",\n+        related_query_name=\"user\",\n+    )\n+    orgs = models.ManyToManyField(Organization, blank=True)\n+\n+    class Meta:\n+        app_label = \"auth\"\n+\n+\n+# The custom UserCreationForm for the custom user model\n+class M2MUserCreationForm(UserCreationForm):\n+    class Meta(UserCreationForm.Meta):\n+        model = CustomUserWithM2M\n+        fields = (\"username\", \"orgs\")\n+\n+\n+@override_settings(AUTH_USER_MODEL=\"auth.CustomUserWithM2M\")\n+class UserCreationFormM2MTest(TestCase):\n+    \"\"\"\n+    Tests for UserCreationForm with ManyToManyFields.\n+    \"\"\"\n+\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.org1 = Organization.objects.create(name=\"Organization 1\")\n+        cls.org2 = Organization.objects.create(name=\"Organization 2\")\n+\n+    def test_user_creation_with_m2m_save(self):\n+        \"\"\"\n+        A custom UserCreationForm with a ManyToManyField should save the\n+        m2m data when the form is saved.\n+        \"\"\"\n+        data = {\n+            \"username\": \"newuser\",\n+            \"password1\": \"password123\",\n+            \"password2\": \"password123\",\n+            \"orgs\": [self.org1.pk, self.org2.pk],\n+        }\n+        form = M2MUserCreationForm(data)\n+        self.assertTrue(form.is_valid(), form.errors)\n+        user = form.save()\n+        # The m2m relations should be saved. This fails if save_m2m() isn't called.\n+        self.assertCountEqual(user.orgs.all(), [self.org1, self.org2])\n"], "arch": "x86_64", "base_commit": "60a7bd89860e504c0c33b02c78edcac87f6d1b5a", "test_directives": ["test_m2m_user_creation_form"], "coverage_files": ["django/contrib/auth/forms.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/auth/forms\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 test_m2m_user_creation_form", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}