{"instance_id": "django__django-16527", "repo": "django/django", "version": "5.0", "environment_setup_commit": "4a72da71001f154ea60906a2f74898d32b7322a7", "patch_list": ["diff --git a/tests/admin_views/test_save_as_new_bug.py b/tests/admin_views/test_save_as_new_bug.py\nnew file mode 100644\nindex 0000000000..d1e75ed2e5\n--- /dev/null\n+++ b/tests/admin_views/test_save_as_new_bug.py\n@@ -0,0 +1,222 @@\n+import datetime\n+\n+from django.contrib.admin import ModelAdmin\n+from django.contrib.admin.templatetags.admin_list import date_hierarchy\n+from django.contrib.admin.templatetags.admin_modify import submit_row\n+from django.contrib.auth.admin import UserAdmin\n+from django.contrib.auth.models import User\n+from django.test import RequestFactory, TestCase\n+from django.urls import reverse\n+\n+from .admin import ArticleAdmin, site\n+from .models import Article, Question\n+from .tests import AdminViewBasicTestCase\n+\n+\n+class AdminTemplateTagsTest(AdminViewBasicTestCase):\n+    request_factory = RequestFactory()\n+\n+    def test_submit_row(self):\n+        \"\"\"\n+        submit_row template tag should pass whole context.\n+        \"\"\"\n+        request = self.request_factory.get(\n+            reverse(\"admin:auth_user_change\", args=[self.superuser.pk])\n+        )\n+        request.user = self.superuser\n+        admin = UserAdmin(User, site)\n+        extra_context = {\"extra\": True}\n+        response = admin.change_view(\n+            request, str(self.superuser.pk), extra_context=extra_context\n+        )\n+        template_context = submit_row(response.context_data)\n+        self.assertIs(template_context[\"extra\"], True)\n+        self.assertIs(template_context[\"show_save\"], True)\n+\n+    def test_show_save_as_new_without_add_permission(self):\n+        \"\"\"\n+        The \"Save as new\" button isn't displayed if the user doesn't have\n+        the 'add' permission.\n+        \"\"\"\n+        # This context simulates the change form of a model with save_as=True,\n+        # for a user with change permission but no add permission.\n+        context = {\n+            \"add\": False,\n+            \"change\": True,\n+            \"is_popup\": False,\n+            \"save_as\": True,\n+            \"has_add_permission\": False,\n+            \"has_change_permission\": True,\n+            \"has_view_permission\": True,\n+            \"has_delete_permission\": True,\n+            \"has_editable_inline_admin_formsets\": False,\n+        }\n+        template_context = submit_row(context)\n+        self.assertIs(template_context[\"show_save_as_new\"], False)\n+\n+    def test_override_show_save_and_add_another(self):\n+        request = self.request_factory.get(\n+            reverse(\"admin:auth_user_change\", args=[self.superuser.pk]),\n+        )\n+        request.user = self.superuser\n+        admin = UserAdmin(User, site)\n+        for extra_context, expected_flag in (\n+            ({}, True),  # Default.\n+            ({\"show_save_and_add_another\": False}, False),\n+        ):\n+            with self.subTest(show_save_and_add_another=expected_flag):\n+                response = admin.change_view(\n+                    request,\n+                    str(self.superuser.pk),\n+                    extra_context=extra_context,\n+                )\n+                template_context = submit_row(response.context_data)\n+                self.assertIs(\n+                    template_context[\"show_save_and_add_another\"], expected_flag\n+                )\n+\n+    def test_override_change_form_template_tags(self):\n+        \"\"\"\n+        admin_modify template tags follow the standard search pattern\n+        admin/app_label/model/template.html.\n+        \"\"\"\n+        article = Article.objects.all()[0]\n+        request = self.request_factory.get(\n+            reverse(\"admin:admin_views_article_change\", args=[article.pk])\n+        )\n+        request.user = self.superuser\n+        admin = ArticleAdmin(Article, site)\n+        extra_context = {\"show_publish\": True, \"extra\": True}\n+        response = admin.change_view(\n+            request, str(article.pk), extra_context=extra_context\n+        )\n+        response.render()\n+        self.assertIs(response.context_data[\"show_publish\"], True)\n+        self.assertIs(response.context_data[\"extra\"], True)\n+        self.assertContains(response, 'name=\"_save\"')\n+        self.assertContains(response, 'name=\"_publish\"')\n+        self.assertContains(response, \"override-change_form_object_tools\")\n+        self.assertContains(response, \"override-prepopulated_fields_js\")\n+\n+    def test_override_change_list_template_tags(self):\n+        \"\"\"\n+        admin_list template tags follow the standard search pattern\n+        admin/app_label/model/template.html.\n+        \"\"\"\n+        request = self.request_factory.get(\n+            reverse(\"admin:admin_views_article_changelist\")\n+        )\n+        request.user = self.superuser\n+        admin = ArticleAdmin(Article, site)\n+        admin.date_hierarchy = \"date\"\n+        admin.search_fields = (\"title\", \"content\")\n+        response = admin.changelist_view(request)\n+        response.render()\n+        self.assertContains(response, \"override-actions\")\n+        self.assertContains(response, \"override-change_list_object_tools\")\n+        self.assertContains(response, \"override-change_list_results\")\n+        self.assertContains(response, \"override-date_hierarchy\")\n+        self.assertContains(response, \"override-pagination\")\n+        self.assertContains(response, \"override-search_form\")\n+\n+\n+class DateHierarchyTests(TestCase):\n+    factory = RequestFactory()\n+\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.superuser = User.objects.create_superuser(\n+            username=\"super\", password=\"secret\", email=\"super@example.com\"\n+        )\n+\n+    def test_choice_links(self):\n+        modeladmin = ModelAdmin(Question, site)\n+        modeladmin.date_hierarchy = \"posted\"\n+\n+        posted_dates = (\n+            datetime.date(2017, 10, 1),\n+            datetime.date(2017, 10, 1),\n+            datetime.date(2017, 12, 15),\n+            datetime.date(2017, 12, 15),\n+            datetime.date(2017, 12, 31),\n+            datetime.date(2018, 2, 1),\n+        )\n+        Question.objects.bulk_create(\n+            Question(question=\"q\", posted=posted) for posted in posted_dates\n+        )\n+\n+        tests = (\n+            ({}, [[\"year=2017\"], [\"year=2018\"]]),\n+            ({\"year\": 2016}, []),\n+            ({\"year\": 2017}, [[\"month=10\", \"year=2017\"], [\"month=12\", \"year=2017\"]]),\n+            ({\"year\": 2017, \"month\": 9}, []),\n+            (\n+                {\"year\": 2017, \"month\": 12},\n+                [\n+                    [\"day=15\", \"month=12\", \"year=2017\"],\n+                    [\"day=31\", \"month=12\", \"year=2017\"],\n+                ],\n+            ),\n+        )\n+        for query, expected_choices in tests:\n+            with self.subTest(query=query):\n+                query = {\"posted__%s\" % q: val for q, val in query.items()}\n+                request = self.factory.get(\"/\", query)\n+                request.user = self.superuser\n+                changelist = modeladmin.get_changelist_instance(request)\n+                spec = date_hierarchy(changelist)\n+                choices = [choice[\"link\"] for choice in spec[\"choices\"]]\n+                expected_choices = [\n+                    \"&\".join(\"posted__%s\" % c for c in choice)\n+                    for choice in expected_choices\n+                ]\n+                expected_choices = [\n+                    (\"?\" + choice) if choice else \"\" for choice in expected_choices\n+                ]\n+                self.assertEqual(choices, expected_choices)\n+\n+    def test_choice_links_datetime(self):\n+        modeladmin = ModelAdmin(Question, site)\n+        modeladmin.date_hierarchy = \"expires\"\n+        Question.objects.bulk_create(\n+            [\n+                Question(question=\"q1\", expires=datetime.datetime(2017, 10, 1)),\n+                Question(question=\"q2\", expires=datetime.datetime(2017, 10, 1)),\n+                Question(question=\"q3\", expires=datetime.datetime(2017, 12, 15)),\n+                Question(question=\"q4\", expires=datetime.datetime(2017, 12, 15)),\n+                Question(question=\"q5\", expires=datetime.datetime(2017, 12, 31)),\n+                Question(question=\"q6\", expires=datetime.datetime(2018, 2, 1)),\n+            ]\n+        )\n+        tests = [\n+            ({}, [[\"year=2017\"], [\"year=2018\"]]),\n+            ({\"year\": 2016}, []),\n+            (\n+                {\"year\": 2017},\n+                [\n+                    [\"month=10\", \"year=2017\"],\n+                    [\"month=12\", \"year=2017\"],\n+                ],\n+            ),\n+            ({\"year\": 2017, \"month\": 9}, []),\n+            (\n+                {\"year\": 2017, \"month\": 12},\n+                [\n+                    [\"day=15\", \"month=12\", \"year=2017\"],\n+                    [\"day=31\", \"month=12\", \"year=2017\"],\n+                ],\n+            ),\n+        ]\n+        for query, expected_choices in tests:\n+            with self.subTest(query=query):\n+                query = {\"expires__%s\" % q: val for q, val in query.items()}\n+                request = self.factory.get(\"/\", query)\n+                request.user = self.superuser\n+                changelist = modeladmin.get_changelist_instance(request)\n+                spec = date_hierarchy(changelist)\n+                choices = [choice[\"link\"] for choice in spec[\"choices\"]]\n+                expected_choices = [\n+                    \"?\" + \"&\".join(\"expires__%s\" % c for c in choice)\n+                    for choice in expected_choices\n+                ]\n+                self.assertEqual(choices, expected_choices)\n"], "arch": "x86_64", "base_commit": "bd366ca2aeffa869b7dbc0b0aa01caea75e6dc31", "test_directives": ["admin_views.test_save_as_new_bug"], "coverage_files": ["django/contrib/admin/templatetags/admin_modify.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.11", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/admin/templatetags/admin_modify\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 admin_views.test_save_as_new_bug", "req_install_commands": ["conda create -n testbed python=3.11 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.7.0\nargon2-cffi >= 19.2.0\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium >= 4.8.0\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}