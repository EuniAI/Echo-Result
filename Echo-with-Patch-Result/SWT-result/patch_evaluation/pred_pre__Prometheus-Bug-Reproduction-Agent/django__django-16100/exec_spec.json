{"instance_id": "django__django-16100", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/admin_views/test_list_editable_transactions.py b/admin_views/test_list_editable_transactions.py\nnew file mode 100644\nindex 0000000000..2c739b70b6\n--- /dev/null\n+++ b/admin_views/test_list_editable_transactions.py\n@@ -0,0 +1,81 @@\n+from unittest.mock import patch\n+\n+from django.contrib.auth.models import User\n+from django.test import TransactionTestCase, override_settings\n+from django.urls import reverse\n+\n+from .admin import PersonAdmin\n+from .models import Person\n+\n+\n+@override_settings(ROOT_URLCONF=\"admin_views.urls\", USE_TZ=False)\n+class ListEditableTransactionTests(TransactionTestCase):\n+    \"\"\"\n+    Tests that list_editable saves are wrapped in a transaction.\n+    This test is designed to be placed within the 'admin_views' test suite.\n+    \"\"\"\n+\n+    # This attribute is required for TransactionTestCase to set up the\n+    # test database. It lists all apps whose models are needed, resolving\n+    # potential AppRegistryNotReady errors by ensuring a complete environment.\n+    available_apps = [\n+        \"django.contrib.admin\",\n+        \"django.contrib.auth\",\n+        \"django.contrib.contenttypes\",\n+        \"django.contrib.sessions\",\n+        \"django.contrib.messages\",\n+        \"django.contrib.staticfiles\",\n+        \"admin_views\",\n+    ]\n+    serializable_rollback = True\n+\n+    def setUp(self):\n+        self.superuser = User.objects.create_superuser(\n+            \"super\", \"super@example.com\", \"secret\"\n+        )\n+        self.client.force_login(self.superuser)\n+        # The PersonAdmin is ordered by 'age', ensuring p1 is processed first.\n+        self.p1 = Person.objects.create(name=\"Person 1\", gender=1, alive=True, age=30)\n+        self.p2 = Person.objects.create(name=\"Person 2\", gender=1, alive=True, age=40)\n+\n+    def test_list_editable_transaction_rolls_back_on_error(self):\n+        \"\"\"\n+        A failure when saving one object in a list_editable changelist should\n+        roll back the entire transaction.\n+        \"\"\"\n+        original_save_model = PersonAdmin.save_model\n+\n+        def mock_save_model(admin_instance, request, obj, form, change):\n+            if obj.pk == self.p2.pk:\n+                # Simulate an error on the second object.\n+                raise ValueError(\"This is an intentional error.\")\n+            # Call the original method for the first object.\n+            original_save_model(admin_instance, request, obj, form, change)\n+\n+        # Form data attempts to set both people to not alive, as the 'alive'\n+        # checkbox is not submitted for either.\n+        post_data = {\n+            \"form-TOTAL_FORMS\": \"2\",\n+            \"form-INITIAL_FORMS\": \"2\",\n+            \"form-MAX_NUM_FORMS\": \"0\",\n+            \"_save\": \"Save\",\n+            \"form-0-id\": str(self.p1.pk),\n+            \"form-0-gender\": str(self.p1.gender),\n+            \"form-1-id\": str(self.p2.pk),\n+            \"form-1-gender\": str(self.p2.gender),\n+        }\n+        changelist_url = reverse(\"admin:admin_views_person_changelist\")\n+\n+        with patch.object(\n+            PersonAdmin, \"save_model\", side_effect=mock_save_model, autospec=True\n+        ):\n+            with self.assertRaisesMessage(ValueError, \"This is an intentional error.\"):\n+                self.client.post(changelist_url, post_data)\n+\n+        self.p1.refresh_from_db()\n+\n+        # Before patch: The save of p1 is committed, p1.alive becomes False.\n+        # This assertion will fail, correctly identifying the bug.\n+        # After patch: The transaction is rolled back, p1.alive remains True.\n+        # This assertion will pass, verifying the fix.\n+        self.assertTrue(self.p1.alive)\n"], "arch": "x86_64", "base_commit": "c6350d594c359151ee17b0c4f354bb44f28ff69e", "test_directives": ["admin_views.test_list_editable_transactions"], "coverage_files": ["django/contrib/admin/options.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/admin/options\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 admin_views.test_list_editable_transactions", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}