{"instance_id": "django__django-12774", "repo": "django/django", "version": "3.1", "environment_setup_commit": "0668164b4ac93a5be79f5b87fae83c657124d9ab", "patch_list": ["diff --git a/django/db/models/query.py b/django/db/models/query.py\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -689,7 +689,17 @@ def in_bulk(self, id_list=None, *, field_name='pk'):\n         \"\"\"\n         assert not self.query.is_sliced, \\\n             \"Cannot use 'limit' or 'offset' with in_bulk\"\n-        if field_name != 'pk' and not self.model._meta.get_field(field_name).unique:\n+        opts = self.model._meta\n+        unique_fields = [\n+            constraint.fields[0]\n+            for constraint in opts.total_unique_constraints\n+            if len(constraint.fields) == 1\n+        ]\n+        if (\n+            field_name != 'pk' and\n+            not opts.get_field(field_name).unique and\n+            field_name not in unique_fields\n+        ):\n             raise ValueError(\"in_bulk()'s field_name must be a unique field but %r isn't.\" % field_name)\n         if id_list is not None:\n             if not id_list:\n", "diff --git a/tests/queries/test_ticket_29705.py b/tests/queries/test_ticket_29705.py\nnew file mode 100644\nindex 0000000000..6b6855f617\n--- /dev/null\n+++ b/tests/queries/test_ticket_29705.py\n@@ -0,0 +1,42 @@\n+from django.db import models\n+from django.test import TestCase\n+\n+\n+class ArticleFor29705(models.Model):\n+    \"\"\"\n+    A model with a UniqueConstraint on a field, but without `unique=True`.\n+    This is used to test the fix for ticket #29705.\n+    \"\"\"\n+    slug = models.CharField(max_length=255)\n+\n+    class Meta:\n+        # Assign to an existing app from the test suite to ensure it's picked up.\n+        app_label = 'queries'\n+        constraints = [\n+            models.UniqueConstraint(fields=['slug'], name='queries_articlefor29705_slug_unq'),\n+        ]\n+\n+\n+class InBulkWithUniqueConstraintTest(TestCase):\n+    \"\"\"\n+    Tests for QuerySet.in_bulk() with a UniqueConstraint.\n+    \"\"\"\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.article = ArticleFor29705.objects.create(slug='test-slug-29705')\n+\n+    def test_in_bulk_on_field_with_unique_constraint(self):\n+        \"\"\"\n+        in_bulk() should work on a field that has a UniqueConstraint,\n+        even if the field itself doesn't have `unique=True`.\n+        \"\"\"\n+        # Before the fix, this call raises a ValueError because 'slug' is not\n+        # considered unique. The test is expected to fail with this unhandled\n+        # exception, which correctly demonstrates the bug.\n+        # After the fix is applied, this line should execute without error.\n+        articles = ArticleFor29705.objects.in_bulk(field_name='slug')\n+\n+        # These assertions will only be reached if the ValueError is not raised.\n+        # They verify that the bug is fixed and the method returns the correct result.\n+        self.assertIn('test-slug-29705', articles)\n+        self.assertEqual(articles['test-slug-29705'].pk, self.article.pk)\n"], "arch": "x86_64", "base_commit": "67f9d076cfc1858b94f9ed6d1a5ce2327dcc8d0d", "test_directives": ["queries.test_ticket_29705"], "coverage_files": ["django/db/models/query.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/models/query\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 queries.test_ticket_29705", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.2\nargon2-cffi >= 16.1.0\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}