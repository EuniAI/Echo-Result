{"instance_id": "django__django-14855", "repo": "django/django", "version": "4.0", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "patch_list": ["diff --git a/django/contrib/admin/helpers.py b/django/contrib/admin/helpers.py\n--- a/django/contrib/admin/helpers.py\n+++ b/django/contrib/admin/helpers.py\n@@ -209,7 +209,11 @@ def get_admin_url(self, remote_field, remote_obj):\n             remote_field.model._meta.model_name,\n         )\n         try:\n-            url = reverse(url_name, args=[quote(remote_obj.pk)])\n+            url = reverse(\n+                url_name,\n+                args=[quote(remote_obj.pk)],\n+                current_app=self.model_admin.admin_site.name,\n+            )\n             return format_html('<a href=\"{}\">{}</a>', url, remote_obj)\n         except NoReverseMatch:\n             return str(remote_obj)\n", "diff --git a/tests/test_readonly_fk_custom_admin.py b/tests/test_readonly_fk_custom_admin.py\nnew file mode 100644\nindex 0000000000..35c313165e\n--- /dev/null\n+++ b/tests/test_readonly_fk_custom_admin.py\n@@ -0,0 +1,120 @@\n+from django.contrib import admin\n+from django.contrib.auth.models import User\n+from django.db import models\n+from django.test import TestCase, override_settings\n+from django.urls import path, reverse\n+\n+# Models for test. Using 'auth' as app_label to ensure models are created\n+# by the test runner without needing a separate app.\n+class Book(models.Model):\n+    name = models.CharField(max_length=100)\n+\n+    class Meta:\n+        app_label = 'auth'\n+\n+    def __str__(self):\n+        return self.name\n+\n+class Chapter(models.Model):\n+    title = models.CharField(max_length=100)\n+    book = models.ForeignKey(Book, on_delete=models.CASCADE)\n+\n+    class Meta:\n+        app_label = 'auth'\n+\n+    def __str__(self):\n+        return self.title\n+\n+class ReadOnlyFKModel(models.Model):\n+    chapter = models.ForeignKey(Chapter, on_delete=models.CASCADE)\n+    name = models.CharField(max_length=100)\n+\n+    class Meta:\n+        app_label = 'auth'\n+        verbose_name = 'Read-only FK Model'\n+\n+\n+# Admin classes for the models\n+class BookAdmin(admin.ModelAdmin):\n+    pass\n+\n+class ChapterAdmin(admin.ModelAdmin):\n+    pass\n+\n+class ReadOnlyFKModelAdmin(admin.ModelAdmin):\n+    readonly_fields = ('chapter',)\n+\n+\n+# A custom admin site is instantiated to test namespaced URLs.\n+custom_admin_site = admin.AdminSite(name='custom_admin')\n+\n+# Models are registered with both the default admin.site AND the custom_admin_site.\n+# This is crucial for reproducing the bug, as the incorrect URL resolution\n+# happens when both sites are active.\n+admin.site.register(Book, BookAdmin)\n+admin.site.register(Chapter, ChapterAdmin)\n+admin.site.register(ReadOnlyFKModel, ReadOnlyFKModelAdmin)\n+\n+custom_admin_site.register(Book, BookAdmin)\n+custom_admin_site.register(Chapter, ChapterAdmin)\n+custom_admin_site.register(ReadOnlyFKModel, ReadOnlyFKModelAdmin)\n+\n+\n+# The test URLconf includes both the default and the custom admin sites.\n+urlpatterns = [\n+    path('admin/', admin.site.urls),\n+    path('custom_admin/', custom_admin_site.urls),\n+]\n+\n+\n+@override_settings(\n+    ROOT_URLCONF=__name__,\n+    # Add required apps for the admin and our models (which are in 'auth' app)\n+    INSTALLED_APPS=(\n+        'django.contrib.auth',\n+        'django.contrib.contenttypes',\n+        'django.contrib.sessions',\n+        'django.contrib.messages',\n+        'django.contrib.admin',\n+    ),\n+)\n+class ReadonlyURLTests(TestCase):\n+    \"\"\"\n+    Tests for readonly field URL generation in a custom AdminSite.\n+    \"\"\"\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.superuser = User.objects.create_superuser('super', 'super@example.com', 'password')\n+        cls.book = Book.objects.create(name='Test Book')\n+        cls.chapter = Chapter.objects.create(title='Test Chapter', book=cls.book)\n+        cls.readonly_instance = ReadOnlyFKModel.objects.create(\n+            name='Test Readonly',\n+            chapter=cls.chapter\n+        )\n+\n+    def test_readonly_fk_link_in_custom_admin(self):\n+        \"\"\"\n+        A readonly foreign key field on a custom admin site should link to the\n+        change view on the same site, not the default one.\n+        \"\"\"\n+        self.client.force_login(self.superuser)\n+        # Access the change page on the custom admin site.\n+        url = reverse(\n+            'custom_admin:auth_readonlyfkmodel_change',\n+            args=(self.readonly_instance.pk,)\n+        )\n+        response = self.client.get(url)\n+\n+        # This is the URL that *should* be generated for the readonly field.\n+        correct_url = reverse(\n+            'custom_admin:auth_chapter_change',\n+            args=(self.chapter.pk,)\n+        )\n+\n+        # This assertion should fail because the bug causes the URL to be\n+        # generated for the 'admin' namespace instead of 'custom_admin'.\n+        self.assertContains(\n+            response,\n+            f'<a href=\"{correct_url}\">{self.chapter}</a>',\n+            html=True\n+        )\n"], "arch": "x86_64", "base_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "test_directives": ["test_readonly_fk_custom_admin"], "coverage_files": ["django/contrib/admin/helpers.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.8", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/admin/helpers\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 test_readonly_fk_custom_admin", "req_install_commands": ["conda create -n testbed python=3.8 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}