{"instance_id": "django__django-13820", "repo": "django/django", "version": "3.2", "environment_setup_commit": "65dfb06a1ab56c238cc80f5e1c31f61210c4577d", "patch_list": ["diff --git a/django/db/migrations/loader.py b/django/db/migrations/loader.py\n--- a/django/db/migrations/loader.py\n+++ b/django/db/migrations/loader.py\n@@ -88,15 +88,19 @@ def load_disk(self):\n                     continue\n                 raise\n             else:\n-                # Empty directories are namespaces.\n-                # getattr() needed on PY36 and older (replace w/attribute access).\n-                if getattr(module, '__file__', None) is None:\n-                    self.unmigrated_apps.add(app_config.label)\n-                    continue\n                 # Module is not a package (e.g. migrations.py).\n                 if not hasattr(module, '__path__'):\n                     self.unmigrated_apps.add(app_config.label)\n                     continue\n+                # Empty directories are namespaces. Namespace packages have no\n+                # __file__ and don't use a list for __path__. See\n+                # https://docs.python.org/3/reference/import.html#namespace-packages\n+                if (\n+                    getattr(module, '__file__', None) is None and\n+                    not isinstance(module.__path__, list)\n+                ):\n+                    self.unmigrated_apps.add(app_config.label)\n+                    continue\n                 # Force a reload if it's already loaded (tests need this)\n                 if was_loaded:\n                     reload(module)\n", "diff --git a/tests/migrations/test_loader_no_file_attr.py b/tests/migrations/test_loader_no_file_attr.py\nnew file mode 100644\nindex 0000000000..c4109e9455\n--- /dev/null\n+++ b/tests/migrations/test_loader_no_file_attr.py\n@@ -0,0 +1,46 @@\n+import sys\n+from types import ModuleType\n+from unittest.mock import MagicMock, patch\n+\n+from django.db.migrations.loader import MigrationLoader\n+from django.test import TestCase, modify_settings, override_settings\n+\n+\n+class MigrationLoaderFileAttributeTests(TestCase):\n+    # Add the 'basic' test app to INSTALLED_APPS for the loader to find it.\n+    # Then, override its migration module to point to our fake module.\n+    @modify_settings(INSTALLED_APPS={'append': 'migrations.migrations_test_apps.basic'})\n+    @override_settings(MIGRATION_MODULES={'basic': 'basic.migrations'})\n+    def test_regular_package_no_file_attribute(self):\n+        \"\"\"\n+        Migrations in a regular package without a __file__ attribute should be\n+        loaded.\n+        \"\"\"\n+        migrations_module_name = 'basic.migrations'\n+        migration_name = '0001_initial'\n+        full_migration_module_name = f'{migrations_module_name}.{migration_name}'\n+\n+        # A mock module for a regular package without a __file__ attribute.\n+        migrations_pkg_module = ModuleType(migrations_module_name)\n+        migrations_pkg_module.__path__ = ['/fake/path']\n+\n+        # A mock for the actual migration file.\n+        migration_file_module = ModuleType(full_migration_module_name)\n+        migration_file_module.Migration = MagicMock()\n+\n+        # Place the mock modules in sys.modules so they can be \"imported\".\n+        mocked_modules = {\n+            migrations_module_name: migrations_pkg_module,\n+            full_migration_module_name: migration_file_module,\n+        }\n+        # Mock pkgutil to \"find\" the migration file in our mock package.\n+        with patch.dict(sys.modules, mocked_modules), \\\n+             patch('django.db.migrations.loader.pkgutil.iter_modules', return_value=[(None, migration_name, False)]):\n+            loader = MigrationLoader(connection=None)\n+\n+            # The bug is that the loader incorrectly flags the app as\n+            # unmigrated due to the missing __file__ attribute. This assertion\n+            # will fail on the buggy code because 'basic' will NOT be in\n+            # migrated_apps. It will pass on the patched code which correctly\n+            # checks the type of __path__ and loads the app's migrations.\n+            self.assertIn('basic', loader.migrated_apps)\n"], "arch": "x86_64", "base_commit": "98ad327864aed8df245fd19ea9d2743279e11643", "test_directives": ["migrations.test_loader_no_file_attr"], "coverage_files": ["django/db/migrations/loader.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/loader\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_loader_no_file_attr", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}