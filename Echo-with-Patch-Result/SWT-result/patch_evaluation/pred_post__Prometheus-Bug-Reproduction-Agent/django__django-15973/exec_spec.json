{"instance_id": "django__django-15973", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ def _get_dependencies_for_foreign_key(app_label, model_name, field, project_stat\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n", "diff --git a/tests/migrations/test_many_to_many_through_cross_app.py b/tests/migrations/test_many_to_many_through_cross_app.py\nnew file mode 100644\nindex 0000000000..5d3f047ead\n--- /dev/null\n+++ b/tests/migrations/test_many_to_many_through_cross_app.py\n@@ -0,0 +1,89 @@\n+from django.db import connection, migrations, models\n+from django.db.migrations.state import ProjectState\n+\n+from .test_base import OperationTestBase\n+\n+\n+class ManyToManyThroughCrossAppTests(OperationTestBase):\n+    def test_m2m_through_model_in_other_app(self):\n+        \"\"\"\n+        Tests that creating a model with a ManyToManyField referencing a\n+        `through` model in another app by string doesn't fail.\n+        \"\"\"\n+        app_label = \"fonte\"\n+        related_app_label = \"variavel\"\n+        through_app_label = \"fonte_variavel\"\n+\n+        # These are the operations to set up the 'variavel' app.\n+        variavel_ops = [\n+            migrations.CreateModel(\n+                \"VariavelModel\",\n+                fields=[\n+                    (\n+                        \"id\",\n+                        models.BigAutoField(\n+                            auto_created=True,\n+                            primary_key=True,\n+                            serialize=False,\n+                            verbose_name=\"ID\",\n+                        ),\n+                    ),\n+                    (\"nome\", models.TextField(unique=True)),\n+                    (\"descricao\", models.TextField()),\n+                ],\n+                options={\"db_table\": \"variaveis\"},\n+            )\n+        ]\n+        # State before migration: the related 'to' model 'VariavelModel'\n+        # exists in a different app.\n+        project_state = self.apply_operations(\n+            related_app_label, ProjectState(), variavel_ops\n+        )\n+\n+        # This is the operation that causes the bug.\n+        operation = migrations.CreateModel(\n+            name=\"FonteModel\",\n+            fields=[\n+                (\n+                    \"id\",\n+                    models.BigAutoField(\n+                        auto_created=True,\n+                        primary_key=True,\n+                        serialize=False,\n+                        verbose_name=\"ID\",\n+                    ),\n+                ),\n+                (\"nome\", models.TextField(unique=True)),\n+                (\"descricao\", models.TextField()),\n+                (\"data_inicial\", models.DateField()),\n+                (\"data_final\", models.DateField(blank=True, null=True)),\n+                (\n+                    \"variaveis\",\n+                    models.ManyToManyField(\n+                        to=f\"{related_app_label}.VariavelModel\",\n+                        through=f\"{through_app_label}.FonteVariavelModel\",\n+                    ),\n+                ),\n+            ],\n+            options={\"db_table\": \"fontes\"},\n+        )\n+\n+        # This will raise AttributeError before the fix.\n+        new_state = project_state.clone()\n+        operation.state_forwards(app_label, new_state)\n+        with connection.schema_editor() as editor:\n+            operation.database_forwards(app_label, editor, project_state, new_state)\n+\n+        # The assertion is that the table for FonteModel is created.\n+        self.assertTableExists(\"fontes\")\n+\n+        # Cleanup: Manually drop the 'fontes' table to avoid calling\n+        # delete_model(), which has the same bug but is not covered by the patch.\n+        # Then, properly unapply the setup operations for the 'variavel' app.\n+        try:\n+            with connection.schema_editor() as editor:\n+                editor.execute(\n+                    editor.sql_delete_table % {\"table\": editor.quote_name(\"fontes\")}\n+                )\n+        finally:\n+            self.unapply_operations(related_app_label, project_state, variavel_ops)\n"], "arch": "x86_64", "base_commit": "2480554dc4ada4ecf3f6a08e318735a2e50783f3", "test_directives": ["migrations.test_many_to_many_through_cross_app"], "coverage_files": ["django/db/migrations/autodetector.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/autodetector\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_many_to_many_through_cross_app", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}