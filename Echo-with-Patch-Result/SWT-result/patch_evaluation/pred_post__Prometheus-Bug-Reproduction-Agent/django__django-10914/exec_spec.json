{"instance_id": "django__django-10914", "repo": "django/django", "version": "3.0", "environment_setup_commit": "419a78300f7cd27611196e1e464d50fd0385ff27", "patch_list": ["diff --git a/django/conf/global_settings.py b/django/conf/global_settings.py\n--- a/django/conf/global_settings.py\n+++ b/django/conf/global_settings.py\n@@ -304,7 +304,7 @@ def gettext_noop(s):\n \n # The numeric mode to set newly-uploaded files to. The value should be a mode\n # you'd pass directly to os.chmod; see https://docs.python.org/library/os.html#files-and-directories.\n-FILE_UPLOAD_PERMISSIONS = None\n+FILE_UPLOAD_PERMISSIONS = 0o644\n \n # The numeric mode to assign to newly-created directories, when uploading files.\n # The value should be a mode as you'd pass to os.chmod;\n", "diff --git a/tests/storage/test_file_upload_permissions.py b/tests/storage/test_file_upload_permissions.py\nnew file mode 100644\nindex 0000000000..1c63bc6f11\n--- /dev/null\n+++ b/tests/storage/test_file_upload_permissions.py\n@@ -0,0 +1,51 @@\n+import os\n+import shutil\n+import tempfile\n+\n+from django.core.files.storage import FileSystemStorage\n+from django.core.files.uploadedfile import TemporaryUploadedFile\n+from django.test import TestCase\n+\n+\n+class FileUploadPermissionsTest(TestCase):\n+    \"\"\"\n+    Tests for file upload permissions.\n+    \"\"\"\n+    def setUp(self):\n+        self.storage_dir = tempfile.mkdtemp()\n+        # The FILE_UPLOAD_PERMISSIONS setting is None by default in the old code.\n+        # We don't need to override it to test the default behavior.\n+        self.storage = FileSystemStorage(location=self.storage_dir)\n+\n+    def tearDown(self):\n+        shutil.rmtree(self.storage_dir)\n+\n+    def test_temporary_file_upload_permissions(self):\n+        \"\"\"\n+        A file uploaded using TemporaryUploadedFile is moved, so it should\n+        have its permissions set by the default FILE_UPLOAD_PERMISSIONS.\n+        \"\"\"\n+        # This test is sensitive to the umask. Set a restrictive umask to\n+        # ensure that the temporary file is created with permissions that\n+        # would fail the test if they were preserved.\n+        old_umask = os.umask(0o077)\n+        try:\n+            # Use TemporaryUploadedFile to simulate a large file upload, which\n+            # is moved into place by FileSystemStorage.\n+            with TemporaryUploadedFile('test.txt', 'text/plain', 1, 'utf-8') as tmp_file:\n+                tmp_file.write(b'content')\n+                tmp_file.seek(0)\n+                # Before the fix, FILE_UPLOAD_PERMISSIONS is None by default,\n+                # so os.chmod() is not called. The restrictive permissions of\n+                # the temporary file (e.g., 0o600 due to the umask) are kept.\n+                # After the fix, the default is 0o644, and os.chmod() is called.\n+                saved_name = self.storage.save('test_permissions.txt', tmp_file)\n+                path = self.storage.path(saved_name)\n+                mode = os.stat(path).st_mode\n+                self.addCleanup(self.storage.delete, saved_name)\n+\n+                # This assertion will fail before the fix (e.g. 0o600 != 0o644)\n+                # and pass after.\n+                self.assertEqual(mode & 0o777, 0o644)\n+        finally:\n+            os.umask(old_umask)\n"], "arch": "x86_64", "base_commit": "e7fd69d051eaa67cb17f172a39b57253e9cb831a", "test_directives": ["storage.test_file_upload_permissions"], "coverage_files": ["django/conf/global_settings.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/conf/global_settings\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 storage.test_file_upload_permissions", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref ~= 3.2\nargon2-cffi >= 16.1.0\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow != 5.4.0\npylibmc; sys.platform != 'win32'\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}