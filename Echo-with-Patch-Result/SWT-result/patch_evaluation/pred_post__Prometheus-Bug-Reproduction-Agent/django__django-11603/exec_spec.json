{"instance_id": "django__django-11603", "repo": "django/django", "version": "3.0", "environment_setup_commit": "419a78300f7cd27611196e1e464d50fd0385ff27", "patch_list": ["diff --git a/django/db/models/aggregates.py b/django/db/models/aggregates.py\n--- a/django/db/models/aggregates.py\n+++ b/django/db/models/aggregates.py\n@@ -99,6 +99,7 @@ def _get_repr_options(self):\n class Avg(FixDurationInputMixin, NumericOutputFieldMixin, Aggregate):\n     function = 'AVG'\n     name = 'Avg'\n+    allow_distinct = True\n \n \n class Count(Aggregate):\n@@ -142,6 +143,7 @@ def _get_repr_options(self):\n class Sum(FixDurationInputMixin, Aggregate):\n     function = 'SUM'\n     name = 'Sum'\n+    allow_distinct = True\n \n \n class Variance(NumericOutputFieldMixin, Aggregate):\n", "diff --git a/tests/aggregation/test_distinct_aggregate.py b/tests/aggregation/test_distinct_aggregate.py\nnew file mode 100644\nindex 0000000000..92c7a196d1\n--- /dev/null\n+++ b/tests/aggregation/test_distinct_aggregate.py\n@@ -0,0 +1,53 @@\n+import datetime\n+from decimal import Decimal\n+\n+from django.db.models import Avg, Sum\n+from django.test import TestCase\n+\n+from .models import Author, Book, Publisher\n+\n+\n+class AggregateDistinctTests(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        publisher = Publisher.objects.create(name='Apress', num_awards=3)\n+        author = Author.objects.create(name='Adrian Holovaty', age=34)\n+        Book.objects.create(\n+            name='The Definitive Guide to Django',\n+            pages=447,\n+            rating=4.5,\n+            price=Decimal('30.00'),\n+            contact=author,\n+            publisher=publisher,\n+            pubdate=datetime.date(2007, 12, 6),\n+        )\n+        Book.objects.create(\n+            name='Practical Django Projects',\n+            pages=300,\n+            rating=4.0,\n+            price=Decimal('30.00'),\n+            contact=author,\n+            publisher=publisher,\n+            pubdate=datetime.date(2008, 6, 23),\n+        )\n+        Book.objects.create(\n+            name='Python Web Development with Django',\n+            pages=350,\n+            rating=4.0,\n+            price=Decimal('29.69'),\n+            contact=author,\n+            publisher=publisher,\n+            pubdate=datetime.date(2008, 11, 3),\n+        )\n+\n+    def test_distinct_on_sum_avg(self):\n+        \"\"\"\n+        The distinct parameter should be allowed on Sum and Avg aggregates.\n+        \"\"\"\n+        result = Book.objects.aggregate(\n+            price_sum=Sum('price', distinct=True),\n+            price_avg=Avg('price', distinct=True),\n+        )\n+        # Distinct prices are 30.00 and 29.69.\n+        self.assertEqual(result['price_sum'], Decimal('59.69'))\n+        self.assertEqual(result['price_avg'], Decimal('29.845'))\n"], "arch": "x86_64", "base_commit": "f618e033acd37d59b536d6e6126e6c5be18037f6", "test_directives": ["aggregation.test_distinct_aggregate"], "coverage_files": ["django/db/models/aggregates.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/models/aggregates\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 aggregation.test_distinct_aggregate", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref ~= 3.2\nargon2-cffi >= 16.1.0\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow != 5.4.0\npylibmc; sys.platform != 'win32'\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}