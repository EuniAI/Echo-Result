{"instance_id": "django__django-14404", "repo": "django/django", "version": "4.0", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "patch_list": ["diff --git a/django/contrib/admin/sites.py b/django/contrib/admin/sites.py\n--- a/django/contrib/admin/sites.py\n+++ b/django/contrib/admin/sites.py\n@@ -420,14 +420,13 @@ def autocomplete_view(self, request):\n     def catch_all_view(self, request, url):\n         if settings.APPEND_SLASH and not url.endswith('/'):\n             urlconf = getattr(request, 'urlconf', None)\n-            path = '%s/' % request.path_info\n             try:\n-                match = resolve(path, urlconf)\n+                match = resolve('%s/' % request.path_info, urlconf)\n             except Resolver404:\n                 pass\n             else:\n                 if getattr(match.func, 'should_append_slash', True):\n-                    return HttpResponsePermanentRedirect(path)\n+                    return HttpResponsePermanentRedirect('%s/' % request.path)\n         raise Http404\n \n     def _build_app_dict(self, request, label=None):\n", "diff --git a/tests/test_catch_all_redirect.py b/tests/test_catch_all_redirect.py\nnew file mode 100644\nindex 0000000000..cd768089c9\n--- /dev/null\n+++ b/tests/test_catch_all_redirect.py\n@@ -0,0 +1,59 @@\n+from django.contrib import admin\n+from django.contrib.auth.models import User\n+from django.test import TestCase, override_settings\n+from django.test.client import RequestFactory\n+from django.urls import path\n+\n+# A minimal, self-contained URLconf is used for test isolation.\n+site = admin.AdminSite(name=\"admin\")\n+site.register(User)\n+\n+urlpatterns = [\n+    path(\"admin/\", site.urls),\n+]\n+\n+\n+# The test environment is configured with the minimal set of apps needed\n+# for the admin site's URL resolver to function correctly.\n+@override_settings(\n+    ROOT_URLCONF=__name__,\n+    INSTALLED_APPS=[\n+        \"django.contrib.admin\",\n+        \"django.contrib.auth\",\n+        \"django.contrib.contenttypes\",\n+        \"django.contrib.sessions\",\n+    ],\n+)\n+class CatchAllViewForceScriptNameTest(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.user = User.objects.create_superuser(\"user\", \"user@example.com\", \"password\")\n+        cls.factory = RequestFactory()\n+\n+    def test_catch_all_redirect_respects_script_name(self):\n+        \"\"\"\n+        The admin's catch_all_view should respect FORCE_SCRIPT_NAME when\n+        redirecting a URL that is missing a trailing slash.\n+        \"\"\"\n+        # A request object is created with RequestFactory to accurately simulate\n+        # the SCRIPT_NAME and PATH_INFO environment of a real WSGI server.\n+        request = self.factory.get(\"/admin/auth\")\n+        request.user = self.user\n+\n+        # Simulate the environment for a request to 'http://testserver/prefix/admin/auth'\n+        request.META[\"SCRIPT_NAME\"] = \"/prefix\"\n+        request.path_info = \"/admin/auth\"\n+        request.path = \"/prefix/admin/auth\"\n+\n+        # The request's urlconf is set to the test module's urlpatterns.\n+        request.urlconf = __name__\n+\n+        # The view is called directly. For a request to '/admin/auth', the\n+        # admin's URL resolver captures 'auth' and passes it as the 'url' argument.\n+        response = site.catch_all_view(request, url=\"auth\")\n+\n+        # The unpatched view builds the redirect from request.path_info,\n+        # resulting in a redirect to '/admin/auth/'. The patched view uses\n+        # request.get_full_path(), resulting in '/prefix/admin/auth/'.\n+        self.assertEqual(response.status_code, 301)\n+        self.assertEqual(response.url, \"/prefix/admin/auth/\")\n"], "arch": "x86_64", "base_commit": "de32fe83a2e4a20887972c69a0693b94eb25a88b", "test_directives": ["test_catch_all_redirect"], "coverage_files": ["django/contrib/admin/sites.py"], "env_name": "testbed", "run_id": "patch_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": true, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.8", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/admin/sites\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 test_catch_all_redirect", "req_install_commands": ["conda create -n testbed python=3.8 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}