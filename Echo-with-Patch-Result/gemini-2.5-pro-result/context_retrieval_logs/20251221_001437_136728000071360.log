2025-12-21 00:14:37,947 - thread-136728000071360.prometheus_context_collector - INFO - Starting context retrieval for query: 
Issue: kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes

Description: **Describe the bug**

The `:kbd:` role produces incorrect HTML when:

1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)
2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)

**To Reproduce**

For the below three keyboard definitions:
```
(1) :kbd:`-`
(2) :kbd:`+`
(3) :kbd:`Shift-+`
```

The following three incorrect output is generated:

(1) `-` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(2) `+` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(3) `+` is treated as a separator within a compound-keystroke, with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Shift</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

**Expected behavior**

For single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.

For compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).

**Screenshot**

![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)


**Environment info**
- OS: Windows
- Python version: 3.9.1
- Sphinx version: 3.4.0
- Sphinx extensions:  -
- Extra tools: -


Patch information:
diff --git a/doc/usage/restructuredtext/roles.rst b/doc/usage/restructuredtext/roles.rst
index de12a41b5..0a8ca2452 100644
--- a/doc/usage/restructuredtext/roles.rst
+++ b/doc/usage/restructuredtext/roles.rst
@@ -350,6 +350,10 @@ different style:
    reference to a specific application or platform, the same sequence should be
    marked as ``:kbd:`Control-x Control-f```.
 
+   Note that the characters '-', '+', and '^' are treated as separators only
+   when they separate two non-empty key names. When used alone or at the
+   beginning or end of a compound sequence, they are treated as individual
+   keys.
 .. rst:role:: mailheader
 
    The name of an RFC 822-style mail header.  This markup does not imply that
diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py
index c91da57e9..e04e0d838 100644
--- a/sphinx/builders/html/transforms.py
+++ b/sphinx/builders/html/transforms.py
@@ -8,8 +8,7 @@
     :license: BSD, see LICENSE for details.
 """
 
-import re
-from typing import Any, Dict
+from typing import Any, Dict, List
 
 from docutils import nodes
 
@@ -37,26 +36,71 @@ class KeyboardTransform(SphinxPostTransform):
     """
     default_priority = 400
     builders = ('html',)
-    pattern = re.compile(r'(-|\+|\^|\s+)')
 
     def run(self, **kwargs: Any) -> None:
         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
         for node in self.document.traverse(matcher):  # type: nodes.literal
-            parts = self.pattern.split(node[-1].astext())
-            if len(parts) == 1:
+            text = node[-1].astext()
+
+            keys = []  # type: List[str]
+            prefix_seps = []  # type: List[str]
+            infix_seps = []  # type: List[str]
+
+            buf = ''
+            seen_key = False
+            i = 0
+            length = len(text)
+            while i < length:
+                ch = text[i]
+                if ch.isspace():
+                    # accumulate consecutive whitespace as a single separator
+                    j = i
+                    while i < length and text[i].isspace():
+                        i += 1
+                    sep = text[j:i]
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        infix_seps.append(sep)
+                    else:
+                        if not seen_key:
+                            prefix_seps.append(sep)
+                        else:
+                            infix_seps.append(sep)
+                    continue
+                elif ch in '-+^':
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        # treat as separator between two non-empty keys
+                        infix_seps.append(ch)
+                    else:
+                        # treat as a key when at start of sequence or
+                        # immediately after a separator (avoid empty keys)
+                        buf += ch
+                    i += 1
+                else:
+                    buf += ch
+                    i += 1
+
+            if buf:
+                keys.append(buf)
+
+            # If there is only a single key, leave as-is
+            if len(keys) <= 1:
                 continue
 
+            # rebuild node: preserve leading separators, then interleave keys and separators
             node.pop()
-            while parts:
-                key = parts.pop(0)
-                node += nodes.literal('', key, classes=["kbd"])
-
-                try:
-                    # key separator (ex. -, +, ^)
-                    sep = parts.pop(0)
-                    node += nodes.Text(sep)
-                except IndexError:
-                    pass
+            for sep in prefix_seps:
+                node += nodes.Text(sep)
+
+            for idx in range(len(keys)):
+                node += nodes.literal('', keys[idx], classes=["kbd"])
+                if idx < len(infix_seps):
+                    node += nodes.Text(infix_seps[idx])
 
 
 def setup(app: Sphinx) -> Dict[str, Any]:


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

2025-12-21 00:14:38,025 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       ├── main.yml
|       └── nodejs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── deprecated.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-two-links
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes

Description: **Describe the bug**

The `:kbd:` role produces incorrect HTML when:

1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)
2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)

**To Reproduce**

For the below three keyboard definitions:
```
(1) :kbd:`-`
(2) :kbd:`+`
(3) :kbd:`Shift-+`
```

The following three incorrect output is generated:

(1) `-` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(2) `+` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(3) `+` is treated as a separator within a compound-keystroke, with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Shift</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

**Expected behavior**

For single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.

For compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).

**Screenshot**

![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)


**Environment info**
- OS: Windows
- Python version: 3.9.1
- Sphinx version: 3.4.0
- Sphinx extensions:  -
- Extra tools: -


Patch information:
diff --git a/doc/usage/restructuredtext/roles.rst b/doc/usage/restructuredtext/roles.rst
index de12a41b5..0a8ca2452 100644
--- a/doc/usage/restructuredtext/roles.rst
+++ b/doc/usage/restructuredtext/roles.rst
@@ -350,6 +350,10 @@ different style:
    reference to a specific application or platform, the same sequence should be
    marked as ``:kbd:`Control-x Control-f```.
 
+   Note that the characters '-', '+', and '^' are treated as separators only
+   when they separate two non-empty key names. When used alone or at the
+   beginning or end of a compound sequence, they are treated as individual
+   keys.
 .. rst:role:: mailheader
 
    The name of an RFC 822-style mail header.  This markup does not imply that
diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py
index c91da57e9..e04e0d838 100644
--- a/sphinx/builders/html/transforms.py
+++ b/sphinx/builders/html/transforms.py
@@ -8,8 +8,7 @@
     :license: BSD, see LICENSE for details.
 """
 
-import re
-from typing import Any, Dict
+from typing import Any, Dict, List
 
 from docutils import nodes
 
@@ -37,26 +36,71 @@ class KeyboardTransform(SphinxPostTransform):
     """
     default_priority = 400
     builders = ('html',)
-    pattern = re.compile(r'(-|\+|\^|\s+)')
 
     def run(self, **kwargs: Any) -> None:
         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
         for node in self.document.traverse(matcher):  # type: nodes.literal
-            parts = self.pattern.split(node[-1].astext())
-            if len(parts) == 1:
+            text = node[-1].astext()
+
+            keys = []  # type: List[str]
+            prefix_seps = []  # type: List[str]
+            infix_seps = []  # type: List[str]
+
+            buf = ''
+            seen_key = False
+            i = 0
+            length = len(text)
+            while i < length:
+                ch = text[i]
+                if ch.isspace():
+                    # accumulate consecutive whitespace as a single separator
+                    j = i
+                    while i < length and text[i].isspace():
+                        i += 1
+                    sep = text[j:i]
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        infix_seps.append(sep)
+                    else:
+                        if not seen_key:
+                            prefix_seps.append(sep)
+                        else:
+                            infix_seps.append(sep)
+                    continue
+                elif ch in '-+^':
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        # treat as separator between two non-empty keys
+                        infix_seps.append(ch)
+                    else:
+                        # treat as a key when at start of sequence or
+                        # immediately after a separator (avoid empty keys)
+                        buf += ch
+                    i += 1
+                else:
+                    buf += ch
+                    i += 1
+
+            if buf:
+                keys.append(buf)
+
+            # If there is only a single key, leave as-is
+            if len(keys) <= 1:
                 continue
 
+            # rebuild node: preserve leading separators, then interleave keys and separators
             node.pop()
-            while parts:
-                key = parts.pop(0)
-                node += nodes.literal('', key, classes=["kbd"])
-
-                try:
-                    # key separator (ex. -, +, ^)
-                    sep = parts.pop(0)
-                    node += nodes.Text(sep)
-                except IndexError:
-                    pass
+            for sep in prefix_seps:
+                node += nodes.Text(sep)
+
+            for idx in range(len(keys)):
+                node += nodes.literal('', keys[idx], classes=["kbd"])
+                if idx < len(infix_seps):
+                    node += nodes.Text(infix_seps[idx])
 
 
 def setup(app: Sphinx) -> Dict[str, Any]:


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-21 00:14:53,981 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user wants to find existing test cases related to the `:kbd:` role and its HTML output. The bug report indicates an issue with how separators are handled within this role. The patch is in `sphinx/builders/html/transforms.py`. Therefore, test files related to HTML building and markup processing are the most relevant places to find the required test cases. I need to examine `tests/test_build_html.py` and `tests/test_markup.py` to identify tests that cover the `:kbd:` role and its rendering.' query='Please provide the full content of `tests/test_build_html.py` and `tests/test_markup.py`.' extra_requirements='' purpose='I need to find three existing test cases that demonstrate the functionality of the `:kbd:` role to understand how it is tested and to find examples similar to the reported bug.'
2025-12-21 00:14:53,982 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of `tests/test_build_html.py` and `tests/test_markup.py`.
2025-12-21 00:14:53,983 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-21 00:14:53,983 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-21 00:14:53,984 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-21 00:14:53,984 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of `tests/test_build_html.py` and `tests/test_markup.py`.
Purpose: I need to find three existing test cases that demonstrate the functionality of the `:kbd:` role to understand how it is tested and to find examples similar to the reported bug.
2025-12-21 00:14:57,882 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the full content of both `tests/test_build_html.py` and `tests/test_markup.py` so you can examine them for test cases related to the `:kbd:` role. This will help you understand how the functionality is tested and find examples relevant to the bug you are investigating.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/test_markup.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2097, 'candidates_token_count': 110, 'total_token_count': 2443, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2097}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 110}], 'thoughts_token_count': 236, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.10585752833973278, 'model_name': 'gemini-2.5-pro'} id='run--b7c2f95a-361a-438b-9f90-4b1d69fe11d0-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_build_html.py'}, 'id': '69e0a7c7-b8eb-47a1-bdf1-4473a7b6705e', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_markup.py'}, 'id': 'a1213bf4-37f5-4934-8399-5657600ae1d6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2097, 'output_tokens': 110, 'total_tokens': 2443, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 236}}
2025-12-21 00:15:07,165 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the contents of `tests/test_build_html.py` and `tests/test_markup.py`.\n\nIn `tests/test_build_html.py`, I found a test case within the `test_html5_output` function that verifies the presence of a `<kbd>` tag in the generated HTML output for the `markup.html` file.\n\nIn `tests/test_markup.py`, I located three distinct test cases for the `:kbd:` role within the `test_inline` function. These tests cover a simple key, a key combination using `+`, and a more complex key combination involving spaces, providing clear examples of how the `:kbd:` role is tested.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 20093, 'candidates_token_count': 149, 'total_token_count': 21004, 'cached_content_token_count': 1840, 'prompt_tokens_details': [{'modality': 1, 'token_count': 20093}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1840}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 149}], 'thoughts_token_count': 762}, 'finish_reason': 'STOP', 'avg_logprobs': -0.5257560166736577, 'model_name': 'gemini-2.5-pro'} id='run--bf275287-4c89-4347-a65e-ac46f269c507-0' usage_metadata={'input_tokens': 20093, 'output_tokens': 149, 'total_tokens': 21004, 'input_token_details': {'cache_read': 1840}, 'output_token_details': {'reasoning': 762}}
2025-12-21 00:15:07,167 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of `tests/test_build_html.py` and `tests/test_markup.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
I need to find three existing test cases that demonstrate the functionality of the `:kbd:` role to understand how it is tested and to find examples similar to the reported bug.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: tests/test_build_html.py
Line number range: 1 - 500
Content:
1. """
2.     test_build_html
3.     ~~~~~~~~~~~~~~~
4. 
5.     Test the HTML builder and check output against XPath.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import os
12. import re
13. from distutils.version import LooseVersion
14. from itertools import chain, cycle
15. 
16. import pygments
17. import pytest
18. from html5lib import HTMLParser
19. 
20. from sphinx.builders.html import validate_html_extra_path, validate_html_static_path
21. from sphinx.errors import ConfigError
22. from sphinx.testing.util import strip_escseq
23. from sphinx.util import docutils, md5
24. from sphinx.util.inventory import InventoryFile
25. 
26. ENV_WARNINGS = """\
27. %(root)s/autodoc_fodder.py:docstring of autodoc_fodder.MarkupError:\\d+: \
28. WARNING: Explicit markup ends without a blank line; unexpected unindent.
29. %(root)s/index.rst:\\d+: WARNING: Encoding 'utf-8-sig' used for reading included \
30. file '%(root)s/wrongenc.inc' seems to be wrong, try giving an :encoding: option
31. %(root)s/index.rst:\\d+: WARNING: invalid single index entry ''
32. %(root)s/index.rst:\\d+: WARNING: image file not readable: foo.png
33. %(root)s/index.rst:\\d+: WARNING: download file not readable: %(root)s/nonexisting.png
34. %(root)s/undecodable.rst:\\d+: WARNING: undecodable source characters, replacing \
35. with "\\?": b?'here: >>>(\\\\|/)xbb<<<((\\\\|/)r)?'
36. """
37. 
38. HTML_WARNINGS = ENV_WARNINGS + """\
39. %(root)s/index.rst:\\d+: WARNING: unknown option: &option
40. %(root)s/index.rst:\\d+: WARNING: citation not found: missing
41. %(root)s/index.rst:\\d+: WARNING: a suitable image for html builder not found: foo.\\*
42. %(root)s/index.rst:\\d+: WARNING: Could not lex literal_block as "c". Highlighting skipped.
43. """
44. 
45. 
46. etree_cache = {}
47. 
48. 
49. @pytest.fixture(scope='module')
50. def cached_etree_parse():
51.     def parse(fname):
52.         if fname in etree_cache:
53.             return etree_cache[fname]
54.         with (fname).open('rb') as fp:
55.             etree = HTMLParser(namespaceHTMLElements=False).parse(fp)
56.             etree_cache.clear()
57.             etree_cache[fname] = etree
58.             return etree
59.     yield parse
60.     etree_cache.clear()
61. 
62. 
63. def flat_dict(d):
64.     return chain.from_iterable(
65.         [
66.             zip(cycle([fname]), values)
67.             for fname, values in d.items()
68.         ]
69.     )
70. 
71. 
72. def tail_check(check):
73.     rex = re.compile(check)
74. 
75.     def checker(nodes):
76.         for node in nodes:
77.             if node.tail and rex.search(node.tail):
78.                 return True
79.         assert False, '%r not found in tail of any nodes %s' % (check, nodes)
80.     return checker
81. 
82. 
83. def check_xpath(etree, fname, path, check, be_found=True):
84.     nodes = list(etree.findall(path))
85.     if check is None:
86.         assert nodes == [], ('found any nodes matching xpath '
87.                              '%r in file %s' % (path, fname))
88.         return
89.     else:
90.         assert nodes != [], ('did not find any node matching xpath '
91.                              '%r in file %s' % (path, fname))
92.     if hasattr(check, '__call__'):
93.         check(nodes)
94.     elif not check:
95.         # only check for node presence
96.         pass
97.     else:
98.         def get_text(node):
99.             if node.text is not None:
100.                 # the node has only one text
101.                 return node.text
102.             else:
103.                 # the node has tags and text; gather texts just under the node
104.                 return ''.join(n.tail or '' for n in node)
105. 
106.         rex = re.compile(check)
107.         if be_found:
108.             if any(rex.search(get_text(node)) for node in nodes):
109.                 return
110.         else:
111.             if all(not rex.search(get_text(node)) for node in nodes):
112.                 return
113. 
114.         assert False, ('%r not found in any node matching '
115.                        'path %s in %s: %r' % (check, path, fname,
116.                                               [node.text for node in nodes]))
117. 
118. 
119. @pytest.mark.sphinx('html', testroot='warnings')
120. def test_html_warnings(app, warning):
121.     app.build()
122.     html_warnings = strip_escseq(re.sub(re.escape(os.sep) + '{1,2}', '/', warning.getvalue()))
123.     html_warnings_exp = HTML_WARNINGS % {
124.         'root': re.escape(app.srcdir.replace(os.sep, '/'))}
125.     assert re.match(html_warnings_exp + '$', html_warnings), \
126.         'Warnings don\'t match:\n' + \
127.         '--- Expected (regex):\n' + html_warnings_exp + \
128.         '--- Got:\n' + html_warnings
129. 
130. 
131. @pytest.mark.sphinx('html', confoverrides={'html4_writer': True})
132. def test_html4_output(app, status, warning):
133.     app.build()
134. 
135. 
136. @pytest.mark.parametrize("fname,expect", flat_dict({
137.     'images.html': [
138.         (".//img[@src='_images/img.png']", ''),
139.         (".//img[@src='_images/img1.png']", ''),
140.         (".//img[@src='_images/simg.png']", ''),
141.         (".//img[@src='_images/svgimg.svg']", ''),
142.         (".//a[@href='_sources/images.txt']", ''),
143.     ],
144.     'subdir/images.html': [
145.         (".//img[@src='../_images/img1.png']", ''),
146.         (".//img[@src='../_images/rimg.png']", ''),
147.     ],
148.     'subdir/includes.html': [
149.         (".//a[@class='reference download internal']", ''),
150.         (".//img[@src='../_images/img.png']", ''),
151.         (".//p", 'This is an include file.'),
152.         (".//pre/span", 'line 1'),
153.         (".//pre/span", 'line 2'),
154.     ],
155.     'includes.html': [
156.         (".//pre", 'Max Strauß'),
157.         (".//a[@class='reference download internal']", ''),
158.         (".//pre/span", '"quotes"'),
159.         (".//pre/span", "'included'"),
160.         (".//pre/span[@class='s2']", 'üöä'),
161.         (".//div[@class='inc-pyobj1 highlight-text notranslate']//pre",
162.          r'^class Foo:\n    pass\n\s*$'),
163.         (".//div[@class='inc-pyobj2 highlight-text notranslate']//pre",
164.          r'^    def baz\(\):\n        pass\n\s*$'),
165.         (".//div[@class='inc-lines highlight-text notranslate']//pre",
166.          r'^class Foo:\n    pass\nclass Bar:\n$'),
167.         (".//div[@class='inc-startend highlight-text notranslate']//pre",
168.          '^foo = "Including Unicode characters: üöä"\\n$'),
169.         (".//div[@class='inc-preappend highlight-text notranslate']//pre",
170.          r'(?m)^START CODE$'),
171.         (".//div[@class='inc-pyobj-dedent highlight-python notranslate']//span",
172.          r'def'),
173.         (".//div[@class='inc-tab3 highlight-text notranslate']//pre",
174.          r'-| |-'),
175.         (".//div[@class='inc-tab8 highlight-python notranslate']//pre/span",
176.          r'-|      |-'),
177.     ],
178.     'autodoc.html': [
179.         (".//dl[@class='py class']/dt[@id='autodoc_target.Class']", ''),
180.         (".//dl[@class='py function']/dt[@id='autodoc_target.function']/em/span", r'\*\*'),
181.         (".//dl[@class='py function']/dt[@id='autodoc_target.function']/em/span", r'kwds'),
182.         (".//dd/p", r'Return spam\.'),
183.     ],
184.     'extapi.html': [
185.         (".//strong", 'from class: Bar'),
186.     ],
187.     'markup.html': [
188.         (".//title", 'set by title directive'),
189.         (".//p/em", 'Section author: Georg Brandl'),
190.         (".//p/em", 'Module author: Georg Brandl'),
191.         # created by the meta directive
192.         (".//meta[@name='author'][@content='Me']", ''),
193.         (".//meta[@name='keywords'][@content='docs, sphinx']", ''),
194.         # a label created by ``.. _label:``
195.         (".//div[@id='label']", ''),
196.         # code with standard code blocks
197.         (".//pre", '^some code$'),
198.         # an option list
199.         (".//span[@class='option']", '--help'),
200.         # admonitions
201.         (".//p[@class='admonition-title']", 'My Admonition'),
202.         (".//div[@class='admonition note']/p", 'Note text.'),
203.         (".//div[@class='admonition warning']/p", 'Warning text.'),
204.         # inline markup
205.         (".//li/p/strong", r'^command\\n$'),
206.         (".//li/p/strong", r'^program\\n$'),
207.         (".//li/p/em", r'^dfn\\n$'),
208.         (".//li/p/kbd", r'^kbd\\n$'),
209.         (".//li/p/span", 'File \N{TRIANGULAR BULLET} Close'),
210.         (".//li/p/code/span[@class='pre']", '^a/$'),
211.         (".//li/p/code/em/span[@class='pre']", '^varpart$'),
212.         (".//li/p/code/em/span[@class='pre']", '^i$'),
213.         (".//a[@href='https://www.python.org/dev/peps/pep-0008']"
214.          "[@class='pep reference external']/strong", 'PEP 8'),
215.         (".//a[@href='https://www.python.org/dev/peps/pep-0008']"
216.          "[@class='pep reference external']/strong",
217.          'Python Enhancement Proposal #8'),
218.         (".//a[@href='https://tools.ietf.org/html/rfc1.html']"
219.          "[@class='rfc reference external']/strong", 'RFC 1'),
220.         (".//a[@href='https://tools.ietf.org/html/rfc1.html']"
221.          "[@class='rfc reference external']/strong", 'Request for Comments #1'),
222.         (".//a[@href='objects.html#envvar-HOME']"
223.          "[@class='reference internal']/code/span[@class='pre']", 'HOME'),
224.         (".//a[@href='#with']"
225.          "[@class='reference internal']/code/span[@class='pre']", '^with$'),
226.         (".//a[@href='#grammar-token-try_stmt']"
227.          "[@class='reference internal']/code/span", '^statement$'),
228.         (".//a[@href='#some-label'][@class='reference internal']/span", '^here$'),
229.         (".//a[@href='#some-label'][@class='reference internal']/span", '^there$'),
230.         (".//a[@href='subdir/includes.html']"
231.          "[@class='reference internal']/span", 'Including in subdir'),
232.         (".//a[@href='objects.html#cmdoption-python-c']"
233.          "[@class='reference internal']/code/span[@class='pre']", '-c'),
234.         # abbreviations
235.         (".//abbr[@title='abbreviation']", '^abbr$'),
236.         # version stuff
237.         (".//div[@class='versionadded']/p/span", 'New in version 0.6: '),
238.         (".//div[@class='versionadded']/p/span",
239.          tail_check('First paragraph of versionadded')),
240.         (".//div[@class='versionchanged']/p/span",
241.          tail_check('First paragraph of versionchanged')),
242.         (".//div[@class='versionchanged']/p",
243.          'Second paragraph of versionchanged'),
244.         # footnote reference
245.         (".//a[@class='footnote-reference brackets']", r'1'),
246.         # created by reference lookup
247.         (".//a[@href='index.html#ref1']", ''),
248.         # ``seealso`` directive
249.         (".//div/p[@class='admonition-title']", 'See also'),
250.         # a ``hlist`` directive
251.         (".//table[@class='hlist']/tbody/tr/td/ul/li/p", '^This$'),
252.         # a ``centered`` directive
253.         (".//p[@class='centered']/strong", 'LICENSE'),
254.         # a glossary
255.         (".//dl/dt[@id='term-boson']", 'boson'),
256.         # a production list
257.         (".//pre/strong", 'try_stmt'),
258.         (".//pre/a[@href='#grammar-token-try1_stmt']/code/span", 'try1_stmt'),
259.         # tests for ``only`` directive
260.         (".//p", 'A global substitution!'),
261.         (".//p", 'In HTML.'),
262.         (".//p", 'In both.'),
263.         (".//p", 'Always present'),
264.         # tests for ``any`` role
265.         (".//a[@href='#with']/span", 'headings'),
266.         (".//a[@href='objects.html#func_without_body']/code/span", 'objects'),
267.         # tests for numeric labels
268.         (".//a[@href='#id1'][@class='reference internal']/span", 'Testing various markup'),
269.         # tests for smartypants
270.         (".//li/p", 'Smart “quotes” in English ‘text’.'),
271.         (".//li/p", 'Smart — long and – short dashes.'),
272.         (".//li/p", 'Ellipsis…'),
273.         (".//li/p/code/span[@class='pre']", 'foo--"bar"...'),
274.         (".//p", 'Этот «абзац» должен использовать „русские“ кавычки.'),
275.         (".//p", 'Il dit : « C’est “super” ! »'),
276.     ],
277.     'objects.html': [
278.         (".//dt[@id='mod.Cls.meth1']", ''),
279.         (".//dt[@id='errmod.Error']", ''),
280.         (".//dt/code", r'long\(parameter,\s* list\)'),
281.         (".//dt/code", 'another one'),
282.         (".//a[@href='#mod.Cls'][@class='reference internal']", ''),
283.         (".//dl[@class='std userdesc']", ''),
284.         (".//dt[@id='userdesc-myobj']", ''),
285.         (".//a[@href='#userdesc-myobj'][@class='reference internal']", ''),
286.         # docfields
287.         (".//a[@class='reference internal'][@href='#TimeInt']/em", 'TimeInt'),
288.         (".//a[@class='reference internal'][@href='#Time']", 'Time'),
289.         (".//a[@class='reference internal'][@href='#errmod.Error']/strong", 'Error'),
290.         # C references
291.         (".//span[@class='pre']", 'CFunction()'),
292.         (".//a[@href='#c.Sphinx_DoSomething']", ''),
293.         (".//a[@href='#c.SphinxStruct.member']", ''),
294.         (".//a[@href='#c.SPHINX_USE_PYTHON']", ''),
295.         (".//a[@href='#c.SphinxType']", ''),
296.         (".//a[@href='#c.sphinx_global']", ''),
297.         # test global TOC created by toctree()
298.         (".//ul[@class='current']/li[@class='toctree-l1 current']/a[@href='#']",
299.          'Testing object descriptions'),
300.         (".//li[@class='toctree-l1']/a[@href='markup.html']",
301.          'Testing various markup'),
302.         # test unknown field names
303.         (".//dt[@class='field-odd']", 'Field_name'),
304.         (".//dt[@class='field-even']", 'Field_name all lower'),
305.         (".//dt[@class='field-odd']", 'FIELD_NAME'),
306.         (".//dt[@class='field-even']", 'FIELD_NAME ALL CAPS'),
307.         (".//dt[@class='field-odd']", 'Field_Name'),
308.         (".//dt[@class='field-even']", 'Field_Name All Word Caps'),
309.         (".//dt[@class='field-odd']", 'Field_name'),
310.         (".//dt[@class='field-even']", 'Field_name First word cap'),
311.         (".//dt[@class='field-odd']", 'FIELd_name'),
312.         (".//dt[@class='field-even']", 'FIELd_name PARTial caps'),
313.         # custom sidebar
314.         (".//h4", 'Custom sidebar'),
315.         # docfields
316.         (".//dd[@class='field-odd']/p/strong", '^moo$'),
317.         (".//dd[@class='field-odd']/p/strong", tail_check(r'\(Moo\) .* Moo')),
318.         (".//dd[@class='field-odd']/ul/li/p/strong", '^hour$'),
319.         (".//dd[@class='field-odd']/ul/li/p/em", '^DuplicateType$'),
320.         (".//dd[@class='field-odd']/ul/li/p/em", tail_check(r'.* Some parameter')),
321.         # others
322.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-p']/code/span",
323.          'perl'),
324.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-p']/code/span",
325.          '\\+p'),
326.         (".//a[@class='reference internal'][@href='#cmdoption-perl-ObjC']/code/span",
327.          '--ObjC\\+\\+'),
328.         (".//a[@class='reference internal'][@href='#cmdoption-perl-plugin.option']/code/span",
329.          '--plugin.option'),
330.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-create-auth-token']"
331.          "/code/span",
332.          'create-auth-token'),
333.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-arg']/code/span",
334.          'arg'),
335.         (".//a[@class='reference internal'][@href='#cmdoption-perl-j']/code/span",
336.          '-j'),
337.         (".//a[@class='reference internal'][@href='#cmdoption-hg-arg-commit']/code/span",
338.          'hg'),
339.         (".//a[@class='reference internal'][@href='#cmdoption-hg-arg-commit']/code/span",
340.          'commit'),
341.         (".//a[@class='reference internal'][@href='#cmdoption-git-commit-p']/code/span",
342.          'git'),
343.         (".//a[@class='reference internal'][@href='#cmdoption-git-commit-p']/code/span",
344.          'commit'),
345.         (".//a[@class='reference internal'][@href='#cmdoption-git-commit-p']/code/span",
346.          '-p'),
347.     ],
348.     'index.html': [
349.         (".//meta[@name='hc'][@content='hcval']", ''),
350.         (".//meta[@name='hc_co'][@content='hcval_co']", ''),
351.         (".//dt[@class='label']/span[@class='brackets']", r'Ref1'),
352.         (".//dt[@class='label']", ''),
353.         (".//li[@class='toctree-l1']/a", 'Testing various markup'),
354.         (".//li[@class='toctree-l2']/a", 'Inline markup'),
355.         (".//title", 'Sphinx <Tests>'),
356.         (".//div[@class='footer']", 'Georg Brandl & Team'),
357.         (".//a[@href='http://python.org/']"
358.          "[@class='reference external']", ''),
359.         (".//li/p/a[@href='genindex.html']/span", 'Index'),
360.         (".//li/p/a[@href='py-modindex.html']/span", 'Module Index'),
361.         # custom sidebar only for contents
362.         (".//h4", 'Contents sidebar'),
363.         # custom JavaScript
364.         (".//script[@src='file://moo.js']", ''),
365.         # URL in contents
366.         (".//a[@class='reference external'][@href='http://sphinx-doc.org/']",
367.          'http://sphinx-doc.org/'),
368.         (".//a[@class='reference external'][@href='http://sphinx-doc.org/latest/']",
369.          'Latest reference'),
370.         # Indirect hyperlink targets across files
371.         (".//a[@href='markup.html#some-label'][@class='reference internal']/span",
372.          '^indirect hyperref$'),
373.     ],
374.     'bom.html': [
375.         (".//title", " File with UTF-8 BOM"),
376.     ],
377.     'extensions.html': [
378.         (".//a[@href='http://python.org/dev/']", "http://python.org/dev/"),
379.         (".//a[@href='http://bugs.python.org/issue1000']", "issue 1000"),
380.         (".//a[@href='http://bugs.python.org/issue1042']", "explicit caption"),
381.     ],
382.     'genindex.html': [
383.         # index entries
384.         (".//a/strong", "Main"),
385.         (".//a/strong", "[1]"),
386.         (".//a/strong", "Other"),
387.         (".//a", "entry"),
388.         (".//li/a", "double"),
389.     ],
390.     'footnote.html': [
391.         (".//a[@class='footnote-reference brackets'][@href='#id9'][@id='id1']", r"1"),
392.         (".//a[@class='footnote-reference brackets'][@href='#id10'][@id='id2']", r"2"),
393.         (".//a[@class='footnote-reference brackets'][@href='#foo'][@id='id3']", r"3"),
394.         (".//a[@class='reference internal'][@href='#bar'][@id='id4']/span", r"\[bar\]"),
395.         (".//a[@class='reference internal'][@href='#baz-qux'][@id='id5']/span", r"\[baz_qux\]"),
396.         (".//a[@class='footnote-reference brackets'][@href='#id11'][@id='id6']", r"4"),
397.         (".//a[@class='footnote-reference brackets'][@href='#id12'][@id='id7']", r"5"),
398.         (".//a[@class='fn-backref'][@href='#id1']", r"1"),
399.         (".//a[@class='fn-backref'][@href='#id2']", r"2"),
400.         (".//a[@class='fn-backref'][@href='#id3']", r"3"),
401.         (".//a[@class='fn-backref'][@href='#id4']", r"bar"),
402.         (".//a[@class='fn-backref'][@href='#id5']", r"baz_qux"),
403.         (".//a[@class='fn-backref'][@href='#id6']", r"4"),
404.         (".//a[@class='fn-backref'][@href='#id7']", r"5"),
405.         (".//a[@class='fn-backref'][@href='#id8']", r"6"),
406.     ],
407.     'otherext.html': [
408.         (".//h1", "Generated section"),
409.         (".//a[@href='_sources/otherext.foo.txt']", ''),
410.     ]
411. }))
412. @pytest.mark.skipif(docutils.__version_info__ < (0, 13),
413.                     reason='docutils-0.13 or above is required')
414. @pytest.mark.sphinx('html', tags=['testtag'],
415.                     confoverrides={'html_context.hckey_co': 'hcval_co'})
416. @pytest.mark.test_params(shared_result='test_build_html_output')
417. def test_html5_output(app, cached_etree_parse, fname, expect):
418.     app.build()
419.     print(app.outdir / fname)
420.     check_xpath(cached_etree_parse(app.outdir / fname), fname, *expect)
421. 
422. 
423. @pytest.mark.sphinx('html', parallel=2)
424. def test_html_parallel(app):
425.     app.build()
426. 
427. 
428. @pytest.mark.skipif(docutils.__version_info__ < (0, 13),
429.                     reason='docutils-0.13 or above is required')
430. @pytest.mark.sphinx('html')
431. @pytest.mark.test_params(shared_result='test_build_html_output')
432. def test_html_download(app):
433.     app.build()
434. 
435.     # subdir/includes.html
436.     result = (app.outdir / 'subdir' / 'includes.html').read_text()
437.     pattern = ('<a class="reference download internal" download="" '
438.                'href="../(_downloads/.*/img.png)">')
439.     matched = re.search(pattern, result)
440.     assert matched
441.     assert (app.outdir / matched.group(1)).exists()
442.     filename = matched.group(1)
443. 
444.     # includes.html
445.     result = (app.outdir / 'includes.html').read_text()
446.     pattern = ('<a class="reference download internal" download="" '
447.                'href="(_downloads/.*/img.png)">')
448.     matched = re.search(pattern, result)
449.     assert matched
450.     assert (app.outdir / matched.group(1)).exists()
451.     assert matched.group(1) == filename
452. 
453. 
454. @pytest.mark.skipif(docutils.__version_info__ < (0, 13),
455.                     reason='docutils-0.13 or above is required')
456. @pytest.mark.sphinx('html', testroot='roles-download')
457. def test_html_download_role(app, status, warning):
458.     app.build()
459.     digest = md5(b'dummy.dat').hexdigest()
460.     assert (app.outdir / '_downloads' / digest / 'dummy.dat').exists()
461.     digest_another = md5(b'another/dummy.dat').hexdigest()
462.     assert (app.outdir / '_downloads' / digest_another / 'dummy.dat').exists()
463. 
464.     content = (app.outdir / 'index.html').read_text()
465.     assert (('<li><p><a class="reference download internal" download="" '
466.              'href="_downloads/%s/dummy.dat">'
467.              '<code class="xref download docutils literal notranslate">'
468.              '<span class="pre">dummy.dat</span></code></a></p></li>' % digest)
469.             in content)
470.     assert (('<li><p><a class="reference download internal" download="" '
471.              'href="_downloads/%s/dummy.dat">'
472.              '<code class="xref download docutils literal notranslate">'
473.              '<span class="pre">another/dummy.dat</span></code></a></p></li>' %
474.              digest_another) in content)
475.     assert ('<li><p><code class="xref download docutils literal notranslate">'
476.             '<span class="pre">not_found.dat</span></code></p></li>' in content)
477.     assert ('<li><p><a class="reference download external" download="" '
478.             'href="http://www.sphinx-doc.org/en/master/_static/sphinxheader.png">'
479.             '<code class="xref download docutils literal notranslate">'
480.             '<span class="pre">Sphinx</span> <span class="pre">logo</span>'
481.             '</code></a></p></li>' in content)
482. 
483. 
484. @pytest.mark.sphinx('html', testroot='build-html-translator')
485. def test_html_translator(app):
486.     app.build()
487.     assert app.builder.docwriter.visitor.depart_with_node == 10
488. 
489. 
490. @pytest.mark.parametrize("fname,expect", flat_dict({
491.     'index.html': [
492.         (".//li[@class='toctree-l3']/a", '1.1.1. Foo A1', True),
493.         (".//li[@class='toctree-l3']/a", '1.2.1. Foo B1', True),
494.         (".//li[@class='toctree-l3']/a", '2.1.1. Bar A1', False),
495.         (".//li[@class='toctree-l3']/a", '2.2.1. Bar B1', False),
496.     ],
497.     'foo.html': [
498.         (".//h1", 'Foo', True),
499.         (".//h2", 'Foo A', True),
500.         (".//h3", 'Foo A1', True),


File: tests/test_markup.py
Line number range: 1 - 500
Content:
1. """
2.     test_markup
3.     ~~~~~~~~~~~
4. 
5.     Test various Sphinx-specific markup extensions.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. 
13. import pytest
14. from docutils import frontend, nodes, utils
15. from docutils.parsers.rst import Parser as RstParser
16. 
17. from sphinx import addnodes
18. from sphinx.builders.html.transforms import KeyboardTransform
19. from sphinx.builders.latex import LaTeXBuilder
20. from sphinx.roles import XRefRole
21. from sphinx.testing.util import Struct, assert_node
22. from sphinx.transforms import SphinxSmartQuotes
23. from sphinx.util import docutils, texescape
24. from sphinx.util.docutils import sphinx_domains
25. from sphinx.writers.html import HTMLTranslator, HTMLWriter
26. from sphinx.writers.latex import LaTeXTranslator, LaTeXWriter
27. 
28. 
29. @pytest.fixture
30. def settings(app):
31.     texescape.init()  # otherwise done by the latex builder
32.     optparser = frontend.OptionParser(
33.         components=(RstParser, HTMLWriter, LaTeXWriter))
34.     settings = optparser.get_default_values()
35.     settings.smart_quotes = True
36.     settings.env = app.builder.env
37.     settings.env.temp_data['docname'] = 'dummy'
38.     settings.contentsname = 'dummy'
39.     settings.rfc_base_url = 'http://tools.ietf.org/html/'
40.     domain_context = sphinx_domains(settings.env)
41.     domain_context.enable()
42.     yield settings
43.     domain_context.disable()
44. 
45. 
46. @pytest.fixture
47. def new_document(settings):
48.     def create():
49.         document = utils.new_document('test data', settings)
50.         document['file'] = 'dummy'
51.         return document
52. 
53.     return create
54. 
55. 
56. @pytest.fixture
57. def inliner(new_document):
58.     document = new_document()
59.     document.reporter.get_source_and_line = lambda line=1: ('dummy.rst', line)
60.     return Struct(document=document, reporter=document.reporter)
61. 
62. 
63. @pytest.fixture
64. def parse(new_document):
65.     def parse_(rst):
66.         document = new_document()
67.         parser = RstParser()
68.         parser.parse(rst, document)
69.         SphinxSmartQuotes(document, startnode=None).apply()
70.         for msg in document.traverse(nodes.system_message):
71.             if msg['level'] == 1:
72.                 msg.replace_self([])
73.         return document
74.     return parse_
75. 
76. 
77. # since we're not resolving the markup afterwards, these nodes may remain
78. class ForgivingTranslator:
79.     def visit_pending_xref(self, node):
80.         pass
81. 
82.     def depart_pending_xref(self, node):
83.         pass
84. 
85. 
86. class ForgivingHTMLTranslator(HTMLTranslator, ForgivingTranslator):
87.     pass
88. 
89. 
90. class ForgivingLaTeXTranslator(LaTeXTranslator, ForgivingTranslator):
91.     pass
92. 
93. 
94. @pytest.fixture
95. def verify_re_html(app, parse):
96.     def verify(rst, html_expected):
97.         document = parse(rst)
98.         KeyboardTransform(document).apply()
99.         html_translator = ForgivingHTMLTranslator(document, app.builder)
100.         document.walkabout(html_translator)
101.         html_translated = ''.join(html_translator.fragment).strip()
102.         assert re.match(html_expected, html_translated), 'from ' + rst
103.     return verify
104. 
105. 
106. @pytest.fixture
107. def verify_re_latex(app, parse):
108.     def verify(rst, latex_expected):
109.         document = parse(rst)
110.         app.builder = LaTeXBuilder(app)
111.         app.builder.set_environment(app.env)
112.         app.builder.init()
113.         theme = app.builder.themes.get('manual')
114.         latex_translator = ForgivingLaTeXTranslator(document, app.builder, theme)
115.         latex_translator.first_document = -1  # don't write \begin{document}
116.         document.walkabout(latex_translator)
117.         latex_translated = ''.join(latex_translator.body).strip()
118.         assert re.match(latex_expected, latex_translated), 'from ' + repr(rst)
119.     return verify
120. 
121. 
122. @pytest.fixture
123. def verify_re(verify_re_html, verify_re_latex):
124.     def verify_re_(rst, html_expected, latex_expected):
125.         if html_expected:
126.             verify_re_html(rst, html_expected)
127.         if latex_expected:
128.             verify_re_latex(rst, latex_expected)
129.     return verify_re_
130. 
131. 
132. @pytest.fixture
133. def verify(verify_re_html, verify_re_latex):
134.     def verify_(rst, html_expected, latex_expected):
135.         if html_expected:
136.             verify_re_html(rst, re.escape(html_expected) + '$')
137.         if latex_expected:
138.             verify_re_latex(rst, re.escape(latex_expected) + '$')
139.     return verify_
140. 
141. 
142. @pytest.fixture
143. def get_verifier(verify, verify_re):
144.     v = {
145.         'verify': verify,
146.         'verify_re': verify_re,
147.     }
148. 
149.     def get(name):
150.         return v[name]
151.     return get
152. 
153. 
154. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
155.     (
156.         # pep role
157.         'verify',
158.         ':pep:`8`',
159.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
160.          'href="http://www.python.org/dev/peps/pep-0008"><strong>PEP 8</strong></a></p>'),
161.         ('\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
162.          '!PEP 8@\\spxentry{PEP 8}}\\sphinxhref{http://www.python.org/dev/peps/pep-0008}'
163.          '{\\sphinxstylestrong{PEP 8}}')
164.     ),
165.     (
166.         # pep role with anchor
167.         'verify',
168.         ':pep:`8#id1`',
169.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
170.          'href="http://www.python.org/dev/peps/pep-0008#id1">'
171.          '<strong>PEP 8#id1</strong></a></p>'),
172.         ('\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
173.          '!PEP 8\\#id1@\\spxentry{PEP 8\\#id1}}\\sphinxhref'
174.          '{http://www.python.org/dev/peps/pep-0008\\#id1}'
175.          '{\\sphinxstylestrong{PEP 8\\#id1}}')
176.     ),
177.     (
178.         # rfc role
179.         'verify',
180.         ':rfc:`2324`',
181.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
182.          'href="http://tools.ietf.org/html/rfc2324.html"><strong>RFC 2324</strong></a></p>'),
183.         ('\\index{RFC@\\spxentry{RFC}!RFC 2324@\\spxentry{RFC 2324}}'
184.          '\\sphinxhref{http://tools.ietf.org/html/rfc2324.html}'
185.          '{\\sphinxstylestrong{RFC 2324}}')
186.     ),
187.     (
188.         # rfc role with anchor
189.         'verify',
190.         ':rfc:`2324#id1`',
191.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
192.          'href="http://tools.ietf.org/html/rfc2324.html#id1">'
193.          '<strong>RFC 2324#id1</strong></a></p>'),
194.         ('\\index{RFC@\\spxentry{RFC}!RFC 2324\\#id1@\\spxentry{RFC 2324\\#id1}}'
195.          '\\sphinxhref{http://tools.ietf.org/html/rfc2324.html\\#id1}'
196.          '{\\sphinxstylestrong{RFC 2324\\#id1}}')
197.     ),
198.     (
199.         # correct interpretation of code with whitespace
200.         'verify_re',
201.         '``code   sample``',
202.         ('<p><code class="(samp )?docutils literal notranslate"><span class="pre">'
203.          'code</span>&#160;&#160; <span class="pre">sample</span></code></p>'),
204.         r'\\sphinxcode{\\sphinxupquote{code   sample}}',
205.     ),
206.     (
207.         # interpolation of arrows in menuselection
208.         'verify',
209.         ':menuselection:`a --> b`',
210.         ('<p><span class="menuselection">a \N{TRIANGULAR BULLET} b</span></p>'),
211.         '\\sphinxmenuselection{a \\(\\rightarrow\\) b}',
212.     ),
213.     (
214.         # interpolation of ampersands in menuselection
215.         'verify',
216.         ':menuselection:`&Foo -&&- &Bar`',
217.         ('<p><span class="menuselection"><span class="accelerator">F</span>oo '
218.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
219.         r'\sphinxmenuselection{\sphinxaccelerator{F}oo \sphinxhyphen{}\&\sphinxhyphen{} \sphinxaccelerator{B}ar}',
220.     ),
221.     (
222.         # interpolation of ampersands in guilabel
223.         'verify',
224.         ':guilabel:`&Foo -&&- &Bar`',
225.         ('<p><span class="guilabel"><span class="accelerator">F</span>oo '
226.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
227.         r'\sphinxguilabel{\sphinxaccelerator{F}oo \sphinxhyphen{}\&\sphinxhyphen{} \sphinxaccelerator{B}ar}',
228.     ),
229.     (
230.         # no ampersands in guilabel
231.         'verify',
232.         ':guilabel:`Foo`',
233.         '<p><span class="guilabel">Foo</span></p>',
234.         r'\sphinxguilabel{Foo}',
235.     ),
236.     (
237.         # kbd role
238.         'verify',
239.         ':kbd:`space`',
240.         '<p><kbd class="kbd docutils literal notranslate">space</kbd></p>',
241.         '\\sphinxkeyboard{\\sphinxupquote{space}}',
242.     ),
243.     (
244.         # kbd role
245.         'verify',
246.         ':kbd:`Control+X`',
247.         ('<p><kbd class="kbd docutils literal notranslate">'
248.          '<kbd class="kbd docutils literal notranslate">Control</kbd>'
249.          '+'
250.          '<kbd class="kbd docutils literal notranslate">X</kbd>'
251.          '</kbd></p>'),
252.         '\\sphinxkeyboard{\\sphinxupquote{Control+X}}',
253.     ),
254.     (
255.         # kbd role
256.         'verify',
257.         ':kbd:`M-x  M-s`',
258.         ('<p><kbd class="kbd docutils literal notranslate">'
259.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
260.          '-'
261.          '<kbd class="kbd docutils literal notranslate">x</kbd>'
262.          '  '
263.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
264.          '-'
265.          '<kbd class="kbd docutils literal notranslate">s</kbd>'
266.          '</kbd></p>'),
267.         '\\sphinxkeyboard{\\sphinxupquote{M\\sphinxhyphen{}x  M\\sphinxhyphen{}s}}',
268.     ),
269.     (
270.         # non-interpolation of dashes in option role
271.         'verify_re',
272.         ':option:`--with-option`',
273.         ('<p><code( class="xref std std-option docutils literal notranslate")?>'
274.          '<span class="pre">--with-option</span></code></p>$'),
275.         r'\\sphinxcode{\\sphinxupquote{\\sphinxhyphen{}\\sphinxhyphen{}with\\sphinxhyphen{}option}}$',
276.     ),
277.     (
278.         # verify smarty-pants quotes
279.         'verify',
280.         '"John"',
281.         '<p>“John”</p>',
282.         "“John”",
283.     ),
284.     (
285.         # ... but not in literal text
286.         'verify',
287.         '``"John"``',
288.         ('<p><code class="docutils literal notranslate"><span class="pre">'
289.          '&quot;John&quot;</span></code></p>'),
290.         '\\sphinxcode{\\sphinxupquote{"John"}}',
291.     ),
292.     (
293.         # verify classes for inline roles
294.         'verify',
295.         ':manpage:`mp(1)`',
296.         '<p><em class="manpage">mp(1)</em></p>',
297.         '\\sphinxstyleliteralemphasis{\\sphinxupquote{mp(1)}}',
298.     ),
299.     (
300.         # correct escaping in normal mode
301.         'verify',
302.         'Γ\\\\∞$',
303.         None,
304.         'Γ\\textbackslash{}\\(\\infty\\)\\$',
305.     ),
306.     (
307.         # in verbatim code fragments
308.         'verify',
309.         '::\n\n @Γ\\∞${}',
310.         None,
311.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
312.          '@Γ\\PYGZbs{}\\(\\infty\\)\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
313.          '\\end{sphinxVerbatim}'),
314.     ),
315.     (
316.         # in URIs
317.         'verify_re',
318.         '`test <https://www.google.com/~me/>`_',
319.         None,
320.         r'\\sphinxhref{https://www.google.com/~me/}{test}.*',
321.     ),
322.     (
323.         # description list: simple
324.         'verify',
325.         'term\n    description',
326.         '<dl class="docutils">\n<dt>term</dt><dd>description</dd>\n</dl>',
327.         None,
328.     ),
329.     (
330.         # description list: with classifiers
331.         'verify',
332.         'term : class1 : class2\n    description',
333.         ('<dl class="docutils">\n<dt>term<span class="classifier">class1</span>'
334.          '<span class="classifier">class2</span></dt><dd>description</dd>\n</dl>'),
335.         None,
336.     ),
337.     (
338.         # glossary (description list): multiple terms
339.         'verify',
340.         '.. glossary::\n\n   term1\n   term2\n       description',
341.         ('<dl class="glossary docutils">\n<dt id="term-term1">term1</dt>'
342.          '<dt id="term-term2">term2</dt><dd>description</dd>\n</dl>'),
343.         None,
344.     ),
345. ])
346. def test_inline(get_verifier, type, rst, html_expected, latex_expected):
347.     verifier = get_verifier(type)
348.     verifier(rst, html_expected, latex_expected)
349. 
350. 
351. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
352.     (
353.         'verify',
354.         r'4 backslashes \\\\',
355.         r'<p>4 backslashes \\</p>',
356.         None,
357.     ),
358. ])
359. @pytest.mark.skipif(docutils.__version_info__ < (0, 16),
360.                     reason='docutils-0.16 or above is required')
361. def test_inline_docutils16(get_verifier, type, rst, html_expected, latex_expected):
362.     verifier = get_verifier(type)
363.     verifier(rst, html_expected, latex_expected)
364. 
365. 
366. @pytest.mark.sphinx(confoverrides={'latex_engine': 'xelatex'})
367. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
368.     (
369.         # in verbatim code fragments
370.         'verify',
371.         '::\n\n @Γ\\∞${}',
372.         None,
373.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
374.          '@Γ\\PYGZbs{}∞\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
375.          '\\end{sphinxVerbatim}'),
376.     ),
377. ])
378. def test_inline_for_unicode_latex_engine(get_verifier, type, rst,
379.                                          html_expected, latex_expected):
380.     verifier = get_verifier(type)
381.     verifier(rst, html_expected, latex_expected)
382. 
383. 
384. def test_samp_role(parse):
385.     # no braces
386.     text = ':samp:`a{b}c`'
387.     doctree = parse(text)
388.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
389.                                                               [nodes.emphasis, "b"],
390.                                                               "c")])
391.     # nested braces
392.     text = ':samp:`a{{b}}c`'
393.     doctree = parse(text)
394.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
395.                                                               [nodes.emphasis, "{b"],
396.                                                               "}c")])
397. 
398.     # half-opened braces
399.     text = ':samp:`a{bc`'
400.     doctree = parse(text)
401.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{bc"])
402. 
403.     # escaped braces
404.     text = ':samp:`a\\\\{b}c`'
405.     doctree = parse(text)
406.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{b}c"])
407. 
408.     # no braces (whitespaces are keeped as is)
409.     text = ':samp:`code   sample`'
410.     doctree = parse(text)
411.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "code   sample"])
412. 
413. 
414. def test_download_role(parse):
415.     # implicit
416.     text = ':download:`sphinx.rst`'
417.     doctree = parse(text)
418.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
419.                              nodes.literal, "sphinx.rst"])
420.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
421.                 refexplicit=False, reftarget='sphinx.rst', refwarn=False)
422.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
423. 
424.     # explicit
425.     text = ':download:`reftitle <sphinx.rst>`'
426.     doctree = parse(text)
427.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
428.                              nodes.literal, "reftitle"])
429.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
430.                 refexplicit=True, reftarget='sphinx.rst', refwarn=False)
431.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
432. 
433. 
434. def test_XRefRole(inliner):
435.     role = XRefRole()
436. 
437.     # implicit
438.     doctrees, errors = role('ref', 'rawtext', 'text', 5, inliner, {}, [])
439.     assert len(doctrees) == 1
440.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text'])
441.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
442.                 refexplicit=False, refwarn=False)
443.     assert errors == []
444. 
445.     # explicit
446.     doctrees, errors = role('ref', 'rawtext', 'title <target>', 5, inliner, {}, [])
447.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'title'])
448.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='target',
449.                 refexplicit=True, refwarn=False)
450. 
451.     # bang
452.     doctrees, errors = role('ref', 'rawtext', '!title <target>', 5, inliner, {}, [])
453.     assert_node(doctrees[0], [nodes.literal, 'title <target>'])
454. 
455.     # refdomain
456.     doctrees, errors = role('test:doc', 'rawtext', 'text', 5, inliner, {}, [])
457.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text'])
458.     assert_node(doctrees[0], refdoc='dummy', refdomain='test', reftype='doc', reftarget='text',
459.                 refexplicit=False, refwarn=False)
460. 
461.     # fix_parens
462.     role = XRefRole(fix_parens=True)
463.     doctrees, errors = role('ref', 'rawtext', 'text()', 5, inliner, {}, [])
464.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text()'])
465.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
466.                 refexplicit=False, refwarn=False)
467. 
468.     # lowercase
469.     role = XRefRole(lowercase=True)
470.     doctrees, errors = role('ref', 'rawtext', 'TEXT', 5, inliner, {}, [])
471.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'TEXT'])
472.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
473.                 refexplicit=False, refwarn=False)
474. 
475. 
476. @pytest.mark.sphinx('dummy', testroot='prolog')
477. def test_rst_prolog(app, status, warning):
478.     app.builder.build_all()
479.     rst = app.env.get_doctree('restructuredtext')
480.     md = app.env.get_doctree('markdown')
481. 
482.     # rst_prolog
483.     assert_node(rst[0], nodes.paragraph)
484.     assert_node(rst[0][0], nodes.emphasis)
485.     assert_node(rst[0][0][0], nodes.Text)
486.     assert rst[0][0][0] == 'Hello world'
487. 
488.     # rst_epilog
489.     assert_node(rst[-1], nodes.section)
490.     assert_node(rst[-1][-1], nodes.paragraph)
491.     assert_node(rst[-1][-1][0], nodes.emphasis)
492.     assert_node(rst[-1][-1][0][0], nodes.Text)
493.     assert rst[-1][-1][0][0] == 'Good-bye world'
494. 
495.     # rst_prolog & rst_epilog on exlucding reST parser
496.     assert not md.rawsource.startswith('*Hello world*.')
497.     assert not md.rawsource.endswith('*Good-bye world*.\n')
498. 
499. 
500. @pytest.mark.sphinx('dummy', testroot='keep_warnings')

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-21 00:15:12,754 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='The user explicitly asked for the full content of `tests/test_build_html.py`.', relative_path='tests/test_build_html.py', start_line=1, end_line=500), ContextOutput(reasoning='The user explicitly asked for the full content of `tests/test_markup.py`.', relative_path='tests/test_markup.py', start_line=1, end_line=500)]
2025-12-21 00:15:12,761 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 2 contexts to memory for query: Please provide the full content of `tests/test_build_html.py` and `tests/test_markup.py`.
2025-12-21 00:15:12,761 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-21 00:15:12,761 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-21 00:15:12,762 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 2 new contexts to 0 existing contexts
2025-12-21 00:15:12,762 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 2 total contexts (removed 0 duplicates)
2025-12-21 00:15:12,763 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       ├── main.yml
|       └── nodejs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── deprecated.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-two-links
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes

Description: **Describe the bug**

The `:kbd:` role produces incorrect HTML when:

1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)
2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)

**To Reproduce**

For the below three keyboard definitions:
```
(1) :kbd:`-`
(2) :kbd:`+`
(3) :kbd:`Shift-+`
```

The following three incorrect output is generated:

(1) `-` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(2) `+` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(3) `+` is treated as a separator within a compound-keystroke, with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Shift</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

**Expected behavior**

For single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.

For compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).

**Screenshot**

![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)


**Environment info**
- OS: Windows
- Python version: 3.9.1
- Sphinx version: 3.4.0
- Sphinx extensions:  -
- Extra tools: -


Patch information:
diff --git a/doc/usage/restructuredtext/roles.rst b/doc/usage/restructuredtext/roles.rst
index de12a41b5..0a8ca2452 100644
--- a/doc/usage/restructuredtext/roles.rst
+++ b/doc/usage/restructuredtext/roles.rst
@@ -350,6 +350,10 @@ different style:
    reference to a specific application or platform, the same sequence should be
    marked as ``:kbd:`Control-x Control-f```.
 
+   Note that the characters '-', '+', and '^' are treated as separators only
+   when they separate two non-empty key names. When used alone or at the
+   beginning or end of a compound sequence, they are treated as individual
+   keys.
 .. rst:role:: mailheader
 
    The name of an RFC 822-style mail header.  This markup does not imply that
diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py
index c91da57e9..e04e0d838 100644
--- a/sphinx/builders/html/transforms.py
+++ b/sphinx/builders/html/transforms.py
@@ -8,8 +8,7 @@
     :license: BSD, see LICENSE for details.
 """
 
-import re
-from typing import Any, Dict
+from typing import Any, Dict, List
 
 from docutils import nodes
 
@@ -37,26 +36,71 @@ class KeyboardTransform(SphinxPostTransform):
     """
     default_priority = 400
     builders = ('html',)
-    pattern = re.compile(r'(-|\+|\^|\s+)')
 
     def run(self, **kwargs: Any) -> None:
         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
         for node in self.document.traverse(matcher):  # type: nodes.literal
-            parts = self.pattern.split(node[-1].astext())
-            if len(parts) == 1:
+            text = node[-1].astext()
+
+            keys = []  # type: List[str]
+            prefix_seps = []  # type: List[str]
+            infix_seps = []  # type: List[str]
+
+            buf = ''
+            seen_key = False
+            i = 0
+            length = len(text)
+            while i < length:
+                ch = text[i]
+                if ch.isspace():
+                    # accumulate consecutive whitespace as a single separator
+                    j = i
+                    while i < length and text[i].isspace():
+                        i += 1
+                    sep = text[j:i]
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        infix_seps.append(sep)
+                    else:
+                        if not seen_key:
+                            prefix_seps.append(sep)
+                        else:
+                            infix_seps.append(sep)
+                    continue
+                elif ch in '-+^':
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        # treat as separator between two non-empty keys
+                        infix_seps.append(ch)
+                    else:
+                        # treat as a key when at start of sequence or
+                        # immediately after a separator (avoid empty keys)
+                        buf += ch
+                    i += 1
+                else:
+                    buf += ch
+                    i += 1
+
+            if buf:
+                keys.append(buf)
+
+            # If there is only a single key, leave as-is
+            if len(keys) <= 1:
                 continue
 
+            # rebuild node: preserve leading separators, then interleave keys and separators
             node.pop()
-            while parts:
-                key = parts.pop(0)
-                node += nodes.literal('', key, classes=["kbd"])
-
-                try:
-                    # key separator (ex. -, +, ^)
-                    sep = parts.pop(0)
-                    node += nodes.Text(sep)
-                except IndexError:
-                    pass
+            for sep in prefix_seps:
+                node += nodes.Text(sep)
+
+            for idx in range(len(keys)):
+                node += nodes.literal('', keys[idx], classes=["kbd"])
+                if idx < len(infix_seps):
+                    node += nodes.Text(infix_seps[idx])
 
 
 def setup(app: Sphinx) -> Dict[str, Any]:


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of `tests/test_build_html.py` and `tests/test_markup.py`.
Extra Requirements: 
Purpose: I need to find three existing test cases that demonstrate the functionality of the `:kbd:` role to understand how it is tested and to find examples similar to the reported bug.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: tests/test_build_html.py
Line number range: 1 - 500
Content:
1. """
2.     test_build_html
3.     ~~~~~~~~~~~~~~~
4. 
5.     Test the HTML builder and check output against XPath.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import os
12. import re
13. from distutils.version import LooseVersion
14. from itertools import chain, cycle
15. 
16. import pygments
17. import pytest
18. from html5lib import HTMLParser
19. 
20. from sphinx.builders.html import validate_html_extra_path, validate_html_static_path
21. from sphinx.errors import ConfigError
22. from sphinx.testing.util import strip_escseq
23. from sphinx.util import docutils, md5
24. from sphinx.util.inventory import InventoryFile
25. 
26. ENV_WARNINGS = """\
27. %(root)s/autodoc_fodder.py:docstring of autodoc_fodder.MarkupError:\\d+: \
28. WARNING: Explicit markup ends without a blank line; unexpected unindent.
29. %(root)s/index.rst:\\d+: WARNING: Encoding 'utf-8-sig' used for reading included \
30. file '%(root)s/wrongenc.inc' seems to be wrong, try giving an :encoding: option
31. %(root)s/index.rst:\\d+: WARNING: invalid single index entry ''
32. %(root)s/index.rst:\\d+: WARNING: image file not readable: foo.png
33. %(root)s/index.rst:\\d+: WARNING: download file not readable: %(root)s/nonexisting.png
34. %(root)s/undecodable.rst:\\d+: WARNING: undecodable source characters, replacing \
35. with "\\?": b?'here: >>>(\\\\|/)xbb<<<((\\\\|/)r)?'
36. """
37. 
38. HTML_WARNINGS = ENV_WARNINGS + """\
39. %(root)s/index.rst:\\d+: WARNING: unknown option: &option
40. %(root)s/index.rst:\\d+: WARNING: citation not found: missing
41. %(root)s/index.rst:\\d+: WARNING: a suitable image for html builder not found: foo.\\*
42. %(root)s/index.rst:\\d+: WARNING: Could not lex literal_block as "c". Highlighting skipped.
43. """
44. 
45. 
46. etree_cache = {}
47. 
48. 
49. @pytest.fixture(scope='module')
50. def cached_etree_parse():
51.     def parse(fname):
52.         if fname in etree_cache:
53.             return etree_cache[fname]
54.         with (fname).open('rb') as fp:
55.             etree = HTMLParser(namespaceHTMLElements=False).parse(fp)
56.             etree_cache.clear()
57.             etree_cache[fname] = etree
58.             return etree
59.     yield parse
60.     etree_cache.clear()
61. 
62. 
63. def flat_dict(d):
64.     return chain.from_iterable(
65.         [
66.             zip(cycle([fname]), values)
67.             for fname, values in d.items()
68.         ]
69.     )
70. 
71. 
72. def tail_check(check):
73.     rex = re.compile(check)
74. 
75.     def checker(nodes):
76.         for node in nodes:
77.             if node.tail and rex.search(node.tail):
78.                 return True
79.         assert False, '%r not found in tail of any nodes %s' % (check, nodes)
80.     return checker
81. 
82. 
83. def check_xpath(etree, fname, path, check, be_found=True):
84.     nodes = list(etree.findall(path))
85.     if check is None:
86.         assert nodes == [], ('found any nodes matching xpath '
87.                              '%r in file %s' % (path, fname))
88.         return
89.     else:
90.         assert nodes != [], ('did not find any node matching xpath '
91.                              '%r in file %s' % (path, fname))
92.     if hasattr(check, '__call__'):
93.         check(nodes)
94.     elif not check:
95.         # only check for node presence
96.         pass
97.     else:
98.         def get_text(node):
99.             if node.text is not None:
100.                 # the node has only one text
101.                 return node.text
102.             else:
103.                 # the node has tags and text; gather texts just under the node
104.                 return ''.join(n.tail or '' for n in node)
105. 
106.         rex = re.compile(check)
107.         if be_found:
108.             if any(rex.search(get_text(node)) for node in nodes):
109.                 return
110.         else:
111.             if all(not rex.search(get_text(node)) for node in nodes):
112.                 return
113. 
114.         assert False, ('%r not found in any node matching '
115.                        'path %s in %s: %r' % (check, path, fname,
116.                                               [node.text for node in nodes]))
117. 
118. 
119. @pytest.mark.sphinx('html', testroot='warnings')
120. def test_html_warnings(app, warning):
121.     app.build()
122.     html_warnings = strip_escseq(re.sub(re.escape(os.sep) + '{1,2}', '/', warning.getvalue()))
123.     html_warnings_exp = HTML_WARNINGS % {
124.         'root': re.escape(app.srcdir.replace(os.sep, '/'))}
125.     assert re.match(html_warnings_exp + '$', html_warnings), \
126.         'Warnings don\'t match:\n' + \
127.         '--- Expected (regex):\n' + html_warnings_exp + \
128.         '--- Got:\n' + html_warnings
129. 
130. 
131. @pytest.mark.sphinx('html', confoverrides={'html4_writer': True})
132. def test_html4_output(app, status, warning):
133.     app.build()
134. 
135. 
136. @pytest.mark.parametrize("fname,expect", flat_dict({
137.     'images.html': [
138.         (".//img[@src='_images/img.png']", ''),
139.         (".//img[@src='_images/img1.png']", ''),
140.         (".//img[@src='_images/simg.png']", ''),
141.         (".//img[@src='_images/svgimg.svg']", ''),
142.         (".//a[@href='_sources/images.txt']", ''),
143.     ],
144.     'subdir/images.html': [
145.         (".//img[@src='../_images/img1.png']", ''),
146.         (".//img[@src='../_images/rimg.png']", ''),
147.     ],
148.     'subdir/includes.html': [
149.         (".//a[@class='reference download internal']", ''),
150.         (".//img[@src='../_images/img.png']", ''),
151.         (".//p", 'This is an include file.'),
152.         (".//pre/span", 'line 1'),
153.         (".//pre/span", 'line 2'),
154.     ],
155.     'includes.html': [
156.         (".//pre", 'Max Strauß'),
157.         (".//a[@class='reference download internal']", ''),
158.         (".//pre/span", '"quotes"'),
159.         (".//pre/span", "'included'"),
160.         (".//pre/span[@class='s2']", 'üöä'),
161.         (".//div[@class='inc-pyobj1 highlight-text notranslate']//pre",
162.          r'^class Foo:\n    pass\n\s*$'),
163.         (".//div[@class='inc-pyobj2 highlight-text notranslate']//pre",
164.          r'^    def baz\(\):\n        pass\n\s*$'),
165.         (".//div[@class='inc-lines highlight-text notranslate']//pre",
166.          r'^class Foo:\n    pass\nclass Bar:\n$'),
167.         (".//div[@class='inc-startend highlight-text notranslate']//pre",
168.          '^foo = "Including Unicode characters: üöä"\\n$'),
169.         (".//div[@class='inc-preappend highlight-text notranslate']//pre",
170.          r'(?m)^START CODE$'),
171.         (".//div[@class='inc-pyobj-dedent highlight-python notranslate']//span",
172.          r'def'),
173.         (".//div[@class='inc-tab3 highlight-text notranslate']//pre",
174.          r'-| |-'),
175.         (".//div[@class='inc-tab8 highlight-python notranslate']//pre/span",
176.          r'-|      |-'),
177.     ],
178.     'autodoc.html': [
179.         (".//dl[@class='py class']/dt[@id='autodoc_target.Class']", ''),
180.         (".//dl[@class='py function']/dt[@id='autodoc_target.function']/em/span", r'\*\*'),
181.         (".//dl[@class='py function']/dt[@id='autodoc_target.function']/em/span", r'kwds'),
182.         (".//dd/p", r'Return spam\.'),
183.     ],
184.     'extapi.html': [
185.         (".//strong", 'from class: Bar'),
186.     ],
187.     'markup.html': [
188.         (".//title", 'set by title directive'),
189.         (".//p/em", 'Section author: Georg Brandl'),
190.         (".//p/em", 'Module author: Georg Brandl'),
191.         # created by the meta directive
192.         (".//meta[@name='author'][@content='Me']", ''),
193.         (".//meta[@name='keywords'][@content='docs, sphinx']", ''),
194.         # a label created by ``.. _label:``
195.         (".//div[@id='label']", ''),
196.         # code with standard code blocks
197.         (".//pre", '^some code$'),
198.         # an option list
199.         (".//span[@class='option']", '--help'),
200.         # admonitions
201.         (".//p[@class='admonition-title']", 'My Admonition'),
202.         (".//div[@class='admonition note']/p", 'Note text.'),
203.         (".//div[@class='admonition warning']/p", 'Warning text.'),
204.         # inline markup
205.         (".//li/p/strong", r'^command\\n$'),
206.         (".//li/p/strong", r'^program\\n$'),
207.         (".//li/p/em", r'^dfn\\n$'),
208.         (".//li/p/kbd", r'^kbd\\n$'),
209.         (".//li/p/span", 'File \N{TRIANGULAR BULLET} Close'),
210.         (".//li/p/code/span[@class='pre']", '^a/$'),
211.         (".//li/p/code/em/span[@class='pre']", '^varpart$'),
212.         (".//li/p/code/em/span[@class='pre']", '^i$'),
213.         (".//a[@href='https://www.python.org/dev/peps/pep-0008']"
214.          "[@class='pep reference external']/strong", 'PEP 8'),
215.         (".//a[@href='https://www.python.org/dev/peps/pep-0008']"
216.          "[@class='pep reference external']/strong",
217.          'Python Enhancement Proposal #8'),
218.         (".//a[@href='https://tools.ietf.org/html/rfc1.html']"
219.          "[@class='rfc reference external']/strong", 'RFC 1'),
220.         (".//a[@href='https://tools.ietf.org/html/rfc1.html']"
221.          "[@class='rfc reference external']/strong", 'Request for Comments #1'),
222.         (".//a[@href='objects.html#envvar-HOME']"
223.          "[@class='reference internal']/code/span[@class='pre']", 'HOME'),
224.         (".//a[@href='#with']"
225.          "[@class='reference internal']/code/span[@class='pre']", '^with$'),
226.         (".//a[@href='#grammar-token-try_stmt']"
227.          "[@class='reference internal']/code/span", '^statement$'),
228.         (".//a[@href='#some-label'][@class='reference internal']/span", '^here$'),
229.         (".//a[@href='#some-label'][@class='reference internal']/span", '^there$'),
230.         (".//a[@href='subdir/includes.html']"
231.          "[@class='reference internal']/span", 'Including in subdir'),
232.         (".//a[@href='objects.html#cmdoption-python-c']"
233.          "[@class='reference internal']/code/span[@class='pre']", '-c'),
234.         # abbreviations
235.         (".//abbr[@title='abbreviation']", '^abbr$'),
236.         # version stuff
237.         (".//div[@class='versionadded']/p/span", 'New in version 0.6: '),
238.         (".//div[@class='versionadded']/p/span",
239.          tail_check('First paragraph of versionadded')),
240.         (".//div[@class='versionchanged']/p/span",
241.          tail_check('First paragraph of versionchanged')),
242.         (".//div[@class='versionchanged']/p",
243.          'Second paragraph of versionchanged'),
244.         # footnote reference
245.         (".//a[@class='footnote-reference brackets']", r'1'),
246.         # created by reference lookup
247.         (".//a[@href='index.html#ref1']", ''),
248.         # ``seealso`` directive
249.         (".//div/p[@class='admonition-title']", 'See also'),
250.         # a ``hlist`` directive
251.         (".//table[@class='hlist']/tbody/tr/td/ul/li/p", '^This$'),
252.         # a ``centered`` directive
253.         (".//p[@class='centered']/strong", 'LICENSE'),
254.         # a glossary
255.         (".//dl/dt[@id='term-boson']", 'boson'),
256.         # a production list
257.         (".//pre/strong", 'try_stmt'),
258.         (".//pre/a[@href='#grammar-token-try1_stmt']/code/span", 'try1_stmt'),
259.         # tests for ``only`` directive
260.         (".//p", 'A global substitution!'),
261.         (".//p", 'In HTML.'),
262.         (".//p", 'In both.'),
263.         (".//p", 'Always present'),
264.         # tests for ``any`` role
265.         (".//a[@href='#with']/span", 'headings'),
266.         (".//a[@href='objects.html#func_without_body']/code/span", 'objects'),
267.         # tests for numeric labels
268.         (".//a[@href='#id1'][@class='reference internal']/span", 'Testing various markup'),
269.         # tests for smartypants
270.         (".//li/p", 'Smart “quotes” in English ‘text’.'),
271.         (".//li/p", 'Smart — long and – short dashes.'),
272.         (".//li/p", 'Ellipsis…'),
273.         (".//li/p/code/span[@class='pre']", 'foo--"bar"...'),
274.         (".//p", 'Этот «абзац» должен использовать „русские“ кавычки.'),
275.         (".//p", 'Il dit : « C’est “super” ! »'),
276.     ],
277.     'objects.html': [
278.         (".//dt[@id='mod.Cls.meth1']", ''),
279.         (".//dt[@id='errmod.Error']", ''),
280.         (".//dt/code", r'long\(parameter,\s* list\)'),
281.         (".//dt/code", 'another one'),
282.         (".//a[@href='#mod.Cls'][@class='reference internal']", ''),
283.         (".//dl[@class='std userdesc']", ''),
284.         (".//dt[@id='userdesc-myobj']", ''),
285.         (".//a[@href='#userdesc-myobj'][@class='reference internal']", ''),
286.         # docfields
287.         (".//a[@class='reference internal'][@href='#TimeInt']/em", 'TimeInt'),
288.         (".//a[@class='reference internal'][@href='#Time']", 'Time'),
289.         (".//a[@class='reference internal'][@href='#errmod.Error']/strong", 'Error'),
290.         # C references
291.         (".//span[@class='pre']", 'CFunction()'),
292.         (".//a[@href='#c.Sphinx_DoSomething']", ''),
293.         (".//a[@href='#c.SphinxStruct.member']", ''),
294.         (".//a[@href='#c.SPHINX_USE_PYTHON']", ''),
295.         (".//a[@href='#c.SphinxType']", ''),
296.         (".//a[@href='#c.sphinx_global']", ''),
297.         # test global TOC created by toctree()
298.         (".//ul[@class='current']/li[@class='toctree-l1 current']/a[@href='#']",
299.          'Testing object descriptions'),
300.         (".//li[@class='toctree-l1']/a[@href='markup.html']",
301.          'Testing various markup'),
302.         # test unknown field names
303.         (".//dt[@class='field-odd']", 'Field_name'),
304.         (".//dt[@class='field-even']", 'Field_name all lower'),
305.         (".//dt[@class='field-odd']", 'FIELD_NAME'),
306.         (".//dt[@class='field-even']", 'FIELD_NAME ALL CAPS'),
307.         (".//dt[@class='field-odd']", 'Field_Name'),
308.         (".//dt[@class='field-even']", 'Field_Name All Word Caps'),
309.         (".//dt[@class='field-odd']", 'Field_name'),
310.         (".//dt[@class='field-even']", 'Field_name First word cap'),
311.         (".//dt[@class='field-odd']", 'FIELd_name'),
312.         (".//dt[@class='field-even']", 'FIELd_name PARTial caps'),
313.         # custom sidebar
314.         (".//h4", 'Custom sidebar'),
315.         # docfields
316.         (".//dd[@class='field-odd']/p/strong", '^moo$'),
317.         (".//dd[@class='field-odd']/p/strong", tail_check(r'\(Moo\) .* Moo')),
318.         (".//dd[@class='field-odd']/ul/li/p/strong", '^hour$'),
319.         (".//dd[@class='field-odd']/ul/li/p/em", '^DuplicateType$'),
320.         (".//dd[@class='field-odd']/ul/li/p/em", tail_check(r'.* Some parameter')),
321.         # others
322.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-p']/code/span",
323.          'perl'),
324.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-p']/code/span",
325.          '\\+p'),
326.         (".//a[@class='reference internal'][@href='#cmdoption-perl-ObjC']/code/span",
327.          '--ObjC\\+\\+'),
328.         (".//a[@class='reference internal'][@href='#cmdoption-perl-plugin.option']/code/span",
329.          '--plugin.option'),
330.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-create-auth-token']"
331.          "/code/span",
332.          'create-auth-token'),
333.         (".//a[@class='reference internal'][@href='#cmdoption-perl-arg-arg']/code/span",
334.          'arg'),
335.         (".//a[@class='reference internal'][@href='#cmdoption-perl-j']/code/span",
336.          '-j'),
337.         (".//a[@class='reference internal'][@href='#cmdoption-hg-arg-commit']/code/span",
338.          'hg'),
339.         (".//a[@class='reference internal'][@href='#cmdoption-hg-arg-commit']/code/span",
340.          'commit'),
341.         (".//a[@class='reference internal'][@href='#cmdoption-git-commit-p']/code/span",
342.          'git'),
343.         (".//a[@class='reference internal'][@href='#cmdoption-git-commit-p']/code/span",
344.          'commit'),
345.         (".//a[@class='reference internal'][@href='#cmdoption-git-commit-p']/code/span",
346.          '-p'),
347.     ],
348.     'index.html': [
349.         (".//meta[@name='hc'][@content='hcval']", ''),
350.         (".//meta[@name='hc_co'][@content='hcval_co']", ''),
351.         (".//dt[@class='label']/span[@class='brackets']", r'Ref1'),
352.         (".//dt[@class='label']", ''),
353.         (".//li[@class='toctree-l1']/a", 'Testing various markup'),
354.         (".//li[@class='toctree-l2']/a", 'Inline markup'),
355.         (".//title", 'Sphinx <Tests>'),
356.         (".//div[@class='footer']", 'Georg Brandl & Team'),
357.         (".//a[@href='http://python.org/']"
358.          "[@class='reference external']", ''),
359.         (".//li/p/a[@href='genindex.html']/span", 'Index'),
360.         (".//li/p/a[@href='py-modindex.html']/span", 'Module Index'),
361.         # custom sidebar only for contents
362.         (".//h4", 'Contents sidebar'),
363.         # custom JavaScript
364.         (".//script[@src='file://moo.js']", ''),
365.         # URL in contents
366.         (".//a[@class='reference external'][@href='http://sphinx-doc.org/']",
367.          'http://sphinx-doc.org/'),
368.         (".//a[@class='reference external'][@href='http://sphinx-doc.org/latest/']",
369.          'Latest reference'),
370.         # Indirect hyperlink targets across files
371.         (".//a[@href='markup.html#some-label'][@class='reference internal']/span",
372.          '^indirect hyperref$'),
373.     ],
374.     'bom.html': [
375.         (".//title", " File with UTF-8 BOM"),
376.     ],
377.     'extensions.html': [
378.         (".//a[@href='http://python.org/dev/']", "http://python.org/dev/"),
379.         (".//a[@href='http://bugs.python.org/issue1000']", "issue 1000"),
380.         (".//a[@href='http://bugs.python.org/issue1042']", "explicit caption"),
381.     ],
382.     'genindex.html': [
383.         # index entries
384.         (".//a/strong", "Main"),
385.         (".//a/strong", "[1]"),
386.         (".//a/strong", "Other"),
387.         (".//a", "entry"),
388.         (".//li/a", "double"),
389.     ],
390.     'footnote.html': [
391.         (".//a[@class='footnote-reference brackets'][@href='#id9'][@id='id1']", r"1"),
392.         (".//a[@class='footnote-reference brackets'][@href='#id10'][@id='id2']", r"2"),
393.         (".//a[@class='footnote-reference brackets'][@href='#foo'][@id='id3']", r"3"),
394.         (".//a[@class='reference internal'][@href='#bar'][@id='id4']/span", r"\[bar\]"),
395.         (".//a[@class='reference internal'][@href='#baz-qux'][@id='id5']/span", r"\[baz_qux\]"),
396.         (".//a[@class='footnote-reference brackets'][@href='#id11'][@id='id6']", r"4"),
397.         (".//a[@class='footnote-reference brackets'][@href='#id12'][@id='id7']", r"5"),
398.         (".//a[@class='fn-backref'][@href='#id1']", r"1"),
399.         (".//a[@class='fn-backref'][@href='#id2']", r"2"),
400.         (".//a[@class='fn-backref'][@href='#id3']", r"3"),
401.         (".//a[@class='fn-backref'][@href='#id4']", r"bar"),
402.         (".//a[@class='fn-backref'][@href='#id5']", r"baz_qux"),
403.         (".//a[@class='fn-backref'][@href='#id6']", r"4"),
404.         (".//a[@class='fn-backref'][@href='#id7']", r"5"),
405.         (".//a[@class='fn-backref'][@href='#id8']", r"6"),
406.     ],
407.     'otherext.html': [
408.         (".//h1", "Generated section"),
409.         (".//a[@href='_sources/otherext.foo.txt']", ''),
410.     ]
411. }))
412. @pytest.mark.skipif(docutils.__version_info__ < (0, 13),
413.                     reason='docutils-0.13 or above is required')
414. @pytest.mark.sphinx('html', tags=['testtag'],
415.                     confoverrides={'html_context.hckey_co': 'hcval_co'})
416. @pytest.mark.test_params(shared_result='test_build_html_output')
417. def test_html5_output(app, cached_etree_parse, fname, expect):
418.     app.build()
419.     print(app.outdir / fname)
420.     check_xpath(cached_etree_parse(app.outdir / fname), fname, *expect)
421. 
422. 
423. @pytest.mark.sphinx('html', parallel=2)
424. def test_html_parallel(app):
425.     app.build()
426. 
427. 
428. @pytest.mark.skipif(docutils.__version_info__ < (0, 13),
429.                     reason='docutils-0.13 or above is required')
430. @pytest.mark.sphinx('html')
431. @pytest.mark.test_params(shared_result='test_build_html_output')
432. def test_html_download(app):
433.     app.build()
434. 
435.     # subdir/includes.html
436.     result = (app.outdir / 'subdir' / 'includes.html').read_text()
437.     pattern = ('<a class="reference download internal" download="" '
438.                'href="../(_downloads/.*/img.png)">')
439.     matched = re.search(pattern, result)
440.     assert matched
441.     assert (app.outdir / matched.group(1)).exists()
442.     filename = matched.group(1)
443. 
444.     # includes.html
445.     result = (app.outdir / 'includes.html').read_text()
446.     pattern = ('<a class="reference download internal" download="" '
447.                'href="(_downloads/.*/img.png)">')
448.     matched = re.search(pattern, result)
449.     assert matched
450.     assert (app.outdir / matched.group(1)).exists()
451.     assert matched.group(1) == filename
452. 
453. 
454. @pytest.mark.skipif(docutils.__version_info__ < (0, 13),
455.                     reason='docutils-0.13 or above is required')
456. @pytest.mark.sphinx('html', testroot='roles-download')
457. def test_html_download_role(app, status, warning):
458.     app.build()
459.     digest = md5(b'dummy.dat').hexdigest()
460.     assert (app.outdir / '_downloads' / digest / 'dummy.dat').exists()
461.     digest_another = md5(b'another/dummy.dat').hexdigest()
462.     assert (app.outdir / '_downloads' / digest_another / 'dummy.dat').exists()
463. 
464.     content = (app.outdir / 'index.html').read_text()
465.     assert (('<li><p><a class="reference download internal" download="" '
466.              'href="_downloads/%s/dummy.dat">'
467.              '<code class="xref download docutils literal notranslate">'
468.              '<span class="pre">dummy.dat</span></code></a></p></li>' % digest)
469.             in content)
470.     assert (('<li><p><a class="reference download internal" download="" '
471.              'href="_downloads/%s/dummy.dat">'
472.              '<code class="xref download docutils literal notranslate">'
473.              '<span class="pre">another/dummy.dat</span></code></a></p></li>' %
474.              digest_another) in content)
475.     assert ('<li><p><code class="xref download docutils literal notranslate">'
476.             '<span class="pre">not_found.dat</span></code></p></li>' in content)
477.     assert ('<li><p><a class="reference download external" download="" '
478.             'href="http://www.sphinx-doc.org/en/master/_static/sphinxheader.png">'
479.             '<code class="xref download docutils literal notranslate">'
480.             '<span class="pre">Sphinx</span> <span class="pre">logo</span>'
481.             '</code></a></p></li>' in content)
482. 
483. 
484. @pytest.mark.sphinx('html', testroot='build-html-translator')
485. def test_html_translator(app):
486.     app.build()
487.     assert app.builder.docwriter.visitor.depart_with_node == 10
488. 
489. 
490. @pytest.mark.parametrize("fname,expect", flat_dict({
491.     'index.html': [
492.         (".//li[@class='toctree-l3']/a", '1.1.1. Foo A1', True),
493.         (".//li[@class='toctree-l3']/a", '1.2.1. Foo B1', True),
494.         (".//li[@class='toctree-l3']/a", '2.1.1. Bar A1', False),
495.         (".//li[@class='toctree-l3']/a", '2.2.1. Bar B1', False),
496.     ],
497.     'foo.html': [
498.         (".//h1", 'Foo', True),
499.         (".//h2", 'Foo A', True),
500.         (".//h3", 'Foo A1', True),


File: tests/test_markup.py
Line number range: 1 - 500
Content:
1. """
2.     test_markup
3.     ~~~~~~~~~~~
4. 
5.     Test various Sphinx-specific markup extensions.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. 
13. import pytest
14. from docutils import frontend, nodes, utils
15. from docutils.parsers.rst import Parser as RstParser
16. 
17. from sphinx import addnodes
18. from sphinx.builders.html.transforms import KeyboardTransform
19. from sphinx.builders.latex import LaTeXBuilder
20. from sphinx.roles import XRefRole
21. from sphinx.testing.util import Struct, assert_node
22. from sphinx.transforms import SphinxSmartQuotes
23. from sphinx.util import docutils, texescape
24. from sphinx.util.docutils import sphinx_domains
25. from sphinx.writers.html import HTMLTranslator, HTMLWriter
26. from sphinx.writers.latex import LaTeXTranslator, LaTeXWriter
27. 
28. 
29. @pytest.fixture
30. def settings(app):
31.     texescape.init()  # otherwise done by the latex builder
32.     optparser = frontend.OptionParser(
33.         components=(RstParser, HTMLWriter, LaTeXWriter))
34.     settings = optparser.get_default_values()
35.     settings.smart_quotes = True
36.     settings.env = app.builder.env
37.     settings.env.temp_data['docname'] = 'dummy'
38.     settings.contentsname = 'dummy'
39.     settings.rfc_base_url = 'http://tools.ietf.org/html/'
40.     domain_context = sphinx_domains(settings.env)
41.     domain_context.enable()
42.     yield settings
43.     domain_context.disable()
44. 
45. 
46. @pytest.fixture
47. def new_document(settings):
48.     def create():
49.         document = utils.new_document('test data', settings)
50.         document['file'] = 'dummy'
51.         return document
52. 
53.     return create
54. 
55. 
56. @pytest.fixture
57. def inliner(new_document):
58.     document = new_document()
59.     document.reporter.get_source_and_line = lambda line=1: ('dummy.rst', line)
60.     return Struct(document=document, reporter=document.reporter)
61. 
62. 
63. @pytest.fixture
64. def parse(new_document):
65.     def parse_(rst):
66.         document = new_document()
67.         parser = RstParser()
68.         parser.parse(rst, document)
69.         SphinxSmartQuotes(document, startnode=None).apply()
70.         for msg in document.traverse(nodes.system_message):
71.             if msg['level'] == 1:
72.                 msg.replace_self([])
73.         return document
74.     return parse_
75. 
76. 
77. # since we're not resolving the markup afterwards, these nodes may remain
78. class ForgivingTranslator:
79.     def visit_pending_xref(self, node):
80.         pass
81. 
82.     def depart_pending_xref(self, node):
83.         pass
84. 
85. 
86. class ForgivingHTMLTranslator(HTMLTranslator, ForgivingTranslator):
87.     pass
88. 
89. 
90. class ForgivingLaTeXTranslator(LaTeXTranslator, ForgivingTranslator):
91.     pass
92. 
93. 
94. @pytest.fixture
95. def verify_re_html(app, parse):
96.     def verify(rst, html_expected):
97.         document = parse(rst)
98.         KeyboardTransform(document).apply()
99.         html_translator = ForgivingHTMLTranslator(document, app.builder)
100.         document.walkabout(html_translator)
101.         html_translated = ''.join(html_translator.fragment).strip()
102.         assert re.match(html_expected, html_translated), 'from ' + rst
103.     return verify
104. 
105. 
106. @pytest.fixture
107. def verify_re_latex(app, parse):
108.     def verify(rst, latex_expected):
109.         document = parse(rst)
110.         app.builder = LaTeXBuilder(app)
111.         app.builder.set_environment(app.env)
112.         app.builder.init()
113.         theme = app.builder.themes.get('manual')
114.         latex_translator = ForgivingLaTeXTranslator(document, app.builder, theme)
115.         latex_translator.first_document = -1  # don't write \begin{document}
116.         document.walkabout(latex_translator)
117.         latex_translated = ''.join(latex_translator.body).strip()
118.         assert re.match(latex_expected, latex_translated), 'from ' + repr(rst)
119.     return verify
120. 
121. 
122. @pytest.fixture
123. def verify_re(verify_re_html, verify_re_latex):
124.     def verify_re_(rst, html_expected, latex_expected):
125.         if html_expected:
126.             verify_re_html(rst, html_expected)
127.         if latex_expected:
128.             verify_re_latex(rst, latex_expected)
129.     return verify_re_
130. 
131. 
132. @pytest.fixture
133. def verify(verify_re_html, verify_re_latex):
134.     def verify_(rst, html_expected, latex_expected):
135.         if html_expected:
136.             verify_re_html(rst, re.escape(html_expected) + '$')
137.         if latex_expected:
138.             verify_re_latex(rst, re.escape(latex_expected) + '$')
139.     return verify_
140. 
141. 
142. @pytest.fixture
143. def get_verifier(verify, verify_re):
144.     v = {
145.         'verify': verify,
146.         'verify_re': verify_re,
147.     }
148. 
149.     def get(name):
150.         return v[name]
151.     return get
152. 
153. 
154. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
155.     (
156.         # pep role
157.         'verify',
158.         ':pep:`8`',
159.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
160.          'href="http://www.python.org/dev/peps/pep-0008"><strong>PEP 8</strong></a></p>'),
161.         ('\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
162.          '!PEP 8@\\spxentry{PEP 8}}\\sphinxhref{http://www.python.org/dev/peps/pep-0008}'
163.          '{\\sphinxstylestrong{PEP 8}}')
164.     ),
165.     (
166.         # pep role with anchor
167.         'verify',
168.         ':pep:`8#id1`',
169.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
170.          'href="http://www.python.org/dev/peps/pep-0008#id1">'
171.          '<strong>PEP 8#id1</strong></a></p>'),
172.         ('\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
173.          '!PEP 8\\#id1@\\spxentry{PEP 8\\#id1}}\\sphinxhref'
174.          '{http://www.python.org/dev/peps/pep-0008\\#id1}'
175.          '{\\sphinxstylestrong{PEP 8\\#id1}}')
176.     ),
177.     (
178.         # rfc role
179.         'verify',
180.         ':rfc:`2324`',
181.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
182.          'href="http://tools.ietf.org/html/rfc2324.html"><strong>RFC 2324</strong></a></p>'),
183.         ('\\index{RFC@\\spxentry{RFC}!RFC 2324@\\spxentry{RFC 2324}}'
184.          '\\sphinxhref{http://tools.ietf.org/html/rfc2324.html}'
185.          '{\\sphinxstylestrong{RFC 2324}}')
186.     ),
187.     (
188.         # rfc role with anchor
189.         'verify',
190.         ':rfc:`2324#id1`',
191.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
192.          'href="http://tools.ietf.org/html/rfc2324.html#id1">'
193.          '<strong>RFC 2324#id1</strong></a></p>'),
194.         ('\\index{RFC@\\spxentry{RFC}!RFC 2324\\#id1@\\spxentry{RFC 2324\\#id1}}'
195.          '\\sphinxhref{http://tools.ietf.org/html/rfc2324.html\\#id1}'
196.          '{\\sphinxstylestrong{RFC 2324\\#id1}}')
197.     ),
198.     (
199.         # correct interpretation of code with whitespace
200.         'verify_re',
201.         '``code   sample``',
202.         ('<p><code class="(samp )?docutils literal notranslate"><span class="pre">'
203.          'code</span>&#160;&#160; <span class="pre">sample</span></code></p>'),
204.         r'\\sphinxcode{\\sphinxupquote{code   sample}}',
205.     ),
206.     (
207.         # interpolation of arrows in menuselection
208.         'verify',
209.         ':menuselection:`a --> b`',
210.         ('<p><span class="menuselection">a \N{TRIANGULAR BULLET} b</span></p>'),
211.         '\\sphinxmenuselection{a \\(\\rightarrow\\) b}',
212.     ),
213.     (
214.         # interpolation of ampersands in menuselection
215.         'verify',
216.         ':menuselection:`&Foo -&&- &Bar`',
217.         ('<p><span class="menuselection"><span class="accelerator">F</span>oo '
218.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
219.         r'\sphinxmenuselection{\sphinxaccelerator{F}oo \sphinxhyphen{}\&\sphinxhyphen{} \sphinxaccelerator{B}ar}',
220.     ),
221.     (
222.         # interpolation of ampersands in guilabel
223.         'verify',
224.         ':guilabel:`&Foo -&&- &Bar`',
225.         ('<p><span class="guilabel"><span class="accelerator">F</span>oo '
226.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
227.         r'\sphinxguilabel{\sphinxaccelerator{F}oo \sphinxhyphen{}\&\sphinxhyphen{} \sphinxaccelerator{B}ar}',
228.     ),
229.     (
230.         # no ampersands in guilabel
231.         'verify',
232.         ':guilabel:`Foo`',
233.         '<p><span class="guilabel">Foo</span></p>',
234.         r'\sphinxguilabel{Foo}',
235.     ),
236.     (
237.         # kbd role
238.         'verify',
239.         ':kbd:`space`',
240.         '<p><kbd class="kbd docutils literal notranslate">space</kbd></p>',
241.         '\\sphinxkeyboard{\\sphinxupquote{space}}',
242.     ),
243.     (
244.         # kbd role
245.         'verify',
246.         ':kbd:`Control+X`',
247.         ('<p><kbd class="kbd docutils literal notranslate">'
248.          '<kbd class="kbd docutils literal notranslate">Control</kbd>'
249.          '+'
250.          '<kbd class="kbd docutils literal notranslate">X</kbd>'
251.          '</kbd></p>'),
252.         '\\sphinxkeyboard{\\sphinxupquote{Control+X}}',
253.     ),
254.     (
255.         # kbd role
256.         'verify',
257.         ':kbd:`M-x  M-s`',
258.         ('<p><kbd class="kbd docutils literal notranslate">'
259.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
260.          '-'
261.          '<kbd class="kbd docutils literal notranslate">x</kbd>'
262.          '  '
263.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
264.          '-'
265.          '<kbd class="kbd docutils literal notranslate">s</kbd>'
266.          '</kbd></p>'),
267.         '\\sphinxkeyboard{\\sphinxupquote{M\\sphinxhyphen{}x  M\\sphinxhyphen{}s}}',
268.     ),
269.     (
270.         # non-interpolation of dashes in option role
271.         'verify_re',
272.         ':option:`--with-option`',
273.         ('<p><code( class="xref std std-option docutils literal notranslate")?>'
274.          '<span class="pre">--with-option</span></code></p>$'),
275.         r'\\sphinxcode{\\sphinxupquote{\\sphinxhyphen{}\\sphinxhyphen{}with\\sphinxhyphen{}option}}$',
276.     ),
277.     (
278.         # verify smarty-pants quotes
279.         'verify',
280.         '"John"',
281.         '<p>“John”</p>',
282.         "“John”",
283.     ),
284.     (
285.         # ... but not in literal text
286.         'verify',
287.         '``"John"``',
288.         ('<p><code class="docutils literal notranslate"><span class="pre">'
289.          '&quot;John&quot;</span></code></p>'),
290.         '\\sphinxcode{\\sphinxupquote{"John"}}',
291.     ),
292.     (
293.         # verify classes for inline roles
294.         'verify',
295.         ':manpage:`mp(1)`',
296.         '<p><em class="manpage">mp(1)</em></p>',
297.         '\\sphinxstyleliteralemphasis{\\sphinxupquote{mp(1)}}',
298.     ),
299.     (
300.         # correct escaping in normal mode
301.         'verify',
302.         'Γ\\\\∞$',
303.         None,
304.         'Γ\\textbackslash{}\\(\\infty\\)\\$',
305.     ),
306.     (
307.         # in verbatim code fragments
308.         'verify',
309.         '::\n\n @Γ\\∞${}',
310.         None,
311.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
312.          '@Γ\\PYGZbs{}\\(\\infty\\)\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
313.          '\\end{sphinxVerbatim}'),
314.     ),
315.     (
316.         # in URIs
317.         'verify_re',
318.         '`test <https://www.google.com/~me/>`_',
319.         None,
320.         r'\\sphinxhref{https://www.google.com/~me/}{test}.*',
321.     ),
322.     (
323.         # description list: simple
324.         'verify',
325.         'term\n    description',
326.         '<dl class="docutils">\n<dt>term</dt><dd>description</dd>\n</dl>',
327.         None,
328.     ),
329.     (
330.         # description list: with classifiers
331.         'verify',
332.         'term : class1 : class2\n    description',
333.         ('<dl class="docutils">\n<dt>term<span class="classifier">class1</span>'
334.          '<span class="classifier">class2</span></dt><dd>description</dd>\n</dl>'),
335.         None,
336.     ),
337.     (
338.         # glossary (description list): multiple terms
339.         'verify',
340.         '.. glossary::\n\n   term1\n   term2\n       description',
341.         ('<dl class="glossary docutils">\n<dt id="term-term1">term1</dt>'
342.          '<dt id="term-term2">term2</dt><dd>description</dd>\n</dl>'),
343.         None,
344.     ),
345. ])
346. def test_inline(get_verifier, type, rst, html_expected, latex_expected):
347.     verifier = get_verifier(type)
348.     verifier(rst, html_expected, latex_expected)
349. 
350. 
351. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
352.     (
353.         'verify',
354.         r'4 backslashes \\\\',
355.         r'<p>4 backslashes \\</p>',
356.         None,
357.     ),
358. ])
359. @pytest.mark.skipif(docutils.__version_info__ < (0, 16),
360.                     reason='docutils-0.16 or above is required')
361. def test_inline_docutils16(get_verifier, type, rst, html_expected, latex_expected):
362.     verifier = get_verifier(type)
363.     verifier(rst, html_expected, latex_expected)
364. 
365. 
366. @pytest.mark.sphinx(confoverrides={'latex_engine': 'xelatex'})
367. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
368.     (
369.         # in verbatim code fragments
370.         'verify',
371.         '::\n\n @Γ\\∞${}',
372.         None,
373.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
374.          '@Γ\\PYGZbs{}∞\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
375.          '\\end{sphinxVerbatim}'),
376.     ),
377. ])
378. def test_inline_for_unicode_latex_engine(get_verifier, type, rst,
379.                                          html_expected, latex_expected):
380.     verifier = get_verifier(type)
381.     verifier(rst, html_expected, latex_expected)
382. 
383. 
384. def test_samp_role(parse):
385.     # no braces
386.     text = ':samp:`a{b}c`'
387.     doctree = parse(text)
388.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
389.                                                               [nodes.emphasis, "b"],
390.                                                               "c")])
391.     # nested braces
392.     text = ':samp:`a{{b}}c`'
393.     doctree = parse(text)
394.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
395.                                                               [nodes.emphasis, "{b"],
396.                                                               "}c")])
397. 
398.     # half-opened braces
399.     text = ':samp:`a{bc`'
400.     doctree = parse(text)
401.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{bc"])
402. 
403.     # escaped braces
404.     text = ':samp:`a\\\\{b}c`'
405.     doctree = parse(text)
406.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{b}c"])
407. 
408.     # no braces (whitespaces are keeped as is)
409.     text = ':samp:`code   sample`'
410.     doctree = parse(text)
411.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "code   sample"])
412. 
413. 
414. def test_download_role(parse):
415.     # implicit
416.     text = ':download:`sphinx.rst`'
417.     doctree = parse(text)
418.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
419.                              nodes.literal, "sphinx.rst"])
420.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
421.                 refexplicit=False, reftarget='sphinx.rst', refwarn=False)
422.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
423. 
424.     # explicit
425.     text = ':download:`reftitle <sphinx.rst>`'
426.     doctree = parse(text)
427.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
428.                              nodes.literal, "reftitle"])
429.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
430.                 refexplicit=True, reftarget='sphinx.rst', refwarn=False)
431.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
432. 
433. 
434. def test_XRefRole(inliner):
435.     role = XRefRole()
436. 
437.     # implicit
438.     doctrees, errors = role('ref', 'rawtext', 'text', 5, inliner, {}, [])
439.     assert len(doctrees) == 1
440.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text'])
441.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
442.                 refexplicit=False, refwarn=False)
443.     assert errors == []
444. 
445.     # explicit
446.     doctrees, errors = role('ref', 'rawtext', 'title <target>', 5, inliner, {}, [])
447.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'title'])
448.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='target',
449.                 refexplicit=True, refwarn=False)
450. 
451.     # bang
452.     doctrees, errors = role('ref', 'rawtext', '!title <target>', 5, inliner, {}, [])
453.     assert_node(doctrees[0], [nodes.literal, 'title <target>'])
454. 
455.     # refdomain
456.     doctrees, errors = role('test:doc', 'rawtext', 'text', 5, inliner, {}, [])
457.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text'])
458.     assert_node(doctrees[0], refdoc='dummy', refdomain='test', reftype='doc', reftarget='text',
459.                 refexplicit=False, refwarn=False)
460. 
461.     # fix_parens
462.     role = XRefRole(fix_parens=True)
463.     doctrees, errors = role('ref', 'rawtext', 'text()', 5, inliner, {}, [])
464.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text()'])
465.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
466.                 refexplicit=False, refwarn=False)
467. 
468.     # lowercase
469.     role = XRefRole(lowercase=True)
470.     doctrees, errors = role('ref', 'rawtext', 'TEXT', 5, inliner, {}, [])
471.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'TEXT'])
472.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
473.                 refexplicit=False, refwarn=False)
474. 
475. 
476. @pytest.mark.sphinx('dummy', testroot='prolog')
477. def test_rst_prolog(app, status, warning):
478.     app.builder.build_all()
479.     rst = app.env.get_doctree('restructuredtext')
480.     md = app.env.get_doctree('markdown')
481. 
482.     # rst_prolog
483.     assert_node(rst[0], nodes.paragraph)
484.     assert_node(rst[0][0], nodes.emphasis)
485.     assert_node(rst[0][0][0], nodes.Text)
486.     assert rst[0][0][0] == 'Hello world'
487. 
488.     # rst_epilog
489.     assert_node(rst[-1], nodes.section)
490.     assert_node(rst[-1][-1], nodes.paragraph)
491.     assert_node(rst[-1][-1][0], nodes.emphasis)
492.     assert_node(rst[-1][-1][0][0], nodes.Text)
493.     assert rst[-1][-1][0][0] == 'Good-bye world'
494. 
495.     # rst_prolog & rst_epilog on exlucding reST parser
496.     assert not md.rawsource.startswith('*Hello world*.')
497.     assert not md.rawsource.endswith('*Good-bye world*.\n')
498. 
499. 
500. @pytest.mark.sphinx('dummy', testroot='keep_warnings')

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-21 00:15:40,760 - thread-136728000071360.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The user wants to find three relevant test cases for a bug related to the `:kbd:` role. The provided context, specifically the file `tests/test_markup.py`, contains three parameterized tests for the `:kbd:` role that are directly relevant to the bug. These tests cover simple keys and compound keys using separators like `+` and `-`. The file also includes all necessary fixtures, helper functions, and imports to understand these tests completely. Therefore, the current context is sufficient to fulfill the user's request, and no additional information is needed." query='' extra_requirements='' purpose=''
2025-12-21 00:15:40,761 - thread-136728000071360.prometheus_context_collector - INFO - Successfully retrieved 2 context snippets
