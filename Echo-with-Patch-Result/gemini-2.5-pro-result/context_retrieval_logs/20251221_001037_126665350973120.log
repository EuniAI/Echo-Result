2025-12-21 00:10:37,872 - thread-126665350973120.prometheus_context_collector - INFO - Starting context retrieval for query: 
Issue: kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes

Description: **Describe the bug**

The `:kbd:` role produces incorrect HTML when:

1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)
2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)

**To Reproduce**

For the below three keyboard definitions:
```
(1) :kbd:`-`
(2) :kbd:`+`
(3) :kbd:`Shift-+`
```

The following three incorrect output is generated:

(1) `-` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(2) `+` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(3) `+` is treated as a separator within a compound-keystroke, with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Shift</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

**Expected behavior**

For single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.

For compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).

**Screenshot**

![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)


**Environment info**
- OS: Windows
- Python version: 3.9.1
- Sphinx version: 3.4.0
- Sphinx extensions:  -
- Extra tools: -


Patch information:
diff --git a/doc/usage/restructuredtext/roles.rst b/doc/usage/restructuredtext/roles.rst
index de12a41b5..0a8ca2452 100644
--- a/doc/usage/restructuredtext/roles.rst
+++ b/doc/usage/restructuredtext/roles.rst
@@ -350,6 +350,10 @@ different style:
    reference to a specific application or platform, the same sequence should be
    marked as ``:kbd:`Control-x Control-f```.
 
+   Note that the characters '-', '+', and '^' are treated as separators only
+   when they separate two non-empty key names. When used alone or at the
+   beginning or end of a compound sequence, they are treated as individual
+   keys.
 .. rst:role:: mailheader
 
    The name of an RFC 822-style mail header.  This markup does not imply that
diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py
index c91da57e9..e04e0d838 100644
--- a/sphinx/builders/html/transforms.py
+++ b/sphinx/builders/html/transforms.py
@@ -8,8 +8,7 @@
     :license: BSD, see LICENSE for details.
 """
 
-import re
-from typing import Any, Dict
+from typing import Any, Dict, List
 
 from docutils import nodes
 
@@ -37,26 +36,71 @@ class KeyboardTransform(SphinxPostTransform):
     """
     default_priority = 400
     builders = ('html',)
-    pattern = re.compile(r'(-|\+|\^|\s+)')
 
     def run(self, **kwargs: Any) -> None:
         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
         for node in self.document.traverse(matcher):  # type: nodes.literal
-            parts = self.pattern.split(node[-1].astext())
-            if len(parts) == 1:
+            text = node[-1].astext()
+
+            keys = []  # type: List[str]
+            prefix_seps = []  # type: List[str]
+            infix_seps = []  # type: List[str]
+
+            buf = ''
+            seen_key = False
+            i = 0
+            length = len(text)
+            while i < length:
+                ch = text[i]
+                if ch.isspace():
+                    # accumulate consecutive whitespace as a single separator
+                    j = i
+                    while i < length and text[i].isspace():
+                        i += 1
+                    sep = text[j:i]
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        infix_seps.append(sep)
+                    else:
+                        if not seen_key:
+                            prefix_seps.append(sep)
+                        else:
+                            infix_seps.append(sep)
+                    continue
+                elif ch in '-+^':
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        # treat as separator between two non-empty keys
+                        infix_seps.append(ch)
+                    else:
+                        # treat as a key when at start of sequence or
+                        # immediately after a separator (avoid empty keys)
+                        buf += ch
+                    i += 1
+                else:
+                    buf += ch
+                    i += 1
+
+            if buf:
+                keys.append(buf)
+
+            # If there is only a single key, leave as-is
+            if len(keys) <= 1:
                 continue
 
+            # rebuild node: preserve leading separators, then interleave keys and separators
             node.pop()
-            while parts:
-                key = parts.pop(0)
-                node += nodes.literal('', key, classes=["kbd"])
-
-                try:
-                    # key separator (ex. -, +, ^)
-                    sep = parts.pop(0)
-                    node += nodes.Text(sep)
-                except IndexError:
-                    pass
+            for sep in prefix_seps:
+                node += nodes.Text(sep)
+
+            for idx in range(len(keys)):
+                node += nodes.literal('', keys[idx], classes=["kbd"])
+                if idx < len(infix_seps):
+                    node += nodes.Text(infix_seps[idx])
 
 
 def setup(app: Sphinx) -> Dict[str, Any]:


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

2025-12-21 00:10:37,939 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       ├── main.yml
|       └── nodejs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── deprecated.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-two-links
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes

Description: **Describe the bug**

The `:kbd:` role produces incorrect HTML when:

1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)
2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)

**To Reproduce**

For the below three keyboard definitions:
```
(1) :kbd:`-`
(2) :kbd:`+`
(3) :kbd:`Shift-+`
```

The following three incorrect output is generated:

(1) `-` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(2) `+` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(3) `+` is treated as a separator within a compound-keystroke, with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Shift</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

**Expected behavior**

For single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.

For compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).

**Screenshot**

![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)


**Environment info**
- OS: Windows
- Python version: 3.9.1
- Sphinx version: 3.4.0
- Sphinx extensions:  -
- Extra tools: -


Patch information:
diff --git a/doc/usage/restructuredtext/roles.rst b/doc/usage/restructuredtext/roles.rst
index de12a41b5..0a8ca2452 100644
--- a/doc/usage/restructuredtext/roles.rst
+++ b/doc/usage/restructuredtext/roles.rst
@@ -350,6 +350,10 @@ different style:
    reference to a specific application or platform, the same sequence should be
    marked as ``:kbd:`Control-x Control-f```.
 
+   Note that the characters '-', '+', and '^' are treated as separators only
+   when they separate two non-empty key names. When used alone or at the
+   beginning or end of a compound sequence, they are treated as individual
+   keys.
 .. rst:role:: mailheader
 
    The name of an RFC 822-style mail header.  This markup does not imply that
diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py
index c91da57e9..e04e0d838 100644
--- a/sphinx/builders/html/transforms.py
+++ b/sphinx/builders/html/transforms.py
@@ -8,8 +8,7 @@
     :license: BSD, see LICENSE for details.
 """
 
-import re
-from typing import Any, Dict
+from typing import Any, Dict, List
 
 from docutils import nodes
 
@@ -37,26 +36,71 @@ class KeyboardTransform(SphinxPostTransform):
     """
     default_priority = 400
     builders = ('html',)
-    pattern = re.compile(r'(-|\+|\^|\s+)')
 
     def run(self, **kwargs: Any) -> None:
         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
         for node in self.document.traverse(matcher):  # type: nodes.literal
-            parts = self.pattern.split(node[-1].astext())
-            if len(parts) == 1:
+            text = node[-1].astext()
+
+            keys = []  # type: List[str]
+            prefix_seps = []  # type: List[str]
+            infix_seps = []  # type: List[str]
+
+            buf = ''
+            seen_key = False
+            i = 0
+            length = len(text)
+            while i < length:
+                ch = text[i]
+                if ch.isspace():
+                    # accumulate consecutive whitespace as a single separator
+                    j = i
+                    while i < length and text[i].isspace():
+                        i += 1
+                    sep = text[j:i]
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        infix_seps.append(sep)
+                    else:
+                        if not seen_key:
+                            prefix_seps.append(sep)
+                        else:
+                            infix_seps.append(sep)
+                    continue
+                elif ch in '-+^':
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        # treat as separator between two non-empty keys
+                        infix_seps.append(ch)
+                    else:
+                        # treat as a key when at start of sequence or
+                        # immediately after a separator (avoid empty keys)
+                        buf += ch
+                    i += 1
+                else:
+                    buf += ch
+                    i += 1
+
+            if buf:
+                keys.append(buf)
+
+            # If there is only a single key, leave as-is
+            if len(keys) <= 1:
                 continue
 
+            # rebuild node: preserve leading separators, then interleave keys and separators
             node.pop()
-            while parts:
-                key = parts.pop(0)
-                node += nodes.literal('', key, classes=["kbd"])
-
-                try:
-                    # key separator (ex. -, +, ^)
-                    sep = parts.pop(0)
-                    node += nodes.Text(sep)
-                except IndexError:
-                    pass
+            for sep in prefix_seps:
+                node += nodes.Text(sep)
+
+            for idx in range(len(keys)):
+                node += nodes.literal('', keys[idx], classes=["kbd"])
+                if idx < len(infix_seps):
+                    node += nodes.Text(infix_seps[idx])
 
 
 def setup(app: Sphinx) -> Dict[str, Any]:


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-21 00:11:24,827 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user wants to understand a fix for the `:kbd:` role in Sphinx. The provided patch modifies `KeyboardTransform` in `sphinx/builders/html/transforms.py`. To get a complete picture, I need to see: 1) the definition of the `:kbd:` role which creates the initial node (likely in `sphinx/roles.py`), 2) the definition of `SphinxPostTransform`, the base class for `KeyboardTransform` (likely in `sphinx/transforms/__init__.py`), and 3) the full source of the file containing the transform, `sphinx/builders/html/transforms.py`.' query='Please provide the full content of `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`.' extra_requirements='' purpose='This will provide the necessary source code to understand the data flow from role definition to final transform, and the context of the provided patch.'
2025-12-21 00:11:24,828 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`.
2025-12-21 00:11:24,828 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-21 00:11:24,829 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-21 00:11:24,830 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-21 00:11:24,830 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`.
Purpose: This will provide the necessary source code to understand the data flow from role definition to final transform, and the context of the provided patch.
2025-12-21 00:11:27,708 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I will get the full content of the three files you requested: `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`. This will allow you to analyze the data flow from role definition to the final transform.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/builders/html/transforms.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2097, 'candidates_token_count': 121, 'total_token_count': 2333, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2097}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 121}], 'thoughts_token_count': 115, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.045058238604837215, 'model_name': 'gemini-2.5-pro'} id='run--4f444b1a-cabd-4098-9cc6-c1a725413a8e-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/roles.py'}, 'id': 'b0f7415c-b900-4abf-b50e-2e818796811b', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/transforms/__init__.py'}, 'id': '69c5437c-93a2-423e-b95c-13b679e8b590', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/builders/html/transforms.py'}, 'id': 'c47a8a8e-705a-40b0-ad13-30cc07b87a20', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2097, 'output_tokens': 121, 'total_tokens': 2333, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 115}}
2025-12-21 00:11:31,845 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the full content of the three Python files you requested: `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`. These files provide the necessary context to understand the data flow from role definition to the final transform in the Sphinx documentation generator. You can now proceed to analyze the code to understand the data flow.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 17105, 'candidates_token_count': 81, 'total_token_count': 17436, 'cached_content_token_count': 1889, 'prompt_tokens_details': [{'modality': 1, 'token_count': 17105}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1889}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 81}], 'thoughts_token_count': 250}, 'finish_reason': 'STOP', 'avg_logprobs': -0.26790270393277393, 'model_name': 'gemini-2.5-pro'} id='run--e21446cc-ebd2-42d9-86b8-a5b43b76ab8e-0' usage_metadata={'input_tokens': 17105, 'output_tokens': 81, 'total_tokens': 17436, 'input_token_details': {'cache_read': 1889}, 'output_token_details': {'reasoning': 250}}
2025-12-21 00:11:31,847 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
This will provide the necessary source code to understand the data flow from role definition to final transform, and the context of the provided patch.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: sphinx/builders/html/transforms.py
Line number range: 1 - 69
Content:
1. """
2.     sphinx.builders.html.transforms
3.     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
4. 
5.     Transforms for HTML builder.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. from typing import Any, Dict
13. 
14. from docutils import nodes
15. 
16. from sphinx.application import Sphinx
17. from sphinx.transforms.post_transforms import SphinxPostTransform
18. from sphinx.util.nodes import NodeMatcher
19. 
20. 
21. class KeyboardTransform(SphinxPostTransform):
22.     """Transform :kbd: role to more detailed form.
23. 
24.     Before::
25. 
26.         <literal class="kbd">
27.             Control-x
28. 
29.     After::
30. 
31.         <literal class="kbd">
32.             <literal class="kbd">
33.                 Control
34.             -
35.             <literal class="kbd">
36.                 x
37.     """
38.     default_priority = 400
39.     builders = ('html',)
40.     pattern = re.compile(r'(-|\+|\^|\s+)')
41. 
42.     def run(self, **kwargs: Any) -> None:
43.         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
44.         for node in self.document.traverse(matcher):  # type: nodes.literal
45.             parts = self.pattern.split(node[-1].astext())
46.             if len(parts) == 1:
47.                 continue
48. 
49.             node.pop()
50.             while parts:
51.                 key = parts.pop(0)
52.                 node += nodes.literal('', key, classes=["kbd"])
53. 
54.                 try:
55.                     # key separator (ex. -, +, ^)
56.                     sep = parts.pop(0)
57.                     node += nodes.Text(sep)
58.                 except IndexError:
59.                     pass
60. 
61. 
62. def setup(app: Sphinx) -> Dict[str, Any]:
63.     app.add_post_transform(KeyboardTransform)
64. 
65.     return {
66.         'version': 'builtin',
67.         'parallel_read_safe': True,
68.         'parallel_write_safe': True,
69.     }


File: sphinx/roles.py
Line number range: 1 - 500
Content:
1. """
2.     sphinx.roles
3.     ~~~~~~~~~~~~
4. 
5.     Handlers for additional ReST roles.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. import warnings
13. from typing import Any, Dict, List, Tuple
14. 
15. from docutils import nodes, utils
16. from docutils.nodes import Element, Node, TextElement, system_message
17. from docutils.parsers.rst.states import Inliner
18. 
19. from sphinx import addnodes
20. from sphinx.deprecation import RemovedInSphinx40Warning
21. from sphinx.locale import _
22. from sphinx.util import ws_re
23. from sphinx.util.docutils import ReferenceRole, SphinxRole
24. from sphinx.util.nodes import process_index_entry, set_role_source_info, split_explicit_title
25. from sphinx.util.typing import RoleFunction
26. 
27. if False:
28.     # For type annotation
29.     from typing import Type  # for python3.5.1
30. 
31.     from sphinx.application import Sphinx
32.     from sphinx.environment import BuildEnvironment
33. 
34. 
35. generic_docroles = {
36.     'command': addnodes.literal_strong,
37.     'dfn': nodes.emphasis,
38.     'kbd': nodes.literal,
39.     'mailheader': addnodes.literal_emphasis,
40.     'makevar': addnodes.literal_strong,
41.     'manpage': addnodes.manpage,
42.     'mimetype': addnodes.literal_emphasis,
43.     'newsgroup': addnodes.literal_emphasis,
44.     'program': addnodes.literal_strong,  # XXX should be an x-ref
45.     'regexp': nodes.literal,
46. }
47. 
48. 
49. # -- generic cross-reference role ----------------------------------------------
50. 
51. class XRefRole(ReferenceRole):
52.     """
53.     A generic cross-referencing role.  To create a callable that can be used as
54.     a role function, create an instance of this class.
55. 
56.     The general features of this role are:
57. 
58.     * Automatic creation of a reference and a content node.
59.     * Optional separation of title and target with `title <target>`.
60.     * The implementation is a class rather than a function to make
61.       customization easier.
62. 
63.     Customization can be done in two ways:
64. 
65.     * Supplying constructor parameters:
66.       * `fix_parens` to normalize parentheses (strip from target, and add to
67.         title if configured)
68.       * `lowercase` to lowercase the target
69.       * `nodeclass` and `innernodeclass` select the node classes for
70.         the reference and the content node
71. 
72.     * Subclassing and overwriting `process_link()` and/or `result_nodes()`.
73.     """
74. 
75.     nodeclass = addnodes.pending_xref   # type: Type[Element]
76.     innernodeclass = nodes.literal      # type: Type[TextElement]
77. 
78.     def __init__(self, fix_parens: bool = False, lowercase: bool = False,
79.                  nodeclass: "Type[Element]" = None, innernodeclass: "Type[TextElement]" = None,
80.                  warn_dangling: bool = False) -> None:
81.         self.fix_parens = fix_parens
82.         self.lowercase = lowercase
83.         self.warn_dangling = warn_dangling
84.         if nodeclass is not None:
85.             self.nodeclass = nodeclass
86.         if innernodeclass is not None:
87.             self.innernodeclass = innernodeclass
88. 
89.         super().__init__()
90. 
91.     def _fix_parens(self, env: "BuildEnvironment", has_explicit_title: bool, title: str,
92.                     target: str) -> Tuple[str, str]:
93.         warnings.warn('XRefRole._fix_parens() is deprecated.',
94.                       RemovedInSphinx40Warning, stacklevel=2)
95.         if not has_explicit_title:
96.             if title.endswith('()'):
97.                 # remove parentheses
98.                 title = title[:-2]
99.             if env.config.add_function_parentheses:
100.                 # add them back to all occurrences if configured
101.                 title += '()'
102.         # remove parentheses from the target too
103.         if target.endswith('()'):
104.             target = target[:-2]
105.         return title, target
106. 
107.     def update_title_and_target(self, title: str, target: str) -> Tuple[str, str]:
108.         if not self.has_explicit_title:
109.             if title.endswith('()'):
110.                 # remove parentheses
111.                 title = title[:-2]
112.             if self.config.add_function_parentheses:
113.                 # add them back to all occurrences if configured
114.                 title += '()'
115.         # remove parentheses from the target too
116.         if target.endswith('()'):
117.             target = target[:-2]
118.         return title, target
119. 
120.     def run(self) -> Tuple[List[Node], List[system_message]]:
121.         if ':' not in self.name:
122.             self.refdomain, self.reftype = '', self.name
123.             self.classes = ['xref', self.reftype]
124.         else:
125.             self.refdomain, self.reftype = self.name.split(':', 1)
126.             self.classes = ['xref', self.refdomain, '%s-%s' % (self.refdomain, self.reftype)]
127. 
128.         if self.disabled:
129.             return self.create_non_xref_node()
130.         else:
131.             return self.create_xref_node()
132. 
133.     def create_non_xref_node(self) -> Tuple[List[Node], List[system_message]]:
134.         text = utils.unescape(self.text[1:])
135.         if self.fix_parens:
136.             self.has_explicit_title = False  # treat as implicit
137.             text, target = self.update_title_and_target(text, "")
138. 
139.         node = self.innernodeclass(self.rawtext, text, classes=self.classes)
140.         return self.result_nodes(self.inliner.document, self.env, node, is_ref=False)
141. 
142.     def create_xref_node(self) -> Tuple[List[Node], List[system_message]]:
143.         target = self.target
144.         title = self.title
145.         if self.lowercase:
146.             target = target.lower()
147.         if self.fix_parens:
148.             title, target = self.update_title_and_target(title, target)
149. 
150.         # create the reference node
151.         options = {'refdoc': self.env.docname,
152.                    'refdomain': self.refdomain,
153.                    'reftype': self.reftype,
154.                    'refexplicit': self.has_explicit_title,
155.                    'refwarn': self.warn_dangling}
156.         refnode = self.nodeclass(self.rawtext, **options)
157.         self.set_source_info(refnode)
158. 
159.         # determine the target and title for the class
160.         title, target = self.process_link(self.env, refnode, self.has_explicit_title,
161.                                           title, target)
162.         refnode['reftarget'] = target
163.         refnode += self.innernodeclass(self.rawtext, title, classes=self.classes)
164. 
165.         return self.result_nodes(self.inliner.document, self.env, refnode, is_ref=True)
166. 
167.     # methods that can be overwritten
168. 
169.     def process_link(self, env: "BuildEnvironment", refnode: Element, has_explicit_title: bool,
170.                      title: str, target: str) -> Tuple[str, str]:
171.         """Called after parsing title and target text, and creating the
172.         reference node (given in *refnode*).  This method can alter the
173.         reference node and must return a new (or the same) ``(title, target)``
174.         tuple.
175.         """
176.         return title, ws_re.sub(' ', target)
177. 
178.     def result_nodes(self, document: nodes.document, env: "BuildEnvironment", node: Element,
179.                      is_ref: bool) -> Tuple[List[Node], List[system_message]]:
180.         """Called before returning the finished nodes.  *node* is the reference
181.         node if one was created (*is_ref* is then true), else the content node.
182.         This method can add other nodes and must return a ``(nodes, messages)``
183.         tuple (the usual return value of a role function).
184.         """
185.         return [node], []
186. 
187. 
188. class AnyXRefRole(XRefRole):
189.     def process_link(self, env: "BuildEnvironment", refnode: Element, has_explicit_title: bool,
190.                      title: str, target: str) -> Tuple[str, str]:
191.         result = super().process_link(env, refnode, has_explicit_title, title, target)
192.         # add all possible context info (i.e. std:program, py:module etc.)
193.         refnode.attributes.update(env.ref_context)
194.         return result
195. 
196. 
197. def indexmarkup_role(typ: str, rawtext: str, text: str, lineno: int, inliner: Inliner,
198.                      options: Dict = {}, content: List[str] = []
199.                      ) -> Tuple[List[Node], List[system_message]]:
200.     """Role for PEP/RFC references that generate an index entry."""
201.     warnings.warn('indexmarkup_role() is deprecated.  Please use PEP or RFC class instead.',
202.                   RemovedInSphinx40Warning, stacklevel=2)
203.     env = inliner.document.settings.env
204.     if not typ:
205.         assert env.temp_data['default_role']
206.         typ = env.temp_data['default_role'].lower()
207.     else:
208.         typ = typ.lower()
209. 
210.     has_explicit_title, title, target = split_explicit_title(text)
211.     title = utils.unescape(title)
212.     target = utils.unescape(target)
213.     targetid = 'index-%s' % env.new_serialno('index')
214.     indexnode = addnodes.index()
215.     targetnode = nodes.target('', '', ids=[targetid])
216.     inliner.document.note_explicit_target(targetnode)
217.     if typ == 'pep':
218.         indexnode['entries'] = [
219.             ('single', _('Python Enhancement Proposals; PEP %s') % target,
220.              targetid, '', None)]
221.         anchor = ''
222.         anchorindex = target.find('#')
223.         if anchorindex > 0:
224.             target, anchor = target[:anchorindex], target[anchorindex:]
225.         if not has_explicit_title:
226.             title = "PEP " + utils.unescape(title)
227.         try:
228.             pepnum = int(target)
229.         except ValueError:
230.             msg = inliner.reporter.error('invalid PEP number %s' % target,
231.                                          line=lineno)
232.             prb = inliner.problematic(rawtext, rawtext, msg)
233.             return [prb], [msg]
234.         ref = inliner.document.settings.pep_base_url + 'pep-%04d' % pepnum
235.         sn = nodes.strong(title, title)
236.         rn = nodes.reference('', '', internal=False, refuri=ref + anchor,
237.                              classes=[typ])
238.         rn += sn
239.         return [indexnode, targetnode, rn], []
240.     elif typ == 'rfc':
241.         indexnode['entries'] = [
242.             ('single', 'RFC; RFC %s' % target, targetid, '', None)]
243.         anchor = ''
244.         anchorindex = target.find('#')
245.         if anchorindex > 0:
246.             target, anchor = target[:anchorindex], target[anchorindex:]
247.         if not has_explicit_title:
248.             title = "RFC " + utils.unescape(title)
249.         try:
250.             rfcnum = int(target)
251.         except ValueError:
252.             msg = inliner.reporter.error('invalid RFC number %s' % target,
253.                                          line=lineno)
254.             prb = inliner.problematic(rawtext, rawtext, msg)
255.             return [prb], [msg]
256.         ref = inliner.document.settings.rfc_base_url + inliner.rfc_url % rfcnum
257.         sn = nodes.strong(title, title)
258.         rn = nodes.reference('', '', internal=False, refuri=ref + anchor,
259.                              classes=[typ])
260.         rn += sn
261.         return [indexnode, targetnode, rn], []
262.     else:
263.         raise ValueError('unknown role type: %s' % typ)
264. 
265. 
266. class PEP(ReferenceRole):
267.     def run(self) -> Tuple[List[Node], List[system_message]]:
268.         target_id = 'index-%s' % self.env.new_serialno('index')
269.         entries = [('single', _('Python Enhancement Proposals; PEP %s') % self.target,
270.                     target_id, '', None)]
271. 
272.         index = addnodes.index(entries=entries)
273.         target = nodes.target('', '', ids=[target_id])
274.         self.inliner.document.note_explicit_target(target)
275. 
276.         try:
277.             refuri = self.build_uri()
278.             reference = nodes.reference('', '', internal=False, refuri=refuri, classes=['pep'])
279.             if self.has_explicit_title:
280.                 reference += nodes.strong(self.title, self.title)
281.             else:
282.                 title = "PEP " + self.title
283.                 reference += nodes.strong(title, title)
284.         except ValueError:
285.             msg = self.inliner.reporter.error('invalid PEP number %s' % self.target,
286.                                               line=self.lineno)
287.             prb = self.inliner.problematic(self.rawtext, self.rawtext, msg)
288.             return [prb], [msg]
289. 
290.         return [index, target, reference], []
291. 
292.     def build_uri(self) -> str:
293.         base_url = self.inliner.document.settings.pep_base_url
294.         ret = self.target.split('#', 1)
295.         if len(ret) == 2:
296.             return base_url + 'pep-%04d#%s' % (int(ret[0]), ret[1])
297.         else:
298.             return base_url + 'pep-%04d' % int(ret[0])
299. 
300. 
301. class RFC(ReferenceRole):
302.     def run(self) -> Tuple[List[Node], List[system_message]]:
303.         target_id = 'index-%s' % self.env.new_serialno('index')
304.         entries = [('single', 'RFC; RFC %s' % self.target, target_id, '', None)]
305. 
306.         index = addnodes.index(entries=entries)
307.         target = nodes.target('', '', ids=[target_id])
308.         self.inliner.document.note_explicit_target(target)
309. 
310.         try:
311.             refuri = self.build_uri()
312.             reference = nodes.reference('', '', internal=False, refuri=refuri, classes=['rfc'])
313.             if self.has_explicit_title:
314.                 reference += nodes.strong(self.title, self.title)
315.             else:
316.                 title = "RFC " + self.title
317.                 reference += nodes.strong(title, title)
318.         except ValueError:
319.             msg = self.inliner.reporter.error('invalid RFC number %s' % self.target,
320.                                               line=self.lineno)
321.             prb = self.inliner.problematic(self.rawtext, self.rawtext, msg)
322.             return [prb], [msg]
323. 
324.         return [index, target, reference], []
325. 
326.     def build_uri(self) -> str:
327.         base_url = self.inliner.document.settings.rfc_base_url
328.         ret = self.target.split('#', 1)
329.         if len(ret) == 2:
330.             return base_url + self.inliner.rfc_url % int(ret[0]) + '#' + ret[1]
331.         else:
332.             return base_url + self.inliner.rfc_url % int(ret[0])
333. 
334. 
335. _amp_re = re.compile(r'(?<!&)&(?![&\s])')
336. 
337. 
338. def menusel_role(typ: str, rawtext: str, text: str, lineno: int, inliner: Inliner,
339.                  options: Dict = {}, content: List[str] = []
340.                  ) -> Tuple[List[Node], List[system_message]]:
341.     warnings.warn('menusel_role() is deprecated. '
342.                   'Please use MenuSelection or GUILabel class instead.',
343.                   RemovedInSphinx40Warning, stacklevel=2)
344.     env = inliner.document.settings.env
345.     if not typ:
346.         assert env.temp_data['default_role']
347.         typ = env.temp_data['default_role'].lower()
348.     else:
349.         typ = typ.lower()
350. 
351.     text = utils.unescape(text)
352.     if typ == 'menuselection':
353.         text = text.replace('-->', '\N{TRIANGULAR BULLET}')
354.     spans = _amp_re.split(text)
355. 
356.     node = nodes.inline(rawtext=rawtext)
357.     for i, span in enumerate(spans):
358.         span = span.replace('&&', '&')
359.         if i == 0:
360.             if len(span) > 0:
361.                 textnode = nodes.Text(span)
362.                 node += textnode
363.             continue
364.         accel_node = nodes.inline()
365.         letter_node = nodes.Text(span[0])
366.         accel_node += letter_node
367.         accel_node['classes'].append('accelerator')
368.         node += accel_node
369.         textnode = nodes.Text(span[1:])
370.         node += textnode
371. 
372.     node['classes'].append(typ)
373.     return [node], []
374. 
375. 
376. class GUILabel(SphinxRole):
377.     amp_re = re.compile(r'(?<!&)&(?![&\s])')
378. 
379.     def run(self) -> Tuple[List[Node], List[system_message]]:
380.         node = nodes.inline(rawtext=self.rawtext, classes=[self.name])
381.         spans = self.amp_re.split(self.text)
382.         node += nodes.Text(spans.pop(0))
383.         for span in spans:
384.             span = span.replace('&&', '&')
385. 
386.             letter = nodes.Text(span[0])
387.             accelerator = nodes.inline('', '', letter, classes=['accelerator'])
388.             node += accelerator
389.             node += nodes.Text(span[1:])
390. 
391.         return [node], []
392. 
393. 
394. class MenuSelection(GUILabel):
395.     BULLET_CHARACTER = '\N{TRIANGULAR BULLET}'
396. 
397.     def run(self) -> Tuple[List[Node], List[system_message]]:
398.         self.text = self.text.replace('-->', self.BULLET_CHARACTER)
399.         return super().run()
400. 
401. 
402. _litvar_re = re.compile('{([^}]+)}')
403. parens_re = re.compile(r'(\\*{|\\*})')
404. 
405. 
406. def emph_literal_role(typ: str, rawtext: str, text: str, lineno: int, inliner: Inliner,
407.                       options: Dict = {}, content: List[str] = []
408.                       ) -> Tuple[List[Node], List[system_message]]:
409.     warnings.warn('emph_literal_role() is deprecated. '
410.                   'Please use EmphasizedLiteral class instead.',
411.                   RemovedInSphinx40Warning, stacklevel=2)
412.     env = inliner.document.settings.env
413.     if not typ:
414.         assert env.temp_data['default_role']
415.         typ = env.temp_data['default_role'].lower()
416.     else:
417.         typ = typ.lower()
418. 
419.     retnode = nodes.literal(role=typ.lower(), classes=[typ])
420.     parts = list(parens_re.split(utils.unescape(text)))
421.     stack = ['']
422.     for part in parts:
423.         matched = parens_re.match(part)
424.         if matched:
425.             backslashes = len(part) - 1
426.             if backslashes % 2 == 1:    # escaped
427.                 stack[-1] += "\\" * int((backslashes - 1) / 2) + part[-1]
428.             elif part[-1] == '{':       # rparen
429.                 stack[-1] += "\\" * int(backslashes / 2)
430.                 if len(stack) >= 2 and stack[-2] == "{":
431.                     # nested
432.                     stack[-1] += "{"
433.                 else:
434.                     # start emphasis
435.                     stack.append('{')
436.                     stack.append('')
437.             else:                       # lparen
438.                 stack[-1] += "\\" * int(backslashes / 2)
439.                 if len(stack) == 3 and stack[1] == "{" and len(stack[2]) > 0:
440.                     # emphasized word found
441.                     if stack[0]:
442.                         retnode += nodes.Text(stack[0], stack[0])
443.                     retnode += nodes.emphasis(stack[2], stack[2])
444.                     stack = ['']
445.                 else:
446.                     # emphasized word not found; the rparen is not a special symbol
447.                     stack.append('}')
448.                     stack = [''.join(stack)]
449.         else:
450.             stack[-1] += part
451.     if ''.join(stack):
452.         # remaining is treated as Text
453.         text = ''.join(stack)
454.         retnode += nodes.Text(text, text)
455. 
456.     return [retnode], []
457. 
458. 
459. class EmphasizedLiteral(SphinxRole):
460.     parens_re = re.compile(r'(\\\\|\\{|\\}|{|})')
461. 
462.     def run(self) -> Tuple[List[Node], List[system_message]]:
463.         children = self.parse(self.text)
464.         node = nodes.literal(self.rawtext, '', *children,
465.                              role=self.name.lower(), classes=[self.name])
466. 
467.         return [node], []
468. 
469.     def parse(self, text: str) -> List[Node]:
470.         result = []  # type: List[Node]
471. 
472.         stack = ['']
473.         for part in self.parens_re.split(text):
474.             if part == '\\\\':  # escaped backslash
475.                 stack[-1] += '\\'
476.             elif part == '{':
477.                 if len(stack) >= 2 and stack[-2] == "{":  # nested
478.                     stack[-1] += "{"
479.                 else:
480.                     # start emphasis
481.                     stack.append('{')
482.                     stack.append('')
483.             elif part == '}':
484.                 if len(stack) == 3 and stack[1] == "{" and len(stack[2]) > 0:
485.                     # emphasized word found
486.                     if stack[0]:
487.                         result.append(nodes.Text(stack[0], stack[0]))
488.                     result.append(nodes.emphasis(stack[2], stack[2]))
489.                     stack = ['']
490.                 else:
491.                     # emphasized word not found; the rparen is not a special symbol
492.                     stack.append('}')
493.                     stack = [''.join(stack)]
494.             elif part == '\\{':  # escaped left-brace
495.                 stack[-1] += '{'
496.             elif part == '\\}':  # escaped right-brace
497.                 stack[-1] += '}'
498.             else:  # others (containing escaped braces)
499.                 stack[-1] += part
500.


File: sphinx/transforms/__init__.py
Line number range: 1 - 441
Content:
1. """
2.     sphinx.transforms
3.     ~~~~~~~~~~~~~~~~~
4. 
5.     Docutils transforms used by Sphinx when reading documents.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. from typing import Any, Dict, Generator, List, Tuple
13. 
14. from docutils import nodes
15. from docutils.nodes import Element, Node, Text
16. from docutils.transforms import Transform, Transformer
17. from docutils.transforms.parts import ContentsFilter
18. from docutils.transforms.universal import SmartQuotes
19. from docutils.utils import normalize_language_tag
20. from docutils.utils.smartquotes import smartchars
21. 
22. from sphinx import addnodes
23. from sphinx.config import Config
24. from sphinx.deprecation import RemovedInSphinx40Warning, deprecated_alias
25. from sphinx.locale import _, __
26. from sphinx.util import docutils, logging
27. from sphinx.util.docutils import new_document
28. from sphinx.util.i18n import format_date
29. from sphinx.util.nodes import NodeMatcher, apply_source_workaround, is_smartquotable
30. 
31. if False:
32.     # For type annotation
33.     from sphinx.application import Sphinx
34.     from sphinx.domain.std import StandardDomain
35.     from sphinx.environment import BuildEnvironment
36. 
37. 
38. logger = logging.getLogger(__name__)
39. 
40. default_substitutions = {
41.     'version',
42.     'release',
43.     'today',
44. }
45. 
46. 
47. class SphinxTransform(Transform):
48.     """A base class of Transforms.
49. 
50.     Compared with ``docutils.transforms.Transform``, this class improves accessibility to
51.     Sphinx APIs.
52.     """
53. 
54.     @property
55.     def app(self) -> "Sphinx":
56.         """Reference to the :class:`.Sphinx` object."""
57.         return self.env.app
58. 
59.     @property
60.     def env(self) -> "BuildEnvironment":
61.         """Reference to the :class:`.BuildEnvironment` object."""
62.         return self.document.settings.env
63. 
64.     @property
65.     def config(self) -> Config:
66.         """Reference to the :class:`.Config` object."""
67.         return self.env.config
68. 
69. 
70. class SphinxTransformer(Transformer):
71.     """
72.     A transformer for Sphinx.
73.     """
74. 
75.     document = None  # type: nodes.document
76.     env = None  # type: BuildEnvironment
77. 
78.     def set_environment(self, env: "BuildEnvironment") -> None:
79.         self.env = env
80. 
81.     def apply_transforms(self) -> None:
82.         if isinstance(self.document, nodes.document):
83.             if not hasattr(self.document.settings, 'env') and self.env:
84.                 self.document.settings.env = self.env
85. 
86.             super().apply_transforms()
87.         else:
88.             # wrap the target node by document node during transforming
89.             try:
90.                 document = new_document('')
91.                 if self.env:
92.                     document.settings.env = self.env
93.                 document += self.document
94.                 self.document = document
95.                 super().apply_transforms()
96.             finally:
97.                 self.document = self.document[0]
98. 
99. 
100. class DefaultSubstitutions(SphinxTransform):
101.     """
102.     Replace some substitutions if they aren't defined in the document.
103.     """
104.     # run before the default Substitutions
105.     default_priority = 210
106. 
107.     def apply(self, **kwargs: Any) -> None:
108.         # only handle those not otherwise defined in the document
109.         to_handle = default_substitutions - set(self.document.substitution_defs)
110.         for ref in self.document.traverse(nodes.substitution_reference):
111.             refname = ref['refname']
112.             if refname in to_handle:
113.                 text = self.config[refname]
114.                 if refname == 'today' and not text:
115.                     # special handling: can also specify a strftime format
116.                     text = format_date(self.config.today_fmt or _('%b %d, %Y'),
117.                                        language=self.config.language)
118.                 ref.replace_self(nodes.Text(text, text))
119. 
120. 
121. class MoveModuleTargets(SphinxTransform):
122.     """
123.     Move module targets that are the first thing in a section to the section
124.     title.
125. 
126.     XXX Python specific
127.     """
128.     default_priority = 210
129. 
130.     def apply(self, **kwargs: Any) -> None:
131.         for node in self.document.traverse(nodes.target):
132.             if not node['ids']:
133.                 continue
134.             if ('ismod' in node and
135.                     node.parent.__class__ is nodes.section and
136.                     # index 0 is the section title node
137.                     node.parent.index(node) == 1):
138.                 node.parent['ids'][0:0] = node['ids']
139.                 node.parent.remove(node)
140. 
141. 
142. class HandleCodeBlocks(SphinxTransform):
143.     """
144.     Several code block related transformations.
145.     """
146.     default_priority = 210
147. 
148.     def apply(self, **kwargs: Any) -> None:
149.         # move doctest blocks out of blockquotes
150.         for node in self.document.traverse(nodes.block_quote):
151.             if all(isinstance(child, nodes.doctest_block) for child
152.                    in node.children):
153.                 node.replace_self(node.children)
154.         # combine successive doctest blocks
155.         # for node in self.document.traverse(nodes.doctest_block):
156.         #    if node not in node.parent.children:
157.         #        continue
158.         #    parindex = node.parent.index(node)
159.         #    while len(node.parent) > parindex+1 and \
160.         #            isinstance(node.parent[parindex+1], nodes.doctest_block):
161.         #        node[0] = nodes.Text(node[0] + '\n\n' +
162.         #                             node.parent[parindex+1][0])
163.         #        del node.parent[parindex+1]
164. 
165. 
166. class AutoNumbering(SphinxTransform):
167.     """
168.     Register IDs of tables, figures and literal_blocks to assign numbers.
169.     """
170.     default_priority = 210
171. 
172.     def apply(self, **kwargs: Any) -> None:
173.         domain = self.env.get_domain('std')  # type: StandardDomain
174. 
175.         for node in self.document.traverse(nodes.Element):
176.             if (domain.is_enumerable_node(node) and
177.                     domain.get_numfig_title(node) is not None and
178.                     node['ids'] == []):
179.                 self.document.note_implicit_target(node)
180. 
181. 
182. class SortIds(SphinxTransform):
183.     """
184.     Sort secion IDs so that the "id[0-9]+" one comes last.
185.     """
186.     default_priority = 261
187. 
188.     def apply(self, **kwargs: Any) -> None:
189.         for node in self.document.traverse(nodes.section):
190.             if len(node['ids']) > 1 and node['ids'][0].startswith('id'):
191.                 node['ids'] = node['ids'][1:] + [node['ids'][0]]
192. 
193. 
194. TRANSLATABLE_NODES = {
195.     'literal-block': nodes.literal_block,
196.     'doctest-block': nodes.doctest_block,
197.     'raw': nodes.raw,
198.     'index': addnodes.index,
199.     'image': nodes.image,
200. }
201. 
202. 
203. class ApplySourceWorkaround(SphinxTransform):
204.     """
205.     update source and rawsource attributes
206.     """
207.     default_priority = 10
208. 
209.     def apply(self, **kwargs: Any) -> None:
210.         for node in self.document.traverse():  # type: Node
211.             if isinstance(node, (nodes.TextElement, nodes.image)):
212.                 apply_source_workaround(node)
213. 
214. 
215. class AutoIndexUpgrader(SphinxTransform):
216.     """
217.     Detect old style; 4 column based indices and automatically upgrade to new style.
218.     """
219.     default_priority = 210
220. 
221.     def apply(self, **kwargs: Any) -> None:
222.         for node in self.document.traverse(addnodes.index):
223.             if 'entries' in node and any(len(entry) == 4 for entry in node['entries']):
224.                 msg = __('4 column based index found. '
225.                          'It might be a bug of extensions you use: %r') % node['entries']
226.                 logger.warning(msg, location=node)
227.                 for i, entry in enumerate(node['entries']):
228.                     if len(entry) == 4:
229.                         node['entries'][i] = entry + (None,)
230. 
231. 
232. class ExtraTranslatableNodes(SphinxTransform):
233.     """
234.     make nodes translatable
235.     """
236.     default_priority = 10
237. 
238.     def apply(self, **kwargs: Any) -> None:
239.         targets = self.config.gettext_additional_targets
240.         target_nodes = [v for k, v in TRANSLATABLE_NODES.items() if k in targets]
241.         if not target_nodes:
242.             return
243. 
244.         def is_translatable_node(node: Node) -> bool:
245.             return isinstance(node, tuple(target_nodes))
246. 
247.         for node in self.document.traverse(is_translatable_node):  # type: Element
248.             node['translatable'] = True
249. 
250. 
251. class UnreferencedFootnotesDetector(SphinxTransform):
252.     """
253.     detect unreferenced footnotes and emit warnings
254.     """
255.     default_priority = 200
256. 
257.     def apply(self, **kwargs: Any) -> None:
258.         for node in self.document.footnotes:
259.             if node['names'] == []:
260.                 # footnote having duplicated number.  It is already warned at parser.
261.                 pass
262.             elif node['names'][0] not in self.document.footnote_refs:
263.                 logger.warning(__('Footnote [%s] is not referenced.'), node['names'][0],
264.                                type='ref', subtype='footnote',
265.                                location=node)
266. 
267.         for node in self.document.autofootnotes:
268.             if not any(ref['auto'] == node['auto'] for ref in self.document.autofootnote_refs):
269.                 logger.warning(__('Footnote [#] is not referenced.'),
270.                                type='ref', subtype='footnote',
271.                                location=node)
272. 
273. 
274. class DoctestTransform(SphinxTransform):
275.     """Set "doctest" style to each doctest_block node"""
276.     default_priority = 500
277. 
278.     def apply(self, **kwargs: Any) -> None:
279.         for node in self.document.traverse(nodes.doctest_block):
280.             node['classes'].append('doctest')
281. 
282. 
283. class FigureAligner(SphinxTransform):
284.     """
285.     Align figures to center by default.
286.     """
287.     default_priority = 700
288. 
289.     def apply(self, **kwargs: Any) -> None:
290.         matcher = NodeMatcher(nodes.table, nodes.figure)
291.         for node in self.document.traverse(matcher):  # type: Element
292.             node.setdefault('align', 'default')
293. 
294. 
295. class FilterSystemMessages(SphinxTransform):
296.     """Filter system messages from a doctree."""
297.     default_priority = 999
298. 
299.     def apply(self, **kwargs: Any) -> None:
300.         filterlevel = 2 if self.config.keep_warnings else 5
301.         for node in self.document.traverse(nodes.system_message):
302.             if node['level'] < filterlevel:
303.                 logger.debug('%s [filtered system message]', node.astext())
304.                 node.parent.remove(node)
305. 
306. 
307. class SphinxContentsFilter(ContentsFilter):
308.     """
309.     Used with BuildEnvironment.add_toc_from() to discard cross-file links
310.     within table-of-contents link nodes.
311.     """
312.     visit_pending_xref = ContentsFilter.ignore_node_but_process_children
313. 
314.     def visit_image(self, node: nodes.image) -> None:
315.         raise nodes.SkipNode
316. 
317. 
318. class SphinxSmartQuotes(SmartQuotes, SphinxTransform):
319.     """
320.     Customized SmartQuotes to avoid transform for some extra node types.
321. 
322.     refs: sphinx.parsers.RSTParser
323.     """
324.     default_priority = 750
325. 
326.     def apply(self, **kwargs: Any) -> None:
327.         if not self.is_available():
328.             return
329. 
330.         # override default settings with :confval:`smartquotes_action`
331.         self.smartquotes_action = self.config.smartquotes_action
332. 
333.         super().apply()
334. 
335.     def is_available(self) -> bool:
336.         builders = self.config.smartquotes_excludes.get('builders', [])
337.         languages = self.config.smartquotes_excludes.get('languages', [])
338. 
339.         if self.document.settings.smart_quotes is False:
340.             # disabled by 3rd party extension (workaround)
341.             return False
342.         elif self.config.smartquotes is False:
343.             # disabled by confval smartquotes
344.             return False
345.         elif self.app.builder.name in builders:
346.             # disabled by confval smartquotes_excludes['builders']
347.             return False
348.         elif self.config.language in languages:
349.             # disabled by confval smartquotes_excludes['languages']
350.             return False
351. 
352.         # confirm selected language supports smart_quotes or not
353.         language = self.env.settings['language_code']
354.         for tag in normalize_language_tag(language):
355.             if tag in smartchars.quotes:
356.                 return True
357.         else:
358.             return False
359. 
360.     def get_tokens(self, txtnodes: List[Text]) -> Generator[Tuple[str, str], None, None]:
361.         # A generator that yields ``(texttype, nodetext)`` tuples for a list
362.         # of "Text" nodes (interface to ``smartquotes.educate_tokens()``).
363.         for txtnode in txtnodes:
364.             if is_smartquotable(txtnode):
365.                 if docutils.__version_info__ >= (0, 16):
366.                     # SmartQuotes uses backslash escapes instead of null-escapes
367.                     text = re.sub(r'(?<=\x00)([-\\\'".`])', r'\\\1', str(txtnode))
368.                 else:
369.                     text = txtnode.astext()
370. 
371.                 yield ('plain', text)
372.             else:
373.                 # skip smart quotes
374.                 yield ('literal', txtnode.astext())
375. 
376. 
377. class DoctreeReadEvent(SphinxTransform):
378.     """Emit :event:`doctree-read` event."""
379.     default_priority = 880
380. 
381.     def apply(self, **kwargs: Any) -> None:
382.         self.app.emit('doctree-read', self.document)
383. 
384. 
385. class ManpageLink(SphinxTransform):
386.     """Find manpage section numbers and names"""
387.     default_priority = 999
388. 
389.     def apply(self, **kwargs: Any) -> None:
390.         for node in self.document.traverse(addnodes.manpage):
391.             manpage = ' '.join([str(x) for x in node.children
392.                                 if isinstance(x, nodes.Text)])
393.             pattern = r'^(?P<path>(?P<page>.+)[\(\.](?P<section>[1-9]\w*)?\)?)$'  # noqa
394.             info = {'path': manpage,
395.                     'page': manpage,
396.                     'section': ''}
397.             r = re.match(pattern, manpage)
398.             if r:
399.                 info = r.groupdict()
400.             node.attributes.update(info)
401. 
402. 
403. from sphinx.domains.citation import CitationDefinitionTransform  # NOQA
404. from sphinx.domains.citation import CitationReferenceTransform  # NOQA
405. 
406. deprecated_alias('sphinx.transforms',
407.                  {
408.                      'CitationReferences': CitationReferenceTransform,
409.                      'SmartQuotesSkipper': CitationDefinitionTransform,
410.                  },
411.                  RemovedInSphinx40Warning,
412.                  {
413.                      'CitationReferences':
414.                      'sphinx.domains.citation.CitationReferenceTransform',
415.                      'SmartQuotesSkipper':
416.                      'sphinx.domains.citation.CitationDefinitionTransform',
417.                  })
418. 
419. 
420. def setup(app: "Sphinx") -> Dict[str, Any]:
421.     app.add_transform(ApplySourceWorkaround)
422.     app.add_transform(ExtraTranslatableNodes)
423.     app.add_transform(DefaultSubstitutions)
424.     app.add_transform(MoveModuleTargets)
425.     app.add_transform(HandleCodeBlocks)
426.     app.add_transform(SortIds)
427.     app.add_transform(DoctestTransform)
428.     app.add_transform(FigureAligner)
429.     app.add_transform(AutoNumbering)
430.     app.add_transform(AutoIndexUpgrader)
431.     app.add_transform(FilterSystemMessages)
432.     app.add_transform(UnreferencedFootnotesDetector)
433.     app.add_transform(SphinxSmartQuotes)
434.     app.add_transform(DoctreeReadEvent)
435.     app.add_transform(ManpageLink)
436. 
437.     return {
438.         'version': 'builtin',
439.         'parallel_read_safe': True,
440.         'parallel_write_safe': True,
441.     }

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-21 00:11:38,995 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The query explicitly asks for the full content of `sphinx/roles.py`.\n   - The context provided contains the entire file content from line 1 to 500.\n2. Extended relevance:\n   - This file is essential as it's one of the three files requested by the user.", relative_path='sphinx/roles.py', start_line=1, end_line=500), ContextOutput(reasoning="1. Query requirement analysis:\n   - The query explicitly asks for the full content of `sphinx/transforms/__init__.py`.\n   - The context provided contains the entire file content from line 1 to 441.\n2. Extended relevance:\n   - This file is essential as it's one of the three files requested by the user.", relative_path='sphinx/transforms/__init__.py', start_line=1, end_line=441), ContextOutput(reasoning="1. Query requirement analysis:\n   - The query explicitly asks for the full content of `sphinx/builders/html/transforms.py`.\n   - The context provided contains the entire file content from line 1 to 69.\n2. Extended relevance:\n   - This file is essential as it's one of the three files requested by the user.", relative_path='sphinx/builders/html/transforms.py', start_line=1, end_line=69)]
2025-12-21 00:11:38,997 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the full content of `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`.
2025-12-21 00:11:38,997 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-21 00:11:38,997 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-21 00:11:38,998 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 0 existing contexts
2025-12-21 00:11:38,998 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 3 total contexts (removed 0 duplicates)
2025-12-21 00:11:38,999 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       ├── main.yml
|       └── nodejs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── deprecated.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-two-links
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes

Description: **Describe the bug**

The `:kbd:` role produces incorrect HTML when:

1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)
2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)

**To Reproduce**

For the below three keyboard definitions:
```
(1) :kbd:`-`
(2) :kbd:`+`
(3) :kbd:`Shift-+`
```

The following three incorrect output is generated:

(1) `-` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(2) `+` is treated as a separator with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

(3) `+` is treated as a separator within a compound-keystroke, with two "blank" keystrokes around it.

```
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Shift</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>+<kbd class="kbd docutils literal notranslate"></kbd></kbd>
```

**Expected behavior**

For single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.

For compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).

**Screenshot**

![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)


**Environment info**
- OS: Windows
- Python version: 3.9.1
- Sphinx version: 3.4.0
- Sphinx extensions:  -
- Extra tools: -


Patch information:
diff --git a/doc/usage/restructuredtext/roles.rst b/doc/usage/restructuredtext/roles.rst
index de12a41b5..0a8ca2452 100644
--- a/doc/usage/restructuredtext/roles.rst
+++ b/doc/usage/restructuredtext/roles.rst
@@ -350,6 +350,10 @@ different style:
    reference to a specific application or platform, the same sequence should be
    marked as ``:kbd:`Control-x Control-f```.
 
+   Note that the characters '-', '+', and '^' are treated as separators only
+   when they separate two non-empty key names. When used alone or at the
+   beginning or end of a compound sequence, they are treated as individual
+   keys.
 .. rst:role:: mailheader
 
    The name of an RFC 822-style mail header.  This markup does not imply that
diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py
index c91da57e9..e04e0d838 100644
--- a/sphinx/builders/html/transforms.py
+++ b/sphinx/builders/html/transforms.py
@@ -8,8 +8,7 @@
     :license: BSD, see LICENSE for details.
 """
 
-import re
-from typing import Any, Dict
+from typing import Any, Dict, List
 
 from docutils import nodes
 
@@ -37,26 +36,71 @@ class KeyboardTransform(SphinxPostTransform):
     """
     default_priority = 400
     builders = ('html',)
-    pattern = re.compile(r'(-|\+|\^|\s+)')
 
     def run(self, **kwargs: Any) -> None:
         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
         for node in self.document.traverse(matcher):  # type: nodes.literal
-            parts = self.pattern.split(node[-1].astext())
-            if len(parts) == 1:
+            text = node[-1].astext()
+
+            keys = []  # type: List[str]
+            prefix_seps = []  # type: List[str]
+            infix_seps = []  # type: List[str]
+
+            buf = ''
+            seen_key = False
+            i = 0
+            length = len(text)
+            while i < length:
+                ch = text[i]
+                if ch.isspace():
+                    # accumulate consecutive whitespace as a single separator
+                    j = i
+                    while i < length and text[i].isspace():
+                        i += 1
+                    sep = text[j:i]
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        infix_seps.append(sep)
+                    else:
+                        if not seen_key:
+                            prefix_seps.append(sep)
+                        else:
+                            infix_seps.append(sep)
+                    continue
+                elif ch in '-+^':
+                    if buf:
+                        keys.append(buf)
+                        buf = ''
+                        seen_key = True
+                        # treat as separator between two non-empty keys
+                        infix_seps.append(ch)
+                    else:
+                        # treat as a key when at start of sequence or
+                        # immediately after a separator (avoid empty keys)
+                        buf += ch
+                    i += 1
+                else:
+                    buf += ch
+                    i += 1
+
+            if buf:
+                keys.append(buf)
+
+            # If there is only a single key, leave as-is
+            if len(keys) <= 1:
                 continue
 
+            # rebuild node: preserve leading separators, then interleave keys and separators
             node.pop()
-            while parts:
-                key = parts.pop(0)
-                node += nodes.literal('', key, classes=["kbd"])
-
-                try:
-                    # key separator (ex. -, +, ^)
-                    sep = parts.pop(0)
-                    node += nodes.Text(sep)
-                except IndexError:
-                    pass
+            for sep in prefix_seps:
+                node += nodes.Text(sep)
+
+            for idx in range(len(keys)):
+                node += nodes.literal('', keys[idx], classes=["kbd"])
+                if idx < len(infix_seps):
+                    node += nodes.Text(infix_seps[idx])
 
 
 def setup(app: Sphinx) -> Dict[str, Any]:


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of `sphinx/roles.py`, `sphinx/transforms/__init__.py`, and `sphinx/builders/html/transforms.py`.
Extra Requirements: 
Purpose: This will provide the necessary source code to understand the data flow from role definition to final transform, and the context of the provided patch.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: sphinx/builders/html/transforms.py
Line number range: 1 - 69
Content:
1. """
2.     sphinx.builders.html.transforms
3.     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
4. 
5.     Transforms for HTML builder.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. from typing import Any, Dict
13. 
14. from docutils import nodes
15. 
16. from sphinx.application import Sphinx
17. from sphinx.transforms.post_transforms import SphinxPostTransform
18. from sphinx.util.nodes import NodeMatcher
19. 
20. 
21. class KeyboardTransform(SphinxPostTransform):
22.     """Transform :kbd: role to more detailed form.
23. 
24.     Before::
25. 
26.         <literal class="kbd">
27.             Control-x
28. 
29.     After::
30. 
31.         <literal class="kbd">
32.             <literal class="kbd">
33.                 Control
34.             -
35.             <literal class="kbd">
36.                 x
37.     """
38.     default_priority = 400
39.     builders = ('html',)
40.     pattern = re.compile(r'(-|\+|\^|\s+)')
41. 
42.     def run(self, **kwargs: Any) -> None:
43.         matcher = NodeMatcher(nodes.literal, classes=["kbd"])
44.         for node in self.document.traverse(matcher):  # type: nodes.literal
45.             parts = self.pattern.split(node[-1].astext())
46.             if len(parts) == 1:
47.                 continue
48. 
49.             node.pop()
50.             while parts:
51.                 key = parts.pop(0)
52.                 node += nodes.literal('', key, classes=["kbd"])
53. 
54.                 try:
55.                     # key separator (ex. -, +, ^)
56.                     sep = parts.pop(0)
57.                     node += nodes.Text(sep)
58.                 except IndexError:
59.                     pass
60. 
61. 
62. def setup(app: Sphinx) -> Dict[str, Any]:
63.     app.add_post_transform(KeyboardTransform)
64. 
65.     return {
66.         'version': 'builtin',
67.         'parallel_read_safe': True,
68.         'parallel_write_safe': True,
69.     }


File: sphinx/roles.py
Line number range: 1 - 500
Content:
1. """
2.     sphinx.roles
3.     ~~~~~~~~~~~~
4. 
5.     Handlers for additional ReST roles.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. import warnings
13. from typing import Any, Dict, List, Tuple
14. 
15. from docutils import nodes, utils
16. from docutils.nodes import Element, Node, TextElement, system_message
17. from docutils.parsers.rst.states import Inliner
18. 
19. from sphinx import addnodes
20. from sphinx.deprecation import RemovedInSphinx40Warning
21. from sphinx.locale import _
22. from sphinx.util import ws_re
23. from sphinx.util.docutils import ReferenceRole, SphinxRole
24. from sphinx.util.nodes import process_index_entry, set_role_source_info, split_explicit_title
25. from sphinx.util.typing import RoleFunction
26. 
27. if False:
28.     # For type annotation
29.     from typing import Type  # for python3.5.1
30. 
31.     from sphinx.application import Sphinx
32.     from sphinx.environment import BuildEnvironment
33. 
34. 
35. generic_docroles = {
36.     'command': addnodes.literal_strong,
37.     'dfn': nodes.emphasis,
38.     'kbd': nodes.literal,
39.     'mailheader': addnodes.literal_emphasis,
40.     'makevar': addnodes.literal_strong,
41.     'manpage': addnodes.manpage,
42.     'mimetype': addnodes.literal_emphasis,
43.     'newsgroup': addnodes.literal_emphasis,
44.     'program': addnodes.literal_strong,  # XXX should be an x-ref
45.     'regexp': nodes.literal,
46. }
47. 
48. 
49. # -- generic cross-reference role ----------------------------------------------
50. 
51. class XRefRole(ReferenceRole):
52.     """
53.     A generic cross-referencing role.  To create a callable that can be used as
54.     a role function, create an instance of this class.
55. 
56.     The general features of this role are:
57. 
58.     * Automatic creation of a reference and a content node.
59.     * Optional separation of title and target with `title <target>`.
60.     * The implementation is a class rather than a function to make
61.       customization easier.
62. 
63.     Customization can be done in two ways:
64. 
65.     * Supplying constructor parameters:
66.       * `fix_parens` to normalize parentheses (strip from target, and add to
67.         title if configured)
68.       * `lowercase` to lowercase the target
69.       * `nodeclass` and `innernodeclass` select the node classes for
70.         the reference and the content node
71. 
72.     * Subclassing and overwriting `process_link()` and/or `result_nodes()`.
73.     """
74. 
75.     nodeclass = addnodes.pending_xref   # type: Type[Element]
76.     innernodeclass = nodes.literal      # type: Type[TextElement]
77. 
78.     def __init__(self, fix_parens: bool = False, lowercase: bool = False,
79.                  nodeclass: "Type[Element]" = None, innernodeclass: "Type[TextElement]" = None,
80.                  warn_dangling: bool = False) -> None:
81.         self.fix_parens = fix_parens
82.         self.lowercase = lowercase
83.         self.warn_dangling = warn_dangling
84.         if nodeclass is not None:
85.             self.nodeclass = nodeclass
86.         if innernodeclass is not None:
87.             self.innernodeclass = innernodeclass
88. 
89.         super().__init__()
90. 
91.     def _fix_parens(self, env: "BuildEnvironment", has_explicit_title: bool, title: str,
92.                     target: str) -> Tuple[str, str]:
93.         warnings.warn('XRefRole._fix_parens() is deprecated.',
94.                       RemovedInSphinx40Warning, stacklevel=2)
95.         if not has_explicit_title:
96.             if title.endswith('()'):
97.                 # remove parentheses
98.                 title = title[:-2]
99.             if env.config.add_function_parentheses:
100.                 # add them back to all occurrences if configured
101.                 title += '()'
102.         # remove parentheses from the target too
103.         if target.endswith('()'):
104.             target = target[:-2]
105.         return title, target
106. 
107.     def update_title_and_target(self, title: str, target: str) -> Tuple[str, str]:
108.         if not self.has_explicit_title:
109.             if title.endswith('()'):
110.                 # remove parentheses
111.                 title = title[:-2]
112.             if self.config.add_function_parentheses:
113.                 # add them back to all occurrences if configured
114.                 title += '()'
115.         # remove parentheses from the target too
116.         if target.endswith('()'):
117.             target = target[:-2]
118.         return title, target
119. 
120.     def run(self) -> Tuple[List[Node], List[system_message]]:
121.         if ':' not in self.name:
122.             self.refdomain, self.reftype = '', self.name
123.             self.classes = ['xref', self.reftype]
124.         else:
125.             self.refdomain, self.reftype = self.name.split(':', 1)
126.             self.classes = ['xref', self.refdomain, '%s-%s' % (self.refdomain, self.reftype)]
127. 
128.         if self.disabled:
129.             return self.create_non_xref_node()
130.         else:
131.             return self.create_xref_node()
132. 
133.     def create_non_xref_node(self) -> Tuple[List[Node], List[system_message]]:
134.         text = utils.unescape(self.text[1:])
135.         if self.fix_parens:
136.             self.has_explicit_title = False  # treat as implicit
137.             text, target = self.update_title_and_target(text, "")
138. 
139.         node = self.innernodeclass(self.rawtext, text, classes=self.classes)
140.         return self.result_nodes(self.inliner.document, self.env, node, is_ref=False)
141. 
142.     def create_xref_node(self) -> Tuple[List[Node], List[system_message]]:
143.         target = self.target
144.         title = self.title
145.         if self.lowercase:
146.             target = target.lower()
147.         if self.fix_parens:
148.             title, target = self.update_title_and_target(title, target)
149. 
150.         # create the reference node
151.         options = {'refdoc': self.env.docname,
152.                    'refdomain': self.refdomain,
153.                    'reftype': self.reftype,
154.                    'refexplicit': self.has_explicit_title,
155.                    'refwarn': self.warn_dangling}
156.         refnode = self.nodeclass(self.rawtext, **options)
157.         self.set_source_info(refnode)
158. 
159.         # determine the target and title for the class
160.         title, target = self.process_link(self.env, refnode, self.has_explicit_title,
161.                                           title, target)
162.         refnode['reftarget'] = target
163.         refnode += self.innernodeclass(self.rawtext, title, classes=self.classes)
164. 
165.         return self.result_nodes(self.inliner.document, self.env, refnode, is_ref=True)
166. 
167.     # methods that can be overwritten
168. 
169.     def process_link(self, env: "BuildEnvironment", refnode: Element, has_explicit_title: bool,
170.                      title: str, target: str) -> Tuple[str, str]:
171.         """Called after parsing title and target text, and creating the
172.         reference node (given in *refnode*).  This method can alter the
173.         reference node and must return a new (or the same) ``(title, target)``
174.         tuple.
175.         """
176.         return title, ws_re.sub(' ', target)
177. 
178.     def result_nodes(self, document: nodes.document, env: "BuildEnvironment", node: Element,
179.                      is_ref: bool) -> Tuple[List[Node], List[system_message]]:
180.         """Called before returning the finished nodes.  *node* is the reference
181.         node if one was created (*is_ref* is then true), else the content node.
182.         This method can add other nodes and must return a ``(nodes, messages)``
183.         tuple (the usual return value of a role function).
184.         """
185.         return [node], []
186. 
187. 
188. class AnyXRefRole(XRefRole):
189.     def process_link(self, env: "BuildEnvironment", refnode: Element, has_explicit_title: bool,
190.                      title: str, target: str) -> Tuple[str, str]:
191.         result = super().process_link(env, refnode, has_explicit_title, title, target)
192.         # add all possible context info (i.e. std:program, py:module etc.)
193.         refnode.attributes.update(env.ref_context)
194.         return result
195. 
196. 
197. def indexmarkup_role(typ: str, rawtext: str, text: str, lineno: int, inliner: Inliner,
198.                      options: Dict = {}, content: List[str] = []
199.                      ) -> Tuple[List[Node], List[system_message]]:
200.     """Role for PEP/RFC references that generate an index entry."""
201.     warnings.warn('indexmarkup_role() is deprecated.  Please use PEP or RFC class instead.',
202.                   RemovedInSphinx40Warning, stacklevel=2)
203.     env = inliner.document.settings.env
204.     if not typ:
205.         assert env.temp_data['default_role']
206.         typ = env.temp_data['default_role'].lower()
207.     else:
208.         typ = typ.lower()
209. 
210.     has_explicit_title, title, target = split_explicit_title(text)
211.     title = utils.unescape(title)
212.     target = utils.unescape(target)
213.     targetid = 'index-%s' % env.new_serialno('index')
214.     indexnode = addnodes.index()
215.     targetnode = nodes.target('', '', ids=[targetid])
216.     inliner.document.note_explicit_target(targetnode)
217.     if typ == 'pep':
218.         indexnode['entries'] = [
219.             ('single', _('Python Enhancement Proposals; PEP %s') % target,
220.              targetid, '', None)]
221.         anchor = ''
222.         anchorindex = target.find('#')
223.         if anchorindex > 0:
224.             target, anchor = target[:anchorindex], target[anchorindex:]
225.         if not has_explicit_title:
226.             title = "PEP " + utils.unescape(title)
227.         try:
228.             pepnum = int(target)
229.         except ValueError:
230.             msg = inliner.reporter.error('invalid PEP number %s' % target,
231.                                          line=lineno)
232.             prb = inliner.problematic(rawtext, rawtext, msg)
233.             return [prb], [msg]
234.         ref = inliner.document.settings.pep_base_url + 'pep-%04d' % pepnum
235.         sn = nodes.strong(title, title)
236.         rn = nodes.reference('', '', internal=False, refuri=ref + anchor,
237.                              classes=[typ])
238.         rn += sn
239.         return [indexnode, targetnode, rn], []
240.     elif typ == 'rfc':
241.         indexnode['entries'] = [
242.             ('single', 'RFC; RFC %s' % target, targetid, '', None)]
243.         anchor = ''
244.         anchorindex = target.find('#')
245.         if anchorindex > 0:
246.             target, anchor = target[:anchorindex], target[anchorindex:]
247.         if not has_explicit_title:
248.             title = "RFC " + utils.unescape(title)
249.         try:
250.             rfcnum = int(target)
251.         except ValueError:
252.             msg = inliner.reporter.error('invalid RFC number %s' % target,
253.                                          line=lineno)
254.             prb = inliner.problematic(rawtext, rawtext, msg)
255.             return [prb], [msg]
256.         ref = inliner.document.settings.rfc_base_url + inliner.rfc_url % rfcnum
257.         sn = nodes.strong(title, title)
258.         rn = nodes.reference('', '', internal=False, refuri=ref + anchor,
259.                              classes=[typ])
260.         rn += sn
261.         return [indexnode, targetnode, rn], []
262.     else:
263.         raise ValueError('unknown role type: %s' % typ)
264. 
265. 
266. class PEP(ReferenceRole):
267.     def run(self) -> Tuple[List[Node], List[system_message]]:
268.         target_id = 'index-%s' % self.env.new_serialno('index')
269.         entries = [('single', _('Python Enhancement Proposals; PEP %s') % self.target,
270.                     target_id, '', None)]
271. 
272.         index = addnodes.index(entries=entries)
273.         target = nodes.target('', '', ids=[target_id])
274.         self.inliner.document.note_explicit_target(target)
275. 
276.         try:
277.             refuri = self.build_uri()
278.             reference = nodes.reference('', '', internal=False, refuri=refuri, classes=['pep'])
279.             if self.has_explicit_title:
280.                 reference += nodes.strong(self.title, self.title)
281.             else:
282.                 title = "PEP " + self.title
283.                 reference += nodes.strong(title, title)
284.         except ValueError:
285.             msg = self.inliner.reporter.error('invalid PEP number %s' % self.target,
286.                                               line=self.lineno)
287.             prb = self.inliner.problematic(self.rawtext, self.rawtext, msg)
288.             return [prb], [msg]
289. 
290.         return [index, target, reference], []
291. 
292.     def build_uri(self) -> str:
293.         base_url = self.inliner.document.settings.pep_base_url
294.         ret = self.target.split('#', 1)
295.         if len(ret) == 2:
296.             return base_url + 'pep-%04d#%s' % (int(ret[0]), ret[1])
297.         else:
298.             return base_url + 'pep-%04d' % int(ret[0])
299. 
300. 
301. class RFC(ReferenceRole):
302.     def run(self) -> Tuple[List[Node], List[system_message]]:
303.         target_id = 'index-%s' % self.env.new_serialno('index')
304.         entries = [('single', 'RFC; RFC %s' % self.target, target_id, '', None)]
305. 
306.         index = addnodes.index(entries=entries)
307.         target = nodes.target('', '', ids=[target_id])
308.         self.inliner.document.note_explicit_target(target)
309. 
310.         try:
311.             refuri = self.build_uri()
312.             reference = nodes.reference('', '', internal=False, refuri=refuri, classes=['rfc'])
313.             if self.has_explicit_title:
314.                 reference += nodes.strong(self.title, self.title)
315.             else:
316.                 title = "RFC " + self.title
317.                 reference += nodes.strong(title, title)
318.         except ValueError:
319.             msg = self.inliner.reporter.error('invalid RFC number %s' % self.target,
320.                                               line=self.lineno)
321.             prb = self.inliner.problematic(self.rawtext, self.rawtext, msg)
322.             return [prb], [msg]
323. 
324.         return [index, target, reference], []
325. 
326.     def build_uri(self) -> str:
327.         base_url = self.inliner.document.settings.rfc_base_url
328.         ret = self.target.split('#', 1)
329.         if len(ret) == 2:
330.             return base_url + self.inliner.rfc_url % int(ret[0]) + '#' + ret[1]
331.         else:
332.             return base_url + self.inliner.rfc_url % int(ret[0])
333. 
334. 
335. _amp_re = re.compile(r'(?<!&)&(?![&\s])')
336. 
337. 
338. def menusel_role(typ: str, rawtext: str, text: str, lineno: int, inliner: Inliner,
339.                  options: Dict = {}, content: List[str] = []
340.                  ) -> Tuple[List[Node], List[system_message]]:
341.     warnings.warn('menusel_role() is deprecated. '
342.                   'Please use MenuSelection or GUILabel class instead.',
343.                   RemovedInSphinx40Warning, stacklevel=2)
344.     env = inliner.document.settings.env
345.     if not typ:
346.         assert env.temp_data['default_role']
347.         typ = env.temp_data['default_role'].lower()
348.     else:
349.         typ = typ.lower()
350. 
351.     text = utils.unescape(text)
352.     if typ == 'menuselection':
353.         text = text.replace('-->', '\N{TRIANGULAR BULLET}')
354.     spans = _amp_re.split(text)
355. 
356.     node = nodes.inline(rawtext=rawtext)
357.     for i, span in enumerate(spans):
358.         span = span.replace('&&', '&')
359.         if i == 0:
360.             if len(span) > 0:
361.                 textnode = nodes.Text(span)
362.                 node += textnode
363.             continue
364.         accel_node = nodes.inline()
365.         letter_node = nodes.Text(span[0])
366.         accel_node += letter_node
367.         accel_node['classes'].append('accelerator')
368.         node += accel_node
369.         textnode = nodes.Text(span[1:])
370.         node += textnode
371. 
372.     node['classes'].append(typ)
373.     return [node], []
374. 
375. 
376. class GUILabel(SphinxRole):
377.     amp_re = re.compile(r'(?<!&)&(?![&\s])')
378. 
379.     def run(self) -> Tuple[List[Node], List[system_message]]:
380.         node = nodes.inline(rawtext=self.rawtext, classes=[self.name])
381.         spans = self.amp_re.split(self.text)
382.         node += nodes.Text(spans.pop(0))
383.         for span in spans:
384.             span = span.replace('&&', '&')
385. 
386.             letter = nodes.Text(span[0])
387.             accelerator = nodes.inline('', '', letter, classes=['accelerator'])
388.             node += accelerator
389.             node += nodes.Text(span[1:])
390. 
391.         return [node], []
392. 
393. 
394. class MenuSelection(GUILabel):
395.     BULLET_CHARACTER = '\N{TRIANGULAR BULLET}'
396. 
397.     def run(self) -> Tuple[List[Node], List[system_message]]:
398.         self.text = self.text.replace('-->', self.BULLET_CHARACTER)
399.         return super().run()
400. 
401. 
402. _litvar_re = re.compile('{([^}]+)}')
403. parens_re = re.compile(r'(\\*{|\\*})')
404. 
405. 
406. def emph_literal_role(typ: str, rawtext: str, text: str, lineno: int, inliner: Inliner,
407.                       options: Dict = {}, content: List[str] = []
408.                       ) -> Tuple[List[Node], List[system_message]]:
409.     warnings.warn('emph_literal_role() is deprecated. '
410.                   'Please use EmphasizedLiteral class instead.',
411.                   RemovedInSphinx40Warning, stacklevel=2)
412.     env = inliner.document.settings.env
413.     if not typ:
414.         assert env.temp_data['default_role']
415.         typ = env.temp_data['default_role'].lower()
416.     else:
417.         typ = typ.lower()
418. 
419.     retnode = nodes.literal(role=typ.lower(), classes=[typ])
420.     parts = list(parens_re.split(utils.unescape(text)))
421.     stack = ['']
422.     for part in parts:
423.         matched = parens_re.match(part)
424.         if matched:
425.             backslashes = len(part) - 1
426.             if backslashes % 2 == 1:    # escaped
427.                 stack[-1] += "\\" * int((backslashes - 1) / 2) + part[-1]
428.             elif part[-1] == '{':       # rparen
429.                 stack[-1] += "\\" * int(backslashes / 2)
430.                 if len(stack) >= 2 and stack[-2] == "{":
431.                     # nested
432.                     stack[-1] += "{"
433.                 else:
434.                     # start emphasis
435.                     stack.append('{')
436.                     stack.append('')
437.             else:                       # lparen
438.                 stack[-1] += "\\" * int(backslashes / 2)
439.                 if len(stack) == 3 and stack[1] == "{" and len(stack[2]) > 0:
440.                     # emphasized word found
441.                     if stack[0]:
442.                         retnode += nodes.Text(stack[0], stack[0])
443.                     retnode += nodes.emphasis(stack[2], stack[2])
444.                     stack = ['']
445.                 else:
446.                     # emphasized word not found; the rparen is not a special symbol
447.                     stack.append('}')
448.                     stack = [''.join(stack)]
449.         else:
450.             stack[-1] += part
451.     if ''.join(stack):
452.         # remaining is treated as Text
453.         text = ''.join(stack)
454.         retnode += nodes.Text(text, text)
455. 
456.     return [retnode], []
457. 
458. 
459. class EmphasizedLiteral(SphinxRole):
460.     parens_re = re.compile(r'(\\\\|\\{|\\}|{|})')
461. 
462.     def run(self) -> Tuple[List[Node], List[system_message]]:
463.         children = self.parse(self.text)
464.         node = nodes.literal(self.rawtext, '', *children,
465.                              role=self.name.lower(), classes=[self.name])
466. 
467.         return [node], []
468. 
469.     def parse(self, text: str) -> List[Node]:
470.         result = []  # type: List[Node]
471. 
472.         stack = ['']
473.         for part in self.parens_re.split(text):
474.             if part == '\\\\':  # escaped backslash
475.                 stack[-1] += '\\'
476.             elif part == '{':
477.                 if len(stack) >= 2 and stack[-2] == "{":  # nested
478.                     stack[-1] += "{"
479.                 else:
480.                     # start emphasis
481.                     stack.append('{')
482.                     stack.append('')
483.             elif part == '}':
484.                 if len(stack) == 3 and stack[1] == "{" and len(stack[2]) > 0:
485.                     # emphasized word found
486.                     if stack[0]:
487.                         result.append(nodes.Text(stack[0], stack[0]))
488.                     result.append(nodes.emphasis(stack[2], stack[2]))
489.                     stack = ['']
490.                 else:
491.                     # emphasized word not found; the rparen is not a special symbol
492.                     stack.append('}')
493.                     stack = [''.join(stack)]
494.             elif part == '\\{':  # escaped left-brace
495.                 stack[-1] += '{'
496.             elif part == '\\}':  # escaped right-brace
497.                 stack[-1] += '}'
498.             else:  # others (containing escaped braces)
499.                 stack[-1] += part
500. 


File: sphinx/transforms/__init__.py
Line number range: 1 - 441
Content:
1. """
2.     sphinx.transforms
3.     ~~~~~~~~~~~~~~~~~
4. 
5.     Docutils transforms used by Sphinx when reading documents.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import re
12. from typing import Any, Dict, Generator, List, Tuple
13. 
14. from docutils import nodes
15. from docutils.nodes import Element, Node, Text
16. from docutils.transforms import Transform, Transformer
17. from docutils.transforms.parts import ContentsFilter
18. from docutils.transforms.universal import SmartQuotes
19. from docutils.utils import normalize_language_tag
20. from docutils.utils.smartquotes import smartchars
21. 
22. from sphinx import addnodes
23. from sphinx.config import Config
24. from sphinx.deprecation import RemovedInSphinx40Warning, deprecated_alias
25. from sphinx.locale import _, __
26. from sphinx.util import docutils, logging
27. from sphinx.util.docutils import new_document
28. from sphinx.util.i18n import format_date
29. from sphinx.util.nodes import NodeMatcher, apply_source_workaround, is_smartquotable
30. 
31. if False:
32.     # For type annotation
33.     from sphinx.application import Sphinx
34.     from sphinx.domain.std import StandardDomain
35.     from sphinx.environment import BuildEnvironment
36. 
37. 
38. logger = logging.getLogger(__name__)
39. 
40. default_substitutions = {
41.     'version',
42.     'release',
43.     'today',
44. }
45. 
46. 
47. class SphinxTransform(Transform):
48.     """A base class of Transforms.
49. 
50.     Compared with ``docutils.transforms.Transform``, this class improves accessibility to
51.     Sphinx APIs.
52.     """
53. 
54.     @property
55.     def app(self) -> "Sphinx":
56.         """Reference to the :class:`.Sphinx` object."""
57.         return self.env.app
58. 
59.     @property
60.     def env(self) -> "BuildEnvironment":
61.         """Reference to the :class:`.BuildEnvironment` object."""
62.         return self.document.settings.env
63. 
64.     @property
65.     def config(self) -> Config:
66.         """Reference to the :class:`.Config` object."""
67.         return self.env.config
68. 
69. 
70. class SphinxTransformer(Transformer):
71.     """
72.     A transformer for Sphinx.
73.     """
74. 
75.     document = None  # type: nodes.document
76.     env = None  # type: BuildEnvironment
77. 
78.     def set_environment(self, env: "BuildEnvironment") -> None:
79.         self.env = env
80. 
81.     def apply_transforms(self) -> None:
82.         if isinstance(self.document, nodes.document):
83.             if not hasattr(self.document.settings, 'env') and self.env:
84.                 self.document.settings.env = self.env
85. 
86.             super().apply_transforms()
87.         else:
88.             # wrap the target node by document node during transforming
89.             try:
90.                 document = new_document('')
91.                 if self.env:
92.                     document.settings.env = self.env
93.                 document += self.document
94.                 self.document = document
95.                 super().apply_transforms()
96.             finally:
97.                 self.document = self.document[0]
98. 
99. 
100. class DefaultSubstitutions(SphinxTransform):
101.     """
102.     Replace some substitutions if they aren't defined in the document.
103.     """
104.     # run before the default Substitutions
105.     default_priority = 210
106. 
107.     def apply(self, **kwargs: Any) -> None:
108.         # only handle those not otherwise defined in the document
109.         to_handle = default_substitutions - set(self.document.substitution_defs)
110.         for ref in self.document.traverse(nodes.substitution_reference):
111.             refname = ref['refname']
112.             if refname in to_handle:
113.                 text = self.config[refname]
114.                 if refname == 'today' and not text:
115.                     # special handling: can also specify a strftime format
116.                     text = format_date(self.config.today_fmt or _('%b %d, %Y'),
117.                                        language=self.config.language)
118.                 ref.replace_self(nodes.Text(text, text))
119. 
120. 
121. class MoveModuleTargets(SphinxTransform):
122.     """
123.     Move module targets that are the first thing in a section to the section
124.     title.
125. 
126.     XXX Python specific
127.     """
128.     default_priority = 210
129. 
130.     def apply(self, **kwargs: Any) -> None:
131.         for node in self.document.traverse(nodes.target):
132.             if not node['ids']:
133.                 continue
134.             if ('ismod' in node and
135.                     node.parent.__class__ is nodes.section and
136.                     # index 0 is the section title node
137.                     node.parent.index(node) == 1):
138.                 node.parent['ids'][0:0] = node['ids']
139.                 node.parent.remove(node)
140. 
141. 
142. class HandleCodeBlocks(SphinxTransform):
143.     """
144.     Several code block related transformations.
145.     """
146.     default_priority = 210
147. 
148.     def apply(self, **kwargs: Any) -> None:
149.         # move doctest blocks out of blockquotes
150.         for node in self.document.traverse(nodes.block_quote):
151.             if all(isinstance(child, nodes.doctest_block) for child
152.                    in node.children):
153.                 node.replace_self(node.children)
154.         # combine successive doctest blocks
155.         # for node in self.document.traverse(nodes.doctest_block):
156.         #    if node not in node.parent.children:
157.         #        continue
158.         #    parindex = node.parent.index(node)
159.         #    while len(node.parent) > parindex+1 and \
160.         #            isinstance(node.parent[parindex+1], nodes.doctest_block):
161.         #        node[0] = nodes.Text(node[0] + '\n\n' +
162.         #                             node.parent[parindex+1][0])
163.         #        del node.parent[parindex+1]
164. 
165. 
166. class AutoNumbering(SphinxTransform):
167.     """
168.     Register IDs of tables, figures and literal_blocks to assign numbers.
169.     """
170.     default_priority = 210
171. 
172.     def apply(self, **kwargs: Any) -> None:
173.         domain = self.env.get_domain('std')  # type: StandardDomain
174. 
175.         for node in self.document.traverse(nodes.Element):
176.             if (domain.is_enumerable_node(node) and
177.                     domain.get_numfig_title(node) is not None and
178.                     node['ids'] == []):
179.                 self.document.note_implicit_target(node)
180. 
181. 
182. class SortIds(SphinxTransform):
183.     """
184.     Sort secion IDs so that the "id[0-9]+" one comes last.
185.     """
186.     default_priority = 261
187. 
188.     def apply(self, **kwargs: Any) -> None:
189.         for node in self.document.traverse(nodes.section):
190.             if len(node['ids']) > 1 and node['ids'][0].startswith('id'):
191.                 node['ids'] = node['ids'][1:] + [node['ids'][0]]
192. 
193. 
194. TRANSLATABLE_NODES = {
195.     'literal-block': nodes.literal_block,
196.     'doctest-block': nodes.doctest_block,
197.     'raw': nodes.raw,
198.     'index': addnodes.index,
199.     'image': nodes.image,
200. }
201. 
202. 
203. class ApplySourceWorkaround(SphinxTransform):
204.     """
205.     update source and rawsource attributes
206.     """
207.     default_priority = 10
208. 
209.     def apply(self, **kwargs: Any) -> None:
210.         for node in self.document.traverse():  # type: Node
211.             if isinstance(node, (nodes.TextElement, nodes.image)):
212.                 apply_source_workaround(node)
213. 
214. 
215. class AutoIndexUpgrader(SphinxTransform):
216.     """
217.     Detect old style; 4 column based indices and automatically upgrade to new style.
218.     """
219.     default_priority = 210
220. 
221.     def apply(self, **kwargs: Any) -> None:
222.         for node in self.document.traverse(addnodes.index):
223.             if 'entries' in node and any(len(entry) == 4 for entry in node['entries']):
224.                 msg = __('4 column based index found. '
225.                          'It might be a bug of extensions you use: %r') % node['entries']
226.                 logger.warning(msg, location=node)
227.                 for i, entry in enumerate(node['entries']):
228.                     if len(entry) == 4:
229.                         node['entries'][i] = entry + (None,)
230. 
231. 
232. class ExtraTranslatableNodes(SphinxTransform):
233.     """
234.     make nodes translatable
235.     """
236.     default_priority = 10
237. 
238.     def apply(self, **kwargs: Any) -> None:
239.         targets = self.config.gettext_additional_targets
240.         target_nodes = [v for k, v in TRANSLATABLE_NODES.items() if k in targets]
241.         if not target_nodes:
242.             return
243. 
244.         def is_translatable_node(node: Node) -> bool:
245.             return isinstance(node, tuple(target_nodes))
246. 
247.         for node in self.document.traverse(is_translatable_node):  # type: Element
248.             node['translatable'] = True
249. 
250. 
251. class UnreferencedFootnotesDetector(SphinxTransform):
252.     """
253.     detect unreferenced footnotes and emit warnings
254.     """
255.     default_priority = 200
256. 
257.     def apply(self, **kwargs: Any) -> None:
258.         for node in self.document.footnotes:
259.             if node['names'] == []:
260.                 # footnote having duplicated number.  It is already warned at parser.
261.                 pass
262.             elif node['names'][0] not in self.document.footnote_refs:
263.                 logger.warning(__('Footnote [%s] is not referenced.'), node['names'][0],
264.                                type='ref', subtype='footnote',
265.                                location=node)
266. 
267.         for node in self.document.autofootnotes:
268.             if not any(ref['auto'] == node['auto'] for ref in self.document.autofootnote_refs):
269.                 logger.warning(__('Footnote [#] is not referenced.'),
270.                                type='ref', subtype='footnote',
271.                                location=node)
272. 
273. 
274. class DoctestTransform(SphinxTransform):
275.     """Set "doctest" style to each doctest_block node"""
276.     default_priority = 500
277. 
278.     def apply(self, **kwargs: Any) -> None:
279.         for node in self.document.traverse(nodes.doctest_block):
280.             node['classes'].append('doctest')
281. 
282. 
283. class FigureAligner(SphinxTransform):
284.     """
285.     Align figures to center by default.
286.     """
287.     default_priority = 700
288. 
289.     def apply(self, **kwargs: Any) -> None:
290.         matcher = NodeMatcher(nodes.table, nodes.figure)
291.         for node in self.document.traverse(matcher):  # type: Element
292.             node.setdefault('align', 'default')
293. 
294. 
295. class FilterSystemMessages(SphinxTransform):
296.     """Filter system messages from a doctree."""
297.     default_priority = 999
298. 
299.     def apply(self, **kwargs: Any) -> None:
300.         filterlevel = 2 if self.config.keep_warnings else 5
301.         for node in self.document.traverse(nodes.system_message):
302.             if node['level'] < filterlevel:
303.                 logger.debug('%s [filtered system message]', node.astext())
304.                 node.parent.remove(node)
305. 
306. 
307. class SphinxContentsFilter(ContentsFilter):
308.     """
309.     Used with BuildEnvironment.add_toc_from() to discard cross-file links
310.     within table-of-contents link nodes.
311.     """
312.     visit_pending_xref = ContentsFilter.ignore_node_but_process_children
313. 
314.     def visit_image(self, node: nodes.image) -> None:
315.         raise nodes.SkipNode
316. 
317. 
318. class SphinxSmartQuotes(SmartQuotes, SphinxTransform):
319.     """
320.     Customized SmartQuotes to avoid transform for some extra node types.
321. 
322.     refs: sphinx.parsers.RSTParser
323.     """
324.     default_priority = 750
325. 
326.     def apply(self, **kwargs: Any) -> None:
327.         if not self.is_available():
328.             return
329. 
330.         # override default settings with :confval:`smartquotes_action`
331.         self.smartquotes_action = self.config.smartquotes_action
332. 
333.         super().apply()
334. 
335.     def is_available(self) -> bool:
336.         builders = self.config.smartquotes_excludes.get('builders', [])
337.         languages = self.config.smartquotes_excludes.get('languages', [])
338. 
339.         if self.document.settings.smart_quotes is False:
340.             # disabled by 3rd party extension (workaround)
341.             return False
342.         elif self.config.smartquotes is False:
343.             # disabled by confval smartquotes
344.             return False
345.         elif self.app.builder.name in builders:
346.             # disabled by confval smartquotes_excludes['builders']
347.             return False
348.         elif self.config.language in languages:
349.             # disabled by confval smartquotes_excludes['languages']
350.             return False
351. 
352.         # confirm selected language supports smart_quotes or not
353.         language = self.env.settings['language_code']
354.         for tag in normalize_language_tag(language):
355.             if tag in smartchars.quotes:
356.                 return True
357.         else:
358.             return False
359. 
360.     def get_tokens(self, txtnodes: List[Text]) -> Generator[Tuple[str, str], None, None]:
361.         # A generator that yields ``(texttype, nodetext)`` tuples for a list
362.         # of "Text" nodes (interface to ``smartquotes.educate_tokens()``).
363.         for txtnode in txtnodes:
364.             if is_smartquotable(txtnode):
365.                 if docutils.__version_info__ >= (0, 16):
366.                     # SmartQuotes uses backslash escapes instead of null-escapes
367.                     text = re.sub(r'(?<=\x00)([-\\\'".`])', r'\\\1', str(txtnode))
368.                 else:
369.                     text = txtnode.astext()
370. 
371.                 yield ('plain', text)
372.             else:
373.                 # skip smart quotes
374.                 yield ('literal', txtnode.astext())
375. 
376. 
377. class DoctreeReadEvent(SphinxTransform):
378.     """Emit :event:`doctree-read` event."""
379.     default_priority = 880
380. 
381.     def apply(self, **kwargs: Any) -> None:
382.         self.app.emit('doctree-read', self.document)
383. 
384. 
385. class ManpageLink(SphinxTransform):
386.     """Find manpage section numbers and names"""
387.     default_priority = 999
388. 
389.     def apply(self, **kwargs: Any) -> None:
390.         for node in self.document.traverse(addnodes.manpage):
391.             manpage = ' '.join([str(x) for x in node.children
392.                                 if isinstance(x, nodes.Text)])
393.             pattern = r'^(?P<path>(?P<page>.+)[\(\.](?P<section>[1-9]\w*)?\)?)$'  # noqa
394.             info = {'path': manpage,
395.                     'page': manpage,
396.                     'section': ''}
397.             r = re.match(pattern, manpage)
398.             if r:
399.                 info = r.groupdict()
400.             node.attributes.update(info)
401. 
402. 
403. from sphinx.domains.citation import CitationDefinitionTransform  # NOQA
404. from sphinx.domains.citation import CitationReferenceTransform  # NOQA
405. 
406. deprecated_alias('sphinx.transforms',
407.                  {
408.                      'CitationReferences': CitationReferenceTransform,
409.                      'SmartQuotesSkipper': CitationDefinitionTransform,
410.                  },
411.                  RemovedInSphinx40Warning,
412.                  {
413.                      'CitationReferences':
414.                      'sphinx.domains.citation.CitationReferenceTransform',
415.                      'SmartQuotesSkipper':
416.                      'sphinx.domains.citation.CitationDefinitionTransform',
417.                  })
418. 
419. 
420. def setup(app: "Sphinx") -> Dict[str, Any]:
421.     app.add_transform(ApplySourceWorkaround)
422.     app.add_transform(ExtraTranslatableNodes)
423.     app.add_transform(DefaultSubstitutions)
424.     app.add_transform(MoveModuleTargets)
425.     app.add_transform(HandleCodeBlocks)
426.     app.add_transform(SortIds)
427.     app.add_transform(DoctestTransform)
428.     app.add_transform(FigureAligner)
429.     app.add_transform(AutoNumbering)
430.     app.add_transform(AutoIndexUpgrader)
431.     app.add_transform(FilterSystemMessages)
432.     app.add_transform(UnreferencedFootnotesDetector)
433.     app.add_transform(SphinxSmartQuotes)
434.     app.add_transform(DoctreeReadEvent)
435.     app.add_transform(ManpageLink)
436. 
437.     return {
438.         'version': 'builtin',
439.         'parallel_read_safe': True,
440.         'parallel_write_safe': True,
441.     }

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-21 00:12:00,742 - thread-126665350973120.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The user's query is about a bug in the `:kbd:` role. The provided context includes `sphinx/roles.py`, which defines the `:kbd:` role, and `sphinx/builders/html/transforms.py`, which contains the buggy `KeyboardTransform` class that processes the output of the role. The provided patch shows the fix for this class. The existing context is sufficient to understand the bug and the fix, as the entire lifecycle of the role is covered and the problem is localized to the `KeyboardTransform` class." query='' extra_requirements='' purpose=''
2025-12-21 00:12:00,743 - thread-126665350973120.prometheus_context_collector - INFO - Successfully retrieved 3 context snippets
