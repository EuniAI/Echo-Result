2025-12-23 00:48:54,579 - thread-124976592041664.prometheus_context_collector - INFO - Starting context retrieval for query: 
Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

2025-12-23 00:48:54,646 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug-report.yml
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── dependabot.yml
|   └── workflows
|       ├── builddoc.yml
|       ├── coverage.yml
|       ├── create-release.yml
|       ├── latex.yml
|       ├── lint.yml
|       ├── lock.yml
|       ├── main.yml
|       ├── nodejs.yml
|       └── transifex.yml
├── .readthedocs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   ├── themes
|   |   |   └── fullsize
|   |   └── tutorial
|   ├── _templates
|   |   └── contents.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── authors.rst
|   ├── changes.rst
|   ├── conf.py
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── templating.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── autodoc_ext.rst
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── autodoc_intenum.py
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── index.rst
|   ├── internals
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── support.rst
|   ├── tutorial
|   |   ├── automatic-doc-generation.rst
|   |   ├── deploying.rst
|   |   ├── describing-code.rst
|   |   ├── end.rst
|   |   ├── first-steps.rst
|   |   ├── getting-started.rst
|   |   ├── index.rst
|   |   ├── more-sphinx-customization.rst
|   |   └── narrative-documentation.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── changes.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── preserve_defaults.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   └── docstring.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_GB
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── is
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── yue
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_TW
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW.Big5
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── searchfield.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── searchtools.js
|   |   |       └── sphinx_highlight.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── console.py
|   |   ├── display.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── exceptions.py
|   |   ├── fileutil.py
|   |   ├── http_date.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   ├── documentation_options.js
|   |   ├── searchtools.js
|   |   └── sphinx_highlight.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-duplicates
|   |   |   └── fish_licence
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-theme-having-multiple-stylesheets
|   |   |   ├── _themes
|   |   |   |   └── mytheme
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-copyright-multiline
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── dedent.rst
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-csv-table
|   |   |   ├── conf.py
|   |   |   └── subdir
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── ns_lookup.rst
|   |   ├── test-domain-c-c_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-cpp-cpp_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-js-javascript_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py
|   |   |   ├── abbr.rst
|   |   |   ├── canonical.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-python_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-python_use_unqualified_type_names
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-environment-record-dependencies
|   |   |   ├── api.rst
|   |   |   ├── conf.py
|   |   |   ├── example_module.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── _functions_to_import.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── autodoc_type_aliases.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── canonical
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── metadata.py
|   |   |       ├── methods.py
|   |   |       ├── module.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── pep604.py
|   |   |       ├── preserve_defaults.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── properties.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       ├── uninitialized_attributes.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_class_module.py
|   |   |   ├── autosummary_dummy_inherited_module.py
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-module_all
|   |   |   ├── autosummary_dummy_package_all
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autosummary_dummy_module.py
|   |   |   |   └── extra_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls-multiple-replacements
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgmockconverter
|   |   |   ├── 1
|   |   |   ├── 2
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── mocksvgconverter.py
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-intersphinx-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   ├── nomath.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-napoleon
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── mypackage
|   |   |   |   ├── __init__.py
|   |   |   |   └── typehints.py
|   |   |   └── typehints.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-highlight_options
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_signaturereturn_icon
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-escape
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── noqa.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-container
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-labels-before-module
|   |   |   ├── automodule1.py
|   |   |   ├── automodule2a.py
|   |   |   ├── automodule2b.py
|   |   |   ├── automodule3.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.rst
|   |   ├── test-linkcheck-anchors-ignore
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-documents_exclude
|   |   |   ├── br0ken_link.rst
|   |   |   ├── broken_link.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-warn-redirects
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-raw-node
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-too-many-retries
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-local-logo
|   |   |   ├── conf.py
|   |   |   ├── images
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   ├── en
|   |   |   |   └── et
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nitpicky-warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-object-description-sections
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-reST-code-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-remote-logo
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── literals.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-domain-objects
|   |   |   ├── conf.py
|   |   |   ├── domains.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-index
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-transforms-post_transforms-keyboard
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-transforms-post_transforms-missing-reference
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_object_description.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_record_dependencies.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_autoproperty.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_preserve_defaults.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_extlinks.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_imgmockconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_extension.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_display.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── babel_runner.py
    ├── bump_docker.sh
    └── bump_version.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 00:49:25,895 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='1. The user is reporting a bug where `rst_prolog` interferes with headings that contain domain directives. The patch is in `sphinx/util/rst.py`.\n2. To find relevant tests, I need to examine tests for the patched module, `sphinx/util/rst.py`, which are likely in `tests/test_util_rst.py`.\n3. The bug is related to `rst_prolog`, and there is a test root named `test-prolog` which seems to be an integration test for this feature. I need to see its configuration and content.\n4. I also need the Python test file that runs the build for the `test-prolog` root to understand the assertions. `tests/test_build.py` is a likely candidate for this.' query='Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.' extra_requirements='' purpose='These files will provide insight into both unit and integration tests related to `rst_prolog` and reStructuredText parsing, which are central to the reported bug.'
2025-12-23 00:49:25,896 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.
2025-12-23 00:49:25,896 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 00:49:25,897 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 00:49:25,898 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 00:49:25,898 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.
Purpose: These files will provide insight into both unit and integration tests related to `rst_prolog` and reStructuredText parsing, which are central to the reported bug.
2025-12-23 00:49:29,125 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have started by reading the four files that you requested. These files should give us a good overview of the testing framework, configuration, and existing tests related to `rst_prolog` and reStructuredText parsing.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/test_build.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2125, 'candidates_token_count': 142, 'total_token_count': 2364, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2125}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 142}], 'thoughts_token_count': 97, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.079429438416387, 'model_name': 'gemini-2.5-pro'} id='run--6bb2e85d-1ab6-4747-a602-2ff91701b207-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_util_rst.py'}, 'id': '6ccc845e-0e58-4ee7-870f-34d6e5eb8efb', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/roots/test-prolog/conf.py'}, 'id': 'ae239dca-3b93-46c9-a0e2-1e34338039c8', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/roots/test-prolog/restructuredtext.rst'}, 'id': 'ee017b9c-26cf-4bf1-af61-ccbf8cd6e651', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_build.py'}, 'id': '33f7f268-78f0-43a7-a176-c52c3a77b121', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2125, 'output_tokens': 142, 'total_tokens': 2364, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 97}}
2025-12-23 00:49:33,442 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have now reviewed the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`. These files provide a good foundation for understanding the testing setup surrounding `rst_prolog` and reStructuredText processing. I will now search the codebase to identify where the `rst_prolog` functionality is implemented.' additional_kwargs={'function_call': {'name': 'find_text_node_with_text', 'arguments': '{"text": "rst_prolog"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 6563, 'candidates_token_count': 116, 'total_token_count': 6937, 'cached_content_token_count': 1719, 'prompt_tokens_details': [{'modality': 1, 'token_count': 6563}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1719}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 116}], 'thoughts_token_count': 258}, 'finish_reason': 'STOP', 'avg_logprobs': -0.24579026781279464, 'model_name': 'gemini-2.5-pro'} id='run--fa85a6a5-a34d-44d7-a505-d4b6d99ce863-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'rst_prolog'}, 'id': '2da4d61a-1486-4c3c-b132-8353d2fa9f15', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6563, 'output_tokens': 116, 'total_tokens': 6937, 'input_token_details': {'cache_read': 1719}, 'output_token_details': {'reasoning': 258}}
2025-12-23 00:49:37,568 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have reviewed the initial set of files, which has provided a foundational understanding of the testing environment and configuration related to the issue. My next step is to locate the core implementation of the `rst_prolog` functionality within the Sphinx codebase to understand how it is processed. To do this, I will now search for occurrences of "rst_prolog" within the codebase.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_basename', 'arguments': '{"text": "rst_prolog", "basename": "sphinx/util/rst.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 12962, 'candidates_token_count': 106, 'total_token_count': 13299, 'cached_content_token_count': 5525, 'prompt_tokens_details': [{'modality': 1, 'token_count': 12962}], 'cache_tokens_details': [{'modality': 1, 'token_count': 5525}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 106}], 'thoughts_token_count': 231}, 'finish_reason': 'STOP', 'avg_logprobs': -0.38867457407825395, 'model_name': 'gemini-2.5-pro'} id='run--d7657aef-8a13-4c27-b83c-47783bc1ff3e-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'rst_prolog', 'basename': 'sphinx/util/rst.py'}, 'id': '6439fb14-1fca-478b-abbc-423a774b1f2b', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12962, 'output_tokens': 106, 'total_tokens': 13299, 'input_token_details': {'cache_read': 5525}, 'output_token_details': {'reasoning': 231}}
2025-12-23 00:49:41,677 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I was unable to find any occurrences of `rst_prolog` in `sphinx/util/rst.py`. I will now broaden my search to the entire codebase to locate where the `rst_prolog` functionality is implemented. This will help me understand how the prolog is processed and identify the source of the bug.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_basename', 'arguments': '{"text": "rst_prolog", "basename": ""}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 13098, 'candidates_token_count': 89, 'total_token_count': 13448, 'cached_content_token_count': 12876, 'prompt_tokens_details': [{'modality': 1, 'token_count': 13098}], 'cache_tokens_details': [{'modality': 1, 'token_count': 12876}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 89}], 'thoughts_token_count': 261}, 'finish_reason': 'STOP', 'avg_logprobs': -0.33003545611092217, 'model_name': 'gemini-2.5-pro'} id='run--f1a7f08f-691a-46d4-9598-81c16647ee91-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'rst_prolog', 'basename': ''}, 'id': '94988c39-775a-485a-b1b1-fe5d5ddff3a3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13098, 'output_tokens': 89, 'total_tokens': 13448, 'input_token_details': {'cache_read': 12876}, 'output_token_details': {'reasoning': 261}}
2025-12-23 00:49:43,744 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I was unable to find any occurrences of `rst_prolog` using an AST node search. It\'s possible that `rst_prolog` is not directly embedded in the code in a way that an AST search can find it. I\'ll try a different approach and search for the string "rst_prolog" in the entire codebase. This should help me find any references to it, including in documentation, configuration files, or as a string literal in the code.' additional_kwargs={'function_call': {'name': 'find_text_node_with_text', 'arguments': '{"text": "rst_prolog"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 13217, 'candidates_token_count': 112, 'total_token_count': 13329, 'cached_content_token_count': 12858, 'prompt_tokens_details': [{'modality': 1, 'token_count': 13217}], 'cache_tokens_details': [{'modality': 1, 'token_count': 12858}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 112}], 'thoughts_token_count': 0}, 'finish_reason': 'STOP', 'avg_logprobs': -0.13667930024010794, 'model_name': 'gemini-2.5-pro'} id='run--9c2d2be4-edea-4849-af8f-c513532b9bc9-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'rst_prolog'}, 'id': 'b1e62ac4-4554-4510-8f7c-ef052c99def2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13217, 'output_tokens': 112, 'total_tokens': 13329, 'input_token_details': {'cache_read': 12858}}
2025-12-23 00:49:48,444 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have now reviewed the documentation and test files related to `rst_prolog`, and I\'ve performed a broad search for the term "rst_prolog" to find where it\'s referenced. The search results point to several documentation files, but not the implementation. I will now investigate the `sphinx/util/rst.py` file to find the `prepend_prolog` function, which I suspect is responsible for handling the `rst_prolog` configuration.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/util/rst.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 19612, 'candidates_token_count': 119, 'total_token_count': 20001, 'cached_content_token_count': 13181, 'prompt_tokens_details': [{'modality': 1, 'token_count': 19612}], 'cache_tokens_details': [{'modality': 1, 'token_count': 13181}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 119}], 'thoughts_token_count': 270}, 'finish_reason': 'STOP', 'avg_logprobs': -0.5263043892483751, 'model_name': 'gemini-2.5-pro'} id='run--04b40549-22e8-41cf-89fb-9c607b272ca6-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/util/rst.py'}, 'id': '38034519-149e-4ca7-93d6-e08481de566f', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19612, 'output_tokens': 119, 'total_tokens': 20001, 'input_token_details': {'cache_read': 13181}, 'output_token_details': {'reasoning': 270}}
2025-12-23 00:49:53,175 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I've located the `prepend_prolog` function in `sphinx/util/rst.py`, which appears to be the culprit. The function's logic for finding the insertion point for the `rst_prolog` is based on a regular expression that identifies docinfo blocks. I believe the issue is that if the `rst_prolog` itself contains content that resembles a docinfo block, it can interfere with the parsing, leading to the observed incorrect rendering. To confirm this, I will now examine `prolog_markdown_parser.py` from the test setup to see how `rst_prolog` is being used in the failing test case." additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/roots/test-prolog/prolog_markdown_parser.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 21248, 'candidates_token_count': 168, 'total_token_count': 21677, 'cached_content_token_count': 18865, 'prompt_tokens_details': [{'modality': 1, 'token_count': 21248}], 'cache_tokens_details': [{'modality': 1, 'token_count': 18865}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 168}], 'thoughts_token_count': 261}, 'finish_reason': 'STOP', 'avg_logprobs': -0.23229501360938662, 'model_name': 'gemini-2.5-pro'} id='run--7af0b7be-0b9a-4f0a-9e86-e41f3f6c7daf-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/roots/test-prolog/prolog_markdown_parser.py'}, 'id': 'b905fb28-95e9-4e5e-a42b-611d92eacfc3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21248, 'output_tokens': 168, 'total_tokens': 21677, 'input_token_details': {'cache_read': 18865}, 'output_token_details': {'reasoning': 261}}
2025-12-23 00:50:00,746 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I have now examined the `prolog_markdown_parser.py` file and see that it's a dummy parser that doesn't actually do any parsing. This means that the issue is not with the parser itself, but with how the `rst_prolog` is being handled by Sphinx. The problem is that the `rst_prolog` is being inserted into the document before the parser has had a chance to process it, which is causing the docinfo block to be misinterpreted.\n\nI have now gathered enough information to formulate a solution. I will modify the `prepend_prolog` function in `sphinx/util/rst.py` to ensure that the `rst_prolog` is inserted after the docinfo block has been parsed. This will prevent the `rst_prolog` from interfering with the parsing of the docinfo block and will fix the bug. I am now ready to submit my proposed solution.\nI have now examined the `prolog_markdown_parser.py` file and see that it's a dummy parser that doesn't actually do any parsing. This means that the issue is not with the parser itself, but with how the `rst_prolog` is being handled by Sphinx. The problem is that the `rst_prolog` is being inserted into the document before the parser has had a chance to process it, which is causing the docinfo block to be misinterpreted.\n\nI have now gathered enough information to formulate a solution. I will modify the `prepend_prolog` function in `sphinx/util/rst.py` to ensure that the `rst_prolog` is inserted after the docinfo block has been parsed. This will prevent the `rst_prolog` from interfering with the parsing of the docinfo block and will fix the bug. I am now ready to submit my proposed solution. I will now read the `sphinx/parsers.py` file to get more context on how the parsers are implemented." additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/parsers.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 21632, 'candidates_token_count': 427, 'total_token_count': 22235, 'cached_content_token_count': 20735, 'prompt_tokens_details': [{'modality': 1, 'token_count': 21632}], 'cache_tokens_details': [{'modality': 1, 'token_count': 20735}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 427}], 'thoughts_token_count': 176}, 'finish_reason': 'STOP', 'avg_logprobs': -0.19870875981708322, 'model_name': 'gemini-2.5-pro'} id='run--1377ad1f-040c-4788-b0bb-93c6461ea7be-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/parsers.py'}, 'id': '1955771b-abc3-443b-b37f-e143b27e6c59', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21632, 'output_tokens': 427, 'total_tokens': 22235, 'input_token_details': {'cache_read': 20735}, 'output_token_details': {'reasoning': 176}}
2025-12-23 00:50:06,570 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have now reviewed all the necessary files and have a clear understanding of the problem. The `prepend_prolog` function in `sphinx/util/rst.py` incorrectly identifies the insertion point for the `rst_prolog` content, causing it to be inserted before the docinfo block is fully parsed. This leads to rendering issues when the `rst_prolog` itself contains content that resembles a docinfo block.\n\nTo fix this, I will modify the `prepend_prolog` function to more accurately determine the correct insertion point, ensuring that the `rst_prolog` is always inserted after the entire docinfo block. This will prevent any interference with the parsing of the docinfo block and resolve the rendering issue. I am now prepared to submit the fix.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 23287, 'candidates_token_count': 159, 'total_token_count': 23862, 'cached_content_token_count': 20784, 'prompt_tokens_details': [{'modality': 1, 'token_count': 23287}], 'cache_tokens_details': [{'modality': 1, 'token_count': 20784}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 159}], 'thoughts_token_count': 416}, 'finish_reason': 'STOP', 'avg_logprobs': -0.24618911743164062, 'model_name': 'gemini-2.5-pro'} id='run--3e831f2a-0ca0-407e-9da2-e28a1e8f79fb-0' usage_metadata={'input_tokens': 23287, 'output_tokens': 159, 'total_tokens': 23862, 'input_token_details': {'cache_read': 20784}, 'output_token_details': {'reasoning': 416}}
2025-12-23 00:50:06,572 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
These files will provide insight into both unit and integration tests related to `rst_prolog` and reStructuredText parsing, which are central to the reported bug.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: doc/faq.rst
Line number range: 1 - 146
Content:
.. _faq:

Sphinx FAQ
==========

This is a list of Frequently Asked Questions about Sphinx.  Feel free to
suggest new entries!

How do I...
-----------

... create PDF files without LaTeX?
   `rinohtype`_ provides a PDF builder that can be used as a drop-in
   replacement for the LaTeX builder.

   .. _rinohtype: https://github.com/brechtm/rinohtype

... get section numbers?
   They are automatic in LaTeX output; for HTML, give a ``:numbered:`` option to
   the :rst:dir:`toctree` directive where you want to start numbering.

... customize the look of the built HTML files?
   Use themes, see :doc:`/usage/theming`.

... add global substitutions or includes?
   Add them in the :confval:`rst_prolog` or :confval:`rst_epilog` config value.

... display the whole TOC tree in the sidebar?
   Use the :data:`toctree` callable in a custom layout template, probably in the
   ``sidebartoc`` block.

... write my own extension?
   See the :doc:`/development/tutorials/index`.

... convert from my existing docs using MoinMoin markup?
   The easiest way is to convert to xhtml, then convert `xhtml to reST`_.
   You'll still need to mark up classes and such, but the headings and code
   examples come through cleanly.

For many more extensions and other contributed stuff, see the sphinx-contrib_
repository.

.. _sphinx-contrib: https://github.com/sphinx-contrib/

.. _usingwith:

Using Sphinx with...
--------------------

Read the Docs
    `Read the Docs <https://readthedocs.org>`_ is a documentation hosting
    service based around Sphinx.  They will host sphinx documentation, along
    with supporting a number of other features including version support, PDF
    generation, and more. The `Getting Started`_ guide is a good place to start.

Epydoc
   There's a third-party extension providing an `api role`_ which refers to
   Epydoc's API docs for a given identifier.

Doxygen
   Michael Jones is developing a reST/Sphinx bridge to doxygen called `breathe
   <https://github.com/michaeljones/breathe/tree/master>`_.

SCons
   Glenn Hutchings has written a SCons build script to build Sphinx
   documentation; it is hosted here:
   https://bitbucket-archive.softwareheritage.org/projects/zo/zondo/sphinx-scons.html

PyPI
   Jannis Leidel wrote a `setuptools command
   <https://pypi.org/project/Sphinx-PyPI-upload/>`_ that automatically
   uploads Sphinx documentation to the PyPI package documentation area at
   https://pythonhosted.org/.

GitHub Pages
   Please add :py:mod:`sphinx.ext.githubpages` to your project.  It allows you
   to publish your document in GitHub Pages.  It generates helper files for
   GitHub Pages on building HTML document automatically.

MediaWiki
   See `sphinx-wiki`_, a project by Kevin Dunn.

   .. _sphinx-wiki: https://bitbucket-archive.softwareheritage.org/projects/ke/kevindunn/sphinx-wiki.html

Google Analytics
   You can use a custom ``layout.html`` template, like this:

   .. code-block:: html+jinja

      {% extends "!layout.html" %}

      {%- block extrahead %}
      {{ super() }}
      <script>
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'XXX account number XXX']);
        _gaq.push(['_trackPageview']);
      </script>
      {% endblock %}

      {% block footer %}
      {{ super() }}
      <div class="footer">This page uses <a href="https://analytics.google.com/">
      Google Analytics</a> to collect statistics. You can disable it by blocking
      the JavaScript coming from www.google-analytics.com.
      <script>
        (function() {
          var ga = document.createElement('script');
          ga.src = ('https:' == document.location.protocol ?
                    'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          ga.setAttribute('async', 'true');
          document.documentElement.firstChild.appendChild(ga);
        })();
      </script>
      </div>
      {% endblock %}


Google Search
   To replace Sphinx's built-in search function with Google Search, proceed as
   follows:

   1. Go to https://cse.google.com/cse/all to create the Google Search code
      snippet.

   2. Copy the code snippet and paste it into ``_templates/searchbox.html`` in
      your Sphinx project:

      .. code-block:: html+jinja

         <div>
            <h3>{{ _('Quick search') }}</h3>
            <script>
               (function() {
                  var cx = '......';
                  var gcse = document.createElement('script');
                  gcse.async = true;
                  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                  var s = document.getElementsByTagName('script')[0];
                  s.parentNode.insertBefore(gcse, s);
               })();
            </script>
           <gcse:search></gcse:search>
         </div>

   3. Add ``searchbox.html`` to the :confval:`html_sidebars` configuration value.


File: doc/usage/configuration.rst
Line number range: 133 - 275
Content:
source_suffix = {
          '.rst': 'restructuredtext',
          '.txt': 'restructuredtext',
          '.md': 'markdown',
      }

   By default, Sphinx only supports ``'restructuredtext'`` file type.  You can
   add a new file type using source parser extensions.  Please read a document
   of the extension to know which file type the extension supports.

   The value may also be a list of file extensions: then Sphinx will consider
   that they all map to the ``'restructuredtext'`` file type.

   Default is ``{'.rst': 'restructuredtext'}``.

   .. note:: file extensions have to start with a dot (e.g. ``.rst``).

   .. versionchanged:: 1.3
      Can now be a list of extensions.

   .. versionchanged:: 1.8
      Support file type mapping

.. confval:: source_encoding

   The encoding of all reST source files.  The recommended encoding, and the
   default value, is ``'utf-8-sig'``.

   .. versionadded:: 0.5
      Previously, Sphinx accepted only UTF-8 encoded sources.

.. confval:: source_parsers

   If given, a dictionary of parser classes for different source suffices.  The
   keys are the suffix, the values can be either a class or a string giving a
   fully-qualified name of a parser class.  The parser class can be either
   ``docutils.parsers.Parser`` or :class:`sphinx.parsers.Parser`.  Files with a
   suffix that is not in the dictionary will be parsed with the default
   reStructuredText parser.

   For example::

      source_parsers = {'.md': 'recommonmark.parser.CommonMarkParser'}

   .. note::

      Refer to :doc:`/usage/markdown` for more information on using Markdown
      with Sphinx.

   .. versionadded:: 1.3

   .. deprecated:: 1.8
      Now Sphinx provides an API :meth:`.Sphinx.add_source_parser` to register
      a source parser.  Please use it instead.

.. confval:: master_doc

   Same as :confval:`root_doc`.

   .. versionchanged:: 4.0
      Renamed ``master_doc`` to ``root_doc``.

.. confval:: root_doc

   The document name of the "root" document, that is, the document that
   contains the root :rst:dir:`toctree` directive.  Default is ``'index'``.

   .. versionchanged:: 2.0
      The default is changed to ``'index'`` from ``'contents'``.
   .. versionchanged:: 4.0
      Renamed ``root_doc`` from ``master_doc``.

.. confval:: exclude_patterns

   A list of glob-style patterns [1]_ that should be excluded when looking for
   source files. They are matched against the source file names relative
   to the source directory, using slashes as directory separators on all
   platforms.

   Example patterns:

   - ``'library/xml.rst'`` -- ignores the ``library/xml.rst`` file
   - ``'library/xml'`` -- ignores the ``library/xml`` directory
   - ``'library/xml*'`` -- ignores all files and directories starting with
     ``library/xml``
   - ``'**/.svn'`` -- ignores all ``.svn`` directories

   :confval:`exclude_patterns` is also consulted when looking for static files
   in :confval:`html_static_path` and :confval:`html_extra_path`.

   .. versionadded:: 1.0

.. confval:: include_patterns

   A list of glob-style patterns [1]_ that are used to find source files. They
   are matched against the source file names relative to the source directory,
   using slashes as directory separators on all platforms. The default is ``**``,
   meaning that all files are recursively included from the source directory.

   Example patterns:

   - ``'**'`` -- all files in the source directory and subdirectories, recursively
   - ``'library/xml'`` -- just the ``library/xml`` directory
   - ``'library/xml*'`` -- all files and directories starting with ``library/xml``
   - ``'**/doc'`` -- all ``doc`` directories (this might be useful if
     documentation is co-located with source files)

   .. versionadded:: 5.1

.. confval:: templates_path

   A list of paths that contain extra templates (or templates that overwrite
   builtin/theme-specific templates).  Relative paths are taken as relative to
   the configuration directory.

   .. versionchanged:: 1.3
      As these files are not meant to be built, they are automatically added to
      :confval:`exclude_patterns`.

.. confval:: template_bridge

   A string with the fully-qualified name of a callable (or simply a class)
   that returns an instance of :class:`~sphinx.application.TemplateBridge`.
   This instance is then used to render HTML documents, and possibly the output
   of other builders (currently the changes builder).  (Note that the template
   bridge must be made theme-aware if HTML themes are to be used.)

.. confval:: rst_epilog

   .. index:: pair: global; substitutions

   A string of reStructuredText that will be included at the end of every source
   file that is read.  This is a possible place to add substitutions that should
   be available in every file (another being :confval:`rst_prolog`).  An
   example::

      rst_epilog = """
      .. |psf| replace:: Python Software Foundation
      """

   .. versionadded:: 0.6

.. confval:: rst_prolog


File: doc/usage/configuration.rst
Line number range: 260 - 429
Content:
.. confval:: rst_epilog

   .. index:: pair: global; substitutions

   A string of reStructuredText that will be included at the end of every source
   file that is read.  This is a possible place to add substitutions that should
   be available in every file (another being :confval:`rst_prolog`).  An
   example::

      rst_epilog = """
      .. |psf| replace:: Python Software Foundation
      """

   .. versionadded:: 0.6

.. confval:: rst_prolog

   .. index:: pair: global; substitutions

   A string of reStructuredText that will be included at the beginning of every
   source file that is read.  This is a possible place to add substitutions that
   should be available in every file (another being :confval:`rst_epilog`).  An
   example::

      rst_prolog = """
      .. |psf| replace:: Python Software Foundation
      """

   .. versionadded:: 1.0

.. confval:: primary_domain

   .. index:: default; domain
              primary; domain

   The name of the default :doc:`domain </usage/restructuredtext/domains>`.
   Can also be ``None`` to disable a default domain.  The default is ``'py'``.
   Those objects in other domains (whether the domain name is given explicitly,
   or selected by a :rst:dir:`default-domain` directive) will have the domain
   name explicitly prepended when named (e.g., when the default domain is C,
   Python functions will be named "Python function", not just "function").

   .. versionadded:: 1.0

.. confval:: default_role

   .. index:: default; role

   The name of a reST role (builtin or Sphinx extension) to use as the default
   role, that is, for text marked up ```like this```.  This can be set to
   ``'py:obj'`` to make ```filter``` a cross-reference to the Python function
   "filter".  The default is ``None``, which doesn't reassign the default role.

   The default role can always be set within individual documents using the
   standard reST :dudir:`default-role` directive.

   .. versionadded:: 0.4

.. confval:: keep_warnings

   If true, keep warnings as "system message" paragraphs in the built
   documents.  Regardless of this setting, warnings are always written to the
   standard error stream when ``sphinx-build`` is run.

   The default is ``False``, the pre-0.5 behavior was to always keep them.

   .. versionadded:: 0.5

.. confval:: suppress_warnings

   A list of warning types to suppress arbitrary warning messages.

   Sphinx supports following warning types:

   * ``app.add_node``
   * ``app.add_directive``
   * ``app.add_role``
   * ``app.add_generic_role``
   * ``app.add_source_parser``
   * ``autosectionlabel.*``
   * ``download.not_readable``
   * ``epub.unknown_project_files``
   * ``epub.duplicated_toc_entry``
   * ``i18n.inconsistent_references``
   * ``index``
   * ``image.not_readable``
   * ``ref.term``
   * ``ref.ref``
   * ``ref.numref``
   * ``ref.keyword``
   * ``ref.option``
   * ``ref.citation``
   * ``ref.footnote``
   * ``ref.doc``
   * ``ref.python``
   * ``misc.highlighting_failure``
   * ``toc.circular``
   * ``toc.excluded``
   * ``toc.not_readable``
   * ``toc.secnum``

   You can choose from these types.  You can also give only the first
   component to exclude all warnings attached to it.

   Now, this option should be considered *experimental*.

   .. versionadded:: 1.4

   .. versionchanged:: 1.5

      Added ``misc.highlighting_failure``

   .. versionchanged:: 1.5.1

      Added ``epub.unknown_project_files``

   .. versionchanged:: 1.6

      Added ``ref.footnote``

   .. versionchanged:: 2.1

      Added ``autosectionlabel.*``

   .. versionchanged:: 3.3.0

      Added ``epub.duplicated_toc_entry``

   .. versionchanged:: 4.3

      Added ``toc.excluded`` and ``toc.not_readable``

   .. versionadded:: 4.5

      Added ``i18n.inconsistent_references``

    .. versionadded:: 7.1

        Added ``index`` warning type.

.. confval:: needs_sphinx

   If set to a ``major.minor`` version string like ``'1.1'``, Sphinx will
   compare it with its version and refuse to build if it is too old.  Default
   is no requirement.

   .. versionadded:: 1.0

   .. versionchanged:: 1.4
      also accepts micro version string

.. confval:: needs_extensions

   This value can be a dictionary specifying version requirements for
   extensions in :confval:`extensions`, e.g. ``needs_extensions =
   {'sphinxcontrib.something': '1.5'}``.  The version strings should be in the
   form ``major.minor``.  Requirements do not have to be specified for all
   extensions, only for those you want to check.

   This requires that the extension specifies its version to Sphinx (see
   :ref:`dev-extensions` for how to do that).

   .. versionadded:: 1.3

.. confval:: manpages_url

   A URL to cross-reference :rst:role:`manpage` roles. If this is
   defined to ``https://manpages.debian.org/{path}``, the
   :literal:`:manpage:`man(1)`` role will link to
   <https://manpages.debian.org/man(1)>. The patterns available are:


File: doc/usage/restructuredtext/basics.rst
Line number range: 414 - 555
Content:
``function`` is the directive name.  It is given two arguments here, the
remainder of the first line and the second line, as well as one option
``module`` (as you can see, options are given in the lines immediately
following the arguments and indicated by the colons).  Options must be indented
to the same level as the directive content.

The directive content follows after a blank line and is indented relative to
the directive start or if options are present, by the same amount as the
options.

Be careful as the indent is not a fixed number of whitespace, e.g. three, but
any number whitespace.  This can be surprising when a fixed indent is used
throughout the document and can make a difference for directives which are
sensitive to whitespace. Compare::

   .. code-block::
      :caption: A cool example

          The output of this line starts with four spaces.

   .. code-block::

          The output of this line has no spaces at the beginning.

In the first code block, the indent for the content was fixated by the option
line to three spaces, consequently the content starts with four spaces.
In the latter the indent was fixed by the content itself to seven spaces, thus
it does not start with a space.


Images
------

reST supports an image directive (:dudir:`ref <image>`), used like so::

   .. image:: gnu.png
      (options)

When used within Sphinx, the file name given (here ``gnu.png``) must either be
relative to the source file, or absolute which means that they are relative to
the top source directory.  For example, the file ``sketch/spam.rst`` could
refer to the image ``images/spam.png`` as ``../images/spam.png`` or
``/images/spam.png``.

Sphinx will automatically copy image files over to a subdirectory of the output
directory on building (e.g. the ``_static`` directory for HTML output.)

Interpretation of image size options (``width`` and ``height``) is as follows:
if the size has no unit or the unit is pixels, the given size will only be
respected for output channels that support pixels. Other units (like ``pt`` for
points) will be used for HTML and LaTeX output (the latter replaces ``pt`` by
``bp`` as this is the TeX unit such that ``72bp=1in``).

Sphinx extends the standard docutils behavior by allowing an asterisk for the
extension::

   .. image:: gnu.*

Sphinx then searches for all images matching the provided pattern and
determines their type.  Each builder then chooses the best image out of these
candidates.  For instance, if the file name ``gnu.*`` was given and two files
:file:`gnu.pdf` and :file:`gnu.png` existed in the source tree, the LaTeX
builder would choose the former, while the HTML builder would prefer the
latter.  Supported image types and choosing priority are defined at
:doc:`/usage/builders/index`.

Note that image file names should not contain spaces.

.. versionchanged:: 0.4
   Added the support for file names ending in an asterisk.

.. versionchanged:: 0.6
   Image paths can now be absolute.

.. versionchanged:: 1.5
   latex target supports pixels (default is ``96px=1in``).


Footnotes
---------

For footnotes (:duref:`ref <footnotes>`), use ``[#name]_`` to mark the footnote
location, and add the footnote body at the bottom of the document after a
"Footnotes" rubric heading, like so::

   Lorem ipsum [#f1]_ dolor sit amet ... [#f2]_

   .. rubric:: Footnotes

   .. [#f1] Text of the first footnote.
   .. [#f2] Text of the second footnote.

You can also explicitly number the footnotes (``[1]_``) or use auto-numbered
footnotes without names (``[#]_``).


Citations
---------

Standard reST citations (:duref:`ref <citations>`) are supported, with the
additional feature that they are "global", i.e. all citations can be referenced
from all files.  Use them like so::

   Lorem ipsum [Ref]_ dolor sit amet.

   .. [Ref] Book or article reference, URL or whatever.

Citation usage is similar to footnote usage, but with a label that is not
numeric or begins with ``#``.


Substitutions
-------------

reST supports "substitutions" (:duref:`ref <substitution-definitions>`), which
are pieces of text and/or markup referred to in the text by ``|name|``.  They
are defined like footnotes with explicit markup blocks, like this::

   .. |name| replace:: replacement *text*

or this::

   .. |caution| image:: warning.png
                :alt: Warning!

See the :duref:`reST reference for substitutions <substitution-definitions>`
for details.

.. index:: ! pair: global; substitutions

If you want to use some substitutions for all documents, put them into
:confval:`rst_prolog` or :confval:`rst_epilog` or put them into a separate file
and include it into all documents you want to use them in, using the
:dudir:`include` directive.  (Be sure to give the include file a file name
extension differing from that of other source files, to avoid Sphinx finding it
as a standalone document.)

Sphinx defines some default substitutions, see :ref:`default-substitutions`.


Comments
--------


File: sphinx/parsers.py
Line number range: 1 - 96
Content:
1. """A Base class for additional parsers."""
2. 
3. from __future__ import annotations
4. 
5. from typing import TYPE_CHECKING, Any
6. 
7. import docutils.parsers
8. import docutils.parsers.rst
9. from docutils import nodes
10. from docutils.parsers.rst import states
11. from docutils.statemachine import StringList
12. from docutils.transforms import Transform
13. from docutils.transforms.universal import SmartQuotes
14. 
15. from sphinx.config import Config
16. from sphinx.environment import BuildEnvironment
17. from sphinx.util.rst import append_epilog, prepend_prolog
18. 
19. if TYPE_CHECKING:
20.     from sphinx.application import Sphinx
21. 
22. 
23. class Parser(docutils.parsers.Parser):
24.     """
25.     A base class of source parsers.  The additional parsers should inherit this class instead
26.     of ``docutils.parsers.Parser``.  Compared with ``docutils.parsers.Parser``, this class
27.     improves accessibility to Sphinx APIs.
28. 
29.     The subclasses can access sphinx core runtime objects (app, config and env).
30.     """
31. 
32.     #: The config object
33.     config: Config
34. 
35.     #: The environment object
36.     env: BuildEnvironment
37. 
38.     def set_application(self, app: Sphinx) -> None:
39.         """set_application will be called from Sphinx to set app and other instance variables
40. 
41.         :param sphinx.application.Sphinx app: Sphinx application object
42.         """
43.         self._app = app
44.         self.config = app.config
45.         self.env = app.env
46. 
47. 
48. class RSTParser(docutils.parsers.rst.Parser, Parser):
49.     """A reST parser for Sphinx."""
50. 
51.     def get_transforms(self) -> list[type[Transform]]:
52.         """
53.         Sphinx's reST parser replaces a transform class for smart-quotes by its own
54. 
55.         refs: sphinx.io.SphinxStandaloneReader
56.         """
57.         transforms = super().get_transforms()
58.         transforms.remove(SmartQuotes)
59.         return transforms
60. 
61.     def parse(self, inputstring: str | StringList, document: nodes.document) -> None:
62.         """Parse text and generate a document tree."""
63.         self.setup_parse(inputstring, document)  # type: ignore
64.         self.statemachine = states.RSTStateMachine(
65.             state_classes=self.state_classes,
66.             initial_state=self.initial_state,
67.             debug=document.reporter.debug_flag)
68. 
69.         # preprocess inputstring
70.         if isinstance(inputstring, str):
71.             lines = docutils.statemachine.string2lines(
72.                 inputstring, tab_width=document.settings.tab_width,
73.                 convert_whitespace=True)
74. 
75.             inputlines = StringList(lines, document.current_source)
76.         else:
77.             inputlines = inputstring
78. 
79.         self.decorate(inputlines)
80.         self.statemachine.run(inputlines, document, inliner=self.inliner)
81.         self.finish_parse()
82. 
83.     def decorate(self, content: StringList) -> None:
84.         """Preprocess reST content before parsing."""
85.         prepend_prolog(content, self.config.rst_prolog)
86.         append_epilog(content, self.config.rst_epilog)
87. 
88. 
89. def setup(app: Sphinx) -> dict[str, Any]:
90.     app.add_source_parser(RSTParser)
91. 
92.     return {
93.         'version': 'builtin',
94.         'parallel_read_safe': True,
95.         'parallel_write_safe': True,
96.     }


File: sphinx/util/rst.py
Line number range: 1 - 110
Content:
1. """reST helper functions."""
2. 
3. from __future__ import annotations
4. 
5. import re
6. from collections import defaultdict
7. from contextlib import contextmanager
8. from typing import Generator
9. from unicodedata import east_asian_width
10. 
11. from docutils.parsers.rst import roles
12. from docutils.parsers.rst.languages import en as english
13. from docutils.statemachine import StringList
14. from docutils.utils import Reporter
15. from jinja2 import Environment
16. 
17. from sphinx.locale import __
18. from sphinx.util import docutils, logging
19. 
20. try:
21.     from jinja2.utils import pass_environment
22. except ImportError:
23.     from jinja2 import environmentfilter as pass_environment
24. 
25. 
26. logger = logging.getLogger(__name__)
27. 
28. docinfo_re = re.compile(':\\w+:.*?')
29. symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
30. SECTIONING_CHARS = ['=', '-', '~']
31. 
32. # width of characters
33. WIDECHARS: dict[str, str] = defaultdict(lambda: "WF")  # WF: Wide + Full-width
34. WIDECHARS["ja"] = "WFA"  # In Japanese, Ambiguous characters also have double width
35. 
36. 
37. def escape(text: str) -> str:
38.     text = symbols_re.sub(r'\\\1', text)
39.     text = re.sub(r'^\.', r'\.', text)  # escape a dot at top
40.     return text
41. 
42. 
43. def textwidth(text: str, widechars: str = 'WF') -> int:
44.     """Get width of text."""
45.     def charwidth(char: str, widechars: str) -> int:
46.         if east_asian_width(char) in widechars:
47.             return 2
48.         else:
49.             return 1
50. 
51.     return sum(charwidth(c, widechars) for c in text)
52. 
53. 
54. @pass_environment
55. def heading(env: Environment, text: str, level: int = 1) -> str:
56.     """Create a heading for *level*."""
57.     assert level <= 3
58.     width = textwidth(text, WIDECHARS[env.language])
59.     sectioning_char = SECTIONING_CHARS[level - 1]
60.     return f'{text}\n{sectioning_char * width}'
61. 
62. 
63. @contextmanager
64. def default_role(docname: str, name: str) -> Generator[None, None, None]:
65.     if name:
66.         dummy_reporter = Reporter('', 4, 4)
67.         role_fn, _ = roles.role(name, english, 0, dummy_reporter)
68.         if role_fn:  # type: ignore[truthy-function]
69.             docutils.register_role('', role_fn)
70.         else:
71.             logger.warning(__('default role %s not found'), name, location=docname)
72. 
73.     yield
74. 
75.     docutils.unregister_role('')
76. 
77. 
78. def prepend_prolog(content: StringList, prolog: str) -> None:
79.     """Prepend a string to content body as prolog."""
80.     if prolog:
81.         pos = 0
82.         for line in content:
83.             if docinfo_re.match(line):
84.                 pos += 1
85.             else:
86.                 break
87. 
88.         if pos > 0:
89.             # insert a blank line after docinfo
90.             content.insert(pos, '', '<generated>', 0)
91.             pos += 1
92. 
93.         # insert prolog (after docinfo if exists)
94.         for lineno, line in enumerate(prolog.splitlines()):
95.             content.insert(pos + lineno, line, '<rst_prolog>', lineno)
96. 
97.         content.insert(pos + lineno + 1, '', '<generated>', 0)
98. 
99. 
100. def append_epilog(content: StringList, epilog: str) -> None:
101.     """Append a string to content body as epilog."""
102.     if epilog:
103.         if len(content) > 0:
104.             source, lineno = content.info(-1)
105.         else:
106.             source = '<generated>'
107.             lineno = 0
108.         content.append('', source, lineno + 1)
109.         for lineno, line in enumerate(epilog.splitlines()):
110.             content.append(line, '<rst_epilog>', lineno)


File: tests/roots/test-prolog/conf.py
Line number range: 1 - 10
Content:
1. import os
2. import sys
3. 
4. sys.path.insert(0, os.path.abspath('.'))
5. 
6. 
7. extensions = ['prolog_markdown_parser']
8. 
9. rst_prolog = '*Hello world*.\n\n'
10. rst_epilog = '\n\n*Good-bye world*.'


File: tests/roots/test-prolog/prolog_markdown_parser.py
Line number range: 1 - 13
Content:
1. from docutils.parsers import Parser
2. 
3. 
4. class DummyMarkdownParser(Parser):
5.     supported = ('markdown',)
6. 
7.     def parse(self, inputstring, document):
8.         document.rawsource = inputstring
9. 
10. 
11. def setup(app):
12.     app.add_source_suffix('.md', 'markdown')
13.     app.add_source_parser(DummyMarkdownParser)


File: tests/roots/test-prolog/restructuredtext.rst
Line number range: 1 - 4
Content:
1. sample document
2. ===============
3. 
4. This is a sample document in reST


File: tests/test_build.py
Line number range: 1 - 135
Content:
1. """Test all builders."""
2. 
3. import sys
4. from unittest import mock
5. 
6. import pytest
7. from docutils import nodes
8. 
9. from sphinx.errors import SphinxError
10. 
11. 
12. def request_session_head(url, **kwargs):
13.     response = mock.Mock()
14.     response.status_code = 200
15.     response.url = url
16.     return response
17. 
18. 
19. @pytest.fixture()
20. def nonascii_srcdir(request, rootdir, sphinx_test_tempdir):
21.     # Build in a non-ASCII source dir
22.     test_name = '\u65e5\u672c\u8a9e'
23.     basedir = sphinx_test_tempdir / request.node.originalname
24.     srcdir = basedir / test_name
25.     if not srcdir.exists():
26.         (rootdir / 'test-root').copytree(srcdir)
27. 
28.     # add a doc with a non-ASCII file name to the source dir
29.     (srcdir / (test_name + '.txt')).write_text("""
30. nonascii file name page
31. =======================
32. """, encoding='utf8')
33. 
34.     root_doc = srcdir / 'index.txt'
35.     root_doc.write_text(root_doc.read_text(encoding='utf8') + f"""
36. .. toctree::
37. 
38. {test_name}/{test_name}
39. """, encoding='utf8')
40.     return srcdir
41. 
42. 
43. # note: this test skips building docs for some builders because they have independent testcase.
44. #       (html, changes, epub, latex, texinfo and manpage)
45. @pytest.mark.parametrize(
46.     "buildername",
47.     ['dirhtml', 'singlehtml', 'text', 'xml', 'pseudoxml', 'linkcheck'],
48. )
49. @mock.patch('sphinx.builders.linkcheck.requests.head',
50.             side_effect=request_session_head)
51. @pytest.mark.xfail(sys.platform == 'win32', reason="Not working on windows")
52. def test_build_all(requests_head, make_app, nonascii_srcdir, buildername):
53.     app = make_app(buildername, srcdir=nonascii_srcdir)
54.     app.build()
55. 
56. 
57. def test_root_doc_not_found(tempdir, make_app):
58.     (tempdir / 'conf.py').write_text('', encoding='utf8')
59.     assert tempdir.listdir() == ['conf.py']
60. 
61.     app = make_app('dummy', srcdir=tempdir)
62.     with pytest.raises(SphinxError):
63.         app.builder.build_all()  # no index.rst
64. 
65. 
66. @pytest.mark.sphinx(buildername='text', testroot='circular')
67. def test_circular_toctree(app, status, warning):
68.     app.builder.build_all()
69.     warnings = warning.getvalue()
70.     assert (
71.         'circular toctree references detected, ignoring: '
72.         'sub <- index <- sub') in warnings
73.     assert (
74.         'circular toctree references detected, ignoring: '
75.         'index <- sub <- index') in warnings
76. 
77. 
78. @pytest.mark.sphinx(buildername='text', testroot='numbered-circular')
79. def test_numbered_circular_toctree(app, status, warning):
80.     app.builder.build_all()
81.     warnings = warning.getvalue()
82.     assert (
83.         'circular toctree references detected, ignoring: '
84.         'sub <- index <- sub') in warnings
85.     assert (
86.         'circular toctree references detected, ignoring: '
87.         'index <- sub <- index') in warnings
88. 
89. 
90. @pytest.mark.sphinx(buildername='dummy', testroot='images')
91. def test_image_glob(app, status, warning):
92.     app.builder.build_all()
93. 
94.     # index.rst
95.     doctree = app.env.get_doctree('index')
96. 
97.     assert isinstance(doctree[0][1], nodes.image)
98.     assert doctree[0][1]['candidates'] == {'*': 'rimg.png'}
99.     assert doctree[0][1]['uri'] == 'rimg.png'
100. 
101.     assert isinstance(doctree[0][2], nodes.figure)
102.     assert isinstance(doctree[0][2][0], nodes.image)
103.     assert doctree[0][2][0]['candidates'] == {'*': 'rimg.png'}
104.     assert doctree[0][2][0]['uri'] == 'rimg.png'
105. 
106.     assert isinstance(doctree[0][3], nodes.image)
107.     assert doctree[0][3]['candidates'] == {'application/pdf': 'img.pdf',
108.                                            'image/gif': 'img.gif',
109.                                            'image/png': 'img.png'}
110.     assert doctree[0][3]['uri'] == 'img.*'
111. 
112.     assert isinstance(doctree[0][4], nodes.figure)
113.     assert isinstance(doctree[0][4][0], nodes.image)
114.     assert doctree[0][4][0]['candidates'] == {'application/pdf': 'img.pdf',
115.                                               'image/gif': 'img.gif',
116.                                               'image/png': 'img.png'}
117.     assert doctree[0][4][0]['uri'] == 'img.*'
118. 
119.     # subdir/index.rst
120.     doctree = app.env.get_doctree('subdir/index')
121. 
122.     assert isinstance(doctree[0][1], nodes.image)
123.     assert doctree[0][1]['candidates'] == {'*': 'subdir/rimg.png'}
124.     assert doctree[0][1]['uri'] == 'subdir/rimg.png'
125. 
126.     assert isinstance(doctree[0][2], nodes.image)
127.     assert doctree[0][2]['candidates'] == {'application/pdf': 'subdir/svgimg.pdf',
128.                                            'image/svg+xml': 'subdir/svgimg.svg'}
129.     assert doctree[0][2]['uri'] == 'subdir/svgimg.*'
130. 
131.     assert isinstance(doctree[0][3], nodes.figure)
132.     assert isinstance(doctree[0][3][0], nodes.image)
133.     assert doctree[0][3][0]['candidates'] == {'application/pdf': 'subdir/svgimg.pdf',
134.                                               'image/svg+xml': 'subdir/svgimg.svg'}
135.     assert doctree[0][3][0]['uri'] == 'subdir/svgimg.*'


File: tests/test_util_rst.py
Line number range: 1 - 109
Content:
1. """Tests sphinx.util.rst functions."""
2. 
3. from docutils.statemachine import StringList
4. from jinja2 import Environment
5. 
6. from sphinx.util.rst import append_epilog, escape, heading, prepend_prolog, textwidth
7. 
8. 
9. def test_escape():
10.     assert escape(':ref:`id`') == r'\:ref\:\`id\`'
11.     assert escape('footnote [#]_') == r'footnote \[\#\]\_'
12.     assert escape('sphinx.application') == r'sphinx.application'
13.     assert escape('.. toctree::') == r'\.. toctree\:\:'
14. 
15. 
16. def test_append_epilog(app):
17.     epilog = 'this is rst_epilog\ngood-bye reST!'
18.     content = StringList(['hello Sphinx world',
19.                           'Sphinx is a document generator'],
20.                          'dummy.rst')
21.     append_epilog(content, epilog)
22. 
23.     assert list(content.xitems()) == [('dummy.rst', 0, 'hello Sphinx world'),
24.                                       ('dummy.rst', 1, 'Sphinx is a document generator'),
25.                                       ('dummy.rst', 2, ''),
26.                                       ('<rst_epilog>', 0, 'this is rst_epilog'),
27.                                       ('<rst_epilog>', 1, 'good-bye reST!')]
28. 
29. 
30. def test_prepend_prolog(app):
31.     prolog = 'this is rst_prolog\nhello reST!'
32.     content = StringList([':title: test of SphinxFileInput',
33.                           ':author: Sphinx team',
34.                           '',
35.                           'hello Sphinx world',
36.                           'Sphinx is a document generator'],
37.                          'dummy.rst')
38.     prepend_prolog(content, prolog)
39. 
40.     assert list(content.xitems()) == [('dummy.rst', 0, ':title: test of SphinxFileInput'),
41.                                       ('dummy.rst', 1, ':author: Sphinx team'),
42.                                       ('<generated>', 0, ''),
43.                                       ('<rst_prolog>', 0, 'this is rst_prolog'),
44.                                       ('<rst_prolog>', 1, 'hello reST!'),
45.                                       ('<generated>', 0, ''),
46.                                       ('dummy.rst', 2, ''),
47.                                       ('dummy.rst', 3, 'hello Sphinx world'),
48.                                       ('dummy.rst', 4, 'Sphinx is a document generator')]
49. 
50. 
51. def test_prepend_prolog_with_CR(app):
52.     # prolog having CR at tail
53.     prolog = 'this is rst_prolog\nhello reST!\n'
54.     content = StringList(['hello Sphinx world',
55.                           'Sphinx is a document generator'],
56.                          'dummy.rst')
57.     prepend_prolog(content, prolog)
58. 
59.     assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),
60.                                       ('<rst_prolog>', 1, 'hello reST!'),
61.                                       ('<generated>', 0, ''),
62.                                       ('dummy.rst', 0, 'hello Sphinx world'),
63.                                       ('dummy.rst', 1, 'Sphinx is a document generator')]
64. 
65. 
66. def test_prepend_prolog_without_CR(app):
67.     # prolog not having CR at tail
68.     prolog = 'this is rst_prolog\nhello reST!'
69.     content = StringList(['hello Sphinx world',
70.                           'Sphinx is a document generator'],
71.                          'dummy.rst')
72.     prepend_prolog(content, prolog)
73. 
74.     assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),
75.                                       ('<rst_prolog>', 1, 'hello reST!'),
76.                                       ('<generated>', 0, ''),
77.                                       ('dummy.rst', 0, 'hello Sphinx world'),
78.                                       ('dummy.rst', 1, 'Sphinx is a document generator')]
79. 
80. 
81. def test_textwidth():
82.     assert textwidth('Hello') == 5
83.     assert textwidth('русский язык') == 12
84.     assert textwidth('русский язык', 'WFA') == 23  # Cyrillic are ambiguous chars
85. 
86. 
87. def test_heading():
88.     env = Environment()
89.     env.extend(language=None)
90. 
91.     assert heading(env, 'Hello') == ('Hello\n'
92.                                      '=====')
93.     assert heading(env, 'Hello', 1) == ('Hello\n'
94.                                         '=====')
95.     assert heading(env, 'Hello', 2) == ('Hello\n'
96.                                         '-----')
97.     assert heading(env, 'Hello', 3) == ('Hello\n'
98.                                         '~~~~~')
99.     assert heading(env, 'русский язык', 1) == (
100.         'русский язык\n'
101.         '============'
102.     )
103. 
104.     # language=ja: ambiguous
105.     env.language = 'ja'
106.     assert heading(env, 'русский язык', 1) == (
107.         'русский язык\n'
108.         '======================='
109.     )

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 00:50:12,239 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='The user explicitly requested the content of `tests/test_util_rst.py`. This context provides the full content of the requested file.', relative_path='tests/test_util_rst.py', start_line=1, end_line=109), ContextOutput(reasoning='The user explicitly requested the content of `tests/roots/test-prolog/conf.py`. This context provides the full content of the requested file, which is relevant for understanding the test configuration for `rst_prolog`.', relative_path='tests/roots/test-prolog/conf.py', start_line=1, end_line=10), ContextOutput(reasoning='The user explicitly requested the content of `tests/roots/test-prolog/restructuredtext.rst`. This context provides the full content of the requested file, which is a sample reStructuredText document used in the tests.', relative_path='tests/roots/test-prolog/restructuredtext.rst', start_line=1, end_line=4), ContextOutput(reasoning='The user explicitly requested the content of `tests/test_build.py`. This context provides the full content of the requested file, which contains integration tests for various Sphinx builders.', relative_path='tests/test_build.py', start_line=1, end_line=135)]
2025-12-23 00:50:12,241 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 4 contexts to memory for query: Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.
2025-12-23 00:50:12,241 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 00:50:12,241 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 00:50:12,242 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 4 new contexts to 0 existing contexts
2025-12-23 00:50:12,242 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 4 total contexts (removed 0 duplicates)
2025-12-23 00:50:12,243 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug-report.yml
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── dependabot.yml
|   └── workflows
|       ├── builddoc.yml
|       ├── coverage.yml
|       ├── create-release.yml
|       ├── latex.yml
|       ├── lint.yml
|       ├── lock.yml
|       ├── main.yml
|       ├── nodejs.yml
|       └── transifex.yml
├── .readthedocs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   ├── themes
|   |   |   └── fullsize
|   |   └── tutorial
|   ├── _templates
|   |   └── contents.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── authors.rst
|   ├── changes.rst
|   ├── conf.py
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── templating.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── autodoc_ext.rst
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── autodoc_intenum.py
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── index.rst
|   ├── internals
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── support.rst
|   ├── tutorial
|   |   ├── automatic-doc-generation.rst
|   |   ├── deploying.rst
|   |   ├── describing-code.rst
|   |   ├── end.rst
|   |   ├── first-steps.rst
|   |   ├── getting-started.rst
|   |   ├── index.rst
|   |   ├── more-sphinx-customization.rst
|   |   └── narrative-documentation.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── changes.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── preserve_defaults.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   └── docstring.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_GB
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── is
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── yue
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_TW
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW.Big5
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── searchfield.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── searchtools.js
|   |   |       └── sphinx_highlight.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── console.py
|   |   ├── display.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── exceptions.py
|   |   ├── fileutil.py
|   |   ├── http_date.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   ├── documentation_options.js
|   |   ├── searchtools.js
|   |   └── sphinx_highlight.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-duplicates
|   |   |   └── fish_licence
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-theme-having-multiple-stylesheets
|   |   |   ├── _themes
|   |   |   |   └── mytheme
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-copyright-multiline
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── dedent.rst
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-csv-table
|   |   |   ├── conf.py
|   |   |   └── subdir
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── ns_lookup.rst
|   |   ├── test-domain-c-c_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-cpp-cpp_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-js-javascript_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py
|   |   |   ├── abbr.rst
|   |   |   ├── canonical.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-python_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-python_use_unqualified_type_names
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-environment-record-dependencies
|   |   |   ├── api.rst
|   |   |   ├── conf.py
|   |   |   ├── example_module.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── _functions_to_import.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── autodoc_type_aliases.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── canonical
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── metadata.py
|   |   |       ├── methods.py
|   |   |       ├── module.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── pep604.py
|   |   |       ├── preserve_defaults.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── properties.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       ├── uninitialized_attributes.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_class_module.py
|   |   |   ├── autosummary_dummy_inherited_module.py
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-module_all
|   |   |   ├── autosummary_dummy_package_all
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autosummary_dummy_module.py
|   |   |   |   └── extra_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls-multiple-replacements
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgmockconverter
|   |   |   ├── 1
|   |   |   ├── 2
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── mocksvgconverter.py
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-intersphinx-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   ├── nomath.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-napoleon
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── mypackage
|   |   |   |   ├── __init__.py
|   |   |   |   └── typehints.py
|   |   |   └── typehints.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-highlight_options
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_signaturereturn_icon
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-escape
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── noqa.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-container
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-labels-before-module
|   |   |   ├── automodule1.py
|   |   |   ├── automodule2a.py
|   |   |   ├── automodule2b.py
|   |   |   ├── automodule3.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.rst
|   |   ├── test-linkcheck-anchors-ignore
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-documents_exclude
|   |   |   ├── br0ken_link.rst
|   |   |   ├── broken_link.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-warn-redirects
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-raw-node
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-too-many-retries
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-local-logo
|   |   |   ├── conf.py
|   |   |   ├── images
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   ├── en
|   |   |   |   └── et
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nitpicky-warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-object-description-sections
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-reST-code-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-remote-logo
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── literals.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-domain-objects
|   |   |   ├── conf.py
|   |   |   ├── domains.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-index
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-transforms-post_transforms-keyboard
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-transforms-post_transforms-missing-reference
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_object_description.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_record_dependencies.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_autoproperty.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_preserve_defaults.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_extlinks.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_imgmockconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_extension.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_display.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── babel_runner.py
    ├── bump_docker.sh
    └── bump_version.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.
Extra Requirements: 
Purpose: These files will provide insight into both unit and integration tests related to `rst_prolog` and reStructuredText parsing, which are central to the reported bug.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: tests/roots/test-prolog/conf.py
Line number range: 1 - 10
Content:
1. import os
2. import sys
3. 
4. sys.path.insert(0, os.path.abspath('.'))
5. 
6. 
7. extensions = ['prolog_markdown_parser']
8. 
9. rst_prolog = '*Hello world*.\n\n'
10. rst_epilog = '\n\n*Good-bye world*.'


File: tests/roots/test-prolog/restructuredtext.rst
Line number range: 1 - 4
Content:
1. sample document
2. ===============
3. 
4. This is a sample document in reST


File: tests/test_build.py
Line number range: 1 - 135
Content:
1. """Test all builders."""
2. 
3. import sys
4. from unittest import mock
5. 
6. import pytest
7. from docutils import nodes
8. 
9. from sphinx.errors import SphinxError
10. 
11. 
12. def request_session_head(url, **kwargs):
13.     response = mock.Mock()
14.     response.status_code = 200
15.     response.url = url
16.     return response
17. 
18. 
19. @pytest.fixture()
20. def nonascii_srcdir(request, rootdir, sphinx_test_tempdir):
21.     # Build in a non-ASCII source dir
22.     test_name = '\u65e5\u672c\u8a9e'
23.     basedir = sphinx_test_tempdir / request.node.originalname
24.     srcdir = basedir / test_name
25.     if not srcdir.exists():
26.         (rootdir / 'test-root').copytree(srcdir)
27. 
28.     # add a doc with a non-ASCII file name to the source dir
29.     (srcdir / (test_name + '.txt')).write_text("""
30. nonascii file name page
31. =======================
32. """, encoding='utf8')
33. 
34.     root_doc = srcdir / 'index.txt'
35.     root_doc.write_text(root_doc.read_text(encoding='utf8') + f"""
36. .. toctree::
37. 
38. {test_name}/{test_name}
39. """, encoding='utf8')
40.     return srcdir
41. 
42. 
43. # note: this test skips building docs for some builders because they have independent testcase.
44. #       (html, changes, epub, latex, texinfo and manpage)
45. @pytest.mark.parametrize(
46.     "buildername",
47.     ['dirhtml', 'singlehtml', 'text', 'xml', 'pseudoxml', 'linkcheck'],
48. )
49. @mock.patch('sphinx.builders.linkcheck.requests.head',
50.             side_effect=request_session_head)
51. @pytest.mark.xfail(sys.platform == 'win32', reason="Not working on windows")
52. def test_build_all(requests_head, make_app, nonascii_srcdir, buildername):
53.     app = make_app(buildername, srcdir=nonascii_srcdir)
54.     app.build()
55. 
56. 
57. def test_root_doc_not_found(tempdir, make_app):
58.     (tempdir / 'conf.py').write_text('', encoding='utf8')
59.     assert tempdir.listdir() == ['conf.py']
60. 
61.     app = make_app('dummy', srcdir=tempdir)
62.     with pytest.raises(SphinxError):
63.         app.builder.build_all()  # no index.rst
64. 
65. 
66. @pytest.mark.sphinx(buildername='text', testroot='circular')
67. def test_circular_toctree(app, status, warning):
68.     app.builder.build_all()
69.     warnings = warning.getvalue()
70.     assert (
71.         'circular toctree references detected, ignoring: '
72.         'sub <- index <- sub') in warnings
73.     assert (
74.         'circular toctree references detected, ignoring: '
75.         'index <- sub <- index') in warnings
76. 
77. 
78. @pytest.mark.sphinx(buildername='text', testroot='numbered-circular')
79. def test_numbered_circular_toctree(app, status, warning):
80.     app.builder.build_all()
81.     warnings = warning.getvalue()
82.     assert (
83.         'circular toctree references detected, ignoring: '
84.         'sub <- index <- sub') in warnings
85.     assert (
86.         'circular toctree references detected, ignoring: '
87.         'index <- sub <- index') in warnings
88. 
89. 
90. @pytest.mark.sphinx(buildername='dummy', testroot='images')
91. def test_image_glob(app, status, warning):
92.     app.builder.build_all()
93. 
94.     # index.rst
95.     doctree = app.env.get_doctree('index')
96. 
97.     assert isinstance(doctree[0][1], nodes.image)
98.     assert doctree[0][1]['candidates'] == {'*': 'rimg.png'}
99.     assert doctree[0][1]['uri'] == 'rimg.png'
100. 
101.     assert isinstance(doctree[0][2], nodes.figure)
102.     assert isinstance(doctree[0][2][0], nodes.image)
103.     assert doctree[0][2][0]['candidates'] == {'*': 'rimg.png'}
104.     assert doctree[0][2][0]['uri'] == 'rimg.png'
105. 
106.     assert isinstance(doctree[0][3], nodes.image)
107.     assert doctree[0][3]['candidates'] == {'application/pdf': 'img.pdf',
108.                                            'image/gif': 'img.gif',
109.                                            'image/png': 'img.png'}
110.     assert doctree[0][3]['uri'] == 'img.*'
111. 
112.     assert isinstance(doctree[0][4], nodes.figure)
113.     assert isinstance(doctree[0][4][0], nodes.image)
114.     assert doctree[0][4][0]['candidates'] == {'application/pdf': 'img.pdf',
115.                                               'image/gif': 'img.gif',
116.                                               'image/png': 'img.png'}
117.     assert doctree[0][4][0]['uri'] == 'img.*'
118. 
119.     # subdir/index.rst
120.     doctree = app.env.get_doctree('subdir/index')
121. 
122.     assert isinstance(doctree[0][1], nodes.image)
123.     assert doctree[0][1]['candidates'] == {'*': 'subdir/rimg.png'}
124.     assert doctree[0][1]['uri'] == 'subdir/rimg.png'
125. 
126.     assert isinstance(doctree[0][2], nodes.image)
127.     assert doctree[0][2]['candidates'] == {'application/pdf': 'subdir/svgimg.pdf',
128.                                            'image/svg+xml': 'subdir/svgimg.svg'}
129.     assert doctree[0][2]['uri'] == 'subdir/svgimg.*'
130. 
131.     assert isinstance(doctree[0][3], nodes.figure)
132.     assert isinstance(doctree[0][3][0], nodes.image)
133.     assert doctree[0][3][0]['candidates'] == {'application/pdf': 'subdir/svgimg.pdf',
134.                                               'image/svg+xml': 'subdir/svgimg.svg'}
135.     assert doctree[0][3][0]['uri'] == 'subdir/svgimg.*'


File: tests/test_util_rst.py
Line number range: 1 - 109
Content:
1. """Tests sphinx.util.rst functions."""
2. 
3. from docutils.statemachine import StringList
4. from jinja2 import Environment
5. 
6. from sphinx.util.rst import append_epilog, escape, heading, prepend_prolog, textwidth
7. 
8. 
9. def test_escape():
10.     assert escape(':ref:`id`') == r'\:ref\:\`id\`'
11.     assert escape('footnote [#]_') == r'footnote \[\#\]\_'
12.     assert escape('sphinx.application') == r'sphinx.application'
13.     assert escape('.. toctree::') == r'\.. toctree\:\:'
14. 
15. 
16. def test_append_epilog(app):
17.     epilog = 'this is rst_epilog\ngood-bye reST!'
18.     content = StringList(['hello Sphinx world',
19.                           'Sphinx is a document generator'],
20.                          'dummy.rst')
21.     append_epilog(content, epilog)
22. 
23.     assert list(content.xitems()) == [('dummy.rst', 0, 'hello Sphinx world'),
24.                                       ('dummy.rst', 1, 'Sphinx is a document generator'),
25.                                       ('dummy.rst', 2, ''),
26.                                       ('<rst_epilog>', 0, 'this is rst_epilog'),
27.                                       ('<rst_epilog>', 1, 'good-bye reST!')]
28. 
29. 
30. def test_prepend_prolog(app):
31.     prolog = 'this is rst_prolog\nhello reST!'
32.     content = StringList([':title: test of SphinxFileInput',
33.                           ':author: Sphinx team',
34.                           '',
35.                           'hello Sphinx world',
36.                           'Sphinx is a document generator'],
37.                          'dummy.rst')
38.     prepend_prolog(content, prolog)
39. 
40.     assert list(content.xitems()) == [('dummy.rst', 0, ':title: test of SphinxFileInput'),
41.                                       ('dummy.rst', 1, ':author: Sphinx team'),
42.                                       ('<generated>', 0, ''),
43.                                       ('<rst_prolog>', 0, 'this is rst_prolog'),
44.                                       ('<rst_prolog>', 1, 'hello reST!'),
45.                                       ('<generated>', 0, ''),
46.                                       ('dummy.rst', 2, ''),
47.                                       ('dummy.rst', 3, 'hello Sphinx world'),
48.                                       ('dummy.rst', 4, 'Sphinx is a document generator')]
49. 
50. 
51. def test_prepend_prolog_with_CR(app):
52.     # prolog having CR at tail
53.     prolog = 'this is rst_prolog\nhello reST!\n'
54.     content = StringList(['hello Sphinx world',
55.                           'Sphinx is a document generator'],
56.                          'dummy.rst')
57.     prepend_prolog(content, prolog)
58. 
59.     assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),
60.                                       ('<rst_prolog>', 1, 'hello reST!'),
61.                                       ('<generated>', 0, ''),
62.                                       ('dummy.rst', 0, 'hello Sphinx world'),
63.                                       ('dummy.rst', 1, 'Sphinx is a document generator')]
64. 
65. 
66. def test_prepend_prolog_without_CR(app):
67.     # prolog not having CR at tail
68.     prolog = 'this is rst_prolog\nhello reST!'
69.     content = StringList(['hello Sphinx world',
70.                           'Sphinx is a document generator'],
71.                          'dummy.rst')
72.     prepend_prolog(content, prolog)
73. 
74.     assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),
75.                                       ('<rst_prolog>', 1, 'hello reST!'),
76.                                       ('<generated>', 0, ''),
77.                                       ('dummy.rst', 0, 'hello Sphinx world'),
78.                                       ('dummy.rst', 1, 'Sphinx is a document generator')]
79. 
80. 
81. def test_textwidth():
82.     assert textwidth('Hello') == 5
83.     assert textwidth('русский язык') == 12
84.     assert textwidth('русский язык', 'WFA') == 23  # Cyrillic are ambiguous chars
85. 
86. 
87. def test_heading():
88.     env = Environment()
89.     env.extend(language=None)
90. 
91.     assert heading(env, 'Hello') == ('Hello\n'
92.                                      '=====')
93.     assert heading(env, 'Hello', 1) == ('Hello\n'
94.                                         '=====')
95.     assert heading(env, 'Hello', 2) == ('Hello\n'
96.                                         '-----')
97.     assert heading(env, 'Hello', 3) == ('Hello\n'
98.                                         '~~~~~')
99.     assert heading(env, 'русский язык', 1) == (
100.         'русский язык\n'
101.         '============'
102.     )
103. 
104.     # language=ja: ambiguous
105.     env.language = 'ja'
106.     assert heading(env, 'русский язык', 1) == (
107.         'русский язык\n'
108.         '======================='
109.     )

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 00:50:43,020 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The provided context contains unit tests for `prepend_prolog` from `test_util_rst.py`, which is a great start. However, the bug is an integration issue involving `rst_prolog` and the parsing of a domain directive within a heading. To find relevant integration tests that expose this kind of issue, I need to examine tests related to markup parsing and domain directive handling. `tests/test_markup.py` is likely to contain tests for ReST parsing, including headings. `tests/test_domain_py.py` should contain tests for python domain directives like `:mod:`. These files are essential to find test cases that verify the correct parsing of the document structure when a domain directive is present in a heading, which is the core of the reported bug.' query='Please provide the content of `tests/test_markup.py` and `tests/test_domain_py.py`.' extra_requirements='' purpose='These files are needed to find integration tests that check for correct parsing of headings containing domain directives, which is the scenario described in the bug report.'
2025-12-23 00:50:43,021 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the content of `tests/test_markup.py` and `tests/test_domain_py.py`.
2025-12-23 00:50:43,022 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 00:50:43,023 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 00:50:43,024 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 00:50:43,024 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the content of `tests/test_markup.py` and `tests/test_domain_py.py`.
Purpose: These files are needed to find integration tests that check for correct parsing of headings containing domain directives, which is the scenario described in the bug report.
2025-12-23 00:50:45,586 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the contents of the two requested test files, `tests/test_markup.py` and `tests/test_domain_py.py`. These files will be used to find integration tests that check for the correct parsing of headings, which is relevant to the bug report.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/test_domain_py.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2091, 'candidates_token_count': 103, 'total_token_count': 2292, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2091}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 103}], 'thoughts_token_count': 98, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.09220422355874071, 'model_name': 'gemini-2.5-pro'} id='run--98423c1c-eda1-4ed0-a6a5-9999faa98025-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_markup.py'}, 'id': 'fce14b26-bbaa-4abc-b820-326c2071c4af', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_domain_py.py'}, 'id': '3fdc6ded-2a1e-4da1-83f8-53ea3590d497', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2091, 'output_tokens': 103, 'total_tokens': 2292, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 98}}
2025-12-23 00:51:24,177 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the contents of the two requested test files, `tests/test_markup.py` and `tests/test_domain_py.py`. These files will be used to find integration tests that check for the correct parsing of headings, which is relevant to the bug report.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 19443, 'candidates_token_count': 59, 'total_token_count': 23289, 'prompt_tokens_details': [{'modality': 1, 'token_count': 19443}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 59}], 'thoughts_token_count': 3787, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -12.04889743610964, 'model_name': 'gemini-2.5-pro'} id='run--1eb325c7-e88c-4a6b-a804-bfc6d80c4ea6-0' usage_metadata={'input_tokens': 19443, 'output_tokens': 59, 'total_tokens': 23289, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 3787}}
2025-12-23 00:51:24,178 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the content of `tests/test_markup.py` and `tests/test_domain_py.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
These files are needed to find integration tests that check for correct parsing of headings containing domain directives, which is the scenario described in the bug report.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: tests/test_domain_py.py
Line number range: 1 - 500
Content:
1. """Tests the Python Domain"""
2. 
3. import re
4. from unittest.mock import Mock
5. 
6. import docutils.utils
7. import pytest
8. from docutils import nodes
9. 
10. from sphinx import addnodes
11. from sphinx.addnodes import (
12.     desc,
13.     desc_addname,
14.     desc_annotation,
15.     desc_content,
16.     desc_name,
17.     desc_optional,
18.     desc_parameter,
19.     desc_parameterlist,
20.     desc_returns,
21.     desc_sig_keyword,
22.     desc_sig_literal_number,
23.     desc_sig_literal_string,
24.     desc_sig_name,
25.     desc_sig_operator,
26.     desc_sig_punctuation,
27.     desc_sig_space,
28.     desc_signature,
29.     pending_xref,
30. )
31. from sphinx.domains import IndexEntry
32. from sphinx.domains.python import (
33.     PythonDomain,
34.     PythonModuleIndex,
35.     _parse_annotation,
36.     _pseudo_parse_arglist,
37.     py_sig_re,
38. )
39. from sphinx.testing import restructuredtext
40. from sphinx.testing.util import assert_node
41. from sphinx.writers.text import STDINDENT
42. 
43. 
44. def parse(sig):
45.     m = py_sig_re.match(sig)
46.     if m is None:
47.         raise ValueError
48.     name_prefix, name, arglist, retann = m.groups()
49.     signode = addnodes.desc_signature(sig, '')
50.     _pseudo_parse_arglist(signode, arglist)
51.     return signode.astext()
52. 
53. 
54. def test_function_signatures():
55.     rv = parse('func(a=1) -> int object')
56.     assert rv == '(a=1)'
57. 
58.     rv = parse('func(a=1, [b=None])')
59.     assert rv == '(a=1, [b=None])'
60. 
61.     rv = parse('func(a=1[, b=None])')
62.     assert rv == '(a=1, [b=None])'
63. 
64.     rv = parse("compile(source : string, filename, symbol='file')")
65.     assert rv == "(source : string, filename, symbol='file')"
66. 
67.     rv = parse('func(a=[], [b=None])')
68.     assert rv == '(a=[], [b=None])'
69. 
70.     rv = parse('func(a=[][, b=None])')
71.     assert rv == '(a=[], [b=None])'
72. 
73. 
74. @pytest.mark.sphinx('dummy', testroot='domain-py')
75. def test_domain_py_xrefs(app, status, warning):
76.     """Domain objects have correct prefixes when looking up xrefs"""
77.     app.builder.build_all()
78. 
79.     def assert_refnode(node, module_name, class_name, target, reftype=None,
80.                        domain='py'):
81.         attributes = {
82.             'refdomain': domain,
83.             'reftarget': target,
84.         }
85.         if reftype is not None:
86.             attributes['reftype'] = reftype
87.         if module_name is not False:
88.             attributes['py:module'] = module_name
89.         if class_name is not False:
90.             attributes['py:class'] = class_name
91.         assert_node(node, **attributes)
92. 
93.     doctree = app.env.get_doctree('roles')
94.     refnodes = list(doctree.findall(pending_xref))
95.     assert_refnode(refnodes[0], None, None, 'TopLevel', 'class')
96.     assert_refnode(refnodes[1], None, None, 'top_level', 'meth')
97.     assert_refnode(refnodes[2], None, 'NestedParentA', 'child_1', 'meth')
98.     assert_refnode(refnodes[3], None, 'NestedParentA', 'NestedChildA.subchild_2', 'meth')
99.     assert_refnode(refnodes[4], None, 'NestedParentA', 'child_2', 'meth')
100.     assert_refnode(refnodes[5], False, 'NestedParentA', 'any_child', domain='')
101.     assert_refnode(refnodes[6], None, 'NestedParentA', 'NestedChildA', 'class')
102.     assert_refnode(refnodes[7], None, 'NestedParentA.NestedChildA', 'subchild_2', 'meth')
103.     assert_refnode(refnodes[8], None, 'NestedParentA.NestedChildA',
104.                    'NestedParentA.child_1', 'meth')
105.     assert_refnode(refnodes[9], None, 'NestedParentA', 'NestedChildA.subchild_1', 'meth')
106.     assert_refnode(refnodes[10], None, 'NestedParentB', 'child_1', 'meth')
107.     assert_refnode(refnodes[11], None, 'NestedParentB', 'NestedParentB', 'class')
108.     assert_refnode(refnodes[12], None, None, 'NestedParentA.NestedChildA', 'class')
109.     assert len(refnodes) == 13
110. 
111.     doctree = app.env.get_doctree('module')
112.     refnodes = list(doctree.findall(pending_xref))
113.     assert_refnode(refnodes[0], 'module_a.submodule', None,
114.                    'ModTopLevel', 'class')
115.     assert_refnode(refnodes[1], 'module_a.submodule', 'ModTopLevel',
116.                    'mod_child_1', 'meth')
117.     assert_refnode(refnodes[2], 'module_a.submodule', 'ModTopLevel',
118.                    'ModTopLevel.mod_child_1', 'meth')
119.     assert_refnode(refnodes[3], 'module_a.submodule', 'ModTopLevel',
120.                    'mod_child_2', 'meth')
121.     assert_refnode(refnodes[4], 'module_a.submodule', 'ModTopLevel',
122.                    'module_a.submodule.ModTopLevel.mod_child_1', 'meth')
123.     assert_refnode(refnodes[5], 'module_a.submodule', 'ModTopLevel',
124.                    'prop', 'attr')
125.     assert_refnode(refnodes[6], 'module_a.submodule', 'ModTopLevel',
126.                    'prop', 'meth')
127.     assert_refnode(refnodes[7], 'module_b.submodule', None,
128.                    'ModTopLevel', 'class')
129.     assert_refnode(refnodes[8], 'module_b.submodule', 'ModTopLevel',
130.                    'ModNoModule', 'class')
131.     assert_refnode(refnodes[9], False, False, 'int', 'class')
132.     assert_refnode(refnodes[10], False, False, 'tuple', 'class')
133.     assert_refnode(refnodes[11], False, False, 'str', 'class')
134.     assert_refnode(refnodes[12], False, False, 'float', 'class')
135.     assert_refnode(refnodes[13], False, False, 'list', 'class')
136.     assert_refnode(refnodes[14], False, False, 'ModTopLevel', 'class')
137.     assert_refnode(refnodes[15], False, False, 'index', 'doc', domain='std')
138.     assert len(refnodes) == 16
139. 
140.     doctree = app.env.get_doctree('module_option')
141.     refnodes = list(doctree.findall(pending_xref))
142.     print(refnodes)
143.     print(refnodes[0])
144.     print(refnodes[1])
145.     assert_refnode(refnodes[0], 'test.extra', 'B', 'foo', 'meth')
146.     assert_refnode(refnodes[1], 'test.extra', 'B', 'foo', 'meth')
147.     assert len(refnodes) == 2
148. 
149. 
150. @pytest.mark.sphinx('html', testroot='domain-py')
151. def test_domain_py_xrefs_abbreviations(app, status, warning):
152.     app.builder.build_all()
153. 
154.     content = (app.outdir / 'abbr.html').read_text(encoding='utf8')
155.     assert re.search(r'normal: <a .* href="module.html#module_a.submodule.ModTopLevel.'
156.                      r'mod_child_1" .*><.*>module_a.submodule.ModTopLevel.mod_child_1\(\)'
157.                      r'<.*></a>',
158.                      content)
159.     assert re.search(r'relative: <a .* href="module.html#module_a.submodule.ModTopLevel.'
160.                      r'mod_child_1" .*><.*>ModTopLevel.mod_child_1\(\)<.*></a>',
161.                      content)
162.     assert re.search(r'short name: <a .* href="module.html#module_a.submodule.ModTopLevel.'
163.                      r'mod_child_1" .*><.*>mod_child_1\(\)<.*></a>',
164.                      content)
165.     assert re.search(r'relative \+ short name: <a .* href="module.html#module_a.submodule.'
166.                      r'ModTopLevel.mod_child_1" .*><.*>mod_child_1\(\)<.*></a>',
167.                      content)
168.     assert re.search(r'short name \+ relative: <a .* href="module.html#module_a.submodule.'
169.                      r'ModTopLevel.mod_child_1" .*><.*>mod_child_1\(\)<.*></a>',
170.                      content)
171. 
172. 
173. @pytest.mark.sphinx('dummy', testroot='domain-py')
174. def test_domain_py_objects(app, status, warning):
175.     app.builder.build_all()
176. 
177.     modules = app.env.domains['py'].data['modules']
178.     objects = app.env.domains['py'].data['objects']
179. 
180.     assert 'module_a.submodule' in modules
181.     assert 'module_a.submodule' in objects
182.     assert 'module_b.submodule' in modules
183.     assert 'module_b.submodule' in objects
184. 
185.     assert objects['module_a.submodule.ModTopLevel'][2] == 'class'
186.     assert objects['module_a.submodule.ModTopLevel.mod_child_1'][2] == 'method'
187.     assert objects['module_a.submodule.ModTopLevel.mod_child_2'][2] == 'method'
188.     assert 'ModTopLevel.ModNoModule' not in objects
189.     assert objects['ModNoModule'][2] == 'class'
190.     assert objects['module_b.submodule.ModTopLevel'][2] == 'class'
191. 
192.     assert objects['TopLevel'][2] == 'class'
193.     assert objects['top_level'][2] == 'method'
194.     assert objects['NestedParentA'][2] == 'class'
195.     assert objects['NestedParentA.child_1'][2] == 'method'
196.     assert objects['NestedParentA.any_child'][2] == 'method'
197.     assert objects['NestedParentA.NestedChildA'][2] == 'class'
198.     assert objects['NestedParentA.NestedChildA.subchild_1'][2] == 'method'
199.     assert objects['NestedParentA.NestedChildA.subchild_2'][2] == 'method'
200.     assert objects['NestedParentA.child_2'][2] == 'method'
201.     assert objects['NestedParentB'][2] == 'class'
202.     assert objects['NestedParentB.child_1'][2] == 'method'
203. 
204. 
205. @pytest.mark.sphinx('html', testroot='domain-py')
206. def test_resolve_xref_for_properties(app, status, warning):
207.     app.builder.build_all()
208. 
209.     content = (app.outdir / 'module.html').read_text(encoding='utf8')
210.     assert ('Link to <a class="reference internal" href="#module_a.submodule.ModTopLevel.prop"'
211.             ' title="module_a.submodule.ModTopLevel.prop">'
212.             '<code class="xref py py-attr docutils literal notranslate"><span class="pre">'
213.             'prop</span> <span class="pre">attribute</span></code></a>' in content)
214.     assert ('Link to <a class="reference internal" href="#module_a.submodule.ModTopLevel.prop"'
215.             ' title="module_a.submodule.ModTopLevel.prop">'
216.             '<code class="xref py py-meth docutils literal notranslate"><span class="pre">'
217.             'prop</span> <span class="pre">method</span></code></a>' in content)
218.     assert ('Link to <a class="reference internal" href="#module_a.submodule.ModTopLevel.prop"'
219.             ' title="module_a.submodule.ModTopLevel.prop">'
220.             '<code class="xref py py-attr docutils literal notranslate"><span class="pre">'
221.             'prop</span> <span class="pre">attribute</span></code></a>' in content)
222. 
223. 
224. @pytest.mark.sphinx('dummy', testroot='domain-py')
225. def test_domain_py_find_obj(app, status, warning):
226. 
227.     def find_obj(modname, prefix, obj_name, obj_type, searchmode=0):
228.         return app.env.domains['py'].find_obj(
229.             app.env, modname, prefix, obj_name, obj_type, searchmode)
230. 
231.     app.builder.build_all()
232. 
233.     assert (find_obj(None, None, 'NONEXISTANT', 'class') == [])
234.     assert (find_obj(None, None, 'NestedParentA', 'class') ==
235.             [('NestedParentA', ('roles', 'NestedParentA', 'class', False))])
236.     assert (find_obj(None, None, 'NestedParentA.NestedChildA', 'class') ==
237.             [('NestedParentA.NestedChildA',
238.               ('roles', 'NestedParentA.NestedChildA', 'class', False))])
239.     assert (find_obj(None, 'NestedParentA', 'NestedChildA', 'class') ==
240.             [('NestedParentA.NestedChildA',
241.               ('roles', 'NestedParentA.NestedChildA', 'class', False))])
242.     assert (find_obj(None, None, 'NestedParentA.NestedChildA.subchild_1', 'meth') ==
243.             [('NestedParentA.NestedChildA.subchild_1',
244.               ('roles', 'NestedParentA.NestedChildA.subchild_1', 'method', False))])
245.     assert (find_obj(None, 'NestedParentA', 'NestedChildA.subchild_1', 'meth') ==
246.             [('NestedParentA.NestedChildA.subchild_1',
247.               ('roles', 'NestedParentA.NestedChildA.subchild_1', 'method', False))])
248.     assert (find_obj(None, 'NestedParentA.NestedChildA', 'subchild_1', 'meth') ==
249.             [('NestedParentA.NestedChildA.subchild_1',
250.               ('roles', 'NestedParentA.NestedChildA.subchild_1', 'method', False))])
251. 
252. 
253. @pytest.mark.sphinx('html', testroot='domain-py', freshenv=True)
254. def test_domain_py_canonical(app, status, warning):
255.     app.builder.build_all()
256. 
257.     content = (app.outdir / 'canonical.html').read_text(encoding='utf8')
258.     assert ('<a class="reference internal" href="#canonical.Foo" title="canonical.Foo">'
259.             '<code class="xref py py-class docutils literal notranslate">'
260.             '<span class="pre">Foo</span></code></a>' in content)
261.     assert warning.getvalue() == ''
262. 
263. 
264. def test_get_full_qualified_name():
265.     env = Mock(domaindata={})
266.     domain = PythonDomain(env)
267. 
268.     # non-python references
269.     node = nodes.reference()
270.     assert domain.get_full_qualified_name(node) is None
271. 
272.     # simple reference
273.     node = nodes.reference(reftarget='func')
274.     assert domain.get_full_qualified_name(node) == 'func'
275. 
276.     # with py:module context
277.     kwargs = {'py:module': 'module1'}
278.     node = nodes.reference(reftarget='func', **kwargs)
279.     assert domain.get_full_qualified_name(node) == 'module1.func'
280. 
281.     # with py:class context
282.     kwargs = {'py:class': 'Class'}
283.     node = nodes.reference(reftarget='func', **kwargs)
284.     assert domain.get_full_qualified_name(node) == 'Class.func'
285. 
286.     # with both py:module and py:class context
287.     kwargs = {'py:module': 'module1', 'py:class': 'Class'}
288.     node = nodes.reference(reftarget='func', **kwargs)
289.     assert domain.get_full_qualified_name(node) == 'module1.Class.func'
290. 
291. 
292. def test_parse_annotation(app):
293.     doctree = _parse_annotation("int", app.env)
294.     assert_node(doctree, ([pending_xref, "int"],))
295.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="class", reftarget="int")
296. 
297.     doctree = _parse_annotation("List[int]", app.env)
298.     assert_node(doctree, ([pending_xref, "List"],
299.                           [desc_sig_punctuation, "["],
300.                           [pending_xref, "int"],
301.                           [desc_sig_punctuation, "]"]))
302. 
303.     doctree = _parse_annotation("Tuple[int, int]", app.env)
304.     assert_node(doctree, ([pending_xref, "Tuple"],
305.                           [desc_sig_punctuation, "["],
306.                           [pending_xref, "int"],
307.                           [desc_sig_punctuation, ","],
308.                           desc_sig_space,
309.                           [pending_xref, "int"],
310.                           [desc_sig_punctuation, "]"]))
311. 
312.     doctree = _parse_annotation("Tuple[()]", app.env)
313.     assert_node(doctree, ([pending_xref, "Tuple"],
314.                           [desc_sig_punctuation, "["],
315.                           [desc_sig_punctuation, "("],
316.                           [desc_sig_punctuation, ")"],
317.                           [desc_sig_punctuation, "]"]))
318. 
319.     doctree = _parse_annotation("Tuple[int, ...]", app.env)
320.     assert_node(doctree, ([pending_xref, "Tuple"],
321.                           [desc_sig_punctuation, "["],
322.                           [pending_xref, "int"],
323.                           [desc_sig_punctuation, ","],
324.                           desc_sig_space,
325.                           [desc_sig_punctuation, "..."],
326.                           [desc_sig_punctuation, "]"]))
327. 
328.     doctree = _parse_annotation("Callable[[int, int], int]", app.env)
329.     assert_node(doctree, ([pending_xref, "Callable"],
330.                           [desc_sig_punctuation, "["],
331.                           [desc_sig_punctuation, "["],
332.                           [pending_xref, "int"],
333.                           [desc_sig_punctuation, ","],
334.                           desc_sig_space,
335.                           [pending_xref, "int"],
336.                           [desc_sig_punctuation, "]"],
337.                           [desc_sig_punctuation, ","],
338.                           desc_sig_space,
339.                           [pending_xref, "int"],
340.                           [desc_sig_punctuation, "]"]))
341. 
342.     doctree = _parse_annotation("Callable[[], int]", app.env)
343.     assert_node(doctree, ([pending_xref, "Callable"],
344.                           [desc_sig_punctuation, "["],
345.                           [desc_sig_punctuation, "["],
346.                           [desc_sig_punctuation, "]"],
347.                           [desc_sig_punctuation, ","],
348.                           desc_sig_space,
349.                           [pending_xref, "int"],
350.                           [desc_sig_punctuation, "]"]))
351. 
352.     doctree = _parse_annotation("List[None]", app.env)
353.     assert_node(doctree, ([pending_xref, "List"],
354.                           [desc_sig_punctuation, "["],
355.                           [pending_xref, "None"],
356.                           [desc_sig_punctuation, "]"]))
357. 
358.     # None type makes an object-reference (not a class reference)
359.     doctree = _parse_annotation("None", app.env)
360.     assert_node(doctree, ([pending_xref, "None"],))
361.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="obj", reftarget="None")
362. 
363.     # Literal type makes an object-reference (not a class reference)
364.     doctree = _parse_annotation("typing.Literal['a', 'b']", app.env)
365.     assert_node(doctree, ([pending_xref, "Literal"],
366.                           [desc_sig_punctuation, "["],
367.                           [desc_sig_literal_string, "'a'"],
368.                           [desc_sig_punctuation, ","],
369.                           desc_sig_space,
370.                           [desc_sig_literal_string, "'b'"],
371.                           [desc_sig_punctuation, "]"]))
372.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="obj", reftarget="typing.Literal")
373. 
374. 
375. def test_parse_annotation_suppress(app):
376.     doctree = _parse_annotation("~typing.Dict[str, str]", app.env)
377.     assert_node(doctree, ([pending_xref, "Dict"],
378.                           [desc_sig_punctuation, "["],
379.                           [pending_xref, "str"],
380.                           [desc_sig_punctuation, ","],
381.                           desc_sig_space,
382.                           [pending_xref, "str"],
383.                           [desc_sig_punctuation, "]"]))
384.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="obj", reftarget="typing.Dict")
385. 
386. 
387. def test_parse_annotation_Literal(app):
388.     doctree = _parse_annotation("Literal[True, False]", app.env)
389.     assert_node(doctree, ([pending_xref, "Literal"],
390.                           [desc_sig_punctuation, "["],
391.                           [desc_sig_keyword, "True"],
392.                           [desc_sig_punctuation, ","],
393.                           desc_sig_space,
394.                           [desc_sig_keyword, "False"],
395.                           [desc_sig_punctuation, "]"]))
396. 
397.     doctree = _parse_annotation("typing.Literal[0, 1, 'abc']", app.env)
398.     assert_node(doctree, ([pending_xref, "Literal"],
399.                           [desc_sig_punctuation, "["],
400.                           [desc_sig_literal_number, "0"],
401.                           [desc_sig_punctuation, ","],
402.                           desc_sig_space,
403.                           [desc_sig_literal_number, "1"],
404.                           [desc_sig_punctuation, ","],
405.                           desc_sig_space,
406.                           [desc_sig_literal_string, "'abc'"],
407.                           [desc_sig_punctuation, "]"]))
408. 
409. 
410. def test_pyfunction_signature(app):
411.     text = ".. py:function:: hello(name: str) -> str"
412.     doctree = restructuredtext.parse(app, text)
413.     assert_node(doctree, (addnodes.index,
414.                           [desc, ([desc_signature, ([desc_name, "hello"],
415.                                                     desc_parameterlist,
416.                                                     [desc_returns, pending_xref, "str"])],
417.                                   desc_content)]))
418.     assert_node(doctree[1], addnodes.desc, desctype="function",
419.                 domain="py", objtype="function", noindex=False)
420.     assert_node(doctree[1][0][1],
421.                 [desc_parameterlist, desc_parameter, ([desc_sig_name, "name"],
422.                                                       [desc_sig_punctuation, ":"],
423.                                                       desc_sig_space,
424.                                                       [nodes.inline, pending_xref, "str"])])
425. 
426. 
427. def test_pyfunction_signature_full(app):
428.     text = (".. py:function:: hello(a: str, b = 1, *args: str, "
429.             "c: bool = True, d: tuple = (1, 2), **kwargs: str) -> str")
430.     doctree = restructuredtext.parse(app, text)
431.     assert_node(doctree, (addnodes.index,
432.                           [desc, ([desc_signature, ([desc_name, "hello"],
433.                                                     desc_parameterlist,
434.                                                     [desc_returns, pending_xref, "str"])],
435.                                   desc_content)]))
436.     assert_node(doctree[1], addnodes.desc, desctype="function",
437.                 domain="py", objtype="function", noindex=False)
438.     assert_node(doctree[1][0][1],
439.                 [desc_parameterlist, ([desc_parameter, ([desc_sig_name, "a"],
440.                                                         [desc_sig_punctuation, ":"],
441.                                                         desc_sig_space,
442.                                                         [desc_sig_name, pending_xref, "str"])],
443.                                       [desc_parameter, ([desc_sig_name, "b"],
444.                                                         [desc_sig_operator, "="],
445.                                                         [nodes.inline, "1"])],
446.                                       [desc_parameter, ([desc_sig_operator, "*"],
447.                                                         [desc_sig_name, "args"],
448.                                                         [desc_sig_punctuation, ":"],
449.                                                         desc_sig_space,
450.                                                         [desc_sig_name, pending_xref, "str"])],
451.                                       [desc_parameter, ([desc_sig_name, "c"],
452.                                                         [desc_sig_punctuation, ":"],
453.                                                         desc_sig_space,
454.                                                         [desc_sig_name, pending_xref, "bool"],
455.                                                         desc_sig_space,
456.                                                         [desc_sig_operator, "="],
457.                                                         desc_sig_space,
458.                                                         [nodes.inline, "True"])],
459.                                       [desc_parameter, ([desc_sig_name, "d"],
460.                                                         [desc_sig_punctuation, ":"],
461.                                                         desc_sig_space,
462.                                                         [desc_sig_name, pending_xref, "tuple"],
463.                                                         desc_sig_space,
464.                                                         [desc_sig_operator, "="],
465.                                                         desc_sig_space,
466.                                                         [nodes.inline, "(1, 2)"])],
467.                                       [desc_parameter, ([desc_sig_operator, "**"],
468.                                                         [desc_sig_name, "kwargs"],
469.                                                         [desc_sig_punctuation, ":"],
470.                                                         desc_sig_space,
471.                                                         [desc_sig_name, pending_xref, "str"])])])
472.     # case: separator at head
473.     text = ".. py:function:: hello(*, a)"
474.     doctree = restructuredtext.parse(app, text)
475.     assert_node(doctree[1][0][1],
476.                 [desc_parameterlist, ([desc_parameter, nodes.inline, "*"],
477.                                       [desc_parameter, desc_sig_name, "a"])])
478. 
479.     # case: separator in the middle
480.     text = ".. py:function:: hello(a, /, b, *, c)"
481.     doctree = restructuredtext.parse(app, text)
482.     assert_node(doctree[1][0][1],
483.                 [desc_parameterlist, ([desc_parameter, desc_sig_name, "a"],
484.                                       [desc_parameter, desc_sig_operator, "/"],
485.                                       [desc_parameter, desc_sig_name, "b"],
486.                                       [desc_parameter, desc_sig_operator, "*"],
487.                                       [desc_parameter, desc_sig_name, "c"])])
488. 
489.     # case: separator in the middle (2)
490.     text = ".. py:function:: hello(a, /, *, b)"
491.     doctree = restructuredtext.parse(app, text)
492.     assert_node(doctree[1][0][1],
493.                 [desc_parameterlist, ([desc_parameter, desc_sig_name, "a"],
494.                                       [desc_parameter, desc_sig_operator, "/"],
495.                                       [desc_parameter, desc_sig_operator, "*"],
496.                                       [desc_parameter, desc_sig_name, "b"])])
497. 
498.     # case: separator at tail
499.     text = ".. py:function:: hello(a, /)"
500.     doctree = restructuredtext.parse(app, text)


File: tests/test_markup.py
Line number range: 1 - 500
Content:
1. """Test various Sphinx-specific markup extensions."""
2. 
3. import re
4. import warnings
5. 
6. import pytest
7. from docutils import frontend, nodes, utils
8. from docutils.parsers.rst import Parser as RstParser
9. 
10. from sphinx import addnodes
11. from sphinx.builders.html.transforms import KeyboardTransform
12. from sphinx.builders.latex import LaTeXBuilder
13. from sphinx.environment import default_settings
14. from sphinx.roles import XRefRole
15. from sphinx.testing.util import Struct, assert_node
16. from sphinx.transforms import SphinxSmartQuotes
17. from sphinx.util import texescape
18. from sphinx.util.docutils import sphinx_domains
19. from sphinx.writers.html import HTML5Translator, HTMLWriter
20. from sphinx.writers.latex import LaTeXTranslator, LaTeXWriter
21. 
22. 
23. @pytest.fixture()
24. def settings(app):
25.     texescape.init()  # otherwise done by the latex builder
26.     with warnings.catch_warnings():
27.         warnings.filterwarnings('ignore', category=DeprecationWarning)
28.         # DeprecationWarning: The frontend.OptionParser class will be replaced
29.         # by a subclass of argparse.ArgumentParser in Docutils 0.21 or later.
30.         optparser = frontend.OptionParser(
31.             components=(RstParser, HTMLWriter, LaTeXWriter),
32.             defaults=default_settings)
33.     settings = optparser.get_default_values()
34.     settings.smart_quotes = True
35.     settings.env = app.builder.env
36.     settings.env.temp_data['docname'] = 'dummy'
37.     settings.contentsname = 'dummy'
38.     domain_context = sphinx_domains(settings.env)
39.     domain_context.enable()
40.     yield settings
41.     domain_context.disable()
42. 
43. 
44. @pytest.fixture()
45. def new_document(settings):
46.     def create():
47.         document = utils.new_document('test data', settings)
48.         document['file'] = 'dummy'
49.         return document
50. 
51.     return create
52. 
53. 
54. @pytest.fixture()
55. def inliner(new_document):
56.     document = new_document()
57.     document.reporter.get_source_and_line = lambda line=1: ('dummy.rst', line)
58.     return Struct(document=document, reporter=document.reporter)
59. 
60. 
61. @pytest.fixture()
62. def parse(new_document):
63.     def parse_(rst):
64.         document = new_document()
65.         parser = RstParser()
66.         parser.parse(rst, document)
67.         SphinxSmartQuotes(document, startnode=None).apply()
68.         for msg in list(document.findall(nodes.system_message)):
69.             if msg['level'] == 1:
70.                 msg.replace_self([])
71.         return document
72.     return parse_
73. 
74. 
75. # since we're not resolving the markup afterwards, these nodes may remain
76. class ForgivingTranslator:
77.     def visit_pending_xref(self, node):
78.         pass
79. 
80.     def depart_pending_xref(self, node):
81.         pass
82. 
83. 
84. class ForgivingHTMLTranslator(HTML5Translator, ForgivingTranslator):
85.     pass
86. 
87. 
88. class ForgivingLaTeXTranslator(LaTeXTranslator, ForgivingTranslator):
89.     pass
90. 
91. 
92. @pytest.fixture()
93. def verify_re_html(app, parse):
94.     def verify(rst, html_expected):
95.         document = parse(rst)
96.         KeyboardTransform(document).apply()
97.         html_translator = ForgivingHTMLTranslator(document, app.builder)
98.         document.walkabout(html_translator)
99.         html_translated = ''.join(html_translator.fragment).strip()
100.         assert re.match(html_expected, html_translated), 'from ' + rst
101.     return verify
102. 
103. 
104. @pytest.fixture()
105. def verify_re_latex(app, parse):
106.     def verify(rst, latex_expected):
107.         document = parse(rst)
108.         app.builder = LaTeXBuilder(app, app.env)
109.         app.builder.init()
110.         theme = app.builder.themes.get('manual')
111.         latex_translator = ForgivingLaTeXTranslator(document, app.builder, theme)
112.         latex_translator.first_document = -1  # don't write \begin{document}
113.         document.walkabout(latex_translator)
114.         latex_translated = ''.join(latex_translator.body).strip()
115.         assert re.match(latex_expected, latex_translated), 'from ' + repr(rst)
116.     return verify
117. 
118. 
119. @pytest.fixture()
120. def verify_re(verify_re_html, verify_re_latex):
121.     def verify_re_(rst, html_expected, latex_expected):
122.         if html_expected:
123.             verify_re_html(rst, html_expected)
124.         if latex_expected:
125.             verify_re_latex(rst, latex_expected)
126.     return verify_re_
127. 
128. 
129. @pytest.fixture()
130. def verify(verify_re_html, verify_re_latex):
131.     def verify_(rst, html_expected, latex_expected):
132.         if html_expected:
133.             verify_re_html(rst, re.escape(html_expected) + '$')
134.         if latex_expected:
135.             verify_re_latex(rst, re.escape(latex_expected) + '$')
136.     return verify_
137. 
138. 
139. @pytest.fixture()
140. def get_verifier(verify, verify_re):
141.     v = {
142.         'verify': verify,
143.         'verify_re': verify_re,
144.     }
145. 
146.     def get(name):
147.         return v[name]
148.     return get
149. 
150. 
151. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
152.     (
153.         # pep role
154.         'verify',
155.         ':pep:`8`',
156.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
157.          'href="https://peps.python.org/pep-0008/"><strong>PEP 8</strong></a></p>'),
158.         ('\\sphinxAtStartPar\n'
159.          '\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
160.          '!PEP 8@\\spxentry{PEP 8}}\\sphinxhref{https://peps.python.org/pep-0008/}'
161.          '{\\sphinxstylestrong{PEP 8}}'),
162.     ),
163.     (
164.         # pep role with anchor
165.         'verify',
166.         ':pep:`8#id1`',
167.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
168.          'href="https://peps.python.org/pep-0008/#id1">'
169.          '<strong>PEP 8#id1</strong></a></p>'),
170.         ('\\sphinxAtStartPar\n'
171.          '\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
172.          '!PEP 8\\#id1@\\spxentry{PEP 8\\#id1}}\\sphinxhref'
173.          '{https://peps.python.org/pep-0008/\\#id1}'
174.          '{\\sphinxstylestrong{PEP 8\\#id1}}'),
175.     ),
176.     (
177.         # rfc role
178.         'verify',
179.         ':rfc:`2324`',
180.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
181.          'href="https://datatracker.ietf.org/doc/html/rfc2324.html"><strong>RFC 2324</strong></a></p>'),
182.         ('\\sphinxAtStartPar\n'
183.          '\\index{RFC@\\spxentry{RFC}!RFC 2324@\\spxentry{RFC 2324}}'
184.          '\\sphinxhref{https://datatracker.ietf.org/doc/html/rfc2324.html}'
185.          '{\\sphinxstylestrong{RFC 2324}}'),
186.     ),
187.     (
188.         # rfc role with anchor
189.         'verify',
190.         ':rfc:`2324#id1`',
191.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
192.          'href="https://datatracker.ietf.org/doc/html/rfc2324.html#id1">'
193.          '<strong>RFC 2324#id1</strong></a></p>'),
194.         ('\\sphinxAtStartPar\n'
195.          '\\index{RFC@\\spxentry{RFC}!RFC 2324\\#id1@\\spxentry{RFC 2324\\#id1}}'
196.          '\\sphinxhref{https://datatracker.ietf.org/doc/html/rfc2324.html\\#id1}'
197.          '{\\sphinxstylestrong{RFC 2324\\#id1}}'),
198.     ),
199.     (
200.         # correct interpretation of code with whitespace
201.         'verify_re',
202.         '``code   sample``',
203.         ('<p><code class="(samp )?docutils literal notranslate"><span class="pre">'
204.          'code</span>&#160;&#160; <span class="pre">sample</span></code></p>'),
205.         r'\\sphinxAtStartPar\n\\sphinxcode{\\sphinxupquote{code   sample}}',
206.     ),
207.     (
208.         # interpolation of arrows in menuselection
209.         'verify',
210.         ':menuselection:`a --> b`',
211.         ('<p><span class="menuselection">a \N{TRIANGULAR BULLET} b</span></p>'),
212.         '\\sphinxAtStartPar\n\\sphinxmenuselection{a \\(\\rightarrow\\) b}',
213.     ),
214.     (
215.         # interpolation of ampersands in menuselection
216.         'verify',
217.         ':menuselection:`&Foo -&&- &Bar`',
218.         ('<p><span class="menuselection"><span class="accelerator">F</span>oo '
219.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
220.         ('\\sphinxAtStartPar\n'
221.          r'\sphinxmenuselection{\sphinxaccelerator{F}oo \sphinxhyphen{}'
222.          r'\&\sphinxhyphen{} \sphinxaccelerator{B}ar}'),
223.     ),
224.     (
225.         # interpolation of ampersands in guilabel
226.         'verify',
227.         ':guilabel:`&Foo -&&- &Bar`',
228.         ('<p><span class="guilabel"><span class="accelerator">F</span>oo '
229.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
230.         ('\\sphinxAtStartPar\n'
231.          r'\sphinxguilabel{\sphinxaccelerator{F}oo \sphinxhyphen{}\&\sphinxhyphen{} \sphinxaccelerator{B}ar}'),
232.     ),
233.     (
234.         # no ampersands in guilabel
235.         'verify',
236.         ':guilabel:`Foo`',
237.         '<p><span class="guilabel">Foo</span></p>',
238.         '\\sphinxAtStartPar\n\\sphinxguilabel{Foo}',
239.     ),
240.     (
241.         # kbd role
242.         'verify',
243.         ':kbd:`space`',
244.         '<p><kbd class="kbd docutils literal notranslate">space</kbd></p>',
245.         '\\sphinxAtStartPar\n\\sphinxkeyboard{\\sphinxupquote{space}}',
246.     ),
247.     (
248.         # kbd role
249.         'verify',
250.         ':kbd:`Control+X`',
251.         ('<p><kbd class="kbd compound docutils literal notranslate">'
252.          '<kbd class="kbd docutils literal notranslate">Control</kbd>'
253.          '+'
254.          '<kbd class="kbd docutils literal notranslate">X</kbd>'
255.          '</kbd></p>'),
256.         '\\sphinxAtStartPar\n\\sphinxkeyboard{\\sphinxupquote{Control+X}}',
257.     ),
258.     (
259.         # kbd role
260.         'verify',
261.         ':kbd:`Alt+^`',
262.         ('<p><kbd class="kbd compound docutils literal notranslate">'
263.          '<kbd class="kbd docutils literal notranslate">Alt</kbd>'
264.          '+'
265.          '<kbd class="kbd docutils literal notranslate">^</kbd>'
266.          '</kbd></p>'),
267.         ('\\sphinxAtStartPar\n'
268.          '\\sphinxkeyboard{\\sphinxupquote{Alt+\\textasciicircum{}}}'),
269.     ),
270.     (
271.         # kbd role
272.         'verify',
273.         ':kbd:`M-x  M-s`',
274.         ('<p><kbd class="kbd compound docutils literal notranslate">'
275.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
276.          '-'
277.          '<kbd class="kbd docutils literal notranslate">x</kbd>'
278.          '  '
279.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
280.          '-'
281.          '<kbd class="kbd docutils literal notranslate">s</kbd>'
282.          '</kbd></p>'),
283.         ('\\sphinxAtStartPar\n'
284.          '\\sphinxkeyboard{\\sphinxupquote{M\\sphinxhyphen{}x  M\\sphinxhyphen{}s}}'),
285.     ),
286.     (
287.         # kbd role
288.         'verify',
289.         ':kbd:`-`',
290.         '<p><kbd class="kbd docutils literal notranslate">-</kbd></p>',
291.         ('\\sphinxAtStartPar\n'
292.          '\\sphinxkeyboard{\\sphinxupquote{\\sphinxhyphen{}}}'),
293.     ),
294.     (
295.         # kbd role
296.         'verify',
297.         ':kbd:`Caps Lock`',
298.         '<p><kbd class="kbd docutils literal notranslate">Caps Lock</kbd></p>',
299.         ('\\sphinxAtStartPar\n'
300.          '\\sphinxkeyboard{\\sphinxupquote{Caps Lock}}'),
301.     ),
302.     (
303.         # kbd role
304.         'verify',
305.         ':kbd:`sys   rq`',
306.         '<p><kbd class="kbd docutils literal notranslate">sys   rq</kbd></p>',
307.         ('\\sphinxAtStartPar\n'
308.          '\\sphinxkeyboard{\\sphinxupquote{sys   rq}}'),
309.     ),
310.     (
311.         # non-interpolation of dashes in option role
312.         'verify_re',
313.         ':option:`--with-option`',
314.         ('<p><code( class="xref std std-option docutils literal notranslate")?>'
315.          '<span class="pre">--with-option</span></code></p>$'),
316.         (r'\\sphinxAtStartPar\n'
317.          r'\\sphinxcode{\\sphinxupquote{\\sphinxhyphen{}\\sphinxhyphen{}with\\sphinxhyphen{}option}}$'),
318.     ),
319.     (
320.         # verify smarty-pants quotes
321.         'verify',
322.         '"John"',
323.         '<p>“John”</p>',
324.         "\\sphinxAtStartPar\n“John”",
325.     ),
326.     (
327.         # ... but not in literal text
328.         'verify',
329.         '``"John"``',
330.         ('<p><code class="docutils literal notranslate"><span class="pre">'
331.          '&quot;John&quot;</span></code></p>'),
332.         '\\sphinxAtStartPar\n\\sphinxcode{\\sphinxupquote{"John"}}',
333.     ),
334.     (
335.         # verify classes for inline roles
336.         'verify',
337.         ':manpage:`mp(1)`',
338.         '<p><em class="manpage">mp(1)</em></p>',
339.         '\\sphinxAtStartPar\n\\sphinxstyleliteralemphasis{\\sphinxupquote{mp(1)}}',
340.     ),
341.     (
342.         # correct escaping in normal mode
343.         'verify',
344.         'Γ\\\\∞$',
345.         None,
346.         '\\sphinxAtStartPar\nΓ\\textbackslash{}\\(\\infty\\)\\$',
347.     ),
348.     (
349.         # in verbatim code fragments
350.         'verify',
351.         '::\n\n @Γ\\∞${}',
352.         None,
353.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
354.          '@Γ\\PYGZbs{}\\(\\infty\\)\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
355.          '\\end{sphinxVerbatim}'),
356.     ),
357.     (
358.         # in URIs
359.         'verify_re',
360.         '`test <https://www.google.com/~me/>`_',
361.         None,
362.         r'\\sphinxAtStartPar\n\\sphinxhref{https://www.google.com/~me/}{test}.*',
363.     ),
364.     (
365.         # description list: simple
366.         'verify',
367.         'term\n    description',
368.         '<dl class="simple">\n<dt>term</dt><dd><p>description</p>\n</dd>\n</dl>',
369.         None,
370.     ),
371.     (
372.         # description list: with classifiers
373.         'verify',
374.         'term : class1 : class2\n    description',
375.         ('<dl class="simple">\n<dt>term<span class="classifier">class1</span>'
376.          '<span class="classifier">class2</span></dt><dd><p>description</p>\n</dd>\n</dl>'),
377.         None,
378.     ),
379.     (
380.         # glossary (description list): multiple terms
381.         'verify',
382.         '.. glossary::\n\n   term1\n   term2\n       description',
383.         ('<dl class="simple glossary">\n'
384.          '<dt id="term-term1">term1<a class="headerlink" href="#term-term1"'
385.          ' title="Permalink to this term">¶</a></dt>'
386.          '<dt id="term-term2">term2<a class="headerlink" href="#term-term2"'
387.          ' title="Permalink to this term">¶</a></dt>'
388.          '<dd><p>description</p>\n</dd>\n</dl>'),
389.         None,
390.     ),
391. ])
392. def test_inline(get_verifier, type, rst, html_expected, latex_expected):
393.     verifier = get_verifier(type)
394.     verifier(rst, html_expected, latex_expected)
395. 
396. 
397. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
398.     (
399.         'verify',
400.         r'4 backslashes \\\\',
401.         r'<p>4 backslashes \\</p>',
402.         None,
403.     ),
404. ])
405. def test_inline_docutils16(get_verifier, type, rst, html_expected, latex_expected):
406.     verifier = get_verifier(type)
407.     verifier(rst, html_expected, latex_expected)
408. 
409. 
410. @pytest.mark.sphinx(confoverrides={'latex_engine': 'xelatex'})
411. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
412.     (
413.         # in verbatim code fragments
414.         'verify',
415.         '::\n\n @Γ\\∞${}',
416.         None,
417.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
418.          '@Γ\\PYGZbs{}∞\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
419.          '\\end{sphinxVerbatim}'),
420.     ),
421. ])
422. def test_inline_for_unicode_latex_engine(get_verifier, type, rst,
423.                                          html_expected, latex_expected):
424.     verifier = get_verifier(type)
425.     verifier(rst, html_expected, latex_expected)
426. 
427. 
428. def test_samp_role(parse):
429.     # no braces
430.     text = ':samp:`a{b}c`'
431.     doctree = parse(text)
432.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
433.                                                               [nodes.emphasis, "b"],
434.                                                               "c")])
435.     # nested braces
436.     text = ':samp:`a{{b}}c`'
437.     doctree = parse(text)
438.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
439.                                                               [nodes.emphasis, "{b"],
440.                                                               "}c")])
441. 
442.     # half-opened braces
443.     text = ':samp:`a{bc`'
444.     doctree = parse(text)
445.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{bc"])
446. 
447.     # escaped braces
448.     text = ':samp:`a\\\\{b}c`'
449.     doctree = parse(text)
450.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{b}c"])
451. 
452.     # no braces (whitespaces are keeped as is)
453.     text = ':samp:`code   sample`'
454.     doctree = parse(text)
455.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "code   sample"])
456. 
457. 
458. def test_download_role(parse):
459.     # implicit
460.     text = ':download:`sphinx.rst`'
461.     doctree = parse(text)
462.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
463.                              nodes.literal, "sphinx.rst"])
464.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
465.                 refexplicit=False, reftarget='sphinx.rst', refwarn=False)
466.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
467. 
468.     # explicit
469.     text = ':download:`reftitle <sphinx.rst>`'
470.     doctree = parse(text)
471.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
472.                              nodes.literal, "reftitle"])
473.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
474.                 refexplicit=True, reftarget='sphinx.rst', refwarn=False)
475.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
476. 
477. 
478. def test_XRefRole(inliner):
479.     role = XRefRole()
480. 
481.     # implicit
482.     doctrees, errors = role('ref', 'rawtext', 'text', 5, inliner, {}, [])
483.     assert len(doctrees) == 1
484.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text'])
485.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
486.                 refexplicit=False, refwarn=False)
487.     assert errors == []
488. 
489.     # explicit
490.     doctrees, errors = role('ref', 'rawtext', 'title <target>', 5, inliner, {}, [])
491.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'title'])
492.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='target',
493.                 refexplicit=True, refwarn=False)
494. 
495.     # bang
496.     doctrees, errors = role('ref', 'rawtext', '!title <target>', 5, inliner, {}, [])
497.     assert_node(doctrees[0], [nodes.literal, 'title <target>'])
498. 
499.     # refdomain
500.     doctrees, errors = role('test:doc', 'rawtext', 'text', 5, inliner, {}, [])

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 00:51:31,988 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the content of `tests/test_domain_py.py`.\n2. Extended relevance:\n   - Providing the full content of the requested file is necessary to satisfy the user's query.", relative_path='tests/test_domain_py.py', start_line=1, end_line=500), ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the content of `tests/test_markup.py`.\n2. Extended relevance:\n   - Providing the full content of the requested file is necessary to satisfy the user's query.", relative_path='tests/test_markup.py', start_line=1, end_line=500)]
2025-12-23 00:51:31,991 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 2 contexts to memory for query: Please provide the content of `tests/test_markup.py` and `tests/test_domain_py.py`.
2025-12-23 00:51:31,991 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 00:51:31,991 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 00:51:31,991 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 2 new contexts to 4 existing contexts
2025-12-23 00:51:31,992 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 6 total contexts (removed 0 duplicates)
2025-12-23 00:51:31,992 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug-report.yml
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── dependabot.yml
|   └── workflows
|       ├── builddoc.yml
|       ├── coverage.yml
|       ├── create-release.yml
|       ├── latex.yml
|       ├── lint.yml
|       ├── lock.yml
|       ├── main.yml
|       ├── nodejs.yml
|       └── transifex.yml
├── .readthedocs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   ├── themes
|   |   |   └── fullsize
|   |   └── tutorial
|   ├── _templates
|   |   └── contents.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── authors.rst
|   ├── changes.rst
|   ├── conf.py
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── templating.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── autodoc_ext.rst
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── autodoc_intenum.py
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── index.rst
|   ├── internals
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── support.rst
|   ├── tutorial
|   |   ├── automatic-doc-generation.rst
|   |   ├── deploying.rst
|   |   ├── describing-code.rst
|   |   ├── end.rst
|   |   ├── first-steps.rst
|   |   ├── getting-started.rst
|   |   ├── index.rst
|   |   ├── more-sphinx-customization.rst
|   |   └── narrative-documentation.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── changes.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── preserve_defaults.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   └── docstring.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_GB
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── is
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── yue
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_TW
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW.Big5
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── searchfield.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── searchtools.js
|   |   |       └── sphinx_highlight.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── console.py
|   |   ├── display.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── exceptions.py
|   |   ├── fileutil.py
|   |   ├── http_date.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   ├── documentation_options.js
|   |   ├── searchtools.js
|   |   └── sphinx_highlight.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-duplicates
|   |   |   └── fish_licence
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-theme-having-multiple-stylesheets
|   |   |   ├── _themes
|   |   |   |   └── mytheme
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-copyright-multiline
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── dedent.rst
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-csv-table
|   |   |   ├── conf.py
|   |   |   └── subdir
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── ns_lookup.rst
|   |   ├── test-domain-c-c_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-cpp-cpp_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-js-javascript_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py
|   |   |   ├── abbr.rst
|   |   |   ├── canonical.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-python_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-python_use_unqualified_type_names
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-environment-record-dependencies
|   |   |   ├── api.rst
|   |   |   ├── conf.py
|   |   |   ├── example_module.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── _functions_to_import.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── autodoc_type_aliases.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── canonical
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── metadata.py
|   |   |       ├── methods.py
|   |   |       ├── module.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── pep604.py
|   |   |       ├── preserve_defaults.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── properties.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       ├── uninitialized_attributes.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_class_module.py
|   |   |   ├── autosummary_dummy_inherited_module.py
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-module_all
|   |   |   ├── autosummary_dummy_package_all
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autosummary_dummy_module.py
|   |   |   |   └── extra_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls-multiple-replacements
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgmockconverter
|   |   |   ├── 1
|   |   |   ├── 2
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── mocksvgconverter.py
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-intersphinx-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   ├── nomath.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-napoleon
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── mypackage
|   |   |   |   ├── __init__.py
|   |   |   |   └── typehints.py
|   |   |   └── typehints.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-highlight_options
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_signaturereturn_icon
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-escape
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── noqa.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-container
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-labels-before-module
|   |   |   ├── automodule1.py
|   |   |   ├── automodule2a.py
|   |   |   ├── automodule2b.py
|   |   |   ├── automodule3.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.rst
|   |   ├── test-linkcheck-anchors-ignore
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-documents_exclude
|   |   |   ├── br0ken_link.rst
|   |   |   ├── broken_link.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-warn-redirects
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-raw-node
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-too-many-retries
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-local-logo
|   |   |   ├── conf.py
|   |   |   ├── images
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   ├── en
|   |   |   |   └── et
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nitpicky-warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-object-description-sections
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-reST-code-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-remote-logo
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── literals.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-domain-objects
|   |   |   ├── conf.py
|   |   |   ├── domains.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-index
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-transforms-post_transforms-keyboard
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-transforms-post_transforms-missing-reference
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_object_description.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_record_dependencies.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_autoproperty.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_preserve_defaults.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_extlinks.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_imgmockconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_extension.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_display.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── babel_runner.py
    ├── bump_docker.sh
    └── bump_version.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the content of `tests/test_util_rst.py`, `tests/roots/test-prolog/conf.py`, `tests/roots/test-prolog/restructuredtext.rst`, and `tests/test_build.py`.
Extra Requirements: 
Purpose: These files will provide insight into both unit and integration tests related to `rst_prolog` and reStructuredText parsing, which are central to the reported bug.

Previous refined query 2:
Essential Query: Please provide the content of `tests/test_markup.py` and `tests/test_domain_py.py`.
Extra Requirements: 
Purpose: These files are needed to find integration tests that check for correct parsing of headings containing domain directives, which is the scenario described in the bug report.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: tests/roots/test-prolog/conf.py
Line number range: 1 - 10
Content:
1. import os
2. import sys
3. 
4. sys.path.insert(0, os.path.abspath('.'))
5. 
6. 
7. extensions = ['prolog_markdown_parser']
8. 
9. rst_prolog = '*Hello world*.\n\n'
10. rst_epilog = '\n\n*Good-bye world*.'


File: tests/roots/test-prolog/restructuredtext.rst
Line number range: 1 - 4
Content:
1. sample document
2. ===============
3. 
4. This is a sample document in reST


File: tests/test_build.py
Line number range: 1 - 135
Content:
1. """Test all builders."""
2. 
3. import sys
4. from unittest import mock
5. 
6. import pytest
7. from docutils import nodes
8. 
9. from sphinx.errors import SphinxError
10. 
11. 
12. def request_session_head(url, **kwargs):
13.     response = mock.Mock()
14.     response.status_code = 200
15.     response.url = url
16.     return response
17. 
18. 
19. @pytest.fixture()
20. def nonascii_srcdir(request, rootdir, sphinx_test_tempdir):
21.     # Build in a non-ASCII source dir
22.     test_name = '\u65e5\u672c\u8a9e'
23.     basedir = sphinx_test_tempdir / request.node.originalname
24.     srcdir = basedir / test_name
25.     if not srcdir.exists():
26.         (rootdir / 'test-root').copytree(srcdir)
27. 
28.     # add a doc with a non-ASCII file name to the source dir
29.     (srcdir / (test_name + '.txt')).write_text("""
30. nonascii file name page
31. =======================
32. """, encoding='utf8')
33. 
34.     root_doc = srcdir / 'index.txt'
35.     root_doc.write_text(root_doc.read_text(encoding='utf8') + f"""
36. .. toctree::
37. 
38. {test_name}/{test_name}
39. """, encoding='utf8')
40.     return srcdir
41. 
42. 
43. # note: this test skips building docs for some builders because they have independent testcase.
44. #       (html, changes, epub, latex, texinfo and manpage)
45. @pytest.mark.parametrize(
46.     "buildername",
47.     ['dirhtml', 'singlehtml', 'text', 'xml', 'pseudoxml', 'linkcheck'],
48. )
49. @mock.patch('sphinx.builders.linkcheck.requests.head',
50.             side_effect=request_session_head)
51. @pytest.mark.xfail(sys.platform == 'win32', reason="Not working on windows")
52. def test_build_all(requests_head, make_app, nonascii_srcdir, buildername):
53.     app = make_app(buildername, srcdir=nonascii_srcdir)
54.     app.build()
55. 
56. 
57. def test_root_doc_not_found(tempdir, make_app):
58.     (tempdir / 'conf.py').write_text('', encoding='utf8')
59.     assert tempdir.listdir() == ['conf.py']
60. 
61.     app = make_app('dummy', srcdir=tempdir)
62.     with pytest.raises(SphinxError):
63.         app.builder.build_all()  # no index.rst
64. 
65. 
66. @pytest.mark.sphinx(buildername='text', testroot='circular')
67. def test_circular_toctree(app, status, warning):
68.     app.builder.build_all()
69.     warnings = warning.getvalue()
70.     assert (
71.         'circular toctree references detected, ignoring: '
72.         'sub <- index <- sub') in warnings
73.     assert (
74.         'circular toctree references detected, ignoring: '
75.         'index <- sub <- index') in warnings
76. 
77. 
78. @pytest.mark.sphinx(buildername='text', testroot='numbered-circular')
79. def test_numbered_circular_toctree(app, status, warning):
80.     app.builder.build_all()
81.     warnings = warning.getvalue()
82.     assert (
83.         'circular toctree references detected, ignoring: '
84.         'sub <- index <- sub') in warnings
85.     assert (
86.         'circular toctree references detected, ignoring: '
87.         'index <- sub <- index') in warnings
88. 
89. 
90. @pytest.mark.sphinx(buildername='dummy', testroot='images')
91. def test_image_glob(app, status, warning):
92.     app.builder.build_all()
93. 
94.     # index.rst
95.     doctree = app.env.get_doctree('index')
96. 
97.     assert isinstance(doctree[0][1], nodes.image)
98.     assert doctree[0][1]['candidates'] == {'*': 'rimg.png'}
99.     assert doctree[0][1]['uri'] == 'rimg.png'
100. 
101.     assert isinstance(doctree[0][2], nodes.figure)
102.     assert isinstance(doctree[0][2][0], nodes.image)
103.     assert doctree[0][2][0]['candidates'] == {'*': 'rimg.png'}
104.     assert doctree[0][2][0]['uri'] == 'rimg.png'
105. 
106.     assert isinstance(doctree[0][3], nodes.image)
107.     assert doctree[0][3]['candidates'] == {'application/pdf': 'img.pdf',
108.                                            'image/gif': 'img.gif',
109.                                            'image/png': 'img.png'}
110.     assert doctree[0][3]['uri'] == 'img.*'
111. 
112.     assert isinstance(doctree[0][4], nodes.figure)
113.     assert isinstance(doctree[0][4][0], nodes.image)
114.     assert doctree[0][4][0]['candidates'] == {'application/pdf': 'img.pdf',
115.                                               'image/gif': 'img.gif',
116.                                               'image/png': 'img.png'}
117.     assert doctree[0][4][0]['uri'] == 'img.*'
118. 
119.     # subdir/index.rst
120.     doctree = app.env.get_doctree('subdir/index')
121. 
122.     assert isinstance(doctree[0][1], nodes.image)
123.     assert doctree[0][1]['candidates'] == {'*': 'subdir/rimg.png'}
124.     assert doctree[0][1]['uri'] == 'subdir/rimg.png'
125. 
126.     assert isinstance(doctree[0][2], nodes.image)
127.     assert doctree[0][2]['candidates'] == {'application/pdf': 'subdir/svgimg.pdf',
128.                                            'image/svg+xml': 'subdir/svgimg.svg'}
129.     assert doctree[0][2]['uri'] == 'subdir/svgimg.*'
130. 
131.     assert isinstance(doctree[0][3], nodes.figure)
132.     assert isinstance(doctree[0][3][0], nodes.image)
133.     assert doctree[0][3][0]['candidates'] == {'application/pdf': 'subdir/svgimg.pdf',
134.                                               'image/svg+xml': 'subdir/svgimg.svg'}
135.     assert doctree[0][3][0]['uri'] == 'subdir/svgimg.*'


File: tests/test_domain_py.py
Line number range: 1 - 500
Content:
1. """Tests the Python Domain"""
2. 
3. import re
4. from unittest.mock import Mock
5. 
6. import docutils.utils
7. import pytest
8. from docutils import nodes
9. 
10. from sphinx import addnodes
11. from sphinx.addnodes import (
12.     desc,
13.     desc_addname,
14.     desc_annotation,
15.     desc_content,
16.     desc_name,
17.     desc_optional,
18.     desc_parameter,
19.     desc_parameterlist,
20.     desc_returns,
21.     desc_sig_keyword,
22.     desc_sig_literal_number,
23.     desc_sig_literal_string,
24.     desc_sig_name,
25.     desc_sig_operator,
26.     desc_sig_punctuation,
27.     desc_sig_space,
28.     desc_signature,
29.     pending_xref,
30. )
31. from sphinx.domains import IndexEntry
32. from sphinx.domains.python import (
33.     PythonDomain,
34.     PythonModuleIndex,
35.     _parse_annotation,
36.     _pseudo_parse_arglist,
37.     py_sig_re,
38. )
39. from sphinx.testing import restructuredtext
40. from sphinx.testing.util import assert_node
41. from sphinx.writers.text import STDINDENT
42. 
43. 
44. def parse(sig):
45.     m = py_sig_re.match(sig)
46.     if m is None:
47.         raise ValueError
48.     name_prefix, name, arglist, retann = m.groups()
49.     signode = addnodes.desc_signature(sig, '')
50.     _pseudo_parse_arglist(signode, arglist)
51.     return signode.astext()
52. 
53. 
54. def test_function_signatures():
55.     rv = parse('func(a=1) -> int object')
56.     assert rv == '(a=1)'
57. 
58.     rv = parse('func(a=1, [b=None])')
59.     assert rv == '(a=1, [b=None])'
60. 
61.     rv = parse('func(a=1[, b=None])')
62.     assert rv == '(a=1, [b=None])'
63. 
64.     rv = parse("compile(source : string, filename, symbol='file')")
65.     assert rv == "(source : string, filename, symbol='file')"
66. 
67.     rv = parse('func(a=[], [b=None])')
68.     assert rv == '(a=[], [b=None])'
69. 
70.     rv = parse('func(a=[][, b=None])')
71.     assert rv == '(a=[], [b=None])'
72. 
73. 
74. @pytest.mark.sphinx('dummy', testroot='domain-py')
75. def test_domain_py_xrefs(app, status, warning):
76.     """Domain objects have correct prefixes when looking up xrefs"""
77.     app.builder.build_all()
78. 
79.     def assert_refnode(node, module_name, class_name, target, reftype=None,
80.                        domain='py'):
81.         attributes = {
82.             'refdomain': domain,
83.             'reftarget': target,
84.         }
85.         if reftype is not None:
86.             attributes['reftype'] = reftype
87.         if module_name is not False:
88.             attributes['py:module'] = module_name
89.         if class_name is not False:
90.             attributes['py:class'] = class_name
91.         assert_node(node, **attributes)
92. 
93.     doctree = app.env.get_doctree('roles')
94.     refnodes = list(doctree.findall(pending_xref))
95.     assert_refnode(refnodes[0], None, None, 'TopLevel', 'class')
96.     assert_refnode(refnodes[1], None, None, 'top_level', 'meth')
97.     assert_refnode(refnodes[2], None, 'NestedParentA', 'child_1', 'meth')
98.     assert_refnode(refnodes[3], None, 'NestedParentA', 'NestedChildA.subchild_2', 'meth')
99.     assert_refnode(refnodes[4], None, 'NestedParentA', 'child_2', 'meth')
100.     assert_refnode(refnodes[5], False, 'NestedParentA', 'any_child', domain='')
101.     assert_refnode(refnodes[6], None, 'NestedParentA', 'NestedChildA', 'class')
102.     assert_refnode(refnodes[7], None, 'NestedParentA.NestedChildA', 'subchild_2', 'meth')
103.     assert_refnode(refnodes[8], None, 'NestedParentA.NestedChildA',
104.                    'NestedParentA.child_1', 'meth')
105.     assert_refnode(refnodes[9], None, 'NestedParentA', 'NestedChildA.subchild_1', 'meth')
106.     assert_refnode(refnodes[10], None, 'NestedParentB', 'child_1', 'meth')
107.     assert_refnode(refnodes[11], None, 'NestedParentB', 'NestedParentB', 'class')
108.     assert_refnode(refnodes[12], None, None, 'NestedParentA.NestedChildA', 'class')
109.     assert len(refnodes) == 13
110. 
111.     doctree = app.env.get_doctree('module')
112.     refnodes = list(doctree.findall(pending_xref))
113.     assert_refnode(refnodes[0], 'module_a.submodule', None,
114.                    'ModTopLevel', 'class')
115.     assert_refnode(refnodes[1], 'module_a.submodule', 'ModTopLevel',
116.                    'mod_child_1', 'meth')
117.     assert_refnode(refnodes[2], 'module_a.submodule', 'ModTopLevel',
118.                    'ModTopLevel.mod_child_1', 'meth')
119.     assert_refnode(refnodes[3], 'module_a.submodule', 'ModTopLevel',
120.                    'mod_child_2', 'meth')
121.     assert_refnode(refnodes[4], 'module_a.submodule', 'ModTopLevel',
122.                    'module_a.submodule.ModTopLevel.mod_child_1', 'meth')
123.     assert_refnode(refnodes[5], 'module_a.submodule', 'ModTopLevel',
124.                    'prop', 'attr')
125.     assert_refnode(refnodes[6], 'module_a.submodule', 'ModTopLevel',
126.                    'prop', 'meth')
127.     assert_refnode(refnodes[7], 'module_b.submodule', None,
128.                    'ModTopLevel', 'class')
129.     assert_refnode(refnodes[8], 'module_b.submodule', 'ModTopLevel',
130.                    'ModNoModule', 'class')
131.     assert_refnode(refnodes[9], False, False, 'int', 'class')
132.     assert_refnode(refnodes[10], False, False, 'tuple', 'class')
133.     assert_refnode(refnodes[11], False, False, 'str', 'class')
134.     assert_refnode(refnodes[12], False, False, 'float', 'class')
135.     assert_refnode(refnodes[13], False, False, 'list', 'class')
136.     assert_refnode(refnodes[14], False, False, 'ModTopLevel', 'class')
137.     assert_refnode(refnodes[15], False, False, 'index', 'doc', domain='std')
138.     assert len(refnodes) == 16
139. 
140.     doctree = app.env.get_doctree('module_option')
141.     refnodes = list(doctree.findall(pending_xref))
142.     print(refnodes)
143.     print(refnodes[0])
144.     print(refnodes[1])
145.     assert_refnode(refnodes[0], 'test.extra', 'B', 'foo', 'meth')
146.     assert_refnode(refnodes[1], 'test.extra', 'B', 'foo', 'meth')
147.     assert len(refnodes) == 2
148. 
149. 
150. @pytest.mark.sphinx('html', testroot='domain-py')
151. def test_domain_py_xrefs_abbreviations(app, status, warning):
152.     app.builder.build_all()
153. 
154.     content = (app.outdir / 'abbr.html').read_text(encoding='utf8')
155.     assert re.search(r'normal: <a .* href="module.html#module_a.submodule.ModTopLevel.'
156.                      r'mod_child_1" .*><.*>module_a.submodule.ModTopLevel.mod_child_1\(\)'
157.                      r'<.*></a>',
158.                      content)
159.     assert re.search(r'relative: <a .* href="module.html#module_a.submodule.ModTopLevel.'
160.                      r'mod_child_1" .*><.*>ModTopLevel.mod_child_1\(\)<.*></a>',
161.                      content)
162.     assert re.search(r'short name: <a .* href="module.html#module_a.submodule.ModTopLevel.'
163.                      r'mod_child_1" .*><.*>mod_child_1\(\)<.*></a>',
164.                      content)
165.     assert re.search(r'relative \+ short name: <a .* href="module.html#module_a.submodule.'
166.                      r'ModTopLevel.mod_child_1" .*><.*>mod_child_1\(\)<.*></a>',
167.                      content)
168.     assert re.search(r'short name \+ relative: <a .* href="module.html#module_a.submodule.'
169.                      r'ModTopLevel.mod_child_1" .*><.*>mod_child_1\(\)<.*></a>',
170.                      content)
171. 
172. 
173. @pytest.mark.sphinx('dummy', testroot='domain-py')
174. def test_domain_py_objects(app, status, warning):
175.     app.builder.build_all()
176. 
177.     modules = app.env.domains['py'].data['modules']
178.     objects = app.env.domains['py'].data['objects']
179. 
180.     assert 'module_a.submodule' in modules
181.     assert 'module_a.submodule' in objects
182.     assert 'module_b.submodule' in modules
183.     assert 'module_b.submodule' in objects
184. 
185.     assert objects['module_a.submodule.ModTopLevel'][2] == 'class'
186.     assert objects['module_a.submodule.ModTopLevel.mod_child_1'][2] == 'method'
187.     assert objects['module_a.submodule.ModTopLevel.mod_child_2'][2] == 'method'
188.     assert 'ModTopLevel.ModNoModule' not in objects
189.     assert objects['ModNoModule'][2] == 'class'
190.     assert objects['module_b.submodule.ModTopLevel'][2] == 'class'
191. 
192.     assert objects['TopLevel'][2] == 'class'
193.     assert objects['top_level'][2] == 'method'
194.     assert objects['NestedParentA'][2] == 'class'
195.     assert objects['NestedParentA.child_1'][2] == 'method'
196.     assert objects['NestedParentA.any_child'][2] == 'method'
197.     assert objects['NestedParentA.NestedChildA'][2] == 'class'
198.     assert objects['NestedParentA.NestedChildA.subchild_1'][2] == 'method'
199.     assert objects['NestedParentA.NestedChildA.subchild_2'][2] == 'method'
200.     assert objects['NestedParentA.child_2'][2] == 'method'
201.     assert objects['NestedParentB'][2] == 'class'
202.     assert objects['NestedParentB.child_1'][2] == 'method'
203. 
204. 
205. @pytest.mark.sphinx('html', testroot='domain-py')
206. def test_resolve_xref_for_properties(app, status, warning):
207.     app.builder.build_all()
208. 
209.     content = (app.outdir / 'module.html').read_text(encoding='utf8')
210.     assert ('Link to <a class="reference internal" href="#module_a.submodule.ModTopLevel.prop"'
211.             ' title="module_a.submodule.ModTopLevel.prop">'
212.             '<code class="xref py py-attr docutils literal notranslate"><span class="pre">'
213.             'prop</span> <span class="pre">attribute</span></code></a>' in content)
214.     assert ('Link to <a class="reference internal" href="#module_a.submodule.ModTopLevel.prop"'
215.             ' title="module_a.submodule.ModTopLevel.prop">'
216.             '<code class="xref py py-meth docutils literal notranslate"><span class="pre">'
217.             'prop</span> <span class="pre">method</span></code></a>' in content)
218.     assert ('Link to <a class="reference internal" href="#module_a.submodule.ModTopLevel.prop"'
219.             ' title="module_a.submodule.ModTopLevel.prop">'
220.             '<code class="xref py py-attr docutils literal notranslate"><span class="pre">'
221.             'prop</span> <span class="pre">attribute</span></code></a>' in content)
222. 
223. 
224. @pytest.mark.sphinx('dummy', testroot='domain-py')
225. def test_domain_py_find_obj(app, status, warning):
226. 
227.     def find_obj(modname, prefix, obj_name, obj_type, searchmode=0):
228.         return app.env.domains['py'].find_obj(
229.             app.env, modname, prefix, obj_name, obj_type, searchmode)
230. 
231.     app.builder.build_all()
232. 
233.     assert (find_obj(None, None, 'NONEXISTANT', 'class') == [])
234.     assert (find_obj(None, None, 'NestedParentA', 'class') ==
235.             [('NestedParentA', ('roles', 'NestedParentA', 'class', False))])
236.     assert (find_obj(None, None, 'NestedParentA.NestedChildA', 'class') ==
237.             [('NestedParentA.NestedChildA',
238.               ('roles', 'NestedParentA.NestedChildA', 'class', False))])
239.     assert (find_obj(None, 'NestedParentA', 'NestedChildA', 'class') ==
240.             [('NestedParentA.NestedChildA',
241.               ('roles', 'NestedParentA.NestedChildA', 'class', False))])
242.     assert (find_obj(None, None, 'NestedParentA.NestedChildA.subchild_1', 'meth') ==
243.             [('NestedParentA.NestedChildA.subchild_1',
244.               ('roles', 'NestedParentA.NestedChildA.subchild_1', 'method', False))])
245.     assert (find_obj(None, 'NestedParentA', 'NestedChildA.subchild_1', 'meth') ==
246.             [('NestedParentA.NestedChildA.subchild_1',
247.               ('roles', 'NestedParentA.NestedChildA.subchild_1', 'method', False))])
248.     assert (find_obj(None, 'NestedParentA.NestedChildA', 'subchild_1', 'meth') ==
249.             [('NestedParentA.NestedChildA.subchild_1',
250.               ('roles', 'NestedParentA.NestedChildA.subchild_1', 'method', False))])
251. 
252. 
253. @pytest.mark.sphinx('html', testroot='domain-py', freshenv=True)
254. def test_domain_py_canonical(app, status, warning):
255.     app.builder.build_all()
256. 
257.     content = (app.outdir / 'canonical.html').read_text(encoding='utf8')
258.     assert ('<a class="reference internal" href="#canonical.Foo" title="canonical.Foo">'
259.             '<code class="xref py py-class docutils literal notranslate">'
260.             '<span class="pre">Foo</span></code></a>' in content)
261.     assert warning.getvalue() == ''
262. 
263. 
264. def test_get_full_qualified_name():
265.     env = Mock(domaindata={})
266.     domain = PythonDomain(env)
267. 
268.     # non-python references
269.     node = nodes.reference()
270.     assert domain.get_full_qualified_name(node) is None
271. 
272.     # simple reference
273.     node = nodes.reference(reftarget='func')
274.     assert domain.get_full_qualified_name(node) == 'func'
275. 
276.     # with py:module context
277.     kwargs = {'py:module': 'module1'}
278.     node = nodes.reference(reftarget='func', **kwargs)
279.     assert domain.get_full_qualified_name(node) == 'module1.func'
280. 
281.     # with py:class context
282.     kwargs = {'py:class': 'Class'}
283.     node = nodes.reference(reftarget='func', **kwargs)
284.     assert domain.get_full_qualified_name(node) == 'Class.func'
285. 
286.     # with both py:module and py:class context
287.     kwargs = {'py:module': 'module1', 'py:class': 'Class'}
288.     node = nodes.reference(reftarget='func', **kwargs)
289.     assert domain.get_full_qualified_name(node) == 'module1.Class.func'
290. 
291. 
292. def test_parse_annotation(app):
293.     doctree = _parse_annotation("int", app.env)
294.     assert_node(doctree, ([pending_xref, "int"],))
295.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="class", reftarget="int")
296. 
297.     doctree = _parse_annotation("List[int]", app.env)
298.     assert_node(doctree, ([pending_xref, "List"],
299.                           [desc_sig_punctuation, "["],
300.                           [pending_xref, "int"],
301.                           [desc_sig_punctuation, "]"]))
302. 
303.     doctree = _parse_annotation("Tuple[int, int]", app.env)
304.     assert_node(doctree, ([pending_xref, "Tuple"],
305.                           [desc_sig_punctuation, "["],
306.                           [pending_xref, "int"],
307.                           [desc_sig_punctuation, ","],
308.                           desc_sig_space,
309.                           [pending_xref, "int"],
310.                           [desc_sig_punctuation, "]"]))
311. 
312.     doctree = _parse_annotation("Tuple[()]", app.env)
313.     assert_node(doctree, ([pending_xref, "Tuple"],
314.                           [desc_sig_punctuation, "["],
315.                           [desc_sig_punctuation, "("],
316.                           [desc_sig_punctuation, ")"],
317.                           [desc_sig_punctuation, "]"]))
318. 
319.     doctree = _parse_annotation("Tuple[int, ...]", app.env)
320.     assert_node(doctree, ([pending_xref, "Tuple"],
321.                           [desc_sig_punctuation, "["],
322.                           [pending_xref, "int"],
323.                           [desc_sig_punctuation, ","],
324.                           desc_sig_space,
325.                           [desc_sig_punctuation, "..."],
326.                           [desc_sig_punctuation, "]"]))
327. 
328.     doctree = _parse_annotation("Callable[[int, int], int]", app.env)
329.     assert_node(doctree, ([pending_xref, "Callable"],
330.                           [desc_sig_punctuation, "["],
331.                           [desc_sig_punctuation, "["],
332.                           [pending_xref, "int"],
333.                           [desc_sig_punctuation, ","],
334.                           desc_sig_space,
335.                           [pending_xref, "int"],
336.                           [desc_sig_punctuation, "]"],
337.                           [desc_sig_punctuation, ","],
338.                           desc_sig_space,
339.                           [pending_xref, "int"],
340.                           [desc_sig_punctuation, "]"]))
341. 
342.     doctree = _parse_annotation("Callable[[], int]", app.env)
343.     assert_node(doctree, ([pending_xref, "Callable"],
344.                           [desc_sig_punctuation, "["],
345.                           [desc_sig_punctuation, "["],
346.                           [desc_sig_punctuation, "]"],
347.                           [desc_sig_punctuation, ","],
348.                           desc_sig_space,
349.                           [pending_xref, "int"],
350.                           [desc_sig_punctuation, "]"]))
351. 
352.     doctree = _parse_annotation("List[None]", app.env)
353.     assert_node(doctree, ([pending_xref, "List"],
354.                           [desc_sig_punctuation, "["],
355.                           [pending_xref, "None"],
356.                           [desc_sig_punctuation, "]"]))
357. 
358.     # None type makes an object-reference (not a class reference)
359.     doctree = _parse_annotation("None", app.env)
360.     assert_node(doctree, ([pending_xref, "None"],))
361.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="obj", reftarget="None")
362. 
363.     # Literal type makes an object-reference (not a class reference)
364.     doctree = _parse_annotation("typing.Literal['a', 'b']", app.env)
365.     assert_node(doctree, ([pending_xref, "Literal"],
366.                           [desc_sig_punctuation, "["],
367.                           [desc_sig_literal_string, "'a'"],
368.                           [desc_sig_punctuation, ","],
369.                           desc_sig_space,
370.                           [desc_sig_literal_string, "'b'"],
371.                           [desc_sig_punctuation, "]"]))
372.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="obj", reftarget="typing.Literal")
373. 
374. 
375. def test_parse_annotation_suppress(app):
376.     doctree = _parse_annotation("~typing.Dict[str, str]", app.env)
377.     assert_node(doctree, ([pending_xref, "Dict"],
378.                           [desc_sig_punctuation, "["],
379.                           [pending_xref, "str"],
380.                           [desc_sig_punctuation, ","],
381.                           desc_sig_space,
382.                           [pending_xref, "str"],
383.                           [desc_sig_punctuation, "]"]))
384.     assert_node(doctree[0], pending_xref, refdomain="py", reftype="obj", reftarget="typing.Dict")
385. 
386. 
387. def test_parse_annotation_Literal(app):
388.     doctree = _parse_annotation("Literal[True, False]", app.env)
389.     assert_node(doctree, ([pending_xref, "Literal"],
390.                           [desc_sig_punctuation, "["],
391.                           [desc_sig_keyword, "True"],
392.                           [desc_sig_punctuation, ","],
393.                           desc_sig_space,
394.                           [desc_sig_keyword, "False"],
395.                           [desc_sig_punctuation, "]"]))
396. 
397.     doctree = _parse_annotation("typing.Literal[0, 1, 'abc']", app.env)
398.     assert_node(doctree, ([pending_xref, "Literal"],
399.                           [desc_sig_punctuation, "["],
400.                           [desc_sig_literal_number, "0"],
401.                           [desc_sig_punctuation, ","],
402.                           desc_sig_space,
403.                           [desc_sig_literal_number, "1"],
404.                           [desc_sig_punctuation, ","],
405.                           desc_sig_space,
406.                           [desc_sig_literal_string, "'abc'"],
407.                           [desc_sig_punctuation, "]"]))
408. 
409. 
410. def test_pyfunction_signature(app):
411.     text = ".. py:function:: hello(name: str) -> str"
412.     doctree = restructuredtext.parse(app, text)
413.     assert_node(doctree, (addnodes.index,
414.                           [desc, ([desc_signature, ([desc_name, "hello"],
415.                                                     desc_parameterlist,
416.                                                     [desc_returns, pending_xref, "str"])],
417.                                   desc_content)]))
418.     assert_node(doctree[1], addnodes.desc, desctype="function",
419.                 domain="py", objtype="function", noindex=False)
420.     assert_node(doctree[1][0][1],
421.                 [desc_parameterlist, desc_parameter, ([desc_sig_name, "name"],
422.                                                       [desc_sig_punctuation, ":"],
423.                                                       desc_sig_space,
424.                                                       [nodes.inline, pending_xref, "str"])])
425. 
426. 
427. def test_pyfunction_signature_full(app):
428.     text = (".. py:function:: hello(a: str, b = 1, *args: str, "
429.             "c: bool = True, d: tuple = (1, 2), **kwargs: str) -> str")
430.     doctree = restructuredtext.parse(app, text)
431.     assert_node(doctree, (addnodes.index,
432.                           [desc, ([desc_signature, ([desc_name, "hello"],
433.                                                     desc_parameterlist,
434.                                                     [desc_returns, pending_xref, "str"])],
435.                                   desc_content)]))
436.     assert_node(doctree[1], addnodes.desc, desctype="function",
437.                 domain="py", objtype="function", noindex=False)
438.     assert_node(doctree[1][0][1],
439.                 [desc_parameterlist, ([desc_parameter, ([desc_sig_name, "a"],
440.                                                         [desc_sig_punctuation, ":"],
441.                                                         desc_sig_space,
442.                                                         [desc_sig_name, pending_xref, "str"])],
443.                                       [desc_parameter, ([desc_sig_name, "b"],
444.                                                         [desc_sig_operator, "="],
445.                                                         [nodes.inline, "1"])],
446.                                       [desc_parameter, ([desc_sig_operator, "*"],
447.                                                         [desc_sig_name, "args"],
448.                                                         [desc_sig_punctuation, ":"],
449.                                                         desc_sig_space,
450.                                                         [desc_sig_name, pending_xref, "str"])],
451.                                       [desc_parameter, ([desc_sig_name, "c"],
452.                                                         [desc_sig_punctuation, ":"],
453.                                                         desc_sig_space,
454.                                                         [desc_sig_name, pending_xref, "bool"],
455.                                                         desc_sig_space,
456.                                                         [desc_sig_operator, "="],
457.                                                         desc_sig_space,
458.                                                         [nodes.inline, "True"])],
459.                                       [desc_parameter, ([desc_sig_name, "d"],
460.                                                         [desc_sig_punctuation, ":"],
461.                                                         desc_sig_space,
462.                                                         [desc_sig_name, pending_xref, "tuple"],
463.                                                         desc_sig_space,
464.                                                         [desc_sig_operator, "="],
465.                                                         desc_sig_space,
466.                                                         [nodes.inline, "(1, 2)"])],
467.                                       [desc_parameter, ([desc_sig_operator, "**"],
468.                                                         [desc_sig_name, "kwargs"],
469.                                                         [desc_sig_punctuation, ":"],
470.                                                         desc_sig_space,
471.                                                         [desc_sig_name, pending_xref, "str"])])])
472.     # case: separator at head
473.     text = ".. py:function:: hello(*, a)"
474.     doctree = restructuredtext.parse(app, text)
475.     assert_node(doctree[1][0][1],
476.                 [desc_parameterlist, ([desc_parameter, nodes.inline, "*"],
477.                                       [desc_parameter, desc_sig_name, "a"])])
478. 
479.     # case: separator in the middle
480.     text = ".. py:function:: hello(a, /, b, *, c)"
481.     doctree = restructuredtext.parse(app, text)
482.     assert_node(doctree[1][0][1],
483.                 [desc_parameterlist, ([desc_parameter, desc_sig_name, "a"],
484.                                       [desc_parameter, desc_sig_operator, "/"],
485.                                       [desc_parameter, desc_sig_name, "b"],
486.                                       [desc_parameter, desc_sig_operator, "*"],
487.                                       [desc_parameter, desc_sig_name, "c"])])
488. 
489.     # case: separator in the middle (2)
490.     text = ".. py:function:: hello(a, /, *, b)"
491.     doctree = restructuredtext.parse(app, text)
492.     assert_node(doctree[1][0][1],
493.                 [desc_parameterlist, ([desc_parameter, desc_sig_name, "a"],
494.                                       [desc_parameter, desc_sig_operator, "/"],
495.                                       [desc_parameter, desc_sig_operator, "*"],
496.                                       [desc_parameter, desc_sig_name, "b"])])
497. 
498.     # case: separator at tail
499.     text = ".. py:function:: hello(a, /)"
500.     doctree = restructuredtext.parse(app, text)


File: tests/test_markup.py
Line number range: 1 - 500
Content:
1. """Test various Sphinx-specific markup extensions."""
2. 
3. import re
4. import warnings
5. 
6. import pytest
7. from docutils import frontend, nodes, utils
8. from docutils.parsers.rst import Parser as RstParser
9. 
10. from sphinx import addnodes
11. from sphinx.builders.html.transforms import KeyboardTransform
12. from sphinx.builders.latex import LaTeXBuilder
13. from sphinx.environment import default_settings
14. from sphinx.roles import XRefRole
15. from sphinx.testing.util import Struct, assert_node
16. from sphinx.transforms import SphinxSmartQuotes
17. from sphinx.util import texescape
18. from sphinx.util.docutils import sphinx_domains
19. from sphinx.writers.html import HTML5Translator, HTMLWriter
20. from sphinx.writers.latex import LaTeXTranslator, LaTeXWriter
21. 
22. 
23. @pytest.fixture()
24. def settings(app):
25.     texescape.init()  # otherwise done by the latex builder
26.     with warnings.catch_warnings():
27.         warnings.filterwarnings('ignore', category=DeprecationWarning)
28.         # DeprecationWarning: The frontend.OptionParser class will be replaced
29.         # by a subclass of argparse.ArgumentParser in Docutils 0.21 or later.
30.         optparser = frontend.OptionParser(
31.             components=(RstParser, HTMLWriter, LaTeXWriter),
32.             defaults=default_settings)
33.     settings = optparser.get_default_values()
34.     settings.smart_quotes = True
35.     settings.env = app.builder.env
36.     settings.env.temp_data['docname'] = 'dummy'
37.     settings.contentsname = 'dummy'
38.     domain_context = sphinx_domains(settings.env)
39.     domain_context.enable()
40.     yield settings
41.     domain_context.disable()
42. 
43. 
44. @pytest.fixture()
45. def new_document(settings):
46.     def create():
47.         document = utils.new_document('test data', settings)
48.         document['file'] = 'dummy'
49.         return document
50. 
51.     return create
52. 
53. 
54. @pytest.fixture()
55. def inliner(new_document):
56.     document = new_document()
57.     document.reporter.get_source_and_line = lambda line=1: ('dummy.rst', line)
58.     return Struct(document=document, reporter=document.reporter)
59. 
60. 
61. @pytest.fixture()
62. def parse(new_document):
63.     def parse_(rst):
64.         document = new_document()
65.         parser = RstParser()
66.         parser.parse(rst, document)
67.         SphinxSmartQuotes(document, startnode=None).apply()
68.         for msg in list(document.findall(nodes.system_message)):
69.             if msg['level'] == 1:
70.                 msg.replace_self([])
71.         return document
72.     return parse_
73. 
74. 
75. # since we're not resolving the markup afterwards, these nodes may remain
76. class ForgivingTranslator:
77.     def visit_pending_xref(self, node):
78.         pass
79. 
80.     def depart_pending_xref(self, node):
81.         pass
82. 
83. 
84. class ForgivingHTMLTranslator(HTML5Translator, ForgivingTranslator):
85.     pass
86. 
87. 
88. class ForgivingLaTeXTranslator(LaTeXTranslator, ForgivingTranslator):
89.     pass
90. 
91. 
92. @pytest.fixture()
93. def verify_re_html(app, parse):
94.     def verify(rst, html_expected):
95.         document = parse(rst)
96.         KeyboardTransform(document).apply()
97.         html_translator = ForgivingHTMLTranslator(document, app.builder)
98.         document.walkabout(html_translator)
99.         html_translated = ''.join(html_translator.fragment).strip()
100.         assert re.match(html_expected, html_translated), 'from ' + rst
101.     return verify
102. 
103. 
104. @pytest.fixture()
105. def verify_re_latex(app, parse):
106.     def verify(rst, latex_expected):
107.         document = parse(rst)
108.         app.builder = LaTeXBuilder(app, app.env)
109.         app.builder.init()
110.         theme = app.builder.themes.get('manual')
111.         latex_translator = ForgivingLaTeXTranslator(document, app.builder, theme)
112.         latex_translator.first_document = -1  # don't write \begin{document}
113.         document.walkabout(latex_translator)
114.         latex_translated = ''.join(latex_translator.body).strip()
115.         assert re.match(latex_expected, latex_translated), 'from ' + repr(rst)
116.     return verify
117. 
118. 
119. @pytest.fixture()
120. def verify_re(verify_re_html, verify_re_latex):
121.     def verify_re_(rst, html_expected, latex_expected):
122.         if html_expected:
123.             verify_re_html(rst, html_expected)
124.         if latex_expected:
125.             verify_re_latex(rst, latex_expected)
126.     return verify_re_
127. 
128. 
129. @pytest.fixture()
130. def verify(verify_re_html, verify_re_latex):
131.     def verify_(rst, html_expected, latex_expected):
132.         if html_expected:
133.             verify_re_html(rst, re.escape(html_expected) + '$')
134.         if latex_expected:
135.             verify_re_latex(rst, re.escape(latex_expected) + '$')
136.     return verify_
137. 
138. 
139. @pytest.fixture()
140. def get_verifier(verify, verify_re):
141.     v = {
142.         'verify': verify,
143.         'verify_re': verify_re,
144.     }
145. 
146.     def get(name):
147.         return v[name]
148.     return get
149. 
150. 
151. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
152.     (
153.         # pep role
154.         'verify',
155.         ':pep:`8`',
156.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
157.          'href="https://peps.python.org/pep-0008/"><strong>PEP 8</strong></a></p>'),
158.         ('\\sphinxAtStartPar\n'
159.          '\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
160.          '!PEP 8@\\spxentry{PEP 8}}\\sphinxhref{https://peps.python.org/pep-0008/}'
161.          '{\\sphinxstylestrong{PEP 8}}'),
162.     ),
163.     (
164.         # pep role with anchor
165.         'verify',
166.         ':pep:`8#id1`',
167.         ('<p><span class="target" id="index-0"></span><a class="pep reference external" '
168.          'href="https://peps.python.org/pep-0008/#id1">'
169.          '<strong>PEP 8#id1</strong></a></p>'),
170.         ('\\sphinxAtStartPar\n'
171.          '\\index{Python Enhancement Proposals@\\spxentry{Python Enhancement Proposals}'
172.          '!PEP 8\\#id1@\\spxentry{PEP 8\\#id1}}\\sphinxhref'
173.          '{https://peps.python.org/pep-0008/\\#id1}'
174.          '{\\sphinxstylestrong{PEP 8\\#id1}}'),
175.     ),
176.     (
177.         # rfc role
178.         'verify',
179.         ':rfc:`2324`',
180.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
181.          'href="https://datatracker.ietf.org/doc/html/rfc2324.html"><strong>RFC 2324</strong></a></p>'),
182.         ('\\sphinxAtStartPar\n'
183.          '\\index{RFC@\\spxentry{RFC}!RFC 2324@\\spxentry{RFC 2324}}'
184.          '\\sphinxhref{https://datatracker.ietf.org/doc/html/rfc2324.html}'
185.          '{\\sphinxstylestrong{RFC 2324}}'),
186.     ),
187.     (
188.         # rfc role with anchor
189.         'verify',
190.         ':rfc:`2324#id1`',
191.         ('<p><span class="target" id="index-0"></span><a class="rfc reference external" '
192.          'href="https://datatracker.ietf.org/doc/html/rfc2324.html#id1">'
193.          '<strong>RFC 2324#id1</strong></a></p>'),
194.         ('\\sphinxAtStartPar\n'
195.          '\\index{RFC@\\spxentry{RFC}!RFC 2324\\#id1@\\spxentry{RFC 2324\\#id1}}'
196.          '\\sphinxhref{https://datatracker.ietf.org/doc/html/rfc2324.html\\#id1}'
197.          '{\\sphinxstylestrong{RFC 2324\\#id1}}'),
198.     ),
199.     (
200.         # correct interpretation of code with whitespace
201.         'verify_re',
202.         '``code   sample``',
203.         ('<p><code class="(samp )?docutils literal notranslate"><span class="pre">'
204.          'code</span>&#160;&#160; <span class="pre">sample</span></code></p>'),
205.         r'\\sphinxAtStartPar\n\\sphinxcode{\\sphinxupquote{code   sample}}',
206.     ),
207.     (
208.         # interpolation of arrows in menuselection
209.         'verify',
210.         ':menuselection:`a --> b`',
211.         ('<p><span class="menuselection">a \N{TRIANGULAR BULLET} b</span></p>'),
212.         '\\sphinxAtStartPar\n\\sphinxmenuselection{a \\(\\rightarrow\\) b}',
213.     ),
214.     (
215.         # interpolation of ampersands in menuselection
216.         'verify',
217.         ':menuselection:`&Foo -&&- &Bar`',
218.         ('<p><span class="menuselection"><span class="accelerator">F</span>oo '
219.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
220.         ('\\sphinxAtStartPar\n'
221.          r'\sphinxmenuselection{\sphinxaccelerator{F}oo \sphinxhyphen{}'
222.          r'\&\sphinxhyphen{} \sphinxaccelerator{B}ar}'),
223.     ),
224.     (
225.         # interpolation of ampersands in guilabel
226.         'verify',
227.         ':guilabel:`&Foo -&&- &Bar`',
228.         ('<p><span class="guilabel"><span class="accelerator">F</span>oo '
229.          '-&amp;- <span class="accelerator">B</span>ar</span></p>'),
230.         ('\\sphinxAtStartPar\n'
231.          r'\sphinxguilabel{\sphinxaccelerator{F}oo \sphinxhyphen{}\&\sphinxhyphen{} \sphinxaccelerator{B}ar}'),
232.     ),
233.     (
234.         # no ampersands in guilabel
235.         'verify',
236.         ':guilabel:`Foo`',
237.         '<p><span class="guilabel">Foo</span></p>',
238.         '\\sphinxAtStartPar\n\\sphinxguilabel{Foo}',
239.     ),
240.     (
241.         # kbd role
242.         'verify',
243.         ':kbd:`space`',
244.         '<p><kbd class="kbd docutils literal notranslate">space</kbd></p>',
245.         '\\sphinxAtStartPar\n\\sphinxkeyboard{\\sphinxupquote{space}}',
246.     ),
247.     (
248.         # kbd role
249.         'verify',
250.         ':kbd:`Control+X`',
251.         ('<p><kbd class="kbd compound docutils literal notranslate">'
252.          '<kbd class="kbd docutils literal notranslate">Control</kbd>'
253.          '+'
254.          '<kbd class="kbd docutils literal notranslate">X</kbd>'
255.          '</kbd></p>'),
256.         '\\sphinxAtStartPar\n\\sphinxkeyboard{\\sphinxupquote{Control+X}}',
257.     ),
258.     (
259.         # kbd role
260.         'verify',
261.         ':kbd:`Alt+^`',
262.         ('<p><kbd class="kbd compound docutils literal notranslate">'
263.          '<kbd class="kbd docutils literal notranslate">Alt</kbd>'
264.          '+'
265.          '<kbd class="kbd docutils literal notranslate">^</kbd>'
266.          '</kbd></p>'),
267.         ('\\sphinxAtStartPar\n'
268.          '\\sphinxkeyboard{\\sphinxupquote{Alt+\\textasciicircum{}}}'),
269.     ),
270.     (
271.         # kbd role
272.         'verify',
273.         ':kbd:`M-x  M-s`',
274.         ('<p><kbd class="kbd compound docutils literal notranslate">'
275.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
276.          '-'
277.          '<kbd class="kbd docutils literal notranslate">x</kbd>'
278.          '  '
279.          '<kbd class="kbd docutils literal notranslate">M</kbd>'
280.          '-'
281.          '<kbd class="kbd docutils literal notranslate">s</kbd>'
282.          '</kbd></p>'),
283.         ('\\sphinxAtStartPar\n'
284.          '\\sphinxkeyboard{\\sphinxupquote{M\\sphinxhyphen{}x  M\\sphinxhyphen{}s}}'),
285.     ),
286.     (
287.         # kbd role
288.         'verify',
289.         ':kbd:`-`',
290.         '<p><kbd class="kbd docutils literal notranslate">-</kbd></p>',
291.         ('\\sphinxAtStartPar\n'
292.          '\\sphinxkeyboard{\\sphinxupquote{\\sphinxhyphen{}}}'),
293.     ),
294.     (
295.         # kbd role
296.         'verify',
297.         ':kbd:`Caps Lock`',
298.         '<p><kbd class="kbd docutils literal notranslate">Caps Lock</kbd></p>',
299.         ('\\sphinxAtStartPar\n'
300.          '\\sphinxkeyboard{\\sphinxupquote{Caps Lock}}'),
301.     ),
302.     (
303.         # kbd role
304.         'verify',
305.         ':kbd:`sys   rq`',
306.         '<p><kbd class="kbd docutils literal notranslate">sys   rq</kbd></p>',
307.         ('\\sphinxAtStartPar\n'
308.          '\\sphinxkeyboard{\\sphinxupquote{sys   rq}}'),
309.     ),
310.     (
311.         # non-interpolation of dashes in option role
312.         'verify_re',
313.         ':option:`--with-option`',
314.         ('<p><code( class="xref std std-option docutils literal notranslate")?>'
315.          '<span class="pre">--with-option</span></code></p>$'),
316.         (r'\\sphinxAtStartPar\n'
317.          r'\\sphinxcode{\\sphinxupquote{\\sphinxhyphen{}\\sphinxhyphen{}with\\sphinxhyphen{}option}}$'),
318.     ),
319.     (
320.         # verify smarty-pants quotes
321.         'verify',
322.         '"John"',
323.         '<p>“John”</p>',
324.         "\\sphinxAtStartPar\n“John”",
325.     ),
326.     (
327.         # ... but not in literal text
328.         'verify',
329.         '``"John"``',
330.         ('<p><code class="docutils literal notranslate"><span class="pre">'
331.          '&quot;John&quot;</span></code></p>'),
332.         '\\sphinxAtStartPar\n\\sphinxcode{\\sphinxupquote{"John"}}',
333.     ),
334.     (
335.         # verify classes for inline roles
336.         'verify',
337.         ':manpage:`mp(1)`',
338.         '<p><em class="manpage">mp(1)</em></p>',
339.         '\\sphinxAtStartPar\n\\sphinxstyleliteralemphasis{\\sphinxupquote{mp(1)}}',
340.     ),
341.     (
342.         # correct escaping in normal mode
343.         'verify',
344.         'Γ\\\\∞$',
345.         None,
346.         '\\sphinxAtStartPar\nΓ\\textbackslash{}\\(\\infty\\)\\$',
347.     ),
348.     (
349.         # in verbatim code fragments
350.         'verify',
351.         '::\n\n @Γ\\∞${}',
352.         None,
353.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
354.          '@Γ\\PYGZbs{}\\(\\infty\\)\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
355.          '\\end{sphinxVerbatim}'),
356.     ),
357.     (
358.         # in URIs
359.         'verify_re',
360.         '`test <https://www.google.com/~me/>`_',
361.         None,
362.         r'\\sphinxAtStartPar\n\\sphinxhref{https://www.google.com/~me/}{test}.*',
363.     ),
364.     (
365.         # description list: simple
366.         'verify',
367.         'term\n    description',
368.         '<dl class="simple">\n<dt>term</dt><dd><p>description</p>\n</dd>\n</dl>',
369.         None,
370.     ),
371.     (
372.         # description list: with classifiers
373.         'verify',
374.         'term : class1 : class2\n    description',
375.         ('<dl class="simple">\n<dt>term<span class="classifier">class1</span>'
376.          '<span class="classifier">class2</span></dt><dd><p>description</p>\n</dd>\n</dl>'),
377.         None,
378.     ),
379.     (
380.         # glossary (description list): multiple terms
381.         'verify',
382.         '.. glossary::\n\n   term1\n   term2\n       description',
383.         ('<dl class="simple glossary">\n'
384.          '<dt id="term-term1">term1<a class="headerlink" href="#term-term1"'
385.          ' title="Permalink to this term">¶</a></dt>'
386.          '<dt id="term-term2">term2<a class="headerlink" href="#term-term2"'
387.          ' title="Permalink to this term">¶</a></dt>'
388.          '<dd><p>description</p>\n</dd>\n</dl>'),
389.         None,
390.     ),
391. ])
392. def test_inline(get_verifier, type, rst, html_expected, latex_expected):
393.     verifier = get_verifier(type)
394.     verifier(rst, html_expected, latex_expected)
395. 
396. 
397. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
398.     (
399.         'verify',
400.         r'4 backslashes \\\\',
401.         r'<p>4 backslashes \\</p>',
402.         None,
403.     ),
404. ])
405. def test_inline_docutils16(get_verifier, type, rst, html_expected, latex_expected):
406.     verifier = get_verifier(type)
407.     verifier(rst, html_expected, latex_expected)
408. 
409. 
410. @pytest.mark.sphinx(confoverrides={'latex_engine': 'xelatex'})
411. @pytest.mark.parametrize('type,rst,html_expected,latex_expected', [
412.     (
413.         # in verbatim code fragments
414.         'verify',
415.         '::\n\n @Γ\\∞${}',
416.         None,
417.         ('\\begin{sphinxVerbatim}[commandchars=\\\\\\{\\}]\n'
418.          '@Γ\\PYGZbs{}∞\\PYGZdl{}\\PYGZob{}\\PYGZcb{}\n'
419.          '\\end{sphinxVerbatim}'),
420.     ),
421. ])
422. def test_inline_for_unicode_latex_engine(get_verifier, type, rst,
423.                                          html_expected, latex_expected):
424.     verifier = get_verifier(type)
425.     verifier(rst, html_expected, latex_expected)
426. 
427. 
428. def test_samp_role(parse):
429.     # no braces
430.     text = ':samp:`a{b}c`'
431.     doctree = parse(text)
432.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
433.                                                               [nodes.emphasis, "b"],
434.                                                               "c")])
435.     # nested braces
436.     text = ':samp:`a{{b}}c`'
437.     doctree = parse(text)
438.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, ("a",
439.                                                               [nodes.emphasis, "{b"],
440.                                                               "}c")])
441. 
442.     # half-opened braces
443.     text = ':samp:`a{bc`'
444.     doctree = parse(text)
445.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{bc"])
446. 
447.     # escaped braces
448.     text = ':samp:`a\\\\{b}c`'
449.     doctree = parse(text)
450.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "a{b}c"])
451. 
452.     # no braces (whitespaces are keeped as is)
453.     text = ':samp:`code   sample`'
454.     doctree = parse(text)
455.     assert_node(doctree[0], [nodes.paragraph, nodes.literal, "code   sample"])
456. 
457. 
458. def test_download_role(parse):
459.     # implicit
460.     text = ':download:`sphinx.rst`'
461.     doctree = parse(text)
462.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
463.                              nodes.literal, "sphinx.rst"])
464.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
465.                 refexplicit=False, reftarget='sphinx.rst', refwarn=False)
466.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
467. 
468.     # explicit
469.     text = ':download:`reftitle <sphinx.rst>`'
470.     doctree = parse(text)
471.     assert_node(doctree[0], [nodes.paragraph, addnodes.download_reference,
472.                              nodes.literal, "reftitle"])
473.     assert_node(doctree[0][0], refdoc='dummy', refdomain='', reftype='download',
474.                 refexplicit=True, reftarget='sphinx.rst', refwarn=False)
475.     assert_node(doctree[0][0][0], classes=['xref', 'download'])
476. 
477. 
478. def test_XRefRole(inliner):
479.     role = XRefRole()
480. 
481.     # implicit
482.     doctrees, errors = role('ref', 'rawtext', 'text', 5, inliner, {}, [])
483.     assert len(doctrees) == 1
484.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'text'])
485.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='text',
486.                 refexplicit=False, refwarn=False)
487.     assert errors == []
488. 
489.     # explicit
490.     doctrees, errors = role('ref', 'rawtext', 'title <target>', 5, inliner, {}, [])
491.     assert_node(doctrees[0], [addnodes.pending_xref, nodes.literal, 'title'])
492.     assert_node(doctrees[0], refdoc='dummy', refdomain='', reftype='ref', reftarget='target',
493.                 refexplicit=True, refwarn=False)
494. 
495.     # bang
496.     doctrees, errors = role('ref', 'rawtext', '!title <target>', 5, inliner, {}, [])
497.     assert_node(doctrees[0], [nodes.literal, 'title <target>'])
498. 
499.     # refdomain
500.     doctrees, errors = role('test:doc', 'rawtext', 'text', 5, inliner, {}, [])


File: tests/test_util_rst.py
Line number range: 1 - 109
Content:
1. """Tests sphinx.util.rst functions."""
2. 
3. from docutils.statemachine import StringList
4. from jinja2 import Environment
5. 
6. from sphinx.util.rst import append_epilog, escape, heading, prepend_prolog, textwidth
7. 
8. 
9. def test_escape():
10.     assert escape(':ref:`id`') == r'\:ref\:\`id\`'
11.     assert escape('footnote [#]_') == r'footnote \[\#\]\_'
12.     assert escape('sphinx.application') == r'sphinx.application'
13.     assert escape('.. toctree::') == r'\.. toctree\:\:'
14. 
15. 
16. def test_append_epilog(app):
17.     epilog = 'this is rst_epilog\ngood-bye reST!'
18.     content = StringList(['hello Sphinx world',
19.                           'Sphinx is a document generator'],
20.                          'dummy.rst')
21.     append_epilog(content, epilog)
22. 
23.     assert list(content.xitems()) == [('dummy.rst', 0, 'hello Sphinx world'),
24.                                       ('dummy.rst', 1, 'Sphinx is a document generator'),
25.                                       ('dummy.rst', 2, ''),
26.                                       ('<rst_epilog>', 0, 'this is rst_epilog'),
27.                                       ('<rst_epilog>', 1, 'good-bye reST!')]
28. 
29. 
30. def test_prepend_prolog(app):
31.     prolog = 'this is rst_prolog\nhello reST!'
32.     content = StringList([':title: test of SphinxFileInput',
33.                           ':author: Sphinx team',
34.                           '',
35.                           'hello Sphinx world',
36.                           'Sphinx is a document generator'],
37.                          'dummy.rst')
38.     prepend_prolog(content, prolog)
39. 
40.     assert list(content.xitems()) == [('dummy.rst', 0, ':title: test of SphinxFileInput'),
41.                                       ('dummy.rst', 1, ':author: Sphinx team'),
42.                                       ('<generated>', 0, ''),
43.                                       ('<rst_prolog>', 0, 'this is rst_prolog'),
44.                                       ('<rst_prolog>', 1, 'hello reST!'),
45.                                       ('<generated>', 0, ''),
46.                                       ('dummy.rst', 2, ''),
47.                                       ('dummy.rst', 3, 'hello Sphinx world'),
48.                                       ('dummy.rst', 4, 'Sphinx is a document generator')]
49. 
50. 
51. def test_prepend_prolog_with_CR(app):
52.     # prolog having CR at tail
53.     prolog = 'this is rst_prolog\nhello reST!\n'
54.     content = StringList(['hello Sphinx world',
55.                           'Sphinx is a document generator'],
56.                          'dummy.rst')
57.     prepend_prolog(content, prolog)
58. 
59.     assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),
60.                                       ('<rst_prolog>', 1, 'hello reST!'),
61.                                       ('<generated>', 0, ''),
62.                                       ('dummy.rst', 0, 'hello Sphinx world'),
63.                                       ('dummy.rst', 1, 'Sphinx is a document generator')]
64. 
65. 
66. def test_prepend_prolog_without_CR(app):
67.     # prolog not having CR at tail
68.     prolog = 'this is rst_prolog\nhello reST!'
69.     content = StringList(['hello Sphinx world',
70.                           'Sphinx is a document generator'],
71.                          'dummy.rst')
72.     prepend_prolog(content, prolog)
73. 
74.     assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),
75.                                       ('<rst_prolog>', 1, 'hello reST!'),
76.                                       ('<generated>', 0, ''),
77.                                       ('dummy.rst', 0, 'hello Sphinx world'),
78.                                       ('dummy.rst', 1, 'Sphinx is a document generator')]
79. 
80. 
81. def test_textwidth():
82.     assert textwidth('Hello') == 5
83.     assert textwidth('русский язык') == 12
84.     assert textwidth('русский язык', 'WFA') == 23  # Cyrillic are ambiguous chars
85. 
86. 
87. def test_heading():
88.     env = Environment()
89.     env.extend(language=None)
90. 
91.     assert heading(env, 'Hello') == ('Hello\n'
92.                                      '=====')
93.     assert heading(env, 'Hello', 1) == ('Hello\n'
94.                                         '=====')
95.     assert heading(env, 'Hello', 2) == ('Hello\n'
96.                                         '-----')
97.     assert heading(env, 'Hello', 3) == ('Hello\n'
98.                                         '~~~~~')
99.     assert heading(env, 'русский язык', 1) == (
100.         'русский язык\n'
101.         '============'
102.     )
103. 
104.     # language=ja: ambiguous
105.     env.language = 'ja'
106.     assert heading(env, 'русский язык', 1) == (
107.         'русский язык\n'
108.         '======================='
109.     )

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 00:52:55,016 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user is reporting a bug where `rst_prolog` causes headings with domain directives to be ignored by the toctree. The provided context contains unit tests for `rst_prolog` and generic tests for domain roles, but no integration tests that combine these two features, specifically checking the effect on the toctree. To find relevant existing tests, I need to investigate how Sphinx tests the inclusion of complex headings (like those with domain objects) in toctrees. `test_environment_toctree.py` and its `test-toctree-domain-objects` test root seem highly relevant to this, as they likely contain assertions about toctree contents with domain objects.' query='Please provide the content of `tests/test_environment_toctree.py` and all files within the `tests/roots/test-toctree-domain-objects/` directory.' extra_requirements='' purpose='This will provide test cases that verify the interaction between domain objects in headings and toctree generation, which is a key aspect of the reported bug.'
2025-12-23 00:52:55,017 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the content of `tests/test_environment_toctree.py` and all files within the `tests/roots/test-toctree-domain-objects/` directory.
2025-12-23 00:52:55,017 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 00:52:55,017 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 00:52:55,018 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 00:52:55,018 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the content of `tests/test_environment_toctree.py` and all files within the `tests/roots/test-toctree-domain-objects/` directory.
Purpose: This will provide test cases that verify the interaction between domain objects in headings and toctree generation, which is a key aspect of the reported bug.
2025-12-23 00:52:58,380 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have started by reading the content of the `tests/test_environment_toctree.py` file as you requested. Next, I will proceed to read the files within the `tests/roots/test-toctree-domain-objects/` directory.' additional_kwargs={'function_call': {'name': 'find_file_node_with_relative_path', 'arguments': '{"relative_path": "tests/roots/test-toctree-domain-objects/"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2102, 'candidates_token_count': 101, 'total_token_count': 2379, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2102}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 101}], 'thoughts_token_count': 176, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.06748859008940139, 'model_name': 'gemini-2.5-pro'} id='run--b61d1978-a1c2-45d1-b5d6-9183efe456b2-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/test_environment_toctree.py'}, 'id': '65b39b91-3d9f-49db-8aa8-652441784c5e', 'type': 'tool_call'}, {'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'tests/roots/test-toctree-domain-objects/'}, 'id': '4520f3a9-997c-45cb-a8c0-3a6e93d53d15', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2102, 'output_tokens': 101, 'total_tokens': 2379, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 176}}
2025-12-23 00:53:07,050 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the content of `tests/test_environment_toctree.py`. My attempt to list the files in `tests/roots/test-toctree-domain-objects/` failed, but I was able to infer the filenames from the test file and have now read the contents of `tests/roots/test-toctree-domain-objects/index.rst` and `tests/roots/test-toctree-domain-objects/domains.rst`.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/roots/test-toctree-domain-objects/domains.rst"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 10076, 'candidates_token_count': 153, 'total_token_count': 10887, 'cached_content_token_count': 1845, 'prompt_tokens_details': [{'modality': 1, 'token_count': 10076}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1845}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 153}], 'thoughts_token_count': 658}, 'finish_reason': 'STOP', 'avg_logprobs': -0.35274019428327974, 'model_name': 'gemini-2.5-pro'} id='run--7930dbdd-4f49-4bc1-a27f-cbef128ddf85-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/roots/test-toctree-domain-objects/index.rst'}, 'id': 'b6731504-25a1-43b9-a46c-f9d466ff7d55', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/roots/test-toctree-domain-objects/domains.rst'}, 'id': 'a0167cb8-3678-4686-9363-1e45c464510a', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10076, 'output_tokens': 153, 'total_tokens': 10887, 'input_token_details': {'cache_read': 1845}, 'output_token_details': {'reasoning': 658}}
2025-12-23 00:53:08,901 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have gathered the test files you requested. I started by reading the main test file, `tests/test_environment_toctree.py`. Then, I read the supporting files from the `tests/roots/test-toctree-domain-objects/` directory, which included `index.rst` and `domains.rst`, to provide the full context of the test setup.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 10793, 'candidates_token_count': 77, 'total_token_count': 10920, 'cached_content_token_count': 9226, 'prompt_tokens_details': [{'modality': 1, 'token_count': 10793}], 'cache_tokens_details': [{'modality': 1, 'token_count': 9226}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 77}], 'thoughts_token_count': 50}, 'finish_reason': 'STOP', 'avg_logprobs': -0.20605718934690798, 'model_name': 'gemini-2.5-pro'} id='run--7cb27bcb-707d-4298-a2ef-d4db833043a0-0' usage_metadata={'input_tokens': 10793, 'output_tokens': 77, 'total_tokens': 10920, 'input_token_details': {'cache_read': 9226}, 'output_token_details': {'reasoning': 50}}
2025-12-23 00:53:08,903 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the content of `tests/test_environment_toctree.py` and all files within the `tests/roots/test-toctree-domain-objects/` directory.
--- END QUERY ---



--- BEGIN PURPOSE ---
This will provide test cases that verify the interaction between domain objects in headings and toctree generation, which is a key aspect of the reported bug.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: tests/roots/test-toctree-domain-objects/domains.rst
Line number range: 1 - 39
Content:
1. test-domain-objects
2. ===================
3. 
4. .. py:module:: hello
5. 
6. .. py:function:: world() -> str
7. 
8.    Prints "Hello, World!" to stdout
9. 
10. .. py:class:: HelloWorldPrinter
11. 
12.    Controls printing of hello world
13. 
14.    .. py:method:: set_language()
15. 
16.       Sets the language of the HelloWorldPrinter instance
17. 
18.    .. py:attribute:: output_count
19. 
20.       Count of outputs of "Hello, World!"
21. 
22.    .. py:method:: print_normal()
23.       :async:
24.       :classmethod:
25. 
26.       Prints the normal form of "Hello, World!"
27. 
28.    .. py:method:: print()
29. 
30.       Prints "Hello, World!", including in the chosen language
31. 
32. .. py:function:: exit()
33.    :module: sys
34. 
35.    Quits the interpreter
36. 
37. .. js:function:: fetch(resource)
38. 
39.    Fetches the given resource, returns a Promise


File: tests/roots/test-toctree-domain-objects/index.rst
Line number range: 1 - 6
Content:
1. .. toctree::
2.    :numbered:
3.    :caption: Table of Contents
4.    :name: mastertoc
5. 
6.    domains


File: tests/test_environment_toctree.py
Line number range: 1 - 400
Content:
1. """Test the sphinx.environment.adapters.toctree."""
2. 
3. import pytest
4. from docutils import nodes
5. from docutils.nodes import bullet_list, comment, list_item, literal, reference, title
6. 
7. from sphinx import addnodes
8. from sphinx.addnodes import compact_paragraph, only
9. from sphinx.builders.html import StandaloneHTMLBuilder
10. from sphinx.environment.adapters.toctree import TocTree
11. from sphinx.testing.util import assert_node
12. 
13. 
14. @pytest.mark.sphinx('xml', testroot='toctree')
15. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
16. def test_process_doc(app):
17.     app.build()
18.     # tocs
19.     toctree = app.env.tocs['index']
20.     assert_node(toctree,
21.                 [bullet_list, ([list_item, (compact_paragraph,  # [0][0]
22.                                             [bullet_list, (addnodes.toctree,  # [0][1][0]
23.                                                            only,  # [0][1][1]
24.                                                            list_item)])],  # [0][1][2]
25.                                [list_item, (compact_paragraph,  # [1][0]
26.                                             [bullet_list, (addnodes.toctree,  # [1][1][0]
27.                                                            addnodes.toctree)])],  # [1][1][1]
28.                                list_item)])
29. 
30.     assert_node(toctree[0][0],
31.                 [compact_paragraph, reference, "Welcome to Sphinx Tests’s documentation!"])
32.     assert_node(toctree[0][0][0], reference, anchorname='')
33.     assert_node(toctree[0][1][0], addnodes.toctree,
34.                 caption="Table of Contents", glob=False, hidden=False,
35.                 titlesonly=False, maxdepth=2, numbered=999,
36.                 entries=[(None, 'foo'), (None, 'bar'), (None, 'http://sphinx-doc.org/'),
37.                          (None, 'self')],
38.                 includefiles=['foo', 'bar'])
39. 
40.     # only branch
41.     assert_node(toctree[0][1][1], addnodes.only, expr="html")
42.     assert_node(toctree[0][1][1],
43.                 [only, list_item, ([compact_paragraph, reference, "Section for HTML"],
44.                                    [bullet_list, addnodes.toctree])])
45.     assert_node(toctree[0][1][1][0][0][0], reference, anchorname='#section-for-html')
46.     assert_node(toctree[0][1][1][0][1][0], addnodes.toctree,
47.                 caption=None, glob=False, hidden=False, entries=[(None, 'baz')],
48.                 includefiles=['baz'], titlesonly=False, maxdepth=-1, numbered=0)
49.     assert_node(toctree[0][1][2],
50.                 ([compact_paragraph, reference, "subsection"],
51.                  [bullet_list, list_item, compact_paragraph, reference, "subsubsection"]))
52. 
53.     assert_node(toctree[1][0],
54.                 [compact_paragraph, reference, "Test for issue #1157"])
55.     assert_node(toctree[1][0][0], reference, anchorname='#test-for-issue-1157')
56.     assert_node(toctree[1][1][0], addnodes.toctree,
57.                 caption=None, entries=[], glob=False, hidden=False,
58.                 titlesonly=False, maxdepth=-1, numbered=0)
59.     assert_node(toctree[1][1][1], addnodes.toctree,
60.                 caption=None, glob=False, hidden=True,
61.                 titlesonly=False, maxdepth=-1, numbered=0,
62.                 entries=[('Latest reference', 'http://sphinx-doc.org/latest/'),
63.                          ('Python', 'http://python.org/')])
64. 
65.     assert_node(toctree[2][0],
66.                 [compact_paragraph, reference, "Indices and tables"])
67. 
68.     # other collections
69.     assert app.env.toc_num_entries['index'] == 6
70.     assert app.env.toctree_includes['index'] == ['foo', 'bar', 'baz']
71.     assert app.env.files_to_rebuild['foo'] == {'index'}
72.     assert app.env.files_to_rebuild['bar'] == {'index'}
73.     assert app.env.files_to_rebuild['baz'] == {'index'}
74.     assert app.env.glob_toctrees == set()
75.     assert app.env.numbered_toctrees == {'index'}
76. 
77.     # qux has no section title
78.     assert len(app.env.tocs['qux']) == 0
79.     assert_node(app.env.tocs['qux'], nodes.bullet_list)
80.     assert app.env.toc_num_entries['qux'] == 0
81.     assert 'qux' not in app.env.toctree_includes
82. 
83. 
84. @pytest.mark.sphinx('dummy', testroot='toctree-glob')
85. def test_glob(app):
86.     includefiles = ['foo', 'bar/index', 'bar/bar_1', 'bar/bar_2',
87.                     'bar/bar_3', 'baz', 'qux/index']
88. 
89.     app.build()
90. 
91.     # tocs
92.     toctree = app.env.tocs['index']
93.     assert_node(toctree,
94.                 [bullet_list, list_item, (compact_paragraph,  # [0][0]
95.                                           [bullet_list, (list_item,  # [0][1][0]
96.                                                          list_item)])])  # [0][1][1]
97. 
98.     assert_node(toctree[0][0],
99.                 [compact_paragraph, reference, "test-toctree-glob"])
100.     assert_node(toctree[0][1][0],
101.                 [list_item, ([compact_paragraph, reference, "normal order"],
102.                              [bullet_list, addnodes.toctree])])  # [0][1][0][1][0]
103.     assert_node(toctree[0][1][0][1][0], addnodes.toctree, caption=None,
104.                 glob=True, hidden=False, titlesonly=False,
105.                 maxdepth=-1, numbered=0, includefiles=includefiles,
106.                 entries=[(None, 'foo'), (None, 'bar/index'), (None, 'bar/bar_1'),
107.                          (None, 'bar/bar_2'), (None, 'bar/bar_3'), (None, 'baz'),
108.                          (None, 'qux/index'),
109.                          ('hyperref', 'https://sphinx-doc.org/?q=sphinx')])
110.     assert_node(toctree[0][1][1],
111.                 [list_item, ([compact_paragraph, reference, "reversed order"],
112.                              [bullet_list, addnodes.toctree])])  # [0][1][1][1][0]
113.     assert_node(toctree[0][1][1][1][0], addnodes.toctree, caption=None,
114.                 glob=True, hidden=False, titlesonly=False,
115.                 maxdepth=-1, numbered=0, includefiles=list(reversed(includefiles)),
116.                 entries=[(None, 'qux/index'), (None, 'baz'), (None, 'bar/bar_3'),
117.                          (None, 'bar/bar_2'), (None, 'bar/bar_1'), (None, 'bar/index'),
118.                          (None, 'foo')])
119. 
120.     # other collections
121.     assert app.env.toc_num_entries['index'] == 3
122.     assert app.env.toctree_includes['index'] == includefiles + list(reversed(includefiles))
123.     for file in includefiles:
124.         assert 'index' in app.env.files_to_rebuild[file]
125.     assert 'index' in app.env.glob_toctrees
126.     assert app.env.numbered_toctrees == set()
127. 
128. 
129. @pytest.mark.sphinx('dummy', testroot='toctree-domain-objects')
130. def test_domain_objects(app):
131.     includefiles = ['domains']
132. 
133.     app.build()
134. 
135.     assert app.env.toc_num_entries['index'] == 0
136.     assert app.env.toc_num_entries['domains'] == 9
137.     assert app.env.toctree_includes['index'] == includefiles
138.     for file in includefiles:
139.         assert 'index' in app.env.files_to_rebuild[file]
140.     assert app.env.glob_toctrees == set()
141.     assert app.env.numbered_toctrees == {'index'}
142. 
143.     # tocs
144.     toctree = app.env.tocs['domains']
145.     assert_node(toctree,
146.                 [bullet_list, list_item, (compact_paragraph,  # [0][0]
147.                                           [bullet_list, (list_item,  # [0][1][0]
148.                                                          [list_item,  # [0][1][1]
149.                                                           (compact_paragraph,  # [0][1][1][0]
150.                                                            [bullet_list, (list_item,  # [0][1][1][1][0]
151.                                                                           list_item,
152.                                                                           list_item,
153.                                                                           list_item)])],  # [0][1][1][1][3]
154.                                                          list_item,
155.                                                          list_item)])])  # [0][1][1]
156. 
157.     assert_node(toctree[0][0],
158.                 [compact_paragraph, reference, "test-domain-objects"])
159. 
160.     assert_node(toctree[0][1][0],
161.                 [list_item, ([compact_paragraph, reference, literal, "world()"])])
162. 
163.     assert_node(toctree[0][1][1][1][3],
164.                 [list_item, ([compact_paragraph, reference, literal, "HelloWorldPrinter.print()"])])
165. 
166. 
167. @pytest.mark.sphinx('xml', testroot='toctree')
168. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
169. def test_get_toc_for(app):
170.     app.build()
171.     toctree = TocTree(app.env).get_toc_for('index', app.builder)
172. 
173.     assert_node(toctree,
174.                 [bullet_list, ([list_item, (compact_paragraph,  # [0][0]
175.                                             [bullet_list, (addnodes.toctree,  # [0][1][0]
176.                                                            comment,  # [0][1][1]
177.                                                            list_item)])],  # [0][1][2]
178.                                [list_item, (compact_paragraph,  # [1][0]
179.                                             [bullet_list, (addnodes.toctree,
180.                                                            addnodes.toctree)])],
181.                                [list_item, compact_paragraph])])  # [2][0]
182.     assert_node(toctree[0][0],
183.                 [compact_paragraph, reference, "Welcome to Sphinx Tests’s documentation!"])
184.     assert_node(toctree[0][1][2],
185.                 ([compact_paragraph, reference, "subsection"],
186.                  [bullet_list, list_item, compact_paragraph, reference, "subsubsection"]))
187.     assert_node(toctree[1][0],
188.                 [compact_paragraph, reference, "Test for issue #1157"])
189.     assert_node(toctree[2][0],
190.                 [compact_paragraph, reference, "Indices and tables"])
191. 
192. 
193. @pytest.mark.sphinx('xml', testroot='toctree')
194. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
195. def test_get_toc_for_only(app):
196.     app.build()
197.     builder = StandaloneHTMLBuilder(app, app.env)
198.     toctree = TocTree(app.env).get_toc_for('index', builder)
199. 
200.     assert_node(toctree,
201.                 [bullet_list, ([list_item, (compact_paragraph,  # [0][0]
202.                                             [bullet_list, (addnodes.toctree,  # [0][1][0]
203.                                                            list_item,  # [0][1][1]
204.                                                            list_item)])],  # [0][1][2]
205.                                [list_item, (compact_paragraph,  # [1][0]
206.                                             [bullet_list, (addnodes.toctree,
207.                                                            addnodes.toctree)])],
208.                                [list_item, compact_paragraph])])  # [2][0]
209.     assert_node(toctree[0][0],
210.                 [compact_paragraph, reference, "Welcome to Sphinx Tests’s documentation!"])
211.     assert_node(toctree[0][1][1],
212.                 ([compact_paragraph, reference, "Section for HTML"],
213.                  [bullet_list, addnodes.toctree]))
214.     assert_node(toctree[0][1][2],
215.                 ([compact_paragraph, reference, "subsection"],
216.                  [bullet_list, list_item, compact_paragraph, reference, "subsubsection"]))
217.     assert_node(toctree[1][0],
218.                 [compact_paragraph, reference, "Test for issue #1157"])
219.     assert_node(toctree[2][0],
220.                 [compact_paragraph, reference, "Indices and tables"])
221. 
222. 
223. @pytest.mark.sphinx('xml', testroot='toctree')
224. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
225. def test_get_toc_for_tocdepth(app):
226.     app.build()
227.     toctree = TocTree(app.env).get_toc_for('tocdepth', app.builder)
228. 
229.     assert_node(toctree,
230.                 [bullet_list, list_item, (compact_paragraph,  # [0][0]
231.                                           bullet_list)])  # [0][1]
232.     assert_node(toctree[0][0],
233.                 [compact_paragraph, reference, "level 1"])
234.     assert_node(toctree[0][1],
235.                 [bullet_list, list_item, compact_paragraph, reference, "level 2"])
236. 
237. 
238. @pytest.mark.sphinx('xml', testroot='toctree')
239. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
240. def test_get_toctree_for(app):
241.     app.build()
242.     toctree = TocTree(app.env).get_toctree_for('index', app.builder, collapse=False)
243.     assert_node(toctree,
244.                 [compact_paragraph, ([title, "Table of Contents"],
245.                                      bullet_list,
246.                                      bullet_list,
247.                                      bullet_list)])
248. 
249.     assert_node(toctree[1],
250.                 ([list_item, ([compact_paragraph, reference, "foo"],
251.                               bullet_list)],
252.                  [list_item, compact_paragraph, reference, "bar"],
253.                  [list_item, compact_paragraph, reference, "http://sphinx-doc.org/"],
254.                  [list_item, compact_paragraph, reference,
255.                   "Welcome to Sphinx Tests’s documentation!"]))
256.     assert_node(toctree[1][0][1],
257.                 ([list_item, compact_paragraph, reference, "quux"],
258.                  [list_item, compact_paragraph, reference, "foo.1"],
259.                  [list_item, compact_paragraph, reference, "foo.2"]))
260. 
261.     assert_node(toctree[1][0][0][0], reference, refuri="foo", secnumber=[1])
262.     assert_node(toctree[1][0][1][0][0][0], reference, refuri="quux", secnumber=[1, 1])
263.     assert_node(toctree[1][0][1][1][0][0], reference, refuri="foo#foo-1", secnumber=[1, 2])
264.     assert_node(toctree[1][0][1][2][0][0], reference, refuri="foo#foo-2", secnumber=[1, 3])
265.     assert_node(toctree[1][1][0][0], reference, refuri="bar", secnumber=[2])
266.     assert_node(toctree[1][2][0][0], reference, refuri="http://sphinx-doc.org/")
267.     assert_node(toctree[1][3][0][0], reference, refuri="")
268. 
269.     assert_node(toctree[2],
270.                 [bullet_list, list_item, compact_paragraph, reference, "baz"])
271.     assert_node(toctree[3],
272.                 ([list_item, compact_paragraph, reference, "Latest reference"],
273.                  [list_item, compact_paragraph, reference, "Python"]))
274.     assert_node(toctree[3][0][0][0], reference, refuri="http://sphinx-doc.org/latest/")
275.     assert_node(toctree[3][1][0][0], reference, refuri="http://python.org/")
276. 
277. 
278. @pytest.mark.sphinx('xml', testroot='toctree')
279. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
280. def test_get_toctree_for_collapse(app):
281.     app.build()
282.     toctree = TocTree(app.env).get_toctree_for('index', app.builder, collapse=True)
283.     assert_node(toctree,
284.                 [compact_paragraph, ([title, "Table of Contents"],
285.                                      bullet_list,
286.                                      bullet_list,
287.                                      bullet_list)])
288. 
289.     assert_node(toctree[1],
290.                 ([list_item, compact_paragraph, reference, "foo"],
291.                  [list_item, compact_paragraph, reference, "bar"],
292.                  [list_item, compact_paragraph, reference, "http://sphinx-doc.org/"],
293.                  [list_item, compact_paragraph, reference,
294.                   "Welcome to Sphinx Tests’s documentation!"]))
295.     assert_node(toctree[1][0][0][0], reference, refuri="foo", secnumber=[1])
296.     assert_node(toctree[1][1][0][0], reference, refuri="bar", secnumber=[2])
297.     assert_node(toctree[1][2][0][0], reference, refuri="http://sphinx-doc.org/")
298.     assert_node(toctree[1][3][0][0], reference, refuri="")
299. 
300.     assert_node(toctree[2],
301.                 [bullet_list, list_item, compact_paragraph, reference, "baz"])
302.     assert_node(toctree[3],
303.                 ([list_item, compact_paragraph, reference, "Latest reference"],
304.                  [list_item, compact_paragraph, reference, "Python"]))
305.     assert_node(toctree[3][0][0][0], reference, refuri="http://sphinx-doc.org/latest/")
306.     assert_node(toctree[3][1][0][0], reference, refuri="http://python.org/")
307. 
308. 
309. @pytest.mark.sphinx('xml', testroot='toctree')
310. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
311. def test_get_toctree_for_maxdepth(app):
312.     app.build()
313.     toctree = TocTree(app.env).get_toctree_for('index', app.builder,
314.                                                collapse=False, maxdepth=3)
315.     assert_node(toctree,
316.                 [compact_paragraph, ([title, "Table of Contents"],
317.                                      bullet_list,
318.                                      bullet_list,
319.                                      bullet_list)])
320. 
321.     assert_node(toctree[1],
322.                 ([list_item, ([compact_paragraph, reference, "foo"],
323.                               bullet_list)],
324.                  [list_item, compact_paragraph, reference, "bar"],
325.                  [list_item, compact_paragraph, reference, "http://sphinx-doc.org/"],
326.                  [list_item, compact_paragraph, reference,
327.                   "Welcome to Sphinx Tests’s documentation!"]))
328.     assert_node(toctree[1][0][1],
329.                 ([list_item, compact_paragraph, reference, "quux"],
330.                  [list_item, ([compact_paragraph, reference, "foo.1"],
331.                               bullet_list)],
332.                  [list_item, compact_paragraph, reference, "foo.2"]))
333.     assert_node(toctree[1][0][1][1][1],
334.                 [bullet_list, list_item, compact_paragraph, reference, "foo.1-1"])
335. 
336.     assert_node(toctree[1][0][0][0], reference, refuri="foo", secnumber=[1])
337.     assert_node(toctree[1][0][1][0][0][0], reference, refuri="quux", secnumber=[1, 1])
338.     assert_node(toctree[1][0][1][1][0][0], reference, refuri="foo#foo-1", secnumber=[1, 2])
339.     assert_node(toctree[1][0][1][1][1][0][0][0],
340.                 reference, refuri="foo#foo-1-1", secnumber=[1, 2, 1])
341.     assert_node(toctree[1][0][1][2][0][0], reference, refuri="foo#foo-2", secnumber=[1, 3])
342.     assert_node(toctree[1][1][0][0], reference, refuri="bar", secnumber=[2])
343.     assert_node(toctree[1][2][0][0], reference, refuri="http://sphinx-doc.org/")
344.     assert_node(toctree[1][3][0][0], reference, refuri="")
345. 
346.     assert_node(toctree[2],
347.                 [bullet_list, list_item, compact_paragraph, reference, "baz"])
348.     assert_node(toctree[3],
349.                 ([list_item, compact_paragraph, reference, "Latest reference"],
350.                  [list_item, compact_paragraph, reference, "Python"]))
351.     assert_node(toctree[3][0][0][0], reference, refuri="http://sphinx-doc.org/latest/")
352.     assert_node(toctree[3][1][0][0], reference, refuri="http://python.org/")
353. 
354. 
355. @pytest.mark.sphinx('xml', testroot='toctree')
356. @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
357. def test_get_toctree_for_includehidden(app):
358.     app.build()
359.     toctree = TocTree(app.env).get_toctree_for('index', app.builder, collapse=False,
360.                                                includehidden=False)
361.     assert_node(toctree,
362.                 [compact_paragraph, ([title, "Table of Contents"],
363.                                      bullet_list,
364.                                      bullet_list)])
365. 
366.     assert_node(toctree[1],
367.                 ([list_item, ([compact_paragraph, reference, "foo"],
368.                               bullet_list)],
369.                  [list_item, compact_paragraph, reference, "bar"],
370.                  [list_item, compact_paragraph, reference, "http://sphinx-doc.org/"],
371.                  [list_item, compact_paragraph, reference,
372.                   "Welcome to Sphinx Tests’s documentation!"]))
373.     assert_node(toctree[1][0][1],
374.                 ([list_item, compact_paragraph, reference, "quux"],
375.                  [list_item, compact_paragraph, reference, "foo.1"],
376.                  [list_item, compact_paragraph, reference, "foo.2"]))
377. 
378.     assert_node(toctree[1][0][0][0], reference, refuri="foo", secnumber=[1])
379.     assert_node(toctree[1][0][1][0][0][0], reference, refuri="quux", secnumber=[1, 1])
380.     assert_node(toctree[1][0][1][1][0][0], reference, refuri="foo#foo-1", secnumber=[1, 2])
381.     assert_node(toctree[1][0][1][2][0][0], reference, refuri="foo#foo-2", secnumber=[1, 3])
382.     assert_node(toctree[1][1][0][0], reference, refuri="bar", secnumber=[2])
383.     assert_node(toctree[1][2][0][0], reference, refuri="http://sphinx-doc.org/")
384. 
385.     assert_node(toctree[2],
386.                 [bullet_list, list_item, compact_paragraph, reference, "baz"])
387. 
388. 
389. @pytest.mark.sphinx('xml', testroot='toctree-index')
390. def test_toctree_index(app):
391.     app.build()
392.     toctree = app.env.tocs['index']
393.     assert_node(toctree,
394.                 [bullet_list, ([list_item, (compact_paragraph,  # [0][0]
395.                                             [bullet_list, (addnodes.toctree,  # [0][1][0]
396.                                                            addnodes.toctree)])])])  # [0][1][1]
397.     assert_node(toctree[0][1][1], addnodes.toctree,
398.                 caption="Indices", glob=False, hidden=False,
399.                 titlesonly=False, maxdepth=-1, numbered=0,
400.                 entries=[(None, 'genindex'), (None, 'modindex'), (None, 'search')])

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 00:53:17,688 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the content of the file `tests/test_environment_toctree.py`.\n2. Extended relevance:\n   - This file is directly requested by the user.', relative_path='tests/test_environment_toctree.py', start_line=1, end_line=400), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the content of all files within the `tests/roots/test-toctree-domain-objects/` directory.\n2. Extended relevance:\n   - This file, `domains.rst`, is located within the requested directory.', relative_path='tests/roots/test-toctree-domain-objects/domains.rst', start_line=1, end_line=39), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the content of all files within the `tests/roots/test-toctree-domain-objects/` directory.\n2. Extended relevance:\n   - This file, `index.rst`, is located within the requested directory.', relative_path='tests/roots/test-toctree-domain-objects/index.rst', start_line=1, end_line=6)]
2025-12-23 00:53:17,690 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the content of `tests/test_environment_toctree.py` and all files within the `tests/roots/test-toctree-domain-objects/` directory.
2025-12-23 00:53:17,690 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 00:53:17,690 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 00:53:17,691 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 6 existing contexts
2025-12-23 00:53:17,691 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 9 total contexts (removed 0 duplicates)
2025-12-23 00:53:17,691 - thread-124976592041664.prometheus_context_collector.lang_graph.nodes.context_refine_node - INFO - Reached max_refined_query_loop, not asking for more context
2025-12-23 00:53:17,692 - thread-124976592041664.prometheus_context_collector - INFO - Successfully retrieved 9 context snippets
