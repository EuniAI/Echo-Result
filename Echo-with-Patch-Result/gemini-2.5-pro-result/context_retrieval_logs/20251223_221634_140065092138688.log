2025-12-23 22:16:34,977 - thread-140065092138688.prometheus_context_collector - INFO - Starting context retrieval for query: 
Issue: RenameContentType._rename() doesn't save the content type on the correct database

Description: Description
	
The commit in question:
​https://github.com/django/django/commit/f179113e6cbc8ba0a8d4e87e1d4410fb61d63e75
The specific lines in question:
​https://github.com/django/django/blob/586a9dc4295357de1f5ad0590ad34bf2bc008f79/django/contrib/contenttypes/management/__init__.py#L27
with transaction.atomic(using=db): 
	content_type.save(update_fields={'model'})
The issue:
For some background, we run a dynamic database router and have no "real" databases configured in the settings file, just a default sqlite3 backend which is never actually generated or used. We forked the migrate.py management command and modified it to accept a dictionary containing database connection parameters as the --database argument. 
The dynamic database router is based on, and very similar to this: ​https://github.com/ambitioninc/django-dynamic-db-router/blob/master/dynamic_db_router/router.py
This has worked beautifully for all migrations up until this point.
The issue we're running into is that when attempting to run a migration which contains a call to migrations.RenameModel, and while specifying the database parameters to the migrate command, the migration fails with an OperationalError, stating that no such table: django_content_types exists.
After having exhaustively stepped through the traceback, it appears that even though the content_type.save call is wrapped in the with transaction.atomic(using=db) context manager, the actual database operation is being attempted on the default database (which in our case does not exist) rather than the database specified via schema_editor.connection.alias (on line 15 of the same file) and thus fails loudly.
So, I believe that:
content_type.save(update_fields={'model'})
should be
content_type.save(using=db, update_fields={'model'})

Patch information:
diff --git a/django/contrib/contenttypes/management/__init__.py b/django/contrib/contenttypes/management/__init__.py
index 2b5f688136..563cba2fdf 100644
--- a/django/contrib/contenttypes/management/__init__.py
+++ b/django/contrib/contenttypes/management/__init__.py
@@ -24,7 +24,7 @@ class RenameContentType(migrations.RunPython):
             content_type.model = new_model
             try:
                 with transaction.atomic(using=db):
-                    content_type.save(update_fields={'model'})
+                    content_type.save(using=db, update_fields={'model'})
             except IntegrityError:
                 # Gracefully fallback if a stale content type causes a
                 # conflict as remove_stale_contenttypes will take care of


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

2025-12-23 22:16:35,066 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
django
├── .tx
├── CONTRIBUTING.rst
├── Gruntfile.js
├── README.rst
├── django
|   ├── __init__.py
|   ├── __main__.py
|   ├── apps
|   |   ├── __init__.py
|   |   ├── config.py
|   |   └── registry.py
|   ├── bin
|   |   └── django-admin.py
|   ├── conf
|   |   ├── __init__.py
|   |   ├── app_template
|   |   |   └── migrations
|   |   ├── global_settings.py
|   |   ├── locale
|   |   |   ├── __init__.py
|   |   |   ├── af
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ar
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ast
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── az
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── be
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── bg
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── bn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── br
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── bs
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ca
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── cs
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── cy
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── da
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── de
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── de_CH
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── dsb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── el
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en_AU
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en_GB
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── eo
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_AR
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_CO
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_MX
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_NI
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_PR
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_VE
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── et
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── eu
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fa
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fy
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ga
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── gd
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── gl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── he
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hsb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── hu
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hy
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ia
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── id
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── io
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── is
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── it
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ja
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ka
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── kab
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── kk
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── km
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── kn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ko
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── lb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── lt
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── lv
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ml
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mr
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── my
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── nb
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ne
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── nl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── nn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── os
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── pa
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── pl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── pt
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── pt_BR
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ro
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ru
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sq
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sr_Latn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sv
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sw
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ta
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── te
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── th
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── tr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── tt
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── udm
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── uk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ur
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── vi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── zh_Hans
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   └── zh_Hant
|   |   |       ├── LC_MESSAGES
|   |   |       ├── __init__.py
|   |   |       └── formats.py
|   |   ├── project_template
|   |   |   └── project_name
|   |   └── urls
|   |       ├── __init__.py
|   |       ├── i18n.py
|   |       └── static.py
|   ├── contrib
|   |   ├── __init__.py
|   |   ├── admin
|   |   |   ├── __init__.py
|   |   |   ├── actions.py
|   |   |   ├── apps.py
|   |   |   ├── bin
|   |   |   |   └── compress.py
|   |   |   ├── checks.py
|   |   |   ├── decorators.py
|   |   |   ├── exceptions.py
|   |   |   ├── filters.py
|   |   |   ├── forms.py
|   |   |   ├── helpers.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── am
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_logentry_remove_auto_add.py
|   |   |   |   ├── 0003_logentry_add_action_flag_choices.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── options.py
|   |   |   ├── sites.py
|   |   |   ├── static
|   |   |   |   └── admin
|   |   |   ├── templates
|   |   |   |   ├── admin
|   |   |   |   └── registration
|   |   |   ├── templatetags
|   |   |   |   ├── __init__.py
|   |   |   |   ├── admin_list.py
|   |   |   |   ├── admin_modify.py
|   |   |   |   ├── admin_urls.py
|   |   |   |   ├── base.py
|   |   |   |   └── log.py
|   |   |   ├── tests.py
|   |   |   ├── utils.py
|   |   |   ├── views
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autocomplete.py
|   |   |   |   ├── decorators.py
|   |   |   |   └── main.py
|   |   |   └── widgets.py
|   |   ├── admindocs
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── templates
|   |   |   |   └── admin_doc
|   |   |   ├── urls.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   ├── auth
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── backends.py
|   |   |   ├── base_user.py
|   |   |   ├── checks.py
|   |   |   ├── context_processors.py
|   |   |   ├── decorators.py
|   |   |   ├── forms.py
|   |   |   ├── handlers
|   |   |   |   ├── __init__.py
|   |   |   |   └── modwsgi.py
|   |   |   ├── hashers.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   ├── __init__.py
|   |   |   |   └── commands
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_alter_permission_name_max_length.py
|   |   |   |   ├── 0003_alter_user_email_max_length.py
|   |   |   |   ├── 0004_alter_user_username_opts.py
|   |   |   |   ├── 0005_alter_user_last_login_null.py
|   |   |   |   ├── 0006_require_contenttypes_0002.py
|   |   |   |   ├── 0007_alter_validators_add_error_messages.py
|   |   |   |   ├── 0008_alter_user_username_max_length.py
|   |   |   |   ├── 0009_alter_user_last_name_max_length.py
|   |   |   |   ├── 0010_alter_group_name_max_length.py
|   |   |   |   ├── 0011_update_proxy_permissions.py
|   |   |   |   └── __init__.py
|   |   |   ├── mixins.py
|   |   |   ├── models.py
|   |   |   ├── password_validation.py
|   |   |   ├── signals.py
|   |   |   ├── templates
|   |   |   |   ├── auth
|   |   |   |   └── registration
|   |   |   ├── tokens.py
|   |   |   ├── urls.py
|   |   |   ├── validators.py
|   |   |   └── views.py
|   |   ├── contenttypes
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── checks.py
|   |   |   ├── fields.py
|   |   |   ├── forms.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   ├── __init__.py
|   |   |   |   └── commands
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_remove_content_type_name.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   └── views.py
|   |   ├── flatpages
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── forms.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── sitemaps.py
|   |   |   ├── templatetags
|   |   |   |   ├── __init__.py
|   |   |   |   └── flatpages.py
|   |   |   ├── urls.py
|   |   |   └── views.py
|   |   ├── gis
|   |   |   ├── __init__.py
|   |   |   ├── admin
|   |   |   |   ├── __init__.py
|   |   |   |   ├── options.py
|   |   |   |   └── widgets.py
|   |   |   ├── apps.py
|   |   |   ├── db
|   |   |   |   ├── __init__.py
|   |   |   |   ├── backends
|   |   |   |   └── models
|   |   |   ├── feeds.py
|   |   |   ├── forms
|   |   |   |   ├── __init__.py
|   |   |   |   ├── fields.py
|   |   |   |   └── widgets.py
|   |   |   ├── gdal
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── datasource.py
|   |   |   |   ├── driver.py
|   |   |   |   ├── envelope.py
|   |   |   |   ├── error.py
|   |   |   |   ├── feature.py
|   |   |   |   ├── field.py
|   |   |   |   ├── geometries.py
|   |   |   |   ├── geomtype.py
|   |   |   |   ├── layer.py
|   |   |   |   ├── libgdal.py
|   |   |   |   ├── prototypes
|   |   |   |   ├── raster
|   |   |   |   └── srs.py
|   |   |   ├── geoip2
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   └── resources.py
|   |   |   ├── geometry.py
|   |   |   ├── geos
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── collections.py
|   |   |   |   ├── coordseq.py
|   |   |   |   ├── error.py
|   |   |   |   ├── factory.py
|   |   |   |   ├── geometry.py
|   |   |   |   ├── io.py
|   |   |   |   ├── libgeos.py
|   |   |   |   ├── linestring.py
|   |   |   |   ├── mutable_list.py
|   |   |   |   ├── point.py
|   |   |   |   ├── polygon.py
|   |   |   |   ├── prepared.py
|   |   |   |   └── prototypes
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── measure.py
|   |   |   ├── ptr.py
|   |   |   ├── serializers
|   |   |   |   ├── __init__.py
|   |   |   |   └── geojson.py
|   |   |   ├── shortcuts.py
|   |   |   ├── sitemaps
|   |   |   |   ├── __init__.py
|   |   |   |   ├── kml.py
|   |   |   |   └── views.py
|   |   |   ├── static
|   |   |   |   └── gis
|   |   |   ├── templates
|   |   |   |   └── gis
|   |   |   ├── utils
|   |   |   |   ├── __init__.py
|   |   |   |   ├── layermapping.py
|   |   |   |   ├── ogrinfo.py
|   |   |   |   ├── ogrinspect.py
|   |   |   |   └── srs.py
|   |   |   └── views.py
|   |   ├── humanize
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   └── templatetags
|   |   |       ├── __init__.py
|   |   |       └── humanize.py
|   |   ├── messages
|   |   |   ├── __init__.py
|   |   |   ├── api.py
|   |   |   ├── apps.py
|   |   |   ├── constants.py
|   |   |   ├── context_processors.py
|   |   |   ├── middleware.py
|   |   |   ├── storage
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── cookie.py
|   |   |   |   ├── fallback.py
|   |   |   |   └── session.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   ├── postgres
|   |   |   ├── __init__.py
|   |   |   ├── aggregates
|   |   |   |   ├── __init__.py
|   |   |   |   ├── general.py
|   |   |   |   ├── mixins.py
|   |   |   |   └── statistics.py
|   |   |   ├── apps.py
|   |   |   ├── fields
|   |   |   |   ├── __init__.py
|   |   |   |   ├── array.py
|   |   |   |   ├── citext.py
|   |   |   |   ├── hstore.py
|   |   |   |   ├── jsonb.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── ranges.py
|   |   |   |   └── utils.py
|   |   |   ├── forms
|   |   |   |   ├── __init__.py
|   |   |   |   ├── array.py
|   |   |   |   ├── hstore.py
|   |   |   |   ├── jsonb.py
|   |   |   |   └── ranges.py
|   |   |   ├── functions.py
|   |   |   ├── indexes.py
|   |   |   ├── jinja2
|   |   |   |   └── postgres
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── ko
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── mn
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sv
|   |   |   |   ├── tr
|   |   |   |   ├── uk
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── lookups.py
|   |   |   ├── operations.py
|   |   |   ├── search.py
|   |   |   ├── serializers.py
|   |   |   ├── signals.py
|   |   |   ├── templates
|   |   |   |   └── postgres
|   |   |   ├── utils.py
|   |   |   └── validators.py
|   |   ├── redirects
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   └── models.py
|   |   ├── sessions
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── cache.py
|   |   |   |   ├── cached_db.py
|   |   |   |   ├── db.py
|   |   |   |   ├── file.py
|   |   |   |   └── signed_cookies.py
|   |   |   ├── base_session.py
|   |   |   ├── exceptions.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   └── serializers.py
|   |   ├── sitemaps
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── templates
|   |   |   |   ├── sitemap.xml
|   |   |   |   └── sitemap_index.xml
|   |   |   └── views.py
|   |   ├── sites
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management.py
|   |   |   ├── managers.py
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_alter_domain_unique.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── requests.py
|   |   |   └── shortcuts.py
|   |   ├── staticfiles
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── checks.py
|   |   |   ├── finders.py
|   |   |   ├── handlers.py
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── storage.py
|   |   |   ├── testing.py
|   |   |   ├── urls.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   └── syndication
|   |       ├── __init__.py
|   |       ├── apps.py
|   |       └── views.py
|   ├── core
|   |   ├── __init__.py
|   |   ├── cache
|   |   |   ├── __init__.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── db.py
|   |   |   |   ├── dummy.py
|   |   |   |   ├── filebased.py
|   |   |   |   ├── locmem.py
|   |   |   |   └── memcached.py
|   |   |   └── utils.py
|   |   ├── checks
|   |   |   ├── __init__.py
|   |   |   ├── caches.py
|   |   |   ├── compatibility
|   |   |   |   └── __init__.py
|   |   |   ├── database.py
|   |   |   ├── messages.py
|   |   |   ├── model_checks.py
|   |   |   ├── registry.py
|   |   |   ├── security
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── csrf.py
|   |   |   |   └── sessions.py
|   |   |   ├── templates.py
|   |   |   ├── translation.py
|   |   |   └── urls.py
|   |   ├── exceptions.py
|   |   ├── files
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── images.py
|   |   |   ├── locks.py
|   |   |   ├── move.py
|   |   |   ├── storage.py
|   |   |   ├── temp.py
|   |   |   ├── uploadedfile.py
|   |   |   ├── uploadhandler.py
|   |   |   └── utils.py
|   |   ├── handlers
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── exception.py
|   |   |   └── wsgi.py
|   |   ├── mail
|   |   |   ├── __init__.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── console.py
|   |   |   |   ├── dummy.py
|   |   |   |   ├── filebased.py
|   |   |   |   ├── locmem.py
|   |   |   |   └── smtp.py
|   |   |   ├── message.py
|   |   |   └── utils.py
|   |   ├── management
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── color.py
|   |   |   ├── commands
|   |   |   |   ├── check.py
|   |   |   |   ├── compilemessages.py
|   |   |   |   ├── createcachetable.py
|   |   |   |   ├── dbshell.py
|   |   |   |   ├── diffsettings.py
|   |   |   |   ├── dumpdata.py
|   |   |   |   ├── flush.py
|   |   |   |   ├── inspectdb.py
|   |   |   |   ├── loaddata.py
|   |   |   |   ├── makemessages.py
|   |   |   |   ├── makemigrations.py
|   |   |   |   ├── migrate.py
|   |   |   |   ├── runserver.py
|   |   |   |   ├── sendtestemail.py
|   |   |   |   ├── shell.py
|   |   |   |   ├── showmigrations.py
|   |   |   |   ├── sqlflush.py
|   |   |   |   ├── sqlmigrate.py
|   |   |   |   ├── sqlsequencereset.py
|   |   |   |   ├── squashmigrations.py
|   |   |   |   ├── startapp.py
|   |   |   |   ├── startproject.py
|   |   |   |   ├── test.py
|   |   |   |   └── testserver.py
|   |   |   ├── sql.py
|   |   |   ├── templates.py
|   |   |   └── utils.py
|   |   ├── paginator.py
|   |   ├── serializers
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── json.py
|   |   |   ├── python.py
|   |   |   ├── pyyaml.py
|   |   |   └── xml_serializer.py
|   |   ├── servers
|   |   |   ├── __init__.py
|   |   |   └── basehttp.py
|   |   ├── signals.py
|   |   ├── signing.py
|   |   ├── validators.py
|   |   └── wsgi.py
|   ├── db
|   |   ├── __init__.py
|   |   ├── backends
|   |   |   ├── __init__.py
|   |   |   ├── base
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── validation.py
|   |   |   ├── ddl_references.py
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   └── features.py
|   |   |   ├── mysql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── compiler.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── validation.py
|   |   |   ├── oracle
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── functions.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   ├── utils.py
|   |   |   |   └── validation.py
|   |   |   ├── postgresql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── utils.py
|   |   |   ├── signals.py
|   |   |   ├── sqlite3
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   └── schema.py
|   |   |   └── utils.py
|   |   ├── migrations
|   |   |   ├── __init__.py
|   |   |   ├── autodetector.py
|   |   |   ├── exceptions.py
|   |   |   ├── executor.py
|   |   |   ├── graph.py
|   |   |   ├── loader.py
|   |   |   ├── migration.py
|   |   |   ├── operations
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── fields.py
|   |   |   |   ├── models.py
|   |   |   |   ├── special.py
|   |   |   |   └── utils.py
|   |   |   ├── optimizer.py
|   |   |   ├── questioner.py
|   |   |   ├── recorder.py
|   |   |   ├── serializer.py
|   |   |   ├── state.py
|   |   |   ├── utils.py
|   |   |   └── writer.py
|   |   ├── models
|   |   |   ├── __init__.py
|   |   |   ├── aggregates.py
|   |   |   ├── base.py
|   |   |   ├── constants.py
|   |   |   ├── constraints.py
|   |   |   ├── deletion.py
|   |   |   ├── expressions.py
|   |   |   ├── fields
|   |   |   |   ├── __init__.py
|   |   |   |   ├── files.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── proxy.py
|   |   |   |   ├── related.py
|   |   |   |   ├── related_descriptors.py
|   |   |   |   ├── related_lookups.py
|   |   |   |   └── reverse_related.py
|   |   |   ├── functions
|   |   |   |   ├── __init__.py
|   |   |   |   ├── comparison.py
|   |   |   |   ├── datetime.py
|   |   |   |   ├── math.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── text.py
|   |   |   |   └── window.py
|   |   |   ├── indexes.py
|   |   |   ├── lookups.py
|   |   |   ├── manager.py
|   |   |   ├── options.py
|   |   |   ├── query.py
|   |   |   ├── query_utils.py
|   |   |   ├── signals.py
|   |   |   ├── sql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── compiler.py
|   |   |   |   ├── constants.py
|   |   |   |   ├── datastructures.py
|   |   |   |   ├── query.py
|   |   |   |   ├── subqueries.py
|   |   |   |   └── where.py
|   |   |   └── utils.py
|   |   ├── transaction.py
|   |   └── utils.py
|   ├── dispatch
|   |   ├── __init__.py
|   |   ├── dispatcher.py
|   |   └── license.txt
|   ├── forms
|   |   ├── __init__.py
|   |   ├── boundfield.py
|   |   ├── fields.py
|   |   ├── forms.py
|   |   ├── formsets.py
|   |   ├── jinja2
|   |   |   └── django
|   |   |       └── forms
|   |   ├── models.py
|   |   ├── renderers.py
|   |   ├── templates
|   |   |   └── django
|   |   |       └── forms
|   |   ├── utils.py
|   |   └── widgets.py
|   ├── http
|   |   ├── __init__.py
|   |   ├── cookie.py
|   |   ├── multipartparser.py
|   |   ├── request.py
|   |   └── response.py
|   ├── middleware
|   |   ├── __init__.py
|   |   ├── cache.py
|   |   ├── clickjacking.py
|   |   ├── common.py
|   |   ├── csrf.py
|   |   ├── gzip.py
|   |   ├── http.py
|   |   ├── locale.py
|   |   └── security.py
|   ├── shortcuts.py
|   ├── template
|   |   ├── __init__.py
|   |   ├── backends
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── django.py
|   |   |   ├── dummy.py
|   |   |   ├── jinja2.py
|   |   |   └── utils.py
|   |   ├── base.py
|   |   ├── context.py
|   |   ├── context_processors.py
|   |   ├── defaultfilters.py
|   |   ├── defaulttags.py
|   |   ├── engine.py
|   |   ├── exceptions.py
|   |   ├── library.py
|   |   ├── loader.py
|   |   ├── loader_tags.py
|   |   ├── loaders
|   |   |   ├── __init__.py
|   |   |   ├── app_directories.py
|   |   |   ├── base.py
|   |   |   ├── cached.py
|   |   |   ├── filesystem.py
|   |   |   └── locmem.py
|   |   ├── response.py
|   |   ├── smartif.py
|   |   └── utils.py
|   ├── templatetags
|   |   ├── __init__.py
|   |   ├── cache.py
|   |   ├── i18n.py
|   |   ├── l10n.py
|   |   ├── static.py
|   |   └── tz.py
|   ├── test
|   |   ├── __init__.py
|   |   ├── client.py
|   |   ├── html.py
|   |   ├── runner.py
|   |   ├── selenium.py
|   |   ├── signals.py
|   |   ├── testcases.py
|   |   └── utils.py
|   ├── urls
|   |   ├── __init__.py
|   |   ├── base.py
|   |   ├── conf.py
|   |   ├── converters.py
|   |   ├── exceptions.py
|   |   ├── resolvers.py
|   |   └── utils.py
|   ├── utils
|   |   ├── __init__.py
|   |   ├── _os.py
|   |   ├── archive.py
|   |   ├── autoreload.py
|   |   ├── baseconv.py
|   |   ├── cache.py
|   |   ├── crypto.py
|   |   ├── datastructures.py
|   |   ├── dateformat.py
|   |   ├── dateparse.py
|   |   ├── dates.py
|   |   ├── datetime_safe.py
|   |   ├── deconstruct.py
|   |   ├── decorators.py
|   |   ├── deprecation.py
|   |   ├── duration.py
|   |   ├── encoding.py
|   |   ├── feedgenerator.py
|   |   ├── formats.py
|   |   ├── functional.py
|   |   ├── hashable.py
|   |   ├── html.py
|   |   ├── http.py
|   |   ├── inspect.py
|   |   ├── ipv6.py
|   |   ├── itercompat.py
|   |   ├── jslex.py
|   |   ├── log.py
|   |   ├── lorem_ipsum.py
|   |   ├── module_loading.py
|   |   ├── numberformat.py
|   |   ├── regex_helper.py
|   |   ├── safestring.py
|   |   ├── termcolors.py
|   |   ├── text.py
|   |   ├── timesince.py
|   |   ├── timezone.py
|   |   ├── topological_sort.py
|   |   ├── translation
|   |   |   ├── __init__.py
|   |   |   ├── reloader.py
|   |   |   ├── template.py
|   |   |   ├── trans_null.py
|   |   |   └── trans_real.py
|   |   ├── tree.py
|   |   ├── version.py
|   |   └── xmlutils.py
|   └── views
|       ├── __init__.py
|       ├── csrf.py
|       ├── debug.py
|       ├── decorators
|       |   ├── __init__.py
|       |   ├── cache.py
|       |   ├── clickjacking.py
|       |   ├── csrf.py
|       |   ├── debug.py
|       |   ├── gzip.py
|       |   ├── http.py
|       |   └── vary.py
|       ├── defaults.py
|       ├── generic
|       |   ├── __init__.py
|       |   ├── base.py
|       |   ├── dates.py
|       |   ├── detail.py
|       |   ├── edit.py
|       |   └── list.py
|       ├── i18n.py
|       ├── static.py
|       └── templates
|           ├── default_urlconf.html
|           ├── technical_404.html
|           ├── technical_500.html
|           └── technical_500.txt
├── docs
|   ├── _ext
|   |   └── djangodocs.py
|   ├── _theme
|   |   ├── djangodocs
|   |   |   ├── genindex.html
|   |   |   ├── layout.html
|   |   |   ├── modindex.html
|   |   |   ├── search.html
|   |   |   └── static
|   |   |       ├── console-tabs.css
|   |   |       ├── default.css
|   |   |       ├── djangodocs.css
|   |   |       ├── fontawesome
|   |   |       ├── homepage.css
|   |   |       └── reset-fonts-grids.css
|   |   └── djangodocs-epub
|   |       ├── epub-cover.html
|   |       └── static
|   |           └── epub.css
|   ├── conf.py
|   ├── contents.txt
|   ├── faq
|   |   ├── admin.txt
|   |   ├── contributing.txt
|   |   ├── general.txt
|   |   ├── help.txt
|   |   ├── index.txt
|   |   ├── install.txt
|   |   ├── models.txt
|   |   ├── troubleshooting.txt
|   |   └── usage.txt
|   ├── glossary.txt
|   ├── howto
|   |   ├── auth-remote-user.txt
|   |   ├── custom-file-storage.txt
|   |   ├── custom-lookups.txt
|   |   ├── custom-management-commands.txt
|   |   ├── custom-model-fields.txt
|   |   ├── custom-template-tags.txt
|   |   ├── deployment
|   |   |   ├── checklist.txt
|   |   |   ├── index.txt
|   |   |   └── wsgi
|   |   |       ├── apache-auth.txt
|   |   |       ├── gunicorn.txt
|   |   |       ├── index.txt
|   |   |       ├── modwsgi.txt
|   |   |       └── uwsgi.txt
|   |   ├── error-reporting.txt
|   |   ├── index.txt
|   |   ├── initial-data.txt
|   |   ├── jython.txt
|   |   ├── legacy-databases.txt
|   |   ├── outputting-csv.txt
|   |   ├── outputting-pdf.txt
|   |   ├── overriding-templates.txt
|   |   ├── static-files
|   |   |   ├── deployment.txt
|   |   |   └── index.txt
|   |   ├── upgrade-version.txt
|   |   ├── windows.txt
|   |   └── writing-migrations.txt
|   ├── index.txt
|   ├── internals
|   |   ├── _images
|   |   ├── contributing
|   |   |   ├── bugs-and-features.txt
|   |   |   ├── committing-code.txt
|   |   |   ├── index.txt
|   |   |   ├── localizing.txt
|   |   |   ├── new-contributors.txt
|   |   |   ├── triaging-tickets.txt
|   |   |   ├── writing-code
|   |   |   |   ├── coding-style.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── javascript.txt
|   |   |   |   ├── submitting-patches.txt
|   |   |   |   ├── unit-tests.txt
|   |   |   |   └── working-with-git.txt
|   |   |   └── writing-documentation.txt
|   |   ├── deprecation.txt
|   |   ├── git.txt
|   |   ├── howto-release-django.txt
|   |   ├── index.txt
|   |   ├── mailing-lists.txt
|   |   ├── organization.txt
|   |   ├── release-process.txt
|   |   └── security.txt
|   ├── intro
|   |   ├── _images
|   |   ├── contributing.txt
|   |   ├── index.txt
|   |   ├── install.txt
|   |   ├── overview.txt
|   |   ├── reusable-apps.txt
|   |   ├── tutorial01.txt
|   |   ├── tutorial02.txt
|   |   ├── tutorial03.txt
|   |   ├── tutorial04.txt
|   |   ├── tutorial05.txt
|   |   ├── tutorial06.txt
|   |   ├── tutorial07.txt
|   |   └── whatsnext.txt
|   ├── man
|   ├── misc
|   |   ├── api-stability.txt
|   |   ├── design-philosophies.txt
|   |   ├── distributions.txt
|   |   └── index.txt
|   ├── ref
|   |   ├── applications.txt
|   |   ├── checks.txt
|   |   ├── class-based-views
|   |   |   ├── base.txt
|   |   |   ├── flattened-index.txt
|   |   |   ├── generic-date-based.txt
|   |   |   ├── generic-display.txt
|   |   |   ├── generic-editing.txt
|   |   |   ├── index.txt
|   |   |   ├── mixins-date-based.txt
|   |   |   ├── mixins-editing.txt
|   |   |   ├── mixins-multiple-object.txt
|   |   |   ├── mixins-simple.txt
|   |   |   ├── mixins-single-object.txt
|   |   |   └── mixins.txt
|   |   ├── clickjacking.txt
|   |   ├── contrib
|   |   |   ├── admin
|   |   |   |   ├── _images
|   |   |   |   ├── actions.txt
|   |   |   |   ├── admindocs.txt
|   |   |   |   ├── index.txt
|   |   |   |   └── javascript.txt
|   |   |   ├── auth.txt
|   |   |   ├── contenttypes.txt
|   |   |   ├── flatpages.txt
|   |   |   ├── gis
|   |   |   |   ├── admin.txt
|   |   |   |   ├── commands.txt
|   |   |   |   ├── db-api.txt
|   |   |   |   ├── deployment.txt
|   |   |   |   ├── feeds.txt
|   |   |   |   ├── forms-api.txt
|   |   |   |   ├── functions.txt
|   |   |   |   ├── gdal.txt
|   |   |   |   ├── geoip2.txt
|   |   |   |   ├── geoquerysets.txt
|   |   |   |   ├── geos.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── install
|   |   |   |   ├── layermapping.txt
|   |   |   |   ├── measure.txt
|   |   |   |   ├── model-api.txt
|   |   |   |   ├── ogrinspect.txt
|   |   |   |   ├── serializers.txt
|   |   |   |   ├── sitemaps.txt
|   |   |   |   ├── testing.txt
|   |   |   |   ├── tutorial.txt
|   |   |   |   └── utils.txt
|   |   |   ├── humanize.txt
|   |   |   ├── index.txt
|   |   |   ├── messages.txt
|   |   |   ├── postgres
|   |   |   |   ├── aggregates.txt
|   |   |   |   ├── fields.txt
|   |   |   |   ├── forms.txt
|   |   |   |   ├── functions.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── indexes.txt
|   |   |   |   ├── lookups.txt
|   |   |   |   ├── operations.txt
|   |   |   |   ├── search.txt
|   |   |   |   └── validators.txt
|   |   |   ├── redirects.txt
|   |   |   ├── sitemaps.txt
|   |   |   ├── sites.txt
|   |   |   ├── staticfiles.txt
|   |   |   └── syndication.txt
|   |   ├── csrf.txt
|   |   ├── databases.txt
|   |   ├── django-admin.txt
|   |   ├── exceptions.txt
|   |   ├── files
|   |   |   ├── file.txt
|   |   |   ├── index.txt
|   |   |   ├── storage.txt
|   |   |   └── uploads.txt
|   |   ├── forms
|   |   |   ├── api.txt
|   |   |   ├── fields.txt
|   |   |   ├── formsets.txt
|   |   |   ├── index.txt
|   |   |   ├── models.txt
|   |   |   ├── renderers.txt
|   |   |   ├── validation.txt
|   |   |   └── widgets.txt
|   |   ├── index.txt
|   |   ├── middleware.txt
|   |   ├── migration-operations.txt
|   |   ├── models
|   |   |   ├── class.txt
|   |   |   ├── conditional-expressions.txt
|   |   |   ├── constraints.txt
|   |   |   ├── database-functions.txt
|   |   |   ├── expressions.txt
|   |   |   ├── fields.txt
|   |   |   ├── index.txt
|   |   |   ├── indexes.txt
|   |   |   ├── instances.txt
|   |   |   ├── lookups.txt
|   |   |   ├── meta.txt
|   |   |   ├── options.txt
|   |   |   ├── querysets.txt
|   |   |   └── relations.txt
|   |   ├── request-response.txt
|   |   ├── schema-editor.txt
|   |   ├── settings.txt
|   |   ├── signals.txt
|   |   ├── template-response.txt
|   |   ├── templates
|   |   |   ├── api.txt
|   |   |   ├── builtins.txt
|   |   |   ├── index.txt
|   |   |   └── language.txt
|   |   ├── unicode.txt
|   |   ├── urlresolvers.txt
|   |   ├── urls.txt
|   |   ├── utils.txt
|   |   ├── validators.txt
|   |   └── views.txt
|   ├── releases
|   |   ├── 0.95.txt
|   |   ├── 0.96.txt
|   |   ├── 1.0-porting-guide.txt
|   |   ├── 1.0.1.txt
|   |   ├── 1.0.2.txt
|   |   ├── 1.0.txt
|   |   ├── 1.1.2.txt
|   |   ├── 1.1.3.txt
|   |   ├── 1.1.4.txt
|   |   ├── 1.1.txt
|   |   ├── 1.10.1.txt
|   |   ├── 1.10.2.txt
|   |   ├── 1.10.3.txt
|   |   ├── 1.10.4.txt
|   |   ├── 1.10.5.txt
|   |   ├── 1.10.6.txt
|   |   ├── 1.10.7.txt
|   |   ├── 1.10.8.txt
|   |   ├── 1.10.txt
|   |   ├── 1.11.1.txt
|   |   ├── 1.11.10.txt
|   |   ├── 1.11.11.txt
|   |   ├── 1.11.12.txt
|   |   ├── 1.11.13.txt
|   |   ├── 1.11.14.txt
|   |   ├── 1.11.15.txt
|   |   ├── 1.11.16.txt
|   |   ├── 1.11.17.txt
|   |   ├── 1.11.18.txt
|   |   ├── 1.11.19.txt
|   |   ├── 1.11.2.txt
|   |   ├── 1.11.20.txt
|   |   ├── 1.11.21.txt
|   |   ├── 1.11.3.txt
|   |   ├── 1.11.4.txt
|   |   ├── 1.11.5.txt
|   |   ├── 1.11.6.txt
|   |   ├── 1.11.7.txt
|   |   ├── 1.11.8.txt
|   |   ├── 1.11.9.txt
|   |   ├── 1.11.txt
|   |   ├── 1.2.1.txt
|   |   ├── 1.2.2.txt
|   |   ├── 1.2.3.txt
|   |   ├── 1.2.4.txt
|   |   ├── 1.2.5.txt
|   |   ├── 1.2.6.txt
|   |   ├── 1.2.7.txt
|   |   ├── 1.2.txt
|   |   ├── 1.3.1.txt
|   |   ├── 1.3.2.txt
|   |   ├── 1.3.3.txt
|   |   ├── 1.3.4.txt
|   |   ├── 1.3.5.txt
|   |   ├── 1.3.6.txt
|   |   ├── 1.3.7.txt
|   |   ├── 1.3.txt
|   |   ├── 1.4.1.txt
|   |   ├── 1.4.10.txt
|   |   ├── 1.4.11.txt
|   |   ├── 1.4.12.txt
|   |   ├── 1.4.13.txt
|   |   ├── 1.4.14.txt
|   |   ├── 1.4.15.txt
|   |   ├── 1.4.16.txt
|   |   ├── 1.4.17.txt
|   |   ├── 1.4.18.txt
|   |   ├── 1.4.19.txt
|   |   ├── 1.4.2.txt
|   |   ├── 1.4.20.txt
|   |   ├── 1.4.21.txt
|   |   ├── 1.4.22.txt
|   |   ├── 1.4.3.txt
|   |   ├── 1.4.4.txt
|   |   ├── 1.4.5.txt
|   |   ├── 1.4.6.txt
|   |   ├── 1.4.7.txt
|   |   ├── 1.4.8.txt
|   |   ├── 1.4.9.txt
|   |   ├── 1.4.txt
|   |   ├── 1.5.1.txt
|   |   ├── 1.5.10.txt
|   |   ├── 1.5.11.txt
|   |   ├── 1.5.12.txt
|   |   ├── 1.5.2.txt
|   |   ├── 1.5.3.txt
|   |   ├── 1.5.4.txt
|   |   ├── 1.5.5.txt
|   |   ├── 1.5.6.txt
|   |   ├── 1.5.7.txt
|   |   ├── 1.5.8.txt
|   |   ├── 1.5.9.txt
|   |   ├── 1.5.txt
|   |   ├── 1.6.1.txt
|   |   ├── 1.6.10.txt
|   |   ├── 1.6.11.txt
|   |   ├── 1.6.2.txt
|   |   ├── 1.6.3.txt
|   |   ├── 1.6.4.txt
|   |   ├── 1.6.5.txt
|   |   ├── 1.6.6.txt
|   |   ├── 1.6.7.txt
|   |   ├── 1.6.8.txt
|   |   ├── 1.6.9.txt
|   |   ├── 1.6.txt
|   |   ├── 1.7.1.txt
|   |   ├── 1.7.10.txt
|   |   ├── 1.7.11.txt
|   |   ├── 1.7.2.txt
|   |   ├── 1.7.3.txt
|   |   ├── 1.7.4.txt
|   |   ├── 1.7.5.txt
|   |   ├── 1.7.6.txt
|   |   ├── 1.7.7.txt
|   |   ├── 1.7.8.txt
|   |   ├── 1.7.9.txt
|   |   ├── 1.7.txt
|   |   ├── 1.8.1.txt
|   |   ├── 1.8.10.txt
|   |   ├── 1.8.11.txt
|   |   ├── 1.8.12.txt
|   |   ├── 1.8.13.txt
|   |   ├── 1.8.14.txt
|   |   ├── 1.8.15.txt
|   |   ├── 1.8.16.txt
|   |   ├── 1.8.17.txt
|   |   ├── 1.8.18.txt
|   |   ├── 1.8.19.txt
|   |   ├── 1.8.2.txt
|   |   ├── 1.8.3.txt
|   |   ├── 1.8.4.txt
|   |   ├── 1.8.5.txt
|   |   ├── 1.8.6.txt
|   |   ├── 1.8.7.txt
|   |   ├── 1.8.8.txt
|   |   ├── 1.8.9.txt
|   |   ├── 1.8.txt
|   |   ├── 1.9.1.txt
|   |   ├── 1.9.10.txt
|   |   ├── 1.9.11.txt
|   |   ├── 1.9.12.txt
|   |   ├── 1.9.13.txt
|   |   ├── 1.9.2.txt
|   |   ├── 1.9.3.txt
|   |   ├── 1.9.4.txt
|   |   ├── 1.9.5.txt
|   |   ├── 1.9.6.txt
|   |   ├── 1.9.7.txt
|   |   ├── 1.9.8.txt
|   |   ├── 1.9.9.txt
|   |   ├── 1.9.txt
|   |   ├── 2.0.1.txt
|   |   ├── 2.0.10.txt
|   |   ├── 2.0.11.txt
|   |   ├── 2.0.12.txt
|   |   ├── 2.0.13.txt
|   |   ├── 2.0.2.txt
|   |   ├── 2.0.3.txt
|   |   ├── 2.0.4.txt
|   |   ├── 2.0.5.txt
|   |   ├── 2.0.6.txt
|   |   ├── 2.0.7.txt
|   |   ├── 2.0.8.txt
|   |   ├── 2.0.9.txt
|   |   ├── 2.0.txt
|   |   ├── 2.1.1.txt
|   |   ├── 2.1.2.txt
|   |   ├── 2.1.3.txt
|   |   ├── 2.1.4.txt
|   |   ├── 2.1.5.txt
|   |   ├── 2.1.6.txt
|   |   ├── 2.1.7.txt
|   |   ├── 2.1.8.txt
|   |   ├── 2.1.9.txt
|   |   ├── 2.1.txt
|   |   ├── 2.2.1.txt
|   |   ├── 2.2.2.txt
|   |   ├── 2.2.3.txt
|   |   ├── 2.2.txt
|   |   ├── 3.0.txt
|   |   ├── index.txt
|   |   └── security.txt
|   └── topics
|       ├── _images
|       ├── auth
|       |   ├── customizing.txt
|       |   ├── default.txt
|       |   ├── index.txt
|       |   └── passwords.txt
|       ├── cache.txt
|       ├── checks.txt
|       ├── class-based-views
|       |   ├── generic-display.txt
|       |   ├── generic-editing.txt
|       |   ├── index.txt
|       |   ├── intro.txt
|       |   └── mixins.txt
|       ├── conditional-view-processing.txt
|       ├── db
|       |   ├── aggregation.txt
|       |   ├── examples
|       |   |   ├── index.txt
|       |   |   ├── many_to_many.txt
|       |   |   ├── many_to_one.txt
|       |   |   └── one_to_one.txt
|       |   ├── index.txt
|       |   ├── instrumentation.txt
|       |   ├── managers.txt
|       |   ├── models.txt
|       |   ├── multi-db.txt
|       |   ├── optimization.txt
|       |   ├── queries.txt
|       |   ├── search.txt
|       |   ├── sql.txt
|       |   ├── tablespaces.txt
|       |   └── transactions.txt
|       ├── email.txt
|       ├── external-packages.txt
|       ├── files.txt
|       ├── forms
|       |   ├── formsets.txt
|       |   ├── index.txt
|       |   ├── media.txt
|       |   └── modelforms.txt
|       ├── http
|       |   ├── _images
|       |   ├── decorators.txt
|       |   ├── file-uploads.txt
|       |   ├── generic-views.txt
|       |   ├── index.txt
|       |   ├── middleware.txt
|       |   ├── sessions.txt
|       |   ├── shortcuts.txt
|       |   ├── urls.txt
|       |   └── views.txt
|       ├── i18n
|       |   ├── formatting.txt
|       |   ├── index.txt
|       |   ├── timezones.txt
|       |   └── translation.txt
|       ├── index.txt
|       ├── install.txt
|       ├── logging.txt
|       ├── migrations.txt
|       ├── pagination.txt
|       ├── performance.txt
|       ├── security.txt
|       ├── serialization.txt
|       ├── settings.txt
|       ├── signals.txt
|       ├── signing.txt
|       ├── templates.txt
|       └── testing
|           ├── _images
|           ├── advanced.txt
|           ├── index.txt
|           ├── overview.txt
|           └── tools.txt
├── extras
├── js_tests
|   ├── admin
|   |   ├── DateTimeShortcuts.test.js
|   |   ├── RelatedObjectLookups.test.js
|   |   ├── SelectBox.test.js
|   |   ├── SelectFilter2.test.js
|   |   ├── URLify.test.js
|   |   ├── actions.test.js
|   |   ├── core.test.js
|   |   ├── inlines.test.js
|   |   └── jsi18n-mocks.test.js
|   ├── gis
|   |   └── mapwidget.test.js
|   ├── qunit
|   |   ├── qunit.css
|   |   └── qunit.js
|   └── tests.html
├── scripts
|   ├── manage_translations.py
|   └── rpm-install.sh
├── setup.py
└── tests
    ├── README.rst
    ├── absolute_url_overrides
    |   ├── __init__.py
    |   └── tests.py
    ├── admin_autodiscover
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_changelist
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_date_hierarchy.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_checks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_custom_urls
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_default_site
    |   ├── __init__.py
    |   ├── apps.py
    |   ├── sites.py
    |   └── tests.py
    ├── admin_docs
    |   ├── __init__.py
    |   ├── evilfile.txt
    |   ├── models.py
    |   ├── namespace_urls.py
    |   ├── test_middleware.py
    |   ├── test_utils.py
    |   ├── test_views.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── admin_filters
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_inlines
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_templates.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_registration
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_scripts
    |   ├── __init__.py
    |   ├── another_app_waiting_migration
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   └── models.py
    |   ├── app_raising_messages
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app_raising_warning
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app_waiting_migration
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   └── models.py
    |   ├── app_with_import
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── broken_app
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── complex_app
    |   |   ├── __init__.py
    |   |   ├── admin
    |   |   |   ├── __init__.py
    |   |   |   └── foo.py
    |   |   ├── management
    |   |   |   └── commands
    |   |   └── models
    |   |       ├── __init__.py
    |   |       ├── bar.py
    |   |       └── foo.py
    |   ├── configured_dynamic_settings_manage.py
    |   ├── configured_settings_manage.py
    |   ├── custom_templates
    |   |   ├── app_template
    |   |   |   ├── __init__.py
    |   |   |   └── api.py
    |   |   └── project_template
    |   |       ├── additional_dir
    |   |       ├── project_name
    |   |       └── ticket-18091-non-ascii-template.txt
    |   ├── management
    |   |   └── commands
    |   |       ├── app_command.py
    |   |       ├── base_command.py
    |   |       ├── custom_startproject.py
    |   |       ├── label_command.py
    |   |       └── noargs_command.py
    |   ├── simple_app
    |   |   ├── __init__.py
    |   |   ├── management
    |   |   |   └── commands
    |   |   └── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_utils
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_logentry.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_views
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── custom_has_permission_admin.py
    |   ├── customadmin.py
    |   ├── forms.py
    |   ├── models.py
    |   ├── templates
    |   |   ├── admin
    |   |   |   ├── admin_views
    |   |   |   └── base_site.html
    |   |   └── custom_filter_template.html
    |   ├── test_actions.py
    |   ├── test_adminsite.py
    |   ├── test_autocomplete_view.py
    |   ├── test_forms.py
    |   ├── test_multidb.py
    |   ├── test_templatetags.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── admin_widgets
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_autocomplete_widget.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── widgetadmin.py
    ├── aggregation
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_filter_argument.py
    |   └── tests.py
    ├── aggregation_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── annotations
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── app_loading
    |   ├── __init__.py
    |   ├── eggs
    |   ├── not_installed
    |   |   ├── __init__.py
    |   |   └── models.py
    |   └── tests.py
    ├── apps
    |   ├── __init__.py
    |   ├── apps.py
    |   ├── default_config_app
    |   |   ├── __init__.py
    |   |   └── apps.py
    |   ├── models.py
    |   ├── namespace_package_base
    |   |   └── nsapp
    |   |       └── apps.py
    |   ├── namespace_package_other_base
    |   |   └── nsapp
    |   └── tests.py
    ├── auth_tests
    |   ├── __init__.py
    |   ├── backend_alias.py
    |   ├── client.py
    |   ├── common-passwords-custom.txt
    |   ├── fixtures
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── custom_permissions.py
    |   |   ├── custom_user.py
    |   |   ├── invalid_models.py
    |   |   ├── is_active.py
    |   |   ├── minimal.py
    |   |   ├── no_password.py
    |   |   ├── proxy.py
    |   |   ├── uuid_pk.py
    |   |   ├── with_custom_email_field.py
    |   |   ├── with_foreign_key.py
    |   |   ├── with_integer_username.py
    |   |   └── with_last_login_attr.py
    |   ├── settings.py
    |   ├── templates
    |   |   ├── context_processors
    |   |   |   ├── auth_attrs_access.html
    |   |   |   ├── auth_attrs_messages.html
    |   |   |   ├── auth_attrs_no_access.html
    |   |   |   ├── auth_attrs_perm_in_perms.html
    |   |   |   ├── auth_attrs_perms.html
    |   |   |   ├── auth_attrs_test_access.html
    |   |   |   └── auth_attrs_user.html
    |   |   └── registration
    |   |       ├── html_password_reset_email.html
    |   |       ├── logged_out.html
    |   |       ├── login.html
    |   |       ├── password_change_form.html
    |   |       ├── password_reset_complete.html
    |   |       ├── password_reset_confirm.html
    |   |       ├── password_reset_done.html
    |   |       ├── password_reset_email.html
    |   |       ├── password_reset_form.html
    |   |       └── password_reset_subject.txt
    |   ├── test_admin_multidb.py
    |   ├── test_auth_backends.py
    |   ├── test_basic.py
    |   ├── test_checks.py
    |   ├── test_context_processors.py
    |   ├── test_decorators.py
    |   ├── test_forms.py
    |   ├── test_handlers.py
    |   ├── test_hashers.py
    |   ├── test_management.py
    |   ├── test_middleware.py
    |   ├── test_migrations.py
    |   ├── test_mixins.py
    |   ├── test_models.py
    |   ├── test_remote_user.py
    |   ├── test_remote_user_deprecation.py
    |   ├── test_signals.py
    |   ├── test_templates.py
    |   ├── test_tokens.py
    |   ├── test_validators.py
    |   ├── test_views.py
    |   ├── urls.py
    |   ├── urls_admin.py
    |   └── urls_custom_user_admin.py
    ├── backends
    |   ├── __init__.py
    |   ├── base
    |   |   ├── __init__.py
    |   |   ├── test_base.py
    |   |   ├── test_creation.py
    |   |   ├── test_features.py
    |   |   ├── test_operations.py
    |   |   └── test_schema.py
    |   ├── models.py
    |   ├── mysql
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_features.py
    |   |   ├── test_schema.py
    |   |   └── tests.py
    |   ├── oracle
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_introspection.py
    |   |   ├── test_operations.py
    |   |   └── tests.py
    |   ├── postgresql
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_introspection.py
    |   |   ├── test_server_side_cursors.py
    |   |   └── tests.py
    |   ├── sqlite
    |   |   ├── __init__.py
    |   |   ├── test_introspection.py
    |   |   └── tests.py
    |   ├── test_ddl_references.py
    |   ├── test_utils.py
    |   └── tests.py
    ├── base
    |   ├── __init__.py
    |   └── models.py
    ├── bash_completion
    |   ├── __init__.py
    |   ├── management
    |   |   └── commands
    |   |       └── test_command.py
    |   └── tests.py
    ├── basic
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── builtin_server
    |   ├── __init__.py
    |   └── tests.py
    ├── bulk_create
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── cache
    |   ├── __init__.py
    |   ├── closeable_cache.py
    |   ├── liberal_backend.py
    |   ├── models.py
    |   └── tests.py
    ├── check_framework
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_caches.py
    |   ├── test_database.py
    |   ├── test_model_checks.py
    |   ├── test_model_field_deprecation.py
    |   ├── test_multi_db.py
    |   ├── test_security.py
    |   ├── test_templates.py
    |   ├── test_translation.py
    |   ├── test_urls.py
    |   ├── tests.py
    |   └── urls
    |       ├── __init__.py
    |       ├── bad_error_handlers.py
    |       ├── bad_error_handlers_invalid_path.py
    |       ├── beginning_with_slash.py
    |       ├── contains_tuple.py
    |       ├── good_error_handlers.py
    |       ├── include_contains_tuple.py
    |       ├── include_with_dollar.py
    |       ├── name_with_colon.py
    |       ├── no_warnings.py
    |       ├── no_warnings_i18n.py
    |       ├── non_unique_namespaces.py
    |       ├── path_compatibility
    |       |   ├── __init__.py
    |       |   ├── beginning_with_caret.py
    |       |   ├── contains_re_named_group.py
    |       |   └── ending_with_dollar.py
    |       ├── unique_namespaces.py
    |       └── warning_in_include.py
    ├── conditional_processing
    |   ├── __init__.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── constraints
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── contenttypes_tests
    |   ├── __init__.py
    |   ├── models.py
    |   ├── operations_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_rename_foo.py
    |   |   └── __init__.py
    |   ├── test_checks.py
    |   ├── test_fields.py
    |   ├── test_management.py
    |   ├── test_models.py
    |   ├── test_operations.py
    |   ├── test_order_with_respect_to.py
    |   ├── test_views.py
    |   └── urls.py
    ├── context_processors
    |   ├── __init__.py
    |   ├── models.py
    |   ├── templates
    |   |   └── context_processors
    |   |       ├── debug.html
    |   |       └── request_attrs.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── csrf_tests
    |   ├── __init__.py
    |   ├── csrf_token_error_handler_urls.py
    |   ├── test_context_processor.py
    |   ├── tests.py
    |   └── views.py
    ├── custom_columns
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_lookups
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_managers
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_methods
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_migration_operations
    |   ├── __init__.py
    |   ├── more_operations.py
    |   └── operations.py
    ├── custom_pk
    |   ├── __init__.py
    |   ├── fields.py
    |   ├── models.py
    |   └── tests.py
    ├── datatypes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── dates
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── datetimes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── db_functions
    |   ├── __init__.py
    |   ├── comparison
    |   |   ├── __init__.py
    |   |   ├── test_cast.py
    |   |   ├── test_coalesce.py
    |   |   ├── test_greatest.py
    |   |   ├── test_least.py
    |   |   └── test_nullif.py
    |   ├── datetime
    |   |   ├── __init__.py
    |   |   ├── test_extract_trunc.py
    |   |   └── test_now.py
    |   ├── math
    |   |   ├── __init__.py
    |   |   ├── test_abs.py
    |   |   ├── test_acos.py
    |   |   ├── test_asin.py
    |   |   ├── test_atan.py
    |   |   ├── test_atan2.py
    |   |   ├── test_ceil.py
    |   |   ├── test_cos.py
    |   |   ├── test_cot.py
    |   |   ├── test_degrees.py
    |   |   ├── test_exp.py
    |   |   ├── test_floor.py
    |   |   ├── test_ln.py
    |   |   ├── test_log.py
    |   |   ├── test_mod.py
    |   |   ├── test_pi.py
    |   |   ├── test_power.py
    |   |   ├── test_radians.py
    |   |   ├── test_round.py
    |   |   ├── test_sign.py
    |   |   ├── test_sin.py
    |   |   ├── test_sqrt.py
    |   |   └── test_tan.py
    |   ├── migrations
    |   |   ├── 0001_setup_extensions.py
    |   |   ├── 0002_create_test_models.py
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   ├── text
    |   |   ├── __init__.py
    |   |   ├── test_chr.py
    |   |   ├── test_concat.py
    |   |   ├── test_left.py
    |   |   ├── test_length.py
    |   |   ├── test_lower.py
    |   |   ├── test_md5.py
    |   |   ├── test_ord.py
    |   |   ├── test_pad.py
    |   |   ├── test_repeat.py
    |   |   ├── test_replace.py
    |   |   ├── test_reverse.py
    |   |   ├── test_right.py
    |   |   ├── test_sha1.py
    |   |   ├── test_sha224.py
    |   |   ├── test_sha256.py
    |   |   ├── test_sha384.py
    |   |   ├── test_sha512.py
    |   |   ├── test_strindex.py
    |   |   ├── test_substr.py
    |   |   ├── test_trim.py
    |   |   └── test_upper.py
    |   └── window
    |       ├── __init__.py
    |       └── test_validation.py
    ├── db_typecasts
    |   ├── __init__.py
    |   └── tests.py
    ├── db_utils
    |   ├── __init__.py
    |   └── tests.py
    ├── dbshell
    |   ├── __init__.py
    |   ├── test_mysql.py
    |   ├── test_oracle.py
    |   └── test_postgresql.py
    ├── decorators
    |   ├── __init__.py
    |   └── tests.py
    ├── defer
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── defer_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── delete
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── delete_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── deprecation
    |   ├── __init__.py
    |   └── tests.py
    ├── dispatch
    |   ├── __init__.py
    |   └── tests.py
    ├── distinct_on_fields
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── empty
    |   ├── __init__.py
    |   ├── models.py
    |   ├── no_models
    |   |   └── __init__.py
    |   └── tests.py
    ├── expressions
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_deprecation.py
    |   ├── test_queryset_values.py
    |   └── tests.py
    ├── expressions_case
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── expressions_window
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── extra_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── field_deconstruction
    |   ├── __init__.py
    |   └── tests.py
    ├── field_defaults
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── field_subclassing
    |   ├── __init__.py
    |   ├── fields.py
    |   └── tests.py
    ├── file_storage
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_generate_filename.py
    |   ├── tests.py
    |   └── urls.py
    ├── file_uploads
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   ├── uploadhandler.py
    |   ├── urls.py
    |   └── views.py
    ├── files
    |   ├── __init__.py
    |   └── tests.py
    ├── filtered_relation
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── fixtures
    |   ├── __init__.py
    |   ├── fixtures
    |   |   ├── fixture2.xml
    |   |   ├── fixture3.xml
    |   |   ├── fixture7.xml
    |   |   └── fixture9.xml
    |   ├── models.py
    |   └── tests.py
    ├── fixtures_model_package
    |   ├── __init__.py
    |   ├── fixtures
    |   |   └── fixture2.xml
    |   ├── models
    |   |   └── __init__.py
    |   └── tests.py
    ├── fixtures_regress
    |   ├── __init__.py
    |   ├── fixtures
    |   |   ├── animal.xml
    |   |   ├── bad_fixture2.xml
    |   |   ├── nk-inheritance2.xml
    |   |   ├── non_natural_2.xml
    |   |   ├── pretty.xml
    |   |   └── sequence_extra_xml.xml
    |   ├── fixtures_1
    |   |   └── inner
    |   ├── fixtures_2
    |   ├── models.py
    |   └── tests.py
    ├── flatpages_tests
    |   ├── __init__.py
    |   ├── settings.py
    |   ├── templates
    |   |   ├── flatpages
    |   |   |   └── default.html
    |   |   └── registration
    |   |       └── login.html
    |   ├── test_csrf.py
    |   ├── test_forms.py
    |   ├── test_middleware.py
    |   ├── test_models.py
    |   ├── test_sitemaps.py
    |   ├── test_templatetags.py
    |   ├── test_views.py
    |   └── urls.py
    ├── force_insert_update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── foreign_object
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── article.py
    |   |   ├── customers.py
    |   |   ├── empty_join.py
    |   |   └── person.py
    |   ├── test_agnostic_order_trimjoin.py
    |   ├── test_empty_join.py
    |   ├── test_forms.py
    |   └── tests.py
    ├── forms_tests
    |   ├── __init__.py
    |   ├── field_tests
    |   |   ├── __init__.py
    |   |   ├── filepathfield_test_dir
    |   |   |   ├── __init__.py
    |   |   |   ├── a.py
    |   |   |   ├── ab.py
    |   |   |   ├── b.py
    |   |   |   ├── c
    |   |   |   ├── h
    |   |   |   └── j
    |   |   ├── test_base.py
    |   |   ├── test_booleanfield.py
    |   |   ├── test_charfield.py
    |   |   ├── test_choicefield.py
    |   |   ├── test_combofield.py
    |   |   ├── test_datefield.py
    |   |   ├── test_datetimefield.py
    |   |   ├── test_decimalfield.py
    |   |   ├── test_durationfield.py
    |   |   ├── test_emailfield.py
    |   |   ├── test_filefield.py
    |   |   ├── test_filepathfield.py
    |   |   ├── test_floatfield.py
    |   |   ├── test_genericipaddressfield.py
    |   |   ├── test_imagefield.py
    |   |   ├── test_integerfield.py
    |   |   ├── test_multiplechoicefield.py
    |   |   ├── test_multivaluefield.py
    |   |   ├── test_nullbooleanfield.py
    |   |   ├── test_regexfield.py
    |   |   ├── test_slugfield.py
    |   |   ├── test_splitdatetimefield.py
    |   |   ├── test_timefield.py
    |   |   ├── test_typedchoicefield.py
    |   |   ├── test_typedmultiplechoicefield.py
    |   |   ├── test_urlfield.py
    |   |   └── test_uuidfield.py
    |   ├── jinja2
    |   |   └── forms_tests
    |   |       └── custom_widget.html
    |   ├── models.py
    |   ├── templates
    |   |   └── forms_tests
    |   |       ├── article_form.html
    |   |       └── custom_widget.html
    |   ├── tests
    |   |   ├── __init__.py
    |   |   ├── filepath_test_files
    |   |   |   ├── directory
    |   |   |   └── real-text-file.txt
    |   |   ├── test_error_messages.py
    |   |   ├── test_forms.py
    |   |   ├── test_formsets.py
    |   |   ├── test_i18n.py
    |   |   ├── test_input_formats.py
    |   |   ├── test_media.py
    |   |   ├── test_renderers.py
    |   |   ├── test_utils.py
    |   |   ├── test_validators.py
    |   |   ├── test_widgets.py
    |   |   └── tests.py
    |   ├── urls.py
    |   ├── views.py
    |   └── widget_tests
    |       ├── __init__.py
    |       ├── base.py
    |       ├── test_checkboxinput.py
    |       ├── test_checkboxselectmultiple.py
    |       ├── test_clearablefileinput.py
    |       ├── test_dateinput.py
    |       ├── test_datetimeinput.py
    |       ├── test_fileinput.py
    |       ├── test_hiddeninput.py
    |       ├── test_input.py
    |       ├── test_multiplehiddeninput.py
    |       ├── test_multiwidget.py
    |       ├── test_nullbooleanselect.py
    |       ├── test_numberinput.py
    |       ├── test_passwordinput.py
    |       ├── test_radioselect.py
    |       ├── test_select.py
    |       ├── test_selectdatewidget.py
    |       ├── test_selectmultiple.py
    |       ├── test_splitdatetimewidget.py
    |       ├── test_splithiddendatetimewidget.py
    |       ├── test_textarea.py
    |       ├── test_textinput.py
    |       ├── test_timeinput.py
    |       └── test_widget.py
    ├── from_db_value
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── generic_inline_admin
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── generic_relations
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_forms.py
    |   └── tests.py
    ├── generic_relations_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── generic_views
    |   ├── __init__.py
    |   ├── forms.py
    |   ├── jinja2
    |   |   └── generic_views
    |   |       └── using.html
    |   ├── models.py
    |   ├── templates
    |   |   ├── generic_views
    |   |   |   ├── about.html
    |   |   |   ├── apple_detail.html
    |   |   |   ├── artist_detail.html
    |   |   |   ├── artist_form.html
    |   |   |   ├── author_confirm_delete.html
    |   |   |   ├── author_detail.html
    |   |   |   ├── author_form.html
    |   |   |   ├── author_list.html
    |   |   |   ├── author_objects.html
    |   |   |   ├── author_view.html
    |   |   |   ├── book_archive.html
    |   |   |   ├── book_archive_day.html
    |   |   |   ├── book_archive_month.html
    |   |   |   ├── book_archive_week.html
    |   |   |   ├── book_archive_year.html
    |   |   |   ├── book_detail.html
    |   |   |   ├── book_list.html
    |   |   |   ├── confirm_delete.html
    |   |   |   ├── detail.html
    |   |   |   ├── form.html
    |   |   |   ├── list.html
    |   |   |   ├── page_template.html
    |   |   |   ├── robots.txt
    |   |   |   └── using.html
    |   |   └── registration
    |   |       └── login.html
    |   ├── test_base.py
    |   ├── test_dates.py
    |   ├── test_detail.py
    |   ├── test_edit.py
    |   ├── test_list.py
    |   ├── urls.py
    |   └── views.py
    ├── get_earliest_or_latest
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── get_object_or_404
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── get_or_create
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── gis_tests
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── data
    |   |   ├── __init__.py
    |   |   ├── ch-city
    |   |   ├── cities
    |   |   ├── counties
    |   |   ├── gas_lines
    |   |   ├── has_nulls
    |   |   ├── interstates
    |   |   ├── invalid
    |   |   ├── rasters
    |   |   |   ├── __init__.py
    |   |   |   ├── raster.numpy.txt
    |   |   |   └── textrasters.py
    |   |   ├── test_point
    |   |   ├── test_poly
    |   |   └── test_vrt
    |   ├── distapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── gdal_tests
    |   |   ├── __init__.py
    |   |   ├── test_driver.py
    |   |   ├── test_ds.py
    |   |   ├── test_envelope.py
    |   |   ├── test_geom.py
    |   |   ├── test_raster.py
    |   |   └── test_srs.py
    |   ├── geo3d
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   ├── tests.py
    |   |   └── views.py
    |   ├── geoadmin
    |   |   ├── __init__.py
    |   |   ├── admin.py
    |   |   ├── models.py
    |   |   ├── tests.py
    |   |   └── urls.py
    |   ├── geoapp
    |   |   ├── __init__.py
    |   |   ├── feeds.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   ├── sitemaps.py
    |   |   ├── test_expressions.py
    |   |   ├── test_feeds.py
    |   |   ├── test_functions.py
    |   |   ├── test_regress.py
    |   |   ├── test_serializers.py
    |   |   ├── test_sitemaps.py
    |   |   ├── tests.py
    |   |   └── urls.py
    |   ├── geogapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── geos_tests
    |   |   ├── __init__.py
    |   |   ├── test_coordseq.py
    |   |   ├── test_geos.py
    |   |   ├── test_geos_mutation.py
    |   |   ├── test_io.py
    |   |   └── test_mutable_list.py
    |   ├── gis_migrations
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   ├── test_commands.py
    |   |   └── test_operations.py
    |   ├── inspectapp
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── layermap
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── maps
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── rasterapp
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── test_rasterfield.py
    |   ├── relatedapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── test_data.py
    |   ├── test_fields.py
    |   ├── test_geoforms.py
    |   ├── test_geoip2.py
    |   ├── test_gis_tests_utils.py
    |   ├── test_measure.py
    |   ├── test_ptr.py
    |   ├── test_spatialrefsys.py
    |   ├── tests.py
    |   └── utils.py
    ├── handlers
    |   ├── __init__.py
    |   ├── templates
    |   |   └── test_handler.html
    |   ├── test_exception.py
    |   ├── tests.py
    |   ├── tests_custom_error_handlers.py
    |   ├── urls.py
    |   └── views.py
    ├── httpwrappers
    |   ├── __init__.py
    |   ├── abc.txt
    |   └── tests.py
    ├── humanize_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── i18n
    |   ├── __init__.py
    |   ├── commands
    |   |   ├── __init__.py
    |   |   ├── app_with_locale
    |   |   |   └── locale
    |   |   ├── ignore_dir
    |   |   |   └── ignored.html
    |   |   ├── javascript.js
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   ├── es_AR
    |   |   |   ├── fr
    |   |   |   ├── hr
    |   |   |   ├── ja
    |   |   |   ├── ko
    |   |   |   ├── pt_BR
    |   |   |   ├── ru
    |   |   |   └── xxx
    |   |   ├── media_root
    |   |   |   └── media_ignored.html
    |   |   ├── someapp
    |   |   |   └── static
    |   |   ├── static
    |   |   |   ├── javascript_ignored.js
    |   |   |   └── static_ignored.html
    |   |   └── templates
    |   |       ├── empty.html
    |   |       ├── subdir
    |   |       ├── test.html
    |   |       └── xxx_ignored.html
    |   ├── contenttypes
    |   |   ├── __init__.py
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   └── fr
    |   |   └── tests.py
    |   ├── exclude
    |   |   ├── __init__.py
    |   |   └── canned_locale
    |   |       ├── en
    |   |       ├── fr
    |   |       └── it
    |   ├── forms.py
    |   ├── models.py
    |   ├── other
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       ├── de
    |   |       └── fr
    |   ├── other2
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       └── de
    |   ├── patterns
    |   |   ├── __init__.py
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   ├── nl
    |   |   |   └── pt_BR
    |   |   ├── templates
    |   |   |   ├── 404.html
    |   |   |   └── dummy.html
    |   |   ├── tests.py
    |   |   └── urls
    |   |       ├── __init__.py
    |   |       ├── default.py
    |   |       ├── disabled.py
    |   |       ├── included.py
    |   |       ├── namespace.py
    |   |       ├── path_unused.py
    |   |       ├── wrong.py
    |   |       └── wrong_namespace.py
    |   ├── project_dir
    |   |   ├── __init__.py
    |   |   ├── app_no_locale
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── app_with_locale
    |   |   |   ├── __init__.py
    |   |   |   ├── locale
    |   |   |   └── models.py
    |   |   └── project_locale
    |   ├── resolution
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── de
    |   ├── sampleproject
    |   |   ├── locale
    |   |   |   └── fr
    |   |   ├── manage.py
    |   |   ├── sampleproject
    |   |   |   ├── __init__.py
    |   |   |   └── settings.py
    |   |   ├── templates
    |   |   |   └── percents.html
    |   |   └── update_catalogs.py
    |   ├── territorial_fallback
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── de
    |   |       └── de_DE
    |   ├── test_compilation.py
    |   ├── test_extraction.py
    |   ├── test_management.py
    |   ├── test_percents.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── urls_default_unprefixed.py
    |   └── utils.py
    ├── import_error_package
    |   └── __init__.py
    ├── indexes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── inline_formsets
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── inspectdb
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── introspection
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── invalid_models_tests
    |   ├── __init__.py
    |   ├── test_backend_specific.py
    |   ├── test_custom_fields.py
    |   ├── test_deprecated_fields.py
    |   ├── test_models.py
    |   ├── test_ordinary_fields.py
    |   └── test_relative_fields.py
    ├── known_related_objects
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── logging_tests
    |   ├── __init__.py
    |   ├── logconfig.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── urls_i18n.py
    |   └── views.py
    ├── lookup
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_decimalfield.py
    |   ├── test_lookups.py
    |   ├── test_timefield.py
    |   └── tests.py
    ├── m2m_and_m2o
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_intermediary
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_multiple
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_recursive
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_signals
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_through
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_through_regress
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── test_multitable.py
    |   └── tests.py
    ├── m2o_recursive
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── mail
    |   ├── __init__.py
    |   ├── attachments
    |   |   ├── file.txt
    |   |   └── file_png.txt
    |   ├── custombackend.py
    |   ├── test_sendtestemail.py
    |   └── tests.py
    ├── managers_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_many
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_one
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_one_null
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── max_lengths
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── messages_tests
    |   ├── __init__.py
    |   ├── base.py
    |   ├── test_api.py
    |   ├── test_cookie.py
    |   ├── test_fallback.py
    |   ├── test_middleware.py
    |   ├── test_mixins.py
    |   ├── test_session.py
    |   └── urls.py
    ├── middleware
    |   ├── __init__.py
    |   ├── cond_get_urls.py
    |   ├── extra_urls.py
    |   ├── test_security.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── middleware_exceptions
    |   ├── __init__.py
    |   ├── middleware.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── migrate_signals
    |   ├── __init__.py
    |   ├── custom_migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── migration_test_data_persistence
    |   ├── __init__.py
    |   ├── migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_add_book.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── migrations
    |   ├── __init__.py
    |   ├── deprecated_field_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_remove_ipaddressfield_ip.py
    |   |   └── __init__.py
    |   ├── faulty_migrations
    |   |   ├── __init__.py
    |   |   ├── file.py
    |   |   └── namespace
    |   |       └── foo
    |   ├── migrations_test_apps
    |   |   ├── __init__.py
    |   |   ├── alter_fk
    |   |   |   ├── __init__.py
    |   |   |   ├── author_app
    |   |   |   └── book_app
    |   |   ├── conflicting_app_with_dependencies
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── lookuperror_a
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── lookuperror_b
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── lookuperror_c
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── migrated_app
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── migrated_unapplied_app
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── mutate_state_a
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── mutate_state_b
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── normal
    |   |   |   └── __init__.py
    |   |   ├── unmigrated_app
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unmigrated_app_simple
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unmigrated_app_syncdb
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unspecified_app_with_conflict
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── with_package_model
    |   |   |   ├── __init__.py
    |   |   |   └── models
    |   |   └── without_init_file
    |   |       ├── __init__.py
    |   |       └── migrations
    |   ├── models.py
    |   ├── related_models_app
    |   |   └── __init__.py
    |   ├── routers.py
    |   ├── test_add_many_to_many_field_initial
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_initial.py
    |   |   └── __init__.py
    |   ├── test_auto_now_add
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_autodetector.py
    |   ├── test_base.py
    |   ├── test_commands.py
    |   ├── test_deprecated_fields.py
    |   ├── test_exceptions.py
    |   ├── test_executor.py
    |   ├── test_graph.py
    |   ├── test_loader.py
    |   ├── test_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_atomic_operation
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_backwards_deps_1
    |   |   ├── 0001_initial.py
    |   |   └── 0002_second.py
    |   ├── test_migrations_bad_pyc
    |   |   └── __init__.py
    |   ├── test_migrations_clashing_prefix
    |   |   ├── __init__.py
    |   |   ├── a.py
    |   |   └── ab.py
    |   ├── test_migrations_conflict
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_conflicting_second.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_custom_user
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_empty
    |   |   └── __init__.py
    |   ├── test_migrations_fake_split_initial
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_first
    |   |   ├── __init__.py
    |   |   ├── second.py
    |   |   └── thefirst.py
    |   ├── test_migrations_initial_false
    |   |   ├── 0001_not_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_ancestor
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_conflicting_second.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_changes
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_default
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_init
    |   ├── test_migrations_non_atomic
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_order
    |   |   ├── 0001.py
    |   |   └── __init__.py
    |   ├── test_migrations_plan
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   ├── 0004_fourth.py
    |   |   └── __init__.py
    |   ├── test_migrations_private
    |   |   ├── .util.py
    |   |   ├── 0001_initial.py
    |   |   ├── __init__.py
    |   |   ├── _util.py
    |   |   └── ~util.py
    |   ├── test_migrations_run_before
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed
    |   |   ├── 0001_initial.py
    |   |   ├── 0001_squashed_0002.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_complex
    |   |   ├── 1_auto.py
    |   |   ├── 2_auto.py
    |   |   ├── 3_auto.py
    |   |   ├── 3_squashed_5.py
    |   |   ├── 4_auto.py
    |   |   ├── 5_auto.py
    |   |   ├── 6_auto.py
    |   |   ├── 7_auto.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_complex_multi_apps
    |   |   ├── __init__.py
    |   |   ├── app1
    |   |   |   ├── 1_auto.py
    |   |   |   ├── 2_auto.py
    |   |   |   ├── 2_squashed_3.py
    |   |   |   ├── 3_auto.py
    |   |   |   ├── 4_auto.py
    |   |   |   └── __init__.py
    |   |   └── app2
    |   |       ├── 1_auto.py
    |   |       ├── 1_squashed_2.py
    |   |       ├── 2_auto.py
    |   |       └── __init__.py
    |   ├── test_migrations_squashed_erroneous
    |   |   ├── 1_auto.py
    |   |   ├── 2_auto.py
    |   |   ├── 3_squashed_5.py
    |   |   ├── 6_auto.py
    |   |   ├── 7_auto.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_extra
    |   |   ├── 0001_initial.py
    |   |   ├── 0001_squashed_0002.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_ref_squashed
    |   |   ├── __init__.py
    |   |   ├── app1
    |   |   |   ├── 1_auto.py
    |   |   |   ├── 2_auto.py
    |   |   |   ├── 2_squashed_3.py
    |   |   |   ├── 3_auto.py
    |   |   |   ├── 4_auto.py
    |   |   |   └── __init__.py
    |   |   └── app2
    |   |       ├── 1_auto.py
    |   |       ├── 1_squashed_2.py
    |   |       ├── 2_auto.py
    |   |       └── __init__.py
    |   ├── test_migrations_unmigdep
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_multidb.py
    |   ├── test_operations.py
    |   ├── test_optimizer.py
    |   ├── test_questioner.py
    |   ├── test_state.py
    |   └── test_writer.py
    ├── migrations2
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_migrations_2
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_2_first
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   └── test_migrations_2_no_deps
    |       ├── 0001_initial.py
    |       └── __init__.py
    ├── model_fields
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_binaryfield.py
    |   ├── test_booleanfield.py
    |   ├── test_charfield.py
    |   ├── test_datetimefield.py
    |   ├── test_decimalfield.py
    |   ├── test_durationfield.py
    |   ├── test_field_flags.py
    |   ├── test_filefield.py
    |   ├── test_filepathfield.py
    |   ├── test_floatfield.py
    |   ├── test_foreignkey.py
    |   ├── test_genericipaddressfield.py
    |   ├── test_imagefield.py
    |   ├── test_integerfield.py
    |   ├── test_manytomanyfield.py
    |   ├── test_promises.py
    |   ├── test_slugfield.py
    |   ├── test_textfield.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_forms
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_modelchoicefield.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_formsets
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_formsets_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_indexes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_inheritance
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_abstract_inheritance.py
    |   └── tests.py
    ├── model_inheritance_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_meta
    |   ├── __init__.py
    |   ├── models.py
    |   ├── results.py
    |   └── tests.py
    ├── model_options
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── default_related_name.py
    |   |   └── tablespaces.py
    |   ├── test_default_related_name.py
    |   └── test_tablespaces.py
    ├── model_package
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── article.py
    |   |   └── publication.py
    |   └── tests.py
    ├── model_regress
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_pickle.py
    |   ├── test_state.py
    |   └── tests.py
    ├── modeladmin
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_actions.py
    |   ├── test_checks.py
    |   └── tests.py
    ├── multiple_database
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── routers.py
    |   └── tests.py
    ├── mutually_referential
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── nested_foreign_keys
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── no_models
    |   ├── __init__.py
    |   └── tests.py
    ├── null_fk
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── null_fk_ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── null_queries
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── one_to_one
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── or_lookups
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── order_with_respect_to
    |   ├── __init__.py
    |   ├── base_tests.py
    |   ├── models.py
    |   └── tests.py
    ├── ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── pagination
    |   ├── __init__.py
    |   ├── custom.py
    |   ├── models.py
    |   └── tests.py
    ├── postgres_tests
    |   ├── __init__.py
    |   ├── array_default_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_integerarraymodel_field_2.py
    |   |   └── __init__.py
    |   ├── array_index_migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── fields.py
    |   ├── integration_settings.py
    |   ├── migrations
    |   |   ├── 0001_setup_extensions.py
    |   |   ├── 0002_create_test_models.py
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── test_aggregates.py
    |   ├── test_apps.py
    |   ├── test_array.py
    |   ├── test_bulk_update.py
    |   ├── test_citext.py
    |   ├── test_constraints.py
    |   ├── test_functions.py
    |   ├── test_hstore.py
    |   ├── test_indexes.py
    |   ├── test_integration.py
    |   ├── test_introspection.py
    |   ├── test_json.py
    |   ├── test_ranges.py
    |   ├── test_search.py
    |   ├── test_signals.py
    |   ├── test_trigram.py
    |   └── test_unaccent.py
    ├── prefetch_related
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_prefetch_related_objects.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── project_template
    |   ├── __init__.py
    |   ├── test_settings.py
    |   ├── urls.py
    |   └── views.py
    ├── properties
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── proxy_model_inheritance
    |   ├── __init__.py
    |   ├── app1
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app2
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── models.py
    |   └── tests.py
    ├── proxy_models
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── queries
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_bulk_update.py
    |   ├── test_explain.py
    |   ├── test_iterator.py
    |   ├── test_q.py
    |   ├── test_qs_combinators.py
    |   ├── test_query.py
    |   └── tests.py
    ├── queryset_pickle
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── raw_query
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── redirects_tests
    |   ├── __init__.py
    |   ├── tests.py
    |   └── urls.py
    ├── requests
    |   ├── __init__.py
    |   ├── test_data_upload_settings.py
    |   └── tests.py
    ├── requirements
    |   ├── mysql.txt
    |   ├── oracle.txt
    |   ├── postgres.txt
    |   └── py3.txt
    ├── reserved_names
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── resolve_url
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── responses
    |   ├── __init__.py
    |   ├── test_cookie.py
    |   ├── test_fileresponse.py
    |   └── tests.py
    ├── reverse_lookup
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── runtests.py
    ├── save_delete_hooks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── schema
    |   ├── __init__.py
    |   ├── fields.py
    |   ├── models.py
    |   ├── test_logging.py
    |   └── tests.py
    ├── select_for_update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related_onetoone
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── serializers
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── base.py
    |   |   ├── data.py
    |   |   ├── multi_table.py
    |   |   └── natural.py
    |   ├── test_data.py
    |   ├── test_deserializedobject.py
    |   ├── test_json.py
    |   ├── test_natural.py
    |   ├── test_xml.py
    |   ├── test_yaml.py
    |   └── tests.py
    ├── servers
    |   ├── __init__.py
    |   ├── another_app
    |   |   ├── __init__.py
    |   |   └── static
    |   |       └── another_app
    |   ├── fixtures
    |   ├── media
    |   |   └── example_media_file.txt
    |   ├── models.py
    |   ├── static
    |   |   └── example_static_file.txt
    |   ├── test_basehttp.py
    |   ├── test_liveserverthread.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── sessions_tests
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── settings_tests
    |   ├── __init__.py
    |   ├── test_file_charset.py
    |   └── tests.py
    ├── shell
    |   ├── __init__.py
    |   └── tests.py
    ├── shortcuts
    |   ├── __init__.py
    |   ├── jinja2
    |   |   └── shortcuts
    |   |       └── using.html
    |   ├── templates
    |   |   └── shortcuts
    |   |       ├── render_test.html
    |   |       └── using.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── signals
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── signed_cookies_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── signing
    |   ├── __init__.py
    |   └── tests.py
    ├── sitemaps_tests
    |   ├── __init__.py
    |   ├── base.py
    |   ├── models.py
    |   ├── templates
    |   |   ├── custom_sitemap.xml
    |   |   └── custom_sitemap_index.xml
    |   ├── test_generic.py
    |   ├── test_http.py
    |   ├── test_https.py
    |   ├── test_management.py
    |   ├── test_utils.py
    |   └── urls
    |       ├── __init__.py
    |       ├── empty.py
    |       ├── http.py
    |       ├── https.py
    |       └── index_only.py
    ├── sites_framework
    |   ├── __init__.py
    |   ├── migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── sites_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── staticfiles_tests
    |   ├── __init__.py
    |   ├── apps
    |   |   ├── __init__.py
    |   |   ├── no_label
    |   |   |   ├── __init__.py
    |   |   |   └── static
    |   |   ├── staticfiles_config.py
    |   |   └── test
    |   |       ├── __init__.py
    |   |       ├── otherdir
    |   |       └── static
    |   ├── cases.py
    |   ├── project
    |   |   ├── documents
    |   |   |   ├── absolute_root.css
    |   |   |   ├── cached
    |   |   |   ├── styles_root.css
    |   |   |   ├── subdir
    |   |   |   ├── test
    |   |   |   └── test.txt
    |   |   ├── faulty
    |   |   |   └── faulty.css
    |   |   ├── loop
    |   |   |   ├── bar.css
    |   |   |   └── foo.css
    |   |   ├── prefixed
    |   |   |   └── test.txt
    |   |   └── site_media
    |   |       ├── media
    |   |       └── static
    |   ├── settings.py
    |   ├── storage.py
    |   ├── test_checks.py
    |   ├── test_finders.py
    |   ├── test_forms.py
    |   ├── test_liveserver.py
    |   ├── test_management.py
    |   ├── test_storage.py
    |   ├── test_templatetags.py
    |   ├── test_utils.py
    |   ├── test_views.py
    |   └── urls
    |       ├── __init__.py
    |       ├── default.py
    |       └── helper.py
    ├── str
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── string_lookup
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── swappable_models
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── syndication_tests
    |   ├── __init__.py
    |   ├── feeds.py
    |   ├── models.py
    |   ├── templates
    |   |   └── syndication
    |   |       ├── description.html
    |   |       ├── description_context.html
    |   |       ├── title.html
    |   |       └── title_context.html
    |   ├── tests.py
    |   └── urls.py
    ├── template_backends
    |   ├── __init__.py
    |   ├── apps
    |   |   ├── __init__.py
    |   |   ├── good
    |   |   |   ├── __init__.py
    |   |   |   └── templatetags
    |   |   └── importerror
    |   |       ├── __init__.py
    |   |       └── templatetags
    |   ├── forbidden
    |   |   └── template_backends
    |   |       └── hello.html
    |   ├── jinja2
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       ├── django_escaping.html
    |   |       ├── hello.html
    |   |       ├── syntax_error.html
    |   |       └── syntax_error2.html
    |   ├── template_strings
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       └── hello.html
    |   ├── templates
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       ├── django_escaping.html
    |   |       ├── hello.html
    |   |       └── syntax_error.html
    |   ├── test_django.py
    |   ├── test_dummy.py
    |   ├── test_jinja2.py
    |   └── test_utils.py
    ├── template_loader
    |   ├── __init__.py
    |   ├── template_strings
    |   |   └── template_loader
    |   |       └── hello.html
    |   ├── templates
    |   |   └── template_loader
    |   |       ├── goodbye.html
    |   |       ├── hello.html
    |   |       └── request.html
    |   └── tests.py
    ├── template_tests
    |   ├── __init__.py
    |   ├── alternate_urls.py
    |   ├── annotated_tag_function.py
    |   ├── broken_tag.py
    |   ├── eggs
    |   ├── filter_tests
    |   |   ├── __init__.py
    |   |   ├── test_add.py
    |   |   ├── test_addslashes.py
    |   |   ├── test_autoescape.py
    |   |   ├── test_capfirst.py
    |   |   ├── test_center.py
    |   |   ├── test_chaining.py
    |   |   ├── test_cut.py
    |   |   ├── test_date.py
    |   |   ├── test_default.py
    |   |   ├── test_default_if_none.py
    |   |   ├── test_dictsort.py
    |   |   ├── test_dictsortreversed.py
    |   |   ├── test_divisibleby.py
    |   |   ├── test_escape.py
    |   |   ├── test_escapejs.py
    |   |   ├── test_filesizeformat.py
    |   |   ├── test_first.py
    |   |   ├── test_floatformat.py
    |   |   ├── test_force_escape.py
    |   |   ├── test_get_digit.py
    |   |   ├── test_iriencode.py
    |   |   ├── test_join.py
    |   |   ├── test_json_script.py
    |   |   ├── test_last.py
    |   |   ├── test_length.py
    |   |   ├── test_length_is.py
    |   |   ├── test_linebreaks.py
    |   |   ├── test_linebreaksbr.py
    |   |   ├── test_linenumbers.py
    |   |   ├── test_ljust.py
    |   |   ├── test_lower.py
    |   |   ├── test_make_list.py
    |   |   ├── test_phone2numeric.py
    |   |   ├── test_pluralize.py
    |   |   ├── test_random.py
    |   |   ├── test_rjust.py
    |   |   ├── test_safe.py
    |   |   ├── test_safeseq.py
    |   |   ├── test_slice.py
    |   |   ├── test_slugify.py
    |   |   ├── test_stringformat.py
    |   |   ├── test_striptags.py
    |   |   ├── test_time.py
    |   |   ├── test_timesince.py
    |   |   ├── test_timeuntil.py
    |   |   ├── test_title.py
    |   |   ├── test_truncatechars.py
    |   |   ├── test_truncatechars_html.py
    |   |   ├── test_truncatewords.py
    |   |   ├── test_truncatewords_html.py
    |   |   ├── test_unordered_list.py
    |   |   ├── test_upper.py
    |   |   ├── test_urlencode.py
    |   |   ├── test_urlize.py
    |   |   ├── test_urlizetrunc.py
    |   |   ├── test_wordcount.py
    |   |   ├── test_wordwrap.py
    |   |   ├── test_yesno.py
    |   |   └── timezone_utils.py
    |   ├── jinja2
    |   |   └── template_tests
    |   |       └── using.html
    |   ├── other_templates
    |   |   ├── priority
    |   |   |   └── foo.html
    |   |   └── test_dirs.html
    |   ├── recursive_templates
    |   |   ├── fs
    |   |   |   ├── extend-missing.html
    |   |   |   ├── one.html
    |   |   |   ├── other-recursive.html
    |   |   |   ├── recursive.html
    |   |   |   ├── self.html
    |   |   |   ├── three.html
    |   |   |   └── two.html
    |   |   ├── fs2
    |   |   |   └── recursive.html
    |   |   └── fs3
    |   |       └── recursive.html
    |   ├── relative_templates
    |   |   ├── dir1
    |   |   |   ├── dir2
    |   |   |   ├── looped.html
    |   |   |   ├── one.html
    |   |   |   ├── one1.html
    |   |   |   ├── one2.html
    |   |   |   ├── one3.html
    |   |   |   ├── three.html
    |   |   |   └── two.html
    |   |   ├── error_extends.html
    |   |   ├── error_include.html
    |   |   ├── one.html
    |   |   ├── three.html
    |   |   └── two.html
    |   ├── syntax_tests
    |   |   ├── __init__.py
    |   |   ├── i18n
    |   |   |   ├── __init__.py
    |   |   |   ├── base.py
    |   |   |   ├── test_blocktrans.py
    |   |   |   ├── test_filters.py
    |   |   |   ├── test_get_available_languages.py
    |   |   |   ├── test_get_current_language.py
    |   |   |   ├── test_get_current_language_bidi.py
    |   |   |   ├── test_get_language_info.py
    |   |   |   ├── test_get_language_info_list.py
    |   |   |   ├── test_language.py
    |   |   |   ├── test_trans.py
    |   |   |   └── test_underscore_syntax.py
    |   |   ├── test_autoescape.py
    |   |   ├── test_basic.py
    |   |   ├── test_builtins.py
    |   |   ├── test_cache.py
    |   |   ├── test_comment.py
    |   |   ├── test_cycle.py
    |   |   ├── test_exceptions.py
    |   |   ├── test_extends.py
    |   |   ├── test_filter_syntax.py
    |   |   ├── test_filter_tag.py
    |   |   ├── test_firstof.py
    |   |   ├── test_for.py
    |   |   ├── test_if.py
    |   |   ├── test_if_changed.py
    |   |   ├── test_if_equal.py
    |   |   ├── test_include.py
    |   |   ├── test_invalid_string.py
    |   |   ├── test_list_index.py
    |   |   ├── test_load.py
    |   |   ├── test_lorem.py
    |   |   ├── test_multiline.py
    |   |   ├── test_named_endblock.py
    |   |   ├── test_now.py
    |   |   ├── test_numpy.py
    |   |   ├── test_regroup.py
    |   |   ├── test_resetcycle.py
    |   |   ├── test_setup.py
    |   |   ├── test_simple_tag.py
    |   |   ├── test_spaceless.py
    |   |   ├── test_static.py
    |   |   ├── test_template_tag.py
    |   |   ├── test_url.py
    |   |   ├── test_verbatim.py
    |   |   ├── test_width_ratio.py
    |   |   └── test_with.py
    |   ├── templates
    |   |   ├── 27584_child.html
    |   |   ├── 27584_parent.html
    |   |   ├── 27956_child.html
    |   |   ├── 27956_parent.html
    |   |   ├── broken_base.html
    |   |   ├── first
    |   |   |   └── test.html
    |   |   ├── include_tpl.html
    |   |   ├── included_base.html
    |   |   ├── included_content.html
    |   |   ├── inclusion.html
    |   |   ├── inclusion_base.html
    |   |   ├── inclusion_extends1.html
    |   |   ├── inclusion_extends2.html
    |   |   ├── index.html
    |   |   ├── priority
    |   |   |   └── foo.html
    |   |   ├── recursive_include.html
    |   |   ├── response.html
    |   |   ├── second
    |   |   |   └── test.html
    |   |   ├── ssi include with spaces.html
    |   |   ├── ssi_include.html
    |   |   ├── template_tests
    |   |   |   └── using.html
    |   |   ├── test_context.html
    |   |   ├── test_context_stack.html
    |   |   ├── test_extends_error.html
    |   |   ├── test_incl_tag_use_l10n.html
    |   |   └── test_include_error.html
    |   ├── templatetags
    |   |   ├── __init__.py
    |   |   ├── bad_tag.py
    |   |   ├── custom.py
    |   |   ├── inclusion.py
    |   |   ├── subpackage
    |   |   |   ├── __init__.py
    |   |   |   └── echo.py
    |   |   ├── tag_27584.py
    |   |   └── testtags.py
    |   ├── test_base.py
    |   ├── test_callables.py
    |   ├── test_context.py
    |   ├── test_custom.py
    |   ├── test_engine.py
    |   ├── test_extends.py
    |   ├── test_extends_relative.py
    |   ├── test_library.py
    |   ├── test_loaders.py
    |   ├── test_logging.py
    |   ├── test_nodelist.py
    |   ├── test_origin.py
    |   ├── test_parser.py
    |   ├── test_response.py
    |   ├── test_smartif.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── utils.py
    |   └── views.py
    ├── templates
    |   ├── base.html
    |   ├── comments
    |   |   └── comment_notification_email.txt
    |   ├── custom_admin
    |   |   ├── add_form.html
    |   |   ├── app_index.html
    |   |   ├── change_form.html
    |   |   ├── change_list.html
    |   |   ├── delete_confirmation.html
    |   |   ├── delete_selected_confirmation.html
    |   |   ├── index.html
    |   |   ├── login.html
    |   |   ├── logout.html
    |   |   ├── object_history.html
    |   |   ├── password_change_done.html
    |   |   ├── password_change_form.html
    |   |   └── popup_response.html
    |   ├── extended.html
    |   ├── form_view.html
    |   ├── login.html
    |   └── views
    |       ├── article_archive_day.html
    |       ├── article_archive_month.html
    |       ├── article_confirm_delete.html
    |       ├── article_detail.html
    |       ├── article_form.html
    |       ├── article_list.html
    |       ├── datearticle_archive_month.html
    |       ├── urlarticle_detail.html
    |       └── urlarticle_form.html
    ├── test_client
    |   ├── __init__.py
    |   ├── auth_backends.py
    |   ├── test_conditional_content_removal.py
    |   ├── test_fakepayload.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── test_client_regress
    |   ├── __init__.py
    |   ├── auth_backends.py
    |   ├── bad_templates
    |   |   └── 404.html
    |   ├── context_processors.py
    |   ├── models.py
    |   ├── session.py
    |   ├── templates
    |   |   ├── request_context.html
    |   |   └── unicode.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── test_exceptions
    |   ├── __init__.py
    |   └── test_validation_error.py
    ├── test_runner
    |   ├── __init__.py
    |   ├── models.py
    |   ├── runner.py
    |   ├── test_debug_sql.py
    |   ├── test_discover_runner.py
    |   ├── test_parallel.py
    |   └── tests.py
    ├── test_runner_apps
    |   ├── __init__.py
    |   ├── databases
    |   |   ├── __init__.py
    |   |   └── tests.py
    |   ├── sample
    |   |   ├── __init__.py
    |   |   ├── doctests.py
    |   |   ├── empty.py
    |   |   ├── pattern_tests.py
    |   |   ├── tests
    |   |   |   ├── __init__.py
    |   |   |   └── tests.py
    |   |   └── tests_sample.py
    |   ├── simple
    |   |   ├── __init__.py
    |   |   └── tests.py
    |   └── tagged
    |       ├── __init__.py
    |       ├── tests.py
    |       └── tests_inheritance.py
    ├── test_sqlite.py
    ├── test_utils
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── templates
    |   |   └── template_used
    |   |       ├── alternative.html
    |   |       ├── base.html
    |   |       ├── extends.html
    |   |       └── include.html
    |   ├── test_deprecated_features.py
    |   ├── test_testcase.py
    |   ├── test_transactiontestcase.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── timezones
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── forms.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── transaction_hooks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── transactions
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── unmanaged_models
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── update_only_fields
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── urlpatterns
    |   ├── __init__.py
    |   ├── converter_urls.py
    |   ├── converters.py
    |   ├── included_urls.py
    |   ├── more_urls.py
    |   ├── path_base64_urls.py
    |   ├── path_dynamic_urls.py
    |   ├── path_urls.py
    |   ├── test_resolvers.py
    |   ├── tests.py
    |   └── views.py
    ├── urlpatterns_reverse
    |   ├── __init__.py
    |   ├── erroneous_urls.py
    |   ├── extra_urls.py
    |   ├── included_app_urls.py
    |   ├── included_named_urls.py
    |   ├── included_named_urls2.py
    |   ├── included_namespace_urls.py
    |   ├── included_no_kwargs_urls.py
    |   ├── included_urls.py
    |   ├── included_urls2.py
    |   ├── method_view_urls.py
    |   ├── middleware.py
    |   ├── named_urls.py
    |   ├── named_urls_conflict.py
    |   ├── namespace_urls.py
    |   ├── nested_urls.py
    |   ├── no_urls.py
    |   ├── nonimported_module.py
    |   ├── reverse_lazy_urls.py
    |   ├── test_localeregexdescriptor.py
    |   ├── tests.py
    |   ├── translations
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       ├── de
    |   |       └── fr
    |   ├── urlconf_inner.py
    |   ├── urlconf_outer.py
    |   ├── urls.py
    |   ├── urls_error_handlers.py
    |   ├── urls_error_handlers_callables.py
    |   ├── urls_without_handlers.py
    |   ├── utils.py
    |   ├── views.py
    |   └── views_broken.py
    ├── urls.py
    ├── user_commands
    |   ├── __init__.py
    |   ├── eggs
    |   ├── management
    |   |   └── commands
    |   |       ├── common_args.py
    |   |       ├── dance.py
    |   |       ├── hal.py
    |   |       ├── no_translations.py
    |   |       ├── required_option.py
    |   |       ├── reverse_url.py
    |   |       ├── set_option.py
    |   |       ├── subparser.py
    |   |       └── transaction.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── utils_tests
    |   ├── __init__.py
    |   ├── archives
    |   ├── eggs
    |   ├── files
    |   |   ├── strip_tags1.html
    |   |   └── strip_tags2.txt
    |   ├── models.py
    |   ├── test_archive.py
    |   ├── test_autoreload.py
    |   ├── test_baseconv.py
    |   ├── test_crypto.py
    |   ├── test_datastructures.py
    |   ├── test_dateformat.py
    |   ├── test_dateparse.py
    |   ├── test_datetime_safe.py
    |   ├── test_decorators.py
    |   ├── test_duration.py
    |   ├── test_encoding.py
    |   ├── test_encoding_deprecations.py
    |   ├── test_feedgenerator.py
    |   ├── test_functional.py
    |   ├── test_hashable.py
    |   ├── test_html.py
    |   ├── test_http.py
    |   ├── test_inspect.py
    |   ├── test_ipv6.py
    |   ├── test_jslex.py
    |   ├── test_lazyobject.py
    |   ├── test_lorem_ipsum.py
    |   ├── test_module
    |   |   ├── __init__.py
    |   |   ├── another_bad_module.py
    |   |   ├── another_good_module.py
    |   |   ├── bad_module.py
    |   |   ├── child_module
    |   |   |   ├── __init__.py
    |   |   |   └── grandchild_module.py
    |   |   └── good_module.py
    |   ├── test_module_loading.py
    |   ├── test_no_submodule.py
    |   ├── test_numberformat.py
    |   ├── test_os_utils.py
    |   ├── test_regex_helper.py
    |   ├── test_safestring.py
    |   ├── test_simplelazyobject.py
    |   ├── test_termcolors.py
    |   ├── test_text.py
    |   ├── test_timesince.py
    |   ├── test_timezone.py
    |   ├── test_topological_sort.py
    |   ├── test_tree.py
    |   └── utils.py
    ├── validation
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_custom_messages.py
    |   ├── test_error_messages.py
    |   ├── test_picklable.py
    |   ├── test_unique.py
    |   ├── test_validators.py
    |   └── tests.py
    ├── validators
    |   ├── __init__.py
    |   ├── invalid_urls.txt
    |   ├── tests.py
    |   └── valid_urls.txt
    ├── version
    |   ├── __init__.py
    |   └── tests.py
    ├── view_tests
    |   ├── __init__.py
    |   ├── app0
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── en
    |   ├── app1
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── app2
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── app3
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── es_AR
    |   ├── app4
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── es_AR
    |   ├── app5
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── default_urls.py
    |   ├── generic_urls.py
    |   ├── locale
    |   |   ├── de
    |   |   |   └── LC_MESSAGES
    |   |   ├── en_GB
    |   |   |   └── LC_MESSAGES
    |   |   ├── es
    |   |   |   └── LC_MESSAGES
    |   |   ├── fr
    |   |   |   └── LC_MESSAGES
    |   |   ├── nl
    |   |   |   └── LC_MESSAGES
    |   |   ├── pt
    |   |   |   └── LC_MESSAGES
    |   |   └── ru
    |   |       └── LC_MESSAGES
    |   ├── media
    |   |   ├── %2F.txt
    |   |   ├── file.txt
    |   |   ├── long-line.txt
    |   |   └── subdir
    |   ├── models.py
    |   ├── regression_21530_urls.py
    |   ├── templates
    |   |   ├── debug
    |   |   |   ├── template_error.html
    |   |   |   └── template_exception.html
    |   |   ├── jsi18n-multi-catalogs.html
    |   |   └── jsi18n.html
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: RenameContentType._rename() doesn't save the content type on the correct database

Description: Description
	
The commit in question:
​https://github.com/django/django/commit/f179113e6cbc8ba0a8d4e87e1d4410fb61d63e75
The specific lines in question:
​https://github.com/django/django/blob/586a9dc4295357de1f5ad0590ad34bf2bc008f79/django/contrib/contenttypes/management/__init__.py#L27
with transaction.atomic(using=db): 
	content_type.save(update_fields={'model'})
The issue:
For some background, we run a dynamic database router and have no "real" databases configured in the settings file, just a default sqlite3 backend which is never actually generated or used. We forked the migrate.py management command and modified it to accept a dictionary containing database connection parameters as the --database argument. 
The dynamic database router is based on, and very similar to this: ​https://github.com/ambitioninc/django-dynamic-db-router/blob/master/dynamic_db_router/router.py
This has worked beautifully for all migrations up until this point.
The issue we're running into is that when attempting to run a migration which contains a call to migrations.RenameModel, and while specifying the database parameters to the migrate command, the migration fails with an OperationalError, stating that no such table: django_content_types exists.
After having exhaustively stepped through the traceback, it appears that even though the content_type.save call is wrapped in the with transaction.atomic(using=db) context manager, the actual database operation is being attempted on the default database (which in our case does not exist) rather than the database specified via schema_editor.connection.alias (on line 15 of the same file) and thus fails loudly.
So, I believe that:
content_type.save(update_fields={'model'})
should be
content_type.save(using=db, update_fields={'model'})

Patch information:
diff --git a/django/contrib/contenttypes/management/__init__.py b/django/contrib/contenttypes/management/__init__.py
index 2b5f688136..563cba2fdf 100644
--- a/django/contrib/contenttypes/management/__init__.py
+++ b/django/contrib/contenttypes/management/__init__.py
@@ -24,7 +24,7 @@ class RenameContentType(migrations.RunPython):
             content_type.model = new_model
             try:
                 with transaction.atomic(using=db):
-                    content_type.save(update_fields={'model'})
+                    content_type.save(using=db, update_fields={'model'})
             except IntegrityError:
                 # Gracefully fallback if a stale content type causes a
                 # conflict as remove_stale_contenttypes will take care of


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 22:16:51,141 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user wants to find test cases related to a bug in `RenameContentType` within a multi-database migration context. The current context is empty. To find relevant test cases, I need to examine tests for multi-database migrations, contenttype-specific migration operations, and the `RenameModel` operation itself.' query='Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.' extra_requirements='' purpose='These files are essential to identify test cases that cover multi-database migrations, the `RenameModel` operation, and specific `contenttypes` operations, which are all directly related to the bug report.'
2025-12-23 22:16:51,142 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.
2025-12-23 22:16:51,142 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 22:16:51,143 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 22:16:51,143 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 22:16:51,143 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.
Purpose: These files are essential to identify test cases that cover multi-database migrations, the `RenameModel` operation, and specific `contenttypes` operations, which are all directly related to the bug report.
2025-12-23 22:16:53,724 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I will read the three requested files to find test cases related to the bug report. These files should provide good coverage of multi-database migrations and model renaming.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/migrations/test_operations.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2139, 'candidates_token_count': 106, 'total_token_count': 2335, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2139}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 106}], 'thoughts_token_count': 90, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.11279470515701007, 'model_name': 'gemini-2.5-pro'} id='run--c884cca1-d386-4146-acb0-f7c274fbe9ad-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/migrations/test_multidb.py'}, 'id': '34884901-2f4f-4d32-89eb-33fb4ed5c639', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/contenttypes_tests/test_operations.py'}, 'id': '1735e1b7-5cd8-4eef-accc-027879fe66c7', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/migrations/test_operations.py'}, 'id': '46b2fbc6-e70e-4aed-89ce-83f6d7d53e84', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2139, 'output_tokens': 106, 'total_tokens': 2335, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 90}}
2025-12-23 22:16:58,213 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have now reviewed the three requested files, which provide test cases for multi-database migrations, contenttypes operations, and general migration operations. These files will be instrumental in understanding the existing test coverage for the features related to the bug. I will now proceed to analyze the contents of these files to identify the most relevant test cases.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "RenameModel", "relative_path": "tests/migrations/test_operations.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 13929, 'candidates_token_count': 100, 'total_token_count': 14272, 'cached_content_token_count': 1856, 'prompt_tokens_details': [{'modality': 1, 'token_count': 13929}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1856}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 100}], 'thoughts_token_count': 243}, 'finish_reason': 'STOP', 'avg_logprobs': -0.36407447814941407, 'model_name': 'gemini-2.5-pro'} id='run--6c731422-d96f-43d7-9d2e-7d76b3f61ece-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'RenameModel', 'relative_path': 'tests/migrations/test_operations.py'}, 'id': 'a07d3c3e-9597-48f9-a8bc-401e792fe905', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13929, 'output_tokens': 100, 'total_tokens': 14272, 'input_token_details': {'cache_read': 1856}, 'output_token_details': {'reasoning': 243}}
2025-12-23 22:17:01,977 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have now read the contents of the three test files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`. I have identified a number of test cases that are relevant to the bug report, including tests for multi-database migrations, the `RenameModel` operation, and `contenttypes` operations. I will now proceed to analyze these test cases in more detail to understand how they can be used to reproduce and fix the bug.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 53437, 'candidates_token_count': 115, 'total_token_count': 53677, 'cached_content_token_count': 13482, 'prompt_tokens_details': [{'modality': 1, 'token_count': 53437}], 'cache_tokens_details': [{'modality': 1, 'token_count': 13482}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 115}], 'thoughts_token_count': 125}, 'finish_reason': 'STOP', 'avg_logprobs': -0.22718748009723166, 'model_name': 'gemini-2.5-pro'} id='run--41afb2b4-91d6-42fc-99ae-b1e731c5ba3c-0' usage_metadata={'input_tokens': 53437, 'output_tokens': 115, 'total_tokens': 53677, 'input_token_details': {'cache_read': 13482}, 'output_token_details': {'reasoning': 125}}
2025-12-23 22:17:01,980 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
These files are essential to identify test cases that cover multi-database migrations, the `RenameModel` operation, and specific `contenttypes` operations, which are all directly related to the bug report.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: tests/contenttypes_tests/test_operations.py
Line number range: 1 - 66
Content:
1. from django.apps.registry import apps
2. from django.conf import settings
3. from django.contrib.contenttypes import management as contenttypes_management
4. from django.contrib.contenttypes.models import ContentType
5. from django.core.management import call_command
6. from django.db import migrations, models
7. from django.test import TransactionTestCase, override_settings
8. 
9. 
10. @override_settings(
11.     MIGRATION_MODULES=dict(
12.         settings.MIGRATION_MODULES,
13.         contenttypes_tests='contenttypes_tests.operations_migrations',
14.     ),
15. )
16. class ContentTypeOperationsTests(TransactionTestCase):
17.     available_apps = [
18.         'contenttypes_tests',
19.         'django.contrib.contenttypes',
20.     ]
21. 
22.     def setUp(self):
23.         app_config = apps.get_app_config('contenttypes_tests')
24.         models.signals.post_migrate.connect(self.assertOperationsInjected, sender=app_config)
25. 
26.     def tearDown(self):
27.         app_config = apps.get_app_config('contenttypes_tests')
28.         models.signals.post_migrate.disconnect(self.assertOperationsInjected, sender=app_config)
29. 
30.     def assertOperationsInjected(self, plan, **kwargs):
31.         for migration, _backward in plan:
32.             operations = iter(migration.operations)
33.             for operation in operations:
34.                 if isinstance(operation, migrations.RenameModel):
35.                     next_operation = next(operations)
36.                     self.assertIsInstance(next_operation, contenttypes_management.RenameContentType)
37.                     self.assertEqual(next_operation.app_label, migration.app_label)
38.                     self.assertEqual(next_operation.old_model, operation.old_name_lower)
39.                     self.assertEqual(next_operation.new_model, operation.new_name_lower)
40. 
41.     def test_existing_content_type_rename(self):
42.         ContentType.objects.create(app_label='contenttypes_tests', model='foo')
43.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0,)
44.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
45.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
46.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
47.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
48.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
49. 
50.     def test_missing_content_type_rename_ignore(self):
51.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0,)
52.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
53.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
54.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
55.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
56.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
57. 
58.     def test_content_type_rename_conflict(self):
59.         ContentType.objects.create(app_label='contenttypes_tests', model='foo')
60.         ContentType.objects.create(app_label='contenttypes_tests', model='renamedfoo')
61.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0)
62.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
63.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
64.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
65.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
66.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())


File: tests/migrations/test_multidb.py
Line number range: 1 - 171
Content:
1. from django.db import connection, migrations, models
2. from django.db.migrations.state import ProjectState
3. from django.test import override_settings
4. 
5. from .test_operations import OperationTestBase
6. 
7. 
8. class AgnosticRouter:
9.     """
10.     A router that doesn't have an opinion regarding migrating.
11.     """
12.     def allow_migrate(self, db, app_label, **hints):
13.         return None
14. 
15. 
16. class MigrateNothingRouter:
17.     """
18.     A router that doesn't allow migrating.
19.     """
20.     def allow_migrate(self, db, app_label, **hints):
21.         return False
22. 
23. 
24. class MigrateEverythingRouter:
25.     """
26.     A router that always allows migrating.
27.     """
28.     def allow_migrate(self, db, app_label, **hints):
29.         return True
30. 
31. 
32. class MigrateWhenFooRouter:
33.     """
34.     A router that allows migrating depending on a hint.
35.     """
36.     def allow_migrate(self, db, app_label, **hints):
37.         return hints.get('foo', False)
38. 
39. 
40. class MultiDBOperationTests(OperationTestBase):
41.     databases = {'default', 'other'}
42. 
43.     def _test_create_model(self, app_label, should_run):
44.         """
45.         CreateModel honors multi-db settings.
46.         """
47.         operation = migrations.CreateModel(
48.             "Pony",
49.             [("id", models.AutoField(primary_key=True))],
50.         )
51.         # Test the state alteration
52.         project_state = ProjectState()
53.         new_state = project_state.clone()
54.         operation.state_forwards(app_label, new_state)
55.         # Test the database alteration
56.         self.assertTableNotExists("%s_pony" % app_label)
57.         with connection.schema_editor() as editor:
58.             operation.database_forwards(app_label, editor, project_state, new_state)
59.         if should_run:
60.             self.assertTableExists("%s_pony" % app_label)
61.         else:
62.             self.assertTableNotExists("%s_pony" % app_label)
63.         # And test reversal
64.         with connection.schema_editor() as editor:
65.             operation.database_backwards(app_label, editor, new_state, project_state)
66.         self.assertTableNotExists("%s_pony" % app_label)
67. 
68.     @override_settings(DATABASE_ROUTERS=[AgnosticRouter()])
69.     def test_create_model(self):
70.         """
71.         Test when router doesn't have an opinion (i.e. CreateModel should run).
72.         """
73.         self._test_create_model("test_mltdb_crmo", should_run=True)
74. 
75.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
76.     def test_create_model2(self):
77.         """
78.         Test when router returns False (i.e. CreateModel shouldn't run).
79.         """
80.         self._test_create_model("test_mltdb_crmo2", should_run=False)
81. 
82.     @override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()])
83.     def test_create_model3(self):
84.         """
85.         Test when router returns True (i.e. CreateModel should run).
86.         """
87.         self._test_create_model("test_mltdb_crmo3", should_run=True)
88. 
89.     def test_create_model4(self):
90.         """
91.         Test multiple routers.
92.         """
93.         with override_settings(DATABASE_ROUTERS=[AgnosticRouter(), AgnosticRouter()]):
94.             self._test_create_model("test_mltdb_crmo4", should_run=True)
95.         with override_settings(DATABASE_ROUTERS=[MigrateNothingRouter(), MigrateEverythingRouter()]):
96.             self._test_create_model("test_mltdb_crmo4", should_run=False)
97.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter(), MigrateNothingRouter()]):
98.             self._test_create_model("test_mltdb_crmo4", should_run=True)
99. 
100.     def _test_run_sql(self, app_label, should_run, hints=None):
101.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):
102.             project_state = self.set_up_test_model(app_label)
103. 
104.         sql = """
105.         INSERT INTO {0}_pony (pink, weight) VALUES (1, 3.55);
106.         INSERT INTO {0}_pony (pink, weight) VALUES (3, 5.0);
107.         """.format(app_label)
108. 
109.         operation = migrations.RunSQL(sql, hints=hints or {})
110.         # Test the state alteration does nothing
111.         new_state = project_state.clone()
112.         operation.state_forwards(app_label, new_state)
113.         self.assertEqual(new_state, project_state)
114.         # Test the database alteration
115.         self.assertEqual(project_state.apps.get_model(app_label, "Pony").objects.count(), 0)
116.         with connection.schema_editor() as editor:
117.             operation.database_forwards(app_label, editor, project_state, new_state)
118.         Pony = project_state.apps.get_model(app_label, "Pony")
119.         if should_run:
120.             self.assertEqual(Pony.objects.count(), 2)
121.         else:
122.             self.assertEqual(Pony.objects.count(), 0)
123. 
124.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
125.     def test_run_sql_migrate_nothing_router(self):
126.         self._test_run_sql("test_mltdb_runsql", should_run=False)
127. 
128.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
129.     def test_run_sql_migrate_foo_router_without_hints(self):
130.         self._test_run_sql("test_mltdb_runsql2", should_run=False)
131. 
132.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
133.     def test_run_sql_migrate_foo_router_with_hints(self):
134.         self._test_run_sql('test_mltdb_runsql3', should_run=True, hints={'foo': True})
135. 
136.     def _test_run_python(self, app_label, should_run, hints=None):
137.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):
138.             project_state = self.set_up_test_model(app_label)
139. 
140.         # Create the operation
141.         def inner_method(models, schema_editor):
142.             Pony = models.get_model(app_label, "Pony")
143.             Pony.objects.create(pink=1, weight=3.55)
144.             Pony.objects.create(weight=5)
145. 
146.         operation = migrations.RunPython(inner_method, hints=hints or {})
147.         # Test the state alteration does nothing
148.         new_state = project_state.clone()
149.         operation.state_forwards(app_label, new_state)
150.         self.assertEqual(new_state, project_state)
151.         # Test the database alteration
152.         self.assertEqual(project_state.apps.get_model(app_label, "Pony").objects.count(), 0)
153.         with connection.schema_editor() as editor:
154.             operation.database_forwards(app_label, editor, project_state, new_state)
155.         Pony = project_state.apps.get_model(app_label, "Pony")
156.         if should_run:
157.             self.assertEqual(Pony.objects.count(), 2)
158.         else:
159.             self.assertEqual(Pony.objects.count(), 0)
160. 
161.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
162.     def test_run_python_migrate_nothing_router(self):
163.         self._test_run_python("test_mltdb_runpython", should_run=False)
164. 
165.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
166.     def test_run_python_migrate_foo_router_without_hints(self):
167.         self._test_run_python("test_mltdb_runpython2", should_run=False)
168. 
169.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
170.     def test_run_python_migrate_foo_router_with_hints(self):
171.         self._test_run_python('test_mltdb_runpython3', should_run=True, hints={'foo': True})


File: tests/migrations/test_operations.py
Line number range: 1 - 500
Content:
1. from django.core.exceptions import FieldDoesNotExist
2. from django.db import connection, migrations, models, transaction
3. from django.db.migrations.migration import Migration
4. from django.db.migrations.operations import CreateModel
5. from django.db.migrations.operations.fields import FieldOperation
6. from django.db.migrations.state import ModelState, ProjectState
7. from django.db.models.fields import NOT_PROVIDED
8. from django.db.transaction import atomic
9. from django.db.utils import IntegrityError
10. from django.test import SimpleTestCase, override_settings, skipUnlessDBFeature
11. 
12. from .models import FoodManager, FoodQuerySet, UnicodeModel
13. from .test_base import MigrationTestBase
14. 
15. 
16. class Mixin:
17.     pass
18. 
19. 
20. class OperationTestBase(MigrationTestBase):
21.     """
22.     Common functions to help test operations.
23.     """
24. 
25.     @classmethod
26.     def setUpClass(cls):
27.         super().setUpClass()
28.         cls._initial_table_names = frozenset(connection.introspection.table_names())
29. 
30.     def tearDown(self):
31.         self.cleanup_test_tables()
32.         super().tearDown()
33. 
34.     def cleanup_test_tables(self):
35.         table_names = frozenset(connection.introspection.table_names()) - self._initial_table_names
36.         with connection.schema_editor() as editor:
37.             with connection.constraint_checks_disabled():
38.                 for table_name in table_names:
39.                     editor.execute(editor.sql_delete_table % {
40.                         'table': editor.quote_name(table_name),
41.                     })
42. 
43.     def apply_operations(self, app_label, project_state, operations, atomic=True):
44.         migration = Migration('name', app_label)
45.         migration.operations = operations
46.         with connection.schema_editor(atomic=atomic) as editor:
47.             return migration.apply(project_state, editor)
48. 
49.     def unapply_operations(self, app_label, project_state, operations, atomic=True):
50.         migration = Migration('name', app_label)
51.         migration.operations = operations
52.         with connection.schema_editor(atomic=atomic) as editor:
53.             return migration.unapply(project_state, editor)
54. 
55.     def make_test_state(self, app_label, operation, **kwargs):
56.         """
57.         Makes a test state using set_up_test_model and returns the
58.         original state and the state after the migration is applied.
59.         """
60.         project_state = self.set_up_test_model(app_label, **kwargs)
61.         new_state = project_state.clone()
62.         operation.state_forwards(app_label, new_state)
63.         return project_state, new_state
64. 
65.     def set_up_test_model(
66.             self, app_label, second_model=False, third_model=False, index=False, multicol_index=False,
67.             related_model=False, mti_model=False, proxy_model=False, manager_model=False,
68.             unique_together=False, options=False, db_table=None, index_together=False, constraints=None):
69.         """
70.         Creates a test model state and database table.
71.         """
72.         # Make the "current" state
73.         model_options = {
74.             "swappable": "TEST_SWAP_MODEL",
75.             "index_together": [["weight", "pink"]] if index_together else [],
76.             "unique_together": [["pink", "weight"]] if unique_together else [],
77.         }
78.         if options:
79.             model_options["permissions"] = [("can_groom", "Can groom")]
80.         if db_table:
81.             model_options["db_table"] = db_table
82.         operations = [migrations.CreateModel(
83.             "Pony",
84.             [
85.                 ("id", models.AutoField(primary_key=True)),
86.                 ("pink", models.IntegerField(default=3)),
87.                 ("weight", models.FloatField()),
88.             ],
89.             options=model_options,
90.         )]
91.         if index:
92.             operations.append(migrations.AddIndex(
93.                 "Pony",
94.                 models.Index(fields=["pink"], name="pony_pink_idx")
95.             ))
96.         if multicol_index:
97.             operations.append(migrations.AddIndex(
98.                 "Pony",
99.                 models.Index(fields=["pink", "weight"], name="pony_test_idx")
100.             ))
101.         if constraints:
102.             for constraint in constraints:
103.                 operations.append(migrations.AddConstraint(
104.                     "Pony",
105.                     constraint,
106.                 ))
107.         if second_model:
108.             operations.append(migrations.CreateModel(
109.                 "Stable",
110.                 [
111.                     ("id", models.AutoField(primary_key=True)),
112.                 ]
113.             ))
114.         if third_model:
115.             operations.append(migrations.CreateModel(
116.                 "Van",
117.                 [
118.                     ("id", models.AutoField(primary_key=True)),
119.                 ]
120.             ))
121.         if related_model:
122.             operations.append(migrations.CreateModel(
123.                 "Rider",
124.                 [
125.                     ("id", models.AutoField(primary_key=True)),
126.                     ("pony", models.ForeignKey("Pony", models.CASCADE)),
127.                     ("friend", models.ForeignKey("self", models.CASCADE))
128.                 ],
129.             ))
130.         if mti_model:
131.             operations.append(migrations.CreateModel(
132.                 "ShetlandPony",
133.                 fields=[
134.                     ('pony_ptr', models.OneToOneField(
135.                         'Pony',
136.                         models.CASCADE,
137.                         auto_created=True,
138.                         parent_link=True,
139.                         primary_key=True,
140.                         to_field='id',
141.                         serialize=False,
142.                     )),
143.                     ("cuteness", models.IntegerField(default=1)),
144.                 ],
145.                 bases=['%s.Pony' % app_label],
146.             ))
147.         if proxy_model:
148.             operations.append(migrations.CreateModel(
149.                 "ProxyPony",
150.                 fields=[],
151.                 options={"proxy": True},
152.                 bases=['%s.Pony' % app_label],
153.             ))
154.         if manager_model:
155.             operations.append(migrations.CreateModel(
156.                 "Food",
157.                 fields=[
158.                     ("id", models.AutoField(primary_key=True)),
159.                 ],
160.                 managers=[
161.                     ("food_qs", FoodQuerySet.as_manager()),
162.                     ("food_mgr", FoodManager("a", "b")),
163.                     ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
164.                 ]
165.             ))
166. 
167.         return self.apply_operations(app_label, ProjectState(), operations)
168. 
169. 
170. class OperationTests(OperationTestBase):
171.     """
172.     Tests running the operations and making sure they do what they say they do.
173.     Each test looks at their state changing, and then their database operation -
174.     both forwards and backwards.
175.     """
176. 
177.     def test_create_model(self):
178.         """
179.         Tests the CreateModel operation.
180.         Most other tests use this operation as part of setup, so check failures here first.
181.         """
182.         operation = migrations.CreateModel(
183.             "Pony",
184.             [
185.                 ("id", models.AutoField(primary_key=True)),
186.                 ("pink", models.IntegerField(default=1)),
187.             ],
188.         )
189.         self.assertEqual(operation.describe(), "Create model Pony")
190.         # Test the state alteration
191.         project_state = ProjectState()
192.         new_state = project_state.clone()
193.         operation.state_forwards("test_crmo", new_state)
194.         self.assertEqual(new_state.models["test_crmo", "pony"].name, "Pony")
195.         self.assertEqual(len(new_state.models["test_crmo", "pony"].fields), 2)
196.         # Test the database alteration
197.         self.assertTableNotExists("test_crmo_pony")
198.         with connection.schema_editor() as editor:
199.             operation.database_forwards("test_crmo", editor, project_state, new_state)
200.         self.assertTableExists("test_crmo_pony")
201.         # And test reversal
202.         with connection.schema_editor() as editor:
203.             operation.database_backwards("test_crmo", editor, new_state, project_state)
204.         self.assertTableNotExists("test_crmo_pony")
205.         # And deconstruction
206.         definition = operation.deconstruct()
207.         self.assertEqual(definition[0], "CreateModel")
208.         self.assertEqual(definition[1], [])
209.         self.assertEqual(sorted(definition[2]), ["fields", "name"])
210.         # And default manager not in set
211.         operation = migrations.CreateModel("Foo", fields=[], managers=[("objects", models.Manager())])
212.         definition = operation.deconstruct()
213.         self.assertNotIn('managers', definition[2])
214. 
215.     def test_create_model_with_duplicate_field_name(self):
216.         with self.assertRaisesMessage(ValueError, 'Found duplicate value pink in CreateModel fields argument.'):
217.             migrations.CreateModel(
218.                 "Pony",
219.                 [
220.                     ("id", models.AutoField(primary_key=True)),
221.                     ("pink", models.TextField()),
222.                     ("pink", models.IntegerField(default=1)),
223.                 ],
224.             )
225. 
226.     def test_create_model_with_duplicate_base(self):
227.         message = 'Found duplicate value test_crmo.pony in CreateModel bases argument.'
228.         with self.assertRaisesMessage(ValueError, message):
229.             migrations.CreateModel(
230.                 "Pony",
231.                 fields=[],
232.                 bases=("test_crmo.Pony", "test_crmo.Pony",),
233.             )
234.         with self.assertRaisesMessage(ValueError, message):
235.             migrations.CreateModel(
236.                 "Pony",
237.                 fields=[],
238.                 bases=("test_crmo.Pony", "test_crmo.pony",),
239.             )
240.         message = 'Found duplicate value migrations.unicodemodel in CreateModel bases argument.'
241.         with self.assertRaisesMessage(ValueError, message):
242.             migrations.CreateModel(
243.                 "Pony",
244.                 fields=[],
245.                 bases=(UnicodeModel, UnicodeModel,),
246.             )
247.         with self.assertRaisesMessage(ValueError, message):
248.             migrations.CreateModel(
249.                 "Pony",
250.                 fields=[],
251.                 bases=(UnicodeModel, 'migrations.unicodemodel',),
252.             )
253.         with self.assertRaisesMessage(ValueError, message):
254.             migrations.CreateModel(
255.                 "Pony",
256.                 fields=[],
257.                 bases=(UnicodeModel, 'migrations.UnicodeModel',),
258.             )
259.         message = "Found duplicate value <class 'django.db.models.base.Model'> in CreateModel bases argument."
260.         with self.assertRaisesMessage(ValueError, message):
261.             migrations.CreateModel(
262.                 "Pony",
263.                 fields=[],
264.                 bases=(models.Model, models.Model,),
265.             )
266.         message = "Found duplicate value <class 'migrations.test_operations.Mixin'> in CreateModel bases argument."
267.         with self.assertRaisesMessage(ValueError, message):
268.             migrations.CreateModel(
269.                 "Pony",
270.                 fields=[],
271.                 bases=(Mixin, Mixin,),
272.             )
273. 
274.     def test_create_model_with_duplicate_manager_name(self):
275.         with self.assertRaisesMessage(ValueError, 'Found duplicate value objects in CreateModel managers argument.'):
276.             migrations.CreateModel(
277.                 "Pony",
278.                 fields=[],
279.                 managers=[
280.                     ("objects", models.Manager()),
281.                     ("objects", models.Manager()),
282.                 ],
283.             )
284. 
285.     def test_create_model_with_unique_after(self):
286.         """
287.         Tests the CreateModel operation directly followed by an
288.         AlterUniqueTogether (bug #22844 - sqlite remake issues)
289.         """
290.         operation1 = migrations.CreateModel(
291.             "Pony",
292.             [
293.                 ("id", models.AutoField(primary_key=True)),
294.                 ("pink", models.IntegerField(default=1)),
295.             ],
296.         )
297.         operation2 = migrations.CreateModel(
298.             "Rider",
299.             [
300.                 ("id", models.AutoField(primary_key=True)),
301.                 ("number", models.IntegerField(default=1)),
302.                 ("pony", models.ForeignKey("test_crmoua.Pony", models.CASCADE)),
303.             ],
304.         )
305.         operation3 = migrations.AlterUniqueTogether(
306.             "Rider",
307.             [
308.                 ("number", "pony"),
309.             ],
310.         )
311.         # Test the database alteration
312.         project_state = ProjectState()
313.         self.assertTableNotExists("test_crmoua_pony")
314.         self.assertTableNotExists("test_crmoua_rider")
315.         with connection.schema_editor() as editor:
316.             new_state = project_state.clone()
317.             operation1.state_forwards("test_crmoua", new_state)
318.             operation1.database_forwards("test_crmoua", editor, project_state, new_state)
319.             project_state, new_state = new_state, new_state.clone()
320.             operation2.state_forwards("test_crmoua", new_state)
321.             operation2.database_forwards("test_crmoua", editor, project_state, new_state)
322.             project_state, new_state = new_state, new_state.clone()
323.             operation3.state_forwards("test_crmoua", new_state)
324.             operation3.database_forwards("test_crmoua", editor, project_state, new_state)
325.         self.assertTableExists("test_crmoua_pony")
326.         self.assertTableExists("test_crmoua_rider")
327. 
328.     def test_create_model_m2m(self):
329.         """
330.         Test the creation of a model with a ManyToMany field and the
331.         auto-created "through" model.
332.         """
333.         project_state = self.set_up_test_model("test_crmomm")
334.         operation = migrations.CreateModel(
335.             "Stable",
336.             [
337.                 ("id", models.AutoField(primary_key=True)),
338.                 ("ponies", models.ManyToManyField("Pony", related_name="stables"))
339.             ]
340.         )
341.         # Test the state alteration
342.         new_state = project_state.clone()
343.         operation.state_forwards("test_crmomm", new_state)
344.         # Test the database alteration
345.         self.assertTableNotExists("test_crmomm_stable_ponies")
346.         with connection.schema_editor() as editor:
347.             operation.database_forwards("test_crmomm", editor, project_state, new_state)
348.         self.assertTableExists("test_crmomm_stable")
349.         self.assertTableExists("test_crmomm_stable_ponies")
350.         self.assertColumnNotExists("test_crmomm_stable", "ponies")
351.         # Make sure the M2M field actually works
352.         with atomic():
353.             Pony = new_state.apps.get_model("test_crmomm", "Pony")
354.             Stable = new_state.apps.get_model("test_crmomm", "Stable")
355.             stable = Stable.objects.create()
356.             p1 = Pony.objects.create(pink=False, weight=4.55)
357.             p2 = Pony.objects.create(pink=True, weight=5.43)
358.             stable.ponies.add(p1, p2)
359.             self.assertEqual(stable.ponies.count(), 2)
360.             stable.ponies.all().delete()
361.         # And test reversal
362.         with connection.schema_editor() as editor:
363.             operation.database_backwards("test_crmomm", editor, new_state, project_state)
364.         self.assertTableNotExists("test_crmomm_stable")
365.         self.assertTableNotExists("test_crmomm_stable_ponies")
366. 
367.     def test_create_model_inheritance(self):
368.         """
369.         Tests the CreateModel operation on a multi-table inheritance setup.
370.         """
371.         project_state = self.set_up_test_model("test_crmoih")
372.         # Test the state alteration
373.         operation = migrations.CreateModel(
374.             "ShetlandPony",
375.             [
376.                 ('pony_ptr', models.OneToOneField(
377.                     'test_crmoih.Pony',
378.                     models.CASCADE,
379.                     auto_created=True,
380.                     primary_key=True,
381.                     to_field='id',
382.                     serialize=False,
383.                 )),
384.                 ("cuteness", models.IntegerField(default=1)),
385.             ],
386.         )
387.         new_state = project_state.clone()
388.         operation.state_forwards("test_crmoih", new_state)
389.         self.assertIn(("test_crmoih", "shetlandpony"), new_state.models)
390.         # Test the database alteration
391.         self.assertTableNotExists("test_crmoih_shetlandpony")
392.         with connection.schema_editor() as editor:
393.             operation.database_forwards("test_crmoih", editor, project_state, new_state)
394.         self.assertTableExists("test_crmoih_shetlandpony")
395.         # And test reversal
396.         with connection.schema_editor() as editor:
397.             operation.database_backwards("test_crmoih", editor, new_state, project_state)
398.         self.assertTableNotExists("test_crmoih_shetlandpony")
399. 
400.     def test_create_proxy_model(self):
401.         """
402.         CreateModel ignores proxy models.
403.         """
404.         project_state = self.set_up_test_model("test_crprmo")
405.         # Test the state alteration
406.         operation = migrations.CreateModel(
407.             "ProxyPony",
408.             [],
409.             options={"proxy": True},
410.             bases=("test_crprmo.Pony",),
411.         )
412.         self.assertEqual(operation.describe(), "Create proxy model ProxyPony")
413.         new_state = project_state.clone()
414.         operation.state_forwards("test_crprmo", new_state)
415.         self.assertIn(("test_crprmo", "proxypony"), new_state.models)
416.         # Test the database alteration
417.         self.assertTableNotExists("test_crprmo_proxypony")
418.         self.assertTableExists("test_crprmo_pony")
419.         with connection.schema_editor() as editor:
420.             operation.database_forwards("test_crprmo", editor, project_state, new_state)
421.         self.assertTableNotExists("test_crprmo_proxypony")
422.         self.assertTableExists("test_crprmo_pony")
423.         # And test reversal
424.         with connection.schema_editor() as editor:
425.             operation.database_backwards("test_crprmo", editor, new_state, project_state)
426.         self.assertTableNotExists("test_crprmo_proxypony")
427.         self.assertTableExists("test_crprmo_pony")
428.         # And deconstruction
429.         definition = operation.deconstruct()
430.         self.assertEqual(definition[0], "CreateModel")
431.         self.assertEqual(definition[1], [])
432.         self.assertEqual(sorted(definition[2]), ["bases", "fields", "name", "options"])
433. 
434.     def test_create_unmanaged_model(self):
435.         """
436.         CreateModel ignores unmanaged models.
437.         """
438.         project_state = self.set_up_test_model("test_crummo")
439.         # Test the state alteration
440.         operation = migrations.CreateModel(
441.             "UnmanagedPony",
442.             [],
443.             options={"proxy": True},
444.             bases=("test_crummo.Pony",),
445.         )
446.         self.assertEqual(operation.describe(), "Create proxy model UnmanagedPony")
447.         new_state = project_state.clone()
448.         operation.state_forwards("test_crummo", new_state)
449.         self.assertIn(("test_crummo", "unmanagedpony"), new_state.models)
450.         # Test the database alteration
451.         self.assertTableNotExists("test_crummo_unmanagedpony")
452.         self.assertTableExists("test_crummo_pony")
453.         with connection.schema_editor() as editor:
454.             operation.database_forwards("test_crummo", editor, project_state, new_state)
455.         self.assertTableNotExists("test_crummo_unmanagedpony")
456.         self.assertTableExists("test_crummo_pony")
457.         # And test reversal
458.         with connection.schema_editor() as editor:
459.             operation.database_backwards("test_crummo", editor, new_state, project_state)
460.         self.assertTableNotExists("test_crummo_unmanagedpony")
461.         self.assertTableExists("test_crummo_pony")
462. 
463.     @skipUnlessDBFeature('supports_table_check_constraints')
464.     def test_create_model_with_constraint(self):
465.         where = models.Q(pink__gt=2)
466.         check_constraint = models.CheckConstraint(check=where, name='test_constraint_pony_pink_gt_2')
467.         operation = migrations.CreateModel(
468.             "Pony",
469.             [
470.                 ("id", models.AutoField(primary_key=True)),
471.                 ("pink", models.IntegerField(default=3)),
472.             ],
473.             options={'constraints': [check_constraint]},
474.         )
475. 
476.         # Test the state alteration
477.         project_state = ProjectState()
478.         new_state = project_state.clone()
479.         operation.state_forwards("test_crmo", new_state)
480.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
481. 
482.         # Test database alteration
483.         self.assertTableNotExists("test_crmo_pony")
484.         with connection.schema_editor() as editor:
485.             operation.database_forwards("test_crmo", editor, project_state, new_state)
486.         self.assertTableExists("test_crmo_pony")
487.         with connection.cursor() as cursor:
488.             with self.assertRaises(IntegrityError):
489.                 cursor.execute("INSERT INTO test_crmo_pony (id, pink) VALUES (1, 1)")
490. 
491.         # Test reversal
492.         with connection.schema_editor() as editor:
493.             operation.database_backwards("test_crmo", editor, new_state, project_state)
494.         self.assertTableNotExists("test_crmo_pony")
495. 
496.         # Test deconstruction
497.         definition = operation.deconstruct()
498.         self.assertEqual(definition[0], "CreateModel")
499.         self.assertEqual(definition[1], [])
500.         self.assertEqual(definition[2]['options']['constraints'], [check_constraint])


File: tests/migrations/test_operations.py
Line number range: 170 - 2865
Content:
class OperationTests(OperationTestBase):
    """
    Tests running the operations and making sure they do what they say they do.
    Each test looks at their state changing, and then their database operation -
    both forwards and backwards.
    """

    def test_create_model(self):
        """
        Tests the CreateModel operation.
        Most other tests use this operation as part of setup, so check failures here first.
        """
        operation = migrations.CreateModel(
            "Pony",
            [
                ("id", models.AutoField(primary_key=True)),
                ("pink", models.IntegerField(default=1)),
            ],
        )
        self.assertEqual(operation.describe(), "Create model Pony")
        # Test the state alteration
        project_state = ProjectState()
        new_state = project_state.clone()
        operation.state_forwards("test_crmo", new_state)
        self.assertEqual(new_state.models["test_crmo", "pony"].name, "Pony")
        self.assertEqual(len(new_state.models["test_crmo", "pony"].fields), 2)
        # Test the database alteration
        self.assertTableNotExists("test_crmo_pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_crmo", editor, project_state, new_state)
        self.assertTableExists("test_crmo_pony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_crmo", editor, new_state, project_state)
        self.assertTableNotExists("test_crmo_pony")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "CreateModel")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["fields", "name"])
        # And default manager not in set
        operation = migrations.CreateModel("Foo", fields=[], managers=[("objects", models.Manager())])
        definition = operation.deconstruct()
        self.assertNotIn('managers', definition[2])

    def test_create_model_with_duplicate_field_name(self):
        with self.assertRaisesMessage(ValueError, 'Found duplicate value pink in CreateModel fields argument.'):
            migrations.CreateModel(
                "Pony",
                [
                    ("id", models.AutoField(primary_key=True)),
                    ("pink", models.TextField()),
                    ("pink", models.IntegerField(default=1)),
                ],
            )

    def test_create_model_with_duplicate_base(self):
        message = 'Found duplicate value test_crmo.pony in CreateModel bases argument.'
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=("test_crmo.Pony", "test_crmo.Pony",),
            )
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=("test_crmo.Pony", "test_crmo.pony",),
            )
        message = 'Found duplicate value migrations.unicodemodel in CreateModel bases argument.'
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=(UnicodeModel, UnicodeModel,),
            )
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=(UnicodeModel, 'migrations.unicodemodel',),
            )
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=(UnicodeModel, 'migrations.UnicodeModel',),
            )
        message = "Found duplicate value <class 'django.db.models.base.Model'> in CreateModel bases argument."
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=(models.Model, models.Model,),
            )
        message = "Found duplicate value <class 'migrations.test_operations.Mixin'> in CreateModel bases argument."
        with self.assertRaisesMessage(ValueError, message):
            migrations.CreateModel(
                "Pony",
                fields=[],
                bases=(Mixin, Mixin,),
            )

    def test_create_model_with_duplicate_manager_name(self):
        with self.assertRaisesMessage(ValueError, 'Found duplicate value objects in CreateModel managers argument.'):
            migrations.CreateModel(
                "Pony",
                fields=[],
                managers=[
                    ("objects", models.Manager()),
                    ("objects", models.Manager()),
                ],
            )

    def test_create_model_with_unique_after(self):
        """
        Tests the CreateModel operation directly followed by an
        AlterUniqueTogether (bug #22844 - sqlite remake issues)
        """
        operation1 = migrations.CreateModel(
            "Pony",
            [
                ("id", models.AutoField(primary_key=True)),
                ("pink", models.IntegerField(default=1)),
            ],
        )
        operation2 = migrations.CreateModel(
            "Rider",
            [
                ("id", models.AutoField(primary_key=True)),
                ("number", models.IntegerField(default=1)),
                ("pony", models.ForeignKey("test_crmoua.Pony", models.CASCADE)),
            ],
        )
        operation3 = migrations.AlterUniqueTogether(
            "Rider",
            [
                ("number", "pony"),
            ],
        )
        # Test the database alteration
        project_state = ProjectState()
        self.assertTableNotExists("test_crmoua_pony")
        self.assertTableNotExists("test_crmoua_rider")
        with connection.schema_editor() as editor:
            new_state = project_state.clone()
            operation1.state_forwards("test_crmoua", new_state)
            operation1.database_forwards("test_crmoua", editor, project_state, new_state)
            project_state, new_state = new_state, new_state.clone()
            operation2.state_forwards("test_crmoua", new_state)
            operation2.database_forwards("test_crmoua", editor, project_state, new_state)
            project_state, new_state = new_state, new_state.clone()
            operation3.state_forwards("test_crmoua", new_state)
            operation3.database_forwards("test_crmoua", editor, project_state, new_state)
        self.assertTableExists("test_crmoua_pony")
        self.assertTableExists("test_crmoua_rider")

    def test_create_model_m2m(self):
        """
        Test the creation of a model with a ManyToMany field and the
        auto-created "through" model.
        """
        project_state = self.set_up_test_model("test_crmomm")
        operation = migrations.CreateModel(
            "Stable",
            [
                ("id", models.AutoField(primary_key=True)),
                ("ponies", models.ManyToManyField("Pony", related_name="stables"))
            ]
        )
        # Test the state alteration
        new_state = project_state.clone()
        operation.state_forwards("test_crmomm", new_state)
        # Test the database alteration
        self.assertTableNotExists("test_crmomm_stable_ponies")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_crmomm", editor, project_state, new_state)
        self.assertTableExists("test_crmomm_stable")
        self.assertTableExists("test_crmomm_stable_ponies")
        self.assertColumnNotExists("test_crmomm_stable", "ponies")
        # Make sure the M2M field actually works
        with atomic():
            Pony = new_state.apps.get_model("test_crmomm", "Pony")
            Stable = new_state.apps.get_model("test_crmomm", "Stable")
            stable = Stable.objects.create()
            p1 = Pony.objects.create(pink=False, weight=4.55)
            p2 = Pony.objects.create(pink=True, weight=5.43)
            stable.ponies.add(p1, p2)
            self.assertEqual(stable.ponies.count(), 2)
            stable.ponies.all().delete()
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_crmomm", editor, new_state, project_state)
        self.assertTableNotExists("test_crmomm_stable")
        self.assertTableNotExists("test_crmomm_stable_ponies")

    def test_create_model_inheritance(self):
        """
        Tests the CreateModel operation on a multi-table inheritance setup.
        """
        project_state = self.set_up_test_model("test_crmoih")
        # Test the state alteration
        operation = migrations.CreateModel(
            "ShetlandPony",
            [
                ('pony_ptr', models.OneToOneField(
                    'test_crmoih.Pony',
                    models.CASCADE,
                    auto_created=True,
                    primary_key=True,
                    to_field='id',
                    serialize=False,
                )),
                ("cuteness", models.IntegerField(default=1)),
            ],
        )
        new_state = project_state.clone()
        operation.state_forwards("test_crmoih", new_state)
        self.assertIn(("test_crmoih", "shetlandpony"), new_state.models)
        # Test the database alteration
        self.assertTableNotExists("test_crmoih_shetlandpony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_crmoih", editor, project_state, new_state)
        self.assertTableExists("test_crmoih_shetlandpony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_crmoih", editor, new_state, project_state)
        self.assertTableNotExists("test_crmoih_shetlandpony")

    def test_create_proxy_model(self):
        """
        CreateModel ignores proxy models.
        """
        project_state = self.set_up_test_model("test_crprmo")
        # Test the state alteration
        operation = migrations.CreateModel(
            "ProxyPony",
            [],
            options={"proxy": True},
            bases=("test_crprmo.Pony",),
        )
        self.assertEqual(operation.describe(), "Create proxy model ProxyPony")
        new_state = project_state.clone()
        operation.state_forwards("test_crprmo", new_state)
        self.assertIn(("test_crprmo", "proxypony"), new_state.models)
        # Test the database alteration
        self.assertTableNotExists("test_crprmo_proxypony")
        self.assertTableExists("test_crprmo_pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_crprmo", editor, project_state, new_state)
        self.assertTableNotExists("test_crprmo_proxypony")
        self.assertTableExists("test_crprmo_pony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_crprmo", editor, new_state, project_state)
        self.assertTableNotExists("test_crprmo_proxypony")
        self.assertTableExists("test_crprmo_pony")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "CreateModel")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["bases", "fields", "name", "options"])

    def test_create_unmanaged_model(self):
        """
        CreateModel ignores unmanaged models.
        """
        project_state = self.set_up_test_model("test_crummo")
        # Test the state alteration
        operation = migrations.CreateModel(
            "UnmanagedPony",
            [],
            options={"proxy": True},
            bases=("test_crummo.Pony",),
        )
        self.assertEqual(operation.describe(), "Create proxy model UnmanagedPony")
        new_state = project_state.clone()
        operation.state_forwards("test_crummo", new_state)
        self.assertIn(("test_crummo", "unmanagedpony"), new_state.models)
        # Test the database alteration
        self.assertTableNotExists("test_crummo_unmanagedpony")
        self.assertTableExists("test_crummo_pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_crummo", editor, project_state, new_state)
        self.assertTableNotExists("test_crummo_unmanagedpony")
        self.assertTableExists("test_crummo_pony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_crummo", editor, new_state, project_state)
        self.assertTableNotExists("test_crummo_unmanagedpony")
        self.assertTableExists("test_crummo_pony")

    @skipUnlessDBFeature('supports_table_check_constraints')
    def test_create_model_with_constraint(self):
        where = models.Q(pink__gt=2)
        check_constraint = models.CheckConstraint(check=where, name='test_constraint_pony_pink_gt_2')
        operation = migrations.CreateModel(
            "Pony",
            [
                ("id", models.AutoField(primary_key=True)),
                ("pink", models.IntegerField(default=3)),
            ],
            options={'constraints': [check_constraint]},
        )

        # Test the state alteration
        project_state = ProjectState()
        new_state = project_state.clone()
        operation.state_forwards("test_crmo", new_state)
        self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)

        # Test database alteration
        self.assertTableNotExists("test_crmo_pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_crmo", editor, project_state, new_state)
        self.assertTableExists("test_crmo_pony")
        with connection.cursor() as cursor:
            with self.assertRaises(IntegrityError):
                cursor.execute("INSERT INTO test_crmo_pony (id, pink) VALUES (1, 1)")

        # Test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_crmo", editor, new_state, project_state)
        self.assertTableNotExists("test_crmo_pony")

        # Test deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "CreateModel")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2]['options']['constraints'], [check_constraint])

    def test_create_model_with_partial_unique_constraint(self):
        partial_unique_constraint = models.UniqueConstraint(
            fields=['pink'],
            condition=models.Q(weight__gt=5),
            name='test_constraint_pony_pink_for_weight_gt_5_uniq',
        )
        operation = migrations.CreateModel(
            'Pony',
            [
                ('id', models.AutoField(primary_key=True)),
                ('pink', models.IntegerField(default=3)),
                ('weight', models.FloatField()),
            ],
            options={'constraints': [partial_unique_constraint]},
        )
        # Test the state alteration
        project_state = ProjectState()
        new_state = project_state.clone()
        operation.state_forwards('test_crmo', new_state)
        self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
        # Test database alteration
        self.assertTableNotExists('test_crmo_pony')
        with connection.schema_editor() as editor:
            operation.database_forwards('test_crmo', editor, project_state, new_state)
        self.assertTableExists('test_crmo_pony')
        # Test constraint works
        Pony = new_state.apps.get_model('test_crmo', 'Pony')
        Pony.objects.create(pink=1, weight=4.0)
        Pony.objects.create(pink=1, weight=4.0)
        Pony.objects.create(pink=1, weight=6.0)
        if connection.features.supports_partial_indexes:
            with self.assertRaises(IntegrityError):
                Pony.objects.create(pink=1, weight=7.0)
        else:
            Pony.objects.create(pink=1, weight=7.0)
        # Test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards('test_crmo', editor, new_state, project_state)
        self.assertTableNotExists('test_crmo_pony')
        # Test deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], 'CreateModel')
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2]['options']['constraints'], [partial_unique_constraint])

    def test_create_model_managers(self):
        """
        The managers on a model are set.
        """
        project_state = self.set_up_test_model("test_cmoma")
        # Test the state alteration
        operation = migrations.CreateModel(
            "Food",
            fields=[
                ("id", models.AutoField(primary_key=True)),
            ],
            managers=[
                ("food_qs", FoodQuerySet.as_manager()),
                ("food_mgr", FoodManager("a", "b")),
                ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
            ]
        )
        self.assertEqual(operation.describe(), "Create model Food")
        new_state = project_state.clone()
        operation.state_forwards("test_cmoma", new_state)
        self.assertIn(("test_cmoma", "food"), new_state.models)
        managers = new_state.models["test_cmoma", "food"].managers
        self.assertEqual(managers[0][0], "food_qs")
        self.assertIsInstance(managers[0][1], models.Manager)
        self.assertEqual(managers[1][0], "food_mgr")
        self.assertIsInstance(managers[1][1], FoodManager)
        self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
        self.assertEqual(managers[2][0], "food_mgr_kwargs")
        self.assertIsInstance(managers[2][1], FoodManager)
        self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))

    def test_delete_model(self):
        """
        Tests the DeleteModel operation.
        """
        project_state = self.set_up_test_model("test_dlmo")
        # Test the state alteration
        operation = migrations.DeleteModel("Pony")
        self.assertEqual(operation.describe(), "Delete model Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_dlmo", new_state)
        self.assertNotIn(("test_dlmo", "pony"), new_state.models)
        # Test the database alteration
        self.assertTableExists("test_dlmo_pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_dlmo", editor, project_state, new_state)
        self.assertTableNotExists("test_dlmo_pony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_dlmo", editor, new_state, project_state)
        self.assertTableExists("test_dlmo_pony")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "DeleteModel")
        self.assertEqual(definition[1], [])
        self.assertEqual(list(definition[2]), ["name"])

    def test_delete_proxy_model(self):
        """
        Tests the DeleteModel operation ignores proxy models.
        """
        project_state = self.set_up_test_model("test_dlprmo", proxy_model=True)
        # Test the state alteration
        operation = migrations.DeleteModel("ProxyPony")
        new_state = project_state.clone()
        operation.state_forwards("test_dlprmo", new_state)
        self.assertIn(("test_dlprmo", "proxypony"), project_state.models)
        self.assertNotIn(("test_dlprmo", "proxypony"), new_state.models)
        # Test the database alteration
        self.assertTableExists("test_dlprmo_pony")
        self.assertTableNotExists("test_dlprmo_proxypony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_dlprmo", editor, project_state, new_state)
        self.assertTableExists("test_dlprmo_pony")
        self.assertTableNotExists("test_dlprmo_proxypony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_dlprmo", editor, new_state, project_state)
        self.assertTableExists("test_dlprmo_pony")
        self.assertTableNotExists("test_dlprmo_proxypony")

    def test_delete_mti_model(self):
        project_state = self.set_up_test_model('test_dlmtimo', mti_model=True)
        # Test the state alteration
        operation = migrations.DeleteModel('ShetlandPony')
        new_state = project_state.clone()
        operation.state_forwards('test_dlmtimo', new_state)
        self.assertIn(('test_dlmtimo', 'shetlandpony'), project_state.models)
        self.assertNotIn(('test_dlmtimo', 'shetlandpony'), new_state.models)
        # Test the database alteration
        self.assertTableExists('test_dlmtimo_pony')
        self.assertTableExists('test_dlmtimo_shetlandpony')
        self.assertColumnExists('test_dlmtimo_shetlandpony', 'pony_ptr_id')
        with connection.schema_editor() as editor:
            operation.database_forwards('test_dlmtimo', editor, project_state, new_state)
        self.assertTableExists('test_dlmtimo_pony')
        self.assertTableNotExists('test_dlmtimo_shetlandpony')
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards('test_dlmtimo', editor, new_state, project_state)
        self.assertTableExists('test_dlmtimo_pony')
        self.assertTableExists('test_dlmtimo_shetlandpony')
        self.assertColumnExists('test_dlmtimo_shetlandpony', 'pony_ptr_id')

    def test_rename_model(self):
        """
        Tests the RenameModel operation.
        """
        project_state = self.set_up_test_model("test_rnmo", related_model=True)
        # Test the state alteration
        operation = migrations.RenameModel("Pony", "Horse")
        self.assertEqual(operation.describe(), "Rename model Pony to Horse")
        # Test initial state and database
        self.assertIn(("test_rnmo", "pony"), project_state.models)
        self.assertNotIn(("test_rnmo", "horse"), project_state.models)
        self.assertTableExists("test_rnmo_pony")
        self.assertTableNotExists("test_rnmo_horse")
        if connection.features.supports_foreign_keys:
            self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
            self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
        # Migrate forwards
        new_state = project_state.clone()
        atomic_rename = connection.features.supports_atomic_references_rename
        new_state = self.apply_operations("test_rnmo", new_state, [operation], atomic=atomic_rename)
        # Test new state and database
        self.assertNotIn(("test_rnmo", "pony"), new_state.models)
        self.assertIn(("test_rnmo", "horse"), new_state.models)
        # RenameModel also repoints all incoming FKs and M2Ms
        self.assertEqual("test_rnmo.Horse", new_state.models["test_rnmo", "rider"].fields[1][1].remote_field.model)
        self.assertTableNotExists("test_rnmo_pony")
        self.assertTableExists("test_rnmo_horse")
        if connection.features.supports_foreign_keys:
            self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
            self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
        # Migrate backwards
        original_state = self.unapply_operations("test_rnmo", project_state, [operation], atomic=atomic_rename)
        # Test original state and database
        self.assertIn(("test_rnmo", "pony"), original_state.models)
        self.assertNotIn(("test_rnmo", "horse"), original_state.models)
        self.assertEqual("Pony", original_state.models["test_rnmo", "rider"].fields[1][1].remote_field.model)
        self.assertTableExists("test_rnmo_pony")
        self.assertTableNotExists("test_rnmo_horse")
        if connection.features.supports_foreign_keys:
            self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
            self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RenameModel")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'old_name': "Pony", 'new_name': "Horse"})

    def test_rename_model_state_forwards(self):
        """
        RenameModel operations shouldn't trigger the caching of rendered apps
        on state without prior apps.
        """
        state = ProjectState()
        state.add_model(ModelState('migrations', 'Foo', []))
        operation = migrations.RenameModel('Foo', 'Bar')
        operation.state_forwards('migrations', state)
        self.assertNotIn('apps', state.__dict__)
        self.assertNotIn(('migrations', 'foo'), state.models)
        self.assertIn(('migrations', 'bar'), state.models)
        # Now with apps cached.
        apps = state.apps
        operation = migrations.RenameModel('Bar', 'Foo')
        operation.state_forwards('migrations', state)
        self.assertIs(state.apps, apps)
        self.assertNotIn(('migrations', 'bar'), state.models)
        self.assertIn(('migrations', 'foo'), state.models)

    def test_rename_model_with_self_referential_fk(self):
        """
        Tests the RenameModel operation on model with self referential FK.
        """
        project_state = self.set_up_test_model("test_rmwsrf", related_model=True)
        # Test the state alteration
        operation = migrations.RenameModel("Rider", "HorseRider")
        self.assertEqual(operation.describe(), "Rename model Rider to HorseRider")
        new_state = project_state.clone()
        operation.state_forwards("test_rmwsrf", new_state)
        self.assertNotIn(("test_rmwsrf", "rider"), new_state.models)
        self.assertIn(("test_rmwsrf", "horserider"), new_state.models)
        # Remember, RenameModel also repoints all incoming FKs and M2Ms
        self.assertEqual(
            'self',
            new_state.models["test_rmwsrf", "horserider"].fields[2][1].remote_field.model
        )
        HorseRider = new_state.apps.get_model('test_rmwsrf', 'horserider')
        self.assertIs(HorseRider._meta.get_field('horserider').remote_field.model, HorseRider)
        # Test the database alteration
        self.assertTableExists("test_rmwsrf_rider")
        self.assertTableNotExists("test_rmwsrf_horserider")
        if connection.features.supports_foreign_keys:
            self.assertFKExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_rider", "id"))
            self.assertFKNotExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
        atomic_rename = connection.features.supports_atomic_references_rename
        with connection.schema_editor(atomic=atomic_rename) as editor:
            operation.database_forwards("test_rmwsrf", editor, project_state, new_state)
        self.assertTableNotExists("test_rmwsrf_rider")
        self.assertTableExists("test_rmwsrf_horserider")
        if connection.features.supports_foreign_keys:
            self.assertFKNotExists("test_rmwsrf_horserider", ["friend_id"], ("test_rmwsrf_rider", "id"))
            self.assertFKExists("test_rmwsrf_horserider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
        # And test reversal
        with connection.schema_editor(atomic=atomic_rename) as editor:
            operation.database_backwards("test_rmwsrf", editor, new_state, project_state)
        self.assertTableExists("test_rmwsrf_rider")
        self.assertTableNotExists("test_rmwsrf_horserider")
        if connection.features.supports_foreign_keys:
            self.assertFKExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_rider", "id"))
            self.assertFKNotExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_horserider", "id"))

    def test_rename_model_with_superclass_fk(self):
        """
        Tests the RenameModel operation on a model which has a superclass that
        has a foreign key.
        """
        project_state = self.set_up_test_model("test_rmwsc", related_model=True, mti_model=True)
        # Test the state alteration
        operation = migrations.RenameModel("ShetlandPony", "LittleHorse")
        self.assertEqual(operation.describe(), "Rename model ShetlandPony to LittleHorse")
        new_state = project_state.clone()
        operation.state_forwards("test_rmwsc", new_state)
        self.assertNotIn(("test_rmwsc", "shetlandpony"), new_state.models)
        self.assertIn(("test_rmwsc", "littlehorse"), new_state.models)
        # RenameModel shouldn't repoint the superclass's relations, only local ones
        self.assertEqual(
            project_state.models["test_rmwsc", "rider"].fields[1][1].remote_field.model,
            new_state.models["test_rmwsc", "rider"].fields[1][1].remote_field.model
        )
        # Before running the migration we have a table for Shetland Pony, not Little Horse
        self.assertTableExists("test_rmwsc_shetlandpony")
        self.assertTableNotExists("test_rmwsc_littlehorse")
        if connection.features.supports_foreign_keys:
            # and the foreign key on rider points to pony, not shetland pony
            self.assertFKExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_pony", "id"))
            self.assertFKNotExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_shetlandpony", "id"))
        with connection.schema_editor(atomic=connection.features.supports_atomic_references_rename) as editor:
            operation.database_forwards("test_rmwsc", editor, project_state, new_state)
        # Now we have a little horse table, not shetland pony
        self.assertTableNotExists("test_rmwsc_shetlandpony")
        self.assertTableExists("test_rmwsc_littlehorse")
        if connection.features.supports_foreign_keys:
            # but the Foreign keys still point at pony, not little horse
            self.assertFKExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_pony", "id"))
            self.assertFKNotExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_littlehorse", "id"))

    def test_rename_model_with_self_referential_m2m(self):
        app_label = "test_rename_model_with_self_referential_m2m"

        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel("ReflexivePony", fields=[
                ("id", models.AutoField(primary_key=True)),
                ("ponies", models.ManyToManyField("self")),
            ]),
        ])
        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.RenameModel("ReflexivePony", "ReflexivePony2"),
        ], atomic=connection.features.supports_atomic_references_rename)
        Pony = project_state.apps.get_model(app_label, "ReflexivePony2")
        pony = Pony.objects.create()
        pony.ponies.add(pony)

    def test_rename_model_with_m2m(self):
        app_label = "test_rename_model_with_m2m"
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel("Rider", fields=[
                ("id", models.AutoField(primary_key=True)),
            ]),
            migrations.CreateModel("Pony", fields=[
                ("id", models.AutoField(primary_key=True)),
                ("riders", models.ManyToManyField("Rider")),
            ]),
        ])
        Pony = project_state.apps.get_model(app_label, "Pony")
        Rider = project_state.apps.get_model(app_label, "Rider")
        pony = Pony.objects.create()
        rider = Rider.objects.create()
        pony.riders.add(rider)

        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.RenameModel("Pony", "Pony2"),
        ], atomic=connection.features.supports_atomic_references_rename)
        Pony = project_state.apps.get_model(app_label, "Pony2")
        Rider = project_state.apps.get_model(app_label, "Rider")
        pony = Pony.objects.create()
        rider = Rider.objects.create()
        pony.riders.add(rider)
        self.assertEqual(Pony.objects.count(), 2)
        self.assertEqual(Rider.objects.count(), 2)
        self.assertEqual(Pony._meta.get_field('riders').remote_field.through.objects.count(), 2)

    def test_rename_m2m_target_model(self):
        app_label = "test_rename_m2m_target_model"
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel("Rider", fields=[
                ("id", models.AutoField(primary_key=True)),
            ]),
            migrations.CreateModel("Pony", fields=[
                ("id", models.AutoField(primary_key=True)),
                ("riders", models.ManyToManyField("Rider")),
            ]),
        ])
        Pony = project_state.apps.get_model(app_label, "Pony")
        Rider = project_state.apps.get_model(app_label, "Rider")
        pony = Pony.objects.create()
        rider = Rider.objects.create()
        pony.riders.add(rider)

        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.RenameModel("Rider", "Rider2"),
        ], atomic=connection.features.supports_atomic_references_rename)
        Pony = project_state.apps.get_model(app_label, "Pony")
        Rider = project_state.apps.get_model(app_label, "Rider2")
        pony = Pony.objects.create()
        rider = Rider.objects.create()
        pony.riders.add(rider)
        self.assertEqual(Pony.objects.count(), 2)
        self.assertEqual(Rider.objects.count(), 2)
        self.assertEqual(Pony._meta.get_field('riders').remote_field.through.objects.count(), 2)

    def test_rename_m2m_through_model(self):
        app_label = "test_rename_through"
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel("Rider", fields=[
                ("id", models.AutoField(primary_key=True)),
            ]),
            migrations.CreateModel("Pony", fields=[
                ("id", models.AutoField(primary_key=True)),
            ]),
            migrations.CreateModel("PonyRider", fields=[
                ("id", models.AutoField(primary_key=True)),
                ("rider", models.ForeignKey("test_rename_through.Rider", models.CASCADE)),
                ("pony", models.ForeignKey("test_rename_through.Pony", models.CASCADE)),
            ]),
            migrations.AddField(
                "Pony",
                "riders",
                models.ManyToManyField("test_rename_through.Rider", through="test_rename_through.PonyRider"),
            ),
        ])
        Pony = project_state.apps.get_model(app_label, "Pony")
        Rider = project_state.apps.get_model(app_label, "Rider")
        PonyRider = project_state.apps.get_model(app_label, "PonyRider")
        pony = Pony.objects.create()
        rider = Rider.objects.create()
        PonyRider.objects.create(pony=pony, rider=rider)

        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.RenameModel("PonyRider", "PonyRider2"),
        ])
        Pony = project_state.apps.get_model(app_label, "Pony")
        Rider = project_state.apps.get_model(app_label, "Rider")
        PonyRider = project_state.apps.get_model(app_label, "PonyRider2")
        pony = Pony.objects.first()
        rider = Rider.objects.create()
        PonyRider.objects.create(pony=pony, rider=rider)
        self.assertEqual(Pony.objects.count(), 1)
        self.assertEqual(Rider.objects.count(), 2)
        self.assertEqual(PonyRider.objects.count(), 2)
        self.assertEqual(pony.riders.count(), 2)

    def test_rename_m2m_model_after_rename_field(self):
        """RenameModel renames a many-to-many column after a RenameField."""
        app_label = 'test_rename_multiple'
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel('Pony', fields=[
                ('id', models.AutoField(primary_key=True)),
                ('name', models.CharField(max_length=20)),
            ]),
            migrations.CreateModel('Rider', fields=[
                ('id', models.AutoField(primary_key=True)),
                ('pony', models.ForeignKey('test_rename_multiple.Pony', models.CASCADE)),
            ]),
            migrations.CreateModel('PonyRider', fields=[
                ('id', models.AutoField(primary_key=True)),
                ('riders', models.ManyToManyField('Rider')),
            ]),
            migrations.RenameField(model_name='pony', old_name='name', new_name='fancy_name'),
            migrations.RenameModel(old_name='Rider', new_name='Jockey'),
        ], atomic=connection.features.supports_atomic_references_rename)
        Pony = project_state.apps.get_model(app_label, 'Pony')
        Jockey = project_state.apps.get_model(app_label, 'Jockey')
        PonyRider = project_state.apps.get_model(app_label, 'PonyRider')
        # No "no such column" error means the column was renamed correctly.
        pony = Pony.objects.create(fancy_name='a good name')
        jockey = Jockey.objects.create(pony=pony)
        ponyrider = PonyRider.objects.create()
        ponyrider.riders.add(jockey)

    def test_add_field(self):
        """
        Tests the AddField operation.
        """
        # Test the state alteration
        operation = migrations.AddField(
            "Pony",
            "height",
            models.FloatField(null=True, default=5),
        )
        self.assertEqual(operation.describe(), "Add field height to Pony")
        project_state, new_state = self.make_test_state("test_adfl", operation)
        self.assertEqual(len(new_state.models["test_adfl", "pony"].fields), 4)
        field = [
            f for n, f in new_state.models["test_adfl", "pony"].fields
            if n == "height"
        ][0]
        self.assertEqual(field.default, 5)
        # Test the database alteration
        self.assertColumnNotExists("test_adfl_pony", "height")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_adfl", editor, project_state, new_state)
        self.assertColumnExists("test_adfl_pony", "height")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_adfl", editor, new_state, project_state)
        self.assertColumnNotExists("test_adfl_pony", "height")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AddField")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["field", "model_name", "name"])

    def test_add_charfield(self):
        """
        Tests the AddField operation on TextField.
        """
        project_state = self.set_up_test_model("test_adchfl")

        Pony = project_state.apps.get_model("test_adchfl", "Pony")
        pony = Pony.objects.create(weight=42)

        new_state = self.apply_operations("test_adchfl", project_state, [
            migrations.AddField(
                "Pony",
                "text",
                models.CharField(max_length=10, default="some text"),
            ),
            migrations.AddField(
                "Pony",
                "empty",
                models.CharField(max_length=10, default=""),
            ),
            # If not properly quoted digits would be interpreted as an int.
            migrations.AddField(
                "Pony",
                "digits",
                models.CharField(max_length=10, default="42"),
            ),
            # Manual quoting is fragile and could trip on quotes. Refs #xyz.
            migrations.AddField(
                "Pony",
                "quotes",
                models.CharField(max_length=10, default='"\'"'),
            ),
        ])

        Pony = new_state.apps.get_model("test_adchfl", "Pony")
        pony = Pony.objects.get(pk=pony.pk)
        self.assertEqual(pony.text, "some text")
        self.assertEqual(pony.empty, "")
        self.assertEqual(pony.digits, "42")
        self.assertEqual(pony.quotes, '"\'"')

    def test_add_textfield(self):
        """
        Tests the AddField operation on TextField.
        """
        project_state = self.set_up_test_model("test_adtxtfl")

        Pony = project_state.apps.get_model("test_adtxtfl", "Pony")
        pony = Pony.objects.create(weight=42)

        new_state = self.apply_operations("test_adtxtfl", project_state, [
            migrations.AddField(
                "Pony",
                "text",
                models.TextField(default="some text"),
            ),
            migrations.AddField(
                "Pony",
                "empty",
                models.TextField(default=""),
            ),
            # If not properly quoted digits would be interpreted as an int.
            migrations.AddField(
                "Pony",
                "digits",
                models.TextField(default="42"),
            ),
            # Manual quoting is fragile and could trip on quotes. Refs #xyz.
            migrations.AddField(
                "Pony",
                "quotes",
                models.TextField(default='"\'"'),
            ),
        ])

        Pony = new_state.apps.get_model("test_adtxtfl", "Pony")
        pony = Pony.objects.get(pk=pony.pk)
        self.assertEqual(pony.text, "some text")
        self.assertEqual(pony.empty, "")
        self.assertEqual(pony.digits, "42")
        self.assertEqual(pony.quotes, '"\'"')

    def test_add_binaryfield(self):
        """
        Tests the AddField operation on TextField/BinaryField.
        """
        project_state = self.set_up_test_model("test_adbinfl")

        Pony = project_state.apps.get_model("test_adbinfl", "Pony")
        pony = Pony.objects.create(weight=42)

        new_state = self.apply_operations("test_adbinfl", project_state, [
            migrations.AddField(
                "Pony",
                "blob",
                models.BinaryField(default=b"some text"),
            ),
            migrations.AddField(
                "Pony",
                "empty",
                models.BinaryField(default=b""),
            ),
            # If not properly quoted digits would be interpreted as an int.
            migrations.AddField(
                "Pony",
                "digits",
                models.BinaryField(default=b"42"),
            ),
            # Manual quoting is fragile and could trip on quotes. Refs #xyz.
            migrations.AddField(
                "Pony",
                "quotes",
                models.BinaryField(default=b'"\'"'),
            ),
        ])

        Pony = new_state.apps.get_model("test_adbinfl", "Pony")
        pony = Pony.objects.get(pk=pony.pk)
        # SQLite returns buffer/memoryview, cast to bytes for checking.
        self.assertEqual(bytes(pony.blob), b"some text")
        self.assertEqual(bytes(pony.empty), b"")
        self.assertEqual(bytes(pony.digits), b"42")
        self.assertEqual(bytes(pony.quotes), b'"\'"')

    def test_column_name_quoting(self):
        """
        Column names that are SQL keywords shouldn't cause problems when used
        in migrations (#22168).
        """
        project_state = self.set_up_test_model("test_regr22168")
        operation = migrations.AddField(
            "Pony",
            "order",
            models.IntegerField(default=0),
        )
        new_state = project_state.clone()
        operation.state_forwards("test_regr22168", new_state)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_regr22168", editor, project_state, new_state)
        self.assertColumnExists("test_regr22168_pony", "order")

    def test_add_field_preserve_default(self):
        """
        Tests the AddField operation's state alteration
        when preserve_default = False.
        """
        project_state = self.set_up_test_model("test_adflpd")
        # Test the state alteration
        operation = migrations.AddField(
            "Pony",
            "height",
            models.FloatField(null=True, default=4),
            preserve_default=False,
        )
        new_state = project_state.clone()
        operation.state_forwards("test_adflpd", new_state)
        self.assertEqual(len(new_state.models["test_adflpd", "pony"].fields), 4)
        field = [
            f for n, f in new_state.models["test_adflpd", "pony"].fields
            if n == "height"
        ][0]
        self.assertEqual(field.default, NOT_PROVIDED)
        # Test the database alteration
        project_state.apps.get_model("test_adflpd", "pony").objects.create(
            weight=4,
        )
        self.assertColumnNotExists("test_adflpd_pony", "height")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_adflpd", editor, project_state, new_state)
        self.assertColumnExists("test_adflpd_pony", "height")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AddField")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["field", "model_name", "name", "preserve_default"])

    def test_add_field_m2m(self):
        """
        Tests the AddField operation with a ManyToManyField.
        """
        project_state = self.set_up_test_model("test_adflmm", second_model=True)
        # Test the state alteration
        operation = migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
        new_state = project_state.clone()
        operation.state_forwards("test_adflmm", new_state)
        self.assertEqual(len(new_state.models["test_adflmm", "pony"].fields), 4)
        # Test the database alteration
        self.assertTableNotExists("test_adflmm_pony_stables")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_adflmm", editor, project_state, new_state)
        self.assertTableExists("test_adflmm_pony_stables")
        self.assertColumnNotExists("test_adflmm_pony", "stables")
        # Make sure the M2M field actually works
        with atomic():
            Pony = new_state.apps.get_model("test_adflmm", "Pony")
            p = Pony.objects.create(pink=False, weight=4.55)
            p.stables.create()
            self.assertEqual(p.stables.count(), 1)
            p.stables.all().delete()
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_adflmm", editor, new_state, project_state)
        self.assertTableNotExists("test_adflmm_pony_stables")

    def test_alter_field_m2m(self):
        project_state = self.set_up_test_model("test_alflmm", second_model=True)

        project_state = self.apply_operations("test_alflmm", project_state, operations=[
            migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
        ])
        Pony = project_state.apps.get_model("test_alflmm", "Pony")
        self.assertFalse(Pony._meta.get_field('stables').blank)

        project_state = self.apply_operations("test_alflmm", project_state, operations=[
            migrations.AlterField(
                "Pony", "stables", models.ManyToManyField(to="Stable", related_name="ponies", blank=True)
            )
        ])
        Pony = project_state.apps.get_model("test_alflmm", "Pony")
        self.assertTrue(Pony._meta.get_field('stables').blank)

    def test_repoint_field_m2m(self):
        project_state = self.set_up_test_model("test_alflmm", second_model=True, third_model=True)

        project_state = self.apply_operations("test_alflmm", project_state, operations=[
            migrations.AddField("Pony", "places", models.ManyToManyField("Stable", related_name="ponies"))
        ])
        Pony = project_state.apps.get_model("test_alflmm", "Pony")

        project_state = self.apply_operations("test_alflmm", project_state, operations=[
            migrations.AlterField("Pony", "places", models.ManyToManyField(to="Van", related_name="ponies"))
        ])

        # Ensure the new field actually works
        Pony = project_state.apps.get_model("test_alflmm", "Pony")
        p = Pony.objects.create(pink=False, weight=4.55)
        p.places.create()
        self.assertEqual(p.places.count(), 1)
        p.places.all().delete()

    def test_remove_field_m2m(self):
        project_state = self.set_up_test_model("test_rmflmm", second_model=True)

        project_state = self.apply_operations("test_rmflmm", project_state, operations=[
            migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
        ])
        self.assertTableExists("test_rmflmm_pony_stables")

        with_field_state = project_state.clone()
        operations = [migrations.RemoveField("Pony", "stables")]
        project_state = self.apply_operations("test_rmflmm", project_state, operations=operations)
        self.assertTableNotExists("test_rmflmm_pony_stables")

        # And test reversal
        self.unapply_operations("test_rmflmm", with_field_state, operations=operations)
        self.assertTableExists("test_rmflmm_pony_stables")

    def test_remove_field_m2m_with_through(self):
        project_state = self.set_up_test_model("test_rmflmmwt", second_model=True)

        self.assertTableNotExists("test_rmflmmwt_ponystables")
        project_state = self.apply_operations("test_rmflmmwt", project_state, operations=[
            migrations.CreateModel("PonyStables", fields=[
                ("pony", models.ForeignKey('test_rmflmmwt.Pony', models.CASCADE)),
                ("stable", models.ForeignKey('test_rmflmmwt.Stable', models.CASCADE)),
            ]),
            migrations.AddField(
                "Pony", "stables",
                models.ManyToManyField("Stable", related_name="ponies", through='test_rmflmmwt.PonyStables')
            )
        ])
        self.assertTableExists("test_rmflmmwt_ponystables")

        operations = [migrations.RemoveField("Pony", "stables"), migrations.DeleteModel("PonyStables")]
        self.apply_operations("test_rmflmmwt", project_state, operations=operations)

    def test_remove_field(self):
        """
        Tests the RemoveField operation.
        """
        project_state = self.set_up_test_model("test_rmfl")
        # Test the state alteration
        operation = migrations.RemoveField("Pony", "pink")
        self.assertEqual(operation.describe(), "Remove field pink from Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_rmfl", new_state)
        self.assertEqual(len(new_state.models["test_rmfl", "pony"].fields), 2)
        # Test the database alteration
        self.assertColumnExists("test_rmfl_pony", "pink")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_rmfl", editor, project_state, new_state)
        self.assertColumnNotExists("test_rmfl_pony", "pink")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_rmfl", editor, new_state, project_state)
        self.assertColumnExists("test_rmfl_pony", "pink")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RemoveField")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': "Pony", 'name': 'pink'})

    def test_remove_fk(self):
        """
        Tests the RemoveField operation on a foreign key.
        """
        project_state = self.set_up_test_model("test_rfk", related_model=True)
        self.assertColumnExists("test_rfk_rider", "pony_id")
        operation = migrations.RemoveField("Rider", "pony")

        new_state = project_state.clone()
        operation.state_forwards("test_rfk", new_state)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_rfk", editor, project_state, new_state)
        self.assertColumnNotExists("test_rfk_rider", "pony_id")
        with connection.schema_editor() as editor:
            operation.database_backwards("test_rfk", editor, new_state, project_state)
        self.assertColumnExists("test_rfk_rider", "pony_id")

    def test_alter_model_table(self):
        """
        Tests the AlterModelTable operation.
        """
        project_state = self.set_up_test_model("test_almota")
        # Test the state alteration
        operation = migrations.AlterModelTable("Pony", "test_almota_pony_2")
        self.assertEqual(operation.describe(), "Rename table for Pony to test_almota_pony_2")
        new_state = project_state.clone()
        operation.state_forwards("test_almota", new_state)
        self.assertEqual(new_state.models["test_almota", "pony"].options["db_table"], "test_almota_pony_2")
        # Test the database alteration
        self.assertTableExists("test_almota_pony")
        self.assertTableNotExists("test_almota_pony_2")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_almota", editor, project_state, new_state)
        self.assertTableNotExists("test_almota_pony")
        self.assertTableExists("test_almota_pony_2")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_almota", editor, new_state, project_state)
        self.assertTableExists("test_almota_pony")
        self.assertTableNotExists("test_almota_pony_2")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterModelTable")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'name': "Pony", 'table': "test_almota_pony_2"})

    def test_alter_model_table_none(self):
        """
        Tests the AlterModelTable operation if the table name is set to None.
        """
        operation = migrations.AlterModelTable("Pony", None)
        self.assertEqual(operation.describe(), "Rename table for Pony to (default)")

    def test_alter_model_table_noop(self):
        """
        Tests the AlterModelTable operation if the table name is not changed.
        """
        project_state = self.set_up_test_model("test_almota")
        # Test the state alteration
        operation = migrations.AlterModelTable("Pony", "test_almota_pony")
        new_state = project_state.clone()
        operation.state_forwards("test_almota", new_state)
        self.assertEqual(new_state.models["test_almota", "pony"].options["db_table"], "test_almota_pony")
        # Test the database alteration
        self.assertTableExists("test_almota_pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_almota", editor, project_state, new_state)
        self.assertTableExists("test_almota_pony")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_almota", editor, new_state, project_state)
        self.assertTableExists("test_almota_pony")

    def test_alter_model_table_m2m(self):
        """
        AlterModelTable should rename auto-generated M2M tables.
        """
        app_label = "test_talflmltlm2m"
        pony_db_table = 'pony_foo'
        project_state = self.set_up_test_model(app_label, second_model=True, db_table=pony_db_table)
        # Add the M2M field
        first_state = project_state.clone()
        operation = migrations.AddField("Pony", "stables", models.ManyToManyField("Stable"))
        operation.state_forwards(app_label, first_state)
        with connection.schema_editor() as editor:
            operation.database_forwards(app_label, editor, project_state, first_state)
        original_m2m_table = "%s_%s" % (pony_db_table, "stables")
        new_m2m_table = "%s_%s" % (app_label, "pony_stables")
        self.assertTableExists(original_m2m_table)
        self.assertTableNotExists(new_m2m_table)
        # Rename the Pony db_table which should also rename the m2m table.
        second_state = first_state.clone()
        operation = migrations.AlterModelTable(name='pony', table=None)
        operation.state_forwards(app_label, second_state)
        atomic_rename = connection.features.supports_atomic_references_rename
        with connection.schema_editor(atomic=atomic_rename) as editor:
            operation.database_forwards(app_label, editor, first_state, second_state)
        self.assertTableExists(new_m2m_table)
        self.assertTableNotExists(original_m2m_table)
        # And test reversal
        with connection.schema_editor(atomic=atomic_rename) as editor:
            operation.database_backwards(app_label, editor, second_state, first_state)
        self.assertTableExists(original_m2m_table)
        self.assertTableNotExists(new_m2m_table)

    def test_alter_field(self):
        """
        Tests the AlterField operation.
        """
        project_state = self.set_up_test_model("test_alfl")
        # Test the state alteration
        operation = migrations.AlterField("Pony", "pink", models.IntegerField(null=True))
        self.assertEqual(operation.describe(), "Alter field pink on Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_alfl", new_state)
        self.assertIs(project_state.models["test_alfl", "pony"].get_field_by_name("pink").null, False)
        self.assertIs(new_state.models["test_alfl", "pony"].get_field_by_name("pink").null, True)
        # Test the database alteration
        self.assertColumnNotNull("test_alfl_pony", "pink")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_alfl", editor, project_state, new_state)
        self.assertColumnNull("test_alfl_pony", "pink")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_alfl", editor, new_state, project_state)
        self.assertColumnNotNull("test_alfl_pony", "pink")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterField")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["field", "model_name", "name"])

    def test_alter_field_pk(self):
        """
        Tests the AlterField operation on primary keys (for things like PostgreSQL's SERIAL weirdness)
        """
        project_state = self.set_up_test_model("test_alflpk")
        # Test the state alteration
        operation = migrations.AlterField("Pony", "id", models.IntegerField(primary_key=True))
        new_state = project_state.clone()
        operation.state_forwards("test_alflpk", new_state)
        self.assertIsInstance(project_state.models["test_alflpk", "pony"].get_field_by_name("id"), models.AutoField)
        self.assertIsInstance(new_state.models["test_alflpk", "pony"].get_field_by_name("id"), models.IntegerField)
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_alflpk", editor, project_state, new_state)
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_alflpk", editor, new_state, project_state)

    @skipUnlessDBFeature('supports_foreign_keys')
    def test_alter_field_pk_fk(self):
        """
        Tests the AlterField operation on primary keys changes any FKs pointing to it.
        """
        project_state = self.set_up_test_model("test_alflpkfk", related_model=True)
        # Test the state alteration
        operation = migrations.AlterField("Pony", "id", models.FloatField(primary_key=True))
        new_state = project_state.clone()
        operation.state_forwards("test_alflpkfk", new_state)
        self.assertIsInstance(project_state.models["test_alflpkfk", "pony"].get_field_by_name("id"), models.AutoField)
        self.assertIsInstance(new_state.models["test_alflpkfk", "pony"].get_field_by_name("id"), models.FloatField)

        def assertIdTypeEqualsFkType():
            with connection.cursor() as cursor:
                id_type, id_null = [
                    (c.type_code, c.null_ok)
                    for c in connection.introspection.get_table_description(cursor, "test_alflpkfk_pony")
                    if c.name == "id"
                ][0]
                fk_type, fk_null = [
                    (c.type_code, c.null_ok)
                    for c in connection.introspection.get_table_description(cursor, "test_alflpkfk_rider")
                    if c.name == "pony_id"
                ][0]
            self.assertEqual(id_type, fk_type)
            self.assertEqual(id_null, fk_null)

        assertIdTypeEqualsFkType()
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_alflpkfk", editor, project_state, new_state)
        assertIdTypeEqualsFkType()
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_alflpkfk", editor, new_state, project_state)
        assertIdTypeEqualsFkType()

    def test_alter_field_reloads_state_on_fk_target_changes(self):
        """
        If AlterField doesn't reload state appropriately, the second AlterField
        crashes on MySQL due to not dropping the PonyRider.pony foreign key
        constraint before modifying the column.
        """
        app_label = 'alter_alter_field_reloads_state_on_fk_target_changes'
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel('Rider', fields=[
                ('id', models.CharField(primary_key=True, max_length=100)),
            ]),
            migrations.CreateModel('Pony', fields=[
                ('id', models.CharField(primary_key=True, max_length=100)),
                ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE)),
            ]),
            migrations.CreateModel('PonyRider', fields=[
                ('id', models.AutoField(primary_key=True)),
                ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE)),
            ]),
        ])
        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.AlterField('Rider', 'id', models.CharField(primary_key=True, max_length=99)),
            migrations.AlterField('Pony', 'id', models.CharField(primary_key=True, max_length=99)),
        ])

    def test_alter_field_reloads_state_on_fk_with_to_field_target_changes(self):
        """
        If AlterField doesn't reload state appropriately, the second AlterField
        crashes on MySQL due to not dropping the PonyRider.pony foreign key
        constraint before modifying the column.
        """
        app_label = 'alter_alter_field_reloads_state_on_fk_with_to_field_target_changes'
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel('Rider', fields=[
                ('id', models.CharField(primary_key=True, max_length=100)),
                ('slug', models.CharField(unique=True, max_length=100)),
            ]),
            migrations.CreateModel('Pony', fields=[
                ('id', models.CharField(primary_key=True, max_length=100)),
                ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE, to_field='slug')),
                ('slug', models.CharField(unique=True, max_length=100)),
            ]),
            migrations.CreateModel('PonyRider', fields=[
                ('id', models.AutoField(primary_key=True)),
                ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE, to_field='slug')),
            ]),
        ])
        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.AlterField('Rider', 'slug', models.CharField(unique=True, max_length=99)),
            migrations.AlterField('Pony', 'slug', models.CharField(unique=True, max_length=99)),
        ])

    def test_rename_field_reloads_state_on_fk_target_changes(self):
        """
        If RenameField doesn't reload state appropriately, the AlterField
        crashes on MySQL due to not dropping the PonyRider.pony foreign key
        constraint before modifying the column.
        """
        app_label = 'alter_rename_field_reloads_state_on_fk_target_changes'
        project_state = self.apply_operations(app_label, ProjectState(), operations=[
            migrations.CreateModel('Rider', fields=[
                ('id', models.CharField(primary_key=True, max_length=100)),
            ]),
            migrations.CreateModel('Pony', fields=[
                ('id', models.CharField(primary_key=True, max_length=100)),
                ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE)),
            ]),
            migrations.CreateModel('PonyRider', fields=[
                ('id', models.AutoField(primary_key=True)),
                ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE)),
            ]),
        ])
        project_state = self.apply_operations(app_label, project_state, operations=[
            migrations.RenameField('Rider', 'id', 'id2'),
            migrations.AlterField('Pony', 'id', models.CharField(primary_key=True, max_length=99)),
        ], atomic=connection.features.supports_atomic_references_rename)

    def test_rename_field(self):
        """
        Tests the RenameField operation.
        """
        project_state = self.set_up_test_model("test_rnfl", unique_together=True, index_together=True)
        # Test the state alteration
        operation = migrations.RenameField("Pony", "pink", "blue")
        self.assertEqual(operation.describe(), "Rename field pink on Pony to blue")
        new_state = project_state.clone()
        operation.state_forwards("test_rnfl", new_state)
        self.assertIn("blue", [n for n, f in new_state.models["test_rnfl", "pony"].fields])
        self.assertNotIn("pink", [n for n, f in new_state.models["test_rnfl", "pony"].fields])
        # Make sure the unique_together has the renamed column too
        self.assertIn("blue", new_state.models["test_rnfl", "pony"].options['unique_together'][0])
        self.assertNotIn("pink", new_state.models["test_rnfl", "pony"].options['unique_together'][0])
        # Make sure the index_together has the renamed column too
        self.assertIn("blue", new_state.models["test_rnfl", "pony"].options['index_together'][0])
        self.assertNotIn("pink", new_state.models["test_rnfl", "pony"].options['index_together'][0])
        # Test the database alteration
        self.assertColumnExists("test_rnfl_pony", "pink")
        self.assertColumnNotExists("test_rnfl_pony", "blue")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_rnfl", editor, project_state, new_state)
        self.assertColumnExists("test_rnfl_pony", "blue")
        self.assertColumnNotExists("test_rnfl_pony", "pink")
        # Ensure the unique constraint has been ported over
        with connection.cursor() as cursor:
            cursor.execute("INSERT INTO test_rnfl_pony (blue, weight) VALUES (1, 1)")
            with self.assertRaises(IntegrityError):
                with atomic():
                    cursor.execute("INSERT INTO test_rnfl_pony (blue, weight) VALUES (1, 1)")
            cursor.execute("DELETE FROM test_rnfl_pony")
        # Ensure the index constraint has been ported over
        self.assertIndexExists("test_rnfl_pony", ["weight", "blue"])
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_rnfl", editor, new_state, project_state)
        self.assertColumnExists("test_rnfl_pony", "pink")
        self.assertColumnNotExists("test_rnfl_pony", "blue")
        # Ensure the index constraint has been reset
        self.assertIndexExists("test_rnfl_pony", ["weight", "pink"])
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RenameField")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': "Pony", 'old_name': "pink", 'new_name': "blue"})

    def test_rename_missing_field(self):
        state = ProjectState()
        state.add_model(ModelState('app', 'model', []))
        with self.assertRaisesMessage(FieldDoesNotExist, "app.model has no field named 'field'"):
            migrations.RenameField('model', 'field', 'new_field').state_forwards('app', state)

    def test_rename_referenced_field_state_forward(self):
        state = ProjectState()
        state.add_model(ModelState('app', 'Model', [
            ('id', models.AutoField(primary_key=True)),
            ('field', models.IntegerField(unique=True)),
        ]))
        state.add_model(ModelState('app', 'OtherModel', [
            ('id', models.AutoField(primary_key=True)),
            ('fk', models.ForeignKey('Model', models.CASCADE, to_field='field')),
            ('fo', models.ForeignObject('Model', models.CASCADE, from_fields=('fk',), to_fields=('field',))),
        ]))
        operation = migrations.RenameField('Model', 'field', 'renamed')
        new_state = state.clone()
        operation.state_forwards('app', new_state)
        self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].remote_field.field_name, 'renamed')
        self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].from_fields, ['self'])
        self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].to_fields, ('renamed',))
        self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].from_fields, ('fk',))
        self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].to_fields, ('renamed',))
        operation = migrations.RenameField('OtherModel', 'fk', 'renamed_fk')
        new_state = state.clone()
        operation.state_forwards('app', new_state)
        self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].remote_field.field_name, 'renamed')
        self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].from_fields, ('self',))
        self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].to_fields, ('renamed',))
        self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].from_fields, ('renamed_fk',))
        self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].to_fields, ('renamed',))

    def test_alter_unique_together(self):
        """
        Tests the AlterUniqueTogether operation.
        """
        project_state = self.set_up_test_model("test_alunto")
        # Test the state alteration
        operation = migrations.AlterUniqueTogether("Pony", [("pink", "weight")])
        self.assertEqual(operation.describe(), "Alter unique_together for Pony (1 constraint(s))")
        new_state = project_state.clone()
        operation.state_forwards("test_alunto", new_state)
        self.assertEqual(len(project_state.models["test_alunto", "pony"].options.get("unique_together", set())), 0)
        self.assertEqual(len(new_state.models["test_alunto", "pony"].options.get("unique_together", set())), 1)
        # Make sure we can insert duplicate rows
        with connection.cursor() as cursor:
            cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
            cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
            cursor.execute("DELETE FROM test_alunto_pony")
            # Test the database alteration
            with connection.schema_editor() as editor:
                operation.database_forwards("test_alunto", editor, project_state, new_state)
            cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
            with self.assertRaises(IntegrityError):
                with atomic():
                    cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
            cursor.execute("DELETE FROM test_alunto_pony")
            # And test reversal
            with connection.schema_editor() as editor:
                operation.database_backwards("test_alunto", editor, new_state, project_state)
            cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
            cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
            cursor.execute("DELETE FROM test_alunto_pony")
        # Test flat unique_together
        operation = migrations.AlterUniqueTogether("Pony", ("pink", "weight"))
        operation.state_forwards("test_alunto", new_state)
        self.assertEqual(len(new_state.models["test_alunto", "pony"].options.get("unique_together", set())), 1)
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterUniqueTogether")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'name': "Pony", 'unique_together': {("pink", "weight")}})

    def test_alter_unique_together_remove(self):
        operation = migrations.AlterUniqueTogether("Pony", None)
        self.assertEqual(operation.describe(), "Alter unique_together for Pony (0 constraint(s))")

    def test_add_index(self):
        """
        Test the AddIndex operation.
        """
        project_state = self.set_up_test_model("test_adin")
        msg = (
            "Indexes passed to AddIndex operations require a name argument. "
            "<Index: fields='pink'> doesn't have one."
        )
        with self.assertRaisesMessage(ValueError, msg):
            migrations.AddIndex("Pony", models.Index(fields=["pink"]))
        index = models.Index(fields=["pink"], name="test_adin_pony_pink_idx")
        operation = migrations.AddIndex("Pony", index)
        self.assertEqual(operation.describe(), "Create index test_adin_pony_pink_idx on field(s) pink of model Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_adin", new_state)
        # Test the database alteration
        self.assertEqual(len(new_state.models["test_adin", "pony"].options['indexes']), 1)
        self.assertIndexNotExists("test_adin_pony", ["pink"])
        with connection.schema_editor() as editor:
            operation.database_forwards("test_adin", editor, project_state, new_state)
        self.assertIndexExists("test_adin_pony", ["pink"])
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_adin", editor, new_state, project_state)
        self.assertIndexNotExists("test_adin_pony", ["pink"])
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AddIndex")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': "Pony", 'index': index})

    def test_remove_index(self):
        """
        Test the RemoveIndex operation.
        """
        project_state = self.set_up_test_model("test_rmin", multicol_index=True)
        self.assertTableExists("test_rmin_pony")
        self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
        operation = migrations.RemoveIndex("Pony", "pony_test_idx")
        self.assertEqual(operation.describe(), "Remove index pony_test_idx from Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_rmin", new_state)
        # Test the state alteration
        self.assertEqual(len(new_state.models["test_rmin", "pony"].options['indexes']), 0)
        self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_rmin", editor, project_state, new_state)
        self.assertIndexNotExists("test_rmin_pony", ["pink", "weight"])
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_rmin", editor, new_state, project_state)
        self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RemoveIndex")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': "Pony", 'name': "pony_test_idx"})

        # Also test a field dropped with index - sqlite remake issue
        operations = [
            migrations.RemoveIndex("Pony", "pony_test_idx"),
            migrations.RemoveField("Pony", "pink"),
        ]
        self.assertColumnExists("test_rmin_pony", "pink")
        self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
        # Test database alteration
        new_state = project_state.clone()
        self.apply_operations('test_rmin', new_state, operations=operations)
        self.assertColumnNotExists("test_rmin_pony", "pink")
        self.assertIndexNotExists("test_rmin_pony", ["pink", "weight"])
        # And test reversal
        self.unapply_operations("test_rmin", project_state, operations=operations)
        self.assertIndexExists("test_rmin_pony", ["pink", "weight"])

    def test_add_index_state_forwards(self):
        project_state = self.set_up_test_model('test_adinsf')
        index = models.Index(fields=['pink'], name='test_adinsf_pony_pink_idx')
        old_model = project_state.apps.get_model('test_adinsf', 'Pony')
        new_state = project_state.clone()

        operation = migrations.AddIndex('Pony', index)
        operation.state_forwards('test_adinsf', new_state)
        new_model = new_state.apps.get_model('test_adinsf', 'Pony')
        self.assertIsNot(old_model, new_model)

    def test_remove_index_state_forwards(self):
        project_state = self.set_up_test_model('test_rminsf')
        index = models.Index(fields=['pink'], name='test_rminsf_pony_pink_idx')
        migrations.AddIndex('Pony', index).state_forwards('test_rminsf', project_state)
        old_model = project_state.apps.get_model('test_rminsf', 'Pony')
        new_state = project_state.clone()

        operation = migrations.RemoveIndex('Pony', 'test_rminsf_pony_pink_idx')
        operation.state_forwards('test_rminsf', new_state)
        new_model = new_state.apps.get_model('test_rminsf', 'Pony')
        self.assertIsNot(old_model, new_model)

    def test_alter_field_with_index(self):
        """
        Test AlterField operation with an index to ensure indexes created via
        Meta.indexes don't get dropped with sqlite3 remake.
        """
        project_state = self.set_up_test_model("test_alflin", index=True)
        operation = migrations.AlterField("Pony", "pink", models.IntegerField(null=True))
        new_state = project_state.clone()
        operation.state_forwards("test_alflin", new_state)
        # Test the database alteration
        self.assertColumnNotNull("test_alflin_pony", "pink")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_alflin", editor, project_state, new_state)
        # Index hasn't been dropped
        self.assertIndexExists("test_alflin_pony", ["pink"])
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_alflin", editor, new_state, project_state)
        # Ensure the index is still there
        self.assertIndexExists("test_alflin_pony", ["pink"])

    def test_alter_index_together(self):
        """
        Tests the AlterIndexTogether operation.
        """
        project_state = self.set_up_test_model("test_alinto")
        # Test the state alteration
        operation = migrations.AlterIndexTogether("Pony", [("pink", "weight")])
        self.assertEqual(operation.describe(), "Alter index_together for Pony (1 constraint(s))")
        new_state = project_state.clone()
        operation.state_forwards("test_alinto", new_state)
        self.assertEqual(len(project_state.models["test_alinto", "pony"].options.get("index_together", set())), 0)
        self.assertEqual(len(new_state.models["test_alinto", "pony"].options.get("index_together", set())), 1)
        # Make sure there's no matching index
        self.assertIndexNotExists("test_alinto_pony", ["pink", "weight"])
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_alinto", editor, project_state, new_state)
        self.assertIndexExists("test_alinto_pony", ["pink", "weight"])
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_alinto", editor, new_state, project_state)
        self.assertIndexNotExists("test_alinto_pony", ["pink", "weight"])
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterIndexTogether")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'name': "Pony", 'index_together': {("pink", "weight")}})

    def test_alter_index_together_remove(self):
        operation = migrations.AlterIndexTogether("Pony", None)
        self.assertEqual(operation.describe(), "Alter index_together for Pony (0 constraint(s))")

    @skipUnlessDBFeature('supports_table_check_constraints')
    def test_add_constraint(self):
        project_state = self.set_up_test_model("test_addconstraint")
        gt_check = models.Q(pink__gt=2)
        gt_constraint = models.CheckConstraint(check=gt_check, name="test_add_constraint_pony_pink_gt_2")
        gt_operation = migrations.AddConstraint("Pony", gt_constraint)
        self.assertEqual(
            gt_operation.describe(), "Create constraint test_add_constraint_pony_pink_gt_2 on model Pony"
        )
        # Test the state alteration
        new_state = project_state.clone()
        gt_operation.state_forwards("test_addconstraint", new_state)
        self.assertEqual(len(new_state.models["test_addconstraint", "pony"].options["constraints"]), 1)
        Pony = new_state.apps.get_model("test_addconstraint", "Pony")
        self.assertEqual(len(Pony._meta.constraints), 1)
        # Test the database alteration
        with connection.schema_editor() as editor:
            gt_operation.database_forwards("test_addconstraint", editor, project_state, new_state)
        with self.assertRaises(IntegrityError), transaction.atomic():
            Pony.objects.create(pink=1, weight=1.0)
        # Add another one.
        lt_check = models.Q(pink__lt=100)
        lt_constraint = models.CheckConstraint(check=lt_check, name="test_add_constraint_pony_pink_lt_100")
        lt_operation = migrations.AddConstraint("Pony", lt_constraint)
        lt_operation.state_forwards("test_addconstraint", new_state)
        self.assertEqual(len(new_state.models["test_addconstraint", "pony"].options["constraints"]), 2)
        Pony = new_state.apps.get_model("test_addconstraint", "Pony")
        self.assertEqual(len(Pony._meta.constraints), 2)
        with connection.schema_editor() as editor:
            lt_operation.database_forwards("test_addconstraint", editor, project_state, new_state)
        with self.assertRaises(IntegrityError), transaction.atomic():
            Pony.objects.create(pink=100, weight=1.0)
        # Test reversal
        with connection.schema_editor() as editor:
            gt_operation.database_backwards("test_addconstraint", editor, new_state, project_state)
        Pony.objects.create(pink=1, weight=1.0)
        # Test deconstruction
        definition = gt_operation.deconstruct()
        self.assertEqual(definition[0], "AddConstraint")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': "Pony", 'constraint': gt_constraint})

    @skipUnlessDBFeature('supports_table_check_constraints')
    def test_add_constraint_percent_escaping(self):
        app_label = 'add_constraint_string_quoting'
        operations = [
            CreateModel(
                'Author',
                fields=[
                    ('id', models.AutoField(primary_key=True)),
                    ('name', models.CharField(max_length=100)),
                    ('rebate', models.CharField(max_length=100)),
                ],
            ),
        ]
        from_state = self.apply_operations(app_label, ProjectState(), operations)
        # "%" generated in startswith lookup should be escaped in a way that is
        # considered a leading wildcard.
        check = models.Q(name__startswith='Albert')
        constraint = models.CheckConstraint(check=check, name='name_constraint')
        operation = migrations.AddConstraint('Author', constraint)
        to_state = from_state.clone()
        operation.state_forwards(app_label, to_state)
        with connection.schema_editor() as editor:
            operation.database_forwards(app_label, editor, from_state, to_state)
        Author = to_state.apps.get_model(app_label, 'Author')
        with self.assertRaises(IntegrityError), transaction.atomic():
            Author.objects.create(name='Artur')
        # Literal "%" should be escaped in a way that is not a considered a
        # wildcard.
        check = models.Q(rebate__endswith='%')
        constraint = models.CheckConstraint(check=check, name='rebate_constraint')
        operation = migrations.AddConstraint('Author', constraint)
        from_state = to_state
        to_state = from_state.clone()
        operation.state_forwards(app_label, to_state)
        Author = to_state.apps.get_model(app_label, 'Author')
        with connection.schema_editor() as editor:
            operation.database_forwards(app_label, editor, from_state, to_state)
        Author = to_state.apps.get_model(app_label, 'Author')
        with self.assertRaises(IntegrityError), transaction.atomic():
            Author.objects.create(name='Albert', rebate='10$')
        author = Author.objects.create(name='Albert', rebate='10%')
        self.assertEqual(Author.objects.get(), author)

    @skipUnlessDBFeature('supports_table_check_constraints')
    def test_add_or_constraint(self):
        app_label = 'test_addorconstraint'
        constraint_name = 'add_constraint_or'
        from_state = self.set_up_test_model(app_label)
        check = models.Q(pink__gt=2, weight__gt=2) | models.Q(weight__lt=0)
        constraint = models.CheckConstraint(check=check, name=constraint_name)
        operation = migrations.AddConstraint('Pony', constraint)
        to_state = from_state.clone()
        operation.state_forwards(app_label, to_state)
        with connection.schema_editor() as editor:
            operation.database_forwards(app_label, editor, from_state, to_state)
        Pony = to_state.apps.get_model(app_label, 'Pony')
        with self.assertRaises(IntegrityError), transaction.atomic():
            Pony.objects.create(pink=2, weight=3.0)
        with self.assertRaises(IntegrityError), transaction.atomic():
            Pony.objects.create(pink=3, weight=1.0)
        Pony.objects.bulk_create([
            Pony(pink=3, weight=-1.0),
            Pony(pink=1, weight=-1.0),
            Pony(pink=3, weight=3.0),
        ])

    @skipUnlessDBFeature('supports_table_check_constraints')
    def test_remove_constraint(self):
        project_state = self.set_up_test_model("test_removeconstraint", constraints=[
            models.CheckConstraint(check=models.Q(pink__gt=2), name="test_remove_constraint_pony_pink_gt_2"),
            models.CheckConstraint(check=models.Q(pink__lt=100), name="test_remove_constraint_pony_pink_lt_100"),
        ])
        gt_operation = migrations.RemoveConstraint("Pony", "test_remove_constraint_pony_pink_gt_2")
        self.assertEqual(
            gt_operation.describe(), "Remove constraint test_remove_constraint_pony_pink_gt_2 from model Pony"
        )
        # Test state alteration
        new_state = project_state.clone()
        gt_operation.state_forwards("test_removeconstraint", new_state)
        self.assertEqual(len(new_state.models["test_removeconstraint", "pony"].options['constraints']), 1)
        Pony = new_state.apps.get_model("test_removeconstraint", "Pony")
        self.assertEqual(len(Pony._meta.constraints), 1)
        # Test database alteration
        with connection.schema_editor() as editor:
            gt_operation.database_forwards("test_removeconstraint", editor, project_state, new_state)
        Pony.objects.create(pink=1, weight=1.0).delete()
        with self.assertRaises(IntegrityError), transaction.atomic():
            Pony.objects.create(pink=100, weight=1.0)
        # Remove the other one.
        lt_operation = migrations.RemoveConstraint("Pony", "test_remove_constraint_pony_pink_lt_100")
        lt_operation.state_forwards("test_removeconstraint", new_state)
        self.assertEqual(len(new_state.models["test_removeconstraint", "pony"].options['constraints']), 0)
        Pony = new_state.apps.get_model("test_removeconstraint", "Pony")
        self.assertEqual(len(Pony._meta.constraints), 0)
        with connection.schema_editor() as editor:
            lt_operation.database_forwards("test_removeconstraint", editor, project_state, new_state)
        Pony.objects.create(pink=100, weight=1.0).delete()
        # Test reversal
        with connection.schema_editor() as editor:
            gt_operation.database_backwards("test_removeconstraint", editor, new_state, project_state)
        with self.assertRaises(IntegrityError), transaction.atomic():
            Pony.objects.create(pink=1, weight=1.0)
        # Test deconstruction
        definition = gt_operation.deconstruct()
        self.assertEqual(definition[0], "RemoveConstraint")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': "Pony", 'name': "test_remove_constraint_pony_pink_gt_2"})

    def test_add_partial_unique_constraint(self):
        project_state = self.set_up_test_model('test_addpartialuniqueconstraint')
        partial_unique_constraint = models.UniqueConstraint(
            fields=['pink'],
            condition=models.Q(weight__gt=5),
            name='test_constraint_pony_pink_for_weight_gt_5_uniq',
        )
        operation = migrations.AddConstraint('Pony', partial_unique_constraint)
        self.assertEqual(
            operation.describe(),
            'Create constraint test_constraint_pony_pink_for_weight_gt_5_uniq '
            'on model Pony'
        )
        # Test the state alteration
        new_state = project_state.clone()
        operation.state_forwards('test_addpartialuniqueconstraint', new_state)
        self.assertEqual(len(new_state.models['test_addpartialuniqueconstraint', 'pony'].options['constraints']), 1)
        Pony = new_state.apps.get_model('test_addpartialuniqueconstraint', 'Pony')
        self.assertEqual(len(Pony._meta.constraints), 1)
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards('test_addpartialuniqueconstraint', editor, project_state, new_state)
        # Test constraint works
        Pony.objects.create(pink=1, weight=4.0)
        Pony.objects.create(pink=1, weight=4.0)
        Pony.objects.create(pink=1, weight=6.0)
        if connection.features.supports_partial_indexes:
            with self.assertRaises(IntegrityError), transaction.atomic():
                Pony.objects.create(pink=1, weight=7.0)
        else:
            Pony.objects.create(pink=1, weight=7.0)
        # Test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards('test_addpartialuniqueconstraint', editor, new_state, project_state)
        # Test constraint doesn't work
        Pony.objects.create(pink=1, weight=7.0)
        # Test deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], 'AddConstraint')
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'model_name': 'Pony', 'constraint': partial_unique_constraint})

    def test_remove_partial_unique_constraint(self):
        project_state = self.set_up_test_model('test_removepartialuniqueconstraint', constraints=[
            models.UniqueConstraint(
                fields=['pink'],
                condition=models.Q(weight__gt=5),
                name='test_constraint_pony_pink_for_weight_gt_5_uniq',
            ),
        ])
        gt_operation = migrations.RemoveConstraint('Pony', 'test_constraint_pony_pink_for_weight_gt_5_uniq')
        self.assertEqual(
            gt_operation.describe(), 'Remove constraint test_constraint_pony_pink_for_weight_gt_5_uniq from model Pony'
        )
        # Test state alteration
        new_state = project_state.clone()
        gt_operation.state_forwards('test_removepartialuniqueconstraint', new_state)
        self.assertEqual(len(new_state.models['test_removepartialuniqueconstraint', 'pony'].options['constraints']), 0)
        Pony = new_state.apps.get_model('test_removepartialuniqueconstraint', 'Pony')
        self.assertEqual(len(Pony._meta.constraints), 0)
        # Test database alteration
        with connection.schema_editor() as editor:
            gt_operation.database_forwards('test_removepartialuniqueconstraint', editor, project_state, new_state)
        # Test constraint doesn't work
        Pony.objects.create(pink=1, weight=4.0)
        Pony.objects.create(pink=1, weight=4.0)
        Pony.objects.create(pink=1, weight=6.0)
        Pony.objects.create(pink=1, weight=7.0).delete()
        # Test reversal
        with connection.schema_editor() as editor:
            gt_operation.database_backwards('test_removepartialuniqueconstraint', editor, new_state, project_state)
        # Test constraint works
        if connection.features.supports_partial_indexes:
            with self.assertRaises(IntegrityError), transaction.atomic():
                Pony.objects.create(pink=1, weight=7.0)
        else:
            Pony.objects.create(pink=1, weight=7.0)
        # Test deconstruction
        definition = gt_operation.deconstruct()
        self.assertEqual(definition[0], 'RemoveConstraint')
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {
            'model_name': 'Pony',
            'name': 'test_constraint_pony_pink_for_weight_gt_5_uniq',
        })

    def test_alter_model_options(self):
        """
        Tests the AlterModelOptions operation.
        """
        project_state = self.set_up_test_model("test_almoop")
        # Test the state alteration (no DB alteration to test)
        operation = migrations.AlterModelOptions("Pony", {"permissions": [("can_groom", "Can groom")]})
        self.assertEqual(operation.describe(), "Change Meta options on Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_almoop", new_state)
        self.assertEqual(len(project_state.models["test_almoop", "pony"].options.get("permissions", [])), 0)
        self.assertEqual(len(new_state.models["test_almoop", "pony"].options.get("permissions", [])), 1)
        self.assertEqual(new_state.models["test_almoop", "pony"].options["permissions"][0][0], "can_groom")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterModelOptions")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'name': "Pony", 'options': {"permissions": [("can_groom", "Can groom")]}})

    def test_alter_model_options_emptying(self):
        """
        The AlterModelOptions operation removes keys from the dict (#23121)
        """
        project_state = self.set_up_test_model("test_almoop", options=True)
        # Test the state alteration (no DB alteration to test)
        operation = migrations.AlterModelOptions("Pony", {})
        self.assertEqual(operation.describe(), "Change Meta options on Pony")
        new_state = project_state.clone()
        operation.state_forwards("test_almoop", new_state)
        self.assertEqual(len(project_state.models["test_almoop", "pony"].options.get("permissions", [])), 1)
        self.assertEqual(len(new_state.models["test_almoop", "pony"].options.get("permissions", [])), 0)
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterModelOptions")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'name': "Pony", 'options': {}})

    def test_alter_order_with_respect_to(self):
        """
        Tests the AlterOrderWithRespectTo operation.
        """
        project_state = self.set_up_test_model("test_alorwrtto", related_model=True)
        # Test the state alteration
        operation = migrations.AlterOrderWithRespectTo("Rider", "pony")
        self.assertEqual(operation.describe(), "Set order_with_respect_to on Rider to pony")
        new_state = project_state.clone()
        operation.state_forwards("test_alorwrtto", new_state)
        self.assertIsNone(
            project_state.models["test_alorwrtto", "rider"].options.get("order_with_respect_to", None)
        )
        self.assertEqual(
            new_state.models["test_alorwrtto", "rider"].options.get("order_with_respect_to", None),
            "pony"
        )
        # Make sure there's no matching index
        self.assertColumnNotExists("test_alorwrtto_rider", "_order")
        # Create some rows before alteration
        rendered_state = project_state.apps
        pony = rendered_state.get_model("test_alorwrtto", "Pony").objects.create(weight=50)
        rendered_state.get_model("test_alorwrtto", "Rider").objects.create(pony=pony, friend_id=1)
        rendered_state.get_model("test_alorwrtto", "Rider").objects.create(pony=pony, friend_id=2)
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_alorwrtto", editor, project_state, new_state)
        self.assertColumnExists("test_alorwrtto_rider", "_order")
        # Check for correct value in rows
        updated_riders = new_state.apps.get_model("test_alorwrtto", "Rider").objects.all()
        self.assertEqual(updated_riders[0]._order, 0)
        self.assertEqual(updated_riders[1]._order, 0)
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_alorwrtto", editor, new_state, project_state)
        self.assertColumnNotExists("test_alorwrtto_rider", "_order")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "AlterOrderWithRespectTo")
        self.assertEqual(definition[1], [])
        self.assertEqual(definition[2], {'name': "Rider", 'order_with_respect_to': "pony"})

    def test_alter_model_managers(self):
        """
        The managers on a model are set.
        """
        project_state = self.set_up_test_model("test_almoma")
        # Test the state alteration
        operation = migrations.AlterModelManagers(
            "Pony",
            managers=[
                ("food_qs", FoodQuerySet.as_manager()),
                ("food_mgr", FoodManager("a", "b")),
                ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
            ]
        )
        self.assertEqual(operation.describe(), "Change managers on Pony")
        managers = project_state.models["test_almoma", "pony"].managers
        self.assertEqual(managers, [])

        new_state = project_state.clone()
        operation.state_forwards("test_almoma", new_state)
        self.assertIn(("test_almoma", "pony"), new_state.models)
        managers = new_state.models["test_almoma", "pony"].managers
        self.assertEqual(managers[0][0], "food_qs")
        self.assertIsInstance(managers[0][1], models.Manager)
        self.assertEqual(managers[1][0], "food_mgr")
        self.assertIsInstance(managers[1][1], FoodManager)
        self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
        self.assertEqual(managers[2][0], "food_mgr_kwargs")
        self.assertIsInstance(managers[2][1], FoodManager)
        self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
        rendered_state = new_state.apps
        model = rendered_state.get_model('test_almoma', 'pony')
        self.assertIsInstance(model.food_qs, models.Manager)
        self.assertIsInstance(model.food_mgr, FoodManager)
        self.assertIsInstance(model.food_mgr_kwargs, FoodManager)

    def test_alter_model_managers_emptying(self):
        """
        The managers on a model are set.
        """
        project_state = self.set_up_test_model("test_almomae", manager_model=True)
        # Test the state alteration
        operation = migrations.AlterModelManagers("Food", managers=[])
        self.assertEqual(operation.describe(), "Change managers on Food")
        self.assertIn(("test_almomae", "food"), project_state.models)
        managers = project_state.models["test_almomae", "food"].managers
        self.assertEqual(managers[0][0], "food_qs")
        self.assertIsInstance(managers[0][1], models.Manager)
        self.assertEqual(managers[1][0], "food_mgr")
        self.assertIsInstance(managers[1][1], FoodManager)
        self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
        self.assertEqual(managers[2][0], "food_mgr_kwargs")
        self.assertIsInstance(managers[2][1], FoodManager)
        self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))

        new_state = project_state.clone()
        operation.state_forwards("test_almomae", new_state)
        managers = new_state.models["test_almomae", "food"].managers
        self.assertEqual(managers, [])

    def test_alter_fk(self):
        """
        Creating and then altering an FK works correctly
        and deals with the pending SQL (#23091)
        """
        project_state = self.set_up_test_model("test_alfk")
        # Test adding and then altering the FK in one go
        create_operation = migrations.CreateModel(
            name="Rider",
            fields=[
                ("id", models.AutoField(primary_key=True)),
                ("pony", models.ForeignKey("Pony", models.CASCADE)),
            ],
        )
        create_state = project_state.clone()
        create_operation.state_forwards("test_alfk", create_state)
        alter_operation = migrations.AlterField(
            model_name='Rider',
            name='pony',
            field=models.ForeignKey("Pony", models.CASCADE, editable=False),
        )
        alter_state = create_state.clone()
        alter_operation.state_forwards("test_alfk", alter_state)
        with connection.schema_editor() as editor:
            create_operation.database_forwards("test_alfk", editor, project_state, create_state)
            alter_operation.database_forwards("test_alfk", editor, create_state, alter_state)

    def test_alter_fk_non_fk(self):
        """
        Altering an FK to a non-FK works (#23244)
        """
        # Test the state alteration
        operation = migrations.AlterField(
            model_name="Rider",
            name="pony",
            field=models.FloatField(),
        )
        project_state, new_state = self.make_test_state("test_afknfk", operation, related_model=True)
        # Test the database alteration
        self.assertColumnExists("test_afknfk_rider", "pony_id")
        self.assertColumnNotExists("test_afknfk_rider", "pony")
        with connection.schema_editor() as editor:
            operation.database_forwards("test_afknfk", editor, project_state, new_state)
        self.assertColumnExists("test_afknfk_rider", "pony")
        self.assertColumnNotExists("test_afknfk_rider", "pony_id")
        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_afknfk", editor, new_state, project_state)
        self.assertColumnExists("test_afknfk_rider", "pony_id")
        self.assertColumnNotExists("test_afknfk_rider", "pony")

    def test_run_sql(self):
        """
        Tests the RunSQL operation.
        """
        project_state = self.set_up_test_model("test_runsql")
        # Create the operation
        operation = migrations.RunSQL(
            # Use a multi-line string with a comment to test splitting on SQLite and MySQL respectively
            "CREATE TABLE i_love_ponies (id int, special_thing varchar(15));\n"
            "INSERT INTO i_love_ponies (id, special_thing) VALUES (1, 'i love ponies'); -- this is magic!\n"
            "INSERT INTO i_love_ponies (id, special_thing) VALUES (2, 'i love django');\n"
            "UPDATE i_love_ponies SET special_thing = 'Ponies' WHERE special_thing LIKE '%%ponies';"
            "UPDATE i_love_ponies SET special_thing = 'Django' WHERE special_thing LIKE '%django';",

            # Run delete queries to test for parameter substitution failure
            # reported in #23426
            "DELETE FROM i_love_ponies WHERE special_thing LIKE '%Django%';"
            "DELETE FROM i_love_ponies WHERE special_thing LIKE '%%Ponies%%';"
            "DROP TABLE i_love_ponies",

            state_operations=[migrations.CreateModel("SomethingElse", [("id", models.AutoField(primary_key=True))])],
        )
        self.assertEqual(operation.describe(), "Raw SQL operation")
        # Test the state alteration
        new_state = project_state.clone()
        operation.state_forwards("test_runsql", new_state)
        self.assertEqual(len(new_state.models["test_runsql", "somethingelse"].fields), 1)
        # Make sure there's no table
        self.assertTableNotExists("i_love_ponies")
        # Test SQL collection
        with connection.schema_editor(collect_sql=True) as editor:
            operation.database_forwards("test_runsql", editor, project_state, new_state)
            self.assertIn("LIKE '%%ponies';", "\n".join(editor.collected_sql))
            operation.database_backwards("test_runsql", editor, project_state, new_state)
            self.assertIn("LIKE '%%Ponies%%';", "\n".join(editor.collected_sql))
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runsql", editor, project_state, new_state)
        self.assertTableExists("i_love_ponies")
        # Make sure all the SQL was processed
        with connection.cursor() as cursor:
            cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
            self.assertEqual(cursor.fetchall()[0][0], 2)
            cursor.execute("SELECT COUNT(*) FROM i_love_ponies WHERE special_thing = 'Django'")
            self.assertEqual(cursor.fetchall()[0][0], 1)
            cursor.execute("SELECT COUNT(*) FROM i_love_ponies WHERE special_thing = 'Ponies'")
            self.assertEqual(cursor.fetchall()[0][0], 1)
        # And test reversal
        self.assertTrue(operation.reversible)
        with connection.schema_editor() as editor:
            operation.database_backwards("test_runsql", editor, new_state, project_state)
        self.assertTableNotExists("i_love_ponies")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RunSQL")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["reverse_sql", "sql", "state_operations"])
        # And elidable reduction
        self.assertIs(False, operation.reduce(operation, []))
        elidable_operation = migrations.RunSQL('SELECT 1 FROM void;', elidable=True)
        self.assertEqual(elidable_operation.reduce(operation, []), [operation])

    def test_run_sql_params(self):
        """
        #23426 - RunSQL should accept parameters.
        """
        project_state = self.set_up_test_model("test_runsql")
        # Create the operation
        operation = migrations.RunSQL(
            ["CREATE TABLE i_love_ponies (id int, special_thing varchar(15));"],
            ["DROP TABLE i_love_ponies"],
        )
        param_operation = migrations.RunSQL(
            # forwards
            (
                "INSERT INTO i_love_ponies (id, special_thing) VALUES (1, 'Django');",
                ["INSERT INTO i_love_ponies (id, special_thing) VALUES (2, %s);", ['Ponies']],
                ("INSERT INTO i_love_ponies (id, special_thing) VALUES (%s, %s);", (3, 'Python',)),
            ),
            # backwards
            [
                "DELETE FROM i_love_ponies WHERE special_thing = 'Django';",
                ["DELETE FROM i_love_ponies WHERE special_thing = 'Ponies';", None],
                ("DELETE FROM i_love_ponies WHERE id = %s OR special_thing = %s;", [3, 'Python']),
            ]
        )

        # Make sure there's no table
        self.assertTableNotExists("i_love_ponies")
        new_state = project_state.clone()
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runsql", editor, project_state, new_state)

        # Test parameter passing
        with connection.schema_editor() as editor:
            param_operation.database_forwards("test_runsql", editor, project_state, new_state)
        # Make sure all the SQL was processed
        with connection.cursor() as cursor:
            cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
            self.assertEqual(cursor.fetchall()[0][0], 3)

        with connection.schema_editor() as editor:
            param_operation.database_backwards("test_runsql", editor, new_state, project_state)
        with connection.cursor() as cursor:
            cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
            self.assertEqual(cursor.fetchall()[0][0], 0)

        # And test reversal
        with connection.schema_editor() as editor:
            operation.database_backwards("test_runsql", editor, new_state, project_state)
        self.assertTableNotExists("i_love_ponies")

    def test_run_sql_params_invalid(self):
        """
        #23426 - RunSQL should fail when a list of statements with an incorrect
        number of tuples is given.
        """
        project_state = self.set_up_test_model("test_runsql")
        new_state = project_state.clone()
        operation = migrations.RunSQL(
            # forwards
            [
                ["INSERT INTO foo (bar) VALUES ('buz');"]
            ],
            # backwards
            (
                ("DELETE FROM foo WHERE bar = 'buz';", 'invalid', 'parameter count'),
            ),
        )

        with connection.schema_editor() as editor:
            with self.assertRaisesMessage(ValueError, "Expected a 2-tuple but got 1"):
                operation.database_forwards("test_runsql", editor, project_state, new_state)

        with connection.schema_editor() as editor:
            with self.assertRaisesMessage(ValueError, "Expected a 2-tuple but got 3"):
                operation.database_backwards("test_runsql", editor, new_state, project_state)

    def test_run_sql_noop(self):
        """
        #24098 - Tests no-op RunSQL operations.
        """
        operation = migrations.RunSQL(migrations.RunSQL.noop, migrations.RunSQL.noop)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runsql", editor, None, None)
            operation.database_backwards("test_runsql", editor, None, None)

    def test_run_python(self):
        """
        Tests the RunPython operation
        """

        project_state = self.set_up_test_model("test_runpython", mti_model=True)

        # Create the operation
        def inner_method(models, schema_editor):
            Pony = models.get_model("test_runpython", "Pony")
            Pony.objects.create(pink=1, weight=3.55)
            Pony.objects.create(weight=5)

        def inner_method_reverse(models, schema_editor):
            Pony = models.get_model("test_runpython", "Pony")
            Pony.objects.filter(pink=1, weight=3.55).delete()
            Pony.objects.filter(weight=5).delete()
        operation = migrations.RunPython(inner_method, reverse_code=inner_method_reverse)
        self.assertEqual(operation.describe(), "Raw Python operation")
        # Test the state alteration does nothing
        new_state = project_state.clone()
        operation.state_forwards("test_runpython", new_state)
        self.assertEqual(new_state, project_state)
        # Test the database alteration
        self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 0)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runpython", editor, project_state, new_state)
        self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 2)
        # Now test reversal
        self.assertTrue(operation.reversible)
        with connection.schema_editor() as editor:
            operation.database_backwards("test_runpython", editor, project_state, new_state)
        self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 0)
        # Now test we can't use a string
        with self.assertRaisesMessage(ValueError, 'RunPython must be supplied with a callable'):
            migrations.RunPython("print 'ahahaha'")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RunPython")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["code", "reverse_code"])

        # Also test reversal fails, with an operation identical to above but without reverse_code set
        no_reverse_operation = migrations.RunPython(inner_method)
        self.assertFalse(no_reverse_operation.reversible)
        with connection.schema_editor() as editor:
            no_reverse_operation.database_forwards("test_runpython", editor, project_state, new_state)
            with self.assertRaises(NotImplementedError):
                no_reverse_operation.database_backwards("test_runpython", editor, new_state, project_state)
        self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 2)

        def create_ponies(models, schema_editor):
            Pony = models.get_model("test_runpython", "Pony")
            pony1 = Pony.objects.create(pink=1, weight=3.55)
            self.assertIsNot(pony1.pk, None)
            pony2 = Pony.objects.create(weight=5)
            self.assertIsNot(pony2.pk, None)
            self.assertNotEqual(pony1.pk, pony2.pk)

        operation = migrations.RunPython(create_ponies)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runpython", editor, project_state, new_state)
        self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 4)
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "RunPython")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["code"])

        def create_shetlandponies(models, schema_editor):
            ShetlandPony = models.get_model("test_runpython", "ShetlandPony")
            pony1 = ShetlandPony.objects.create(weight=4.0)
            self.assertIsNot(pony1.pk, None)
            pony2 = ShetlandPony.objects.create(weight=5.0)
            self.assertIsNot(pony2.pk, None)
            self.assertNotEqual(pony1.pk, pony2.pk)

        operation = migrations.RunPython(create_shetlandponies)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runpython", editor, project_state, new_state)
        self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 6)
        self.assertEqual(project_state.apps.get_model("test_runpython", "ShetlandPony").objects.count(), 2)
        # And elidable reduction
        self.assertIs(False, operation.reduce(operation, []))
        elidable_operation = migrations.RunPython(inner_method, elidable=True)
        self.assertEqual(elidable_operation.reduce(operation, []), [operation])

    def test_run_python_atomic(self):
        """
        Tests the RunPython operation correctly handles the "atomic" keyword
        """
        project_state = self.set_up_test_model("test_runpythonatomic", mti_model=True)

        def inner_method(models, schema_editor):
            Pony = models.get_model("test_runpythonatomic", "Pony")
            Pony.objects.create(pink=1, weight=3.55)
            raise ValueError("Adrian hates ponies.")

        # Verify atomicity when applying.
        atomic_migration = Migration("test", "test_runpythonatomic")
        atomic_migration.operations = [migrations.RunPython(inner_method, reverse_code=inner_method)]
        non_atomic_migration = Migration("test", "test_runpythonatomic")
        non_atomic_migration.operations = [migrations.RunPython(inner_method, reverse_code=inner_method, atomic=False)]
        # If we're a fully-transactional database, both versions should rollback
        if connection.features.can_rollback_ddl:
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    atomic_migration.apply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    non_atomic_migration.apply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
        # Otherwise, the non-atomic operation should leave a row there
        else:
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    atomic_migration.apply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    non_atomic_migration.apply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 1)
        # Reset object count to zero and verify atomicity when unapplying.
        project_state.apps.get_model("test_runpythonatomic", "Pony").objects.all().delete()
        # On a fully-transactional database, both versions rollback.
        if connection.features.can_rollback_ddl:
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    atomic_migration.unapply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    non_atomic_migration.unapply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
        # Otherwise, the non-atomic operation leaves a row there.
        else:
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    atomic_migration.unapply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
            with self.assertRaises(ValueError):
                with connection.schema_editor() as editor:
                    non_atomic_migration.unapply(project_state, editor)
            self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 1)
        # Verify deconstruction.
        definition = non_atomic_migration.operations[0].deconstruct()
        self.assertEqual(definition[0], "RunPython")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["atomic", "code", "reverse_code"])

    def test_run_python_related_assignment(self):
        """
        #24282 - Model changes to a FK reverse side update the model
        on the FK side as well.
        """

        def inner_method(models, schema_editor):
            Author = models.get_model("test_authors", "Author")
            Book = models.get_model("test_books", "Book")
            author = Author.objects.create(name="Hemingway")
            Book.objects.create(title="Old Man and The Sea", author=author)

        create_author = migrations.CreateModel(
            "Author",
            [
                ("id", models.AutoField(primary_key=True)),
                ("name", models.CharField(max_length=100)),
            ],
            options={},
        )
        create_book = migrations.CreateModel(
            "Book",
            [
                ("id", models.AutoField(primary_key=True)),
                ("title", models.CharField(max_length=100)),
                ("author", models.ForeignKey("test_authors.Author", models.CASCADE))
            ],
            options={},
        )
        add_hometown = migrations.AddField(
            "Author",
            "hometown",
            models.CharField(max_length=100),
        )
        create_old_man = migrations.RunPython(inner_method, inner_method)

        project_state = ProjectState()
        new_state = project_state.clone()
        with connection.schema_editor() as editor:
            create_author.state_forwards("test_authors", new_state)
            create_author.database_forwards("test_authors", editor, project_state, new_state)
        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            create_book.state_forwards("test_books", new_state)
            create_book.database_forwards("test_books", editor, project_state, new_state)
        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            add_hometown.state_forwards("test_authors", new_state)
            add_hometown.database_forwards("test_authors", editor, project_state, new_state)
        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            create_old_man.state_forwards("test_books", new_state)
            create_old_man.database_forwards("test_books", editor, project_state, new_state)

    def test_model_with_bigautofield(self):
        """
        A model with BigAutoField can be created.
        """
        def create_data(models, schema_editor):
            Author = models.get_model("test_author", "Author")
            Book = models.get_model("test_book", "Book")
            author1 = Author.objects.create(name="Hemingway")
            Book.objects.create(title="Old Man and The Sea", author=author1)
            Book.objects.create(id=2 ** 33, title="A farewell to arms", author=author1)

            author2 = Author.objects.create(id=2 ** 33, name="Remarque")
            Book.objects.create(title="All quiet on the western front", author=author2)
            Book.objects.create(title="Arc de Triomphe", author=author2)

        create_author = migrations.CreateModel(
            "Author",
            [
                ("id", models.BigAutoField(primary_key=True)),
                ("name", models.CharField(max_length=100)),
            ],
            options={},
        )
        create_book = migrations.CreateModel(
            "Book",
            [
                ("id", models.BigAutoField(primary_key=True)),
                ("title", models.CharField(max_length=100)),
                ("author", models.ForeignKey(to="test_author.Author", on_delete=models.CASCADE))
            ],
            options={},
        )
        fill_data = migrations.RunPython(create_data)

        project_state = ProjectState()
        new_state = project_state.clone()
        with connection.schema_editor() as editor:
            create_author.state_forwards("test_author", new_state)
            create_author.database_forwards("test_author", editor, project_state, new_state)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            create_book.state_forwards("test_book", new_state)
            create_book.database_forwards("test_book", editor, project_state, new_state)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            fill_data.state_forwards("fill_data", new_state)
            fill_data.database_forwards("fill_data", editor, project_state, new_state)

    def test_autofield_foreignfield_growth(self):
        """
        A field may be migrated from AutoField to BigAutoField.
        """
        def create_initial_data(models, schema_editor):
            Article = models.get_model("test_article", "Article")
            Blog = models.get_model("test_blog", "Blog")
            blog = Blog.objects.create(name="web development done right")
            Article.objects.create(name="Frameworks", blog=blog)
            Article.objects.create(name="Programming Languages", blog=blog)

        def create_big_data(models, schema_editor):
            Article = models.get_model("test_article", "Article")
            Blog = models.get_model("test_blog", "Blog")
            blog2 = Blog.objects.create(name="Frameworks", id=2 ** 33)
            Article.objects.create(name="Django", blog=blog2)
            Article.objects.create(id=2 ** 33, name="Django2", blog=blog2)

        create_blog = migrations.CreateModel(
            "Blog",
            [
                ("id", models.AutoField(primary_key=True)),
                ("name", models.CharField(max_length=100)),
            ],
            options={},
        )
        create_article = migrations.CreateModel(
            "Article",
            [
                ("id", models.AutoField(primary_key=True)),
                ("blog", models.ForeignKey(to="test_blog.Blog", on_delete=models.CASCADE)),
                ("name", models.CharField(max_length=100)),
                ("data", models.TextField(default="")),
            ],
            options={},
        )
        fill_initial_data = migrations.RunPython(create_initial_data, create_initial_data)
        fill_big_data = migrations.RunPython(create_big_data, create_big_data)

        grow_article_id = migrations.AlterField("Article", "id", models.BigAutoField(primary_key=True))
        grow_blog_id = migrations.AlterField("Blog", "id", models.BigAutoField(primary_key=True))

        project_state = ProjectState()
        new_state = project_state.clone()
        with connection.schema_editor() as editor:
            create_blog.state_forwards("test_blog", new_state)
            create_blog.database_forwards("test_blog", editor, project_state, new_state)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            create_article.state_forwards("test_article", new_state)
            create_article.database_forwards("test_article", editor, project_state, new_state)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            fill_initial_data.state_forwards("fill_initial_data", new_state)
            fill_initial_data.database_forwards("fill_initial_data", editor, project_state, new_state)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            grow_article_id.state_forwards("test_article", new_state)
            grow_article_id.database_forwards("test_article", editor, project_state, new_state)

        state = new_state.clone()
        article = state.apps.get_model("test_article.Article")
        self.assertIsInstance(article._meta.pk, models.BigAutoField)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            grow_blog_id.state_forwards("test_blog", new_state)
            grow_blog_id.database_forwards("test_blog", editor, project_state, new_state)

        state = new_state.clone()
        blog = state.apps.get_model("test_blog.Blog")
        self.assertIsInstance(blog._meta.pk, models.BigAutoField)

        project_state = new_state
        new_state = new_state.clone()
        with connection.schema_editor() as editor:
            fill_big_data.state_forwards("fill_big_data", new_state)
            fill_big_data.database_forwards("fill_big_data", editor, project_state, new_state)

    def test_run_python_noop(self):
        """
        #24098 - Tests no-op RunPython operations.
        """
        project_state = ProjectState()
        new_state = project_state.clone()
        operation = migrations.RunPython(migrations.RunPython.noop, migrations.RunPython.noop)
        with connection.schema_editor() as editor:
            operation.database_forwards("test_runpython", editor, project_state, new_state)
            operation.database_backwards("test_runpython", editor, new_state, project_state)

    def test_separate_database_and_state(self):
        """
        Tests the SeparateDatabaseAndState operation.
        """
        project_state = self.set_up_test_model("test_separatedatabaseandstate")
        # Create the operation
        database_operation = migrations.RunSQL(
            "CREATE TABLE i_love_ponies (id int, special_thing int);",
            "DROP TABLE i_love_ponies;"
        )
        state_operation = migrations.CreateModel("SomethingElse", [("id", models.AutoField(primary_key=True))])
        operation = migrations.SeparateDatabaseAndState(
            state_operations=[state_operation],
            database_operations=[database_operation]
        )
        self.assertEqual(operation.describe(), "Custom state/database change combination")
        # Test the state alteration
        new_state = project_state.clone()
        operation.state_forwards("test_separatedatabaseandstate", new_state)
        self.assertEqual(len(new_state.models["test_separatedatabaseandstate", "somethingelse"].fields), 1)
        # Make sure there's no table
        self.assertTableNotExists("i_love_ponies")
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards("test_separatedatabaseandstate", editor, project_state, new_state)
        self.assertTableExists("i_love_ponies")
        # And test reversal
        self.assertTrue(operation.reversible)
        with connection.schema_editor() as editor:
            operation.database_backwards("test_separatedatabaseandstate", editor, new_state, project_state)
        self.assertTableNotExists("i_love_ponies")
        # And deconstruction
        definition = operation.deconstruct()
        self.assertEqual(definition[0], "SeparateDatabaseAndState")
        self.assertEqual(definition[1], [])
        self.assertEqual(sorted(definition[2]), ["database_operations", "state_operations"])

    def test_separate_database_and_state2(self):
        """
        A complex SeparateDatabaseAndState operation: Multiple operations both
        for state and database. Verify the state dependencies within each list
        and that state ops don't affect the database.
        """
        app_label = "test_separatedatabaseandstate2"
        project_state = self.set_up_test_model(app_label)
        # Create the operation
        database_operations = [
            migrations.CreateModel(
                "ILovePonies",
                [("id", models.AutoField(primary_key=True))],
                options={"db_table": "iloveponies"},
            ),
            migrations.CreateModel(
                "ILoveMorePonies",
                # We use IntegerField and not AutoField because
                # the model is going to be deleted immediately
                # and with an AutoField this fails on Oracle
                [("id", models.IntegerField(primary_key=True))],
                options={"db_table": "ilovemoreponies"},
            ),
            migrations.DeleteModel("ILoveMorePonies"),
            migrations.CreateModel(
                "ILoveEvenMorePonies",
                [("id", models.AutoField(primary_key=True))],
                options={"db_table": "iloveevenmoreponies"},
            ),
        ]
        state_operations = [
            migrations.CreateModel(
                "SomethingElse",
                [("id", models.AutoField(primary_key=True))],
                options={"db_table": "somethingelse"},
            ),
            migrations.DeleteModel("SomethingElse"),
            migrations.CreateModel(
                "SomethingCompletelyDifferent",
                [("id", models.AutoField(primary_key=True))],
                options={"db_table": "somethingcompletelydifferent"},
            ),
        ]
        operation = migrations.SeparateDatabaseAndState(
            state_operations=state_operations,
            database_operations=database_operations,
        )
        # Test the state alteration
        new_state = project_state.clone()
        operation.state_forwards(app_label, new_state)

        def assertModelsAndTables(after_db):
            # Tables and models exist, or don't, as they should:
            self.assertNotIn((app_label, "somethingelse"), new_state.models)
            self.assertEqual(len(new_state.models[app_label, "somethingcompletelydifferent"].fields), 1)
            self.assertNotIn((app_label, "iloveponiesonies"), new_state.models)
            self.assertNotIn((app_label, "ilovemoreponies"), new_state.models)
            self.assertNotIn((app_label, "iloveevenmoreponies"), new_state.models)
            self.assertTableNotExists("somethingelse")
            self.assertTableNotExists("somethingcompletelydifferent")
            self.assertTableNotExists("ilovemoreponies")
            if after_db:
                self.assertTableExists("iloveponies")
                self.assertTableExists("iloveevenmoreponies")
            else:
                self.assertTableNotExists("iloveponies")
                self.assertTableNotExists("iloveevenmoreponies")

        assertModelsAndTables(after_db=False)
        # Test the database alteration
        with connection.schema_editor() as editor:
            operation.database_forwards(app_label, editor, project_state, new_state)
        assertModelsAndTables(after_db=True)
        # And test reversal
        self.assertTrue(operation.reversible)
        with connection.schema_editor() as editor:
            operation.database_backwards(app_label, editor, new_state, project_state)
        assertModelsAndTables(after_db=False)

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 22:17:25,655 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the full content of the file `tests/contenttypes_tests/test_operations.py`.\n2. Extended relevance:\n   - This context contains the entire content of the requested file, from line 1 to 66.', relative_path='tests/contenttypes_tests/test_operations.py', start_line=1, end_line=66), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the full content of the file `tests/migrations/test_multidb.py`.\n2. Extended relevance:\n   - This context contains the entire content of the requested file, from line 1 to 171.', relative_path='tests/migrations/test_multidb.py', start_line=1, end_line=171), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the full content of the file `tests/migrations/test_operations.py`.\n2. Extended relevance:\n   - This context contains the beginning of the requested file, from line 1 to 500.', relative_path='tests/migrations/test_operations.py', start_line=1, end_line=500), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user query explicitly asks for the full content of the file `tests/migrations/test_operations.py`.\n2. Extended relevance:\n   - This context contains a large portion of the requested file, from line 170 to 2865, which is necessary to provide the full content.', relative_path='tests/migrations/test_operations.py', start_line=170, end_line=2865)]
2025-12-23 22:17:25,660 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 4 contexts to memory for query: Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.
2025-12-23 22:17:25,660 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 22:17:25,661 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 22:17:25,661 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 4 new contexts to 0 existing contexts
2025-12-23 22:17:25,661 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 4 total contexts (removed 0 duplicates)
2025-12-23 22:17:25,662 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
django
├── .tx
├── CONTRIBUTING.rst
├── Gruntfile.js
├── README.rst
├── django
|   ├── __init__.py
|   ├── __main__.py
|   ├── apps
|   |   ├── __init__.py
|   |   ├── config.py
|   |   └── registry.py
|   ├── bin
|   |   └── django-admin.py
|   ├── conf
|   |   ├── __init__.py
|   |   ├── app_template
|   |   |   └── migrations
|   |   ├── global_settings.py
|   |   ├── locale
|   |   |   ├── __init__.py
|   |   |   ├── af
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ar
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ast
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── az
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── be
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── bg
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── bn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── br
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── bs
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ca
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── cs
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── cy
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── da
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── de
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── de_CH
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── dsb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── el
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en_AU
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en_GB
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── eo
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_AR
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_CO
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_MX
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_NI
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_PR
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_VE
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── et
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── eu
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fa
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fy
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ga
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── gd
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── gl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── he
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hsb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── hu
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hy
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ia
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── id
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── io
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── is
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── it
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ja
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ka
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── kab
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── kk
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── km
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── kn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ko
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── lb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── lt
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── lv
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ml
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mr
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── my
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── nb
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ne
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── nl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── nn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── os
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── pa
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── pl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── pt
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── pt_BR
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ro
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ru
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sq
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sr_Latn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sv
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sw
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ta
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── te
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── th
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── tr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── tt
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── udm
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── uk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ur
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── vi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── zh_Hans
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   └── zh_Hant
|   |   |       ├── LC_MESSAGES
|   |   |       ├── __init__.py
|   |   |       └── formats.py
|   |   ├── project_template
|   |   |   └── project_name
|   |   └── urls
|   |       ├── __init__.py
|   |       ├── i18n.py
|   |       └── static.py
|   ├── contrib
|   |   ├── __init__.py
|   |   ├── admin
|   |   |   ├── __init__.py
|   |   |   ├── actions.py
|   |   |   ├── apps.py
|   |   |   ├── bin
|   |   |   |   └── compress.py
|   |   |   ├── checks.py
|   |   |   ├── decorators.py
|   |   |   ├── exceptions.py
|   |   |   ├── filters.py
|   |   |   ├── forms.py
|   |   |   ├── helpers.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── am
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_logentry_remove_auto_add.py
|   |   |   |   ├── 0003_logentry_add_action_flag_choices.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── options.py
|   |   |   ├── sites.py
|   |   |   ├── static
|   |   |   |   └── admin
|   |   |   ├── templates
|   |   |   |   ├── admin
|   |   |   |   └── registration
|   |   |   ├── templatetags
|   |   |   |   ├── __init__.py
|   |   |   |   ├── admin_list.py
|   |   |   |   ├── admin_modify.py
|   |   |   |   ├── admin_urls.py
|   |   |   |   ├── base.py
|   |   |   |   └── log.py
|   |   |   ├── tests.py
|   |   |   ├── utils.py
|   |   |   ├── views
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autocomplete.py
|   |   |   |   ├── decorators.py
|   |   |   |   └── main.py
|   |   |   └── widgets.py
|   |   ├── admindocs
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── templates
|   |   |   |   └── admin_doc
|   |   |   ├── urls.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   ├── auth
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── backends.py
|   |   |   ├── base_user.py
|   |   |   ├── checks.py
|   |   |   ├── context_processors.py
|   |   |   ├── decorators.py
|   |   |   ├── forms.py
|   |   |   ├── handlers
|   |   |   |   ├── __init__.py
|   |   |   |   └── modwsgi.py
|   |   |   ├── hashers.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   ├── __init__.py
|   |   |   |   └── commands
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_alter_permission_name_max_length.py
|   |   |   |   ├── 0003_alter_user_email_max_length.py
|   |   |   |   ├── 0004_alter_user_username_opts.py
|   |   |   |   ├── 0005_alter_user_last_login_null.py
|   |   |   |   ├── 0006_require_contenttypes_0002.py
|   |   |   |   ├── 0007_alter_validators_add_error_messages.py
|   |   |   |   ├── 0008_alter_user_username_max_length.py
|   |   |   |   ├── 0009_alter_user_last_name_max_length.py
|   |   |   |   ├── 0010_alter_group_name_max_length.py
|   |   |   |   ├── 0011_update_proxy_permissions.py
|   |   |   |   └── __init__.py
|   |   |   ├── mixins.py
|   |   |   ├── models.py
|   |   |   ├── password_validation.py
|   |   |   ├── signals.py
|   |   |   ├── templates
|   |   |   |   ├── auth
|   |   |   |   └── registration
|   |   |   ├── tokens.py
|   |   |   ├── urls.py
|   |   |   ├── validators.py
|   |   |   └── views.py
|   |   ├── contenttypes
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── checks.py
|   |   |   ├── fields.py
|   |   |   ├── forms.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   ├── __init__.py
|   |   |   |   └── commands
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_remove_content_type_name.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   └── views.py
|   |   ├── flatpages
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── forms.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── sitemaps.py
|   |   |   ├── templatetags
|   |   |   |   ├── __init__.py
|   |   |   |   └── flatpages.py
|   |   |   ├── urls.py
|   |   |   └── views.py
|   |   ├── gis
|   |   |   ├── __init__.py
|   |   |   ├── admin
|   |   |   |   ├── __init__.py
|   |   |   |   ├── options.py
|   |   |   |   └── widgets.py
|   |   |   ├── apps.py
|   |   |   ├── db
|   |   |   |   ├── __init__.py
|   |   |   |   ├── backends
|   |   |   |   └── models
|   |   |   ├── feeds.py
|   |   |   ├── forms
|   |   |   |   ├── __init__.py
|   |   |   |   ├── fields.py
|   |   |   |   └── widgets.py
|   |   |   ├── gdal
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── datasource.py
|   |   |   |   ├── driver.py
|   |   |   |   ├── envelope.py
|   |   |   |   ├── error.py
|   |   |   |   ├── feature.py
|   |   |   |   ├── field.py
|   |   |   |   ├── geometries.py
|   |   |   |   ├── geomtype.py
|   |   |   |   ├── layer.py
|   |   |   |   ├── libgdal.py
|   |   |   |   ├── prototypes
|   |   |   |   ├── raster
|   |   |   |   └── srs.py
|   |   |   ├── geoip2
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   └── resources.py
|   |   |   ├── geometry.py
|   |   |   ├── geos
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── collections.py
|   |   |   |   ├── coordseq.py
|   |   |   |   ├── error.py
|   |   |   |   ├── factory.py
|   |   |   |   ├── geometry.py
|   |   |   |   ├── io.py
|   |   |   |   ├── libgeos.py
|   |   |   |   ├── linestring.py
|   |   |   |   ├── mutable_list.py
|   |   |   |   ├── point.py
|   |   |   |   ├── polygon.py
|   |   |   |   ├── prepared.py
|   |   |   |   └── prototypes
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── measure.py
|   |   |   ├── ptr.py
|   |   |   ├── serializers
|   |   |   |   ├── __init__.py
|   |   |   |   └── geojson.py
|   |   |   ├── shortcuts.py
|   |   |   ├── sitemaps
|   |   |   |   ├── __init__.py
|   |   |   |   ├── kml.py
|   |   |   |   └── views.py
|   |   |   ├── static
|   |   |   |   └── gis
|   |   |   ├── templates
|   |   |   |   └── gis
|   |   |   ├── utils
|   |   |   |   ├── __init__.py
|   |   |   |   ├── layermapping.py
|   |   |   |   ├── ogrinfo.py
|   |   |   |   ├── ogrinspect.py
|   |   |   |   └── srs.py
|   |   |   └── views.py
|   |   ├── humanize
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   └── templatetags
|   |   |       ├── __init__.py
|   |   |       └── humanize.py
|   |   ├── messages
|   |   |   ├── __init__.py
|   |   |   ├── api.py
|   |   |   ├── apps.py
|   |   |   ├── constants.py
|   |   |   ├── context_processors.py
|   |   |   ├── middleware.py
|   |   |   ├── storage
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── cookie.py
|   |   |   |   ├── fallback.py
|   |   |   |   └── session.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   ├── postgres
|   |   |   ├── __init__.py
|   |   |   ├── aggregates
|   |   |   |   ├── __init__.py
|   |   |   |   ├── general.py
|   |   |   |   ├── mixins.py
|   |   |   |   └── statistics.py
|   |   |   ├── apps.py
|   |   |   ├── fields
|   |   |   |   ├── __init__.py
|   |   |   |   ├── array.py
|   |   |   |   ├── citext.py
|   |   |   |   ├── hstore.py
|   |   |   |   ├── jsonb.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── ranges.py
|   |   |   |   └── utils.py
|   |   |   ├── forms
|   |   |   |   ├── __init__.py
|   |   |   |   ├── array.py
|   |   |   |   ├── hstore.py
|   |   |   |   ├── jsonb.py
|   |   |   |   └── ranges.py
|   |   |   ├── functions.py
|   |   |   ├── indexes.py
|   |   |   ├── jinja2
|   |   |   |   └── postgres
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── ko
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── mn
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sv
|   |   |   |   ├── tr
|   |   |   |   ├── uk
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── lookups.py
|   |   |   ├── operations.py
|   |   |   ├── search.py
|   |   |   ├── serializers.py
|   |   |   ├── signals.py
|   |   |   ├── templates
|   |   |   |   └── postgres
|   |   |   ├── utils.py
|   |   |   └── validators.py
|   |   ├── redirects
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   └── models.py
|   |   ├── sessions
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── cache.py
|   |   |   |   ├── cached_db.py
|   |   |   |   ├── db.py
|   |   |   |   ├── file.py
|   |   |   |   └── signed_cookies.py
|   |   |   ├── base_session.py
|   |   |   ├── exceptions.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   └── serializers.py
|   |   ├── sitemaps
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── templates
|   |   |   |   ├── sitemap.xml
|   |   |   |   └── sitemap_index.xml
|   |   |   └── views.py
|   |   ├── sites
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management.py
|   |   |   ├── managers.py
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_alter_domain_unique.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── requests.py
|   |   |   └── shortcuts.py
|   |   ├── staticfiles
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── checks.py
|   |   |   ├── finders.py
|   |   |   ├── handlers.py
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── storage.py
|   |   |   ├── testing.py
|   |   |   ├── urls.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   └── syndication
|   |       ├── __init__.py
|   |       ├── apps.py
|   |       └── views.py
|   ├── core
|   |   ├── __init__.py
|   |   ├── cache
|   |   |   ├── __init__.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── db.py
|   |   |   |   ├── dummy.py
|   |   |   |   ├── filebased.py
|   |   |   |   ├── locmem.py
|   |   |   |   └── memcached.py
|   |   |   └── utils.py
|   |   ├── checks
|   |   |   ├── __init__.py
|   |   |   ├── caches.py
|   |   |   ├── compatibility
|   |   |   |   └── __init__.py
|   |   |   ├── database.py
|   |   |   ├── messages.py
|   |   |   ├── model_checks.py
|   |   |   ├── registry.py
|   |   |   ├── security
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── csrf.py
|   |   |   |   └── sessions.py
|   |   |   ├── templates.py
|   |   |   ├── translation.py
|   |   |   └── urls.py
|   |   ├── exceptions.py
|   |   ├── files
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── images.py
|   |   |   ├── locks.py
|   |   |   ├── move.py
|   |   |   ├── storage.py
|   |   |   ├── temp.py
|   |   |   ├── uploadedfile.py
|   |   |   ├── uploadhandler.py
|   |   |   └── utils.py
|   |   ├── handlers
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── exception.py
|   |   |   └── wsgi.py
|   |   ├── mail
|   |   |   ├── __init__.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── console.py
|   |   |   |   ├── dummy.py
|   |   |   |   ├── filebased.py
|   |   |   |   ├── locmem.py
|   |   |   |   └── smtp.py
|   |   |   ├── message.py
|   |   |   └── utils.py
|   |   ├── management
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── color.py
|   |   |   ├── commands
|   |   |   |   ├── check.py
|   |   |   |   ├── compilemessages.py
|   |   |   |   ├── createcachetable.py
|   |   |   |   ├── dbshell.py
|   |   |   |   ├── diffsettings.py
|   |   |   |   ├── dumpdata.py
|   |   |   |   ├── flush.py
|   |   |   |   ├── inspectdb.py
|   |   |   |   ├── loaddata.py
|   |   |   |   ├── makemessages.py
|   |   |   |   ├── makemigrations.py
|   |   |   |   ├── migrate.py
|   |   |   |   ├── runserver.py
|   |   |   |   ├── sendtestemail.py
|   |   |   |   ├── shell.py
|   |   |   |   ├── showmigrations.py
|   |   |   |   ├── sqlflush.py
|   |   |   |   ├── sqlmigrate.py
|   |   |   |   ├── sqlsequencereset.py
|   |   |   |   ├── squashmigrations.py
|   |   |   |   ├── startapp.py
|   |   |   |   ├── startproject.py
|   |   |   |   ├── test.py
|   |   |   |   └── testserver.py
|   |   |   ├── sql.py
|   |   |   ├── templates.py
|   |   |   └── utils.py
|   |   ├── paginator.py
|   |   ├── serializers
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── json.py
|   |   |   ├── python.py
|   |   |   ├── pyyaml.py
|   |   |   └── xml_serializer.py
|   |   ├── servers
|   |   |   ├── __init__.py
|   |   |   └── basehttp.py
|   |   ├── signals.py
|   |   ├── signing.py
|   |   ├── validators.py
|   |   └── wsgi.py
|   ├── db
|   |   ├── __init__.py
|   |   ├── backends
|   |   |   ├── __init__.py
|   |   |   ├── base
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── validation.py
|   |   |   ├── ddl_references.py
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   └── features.py
|   |   |   ├── mysql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── compiler.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── validation.py
|   |   |   ├── oracle
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── functions.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   ├── utils.py
|   |   |   |   └── validation.py
|   |   |   ├── postgresql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── utils.py
|   |   |   ├── signals.py
|   |   |   ├── sqlite3
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   └── schema.py
|   |   |   └── utils.py
|   |   ├── migrations
|   |   |   ├── __init__.py
|   |   |   ├── autodetector.py
|   |   |   ├── exceptions.py
|   |   |   ├── executor.py
|   |   |   ├── graph.py
|   |   |   ├── loader.py
|   |   |   ├── migration.py
|   |   |   ├── operations
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── fields.py
|   |   |   |   ├── models.py
|   |   |   |   ├── special.py
|   |   |   |   └── utils.py
|   |   |   ├── optimizer.py
|   |   |   ├── questioner.py
|   |   |   ├── recorder.py
|   |   |   ├── serializer.py
|   |   |   ├── state.py
|   |   |   ├── utils.py
|   |   |   └── writer.py
|   |   ├── models
|   |   |   ├── __init__.py
|   |   |   ├── aggregates.py
|   |   |   ├── base.py
|   |   |   ├── constants.py
|   |   |   ├── constraints.py
|   |   |   ├── deletion.py
|   |   |   ├── expressions.py
|   |   |   ├── fields
|   |   |   |   ├── __init__.py
|   |   |   |   ├── files.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── proxy.py
|   |   |   |   ├── related.py
|   |   |   |   ├── related_descriptors.py
|   |   |   |   ├── related_lookups.py
|   |   |   |   └── reverse_related.py
|   |   |   ├── functions
|   |   |   |   ├── __init__.py
|   |   |   |   ├── comparison.py
|   |   |   |   ├── datetime.py
|   |   |   |   ├── math.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── text.py
|   |   |   |   └── window.py
|   |   |   ├── indexes.py
|   |   |   ├── lookups.py
|   |   |   ├── manager.py
|   |   |   ├── options.py
|   |   |   ├── query.py
|   |   |   ├── query_utils.py
|   |   |   ├── signals.py
|   |   |   ├── sql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── compiler.py
|   |   |   |   ├── constants.py
|   |   |   |   ├── datastructures.py
|   |   |   |   ├── query.py
|   |   |   |   ├── subqueries.py
|   |   |   |   └── where.py
|   |   |   └── utils.py
|   |   ├── transaction.py
|   |   └── utils.py
|   ├── dispatch
|   |   ├── __init__.py
|   |   ├── dispatcher.py
|   |   └── license.txt
|   ├── forms
|   |   ├── __init__.py
|   |   ├── boundfield.py
|   |   ├── fields.py
|   |   ├── forms.py
|   |   ├── formsets.py
|   |   ├── jinja2
|   |   |   └── django
|   |   |       └── forms
|   |   ├── models.py
|   |   ├── renderers.py
|   |   ├── templates
|   |   |   └── django
|   |   |       └── forms
|   |   ├── utils.py
|   |   └── widgets.py
|   ├── http
|   |   ├── __init__.py
|   |   ├── cookie.py
|   |   ├── multipartparser.py
|   |   ├── request.py
|   |   └── response.py
|   ├── middleware
|   |   ├── __init__.py
|   |   ├── cache.py
|   |   ├── clickjacking.py
|   |   ├── common.py
|   |   ├── csrf.py
|   |   ├── gzip.py
|   |   ├── http.py
|   |   ├── locale.py
|   |   └── security.py
|   ├── shortcuts.py
|   ├── template
|   |   ├── __init__.py
|   |   ├── backends
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── django.py
|   |   |   ├── dummy.py
|   |   |   ├── jinja2.py
|   |   |   └── utils.py
|   |   ├── base.py
|   |   ├── context.py
|   |   ├── context_processors.py
|   |   ├── defaultfilters.py
|   |   ├── defaulttags.py
|   |   ├── engine.py
|   |   ├── exceptions.py
|   |   ├── library.py
|   |   ├── loader.py
|   |   ├── loader_tags.py
|   |   ├── loaders
|   |   |   ├── __init__.py
|   |   |   ├── app_directories.py
|   |   |   ├── base.py
|   |   |   ├── cached.py
|   |   |   ├── filesystem.py
|   |   |   └── locmem.py
|   |   ├── response.py
|   |   ├── smartif.py
|   |   └── utils.py
|   ├── templatetags
|   |   ├── __init__.py
|   |   ├── cache.py
|   |   ├── i18n.py
|   |   ├── l10n.py
|   |   ├── static.py
|   |   └── tz.py
|   ├── test
|   |   ├── __init__.py
|   |   ├── client.py
|   |   ├── html.py
|   |   ├── runner.py
|   |   ├── selenium.py
|   |   ├── signals.py
|   |   ├── testcases.py
|   |   └── utils.py
|   ├── urls
|   |   ├── __init__.py
|   |   ├── base.py
|   |   ├── conf.py
|   |   ├── converters.py
|   |   ├── exceptions.py
|   |   ├── resolvers.py
|   |   └── utils.py
|   ├── utils
|   |   ├── __init__.py
|   |   ├── _os.py
|   |   ├── archive.py
|   |   ├── autoreload.py
|   |   ├── baseconv.py
|   |   ├── cache.py
|   |   ├── crypto.py
|   |   ├── datastructures.py
|   |   ├── dateformat.py
|   |   ├── dateparse.py
|   |   ├── dates.py
|   |   ├── datetime_safe.py
|   |   ├── deconstruct.py
|   |   ├── decorators.py
|   |   ├── deprecation.py
|   |   ├── duration.py
|   |   ├── encoding.py
|   |   ├── feedgenerator.py
|   |   ├── formats.py
|   |   ├── functional.py
|   |   ├── hashable.py
|   |   ├── html.py
|   |   ├── http.py
|   |   ├── inspect.py
|   |   ├── ipv6.py
|   |   ├── itercompat.py
|   |   ├── jslex.py
|   |   ├── log.py
|   |   ├── lorem_ipsum.py
|   |   ├── module_loading.py
|   |   ├── numberformat.py
|   |   ├── regex_helper.py
|   |   ├── safestring.py
|   |   ├── termcolors.py
|   |   ├── text.py
|   |   ├── timesince.py
|   |   ├── timezone.py
|   |   ├── topological_sort.py
|   |   ├── translation
|   |   |   ├── __init__.py
|   |   |   ├── reloader.py
|   |   |   ├── template.py
|   |   |   ├── trans_null.py
|   |   |   └── trans_real.py
|   |   ├── tree.py
|   |   ├── version.py
|   |   └── xmlutils.py
|   └── views
|       ├── __init__.py
|       ├── csrf.py
|       ├── debug.py
|       ├── decorators
|       |   ├── __init__.py
|       |   ├── cache.py
|       |   ├── clickjacking.py
|       |   ├── csrf.py
|       |   ├── debug.py
|       |   ├── gzip.py
|       |   ├── http.py
|       |   └── vary.py
|       ├── defaults.py
|       ├── generic
|       |   ├── __init__.py
|       |   ├── base.py
|       |   ├── dates.py
|       |   ├── detail.py
|       |   ├── edit.py
|       |   └── list.py
|       ├── i18n.py
|       ├── static.py
|       └── templates
|           ├── default_urlconf.html
|           ├── technical_404.html
|           ├── technical_500.html
|           └── technical_500.txt
├── docs
|   ├── _ext
|   |   └── djangodocs.py
|   ├── _theme
|   |   ├── djangodocs
|   |   |   ├── genindex.html
|   |   |   ├── layout.html
|   |   |   ├── modindex.html
|   |   |   ├── search.html
|   |   |   └── static
|   |   |       ├── console-tabs.css
|   |   |       ├── default.css
|   |   |       ├── djangodocs.css
|   |   |       ├── fontawesome
|   |   |       ├── homepage.css
|   |   |       └── reset-fonts-grids.css
|   |   └── djangodocs-epub
|   |       ├── epub-cover.html
|   |       └── static
|   |           └── epub.css
|   ├── conf.py
|   ├── contents.txt
|   ├── faq
|   |   ├── admin.txt
|   |   ├── contributing.txt
|   |   ├── general.txt
|   |   ├── help.txt
|   |   ├── index.txt
|   |   ├── install.txt
|   |   ├── models.txt
|   |   ├── troubleshooting.txt
|   |   └── usage.txt
|   ├── glossary.txt
|   ├── howto
|   |   ├── auth-remote-user.txt
|   |   ├── custom-file-storage.txt
|   |   ├── custom-lookups.txt
|   |   ├── custom-management-commands.txt
|   |   ├── custom-model-fields.txt
|   |   ├── custom-template-tags.txt
|   |   ├── deployment
|   |   |   ├── checklist.txt
|   |   |   ├── index.txt
|   |   |   └── wsgi
|   |   |       ├── apache-auth.txt
|   |   |       ├── gunicorn.txt
|   |   |       ├── index.txt
|   |   |       ├── modwsgi.txt
|   |   |       └── uwsgi.txt
|   |   ├── error-reporting.txt
|   |   ├── index.txt
|   |   ├── initial-data.txt
|   |   ├── jython.txt
|   |   ├── legacy-databases.txt
|   |   ├── outputting-csv.txt
|   |   ├── outputting-pdf.txt
|   |   ├── overriding-templates.txt
|   |   ├── static-files
|   |   |   ├── deployment.txt
|   |   |   └── index.txt
|   |   ├── upgrade-version.txt
|   |   ├── windows.txt
|   |   └── writing-migrations.txt
|   ├── index.txt
|   ├── internals
|   |   ├── _images
|   |   ├── contributing
|   |   |   ├── bugs-and-features.txt
|   |   |   ├── committing-code.txt
|   |   |   ├── index.txt
|   |   |   ├── localizing.txt
|   |   |   ├── new-contributors.txt
|   |   |   ├── triaging-tickets.txt
|   |   |   ├── writing-code
|   |   |   |   ├── coding-style.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── javascript.txt
|   |   |   |   ├── submitting-patches.txt
|   |   |   |   ├── unit-tests.txt
|   |   |   |   └── working-with-git.txt
|   |   |   └── writing-documentation.txt
|   |   ├── deprecation.txt
|   |   ├── git.txt
|   |   ├── howto-release-django.txt
|   |   ├── index.txt
|   |   ├── mailing-lists.txt
|   |   ├── organization.txt
|   |   ├── release-process.txt
|   |   └── security.txt
|   ├── intro
|   |   ├── _images
|   |   ├── contributing.txt
|   |   ├── index.txt
|   |   ├── install.txt
|   |   ├── overview.txt
|   |   ├── reusable-apps.txt
|   |   ├── tutorial01.txt
|   |   ├── tutorial02.txt
|   |   ├── tutorial03.txt
|   |   ├── tutorial04.txt
|   |   ├── tutorial05.txt
|   |   ├── tutorial06.txt
|   |   ├── tutorial07.txt
|   |   └── whatsnext.txt
|   ├── man
|   ├── misc
|   |   ├── api-stability.txt
|   |   ├── design-philosophies.txt
|   |   ├── distributions.txt
|   |   └── index.txt
|   ├── ref
|   |   ├── applications.txt
|   |   ├── checks.txt
|   |   ├── class-based-views
|   |   |   ├── base.txt
|   |   |   ├── flattened-index.txt
|   |   |   ├── generic-date-based.txt
|   |   |   ├── generic-display.txt
|   |   |   ├── generic-editing.txt
|   |   |   ├── index.txt
|   |   |   ├── mixins-date-based.txt
|   |   |   ├── mixins-editing.txt
|   |   |   ├── mixins-multiple-object.txt
|   |   |   ├── mixins-simple.txt
|   |   |   ├── mixins-single-object.txt
|   |   |   └── mixins.txt
|   |   ├── clickjacking.txt
|   |   ├── contrib
|   |   |   ├── admin
|   |   |   |   ├── _images
|   |   |   |   ├── actions.txt
|   |   |   |   ├── admindocs.txt
|   |   |   |   ├── index.txt
|   |   |   |   └── javascript.txt
|   |   |   ├── auth.txt
|   |   |   ├── contenttypes.txt
|   |   |   ├── flatpages.txt
|   |   |   ├── gis
|   |   |   |   ├── admin.txt
|   |   |   |   ├── commands.txt
|   |   |   |   ├── db-api.txt
|   |   |   |   ├── deployment.txt
|   |   |   |   ├── feeds.txt
|   |   |   |   ├── forms-api.txt
|   |   |   |   ├── functions.txt
|   |   |   |   ├── gdal.txt
|   |   |   |   ├── geoip2.txt
|   |   |   |   ├── geoquerysets.txt
|   |   |   |   ├── geos.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── install
|   |   |   |   ├── layermapping.txt
|   |   |   |   ├── measure.txt
|   |   |   |   ├── model-api.txt
|   |   |   |   ├── ogrinspect.txt
|   |   |   |   ├── serializers.txt
|   |   |   |   ├── sitemaps.txt
|   |   |   |   ├── testing.txt
|   |   |   |   ├── tutorial.txt
|   |   |   |   └── utils.txt
|   |   |   ├── humanize.txt
|   |   |   ├── index.txt
|   |   |   ├── messages.txt
|   |   |   ├── postgres
|   |   |   |   ├── aggregates.txt
|   |   |   |   ├── fields.txt
|   |   |   |   ├── forms.txt
|   |   |   |   ├── functions.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── indexes.txt
|   |   |   |   ├── lookups.txt
|   |   |   |   ├── operations.txt
|   |   |   |   ├── search.txt
|   |   |   |   └── validators.txt
|   |   |   ├── redirects.txt
|   |   |   ├── sitemaps.txt
|   |   |   ├── sites.txt
|   |   |   ├── staticfiles.txt
|   |   |   └── syndication.txt
|   |   ├── csrf.txt
|   |   ├── databases.txt
|   |   ├── django-admin.txt
|   |   ├── exceptions.txt
|   |   ├── files
|   |   |   ├── file.txt
|   |   |   ├── index.txt
|   |   |   ├── storage.txt
|   |   |   └── uploads.txt
|   |   ├── forms
|   |   |   ├── api.txt
|   |   |   ├── fields.txt
|   |   |   ├── formsets.txt
|   |   |   ├── index.txt
|   |   |   ├── models.txt
|   |   |   ├── renderers.txt
|   |   |   ├── validation.txt
|   |   |   └── widgets.txt
|   |   ├── index.txt
|   |   ├── middleware.txt
|   |   ├── migration-operations.txt
|   |   ├── models
|   |   |   ├── class.txt
|   |   |   ├── conditional-expressions.txt
|   |   |   ├── constraints.txt
|   |   |   ├── database-functions.txt
|   |   |   ├── expressions.txt
|   |   |   ├── fields.txt
|   |   |   ├── index.txt
|   |   |   ├── indexes.txt
|   |   |   ├── instances.txt
|   |   |   ├── lookups.txt
|   |   |   ├── meta.txt
|   |   |   ├── options.txt
|   |   |   ├── querysets.txt
|   |   |   └── relations.txt
|   |   ├── request-response.txt
|   |   ├── schema-editor.txt
|   |   ├── settings.txt
|   |   ├── signals.txt
|   |   ├── template-response.txt
|   |   ├── templates
|   |   |   ├── api.txt
|   |   |   ├── builtins.txt
|   |   |   ├── index.txt
|   |   |   └── language.txt
|   |   ├── unicode.txt
|   |   ├── urlresolvers.txt
|   |   ├── urls.txt
|   |   ├── utils.txt
|   |   ├── validators.txt
|   |   └── views.txt
|   ├── releases
|   |   ├── 0.95.txt
|   |   ├── 0.96.txt
|   |   ├── 1.0-porting-guide.txt
|   |   ├── 1.0.1.txt
|   |   ├── 1.0.2.txt
|   |   ├── 1.0.txt
|   |   ├── 1.1.2.txt
|   |   ├── 1.1.3.txt
|   |   ├── 1.1.4.txt
|   |   ├── 1.1.txt
|   |   ├── 1.10.1.txt
|   |   ├── 1.10.2.txt
|   |   ├── 1.10.3.txt
|   |   ├── 1.10.4.txt
|   |   ├── 1.10.5.txt
|   |   ├── 1.10.6.txt
|   |   ├── 1.10.7.txt
|   |   ├── 1.10.8.txt
|   |   ├── 1.10.txt
|   |   ├── 1.11.1.txt
|   |   ├── 1.11.10.txt
|   |   ├── 1.11.11.txt
|   |   ├── 1.11.12.txt
|   |   ├── 1.11.13.txt
|   |   ├── 1.11.14.txt
|   |   ├── 1.11.15.txt
|   |   ├── 1.11.16.txt
|   |   ├── 1.11.17.txt
|   |   ├── 1.11.18.txt
|   |   ├── 1.11.19.txt
|   |   ├── 1.11.2.txt
|   |   ├── 1.11.20.txt
|   |   ├── 1.11.21.txt
|   |   ├── 1.11.3.txt
|   |   ├── 1.11.4.txt
|   |   ├── 1.11.5.txt
|   |   ├── 1.11.6.txt
|   |   ├── 1.11.7.txt
|   |   ├── 1.11.8.txt
|   |   ├── 1.11.9.txt
|   |   ├── 1.11.txt
|   |   ├── 1.2.1.txt
|   |   ├── 1.2.2.txt
|   |   ├── 1.2.3.txt
|   |   ├── 1.2.4.txt
|   |   ├── 1.2.5.txt
|   |   ├── 1.2.6.txt
|   |   ├── 1.2.7.txt
|   |   ├── 1.2.txt
|   |   ├── 1.3.1.txt
|   |   ├── 1.3.2.txt
|   |   ├── 1.3.3.txt
|   |   ├── 1.3.4.txt
|   |   ├── 1.3.5.txt
|   |   ├── 1.3.6.txt
|   |   ├── 1.3.7.txt
|   |   ├── 1.3.txt
|   |   ├── 1.4.1.txt
|   |   ├── 1.4.10.txt
|   |   ├── 1.4.11.txt
|   |   ├── 1.4.12.txt
|   |   ├── 1.4.13.txt
|   |   ├── 1.4.14.txt
|   |   ├── 1.4.15.txt
|   |   ├── 1.4.16.txt
|   |   ├── 1.4.17.txt
|   |   ├── 1.4.18.txt
|   |   ├── 1.4.19.txt
|   |   ├── 1.4.2.txt
|   |   ├── 1.4.20.txt
|   |   ├── 1.4.21.txt
|   |   ├── 1.4.22.txt
|   |   ├── 1.4.3.txt
|   |   ├── 1.4.4.txt
|   |   ├── 1.4.5.txt
|   |   ├── 1.4.6.txt
|   |   ├── 1.4.7.txt
|   |   ├── 1.4.8.txt
|   |   ├── 1.4.9.txt
|   |   ├── 1.4.txt
|   |   ├── 1.5.1.txt
|   |   ├── 1.5.10.txt
|   |   ├── 1.5.11.txt
|   |   ├── 1.5.12.txt
|   |   ├── 1.5.2.txt
|   |   ├── 1.5.3.txt
|   |   ├── 1.5.4.txt
|   |   ├── 1.5.5.txt
|   |   ├── 1.5.6.txt
|   |   ├── 1.5.7.txt
|   |   ├── 1.5.8.txt
|   |   ├── 1.5.9.txt
|   |   ├── 1.5.txt
|   |   ├── 1.6.1.txt
|   |   ├── 1.6.10.txt
|   |   ├── 1.6.11.txt
|   |   ├── 1.6.2.txt
|   |   ├── 1.6.3.txt
|   |   ├── 1.6.4.txt
|   |   ├── 1.6.5.txt
|   |   ├── 1.6.6.txt
|   |   ├── 1.6.7.txt
|   |   ├── 1.6.8.txt
|   |   ├── 1.6.9.txt
|   |   ├── 1.6.txt
|   |   ├── 1.7.1.txt
|   |   ├── 1.7.10.txt
|   |   ├── 1.7.11.txt
|   |   ├── 1.7.2.txt
|   |   ├── 1.7.3.txt
|   |   ├── 1.7.4.txt
|   |   ├── 1.7.5.txt
|   |   ├── 1.7.6.txt
|   |   ├── 1.7.7.txt
|   |   ├── 1.7.8.txt
|   |   ├── 1.7.9.txt
|   |   ├── 1.7.txt
|   |   ├── 1.8.1.txt
|   |   ├── 1.8.10.txt
|   |   ├── 1.8.11.txt
|   |   ├── 1.8.12.txt
|   |   ├── 1.8.13.txt
|   |   ├── 1.8.14.txt
|   |   ├── 1.8.15.txt
|   |   ├── 1.8.16.txt
|   |   ├── 1.8.17.txt
|   |   ├── 1.8.18.txt
|   |   ├── 1.8.19.txt
|   |   ├── 1.8.2.txt
|   |   ├── 1.8.3.txt
|   |   ├── 1.8.4.txt
|   |   ├── 1.8.5.txt
|   |   ├── 1.8.6.txt
|   |   ├── 1.8.7.txt
|   |   ├── 1.8.8.txt
|   |   ├── 1.8.9.txt
|   |   ├── 1.8.txt
|   |   ├── 1.9.1.txt
|   |   ├── 1.9.10.txt
|   |   ├── 1.9.11.txt
|   |   ├── 1.9.12.txt
|   |   ├── 1.9.13.txt
|   |   ├── 1.9.2.txt
|   |   ├── 1.9.3.txt
|   |   ├── 1.9.4.txt
|   |   ├── 1.9.5.txt
|   |   ├── 1.9.6.txt
|   |   ├── 1.9.7.txt
|   |   ├── 1.9.8.txt
|   |   ├── 1.9.9.txt
|   |   ├── 1.9.txt
|   |   ├── 2.0.1.txt
|   |   ├── 2.0.10.txt
|   |   ├── 2.0.11.txt
|   |   ├── 2.0.12.txt
|   |   ├── 2.0.13.txt
|   |   ├── 2.0.2.txt
|   |   ├── 2.0.3.txt
|   |   ├── 2.0.4.txt
|   |   ├── 2.0.5.txt
|   |   ├── 2.0.6.txt
|   |   ├── 2.0.7.txt
|   |   ├── 2.0.8.txt
|   |   ├── 2.0.9.txt
|   |   ├── 2.0.txt
|   |   ├── 2.1.1.txt
|   |   ├── 2.1.2.txt
|   |   ├── 2.1.3.txt
|   |   ├── 2.1.4.txt
|   |   ├── 2.1.5.txt
|   |   ├── 2.1.6.txt
|   |   ├── 2.1.7.txt
|   |   ├── 2.1.8.txt
|   |   ├── 2.1.9.txt
|   |   ├── 2.1.txt
|   |   ├── 2.2.1.txt
|   |   ├── 2.2.2.txt
|   |   ├── 2.2.3.txt
|   |   ├── 2.2.txt
|   |   ├── 3.0.txt
|   |   ├── index.txt
|   |   └── security.txt
|   └── topics
|       ├── _images
|       ├── auth
|       |   ├── customizing.txt
|       |   ├── default.txt
|       |   ├── index.txt
|       |   └── passwords.txt
|       ├── cache.txt
|       ├── checks.txt
|       ├── class-based-views
|       |   ├── generic-display.txt
|       |   ├── generic-editing.txt
|       |   ├── index.txt
|       |   ├── intro.txt
|       |   └── mixins.txt
|       ├── conditional-view-processing.txt
|       ├── db
|       |   ├── aggregation.txt
|       |   ├── examples
|       |   |   ├── index.txt
|       |   |   ├── many_to_many.txt
|       |   |   ├── many_to_one.txt
|       |   |   └── one_to_one.txt
|       |   ├── index.txt
|       |   ├── instrumentation.txt
|       |   ├── managers.txt
|       |   ├── models.txt
|       |   ├── multi-db.txt
|       |   ├── optimization.txt
|       |   ├── queries.txt
|       |   ├── search.txt
|       |   ├── sql.txt
|       |   ├── tablespaces.txt
|       |   └── transactions.txt
|       ├── email.txt
|       ├── external-packages.txt
|       ├── files.txt
|       ├── forms
|       |   ├── formsets.txt
|       |   ├── index.txt
|       |   ├── media.txt
|       |   └── modelforms.txt
|       ├── http
|       |   ├── _images
|       |   ├── decorators.txt
|       |   ├── file-uploads.txt
|       |   ├── generic-views.txt
|       |   ├── index.txt
|       |   ├── middleware.txt
|       |   ├── sessions.txt
|       |   ├── shortcuts.txt
|       |   ├── urls.txt
|       |   └── views.txt
|       ├── i18n
|       |   ├── formatting.txt
|       |   ├── index.txt
|       |   ├── timezones.txt
|       |   └── translation.txt
|       ├── index.txt
|       ├── install.txt
|       ├── logging.txt
|       ├── migrations.txt
|       ├── pagination.txt
|       ├── performance.txt
|       ├── security.txt
|       ├── serialization.txt
|       ├── settings.txt
|       ├── signals.txt
|       ├── signing.txt
|       ├── templates.txt
|       └── testing
|           ├── _images
|           ├── advanced.txt
|           ├── index.txt
|           ├── overview.txt
|           └── tools.txt
├── extras
├── js_tests
|   ├── admin
|   |   ├── DateTimeShortcuts.test.js
|   |   ├── RelatedObjectLookups.test.js
|   |   ├── SelectBox.test.js
|   |   ├── SelectFilter2.test.js
|   |   ├── URLify.test.js
|   |   ├── actions.test.js
|   |   ├── core.test.js
|   |   ├── inlines.test.js
|   |   └── jsi18n-mocks.test.js
|   ├── gis
|   |   └── mapwidget.test.js
|   ├── qunit
|   |   ├── qunit.css
|   |   └── qunit.js
|   └── tests.html
├── scripts
|   ├── manage_translations.py
|   └── rpm-install.sh
├── setup.py
└── tests
    ├── README.rst
    ├── absolute_url_overrides
    |   ├── __init__.py
    |   └── tests.py
    ├── admin_autodiscover
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_changelist
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_date_hierarchy.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_checks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_custom_urls
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_default_site
    |   ├── __init__.py
    |   ├── apps.py
    |   ├── sites.py
    |   └── tests.py
    ├── admin_docs
    |   ├── __init__.py
    |   ├── evilfile.txt
    |   ├── models.py
    |   ├── namespace_urls.py
    |   ├── test_middleware.py
    |   ├── test_utils.py
    |   ├── test_views.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── admin_filters
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_inlines
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_templates.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_registration
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_scripts
    |   ├── __init__.py
    |   ├── another_app_waiting_migration
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   └── models.py
    |   ├── app_raising_messages
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app_raising_warning
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app_waiting_migration
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   └── models.py
    |   ├── app_with_import
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── broken_app
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── complex_app
    |   |   ├── __init__.py
    |   |   ├── admin
    |   |   |   ├── __init__.py
    |   |   |   └── foo.py
    |   |   ├── management
    |   |   |   └── commands
    |   |   └── models
    |   |       ├── __init__.py
    |   |       ├── bar.py
    |   |       └── foo.py
    |   ├── configured_dynamic_settings_manage.py
    |   ├── configured_settings_manage.py
    |   ├── custom_templates
    |   |   ├── app_template
    |   |   |   ├── __init__.py
    |   |   |   └── api.py
    |   |   └── project_template
    |   |       ├── additional_dir
    |   |       ├── project_name
    |   |       └── ticket-18091-non-ascii-template.txt
    |   ├── management
    |   |   └── commands
    |   |       ├── app_command.py
    |   |       ├── base_command.py
    |   |       ├── custom_startproject.py
    |   |       ├── label_command.py
    |   |       └── noargs_command.py
    |   ├── simple_app
    |   |   ├── __init__.py
    |   |   ├── management
    |   |   |   └── commands
    |   |   └── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_utils
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_logentry.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_views
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── custom_has_permission_admin.py
    |   ├── customadmin.py
    |   ├── forms.py
    |   ├── models.py
    |   ├── templates
    |   |   ├── admin
    |   |   |   ├── admin_views
    |   |   |   └── base_site.html
    |   |   └── custom_filter_template.html
    |   ├── test_actions.py
    |   ├── test_adminsite.py
    |   ├── test_autocomplete_view.py
    |   ├── test_forms.py
    |   ├── test_multidb.py
    |   ├── test_templatetags.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── admin_widgets
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_autocomplete_widget.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── widgetadmin.py
    ├── aggregation
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_filter_argument.py
    |   └── tests.py
    ├── aggregation_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── annotations
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── app_loading
    |   ├── __init__.py
    |   ├── eggs
    |   ├── not_installed
    |   |   ├── __init__.py
    |   |   └── models.py
    |   └── tests.py
    ├── apps
    |   ├── __init__.py
    |   ├── apps.py
    |   ├── default_config_app
    |   |   ├── __init__.py
    |   |   └── apps.py
    |   ├── models.py
    |   ├── namespace_package_base
    |   |   └── nsapp
    |   |       └── apps.py
    |   ├── namespace_package_other_base
    |   |   └── nsapp
    |   └── tests.py
    ├── auth_tests
    |   ├── __init__.py
    |   ├── backend_alias.py
    |   ├── client.py
    |   ├── common-passwords-custom.txt
    |   ├── fixtures
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── custom_permissions.py
    |   |   ├── custom_user.py
    |   |   ├── invalid_models.py
    |   |   ├── is_active.py
    |   |   ├── minimal.py
    |   |   ├── no_password.py
    |   |   ├── proxy.py
    |   |   ├── uuid_pk.py
    |   |   ├── with_custom_email_field.py
    |   |   ├── with_foreign_key.py
    |   |   ├── with_integer_username.py
    |   |   └── with_last_login_attr.py
    |   ├── settings.py
    |   ├── templates
    |   |   ├── context_processors
    |   |   |   ├── auth_attrs_access.html
    |   |   |   ├── auth_attrs_messages.html
    |   |   |   ├── auth_attrs_no_access.html
    |   |   |   ├── auth_attrs_perm_in_perms.html
    |   |   |   ├── auth_attrs_perms.html
    |   |   |   ├── auth_attrs_test_access.html
    |   |   |   └── auth_attrs_user.html
    |   |   └── registration
    |   |       ├── html_password_reset_email.html
    |   |       ├── logged_out.html
    |   |       ├── login.html
    |   |       ├── password_change_form.html
    |   |       ├── password_reset_complete.html
    |   |       ├── password_reset_confirm.html
    |   |       ├── password_reset_done.html
    |   |       ├── password_reset_email.html
    |   |       ├── password_reset_form.html
    |   |       └── password_reset_subject.txt
    |   ├── test_admin_multidb.py
    |   ├── test_auth_backends.py
    |   ├── test_basic.py
    |   ├── test_checks.py
    |   ├── test_context_processors.py
    |   ├── test_decorators.py
    |   ├── test_forms.py
    |   ├── test_handlers.py
    |   ├── test_hashers.py
    |   ├── test_management.py
    |   ├── test_middleware.py
    |   ├── test_migrations.py
    |   ├── test_mixins.py
    |   ├── test_models.py
    |   ├── test_remote_user.py
    |   ├── test_remote_user_deprecation.py
    |   ├── test_signals.py
    |   ├── test_templates.py
    |   ├── test_tokens.py
    |   ├── test_validators.py
    |   ├── test_views.py
    |   ├── urls.py
    |   ├── urls_admin.py
    |   └── urls_custom_user_admin.py
    ├── backends
    |   ├── __init__.py
    |   ├── base
    |   |   ├── __init__.py
    |   |   ├── test_base.py
    |   |   ├── test_creation.py
    |   |   ├── test_features.py
    |   |   ├── test_operations.py
    |   |   └── test_schema.py
    |   ├── models.py
    |   ├── mysql
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_features.py
    |   |   ├── test_schema.py
    |   |   └── tests.py
    |   ├── oracle
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_introspection.py
    |   |   ├── test_operations.py
    |   |   └── tests.py
    |   ├── postgresql
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_introspection.py
    |   |   ├── test_server_side_cursors.py
    |   |   └── tests.py
    |   ├── sqlite
    |   |   ├── __init__.py
    |   |   ├── test_introspection.py
    |   |   └── tests.py
    |   ├── test_ddl_references.py
    |   ├── test_utils.py
    |   └── tests.py
    ├── base
    |   ├── __init__.py
    |   └── models.py
    ├── bash_completion
    |   ├── __init__.py
    |   ├── management
    |   |   └── commands
    |   |       └── test_command.py
    |   └── tests.py
    ├── basic
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── builtin_server
    |   ├── __init__.py
    |   └── tests.py
    ├── bulk_create
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── cache
    |   ├── __init__.py
    |   ├── closeable_cache.py
    |   ├── liberal_backend.py
    |   ├── models.py
    |   └── tests.py
    ├── check_framework
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_caches.py
    |   ├── test_database.py
    |   ├── test_model_checks.py
    |   ├── test_model_field_deprecation.py
    |   ├── test_multi_db.py
    |   ├── test_security.py
    |   ├── test_templates.py
    |   ├── test_translation.py
    |   ├── test_urls.py
    |   ├── tests.py
    |   └── urls
    |       ├── __init__.py
    |       ├── bad_error_handlers.py
    |       ├── bad_error_handlers_invalid_path.py
    |       ├── beginning_with_slash.py
    |       ├── contains_tuple.py
    |       ├── good_error_handlers.py
    |       ├── include_contains_tuple.py
    |       ├── include_with_dollar.py
    |       ├── name_with_colon.py
    |       ├── no_warnings.py
    |       ├── no_warnings_i18n.py
    |       ├── non_unique_namespaces.py
    |       ├── path_compatibility
    |       |   ├── __init__.py
    |       |   ├── beginning_with_caret.py
    |       |   ├── contains_re_named_group.py
    |       |   └── ending_with_dollar.py
    |       ├── unique_namespaces.py
    |       └── warning_in_include.py
    ├── conditional_processing
    |   ├── __init__.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── constraints
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── contenttypes_tests
    |   ├── __init__.py
    |   ├── models.py
    |   ├── operations_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_rename_foo.py
    |   |   └── __init__.py
    |   ├── test_checks.py
    |   ├── test_fields.py
    |   ├── test_management.py
    |   ├── test_models.py
    |   ├── test_operations.py
    |   ├── test_order_with_respect_to.py
    |   ├── test_views.py
    |   └── urls.py
    ├── context_processors
    |   ├── __init__.py
    |   ├── models.py
    |   ├── templates
    |   |   └── context_processors
    |   |       ├── debug.html
    |   |       └── request_attrs.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── csrf_tests
    |   ├── __init__.py
    |   ├── csrf_token_error_handler_urls.py
    |   ├── test_context_processor.py
    |   ├── tests.py
    |   └── views.py
    ├── custom_columns
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_lookups
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_managers
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_methods
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_migration_operations
    |   ├── __init__.py
    |   ├── more_operations.py
    |   └── operations.py
    ├── custom_pk
    |   ├── __init__.py
    |   ├── fields.py
    |   ├── models.py
    |   └── tests.py
    ├── datatypes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── dates
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── datetimes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── db_functions
    |   ├── __init__.py
    |   ├── comparison
    |   |   ├── __init__.py
    |   |   ├── test_cast.py
    |   |   ├── test_coalesce.py
    |   |   ├── test_greatest.py
    |   |   ├── test_least.py
    |   |   └── test_nullif.py
    |   ├── datetime
    |   |   ├── __init__.py
    |   |   ├── test_extract_trunc.py
    |   |   └── test_now.py
    |   ├── math
    |   |   ├── __init__.py
    |   |   ├── test_abs.py
    |   |   ├── test_acos.py
    |   |   ├── test_asin.py
    |   |   ├── test_atan.py
    |   |   ├── test_atan2.py
    |   |   ├── test_ceil.py
    |   |   ├── test_cos.py
    |   |   ├── test_cot.py
    |   |   ├── test_degrees.py
    |   |   ├── test_exp.py
    |   |   ├── test_floor.py
    |   |   ├── test_ln.py
    |   |   ├── test_log.py
    |   |   ├── test_mod.py
    |   |   ├── test_pi.py
    |   |   ├── test_power.py
    |   |   ├── test_radians.py
    |   |   ├── test_round.py
    |   |   ├── test_sign.py
    |   |   ├── test_sin.py
    |   |   ├── test_sqrt.py
    |   |   └── test_tan.py
    |   ├── migrations
    |   |   ├── 0001_setup_extensions.py
    |   |   ├── 0002_create_test_models.py
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   ├── text
    |   |   ├── __init__.py
    |   |   ├── test_chr.py
    |   |   ├── test_concat.py
    |   |   ├── test_left.py
    |   |   ├── test_length.py
    |   |   ├── test_lower.py
    |   |   ├── test_md5.py
    |   |   ├── test_ord.py
    |   |   ├── test_pad.py
    |   |   ├── test_repeat.py
    |   |   ├── test_replace.py
    |   |   ├── test_reverse.py
    |   |   ├── test_right.py
    |   |   ├── test_sha1.py
    |   |   ├── test_sha224.py
    |   |   ├── test_sha256.py
    |   |   ├── test_sha384.py
    |   |   ├── test_sha512.py
    |   |   ├── test_strindex.py
    |   |   ├── test_substr.py
    |   |   ├── test_trim.py
    |   |   └── test_upper.py
    |   └── window
    |       ├── __init__.py
    |       └── test_validation.py
    ├── db_typecasts
    |   ├── __init__.py
    |   └── tests.py
    ├── db_utils
    |   ├── __init__.py
    |   └── tests.py
    ├── dbshell
    |   ├── __init__.py
    |   ├── test_mysql.py
    |   ├── test_oracle.py
    |   └── test_postgresql.py
    ├── decorators
    |   ├── __init__.py
    |   └── tests.py
    ├── defer
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── defer_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── delete
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── delete_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── deprecation
    |   ├── __init__.py
    |   └── tests.py
    ├── dispatch
    |   ├── __init__.py
    |   └── tests.py
    ├── distinct_on_fields
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── empty
    |   ├── __init__.py
    |   ├── models.py
    |   ├── no_models
    |   |   └── __init__.py
    |   └── tests.py
    ├── expressions
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_deprecation.py
    |   ├── test_queryset_values.py
    |   └── tests.py
    ├── expressions_case
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── expressions_window
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── extra_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── field_deconstruction
    |   ├── __init__.py
    |   └── tests.py
    ├── field_defaults
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── field_subclassing
    |   ├── __init__.py
    |   ├── fields.py
    |   └── tests.py
    ├── file_storage
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_generate_filename.py
    |   ├── tests.py
    |   └── urls.py
    ├── file_uploads
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   ├── uploadhandler.py
    |   ├── urls.py
    |   └── views.py
    ├── files
    |   ├── __init__.py
    |   └── tests.py
    ├── filtered_relation
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── fixtures
    |   ├── __init__.py
    |   ├── fixtures
    |   |   ├── fixture2.xml
    |   |   ├── fixture3.xml
    |   |   ├── fixture7.xml
    |   |   └── fixture9.xml
    |   ├── models.py
    |   └── tests.py
    ├── fixtures_model_package
    |   ├── __init__.py
    |   ├── fixtures
    |   |   └── fixture2.xml
    |   ├── models
    |   |   └── __init__.py
    |   └── tests.py
    ├── fixtures_regress
    |   ├── __init__.py
    |   ├── fixtures
    |   |   ├── animal.xml
    |   |   ├── bad_fixture2.xml
    |   |   ├── nk-inheritance2.xml
    |   |   ├── non_natural_2.xml
    |   |   ├── pretty.xml
    |   |   └── sequence_extra_xml.xml
    |   ├── fixtures_1
    |   |   └── inner
    |   ├── fixtures_2
    |   ├── models.py
    |   └── tests.py
    ├── flatpages_tests
    |   ├── __init__.py
    |   ├── settings.py
    |   ├── templates
    |   |   ├── flatpages
    |   |   |   └── default.html
    |   |   └── registration
    |   |       └── login.html
    |   ├── test_csrf.py
    |   ├── test_forms.py
    |   ├── test_middleware.py
    |   ├── test_models.py
    |   ├── test_sitemaps.py
    |   ├── test_templatetags.py
    |   ├── test_views.py
    |   └── urls.py
    ├── force_insert_update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── foreign_object
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── article.py
    |   |   ├── customers.py
    |   |   ├── empty_join.py
    |   |   └── person.py
    |   ├── test_agnostic_order_trimjoin.py
    |   ├── test_empty_join.py
    |   ├── test_forms.py
    |   └── tests.py
    ├── forms_tests
    |   ├── __init__.py
    |   ├── field_tests
    |   |   ├── __init__.py
    |   |   ├── filepathfield_test_dir
    |   |   |   ├── __init__.py
    |   |   |   ├── a.py
    |   |   |   ├── ab.py
    |   |   |   ├── b.py
    |   |   |   ├── c
    |   |   |   ├── h
    |   |   |   └── j
    |   |   ├── test_base.py
    |   |   ├── test_booleanfield.py
    |   |   ├── test_charfield.py
    |   |   ├── test_choicefield.py
    |   |   ├── test_combofield.py
    |   |   ├── test_datefield.py
    |   |   ├── test_datetimefield.py
    |   |   ├── test_decimalfield.py
    |   |   ├── test_durationfield.py
    |   |   ├── test_emailfield.py
    |   |   ├── test_filefield.py
    |   |   ├── test_filepathfield.py
    |   |   ├── test_floatfield.py
    |   |   ├── test_genericipaddressfield.py
    |   |   ├── test_imagefield.py
    |   |   ├── test_integerfield.py
    |   |   ├── test_multiplechoicefield.py
    |   |   ├── test_multivaluefield.py
    |   |   ├── test_nullbooleanfield.py
    |   |   ├── test_regexfield.py
    |   |   ├── test_slugfield.py
    |   |   ├── test_splitdatetimefield.py
    |   |   ├── test_timefield.py
    |   |   ├── test_typedchoicefield.py
    |   |   ├── test_typedmultiplechoicefield.py
    |   |   ├── test_urlfield.py
    |   |   └── test_uuidfield.py
    |   ├── jinja2
    |   |   └── forms_tests
    |   |       └── custom_widget.html
    |   ├── models.py
    |   ├── templates
    |   |   └── forms_tests
    |   |       ├── article_form.html
    |   |       └── custom_widget.html
    |   ├── tests
    |   |   ├── __init__.py
    |   |   ├── filepath_test_files
    |   |   |   ├── directory
    |   |   |   └── real-text-file.txt
    |   |   ├── test_error_messages.py
    |   |   ├── test_forms.py
    |   |   ├── test_formsets.py
    |   |   ├── test_i18n.py
    |   |   ├── test_input_formats.py
    |   |   ├── test_media.py
    |   |   ├── test_renderers.py
    |   |   ├── test_utils.py
    |   |   ├── test_validators.py
    |   |   ├── test_widgets.py
    |   |   └── tests.py
    |   ├── urls.py
    |   ├── views.py
    |   └── widget_tests
    |       ├── __init__.py
    |       ├── base.py
    |       ├── test_checkboxinput.py
    |       ├── test_checkboxselectmultiple.py
    |       ├── test_clearablefileinput.py
    |       ├── test_dateinput.py
    |       ├── test_datetimeinput.py
    |       ├── test_fileinput.py
    |       ├── test_hiddeninput.py
    |       ├── test_input.py
    |       ├── test_multiplehiddeninput.py
    |       ├── test_multiwidget.py
    |       ├── test_nullbooleanselect.py
    |       ├── test_numberinput.py
    |       ├── test_passwordinput.py
    |       ├── test_radioselect.py
    |       ├── test_select.py
    |       ├── test_selectdatewidget.py
    |       ├── test_selectmultiple.py
    |       ├── test_splitdatetimewidget.py
    |       ├── test_splithiddendatetimewidget.py
    |       ├── test_textarea.py
    |       ├── test_textinput.py
    |       ├── test_timeinput.py
    |       └── test_widget.py
    ├── from_db_value
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── generic_inline_admin
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── generic_relations
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_forms.py
    |   └── tests.py
    ├── generic_relations_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── generic_views
    |   ├── __init__.py
    |   ├── forms.py
    |   ├── jinja2
    |   |   └── generic_views
    |   |       └── using.html
    |   ├── models.py
    |   ├── templates
    |   |   ├── generic_views
    |   |   |   ├── about.html
    |   |   |   ├── apple_detail.html
    |   |   |   ├── artist_detail.html
    |   |   |   ├── artist_form.html
    |   |   |   ├── author_confirm_delete.html
    |   |   |   ├── author_detail.html
    |   |   |   ├── author_form.html
    |   |   |   ├── author_list.html
    |   |   |   ├── author_objects.html
    |   |   |   ├── author_view.html
    |   |   |   ├── book_archive.html
    |   |   |   ├── book_archive_day.html
    |   |   |   ├── book_archive_month.html
    |   |   |   ├── book_archive_week.html
    |   |   |   ├── book_archive_year.html
    |   |   |   ├── book_detail.html
    |   |   |   ├── book_list.html
    |   |   |   ├── confirm_delete.html
    |   |   |   ├── detail.html
    |   |   |   ├── form.html
    |   |   |   ├── list.html
    |   |   |   ├── page_template.html
    |   |   |   ├── robots.txt
    |   |   |   └── using.html
    |   |   └── registration
    |   |       └── login.html
    |   ├── test_base.py
    |   ├── test_dates.py
    |   ├── test_detail.py
    |   ├── test_edit.py
    |   ├── test_list.py
    |   ├── urls.py
    |   └── views.py
    ├── get_earliest_or_latest
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── get_object_or_404
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── get_or_create
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── gis_tests
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── data
    |   |   ├── __init__.py
    |   |   ├── ch-city
    |   |   ├── cities
    |   |   ├── counties
    |   |   ├── gas_lines
    |   |   ├── has_nulls
    |   |   ├── interstates
    |   |   ├── invalid
    |   |   ├── rasters
    |   |   |   ├── __init__.py
    |   |   |   ├── raster.numpy.txt
    |   |   |   └── textrasters.py
    |   |   ├── test_point
    |   |   ├── test_poly
    |   |   └── test_vrt
    |   ├── distapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── gdal_tests
    |   |   ├── __init__.py
    |   |   ├── test_driver.py
    |   |   ├── test_ds.py
    |   |   ├── test_envelope.py
    |   |   ├── test_geom.py
    |   |   ├── test_raster.py
    |   |   └── test_srs.py
    |   ├── geo3d
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   ├── tests.py
    |   |   └── views.py
    |   ├── geoadmin
    |   |   ├── __init__.py
    |   |   ├── admin.py
    |   |   ├── models.py
    |   |   ├── tests.py
    |   |   └── urls.py
    |   ├── geoapp
    |   |   ├── __init__.py
    |   |   ├── feeds.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   ├── sitemaps.py
    |   |   ├── test_expressions.py
    |   |   ├── test_feeds.py
    |   |   ├── test_functions.py
    |   |   ├── test_regress.py
    |   |   ├── test_serializers.py
    |   |   ├── test_sitemaps.py
    |   |   ├── tests.py
    |   |   └── urls.py
    |   ├── geogapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── geos_tests
    |   |   ├── __init__.py
    |   |   ├── test_coordseq.py
    |   |   ├── test_geos.py
    |   |   ├── test_geos_mutation.py
    |   |   ├── test_io.py
    |   |   └── test_mutable_list.py
    |   ├── gis_migrations
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   ├── test_commands.py
    |   |   └── test_operations.py
    |   ├── inspectapp
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── layermap
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── maps
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── rasterapp
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── test_rasterfield.py
    |   ├── relatedapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── test_data.py
    |   ├── test_fields.py
    |   ├── test_geoforms.py
    |   ├── test_geoip2.py
    |   ├── test_gis_tests_utils.py
    |   ├── test_measure.py
    |   ├── test_ptr.py
    |   ├── test_spatialrefsys.py
    |   ├── tests.py
    |   └── utils.py
    ├── handlers
    |   ├── __init__.py
    |   ├── templates
    |   |   └── test_handler.html
    |   ├── test_exception.py
    |   ├── tests.py
    |   ├── tests_custom_error_handlers.py
    |   ├── urls.py
    |   └── views.py
    ├── httpwrappers
    |   ├── __init__.py
    |   ├── abc.txt
    |   └── tests.py
    ├── humanize_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── i18n
    |   ├── __init__.py
    |   ├── commands
    |   |   ├── __init__.py
    |   |   ├── app_with_locale
    |   |   |   └── locale
    |   |   ├── ignore_dir
    |   |   |   └── ignored.html
    |   |   ├── javascript.js
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   ├── es_AR
    |   |   |   ├── fr
    |   |   |   ├── hr
    |   |   |   ├── ja
    |   |   |   ├── ko
    |   |   |   ├── pt_BR
    |   |   |   ├── ru
    |   |   |   └── xxx
    |   |   ├── media_root
    |   |   |   └── media_ignored.html
    |   |   ├── someapp
    |   |   |   └── static
    |   |   ├── static
    |   |   |   ├── javascript_ignored.js
    |   |   |   └── static_ignored.html
    |   |   └── templates
    |   |       ├── empty.html
    |   |       ├── subdir
    |   |       ├── test.html
    |   |       └── xxx_ignored.html
    |   ├── contenttypes
    |   |   ├── __init__.py
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   └── fr
    |   |   └── tests.py
    |   ├── exclude
    |   |   ├── __init__.py
    |   |   └── canned_locale
    |   |       ├── en
    |   |       ├── fr
    |   |       └── it
    |   ├── forms.py
    |   ├── models.py
    |   ├── other
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       ├── de
    |   |       └── fr
    |   ├── other2
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       └── de
    |   ├── patterns
    |   |   ├── __init__.py
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   ├── nl
    |   |   |   └── pt_BR
    |   |   ├── templates
    |   |   |   ├── 404.html
    |   |   |   └── dummy.html
    |   |   ├── tests.py
    |   |   └── urls
    |   |       ├── __init__.py
    |   |       ├── default.py
    |   |       ├── disabled.py
    |   |       ├── included.py
    |   |       ├── namespace.py
    |   |       ├── path_unused.py
    |   |       ├── wrong.py
    |   |       └── wrong_namespace.py
    |   ├── project_dir
    |   |   ├── __init__.py
    |   |   ├── app_no_locale
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── app_with_locale
    |   |   |   ├── __init__.py
    |   |   |   ├── locale
    |   |   |   └── models.py
    |   |   └── project_locale
    |   ├── resolution
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── de
    |   ├── sampleproject
    |   |   ├── locale
    |   |   |   └── fr
    |   |   ├── manage.py
    |   |   ├── sampleproject
    |   |   |   ├── __init__.py
    |   |   |   └── settings.py
    |   |   ├── templates
    |   |   |   └── percents.html
    |   |   └── update_catalogs.py
    |   ├── territorial_fallback
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── de
    |   |       └── de_DE
    |   ├── test_compilation.py
    |   ├── test_extraction.py
    |   ├── test_management.py
    |   ├── test_percents.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── urls_default_unprefixed.py
    |   └── utils.py
    ├── import_error_package
    |   └── __init__.py
    ├── indexes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── inline_formsets
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── inspectdb
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── introspection
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── invalid_models_tests
    |   ├── __init__.py
    |   ├── test_backend_specific.py
    |   ├── test_custom_fields.py
    |   ├── test_deprecated_fields.py
    |   ├── test_models.py
    |   ├── test_ordinary_fields.py
    |   └── test_relative_fields.py
    ├── known_related_objects
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── logging_tests
    |   ├── __init__.py
    |   ├── logconfig.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── urls_i18n.py
    |   └── views.py
    ├── lookup
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_decimalfield.py
    |   ├── test_lookups.py
    |   ├── test_timefield.py
    |   └── tests.py
    ├── m2m_and_m2o
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_intermediary
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_multiple
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_recursive
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_signals
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_through
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_through_regress
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── test_multitable.py
    |   └── tests.py
    ├── m2o_recursive
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── mail
    |   ├── __init__.py
    |   ├── attachments
    |   |   ├── file.txt
    |   |   └── file_png.txt
    |   ├── custombackend.py
    |   ├── test_sendtestemail.py
    |   └── tests.py
    ├── managers_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_many
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_one
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_one_null
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── max_lengths
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── messages_tests
    |   ├── __init__.py
    |   ├── base.py
    |   ├── test_api.py
    |   ├── test_cookie.py
    |   ├── test_fallback.py
    |   ├── test_middleware.py
    |   ├── test_mixins.py
    |   ├── test_session.py
    |   └── urls.py
    ├── middleware
    |   ├── __init__.py
    |   ├── cond_get_urls.py
    |   ├── extra_urls.py
    |   ├── test_security.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── middleware_exceptions
    |   ├── __init__.py
    |   ├── middleware.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── migrate_signals
    |   ├── __init__.py
    |   ├── custom_migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── migration_test_data_persistence
    |   ├── __init__.py
    |   ├── migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_add_book.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── migrations
    |   ├── __init__.py
    |   ├── deprecated_field_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_remove_ipaddressfield_ip.py
    |   |   └── __init__.py
    |   ├── faulty_migrations
    |   |   ├── __init__.py
    |   |   ├── file.py
    |   |   └── namespace
    |   |       └── foo
    |   ├── migrations_test_apps
    |   |   ├── __init__.py
    |   |   ├── alter_fk
    |   |   |   ├── __init__.py
    |   |   |   ├── author_app
    |   |   |   └── book_app
    |   |   ├── conflicting_app_with_dependencies
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── lookuperror_a
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── lookuperror_b
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── lookuperror_c
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── migrated_app
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── migrated_unapplied_app
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── mutate_state_a
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── mutate_state_b
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── normal
    |   |   |   └── __init__.py
    |   |   ├── unmigrated_app
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unmigrated_app_simple
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unmigrated_app_syncdb
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unspecified_app_with_conflict
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── with_package_model
    |   |   |   ├── __init__.py
    |   |   |   └── models
    |   |   └── without_init_file
    |   |       ├── __init__.py
    |   |       └── migrations
    |   ├── models.py
    |   ├── related_models_app
    |   |   └── __init__.py
    |   ├── routers.py
    |   ├── test_add_many_to_many_field_initial
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_initial.py
    |   |   └── __init__.py
    |   ├── test_auto_now_add
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_autodetector.py
    |   ├── test_base.py
    |   ├── test_commands.py
    |   ├── test_deprecated_fields.py
    |   ├── test_exceptions.py
    |   ├── test_executor.py
    |   ├── test_graph.py
    |   ├── test_loader.py
    |   ├── test_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_atomic_operation
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_backwards_deps_1
    |   |   ├── 0001_initial.py
    |   |   └── 0002_second.py
    |   ├── test_migrations_bad_pyc
    |   |   └── __init__.py
    |   ├── test_migrations_clashing_prefix
    |   |   ├── __init__.py
    |   |   ├── a.py
    |   |   └── ab.py
    |   ├── test_migrations_conflict
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_conflicting_second.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_custom_user
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_empty
    |   |   └── __init__.py
    |   ├── test_migrations_fake_split_initial
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_first
    |   |   ├── __init__.py
    |   |   ├── second.py
    |   |   └── thefirst.py
    |   ├── test_migrations_initial_false
    |   |   ├── 0001_not_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_ancestor
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_conflicting_second.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_changes
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_default
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_init
    |   ├── test_migrations_non_atomic
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_order
    |   |   ├── 0001.py
    |   |   └── __init__.py
    |   ├── test_migrations_plan
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   ├── 0004_fourth.py
    |   |   └── __init__.py
    |   ├── test_migrations_private
    |   |   ├── .util.py
    |   |   ├── 0001_initial.py
    |   |   ├── __init__.py
    |   |   ├── _util.py
    |   |   └── ~util.py
    |   ├── test_migrations_run_before
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed
    |   |   ├── 0001_initial.py
    |   |   ├── 0001_squashed_0002.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_complex
    |   |   ├── 1_auto.py
    |   |   ├── 2_auto.py
    |   |   ├── 3_auto.py
    |   |   ├── 3_squashed_5.py
    |   |   ├── 4_auto.py
    |   |   ├── 5_auto.py
    |   |   ├── 6_auto.py
    |   |   ├── 7_auto.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_complex_multi_apps
    |   |   ├── __init__.py
    |   |   ├── app1
    |   |   |   ├── 1_auto.py
    |   |   |   ├── 2_auto.py
    |   |   |   ├── 2_squashed_3.py
    |   |   |   ├── 3_auto.py
    |   |   |   ├── 4_auto.py
    |   |   |   └── __init__.py
    |   |   └── app2
    |   |       ├── 1_auto.py
    |   |       ├── 1_squashed_2.py
    |   |       ├── 2_auto.py
    |   |       └── __init__.py
    |   ├── test_migrations_squashed_erroneous
    |   |   ├── 1_auto.py
    |   |   ├── 2_auto.py
    |   |   ├── 3_squashed_5.py
    |   |   ├── 6_auto.py
    |   |   ├── 7_auto.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_extra
    |   |   ├── 0001_initial.py
    |   |   ├── 0001_squashed_0002.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_ref_squashed
    |   |   ├── __init__.py
    |   |   ├── app1
    |   |   |   ├── 1_auto.py
    |   |   |   ├── 2_auto.py
    |   |   |   ├── 2_squashed_3.py
    |   |   |   ├── 3_auto.py
    |   |   |   ├── 4_auto.py
    |   |   |   └── __init__.py
    |   |   └── app2
    |   |       ├── 1_auto.py
    |   |       ├── 1_squashed_2.py
    |   |       ├── 2_auto.py
    |   |       └── __init__.py
    |   ├── test_migrations_unmigdep
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_multidb.py
    |   ├── test_operations.py
    |   ├── test_optimizer.py
    |   ├── test_questioner.py
    |   ├── test_state.py
    |   └── test_writer.py
    ├── migrations2
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_migrations_2
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_2_first
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   └── test_migrations_2_no_deps
    |       ├── 0001_initial.py
    |       └── __init__.py
    ├── model_fields
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_binaryfield.py
    |   ├── test_booleanfield.py
    |   ├── test_charfield.py
    |   ├── test_datetimefield.py
    |   ├── test_decimalfield.py
    |   ├── test_durationfield.py
    |   ├── test_field_flags.py
    |   ├── test_filefield.py
    |   ├── test_filepathfield.py
    |   ├── test_floatfield.py
    |   ├── test_foreignkey.py
    |   ├── test_genericipaddressfield.py
    |   ├── test_imagefield.py
    |   ├── test_integerfield.py
    |   ├── test_manytomanyfield.py
    |   ├── test_promises.py
    |   ├── test_slugfield.py
    |   ├── test_textfield.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_forms
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_modelchoicefield.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_formsets
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_formsets_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_indexes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_inheritance
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_abstract_inheritance.py
    |   └── tests.py
    ├── model_inheritance_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_meta
    |   ├── __init__.py
    |   ├── models.py
    |   ├── results.py
    |   └── tests.py
    ├── model_options
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── default_related_name.py
    |   |   └── tablespaces.py
    |   ├── test_default_related_name.py
    |   └── test_tablespaces.py
    ├── model_package
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── article.py
    |   |   └── publication.py
    |   └── tests.py
    ├── model_regress
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_pickle.py
    |   ├── test_state.py
    |   └── tests.py
    ├── modeladmin
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_actions.py
    |   ├── test_checks.py
    |   └── tests.py
    ├── multiple_database
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── routers.py
    |   └── tests.py
    ├── mutually_referential
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── nested_foreign_keys
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── no_models
    |   ├── __init__.py
    |   └── tests.py
    ├── null_fk
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── null_fk_ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── null_queries
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── one_to_one
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── or_lookups
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── order_with_respect_to
    |   ├── __init__.py
    |   ├── base_tests.py
    |   ├── models.py
    |   └── tests.py
    ├── ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── pagination
    |   ├── __init__.py
    |   ├── custom.py
    |   ├── models.py
    |   └── tests.py
    ├── postgres_tests
    |   ├── __init__.py
    |   ├── array_default_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_integerarraymodel_field_2.py
    |   |   └── __init__.py
    |   ├── array_index_migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── fields.py
    |   ├── integration_settings.py
    |   ├── migrations
    |   |   ├── 0001_setup_extensions.py
    |   |   ├── 0002_create_test_models.py
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── test_aggregates.py
    |   ├── test_apps.py
    |   ├── test_array.py
    |   ├── test_bulk_update.py
    |   ├── test_citext.py
    |   ├── test_constraints.py
    |   ├── test_functions.py
    |   ├── test_hstore.py
    |   ├── test_indexes.py
    |   ├── test_integration.py
    |   ├── test_introspection.py
    |   ├── test_json.py
    |   ├── test_ranges.py
    |   ├── test_search.py
    |   ├── test_signals.py
    |   ├── test_trigram.py
    |   └── test_unaccent.py
    ├── prefetch_related
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_prefetch_related_objects.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── project_template
    |   ├── __init__.py
    |   ├── test_settings.py
    |   ├── urls.py
    |   └── views.py
    ├── properties
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── proxy_model_inheritance
    |   ├── __init__.py
    |   ├── app1
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app2
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── models.py
    |   └── tests.py
    ├── proxy_models
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── queries
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_bulk_update.py
    |   ├── test_explain.py
    |   ├── test_iterator.py
    |   ├── test_q.py
    |   ├── test_qs_combinators.py
    |   ├── test_query.py
    |   └── tests.py
    ├── queryset_pickle
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── raw_query
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── redirects_tests
    |   ├── __init__.py
    |   ├── tests.py
    |   └── urls.py
    ├── requests
    |   ├── __init__.py
    |   ├── test_data_upload_settings.py
    |   └── tests.py
    ├── requirements
    |   ├── mysql.txt
    |   ├── oracle.txt
    |   ├── postgres.txt
    |   └── py3.txt
    ├── reserved_names
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── resolve_url
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── responses
    |   ├── __init__.py
    |   ├── test_cookie.py
    |   ├── test_fileresponse.py
    |   └── tests.py
    ├── reverse_lookup
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── runtests.py
    ├── save_delete_hooks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── schema
    |   ├── __init__.py
    |   ├── fields.py
    |   ├── models.py
    |   ├── test_logging.py
    |   └── tests.py
    ├── select_for_update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related_onetoone
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── serializers
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── base.py
    |   |   ├── data.py
    |   |   ├── multi_table.py
    |   |   └── natural.py
    |   ├── test_data.py
    |   ├── test_deserializedobject.py
    |   ├── test_json.py
    |   ├── test_natural.py
    |   ├── test_xml.py
    |   ├── test_yaml.py
    |   └── tests.py
    ├── servers
    |   ├── __init__.py
    |   ├── another_app
    |   |   ├── __init__.py
    |   |   └── static
    |   |       └── another_app
    |   ├── fixtures
    |   ├── media
    |   |   └── example_media_file.txt
    |   ├── models.py
    |   ├── static
    |   |   └── example_static_file.txt
    |   ├── test_basehttp.py
    |   ├── test_liveserverthread.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── sessions_tests
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── settings_tests
    |   ├── __init__.py
    |   ├── test_file_charset.py
    |   └── tests.py
    ├── shell
    |   ├── __init__.py
    |   └── tests.py
    ├── shortcuts
    |   ├── __init__.py
    |   ├── jinja2
    |   |   └── shortcuts
    |   |       └── using.html
    |   ├── templates
    |   |   └── shortcuts
    |   |       ├── render_test.html
    |   |       └── using.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── signals
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── signed_cookies_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── signing
    |   ├── __init__.py
    |   └── tests.py
    ├── sitemaps_tests
    |   ├── __init__.py
    |   ├── base.py
    |   ├── models.py
    |   ├── templates
    |   |   ├── custom_sitemap.xml
    |   |   └── custom_sitemap_index.xml
    |   ├── test_generic.py
    |   ├── test_http.py
    |   ├── test_https.py
    |   ├── test_management.py
    |   ├── test_utils.py
    |   └── urls
    |       ├── __init__.py
    |       ├── empty.py
    |       ├── http.py
    |       ├── https.py
    |       └── index_only.py
    ├── sites_framework
    |   ├── __init__.py
    |   ├── migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── sites_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── staticfiles_tests
    |   ├── __init__.py
    |   ├── apps
    |   |   ├── __init__.py
    |   |   ├── no_label
    |   |   |   ├── __init__.py
    |   |   |   └── static
    |   |   ├── staticfiles_config.py
    |   |   └── test
    |   |       ├── __init__.py
    |   |       ├── otherdir
    |   |       └── static
    |   ├── cases.py
    |   ├── project
    |   |   ├── documents
    |   |   |   ├── absolute_root.css
    |   |   |   ├── cached
    |   |   |   ├── styles_root.css
    |   |   |   ├── subdir
    |   |   |   ├── test
    |   |   |   └── test.txt
    |   |   ├── faulty
    |   |   |   └── faulty.css
    |   |   ├── loop
    |   |   |   ├── bar.css
    |   |   |   └── foo.css
    |   |   ├── prefixed
    |   |   |   └── test.txt
    |   |   └── site_media
    |   |       ├── media
    |   |       └── static
    |   ├── settings.py
    |   ├── storage.py
    |   ├── test_checks.py
    |   ├── test_finders.py
    |   ├── test_forms.py
    |   ├── test_liveserver.py
    |   ├── test_management.py
    |   ├── test_storage.py
    |   ├── test_templatetags.py
    |   ├── test_utils.py
    |   ├── test_views.py
    |   └── urls
    |       ├── __init__.py
    |       ├── default.py
    |       └── helper.py
    ├── str
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── string_lookup
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── swappable_models
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── syndication_tests
    |   ├── __init__.py
    |   ├── feeds.py
    |   ├── models.py
    |   ├── templates
    |   |   └── syndication
    |   |       ├── description.html
    |   |       ├── description_context.html
    |   |       ├── title.html
    |   |       └── title_context.html
    |   ├── tests.py
    |   └── urls.py
    ├── template_backends
    |   ├── __init__.py
    |   ├── apps
    |   |   ├── __init__.py
    |   |   ├── good
    |   |   |   ├── __init__.py
    |   |   |   └── templatetags
    |   |   └── importerror
    |   |       ├── __init__.py
    |   |       └── templatetags
    |   ├── forbidden
    |   |   └── template_backends
    |   |       └── hello.html
    |   ├── jinja2
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       ├── django_escaping.html
    |   |       ├── hello.html
    |   |       ├── syntax_error.html
    |   |       └── syntax_error2.html
    |   ├── template_strings
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       └── hello.html
    |   ├── templates
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       ├── django_escaping.html
    |   |       ├── hello.html
    |   |       └── syntax_error.html
    |   ├── test_django.py
    |   ├── test_dummy.py
    |   ├── test_jinja2.py
    |   └── test_utils.py
    ├── template_loader
    |   ├── __init__.py
    |   ├── template_strings
    |   |   └── template_loader
    |   |       └── hello.html
    |   ├── templates
    |   |   └── template_loader
    |   |       ├── goodbye.html
    |   |       ├── hello.html
    |   |       └── request.html
    |   └── tests.py
    ├── template_tests
    |   ├── __init__.py
    |   ├── alternate_urls.py
    |   ├── annotated_tag_function.py
    |   ├── broken_tag.py
    |   ├── eggs
    |   ├── filter_tests
    |   |   ├── __init__.py
    |   |   ├── test_add.py
    |   |   ├── test_addslashes.py
    |   |   ├── test_autoescape.py
    |   |   ├── test_capfirst.py
    |   |   ├── test_center.py
    |   |   ├── test_chaining.py
    |   |   ├── test_cut.py
    |   |   ├── test_date.py
    |   |   ├── test_default.py
    |   |   ├── test_default_if_none.py
    |   |   ├── test_dictsort.py
    |   |   ├── test_dictsortreversed.py
    |   |   ├── test_divisibleby.py
    |   |   ├── test_escape.py
    |   |   ├── test_escapejs.py
    |   |   ├── test_filesizeformat.py
    |   |   ├── test_first.py
    |   |   ├── test_floatformat.py
    |   |   ├── test_force_escape.py
    |   |   ├── test_get_digit.py
    |   |   ├── test_iriencode.py
    |   |   ├── test_join.py
    |   |   ├── test_json_script.py
    |   |   ├── test_last.py
    |   |   ├── test_length.py
    |   |   ├── test_length_is.py
    |   |   ├── test_linebreaks.py
    |   |   ├── test_linebreaksbr.py
    |   |   ├── test_linenumbers.py
    |   |   ├── test_ljust.py
    |   |   ├── test_lower.py
    |   |   ├── test_make_list.py
    |   |   ├── test_phone2numeric.py
    |   |   ├── test_pluralize.py
    |   |   ├── test_random.py
    |   |   ├── test_rjust.py
    |   |   ├── test_safe.py
    |   |   ├── test_safeseq.py
    |   |   ├── test_slice.py
    |   |   ├── test_slugify.py
    |   |   ├── test_stringformat.py
    |   |   ├── test_striptags.py
    |   |   ├── test_time.py
    |   |   ├── test_timesince.py
    |   |   ├── test_timeuntil.py
    |   |   ├── test_title.py
    |   |   ├── test_truncatechars.py
    |   |   ├── test_truncatechars_html.py
    |   |   ├── test_truncatewords.py
    |   |   ├── test_truncatewords_html.py
    |   |   ├── test_unordered_list.py
    |   |   ├── test_upper.py
    |   |   ├── test_urlencode.py
    |   |   ├── test_urlize.py
    |   |   ├── test_urlizetrunc.py
    |   |   ├── test_wordcount.py
    |   |   ├── test_wordwrap.py
    |   |   ├── test_yesno.py
    |   |   └── timezone_utils.py
    |   ├── jinja2
    |   |   └── template_tests
    |   |       └── using.html
    |   ├── other_templates
    |   |   ├── priority
    |   |   |   └── foo.html
    |   |   └── test_dirs.html
    |   ├── recursive_templates
    |   |   ├── fs
    |   |   |   ├── extend-missing.html
    |   |   |   ├── one.html
    |   |   |   ├── other-recursive.html
    |   |   |   ├── recursive.html
    |   |   |   ├── self.html
    |   |   |   ├── three.html
    |   |   |   └── two.html
    |   |   ├── fs2
    |   |   |   └── recursive.html
    |   |   └── fs3
    |   |       └── recursive.html
    |   ├── relative_templates
    |   |   ├── dir1
    |   |   |   ├── dir2
    |   |   |   ├── looped.html
    |   |   |   ├── one.html
    |   |   |   ├── one1.html
    |   |   |   ├── one2.html
    |   |   |   ├── one3.html
    |   |   |   ├── three.html
    |   |   |   └── two.html
    |   |   ├── error_extends.html
    |   |   ├── error_include.html
    |   |   ├── one.html
    |   |   ├── three.html
    |   |   └── two.html
    |   ├── syntax_tests
    |   |   ├── __init__.py
    |   |   ├── i18n
    |   |   |   ├── __init__.py
    |   |   |   ├── base.py
    |   |   |   ├── test_blocktrans.py
    |   |   |   ├── test_filters.py
    |   |   |   ├── test_get_available_languages.py
    |   |   |   ├── test_get_current_language.py
    |   |   |   ├── test_get_current_language_bidi.py
    |   |   |   ├── test_get_language_info.py
    |   |   |   ├── test_get_language_info_list.py
    |   |   |   ├── test_language.py
    |   |   |   ├── test_trans.py
    |   |   |   └── test_underscore_syntax.py
    |   |   ├── test_autoescape.py
    |   |   ├── test_basic.py
    |   |   ├── test_builtins.py
    |   |   ├── test_cache.py
    |   |   ├── test_comment.py
    |   |   ├── test_cycle.py
    |   |   ├── test_exceptions.py
    |   |   ├── test_extends.py
    |   |   ├── test_filter_syntax.py
    |   |   ├── test_filter_tag.py
    |   |   ├── test_firstof.py
    |   |   ├── test_for.py
    |   |   ├── test_if.py
    |   |   ├── test_if_changed.py
    |   |   ├── test_if_equal.py
    |   |   ├── test_include.py
    |   |   ├── test_invalid_string.py
    |   |   ├── test_list_index.py
    |   |   ├── test_load.py
    |   |   ├── test_lorem.py
    |   |   ├── test_multiline.py
    |   |   ├── test_named_endblock.py
    |   |   ├── test_now.py
    |   |   ├── test_numpy.py
    |   |   ├── test_regroup.py
    |   |   ├── test_resetcycle.py
    |   |   ├── test_setup.py
    |   |   ├── test_simple_tag.py
    |   |   ├── test_spaceless.py
    |   |   ├── test_static.py
    |   |   ├── test_template_tag.py
    |   |   ├── test_url.py
    |   |   ├── test_verbatim.py
    |   |   ├── test_width_ratio.py
    |   |   └── test_with.py
    |   ├── templates
    |   |   ├── 27584_child.html
    |   |   ├── 27584_parent.html
    |   |   ├── 27956_child.html
    |   |   ├── 27956_parent.html
    |   |   ├── broken_base.html
    |   |   ├── first
    |   |   |   └── test.html
    |   |   ├── include_tpl.html
    |   |   ├── included_base.html
    |   |   ├── included_content.html
    |   |   ├── inclusion.html
    |   |   ├── inclusion_base.html
    |   |   ├── inclusion_extends1.html
    |   |   ├── inclusion_extends2.html
    |   |   ├── index.html
    |   |   ├── priority
    |   |   |   └── foo.html
    |   |   ├── recursive_include.html
    |   |   ├── response.html
    |   |   ├── second
    |   |   |   └── test.html
    |   |   ├── ssi include with spaces.html
    |   |   ├── ssi_include.html
    |   |   ├── template_tests
    |   |   |   └── using.html
    |   |   ├── test_context.html
    |   |   ├── test_context_stack.html
    |   |   ├── test_extends_error.html
    |   |   ├── test_incl_tag_use_l10n.html
    |   |   └── test_include_error.html
    |   ├── templatetags
    |   |   ├── __init__.py
    |   |   ├── bad_tag.py
    |   |   ├── custom.py
    |   |   ├── inclusion.py
    |   |   ├── subpackage
    |   |   |   ├── __init__.py
    |   |   |   └── echo.py
    |   |   ├── tag_27584.py
    |   |   └── testtags.py
    |   ├── test_base.py
    |   ├── test_callables.py
    |   ├── test_context.py
    |   ├── test_custom.py
    |   ├── test_engine.py
    |   ├── test_extends.py
    |   ├── test_extends_relative.py
    |   ├── test_library.py
    |   ├── test_loaders.py
    |   ├── test_logging.py
    |   ├── test_nodelist.py
    |   ├── test_origin.py
    |   ├── test_parser.py
    |   ├── test_response.py
    |   ├── test_smartif.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── utils.py
    |   └── views.py
    ├── templates
    |   ├── base.html
    |   ├── comments
    |   |   └── comment_notification_email.txt
    |   ├── custom_admin
    |   |   ├── add_form.html
    |   |   ├── app_index.html
    |   |   ├── change_form.html
    |   |   ├── change_list.html
    |   |   ├── delete_confirmation.html
    |   |   ├── delete_selected_confirmation.html
    |   |   ├── index.html
    |   |   ├── login.html
    |   |   ├── logout.html
    |   |   ├── object_history.html
    |   |   ├── password_change_done.html
    |   |   ├── password_change_form.html
    |   |   └── popup_response.html
    |   ├── extended.html
    |   ├── form_view.html
    |   ├── login.html
    |   └── views
    |       ├── article_archive_day.html
    |       ├── article_archive_month.html
    |       ├── article_confirm_delete.html
    |       ├── article_detail.html
    |       ├── article_form.html
    |       ├── article_list.html
    |       ├── datearticle_archive_month.html
    |       ├── urlarticle_detail.html
    |       └── urlarticle_form.html
    ├── test_client
    |   ├── __init__.py
    |   ├── auth_backends.py
    |   ├── test_conditional_content_removal.py
    |   ├── test_fakepayload.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── test_client_regress
    |   ├── __init__.py
    |   ├── auth_backends.py
    |   ├── bad_templates
    |   |   └── 404.html
    |   ├── context_processors.py
    |   ├── models.py
    |   ├── session.py
    |   ├── templates
    |   |   ├── request_context.html
    |   |   └── unicode.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── test_exceptions
    |   ├── __init__.py
    |   └── test_validation_error.py
    ├── test_runner
    |   ├── __init__.py
    |   ├── models.py
    |   ├── runner.py
    |   ├── test_debug_sql.py
    |   ├── test_discover_runner.py
    |   ├── test_parallel.py
    |   └── tests.py
    ├── test_runner_apps
    |   ├── __init__.py
    |   ├── databases
    |   |   ├── __init__.py
    |   |   └── tests.py
    |   ├── sample
    |   |   ├── __init__.py
    |   |   ├── doctests.py
    |   |   ├── empty.py
    |   |   ├── pattern_tests.py
    |   |   ├── tests
    |   |   |   ├── __init__.py
    |   |   |   └── tests.py
    |   |   └── tests_sample.py
    |   ├── simple
    |   |   ├── __init__.py
    |   |   └── tests.py
    |   └── tagged
    |       ├── __init__.py
    |       ├── tests.py
    |       └── tests_inheritance.py
    ├── test_sqlite.py
    ├── test_utils
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── templates
    |   |   └── template_used
    |   |       ├── alternative.html
    |   |       ├── base.html
    |   |       ├── extends.html
    |   |       └── include.html
    |   ├── test_deprecated_features.py
    |   ├── test_testcase.py
    |   ├── test_transactiontestcase.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── timezones
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── forms.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── transaction_hooks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── transactions
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── unmanaged_models
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── update_only_fields
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── urlpatterns
    |   ├── __init__.py
    |   ├── converter_urls.py
    |   ├── converters.py
    |   ├── included_urls.py
    |   ├── more_urls.py
    |   ├── path_base64_urls.py
    |   ├── path_dynamic_urls.py
    |   ├── path_urls.py
    |   ├── test_resolvers.py
    |   ├── tests.py
    |   └── views.py
    ├── urlpatterns_reverse
    |   ├── __init__.py
    |   ├── erroneous_urls.py
    |   ├── extra_urls.py
    |   ├── included_app_urls.py
    |   ├── included_named_urls.py
    |   ├── included_named_urls2.py
    |   ├── included_namespace_urls.py
    |   ├── included_no_kwargs_urls.py
    |   ├── included_urls.py
    |   ├── included_urls2.py
    |   ├── method_view_urls.py
    |   ├── middleware.py
    |   ├── named_urls.py
    |   ├── named_urls_conflict.py
    |   ├── namespace_urls.py
    |   ├── nested_urls.py
    |   ├── no_urls.py
    |   ├── nonimported_module.py
    |   ├── reverse_lazy_urls.py
    |   ├── test_localeregexdescriptor.py
    |   ├── tests.py
    |   ├── translations
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       ├── de
    |   |       └── fr
    |   ├── urlconf_inner.py
    |   ├── urlconf_outer.py
    |   ├── urls.py
    |   ├── urls_error_handlers.py
    |   ├── urls_error_handlers_callables.py
    |   ├── urls_without_handlers.py
    |   ├── utils.py
    |   ├── views.py
    |   └── views_broken.py
    ├── urls.py
    ├── user_commands
    |   ├── __init__.py
    |   ├── eggs
    |   ├── management
    |   |   └── commands
    |   |       ├── common_args.py
    |   |       ├── dance.py
    |   |       ├── hal.py
    |   |       ├── no_translations.py
    |   |       ├── required_option.py
    |   |       ├── reverse_url.py
    |   |       ├── set_option.py
    |   |       ├── subparser.py
    |   |       └── transaction.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── utils_tests
    |   ├── __init__.py
    |   ├── archives
    |   ├── eggs
    |   ├── files
    |   |   ├── strip_tags1.html
    |   |   └── strip_tags2.txt
    |   ├── models.py
    |   ├── test_archive.py
    |   ├── test_autoreload.py
    |   ├── test_baseconv.py
    |   ├── test_crypto.py
    |   ├── test_datastructures.py
    |   ├── test_dateformat.py
    |   ├── test_dateparse.py
    |   ├── test_datetime_safe.py
    |   ├── test_decorators.py
    |   ├── test_duration.py
    |   ├── test_encoding.py
    |   ├── test_encoding_deprecations.py
    |   ├── test_feedgenerator.py
    |   ├── test_functional.py
    |   ├── test_hashable.py
    |   ├── test_html.py
    |   ├── test_http.py
    |   ├── test_inspect.py
    |   ├── test_ipv6.py
    |   ├── test_jslex.py
    |   ├── test_lazyobject.py
    |   ├── test_lorem_ipsum.py
    |   ├── test_module
    |   |   ├── __init__.py
    |   |   ├── another_bad_module.py
    |   |   ├── another_good_module.py
    |   |   ├── bad_module.py
    |   |   ├── child_module
    |   |   |   ├── __init__.py
    |   |   |   └── grandchild_module.py
    |   |   └── good_module.py
    |   ├── test_module_loading.py
    |   ├── test_no_submodule.py
    |   ├── test_numberformat.py
    |   ├── test_os_utils.py
    |   ├── test_regex_helper.py
    |   ├── test_safestring.py
    |   ├── test_simplelazyobject.py
    |   ├── test_termcolors.py
    |   ├── test_text.py
    |   ├── test_timesince.py
    |   ├── test_timezone.py
    |   ├── test_topological_sort.py
    |   ├── test_tree.py
    |   └── utils.py
    ├── validation
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_custom_messages.py
    |   ├── test_error_messages.py
    |   ├── test_picklable.py
    |   ├── test_unique.py
    |   ├── test_validators.py
    |   └── tests.py
    ├── validators
    |   ├── __init__.py
    |   ├── invalid_urls.txt
    |   ├── tests.py
    |   └── valid_urls.txt
    ├── version
    |   ├── __init__.py
    |   └── tests.py
    ├── view_tests
    |   ├── __init__.py
    |   ├── app0
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── en
    |   ├── app1
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── app2
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── app3
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── es_AR
    |   ├── app4
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── es_AR
    |   ├── app5
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── default_urls.py
    |   ├── generic_urls.py
    |   ├── locale
    |   |   ├── de
    |   |   |   └── LC_MESSAGES
    |   |   ├── en_GB
    |   |   |   └── LC_MESSAGES
    |   |   ├── es
    |   |   |   └── LC_MESSAGES
    |   |   ├── fr
    |   |   |   └── LC_MESSAGES
    |   |   ├── nl
    |   |   |   └── LC_MESSAGES
    |   |   ├── pt
    |   |   |   └── LC_MESSAGES
    |   |   └── ru
    |   |       └── LC_MESSAGES
    |   ├── media
    |   |   ├── %2F.txt
    |   |   ├── file.txt
    |   |   ├── long-line.txt
    |   |   └── subdir
    |   ├── models.py
    |   ├── regression_21530_urls.py
    |   ├── templates
    |   |   ├── debug
    |   |   |   ├── template_error.html
    |   |   |   └── template_exception.html
    |   |   ├── jsi18n-multi-catalogs.html
    |   |   └── jsi18n.html
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: RenameContentType._rename() doesn't save the content type on the correct database

Description: Description
	
The commit in question:
​https://github.com/django/django/commit/f179113e6cbc8ba0a8d4e87e1d4410fb61d63e75
The specific lines in question:
​https://github.com/django/django/blob/586a9dc4295357de1f5ad0590ad34bf2bc008f79/django/contrib/contenttypes/management/__init__.py#L27
with transaction.atomic(using=db): 
	content_type.save(update_fields={'model'})
The issue:
For some background, we run a dynamic database router and have no "real" databases configured in the settings file, just a default sqlite3 backend which is never actually generated or used. We forked the migrate.py management command and modified it to accept a dictionary containing database connection parameters as the --database argument. 
The dynamic database router is based on, and very similar to this: ​https://github.com/ambitioninc/django-dynamic-db-router/blob/master/dynamic_db_router/router.py
This has worked beautifully for all migrations up until this point.
The issue we're running into is that when attempting to run a migration which contains a call to migrations.RenameModel, and while specifying the database parameters to the migrate command, the migration fails with an OperationalError, stating that no such table: django_content_types exists.
After having exhaustively stepped through the traceback, it appears that even though the content_type.save call is wrapped in the with transaction.atomic(using=db) context manager, the actual database operation is being attempted on the default database (which in our case does not exist) rather than the database specified via schema_editor.connection.alias (on line 15 of the same file) and thus fails loudly.
So, I believe that:
content_type.save(update_fields={'model'})
should be
content_type.save(using=db, update_fields={'model'})

Patch information:
diff --git a/django/contrib/contenttypes/management/__init__.py b/django/contrib/contenttypes/management/__init__.py
index 2b5f688136..563cba2fdf 100644
--- a/django/contrib/contenttypes/management/__init__.py
+++ b/django/contrib/contenttypes/management/__init__.py
@@ -24,7 +24,7 @@ class RenameContentType(migrations.RunPython):
             content_type.model = new_model
             try:
                 with transaction.atomic(using=db):
-                    content_type.save(update_fields={'model'})
+                    content_type.save(using=db, update_fields={'model'})
             except IntegrityError:
                 # Gracefully fallback if a stale content type causes a
                 # conflict as remove_stale_contenttypes will take care of


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.
Extra Requirements: 
Purpose: These files are essential to identify test cases that cover multi-database migrations, the `RenameModel` operation, and specific `contenttypes` operations, which are all directly related to the bug report.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: tests/contenttypes_tests/test_operations.py
Line number range: 1 - 66
Content:
1. from django.apps.registry import apps
2. from django.conf import settings
3. from django.contrib.contenttypes import management as contenttypes_management
4. from django.contrib.contenttypes.models import ContentType
5. from django.core.management import call_command
6. from django.db import migrations, models
7. from django.test import TransactionTestCase, override_settings
8. 
9. 
10. @override_settings(
11.     MIGRATION_MODULES=dict(
12.         settings.MIGRATION_MODULES,
13.         contenttypes_tests='contenttypes_tests.operations_migrations',
14.     ),
15. )
16. class ContentTypeOperationsTests(TransactionTestCase):
17.     available_apps = [
18.         'contenttypes_tests',
19.         'django.contrib.contenttypes',
20.     ]
21. 
22.     def setUp(self):
23.         app_config = apps.get_app_config('contenttypes_tests')
24.         models.signals.post_migrate.connect(self.assertOperationsInjected, sender=app_config)
25. 
26.     def tearDown(self):
27.         app_config = apps.get_app_config('contenttypes_tests')
28.         models.signals.post_migrate.disconnect(self.assertOperationsInjected, sender=app_config)
29. 
30.     def assertOperationsInjected(self, plan, **kwargs):
31.         for migration, _backward in plan:
32.             operations = iter(migration.operations)
33.             for operation in operations:
34.                 if isinstance(operation, migrations.RenameModel):
35.                     next_operation = next(operations)
36.                     self.assertIsInstance(next_operation, contenttypes_management.RenameContentType)
37.                     self.assertEqual(next_operation.app_label, migration.app_label)
38.                     self.assertEqual(next_operation.old_model, operation.old_name_lower)
39.                     self.assertEqual(next_operation.new_model, operation.new_name_lower)
40. 
41.     def test_existing_content_type_rename(self):
42.         ContentType.objects.create(app_label='contenttypes_tests', model='foo')
43.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0,)
44.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
45.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
46.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
47.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
48.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
49. 
50.     def test_missing_content_type_rename_ignore(self):
51.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0,)
52.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
53.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
54.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
55.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
56.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
57. 
58.     def test_content_type_rename_conflict(self):
59.         ContentType.objects.create(app_label='contenttypes_tests', model='foo')
60.         ContentType.objects.create(app_label='contenttypes_tests', model='renamedfoo')
61.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0)
62.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
63.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
64.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
65.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
66.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())


File: tests/migrations/test_multidb.py
Line number range: 1 - 171
Content:
1. from django.db import connection, migrations, models
2. from django.db.migrations.state import ProjectState
3. from django.test import override_settings
4. 
5. from .test_operations import OperationTestBase
6. 
7. 
8. class AgnosticRouter:
9.     """
10.     A router that doesn't have an opinion regarding migrating.
11.     """
12.     def allow_migrate(self, db, app_label, **hints):
13.         return None
14. 
15. 
16. class MigrateNothingRouter:
17.     """
18.     A router that doesn't allow migrating.
19.     """
20.     def allow_migrate(self, db, app_label, **hints):
21.         return False
22. 
23. 
24. class MigrateEverythingRouter:
25.     """
26.     A router that always allows migrating.
27.     """
28.     def allow_migrate(self, db, app_label, **hints):
29.         return True
30. 
31. 
32. class MigrateWhenFooRouter:
33.     """
34.     A router that allows migrating depending on a hint.
35.     """
36.     def allow_migrate(self, db, app_label, **hints):
37.         return hints.get('foo', False)
38. 
39. 
40. class MultiDBOperationTests(OperationTestBase):
41.     databases = {'default', 'other'}
42. 
43.     def _test_create_model(self, app_label, should_run):
44.         """
45.         CreateModel honors multi-db settings.
46.         """
47.         operation = migrations.CreateModel(
48.             "Pony",
49.             [("id", models.AutoField(primary_key=True))],
50.         )
51.         # Test the state alteration
52.         project_state = ProjectState()
53.         new_state = project_state.clone()
54.         operation.state_forwards(app_label, new_state)
55.         # Test the database alteration
56.         self.assertTableNotExists("%s_pony" % app_label)
57.         with connection.schema_editor() as editor:
58.             operation.database_forwards(app_label, editor, project_state, new_state)
59.         if should_run:
60.             self.assertTableExists("%s_pony" % app_label)
61.         else:
62.             self.assertTableNotExists("%s_pony" % app_label)
63.         # And test reversal
64.         with connection.schema_editor() as editor:
65.             operation.database_backwards(app_label, editor, new_state, project_state)
66.         self.assertTableNotExists("%s_pony" % app_label)
67. 
68.     @override_settings(DATABASE_ROUTERS=[AgnosticRouter()])
69.     def test_create_model(self):
70.         """
71.         Test when router doesn't have an opinion (i.e. CreateModel should run).
72.         """
73.         self._test_create_model("test_mltdb_crmo", should_run=True)
74. 
75.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
76.     def test_create_model2(self):
77.         """
78.         Test when router returns False (i.e. CreateModel shouldn't run).
79.         """
80.         self._test_create_model("test_mltdb_crmo2", should_run=False)
81. 
82.     @override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()])
83.     def test_create_model3(self):
84.         """
85.         Test when router returns True (i.e. CreateModel should run).
86.         """
87.         self._test_create_model("test_mltdb_crmo3", should_run=True)
88. 
89.     def test_create_model4(self):
90.         """
91.         Test multiple routers.
92.         """
93.         with override_settings(DATABASE_ROUTERS=[AgnosticRouter(), AgnosticRouter()]):
94.             self._test_create_model("test_mltdb_crmo4", should_run=True)
95.         with override_settings(DATABASE_ROUTERS=[MigrateNothingRouter(), MigrateEverythingRouter()]):
96.             self._test_create_model("test_mltdb_crmo4", should_run=False)
97.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter(), MigrateNothingRouter()]):
98.             self._test_create_model("test_mltdb_crmo4", should_run=True)
99. 
100.     def _test_run_sql(self, app_label, should_run, hints=None):
101.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):
102.             project_state = self.set_up_test_model(app_label)
103. 
104.         sql = """
105.         INSERT INTO {0}_pony (pink, weight) VALUES (1, 3.55);
106.         INSERT INTO {0}_pony (pink, weight) VALUES (3, 5.0);
107.         """.format(app_label)
108. 
109.         operation = migrations.RunSQL(sql, hints=hints or {})
110.         # Test the state alteration does nothing
111.         new_state = project_state.clone()
112.         operation.state_forwards(app_label, new_state)
113.         self.assertEqual(new_state, project_state)
114.         # Test the database alteration
115.         self.assertEqual(project_state.apps.get_model(app_label, "Pony").objects.count(), 0)
116.         with connection.schema_editor() as editor:
117.             operation.database_forwards(app_label, editor, project_state, new_state)
118.         Pony = project_state.apps.get_model(app_label, "Pony")
119.         if should_run:
120.             self.assertEqual(Pony.objects.count(), 2)
121.         else:
122.             self.assertEqual(Pony.objects.count(), 0)
123. 
124.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
125.     def test_run_sql_migrate_nothing_router(self):
126.         self._test_run_sql("test_mltdb_runsql", should_run=False)
127. 
128.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
129.     def test_run_sql_migrate_foo_router_without_hints(self):
130.         self._test_run_sql("test_mltdb_runsql2", should_run=False)
131. 
132.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
133.     def test_run_sql_migrate_foo_router_with_hints(self):
134.         self._test_run_sql('test_mltdb_runsql3', should_run=True, hints={'foo': True})
135. 
136.     def _test_run_python(self, app_label, should_run, hints=None):
137.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):
138.             project_state = self.set_up_test_model(app_label)
139. 
140.         # Create the operation
141.         def inner_method(models, schema_editor):
142.             Pony = models.get_model(app_label, "Pony")
143.             Pony.objects.create(pink=1, weight=3.55)
144.             Pony.objects.create(weight=5)
145. 
146.         operation = migrations.RunPython(inner_method, hints=hints or {})
147.         # Test the state alteration does nothing
148.         new_state = project_state.clone()
149.         operation.state_forwards(app_label, new_state)
150.         self.assertEqual(new_state, project_state)
151.         # Test the database alteration
152.         self.assertEqual(project_state.apps.get_model(app_label, "Pony").objects.count(), 0)
153.         with connection.schema_editor() as editor:
154.             operation.database_forwards(app_label, editor, project_state, new_state)
155.         Pony = project_state.apps.get_model(app_label, "Pony")
156.         if should_run:
157.             self.assertEqual(Pony.objects.count(), 2)
158.         else:
159.             self.assertEqual(Pony.objects.count(), 0)
160. 
161.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
162.     def test_run_python_migrate_nothing_router(self):
163.         self._test_run_python("test_mltdb_runpython", should_run=False)
164. 
165.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
166.     def test_run_python_migrate_foo_router_without_hints(self):
167.         self._test_run_python("test_mltdb_runpython2", should_run=False)
168. 
169.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
170.     def test_run_python_migrate_foo_router_with_hints(self):
171.         self._test_run_python('test_mltdb_runpython3', should_run=True, hints={'foo': True})


File: tests/migrations/test_operations.py
Line number range: 1 - 500
Content:
1. from django.core.exceptions import FieldDoesNotExist
2. from django.db import connection, migrations, models, transaction
3. from django.db.migrations.migration import Migration
4. from django.db.migrations.operations import CreateModel
5. from django.db.migrations.operations.fields import FieldOperation
6. from django.db.migrations.state import ModelState, ProjectState
7. from django.db.models.fields import NOT_PROVIDED
8. from django.db.transaction import atomic
9. from django.db.utils import IntegrityError
10. from django.test import SimpleTestCase, override_settings, skipUnlessDBFeature
11. 
12. from .models import FoodManager, FoodQuerySet, UnicodeModel
13. from .test_base import MigrationTestBase
14. 
15. 
16. class Mixin:
17.     pass
18. 
19. 
20. class OperationTestBase(MigrationTestBase):
21.     """
22.     Common functions to help test operations.
23.     """
24. 
25.     @classmethod
26.     def setUpClass(cls):
27.         super().setUpClass()
28.         cls._initial_table_names = frozenset(connection.introspection.table_names())
29. 
30.     def tearDown(self):
31.         self.cleanup_test_tables()
32.         super().tearDown()
33. 
34.     def cleanup_test_tables(self):
35.         table_names = frozenset(connection.introspection.table_names()) - self._initial_table_names
36.         with connection.schema_editor() as editor:
37.             with connection.constraint_checks_disabled():
38.                 for table_name in table_names:
39.                     editor.execute(editor.sql_delete_table % {
40.                         'table': editor.quote_name(table_name),
41.                     })
42. 
43.     def apply_operations(self, app_label, project_state, operations, atomic=True):
44.         migration = Migration('name', app_label)
45.         migration.operations = operations
46.         with connection.schema_editor(atomic=atomic) as editor:
47.             return migration.apply(project_state, editor)
48. 
49.     def unapply_operations(self, app_label, project_state, operations, atomic=True):
50.         migration = Migration('name', app_label)
51.         migration.operations = operations
52.         with connection.schema_editor(atomic=atomic) as editor:
53.             return migration.unapply(project_state, editor)
54. 
55.     def make_test_state(self, app_label, operation, **kwargs):
56.         """
57.         Makes a test state using set_up_test_model and returns the
58.         original state and the state after the migration is applied.
59.         """
60.         project_state = self.set_up_test_model(app_label, **kwargs)
61.         new_state = project_state.clone()
62.         operation.state_forwards(app_label, new_state)
63.         return project_state, new_state
64. 
65.     def set_up_test_model(
66.             self, app_label, second_model=False, third_model=False, index=False, multicol_index=False,
67.             related_model=False, mti_model=False, proxy_model=False, manager_model=False,
68.             unique_together=False, options=False, db_table=None, index_together=False, constraints=None):
69.         """
70.         Creates a test model state and database table.
71.         """
72.         # Make the "current" state
73.         model_options = {
74.             "swappable": "TEST_SWAP_MODEL",
75.             "index_together": [["weight", "pink"]] if index_together else [],
76.             "unique_together": [["pink", "weight"]] if unique_together else [],
77.         }
78.         if options:
79.             model_options["permissions"] = [("can_groom", "Can groom")]
80.         if db_table:
81.             model_options["db_table"] = db_table
82.         operations = [migrations.CreateModel(
83.             "Pony",
84.             [
85.                 ("id", models.AutoField(primary_key=True)),
86.                 ("pink", models.IntegerField(default=3)),
87.                 ("weight", models.FloatField()),
88.             ],
89.             options=model_options,
90.         )]
91.         if index:
92.             operations.append(migrations.AddIndex(
93.                 "Pony",
94.                 models.Index(fields=["pink"], name="pony_pink_idx")
95.             ))
96.         if multicol_index:
97.             operations.append(migrations.AddIndex(
98.                 "Pony",
99.                 models.Index(fields=["pink", "weight"], name="pony_test_idx")
100.             ))
101.         if constraints:
102.             for constraint in constraints:
103.                 operations.append(migrations.AddConstraint(
104.                     "Pony",
105.                     constraint,
106.                 ))
107.         if second_model:
108.             operations.append(migrations.CreateModel(
109.                 "Stable",
110.                 [
111.                     ("id", models.AutoField(primary_key=True)),
112.                 ]
113.             ))
114.         if third_model:
115.             operations.append(migrations.CreateModel(
116.                 "Van",
117.                 [
118.                     ("id", models.AutoField(primary_key=True)),
119.                 ]
120.             ))
121.         if related_model:
122.             operations.append(migrations.CreateModel(
123.                 "Rider",
124.                 [
125.                     ("id", models.AutoField(primary_key=True)),
126.                     ("pony", models.ForeignKey("Pony", models.CASCADE)),
127.                     ("friend", models.ForeignKey("self", models.CASCADE))
128.                 ],
129.             ))
130.         if mti_model:
131.             operations.append(migrations.CreateModel(
132.                 "ShetlandPony",
133.                 fields=[
134.                     ('pony_ptr', models.OneToOneField(
135.                         'Pony',
136.                         models.CASCADE,
137.                         auto_created=True,
138.                         parent_link=True,
139.                         primary_key=True,
140.                         to_field='id',
141.                         serialize=False,
142.                     )),
143.                     ("cuteness", models.IntegerField(default=1)),
144.                 ],
145.                 bases=['%s.Pony' % app_label],
146.             ))
147.         if proxy_model:
148.             operations.append(migrations.CreateModel(
149.                 "ProxyPony",
150.                 fields=[],
151.                 options={"proxy": True},
152.                 bases=['%s.Pony' % app_label],
153.             ))
154.         if manager_model:
155.             operations.append(migrations.CreateModel(
156.                 "Food",
157.                 fields=[
158.                     ("id", models.AutoField(primary_key=True)),
159.                 ],
160.                 managers=[
161.                     ("food_qs", FoodQuerySet.as_manager()),
162.                     ("food_mgr", FoodManager("a", "b")),
163.                     ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
164.                 ]
165.             ))
166. 
167.         return self.apply_operations(app_label, ProjectState(), operations)
168. 
169. 
170. class OperationTests(OperationTestBase):
171.     """
172.     Tests running the operations and making sure they do what they say they do.
173.     Each test looks at their state changing, and then their database operation -
174.     both forwards and backwards.
175.     """
176. 
177.     def test_create_model(self):
178.         """
179.         Tests the CreateModel operation.
180.         Most other tests use this operation as part of setup, so check failures here first.
181.         """
182.         operation = migrations.CreateModel(
183.             "Pony",
184.             [
185.                 ("id", models.AutoField(primary_key=True)),
186.                 ("pink", models.IntegerField(default=1)),
187.             ],
188.         )
189.         self.assertEqual(operation.describe(), "Create model Pony")
190.         # Test the state alteration
191.         project_state = ProjectState()
192.         new_state = project_state.clone()
193.         operation.state_forwards("test_crmo", new_state)
194.         self.assertEqual(new_state.models["test_crmo", "pony"].name, "Pony")
195.         self.assertEqual(len(new_state.models["test_crmo", "pony"].fields), 2)
196.         # Test the database alteration
197.         self.assertTableNotExists("test_crmo_pony")
198.         with connection.schema_editor() as editor:
199.             operation.database_forwards("test_crmo", editor, project_state, new_state)
200.         self.assertTableExists("test_crmo_pony")
201.         # And test reversal
202.         with connection.schema_editor() as editor:
203.             operation.database_backwards("test_crmo", editor, new_state, project_state)
204.         self.assertTableNotExists("test_crmo_pony")
205.         # And deconstruction
206.         definition = operation.deconstruct()
207.         self.assertEqual(definition[0], "CreateModel")
208.         self.assertEqual(definition[1], [])
209.         self.assertEqual(sorted(definition[2]), ["fields", "name"])
210.         # And default manager not in set
211.         operation = migrations.CreateModel("Foo", fields=[], managers=[("objects", models.Manager())])
212.         definition = operation.deconstruct()
213.         self.assertNotIn('managers', definition[2])
214. 
215.     def test_create_model_with_duplicate_field_name(self):
216.         with self.assertRaisesMessage(ValueError, 'Found duplicate value pink in CreateModel fields argument.'):
217.             migrations.CreateModel(
218.                 "Pony",
219.                 [
220.                     ("id", models.AutoField(primary_key=True)),
221.                     ("pink", models.TextField()),
222.                     ("pink", models.IntegerField(default=1)),
223.                 ],
224.             )
225. 
226.     def test_create_model_with_duplicate_base(self):
227.         message = 'Found duplicate value test_crmo.pony in CreateModel bases argument.'
228.         with self.assertRaisesMessage(ValueError, message):
229.             migrations.CreateModel(
230.                 "Pony",
231.                 fields=[],
232.                 bases=("test_crmo.Pony", "test_crmo.Pony",),
233.             )
234.         with self.assertRaisesMessage(ValueError, message):
235.             migrations.CreateModel(
236.                 "Pony",
237.                 fields=[],
238.                 bases=("test_crmo.Pony", "test_crmo.pony",),
239.             )
240.         message = 'Found duplicate value migrations.unicodemodel in CreateModel bases argument.'
241.         with self.assertRaisesMessage(ValueError, message):
242.             migrations.CreateModel(
243.                 "Pony",
244.                 fields=[],
245.                 bases=(UnicodeModel, UnicodeModel,),
246.             )
247.         with self.assertRaisesMessage(ValueError, message):
248.             migrations.CreateModel(
249.                 "Pony",
250.                 fields=[],
251.                 bases=(UnicodeModel, 'migrations.unicodemodel',),
252.             )
253.         with self.assertRaisesMessage(ValueError, message):
254.             migrations.CreateModel(
255.                 "Pony",
256.                 fields=[],
257.                 bases=(UnicodeModel, 'migrations.UnicodeModel',),
258.             )
259.         message = "Found duplicate value <class 'django.db.models.base.Model'> in CreateModel bases argument."
260.         with self.assertRaisesMessage(ValueError, message):
261.             migrations.CreateModel(
262.                 "Pony",
263.                 fields=[],
264.                 bases=(models.Model, models.Model,),
265.             )
266.         message = "Found duplicate value <class 'migrations.test_operations.Mixin'> in CreateModel bases argument."
267.         with self.assertRaisesMessage(ValueError, message):
268.             migrations.CreateModel(
269.                 "Pony",
270.                 fields=[],
271.                 bases=(Mixin, Mixin,),
272.             )
273. 
274.     def test_create_model_with_duplicate_manager_name(self):
275.         with self.assertRaisesMessage(ValueError, 'Found duplicate value objects in CreateModel managers argument.'):
276.             migrations.CreateModel(
277.                 "Pony",
278.                 fields=[],
279.                 managers=[
280.                     ("objects", models.Manager()),
281.                     ("objects", models.Manager()),
282.                 ],
283.             )
284. 
285.     def test_create_model_with_unique_after(self):
286.         """
287.         Tests the CreateModel operation directly followed by an
288.         AlterUniqueTogether (bug #22844 - sqlite remake issues)
289.         """
290.         operation1 = migrations.CreateModel(
291.             "Pony",
292.             [
293.                 ("id", models.AutoField(primary_key=True)),
294.                 ("pink", models.IntegerField(default=1)),
295.             ],
296.         )
297.         operation2 = migrations.CreateModel(
298.             "Rider",
299.             [
300.                 ("id", models.AutoField(primary_key=True)),
301.                 ("number", models.IntegerField(default=1)),
302.                 ("pony", models.ForeignKey("test_crmoua.Pony", models.CASCADE)),
303.             ],
304.         )
305.         operation3 = migrations.AlterUniqueTogether(
306.             "Rider",
307.             [
308.                 ("number", "pony"),
309.             ],
310.         )
311.         # Test the database alteration
312.         project_state = ProjectState()
313.         self.assertTableNotExists("test_crmoua_pony")
314.         self.assertTableNotExists("test_crmoua_rider")
315.         with connection.schema_editor() as editor:
316.             new_state = project_state.clone()
317.             operation1.state_forwards("test_crmoua", new_state)
318.             operation1.database_forwards("test_crmoua", editor, project_state, new_state)
319.             project_state, new_state = new_state, new_state.clone()
320.             operation2.state_forwards("test_crmoua", new_state)
321.             operation2.database_forwards("test_crmoua", editor, project_state, new_state)
322.             project_state, new_state = new_state, new_state.clone()
323.             operation3.state_forwards("test_crmoua", new_state)
324.             operation3.database_forwards("test_crmoua", editor, project_state, new_state)
325.         self.assertTableExists("test_crmoua_pony")
326.         self.assertTableExists("test_crmoua_rider")
327. 
328.     def test_create_model_m2m(self):
329.         """
330.         Test the creation of a model with a ManyToMany field and the
331.         auto-created "through" model.
332.         """
333.         project_state = self.set_up_test_model("test_crmomm")
334.         operation = migrations.CreateModel(
335.             "Stable",
336.             [
337.                 ("id", models.AutoField(primary_key=True)),
338.                 ("ponies", models.ManyToManyField("Pony", related_name="stables"))
339.             ]
340.         )
341.         # Test the state alteration
342.         new_state = project_state.clone()
343.         operation.state_forwards("test_crmomm", new_state)
344.         # Test the database alteration
345.         self.assertTableNotExists("test_crmomm_stable_ponies")
346.         with connection.schema_editor() as editor:
347.             operation.database_forwards("test_crmomm", editor, project_state, new_state)
348.         self.assertTableExists("test_crmomm_stable")
349.         self.assertTableExists("test_crmomm_stable_ponies")
350.         self.assertColumnNotExists("test_crmomm_stable", "ponies")
351.         # Make sure the M2M field actually works
352.         with atomic():
353.             Pony = new_state.apps.get_model("test_crmomm", "Pony")
354.             Stable = new_state.apps.get_model("test_crmomm", "Stable")
355.             stable = Stable.objects.create()
356.             p1 = Pony.objects.create(pink=False, weight=4.55)
357.             p2 = Pony.objects.create(pink=True, weight=5.43)
358.             stable.ponies.add(p1, p2)
359.             self.assertEqual(stable.ponies.count(), 2)
360.             stable.ponies.all().delete()
361.         # And test reversal
362.         with connection.schema_editor() as editor:
363.             operation.database_backwards("test_crmomm", editor, new_state, project_state)
364.         self.assertTableNotExists("test_crmomm_stable")
365.         self.assertTableNotExists("test_crmomm_stable_ponies")
366. 
367.     def test_create_model_inheritance(self):
368.         """
369.         Tests the CreateModel operation on a multi-table inheritance setup.
370.         """
371.         project_state = self.set_up_test_model("test_crmoih")
372.         # Test the state alteration
373.         operation = migrations.CreateModel(
374.             "ShetlandPony",
375.             [
376.                 ('pony_ptr', models.OneToOneField(
377.                     'test_crmoih.Pony',
378.                     models.CASCADE,
379.                     auto_created=True,
380.                     primary_key=True,
381.                     to_field='id',
382.                     serialize=False,
383.                 )),
384.                 ("cuteness", models.IntegerField(default=1)),
385.             ],
386.         )
387.         new_state = project_state.clone()
388.         operation.state_forwards("test_crmoih", new_state)
389.         self.assertIn(("test_crmoih", "shetlandpony"), new_state.models)
390.         # Test the database alteration
391.         self.assertTableNotExists("test_crmoih_shetlandpony")
392.         with connection.schema_editor() as editor:
393.             operation.database_forwards("test_crmoih", editor, project_state, new_state)
394.         self.assertTableExists("test_crmoih_shetlandpony")
395.         # And test reversal
396.         with connection.schema_editor() as editor:
397.             operation.database_backwards("test_crmoih", editor, new_state, project_state)
398.         self.assertTableNotExists("test_crmoih_shetlandpony")
399. 
400.     def test_create_proxy_model(self):
401.         """
402.         CreateModel ignores proxy models.
403.         """
404.         project_state = self.set_up_test_model("test_crprmo")
405.         # Test the state alteration
406.         operation = migrations.CreateModel(
407.             "ProxyPony",
408.             [],
409.             options={"proxy": True},
410.             bases=("test_crprmo.Pony",),
411.         )
412.         self.assertEqual(operation.describe(), "Create proxy model ProxyPony")
413.         new_state = project_state.clone()
414.         operation.state_forwards("test_crprmo", new_state)
415.         self.assertIn(("test_crprmo", "proxypony"), new_state.models)
416.         # Test the database alteration
417.         self.assertTableNotExists("test_crprmo_proxypony")
418.         self.assertTableExists("test_crprmo_pony")
419.         with connection.schema_editor() as editor:
420.             operation.database_forwards("test_crprmo", editor, project_state, new_state)
421.         self.assertTableNotExists("test_crprmo_proxypony")
422.         self.assertTableExists("test_crprmo_pony")
423.         # And test reversal
424.         with connection.schema_editor() as editor:
425.             operation.database_backwards("test_crprmo", editor, new_state, project_state)
426.         self.assertTableNotExists("test_crprmo_proxypony")
427.         self.assertTableExists("test_crprmo_pony")
428.         # And deconstruction
429.         definition = operation.deconstruct()
430.         self.assertEqual(definition[0], "CreateModel")
431.         self.assertEqual(definition[1], [])
432.         self.assertEqual(sorted(definition[2]), ["bases", "fields", "name", "options"])
433. 
434.     def test_create_unmanaged_model(self):
435.         """
436.         CreateModel ignores unmanaged models.
437.         """
438.         project_state = self.set_up_test_model("test_crummo")
439.         # Test the state alteration
440.         operation = migrations.CreateModel(
441.             "UnmanagedPony",
442.             [],
443.             options={"proxy": True},
444.             bases=("test_crummo.Pony",),
445.         )
446.         self.assertEqual(operation.describe(), "Create proxy model UnmanagedPony")
447.         new_state = project_state.clone()
448.         operation.state_forwards("test_crummo", new_state)
449.         self.assertIn(("test_crummo", "unmanagedpony"), new_state.models)
450.         # Test the database alteration
451.         self.assertTableNotExists("test_crummo_unmanagedpony")
452.         self.assertTableExists("test_crummo_pony")
453.         with connection.schema_editor() as editor:
454.             operation.database_forwards("test_crummo", editor, project_state, new_state)
455.         self.assertTableNotExists("test_crummo_unmanagedpony")
456.         self.assertTableExists("test_crummo_pony")
457.         # And test reversal
458.         with connection.schema_editor() as editor:
459.             operation.database_backwards("test_crummo", editor, new_state, project_state)
460.         self.assertTableNotExists("test_crummo_unmanagedpony")
461.         self.assertTableExists("test_crummo_pony")
462. 
463.     @skipUnlessDBFeature('supports_table_check_constraints')
464.     def test_create_model_with_constraint(self):
465.         where = models.Q(pink__gt=2)
466.         check_constraint = models.CheckConstraint(check=where, name='test_constraint_pony_pink_gt_2')
467.         operation = migrations.CreateModel(
468.             "Pony",
469.             [
470.                 ("id", models.AutoField(primary_key=True)),
471.                 ("pink", models.IntegerField(default=3)),
472.             ],
473.             options={'constraints': [check_constraint]},
474.         )
475. 
476.         # Test the state alteration
477.         project_state = ProjectState()
478.         new_state = project_state.clone()
479.         operation.state_forwards("test_crmo", new_state)
480.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
481. 
482.         # Test database alteration
483.         self.assertTableNotExists("test_crmo_pony")
484.         with connection.schema_editor() as editor:
485.             operation.database_forwards("test_crmo", editor, project_state, new_state)
486.         self.assertTableExists("test_crmo_pony")
487.         with connection.cursor() as cursor:
488.             with self.assertRaises(IntegrityError):
489.                 cursor.execute("INSERT INTO test_crmo_pony (id, pink) VALUES (1, 1)")
490. 
491.         # Test reversal
492.         with connection.schema_editor() as editor:
493.             operation.database_backwards("test_crmo", editor, new_state, project_state)
494.         self.assertTableNotExists("test_crmo_pony")
495. 
496.         # Test deconstruction
497.         definition = operation.deconstruct()
498.         self.assertEqual(definition[0], "CreateModel")
499.         self.assertEqual(definition[1], [])
500.         self.assertEqual(definition[2]['options']['constraints'], [check_constraint])


File: tests/migrations/test_operations.py
Line number range: 170 - 2865
Content:
170. class OperationTests(OperationTestBase):
171.     """
172.     Tests running the operations and making sure they do what they say they do.
173.     Each test looks at their state changing, and then their database operation -
174.     both forwards and backwards.
175.     """
176. 
177.     def test_create_model(self):
178.         """
179.         Tests the CreateModel operation.
180.         Most other tests use this operation as part of setup, so check failures here first.
181.         """
182.         operation = migrations.CreateModel(
183.             "Pony",
184.             [
185.                 ("id", models.AutoField(primary_key=True)),
186.                 ("pink", models.IntegerField(default=1)),
187.             ],
188.         )
189.         self.assertEqual(operation.describe(), "Create model Pony")
190.         # Test the state alteration
191.         project_state = ProjectState()
192.         new_state = project_state.clone()
193.         operation.state_forwards("test_crmo", new_state)
194.         self.assertEqual(new_state.models["test_crmo", "pony"].name, "Pony")
195.         self.assertEqual(len(new_state.models["test_crmo", "pony"].fields), 2)
196.         # Test the database alteration
197.         self.assertTableNotExists("test_crmo_pony")
198.         with connection.schema_editor() as editor:
199.             operation.database_forwards("test_crmo", editor, project_state, new_state)
200.         self.assertTableExists("test_crmo_pony")
201.         # And test reversal
202.         with connection.schema_editor() as editor:
203.             operation.database_backwards("test_crmo", editor, new_state, project_state)
204.         self.assertTableNotExists("test_crmo_pony")
205.         # And deconstruction
206.         definition = operation.deconstruct()
207.         self.assertEqual(definition[0], "CreateModel")
208.         self.assertEqual(definition[1], [])
209.         self.assertEqual(sorted(definition[2]), ["fields", "name"])
210.         # And default manager not in set
211.         operation = migrations.CreateModel("Foo", fields=[], managers=[("objects", models.Manager())])
212.         definition = operation.deconstruct()
213.         self.assertNotIn('managers', definition[2])
214. 
215.     def test_create_model_with_duplicate_field_name(self):
216.         with self.assertRaisesMessage(ValueError, 'Found duplicate value pink in CreateModel fields argument.'):
217.             migrations.CreateModel(
218.                 "Pony",
219.                 [
220.                     ("id", models.AutoField(primary_key=True)),
221.                     ("pink", models.TextField()),
222.                     ("pink", models.IntegerField(default=1)),
223.                 ],
224.             )
225. 
226.     def test_create_model_with_duplicate_base(self):
227.         message = 'Found duplicate value test_crmo.pony in CreateModel bases argument.'
228.         with self.assertRaisesMessage(ValueError, message):
229.             migrations.CreateModel(
230.                 "Pony",
231.                 fields=[],
232.                 bases=("test_crmo.Pony", "test_crmo.Pony",),
233.             )
234.         with self.assertRaisesMessage(ValueError, message):
235.             migrations.CreateModel(
236.                 "Pony",
237.                 fields=[],
238.                 bases=("test_crmo.Pony", "test_crmo.pony",),
239.             )
240.         message = 'Found duplicate value migrations.unicodemodel in CreateModel bases argument.'
241.         with self.assertRaisesMessage(ValueError, message):
242.             migrations.CreateModel(
243.                 "Pony",
244.                 fields=[],
245.                 bases=(UnicodeModel, UnicodeModel,),
246.             )
247.         with self.assertRaisesMessage(ValueError, message):
248.             migrations.CreateModel(
249.                 "Pony",
250.                 fields=[],
251.                 bases=(UnicodeModel, 'migrations.unicodemodel',),
252.             )
253.         with self.assertRaisesMessage(ValueError, message):
254.             migrations.CreateModel(
255.                 "Pony",
256.                 fields=[],
257.                 bases=(UnicodeModel, 'migrations.UnicodeModel',),
258.             )
259.         message = "Found duplicate value <class 'django.db.models.base.Model'> in CreateModel bases argument."
260.         with self.assertRaisesMessage(ValueError, message):
261.             migrations.CreateModel(
262.                 "Pony",
263.                 fields=[],
264.                 bases=(models.Model, models.Model,),
265.             )
266.         message = "Found duplicate value <class 'migrations.test_operations.Mixin'> in CreateModel bases argument."
267.         with self.assertRaisesMessage(ValueError, message):
268.             migrations.CreateModel(
269.                 "Pony",
270.                 fields=[],
271.                 bases=(Mixin, Mixin,),
272.             )
273. 
274.     def test_create_model_with_duplicate_manager_name(self):
275.         with self.assertRaisesMessage(ValueError, 'Found duplicate value objects in CreateModel managers argument.'):
276.             migrations.CreateModel(
277.                 "Pony",
278.                 fields=[],
279.                 managers=[
280.                     ("objects", models.Manager()),
281.                     ("objects", models.Manager()),
282.                 ],
283.             )
284. 
285.     def test_create_model_with_unique_after(self):
286.         """
287.         Tests the CreateModel operation directly followed by an
288.         AlterUniqueTogether (bug #22844 - sqlite remake issues)
289.         """
290.         operation1 = migrations.CreateModel(
291.             "Pony",
292.             [
293.                 ("id", models.AutoField(primary_key=True)),
294.                 ("pink", models.IntegerField(default=1)),
295.             ],
296.         )
297.         operation2 = migrations.CreateModel(
298.             "Rider",
299.             [
300.                 ("id", models.AutoField(primary_key=True)),
301.                 ("number", models.IntegerField(default=1)),
302.                 ("pony", models.ForeignKey("test_crmoua.Pony", models.CASCADE)),
303.             ],
304.         )
305.         operation3 = migrations.AlterUniqueTogether(
306.             "Rider",
307.             [
308.                 ("number", "pony"),
309.             ],
310.         )
311.         # Test the database alteration
312.         project_state = ProjectState()
313.         self.assertTableNotExists("test_crmoua_pony")
314.         self.assertTableNotExists("test_crmoua_rider")
315.         with connection.schema_editor() as editor:
316.             new_state = project_state.clone()
317.             operation1.state_forwards("test_crmoua", new_state)
318.             operation1.database_forwards("test_crmoua", editor, project_state, new_state)
319.             project_state, new_state = new_state, new_state.clone()
320.             operation2.state_forwards("test_crmoua", new_state)
321.             operation2.database_forwards("test_crmoua", editor, project_state, new_state)
322.             project_state, new_state = new_state, new_state.clone()
323.             operation3.state_forwards("test_crmoua", new_state)
324.             operation3.database_forwards("test_crmoua", editor, project_state, new_state)
325.         self.assertTableExists("test_crmoua_pony")
326.         self.assertTableExists("test_crmoua_rider")
327. 
328.     def test_create_model_m2m(self):
329.         """
330.         Test the creation of a model with a ManyToMany field and the
331.         auto-created "through" model.
332.         """
333.         project_state = self.set_up_test_model("test_crmomm")
334.         operation = migrations.CreateModel(
335.             "Stable",
336.             [
337.                 ("id", models.AutoField(primary_key=True)),
338.                 ("ponies", models.ManyToManyField("Pony", related_name="stables"))
339.             ]
340.         )
341.         # Test the state alteration
342.         new_state = project_state.clone()
343.         operation.state_forwards("test_crmomm", new_state)
344.         # Test the database alteration
345.         self.assertTableNotExists("test_crmomm_stable_ponies")
346.         with connection.schema_editor() as editor:
347.             operation.database_forwards("test_crmomm", editor, project_state, new_state)
348.         self.assertTableExists("test_crmomm_stable")
349.         self.assertTableExists("test_crmomm_stable_ponies")
350.         self.assertColumnNotExists("test_crmomm_stable", "ponies")
351.         # Make sure the M2M field actually works
352.         with atomic():
353.             Pony = new_state.apps.get_model("test_crmomm", "Pony")
354.             Stable = new_state.apps.get_model("test_crmomm", "Stable")
355.             stable = Stable.objects.create()
356.             p1 = Pony.objects.create(pink=False, weight=4.55)
357.             p2 = Pony.objects.create(pink=True, weight=5.43)
358.             stable.ponies.add(p1, p2)
359.             self.assertEqual(stable.ponies.count(), 2)
360.             stable.ponies.all().delete()
361.         # And test reversal
362.         with connection.schema_editor() as editor:
363.             operation.database_backwards("test_crmomm", editor, new_state, project_state)
364.         self.assertTableNotExists("test_crmomm_stable")
365.         self.assertTableNotExists("test_crmomm_stable_ponies")
366. 
367.     def test_create_model_inheritance(self):
368.         """
369.         Tests the CreateModel operation on a multi-table inheritance setup.
370.         """
371.         project_state = self.set_up_test_model("test_crmoih")
372.         # Test the state alteration
373.         operation = migrations.CreateModel(
374.             "ShetlandPony",
375.             [
376.                 ('pony_ptr', models.OneToOneField(
377.                     'test_crmoih.Pony',
378.                     models.CASCADE,
379.                     auto_created=True,
380.                     primary_key=True,
381.                     to_field='id',
382.                     serialize=False,
383.                 )),
384.                 ("cuteness", models.IntegerField(default=1)),
385.             ],
386.         )
387.         new_state = project_state.clone()
388.         operation.state_forwards("test_crmoih", new_state)
389.         self.assertIn(("test_crmoih", "shetlandpony"), new_state.models)
390.         # Test the database alteration
391.         self.assertTableNotExists("test_crmoih_shetlandpony")
392.         with connection.schema_editor() as editor:
393.             operation.database_forwards("test_crmoih", editor, project_state, new_state)
394.         self.assertTableExists("test_crmoih_shetlandpony")
395.         # And test reversal
396.         with connection.schema_editor() as editor:
397.             operation.database_backwards("test_crmoih", editor, new_state, project_state)
398.         self.assertTableNotExists("test_crmoih_shetlandpony")
399. 
400.     def test_create_proxy_model(self):
401.         """
402.         CreateModel ignores proxy models.
403.         """
404.         project_state = self.set_up_test_model("test_crprmo")
405.         # Test the state alteration
406.         operation = migrations.CreateModel(
407.             "ProxyPony",
408.             [],
409.             options={"proxy": True},
410.             bases=("test_crprmo.Pony",),
411.         )
412.         self.assertEqual(operation.describe(), "Create proxy model ProxyPony")
413.         new_state = project_state.clone()
414.         operation.state_forwards("test_crprmo", new_state)
415.         self.assertIn(("test_crprmo", "proxypony"), new_state.models)
416.         # Test the database alteration
417.         self.assertTableNotExists("test_crprmo_proxypony")
418.         self.assertTableExists("test_crprmo_pony")
419.         with connection.schema_editor() as editor:
420.             operation.database_forwards("test_crprmo", editor, project_state, new_state)
421.         self.assertTableNotExists("test_crprmo_proxypony")
422.         self.assertTableExists("test_crprmo_pony")
423.         # And test reversal
424.         with connection.schema_editor() as editor:
425.             operation.database_backwards("test_crprmo", editor, new_state, project_state)
426.         self.assertTableNotExists("test_crprmo_proxypony")
427.         self.assertTableExists("test_crprmo_pony")
428.         # And deconstruction
429.         definition = operation.deconstruct()
430.         self.assertEqual(definition[0], "CreateModel")
431.         self.assertEqual(definition[1], [])
432.         self.assertEqual(sorted(definition[2]), ["bases", "fields", "name", "options"])
433. 
434.     def test_create_unmanaged_model(self):
435.         """
436.         CreateModel ignores unmanaged models.
437.         """
438.         project_state = self.set_up_test_model("test_crummo")
439.         # Test the state alteration
440.         operation = migrations.CreateModel(
441.             "UnmanagedPony",
442.             [],
443.             options={"proxy": True},
444.             bases=("test_crummo.Pony",),
445.         )
446.         self.assertEqual(operation.describe(), "Create proxy model UnmanagedPony")
447.         new_state = project_state.clone()
448.         operation.state_forwards("test_crummo", new_state)
449.         self.assertIn(("test_crummo", "unmanagedpony"), new_state.models)
450.         # Test the database alteration
451.         self.assertTableNotExists("test_crummo_unmanagedpony")
452.         self.assertTableExists("test_crummo_pony")
453.         with connection.schema_editor() as editor:
454.             operation.database_forwards("test_crummo", editor, project_state, new_state)
455.         self.assertTableNotExists("test_crummo_unmanagedpony")
456.         self.assertTableExists("test_crummo_pony")
457.         # And test reversal
458.         with connection.schema_editor() as editor:
459.             operation.database_backwards("test_crummo", editor, new_state, project_state)
460.         self.assertTableNotExists("test_crummo_unmanagedpony")
461.         self.assertTableExists("test_crummo_pony")
462. 
463.     @skipUnlessDBFeature('supports_table_check_constraints')
464.     def test_create_model_with_constraint(self):
465.         where = models.Q(pink__gt=2)
466.         check_constraint = models.CheckConstraint(check=where, name='test_constraint_pony_pink_gt_2')
467.         operation = migrations.CreateModel(
468.             "Pony",
469.             [
470.                 ("id", models.AutoField(primary_key=True)),
471.                 ("pink", models.IntegerField(default=3)),
472.             ],
473.             options={'constraints': [check_constraint]},
474.         )
475. 
476.         # Test the state alteration
477.         project_state = ProjectState()
478.         new_state = project_state.clone()
479.         operation.state_forwards("test_crmo", new_state)
480.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
481. 
482.         # Test database alteration
483.         self.assertTableNotExists("test_crmo_pony")
484.         with connection.schema_editor() as editor:
485.             operation.database_forwards("test_crmo", editor, project_state, new_state)
486.         self.assertTableExists("test_crmo_pony")
487.         with connection.cursor() as cursor:
488.             with self.assertRaises(IntegrityError):
489.                 cursor.execute("INSERT INTO test_crmo_pony (id, pink) VALUES (1, 1)")
490. 
491.         # Test reversal
492.         with connection.schema_editor() as editor:
493.             operation.database_backwards("test_crmo", editor, new_state, project_state)
494.         self.assertTableNotExists("test_crmo_pony")
495. 
496.         # Test deconstruction
497.         definition = operation.deconstruct()
498.         self.assertEqual(definition[0], "CreateModel")
499.         self.assertEqual(definition[1], [])
500.         self.assertEqual(definition[2]['options']['constraints'], [check_constraint])
501. 
502.     def test_create_model_with_partial_unique_constraint(self):
503.         partial_unique_constraint = models.UniqueConstraint(
504.             fields=['pink'],
505.             condition=models.Q(weight__gt=5),
506.             name='test_constraint_pony_pink_for_weight_gt_5_uniq',
507.         )
508.         operation = migrations.CreateModel(
509.             'Pony',
510.             [
511.                 ('id', models.AutoField(primary_key=True)),
512.                 ('pink', models.IntegerField(default=3)),
513.                 ('weight', models.FloatField()),
514.             ],
515.             options={'constraints': [partial_unique_constraint]},
516.         )
517.         # Test the state alteration
518.         project_state = ProjectState()
519.         new_state = project_state.clone()
520.         operation.state_forwards('test_crmo', new_state)
521.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
522.         # Test database alteration
523.         self.assertTableNotExists('test_crmo_pony')
524.         with connection.schema_editor() as editor:
525.             operation.database_forwards('test_crmo', editor, project_state, new_state)
526.         self.assertTableExists('test_crmo_pony')
527.         # Test constraint works
528.         Pony = new_state.apps.get_model('test_crmo', 'Pony')
529.         Pony.objects.create(pink=1, weight=4.0)
530.         Pony.objects.create(pink=1, weight=4.0)
531.         Pony.objects.create(pink=1, weight=6.0)
532.         if connection.features.supports_partial_indexes:
533.             with self.assertRaises(IntegrityError):
534.                 Pony.objects.create(pink=1, weight=7.0)
535.         else:
536.             Pony.objects.create(pink=1, weight=7.0)
537.         # Test reversal
538.         with connection.schema_editor() as editor:
539.             operation.database_backwards('test_crmo', editor, new_state, project_state)
540.         self.assertTableNotExists('test_crmo_pony')
541.         # Test deconstruction
542.         definition = operation.deconstruct()
543.         self.assertEqual(definition[0], 'CreateModel')
544.         self.assertEqual(definition[1], [])
545.         self.assertEqual(definition[2]['options']['constraints'], [partial_unique_constraint])
546. 
547.     def test_create_model_managers(self):
548.         """
549.         The managers on a model are set.
550.         """
551.         project_state = self.set_up_test_model("test_cmoma")
552.         # Test the state alteration
553.         operation = migrations.CreateModel(
554.             "Food",
555.             fields=[
556.                 ("id", models.AutoField(primary_key=True)),
557.             ],
558.             managers=[
559.                 ("food_qs", FoodQuerySet.as_manager()),
560.                 ("food_mgr", FoodManager("a", "b")),
561.                 ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
562.             ]
563.         )
564.         self.assertEqual(operation.describe(), "Create model Food")
565.         new_state = project_state.clone()
566.         operation.state_forwards("test_cmoma", new_state)
567.         self.assertIn(("test_cmoma", "food"), new_state.models)
568.         managers = new_state.models["test_cmoma", "food"].managers
569.         self.assertEqual(managers[0][0], "food_qs")
570.         self.assertIsInstance(managers[0][1], models.Manager)
571.         self.assertEqual(managers[1][0], "food_mgr")
572.         self.assertIsInstance(managers[1][1], FoodManager)
573.         self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
574.         self.assertEqual(managers[2][0], "food_mgr_kwargs")
575.         self.assertIsInstance(managers[2][1], FoodManager)
576.         self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
577. 
578.     def test_delete_model(self):
579.         """
580.         Tests the DeleteModel operation.
581.         """
582.         project_state = self.set_up_test_model("test_dlmo")
583.         # Test the state alteration
584.         operation = migrations.DeleteModel("Pony")
585.         self.assertEqual(operation.describe(), "Delete model Pony")
586.         new_state = project_state.clone()
587.         operation.state_forwards("test_dlmo", new_state)
588.         self.assertNotIn(("test_dlmo", "pony"), new_state.models)
589.         # Test the database alteration
590.         self.assertTableExists("test_dlmo_pony")
591.         with connection.schema_editor() as editor:
592.             operation.database_forwards("test_dlmo", editor, project_state, new_state)
593.         self.assertTableNotExists("test_dlmo_pony")
594.         # And test reversal
595.         with connection.schema_editor() as editor:
596.             operation.database_backwards("test_dlmo", editor, new_state, project_state)
597.         self.assertTableExists("test_dlmo_pony")
598.         # And deconstruction
599.         definition = operation.deconstruct()
600.         self.assertEqual(definition[0], "DeleteModel")
601.         self.assertEqual(definition[1], [])
602.         self.assertEqual(list(definition[2]), ["name"])
603. 
604.     def test_delete_proxy_model(self):
605.         """
606.         Tests the DeleteModel operation ignores proxy models.
607.         """
608.         project_state = self.set_up_test_model("test_dlprmo", proxy_model=True)
609.         # Test the state alteration
610.         operation = migrations.DeleteModel("ProxyPony")
611.         new_state = project_state.clone()
612.         operation.state_forwards("test_dlprmo", new_state)
613.         self.assertIn(("test_dlprmo", "proxypony"), project_state.models)
614.         self.assertNotIn(("test_dlprmo", "proxypony"), new_state.models)
615.         # Test the database alteration
616.         self.assertTableExists("test_dlprmo_pony")
617.         self.assertTableNotExists("test_dlprmo_proxypony")
618.         with connection.schema_editor() as editor:
619.             operation.database_forwards("test_dlprmo", editor, project_state, new_state)
620.         self.assertTableExists("test_dlprmo_pony")
621.         self.assertTableNotExists("test_dlprmo_proxypony")
622.         # And test reversal
623.         with connection.schema_editor() as editor:
624.             operation.database_backwards("test_dlprmo", editor, new_state, project_state)
625.         self.assertTableExists("test_dlprmo_pony")
626.         self.assertTableNotExists("test_dlprmo_proxypony")
627. 
628.     def test_delete_mti_model(self):
629.         project_state = self.set_up_test_model('test_dlmtimo', mti_model=True)
630.         # Test the state alteration
631.         operation = migrations.DeleteModel('ShetlandPony')
632.         new_state = project_state.clone()
633.         operation.state_forwards('test_dlmtimo', new_state)
634.         self.assertIn(('test_dlmtimo', 'shetlandpony'), project_state.models)
635.         self.assertNotIn(('test_dlmtimo', 'shetlandpony'), new_state.models)
636.         # Test the database alteration
637.         self.assertTableExists('test_dlmtimo_pony')
638.         self.assertTableExists('test_dlmtimo_shetlandpony')
639.         self.assertColumnExists('test_dlmtimo_shetlandpony', 'pony_ptr_id')
640.         with connection.schema_editor() as editor:
641.             operation.database_forwards('test_dlmtimo', editor, project_state, new_state)
642.         self.assertTableExists('test_dlmtimo_pony')
643.         self.assertTableNotExists('test_dlmtimo_shetlandpony')
644.         # And test reversal
645.         with connection.schema_editor() as editor:
646.             operation.database_backwards('test_dlmtimo', editor, new_state, project_state)
647.         self.assertTableExists('test_dlmtimo_pony')
648.         self.assertTableExists('test_dlmtimo_shetlandpony')
649.         self.assertColumnExists('test_dlmtimo_shetlandpony', 'pony_ptr_id')
650. 
651.     def test_rename_model(self):
652.         """
653.         Tests the RenameModel operation.
654.         """
655.         project_state = self.set_up_test_model("test_rnmo", related_model=True)
656.         # Test the state alteration
657.         operation = migrations.RenameModel("Pony", "Horse")
658.         self.assertEqual(operation.describe(), "Rename model Pony to Horse")
659.         # Test initial state and database
660.         self.assertIn(("test_rnmo", "pony"), project_state.models)
661.         self.assertNotIn(("test_rnmo", "horse"), project_state.models)
662.         self.assertTableExists("test_rnmo_pony")
663.         self.assertTableNotExists("test_rnmo_horse")
664.         if connection.features.supports_foreign_keys:
665.             self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
666.             self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
667.         # Migrate forwards
668.         new_state = project_state.clone()
669.         atomic_rename = connection.features.supports_atomic_references_rename
670.         new_state = self.apply_operations("test_rnmo", new_state, [operation], atomic=atomic_rename)
671.         # Test new state and database
672.         self.assertNotIn(("test_rnmo", "pony"), new_state.models)
673.         self.assertIn(("test_rnmo", "horse"), new_state.models)
674.         # RenameModel also repoints all incoming FKs and M2Ms
675.         self.assertEqual("test_rnmo.Horse", new_state.models["test_rnmo", "rider"].fields[1][1].remote_field.model)
676.         self.assertTableNotExists("test_rnmo_pony")
677.         self.assertTableExists("test_rnmo_horse")
678.         if connection.features.supports_foreign_keys:
679.             self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
680.             self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
681.         # Migrate backwards
682.         original_state = self.unapply_operations("test_rnmo", project_state, [operation], atomic=atomic_rename)
683.         # Test original state and database
684.         self.assertIn(("test_rnmo", "pony"), original_state.models)
685.         self.assertNotIn(("test_rnmo", "horse"), original_state.models)
686.         self.assertEqual("Pony", original_state.models["test_rnmo", "rider"].fields[1][1].remote_field.model)
687.         self.assertTableExists("test_rnmo_pony")
688.         self.assertTableNotExists("test_rnmo_horse")
689.         if connection.features.supports_foreign_keys:
690.             self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
691.             self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
692.         # And deconstruction
693.         definition = operation.deconstruct()
694.         self.assertEqual(definition[0], "RenameModel")
695.         self.assertEqual(definition[1], [])
696.         self.assertEqual(definition[2], {'old_name': "Pony", 'new_name': "Horse"})
697. 
698.     def test_rename_model_state_forwards(self):
699.         """
700.         RenameModel operations shouldn't trigger the caching of rendered apps
701.         on state without prior apps.
702.         """
703.         state = ProjectState()
704.         state.add_model(ModelState('migrations', 'Foo', []))
705.         operation = migrations.RenameModel('Foo', 'Bar')
706.         operation.state_forwards('migrations', state)
707.         self.assertNotIn('apps', state.__dict__)
708.         self.assertNotIn(('migrations', 'foo'), state.models)
709.         self.assertIn(('migrations', 'bar'), state.models)
710.         # Now with apps cached.
711.         apps = state.apps
712.         operation = migrations.RenameModel('Bar', 'Foo')
713.         operation.state_forwards('migrations', state)
714.         self.assertIs(state.apps, apps)
715.         self.assertNotIn(('migrations', 'bar'), state.models)
716.         self.assertIn(('migrations', 'foo'), state.models)
717. 
718.     def test_rename_model_with_self_referential_fk(self):
719.         """
720.         Tests the RenameModel operation on model with self referential FK.
721.         """
722.         project_state = self.set_up_test_model("test_rmwsrf", related_model=True)
723.         # Test the state alteration
724.         operation = migrations.RenameModel("Rider", "HorseRider")
725.         self.assertEqual(operation.describe(), "Rename model Rider to HorseRider")
726.         new_state = project_state.clone()
727.         operation.state_forwards("test_rmwsrf", new_state)
728.         self.assertNotIn(("test_rmwsrf", "rider"), new_state.models)
729.         self.assertIn(("test_rmwsrf", "horserider"), new_state.models)
730.         # Remember, RenameModel also repoints all incoming FKs and M2Ms
731.         self.assertEqual(
732.             'self',
733.             new_state.models["test_rmwsrf", "horserider"].fields[2][1].remote_field.model
734.         )
735.         HorseRider = new_state.apps.get_model('test_rmwsrf', 'horserider')
736.         self.assertIs(HorseRider._meta.get_field('horserider').remote_field.model, HorseRider)
737.         # Test the database alteration
738.         self.assertTableExists("test_rmwsrf_rider")
739.         self.assertTableNotExists("test_rmwsrf_horserider")
740.         if connection.features.supports_foreign_keys:
741.             self.assertFKExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_rider", "id"))
742.             self.assertFKNotExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
743.         atomic_rename = connection.features.supports_atomic_references_rename
744.         with connection.schema_editor(atomic=atomic_rename) as editor:
745.             operation.database_forwards("test_rmwsrf", editor, project_state, new_state)
746.         self.assertTableNotExists("test_rmwsrf_rider")
747.         self.assertTableExists("test_rmwsrf_horserider")
748.         if connection.features.supports_foreign_keys:
749.             self.assertFKNotExists("test_rmwsrf_horserider", ["friend_id"], ("test_rmwsrf_rider", "id"))
750.             self.assertFKExists("test_rmwsrf_horserider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
751.         # And test reversal
752.         with connection.schema_editor(atomic=atomic_rename) as editor:
753.             operation.database_backwards("test_rmwsrf", editor, new_state, project_state)
754.         self.assertTableExists("test_rmwsrf_rider")
755.         self.assertTableNotExists("test_rmwsrf_horserider")
756.         if connection.features.supports_foreign_keys:
757.             self.assertFKExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_rider", "id"))
758.             self.assertFKNotExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
759. 
760.     def test_rename_model_with_superclass_fk(self):
761.         """
762.         Tests the RenameModel operation on a model which has a superclass that
763.         has a foreign key.
764.         """
765.         project_state = self.set_up_test_model("test_rmwsc", related_model=True, mti_model=True)
766.         # Test the state alteration
767.         operation = migrations.RenameModel("ShetlandPony", "LittleHorse")
768.         self.assertEqual(operation.describe(), "Rename model ShetlandPony to LittleHorse")
769.         new_state = project_state.clone()
770.         operation.state_forwards("test_rmwsc", new_state)
771.         self.assertNotIn(("test_rmwsc", "shetlandpony"), new_state.models)
772.         self.assertIn(("test_rmwsc", "littlehorse"), new_state.models)
773.         # RenameModel shouldn't repoint the superclass's relations, only local ones
774.         self.assertEqual(
775.             project_state.models["test_rmwsc", "rider"].fields[1][1].remote_field.model,
776.             new_state.models["test_rmwsc", "rider"].fields[1][1].remote_field.model
777.         )
778.         # Before running the migration we have a table for Shetland Pony, not Little Horse
779.         self.assertTableExists("test_rmwsc_shetlandpony")
780.         self.assertTableNotExists("test_rmwsc_littlehorse")
781.         if connection.features.supports_foreign_keys:
782.             # and the foreign key on rider points to pony, not shetland pony
783.             self.assertFKExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_pony", "id"))
784.             self.assertFKNotExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_shetlandpony", "id"))
785.         with connection.schema_editor(atomic=connection.features.supports_atomic_references_rename) as editor:
786.             operation.database_forwards("test_rmwsc", editor, project_state, new_state)
787.         # Now we have a little horse table, not shetland pony
788.         self.assertTableNotExists("test_rmwsc_shetlandpony")
789.         self.assertTableExists("test_rmwsc_littlehorse")
790.         if connection.features.supports_foreign_keys:
791.             # but the Foreign keys still point at pony, not little horse
792.             self.assertFKExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_pony", "id"))
793.             self.assertFKNotExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_littlehorse", "id"))
794. 
795.     def test_rename_model_with_self_referential_m2m(self):
796.         app_label = "test_rename_model_with_self_referential_m2m"
797. 
798.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
799.             migrations.CreateModel("ReflexivePony", fields=[
800.                 ("id", models.AutoField(primary_key=True)),
801.                 ("ponies", models.ManyToManyField("self")),
802.             ]),
803.         ])
804.         project_state = self.apply_operations(app_label, project_state, operations=[
805.             migrations.RenameModel("ReflexivePony", "ReflexivePony2"),
806.         ], atomic=connection.features.supports_atomic_references_rename)
807.         Pony = project_state.apps.get_model(app_label, "ReflexivePony2")
808.         pony = Pony.objects.create()
809.         pony.ponies.add(pony)
810. 
811.     def test_rename_model_with_m2m(self):
812.         app_label = "test_rename_model_with_m2m"
813.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
814.             migrations.CreateModel("Rider", fields=[
815.                 ("id", models.AutoField(primary_key=True)),
816.             ]),
817.             migrations.CreateModel("Pony", fields=[
818.                 ("id", models.AutoField(primary_key=True)),
819.                 ("riders", models.ManyToManyField("Rider")),
820.             ]),
821.         ])
822.         Pony = project_state.apps.get_model(app_label, "Pony")
823.         Rider = project_state.apps.get_model(app_label, "Rider")
824.         pony = Pony.objects.create()
825.         rider = Rider.objects.create()
826.         pony.riders.add(rider)
827. 
828.         project_state = self.apply_operations(app_label, project_state, operations=[
829.             migrations.RenameModel("Pony", "Pony2"),
830.         ], atomic=connection.features.supports_atomic_references_rename)
831.         Pony = project_state.apps.get_model(app_label, "Pony2")
832.         Rider = project_state.apps.get_model(app_label, "Rider")
833.         pony = Pony.objects.create()
834.         rider = Rider.objects.create()
835.         pony.riders.add(rider)
836.         self.assertEqual(Pony.objects.count(), 2)
837.         self.assertEqual(Rider.objects.count(), 2)
838.         self.assertEqual(Pony._meta.get_field('riders').remote_field.through.objects.count(), 2)
839. 
840.     def test_rename_m2m_target_model(self):
841.         app_label = "test_rename_m2m_target_model"
842.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
843.             migrations.CreateModel("Rider", fields=[
844.                 ("id", models.AutoField(primary_key=True)),
845.             ]),
846.             migrations.CreateModel("Pony", fields=[
847.                 ("id", models.AutoField(primary_key=True)),
848.                 ("riders", models.ManyToManyField("Rider")),
849.             ]),
850.         ])
851.         Pony = project_state.apps.get_model(app_label, "Pony")
852.         Rider = project_state.apps.get_model(app_label, "Rider")
853.         pony = Pony.objects.create()
854.         rider = Rider.objects.create()
855.         pony.riders.add(rider)
856. 
857.         project_state = self.apply_operations(app_label, project_state, operations=[
858.             migrations.RenameModel("Rider", "Rider2"),
859.         ], atomic=connection.features.supports_atomic_references_rename)
860.         Pony = project_state.apps.get_model(app_label, "Pony")
861.         Rider = project_state.apps.get_model(app_label, "Rider2")
862.         pony = Pony.objects.create()
863.         rider = Rider.objects.create()
864.         pony.riders.add(rider)
865.         self.assertEqual(Pony.objects.count(), 2)
866.         self.assertEqual(Rider.objects.count(), 2)
867.         self.assertEqual(Pony._meta.get_field('riders').remote_field.through.objects.count(), 2)
868. 
869.     def test_rename_m2m_through_model(self):
870.         app_label = "test_rename_through"
871.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
872.             migrations.CreateModel("Rider", fields=[
873.                 ("id", models.AutoField(primary_key=True)),
874.             ]),
875.             migrations.CreateModel("Pony", fields=[
876.                 ("id", models.AutoField(primary_key=True)),
877.             ]),
878.             migrations.CreateModel("PonyRider", fields=[
879.                 ("id", models.AutoField(primary_key=True)),
880.                 ("rider", models.ForeignKey("test_rename_through.Rider", models.CASCADE)),
881.                 ("pony", models.ForeignKey("test_rename_through.Pony", models.CASCADE)),
882.             ]),
883.             migrations.AddField(
884.                 "Pony",
885.                 "riders",
886.                 models.ManyToManyField("test_rename_through.Rider", through="test_rename_through.PonyRider"),
887.             ),
888.         ])
889.         Pony = project_state.apps.get_model(app_label, "Pony")
890.         Rider = project_state.apps.get_model(app_label, "Rider")
891.         PonyRider = project_state.apps.get_model(app_label, "PonyRider")
892.         pony = Pony.objects.create()
893.         rider = Rider.objects.create()
894.         PonyRider.objects.create(pony=pony, rider=rider)
895. 
896.         project_state = self.apply_operations(app_label, project_state, operations=[
897.             migrations.RenameModel("PonyRider", "PonyRider2"),
898.         ])
899.         Pony = project_state.apps.get_model(app_label, "Pony")
900.         Rider = project_state.apps.get_model(app_label, "Rider")
901.         PonyRider = project_state.apps.get_model(app_label, "PonyRider2")
902.         pony = Pony.objects.first()
903.         rider = Rider.objects.create()
904.         PonyRider.objects.create(pony=pony, rider=rider)
905.         self.assertEqual(Pony.objects.count(), 1)
906.         self.assertEqual(Rider.objects.count(), 2)
907.         self.assertEqual(PonyRider.objects.count(), 2)
908.         self.assertEqual(pony.riders.count(), 2)
909. 
910.     def test_rename_m2m_model_after_rename_field(self):
911.         """RenameModel renames a many-to-many column after a RenameField."""
912.         app_label = 'test_rename_multiple'
913.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
914.             migrations.CreateModel('Pony', fields=[
915.                 ('id', models.AutoField(primary_key=True)),
916.                 ('name', models.CharField(max_length=20)),
917.             ]),
918.             migrations.CreateModel('Rider', fields=[
919.                 ('id', models.AutoField(primary_key=True)),
920.                 ('pony', models.ForeignKey('test_rename_multiple.Pony', models.CASCADE)),
921.             ]),
922.             migrations.CreateModel('PonyRider', fields=[
923.                 ('id', models.AutoField(primary_key=True)),
924.                 ('riders', models.ManyToManyField('Rider')),
925.             ]),
926.             migrations.RenameField(model_name='pony', old_name='name', new_name='fancy_name'),
927.             migrations.RenameModel(old_name='Rider', new_name='Jockey'),
928.         ], atomic=connection.features.supports_atomic_references_rename)
929.         Pony = project_state.apps.get_model(app_label, 'Pony')
930.         Jockey = project_state.apps.get_model(app_label, 'Jockey')
931.         PonyRider = project_state.apps.get_model(app_label, 'PonyRider')
932.         # No "no such column" error means the column was renamed correctly.
933.         pony = Pony.objects.create(fancy_name='a good name')
934.         jockey = Jockey.objects.create(pony=pony)
935.         ponyrider = PonyRider.objects.create()
936.         ponyrider.riders.add(jockey)
937. 
938.     def test_add_field(self):
939.         """
940.         Tests the AddField operation.
941.         """
942.         # Test the state alteration
943.         operation = migrations.AddField(
944.             "Pony",
945.             "height",
946.             models.FloatField(null=True, default=5),
947.         )
948.         self.assertEqual(operation.describe(), "Add field height to Pony")
949.         project_state, new_state = self.make_test_state("test_adfl", operation)
950.         self.assertEqual(len(new_state.models["test_adfl", "pony"].fields), 4)
951.         field = [
952.             f for n, f in new_state.models["test_adfl", "pony"].fields
953.             if n == "height"
954.         ][0]
955.         self.assertEqual(field.default, 5)
956.         # Test the database alteration
957.         self.assertColumnNotExists("test_adfl_pony", "height")
958.         with connection.schema_editor() as editor:
959.             operation.database_forwards("test_adfl", editor, project_state, new_state)
960.         self.assertColumnExists("test_adfl_pony", "height")
961.         # And test reversal
962.         with connection.schema_editor() as editor:
963.             operation.database_backwards("test_adfl", editor, new_state, project_state)
964.         self.assertColumnNotExists("test_adfl_pony", "height")
965.         # And deconstruction
966.         definition = operation.deconstruct()
967.         self.assertEqual(definition[0], "AddField")
968.         self.assertEqual(definition[1], [])
969.         self.assertEqual(sorted(definition[2]), ["field", "model_name", "name"])
970. 
971.     def test_add_charfield(self):
972.         """
973.         Tests the AddField operation on TextField.
974.         """
975.         project_state = self.set_up_test_model("test_adchfl")
976. 
977.         Pony = project_state.apps.get_model("test_adchfl", "Pony")
978.         pony = Pony.objects.create(weight=42)
979. 
980.         new_state = self.apply_operations("test_adchfl", project_state, [
981.             migrations.AddField(
982.                 "Pony",
983.                 "text",
984.                 models.CharField(max_length=10, default="some text"),
985.             ),
986.             migrations.AddField(
987.                 "Pony",
988.                 "empty",
989.                 models.CharField(max_length=10, default=""),
990.             ),
991.             # If not properly quoted digits would be interpreted as an int.
992.             migrations.AddField(
993.                 "Pony",
994.                 "digits",
995.                 models.CharField(max_length=10, default="42"),
996.             ),
997.             # Manual quoting is fragile and could trip on quotes. Refs #xyz.
998.             migrations.AddField(
999.                 "Pony",
1000.                 "quotes",
1001.                 models.CharField(max_length=10, default='"\'"'),
1002.             ),
1003.         ])
1004. 
1005.         Pony = new_state.apps.get_model("test_adchfl", "Pony")
1006.         pony = Pony.objects.get(pk=pony.pk)
1007.         self.assertEqual(pony.text, "some text")
1008.         self.assertEqual(pony.empty, "")
1009.         self.assertEqual(pony.digits, "42")
1010.         self.assertEqual(pony.quotes, '"\'"')
1011. 
1012.     def test_add_textfield(self):
1013.         """
1014.         Tests the AddField operation on TextField.
1015.         """
1016.         project_state = self.set_up_test_model("test_adtxtfl")
1017. 
1018.         Pony = project_state.apps.get_model("test_adtxtfl", "Pony")
1019.         pony = Pony.objects.create(weight=42)
1020. 
1021.         new_state = self.apply_operations("test_adtxtfl", project_state, [
1022.             migrations.AddField(
1023.                 "Pony",
1024.                 "text",
1025.                 models.TextField(default="some text"),
1026.             ),
1027.             migrations.AddField(
1028.                 "Pony",
1029.                 "empty",
1030.                 models.TextField(default=""),
1031.             ),
1032.             # If not properly quoted digits would be interpreted as an int.
1033.             migrations.AddField(
1034.                 "Pony",
1035.                 "digits",
1036.                 models.TextField(default="42"),
1037.             ),
1038.             # Manual quoting is fragile and could trip on quotes. Refs #xyz.
1039.             migrations.AddField(
1040.                 "Pony",
1041.                 "quotes",
1042.                 models.TextField(default='"\'"'),
1043.             ),
1044.         ])
1045. 
1046.         Pony = new_state.apps.get_model("test_adtxtfl", "Pony")
1047.         pony = Pony.objects.get(pk=pony.pk)
1048.         self.assertEqual(pony.text, "some text")
1049.         self.assertEqual(pony.empty, "")
1050.         self.assertEqual(pony.digits, "42")
1051.         self.assertEqual(pony.quotes, '"\'"')
1052. 
1053.     def test_add_binaryfield(self):
1054.         """
1055.         Tests the AddField operation on TextField/BinaryField.
1056.         """
1057.         project_state = self.set_up_test_model("test_adbinfl")
1058. 
1059.         Pony = project_state.apps.get_model("test_adbinfl", "Pony")
1060.         pony = Pony.objects.create(weight=42)
1061. 
1062.         new_state = self.apply_operations("test_adbinfl", project_state, [
1063.             migrations.AddField(
1064.                 "Pony",
1065.                 "blob",
1066.                 models.BinaryField(default=b"some text"),
1067.             ),
1068.             migrations.AddField(
1069.                 "Pony",
1070.                 "empty",
1071.                 models.BinaryField(default=b""),
1072.             ),
1073.             # If not properly quoted digits would be interpreted as an int.
1074.             migrations.AddField(
1075.                 "Pony",
1076.                 "digits",
1077.                 models.BinaryField(default=b"42"),
1078.             ),
1079.             # Manual quoting is fragile and could trip on quotes. Refs #xyz.
1080.             migrations.AddField(
1081.                 "Pony",
1082.                 "quotes",
1083.                 models.BinaryField(default=b'"\'"'),
1084.             ),
1085.         ])
1086. 
1087.         Pony = new_state.apps.get_model("test_adbinfl", "Pony")
1088.         pony = Pony.objects.get(pk=pony.pk)
1089.         # SQLite returns buffer/memoryview, cast to bytes for checking.
1090.         self.assertEqual(bytes(pony.blob), b"some text")
1091.         self.assertEqual(bytes(pony.empty), b"")
1092.         self.assertEqual(bytes(pony.digits), b"42")
1093.         self.assertEqual(bytes(pony.quotes), b'"\'"')
1094. 
1095.     def test_column_name_quoting(self):
1096.         """
1097.         Column names that are SQL keywords shouldn't cause problems when used
1098.         in migrations (#22168).
1099.         """
1100.         project_state = self.set_up_test_model("test_regr22168")
1101.         operation = migrations.AddField(
1102.             "Pony",
1103.             "order",
1104.             models.IntegerField(default=0),
1105.         )
1106.         new_state = project_state.clone()
1107.         operation.state_forwards("test_regr22168", new_state)
1108.         with connection.schema_editor() as editor:
1109.             operation.database_forwards("test_regr22168", editor, project_state, new_state)
1110.         self.assertColumnExists("test_regr22168_pony", "order")
1111. 
1112.     def test_add_field_preserve_default(self):
1113.         """
1114.         Tests the AddField operation's state alteration
1115.         when preserve_default = False.
1116.         """
1117.         project_state = self.set_up_test_model("test_adflpd")
1118.         # Test the state alteration
1119.         operation = migrations.AddField(
1120.             "Pony",
1121.             "height",
1122.             models.FloatField(null=True, default=4),
1123.             preserve_default=False,
1124.         )
1125.         new_state = project_state.clone()
1126.         operation.state_forwards("test_adflpd", new_state)
1127.         self.assertEqual(len(new_state.models["test_adflpd", "pony"].fields), 4)
1128.         field = [
1129.             f for n, f in new_state.models["test_adflpd", "pony"].fields
1130.             if n == "height"
1131.         ][0]
1132.         self.assertEqual(field.default, NOT_PROVIDED)
1133.         # Test the database alteration
1134.         project_state.apps.get_model("test_adflpd", "pony").objects.create(
1135.             weight=4,
1136.         )
1137.         self.assertColumnNotExists("test_adflpd_pony", "height")
1138.         with connection.schema_editor() as editor:
1139.             operation.database_forwards("test_adflpd", editor, project_state, new_state)
1140.         self.assertColumnExists("test_adflpd_pony", "height")
1141.         # And deconstruction
1142.         definition = operation.deconstruct()
1143.         self.assertEqual(definition[0], "AddField")
1144.         self.assertEqual(definition[1], [])
1145.         self.assertEqual(sorted(definition[2]), ["field", "model_name", "name", "preserve_default"])
1146. 
1147.     def test_add_field_m2m(self):
1148.         """
1149.         Tests the AddField operation with a ManyToManyField.
1150.         """
1151.         project_state = self.set_up_test_model("test_adflmm", second_model=True)
1152.         # Test the state alteration
1153.         operation = migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
1154.         new_state = project_state.clone()
1155.         operation.state_forwards("test_adflmm", new_state)
1156.         self.assertEqual(len(new_state.models["test_adflmm", "pony"].fields), 4)
1157.         # Test the database alteration
1158.         self.assertTableNotExists("test_adflmm_pony_stables")
1159.         with connection.schema_editor() as editor:
1160.             operation.database_forwards("test_adflmm", editor, project_state, new_state)
1161.         self.assertTableExists("test_adflmm_pony_stables")
1162.         self.assertColumnNotExists("test_adflmm_pony", "stables")
1163.         # Make sure the M2M field actually works
1164.         with atomic():
1165.             Pony = new_state.apps.get_model("test_adflmm", "Pony")
1166.             p = Pony.objects.create(pink=False, weight=4.55)
1167.             p.stables.create()
1168.             self.assertEqual(p.stables.count(), 1)
1169.             p.stables.all().delete()
1170.         # And test reversal
1171.         with connection.schema_editor() as editor:
1172.             operation.database_backwards("test_adflmm", editor, new_state, project_state)
1173.         self.assertTableNotExists("test_adflmm_pony_stables")
1174. 
1175.     def test_alter_field_m2m(self):
1176.         project_state = self.set_up_test_model("test_alflmm", second_model=True)
1177. 
1178.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1179.             migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
1180.         ])
1181.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1182.         self.assertFalse(Pony._meta.get_field('stables').blank)
1183. 
1184.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1185.             migrations.AlterField(
1186.                 "Pony", "stables", models.ManyToManyField(to="Stable", related_name="ponies", blank=True)
1187.             )
1188.         ])
1189.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1190.         self.assertTrue(Pony._meta.get_field('stables').blank)
1191. 
1192.     def test_repoint_field_m2m(self):
1193.         project_state = self.set_up_test_model("test_alflmm", second_model=True, third_model=True)
1194. 
1195.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1196.             migrations.AddField("Pony", "places", models.ManyToManyField("Stable", related_name="ponies"))
1197.         ])
1198.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1199. 
1200.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1201.             migrations.AlterField("Pony", "places", models.ManyToManyField(to="Van", related_name="ponies"))
1202.         ])
1203. 
1204.         # Ensure the new field actually works
1205.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1206.         p = Pony.objects.create(pink=False, weight=4.55)
1207.         p.places.create()
1208.         self.assertEqual(p.places.count(), 1)
1209.         p.places.all().delete()
1210. 
1211.     def test_remove_field_m2m(self):
1212.         project_state = self.set_up_test_model("test_rmflmm", second_model=True)
1213. 
1214.         project_state = self.apply_operations("test_rmflmm", project_state, operations=[
1215.             migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
1216.         ])
1217.         self.assertTableExists("test_rmflmm_pony_stables")
1218. 
1219.         with_field_state = project_state.clone()
1220.         operations = [migrations.RemoveField("Pony", "stables")]
1221.         project_state = self.apply_operations("test_rmflmm", project_state, operations=operations)
1222.         self.assertTableNotExists("test_rmflmm_pony_stables")
1223. 
1224.         # And test reversal
1225.         self.unapply_operations("test_rmflmm", with_field_state, operations=operations)
1226.         self.assertTableExists("test_rmflmm_pony_stables")
1227. 
1228.     def test_remove_field_m2m_with_through(self):
1229.         project_state = self.set_up_test_model("test_rmflmmwt", second_model=True)
1230. 
1231.         self.assertTableNotExists("test_rmflmmwt_ponystables")
1232.         project_state = self.apply_operations("test_rmflmmwt", project_state, operations=[
1233.             migrations.CreateModel("PonyStables", fields=[
1234.                 ("pony", models.ForeignKey('test_rmflmmwt.Pony', models.CASCADE)),
1235.                 ("stable", models.ForeignKey('test_rmflmmwt.Stable', models.CASCADE)),
1236.             ]),
1237.             migrations.AddField(
1238.                 "Pony", "stables",
1239.                 models.ManyToManyField("Stable", related_name="ponies", through='test_rmflmmwt.PonyStables')
1240.             )
1241.         ])
1242.         self.assertTableExists("test_rmflmmwt_ponystables")
1243. 
1244.         operations = [migrations.RemoveField("Pony", "stables"), migrations.DeleteModel("PonyStables")]
1245.         self.apply_operations("test_rmflmmwt", project_state, operations=operations)
1246. 
1247.     def test_remove_field(self):
1248.         """
1249.         Tests the RemoveField operation.
1250.         """
1251.         project_state = self.set_up_test_model("test_rmfl")
1252.         # Test the state alteration
1253.         operation = migrations.RemoveField("Pony", "pink")
1254.         self.assertEqual(operation.describe(), "Remove field pink from Pony")
1255.         new_state = project_state.clone()
1256.         operation.state_forwards("test_rmfl", new_state)
1257.         self.assertEqual(len(new_state.models["test_rmfl", "pony"].fields), 2)
1258.         # Test the database alteration
1259.         self.assertColumnExists("test_rmfl_pony", "pink")
1260.         with connection.schema_editor() as editor:
1261.             operation.database_forwards("test_rmfl", editor, project_state, new_state)
1262.         self.assertColumnNotExists("test_rmfl_pony", "pink")
1263.         # And test reversal
1264.         with connection.schema_editor() as editor:
1265.             operation.database_backwards("test_rmfl", editor, new_state, project_state)
1266.         self.assertColumnExists("test_rmfl_pony", "pink")
1267.         # And deconstruction
1268.         definition = operation.deconstruct()
1269.         self.assertEqual(definition[0], "RemoveField")
1270.         self.assertEqual(definition[1], [])
1271.         self.assertEqual(definition[2], {'model_name': "Pony", 'name': 'pink'})
1272. 
1273.     def test_remove_fk(self):
1274.         """
1275.         Tests the RemoveField operation on a foreign key.
1276.         """
1277.         project_state = self.set_up_test_model("test_rfk", related_model=True)
1278.         self.assertColumnExists("test_rfk_rider", "pony_id")
1279.         operation = migrations.RemoveField("Rider", "pony")
1280. 
1281.         new_state = project_state.clone()
1282.         operation.state_forwards("test_rfk", new_state)
1283.         with connection.schema_editor() as editor:
1284.             operation.database_forwards("test_rfk", editor, project_state, new_state)
1285.         self.assertColumnNotExists("test_rfk_rider", "pony_id")
1286.         with connection.schema_editor() as editor:
1287.             operation.database_backwards("test_rfk", editor, new_state, project_state)
1288.         self.assertColumnExists("test_rfk_rider", "pony_id")
1289. 
1290.     def test_alter_model_table(self):
1291.         """
1292.         Tests the AlterModelTable operation.
1293.         """
1294.         project_state = self.set_up_test_model("test_almota")
1295.         # Test the state alteration
1296.         operation = migrations.AlterModelTable("Pony", "test_almota_pony_2")
1297.         self.assertEqual(operation.describe(), "Rename table for Pony to test_almota_pony_2")
1298.         new_state = project_state.clone()
1299.         operation.state_forwards("test_almota", new_state)
1300.         self.assertEqual(new_state.models["test_almota", "pony"].options["db_table"], "test_almota_pony_2")
1301.         # Test the database alteration
1302.         self.assertTableExists("test_almota_pony")
1303.         self.assertTableNotExists("test_almota_pony_2")
1304.         with connection.schema_editor() as editor:
1305.             operation.database_forwards("test_almota", editor, project_state, new_state)
1306.         self.assertTableNotExists("test_almota_pony")
1307.         self.assertTableExists("test_almota_pony_2")
1308.         # And test reversal
1309.         with connection.schema_editor() as editor:
1310.             operation.database_backwards("test_almota", editor, new_state, project_state)
1311.         self.assertTableExists("test_almota_pony")
1312.         self.assertTableNotExists("test_almota_pony_2")
1313.         # And deconstruction
1314.         definition = operation.deconstruct()
1315.         self.assertEqual(definition[0], "AlterModelTable")
1316.         self.assertEqual(definition[1], [])
1317.         self.assertEqual(definition[2], {'name': "Pony", 'table': "test_almota_pony_2"})
1318. 
1319.     def test_alter_model_table_none(self):
1320.         """
1321.         Tests the AlterModelTable operation if the table name is set to None.
1322.         """
1323.         operation = migrations.AlterModelTable("Pony", None)
1324.         self.assertEqual(operation.describe(), "Rename table for Pony to (default)")
1325. 
1326.     def test_alter_model_table_noop(self):
1327.         """
1328.         Tests the AlterModelTable operation if the table name is not changed.
1329.         """
1330.         project_state = self.set_up_test_model("test_almota")
1331.         # Test the state alteration
1332.         operation = migrations.AlterModelTable("Pony", "test_almota_pony")
1333.         new_state = project_state.clone()
1334.         operation.state_forwards("test_almota", new_state)
1335.         self.assertEqual(new_state.models["test_almota", "pony"].options["db_table"], "test_almota_pony")
1336.         # Test the database alteration
1337.         self.assertTableExists("test_almota_pony")
1338.         with connection.schema_editor() as editor:
1339.             operation.database_forwards("test_almota", editor, project_state, new_state)
1340.         self.assertTableExists("test_almota_pony")
1341.         # And test reversal
1342.         with connection.schema_editor() as editor:
1343.             operation.database_backwards("test_almota", editor, new_state, project_state)
1344.         self.assertTableExists("test_almota_pony")
1345. 
1346.     def test_alter_model_table_m2m(self):
1347.         """
1348.         AlterModelTable should rename auto-generated M2M tables.
1349.         """
1350.         app_label = "test_talflmltlm2m"
1351.         pony_db_table = 'pony_foo'
1352.         project_state = self.set_up_test_model(app_label, second_model=True, db_table=pony_db_table)
1353.         # Add the M2M field
1354.         first_state = project_state.clone()
1355.         operation = migrations.AddField("Pony", "stables", models.ManyToManyField("Stable"))
1356.         operation.state_forwards(app_label, first_state)
1357.         with connection.schema_editor() as editor:
1358.             operation.database_forwards(app_label, editor, project_state, first_state)
1359.         original_m2m_table = "%s_%s" % (pony_db_table, "stables")
1360.         new_m2m_table = "%s_%s" % (app_label, "pony_stables")
1361.         self.assertTableExists(original_m2m_table)
1362.         self.assertTableNotExists(new_m2m_table)
1363.         # Rename the Pony db_table which should also rename the m2m table.
1364.         second_state = first_state.clone()
1365.         operation = migrations.AlterModelTable(name='pony', table=None)
1366.         operation.state_forwards(app_label, second_state)
1367.         atomic_rename = connection.features.supports_atomic_references_rename
1368.         with connection.schema_editor(atomic=atomic_rename) as editor:
1369.             operation.database_forwards(app_label, editor, first_state, second_state)
1370.         self.assertTableExists(new_m2m_table)
1371.         self.assertTableNotExists(original_m2m_table)
1372.         # And test reversal
1373.         with connection.schema_editor(atomic=atomic_rename) as editor:
1374.             operation.database_backwards(app_label, editor, second_state, first_state)
1375.         self.assertTableExists(original_m2m_table)
1376.         self.assertTableNotExists(new_m2m_table)
1377. 
1378.     def test_alter_field(self):
1379.         """
1380.         Tests the AlterField operation.
1381.         """
1382.         project_state = self.set_up_test_model("test_alfl")
1383.         # Test the state alteration
1384.         operation = migrations.AlterField("Pony", "pink", models.IntegerField(null=True))
1385.         self.assertEqual(operation.describe(), "Alter field pink on Pony")
1386.         new_state = project_state.clone()
1387.         operation.state_forwards("test_alfl", new_state)
1388.         self.assertIs(project_state.models["test_alfl", "pony"].get_field_by_name("pink").null, False)
1389.         self.assertIs(new_state.models["test_alfl", "pony"].get_field_by_name("pink").null, True)
1390.         # Test the database alteration
1391.         self.assertColumnNotNull("test_alfl_pony", "pink")
1392.         with connection.schema_editor() as editor:
1393.             operation.database_forwards("test_alfl", editor, project_state, new_state)
1394.         self.assertColumnNull("test_alfl_pony", "pink")
1395.         # And test reversal
1396.         with connection.schema_editor() as editor:
1397.             operation.database_backwards("test_alfl", editor, new_state, project_state)
1398.         self.assertColumnNotNull("test_alfl_pony", "pink")
1399.         # And deconstruction
1400.         definition = operation.deconstruct()
1401.         self.assertEqual(definition[0], "AlterField")
1402.         self.assertEqual(definition[1], [])
1403.         self.assertEqual(sorted(definition[2]), ["field", "model_name", "name"])
1404. 
1405.     def test_alter_field_pk(self):
1406.         """
1407.         Tests the AlterField operation on primary keys (for things like PostgreSQL's SERIAL weirdness)
1408.         """
1409.         project_state = self.set_up_test_model("test_alflpk")
1410.         # Test the state alteration
1411.         operation = migrations.AlterField("Pony", "id", models.IntegerField(primary_key=True))
1412.         new_state = project_state.clone()
1413.         operation.state_forwards("test_alflpk", new_state)
1414.         self.assertIsInstance(project_state.models["test_alflpk", "pony"].get_field_by_name("id"), models.AutoField)
1415.         self.assertIsInstance(new_state.models["test_alflpk", "pony"].get_field_by_name("id"), models.IntegerField)
1416.         # Test the database alteration
1417.         with connection.schema_editor() as editor:
1418.             operation.database_forwards("test_alflpk", editor, project_state, new_state)
1419.         # And test reversal
1420.         with connection.schema_editor() as editor:
1421.             operation.database_backwards("test_alflpk", editor, new_state, project_state)
1422. 
1423.     @skipUnlessDBFeature('supports_foreign_keys')
1424.     def test_alter_field_pk_fk(self):
1425.         """
1426.         Tests the AlterField operation on primary keys changes any FKs pointing to it.
1427.         """
1428.         project_state = self.set_up_test_model("test_alflpkfk", related_model=True)
1429.         # Test the state alteration
1430.         operation = migrations.AlterField("Pony", "id", models.FloatField(primary_key=True))
1431.         new_state = project_state.clone()
1432.         operation.state_forwards("test_alflpkfk", new_state)
1433.         self.assertIsInstance(project_state.models["test_alflpkfk", "pony"].get_field_by_name("id"), models.AutoField)
1434.         self.assertIsInstance(new_state.models["test_alflpkfk", "pony"].get_field_by_name("id"), models.FloatField)
1435. 
1436.         def assertIdTypeEqualsFkType():
1437.             with connection.cursor() as cursor:
1438.                 id_type, id_null = [
1439.                     (c.type_code, c.null_ok)
1440.                     for c in connection.introspection.get_table_description(cursor, "test_alflpkfk_pony")
1441.                     if c.name == "id"
1442.                 ][0]
1443.                 fk_type, fk_null = [
1444.                     (c.type_code, c.null_ok)
1445.                     for c in connection.introspection.get_table_description(cursor, "test_alflpkfk_rider")
1446.                     if c.name == "pony_id"
1447.                 ][0]
1448.             self.assertEqual(id_type, fk_type)
1449.             self.assertEqual(id_null, fk_null)
1450. 
1451.         assertIdTypeEqualsFkType()
1452.         # Test the database alteration
1453.         with connection.schema_editor() as editor:
1454.             operation.database_forwards("test_alflpkfk", editor, project_state, new_state)
1455.         assertIdTypeEqualsFkType()
1456.         # And test reversal
1457.         with connection.schema_editor() as editor:
1458.             operation.database_backwards("test_alflpkfk", editor, new_state, project_state)
1459.         assertIdTypeEqualsFkType()
1460. 
1461.     def test_alter_field_reloads_state_on_fk_target_changes(self):
1462.         """
1463.         If AlterField doesn't reload state appropriately, the second AlterField
1464.         crashes on MySQL due to not dropping the PonyRider.pony foreign key
1465.         constraint before modifying the column.
1466.         """
1467.         app_label = 'alter_alter_field_reloads_state_on_fk_target_changes'
1468.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
1469.             migrations.CreateModel('Rider', fields=[
1470.                 ('id', models.CharField(primary_key=True, max_length=100)),
1471.             ]),
1472.             migrations.CreateModel('Pony', fields=[
1473.                 ('id', models.CharField(primary_key=True, max_length=100)),
1474.                 ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE)),
1475.             ]),
1476.             migrations.CreateModel('PonyRider', fields=[
1477.                 ('id', models.AutoField(primary_key=True)),
1478.                 ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE)),
1479.             ]),
1480.         ])
1481.         project_state = self.apply_operations(app_label, project_state, operations=[
1482.             migrations.AlterField('Rider', 'id', models.CharField(primary_key=True, max_length=99)),
1483.             migrations.AlterField('Pony', 'id', models.CharField(primary_key=True, max_length=99)),
1484.         ])
1485. 
1486.     def test_alter_field_reloads_state_on_fk_with_to_field_target_changes(self):
1487.         """
1488.         If AlterField doesn't reload state appropriately, the second AlterField
1489.         crashes on MySQL due to not dropping the PonyRider.pony foreign key
1490.         constraint before modifying the column.
1491.         """
1492.         app_label = 'alter_alter_field_reloads_state_on_fk_with_to_field_target_changes'
1493.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
1494.             migrations.CreateModel('Rider', fields=[
1495.                 ('id', models.CharField(primary_key=True, max_length=100)),
1496.                 ('slug', models.CharField(unique=True, max_length=100)),
1497.             ]),
1498.             migrations.CreateModel('Pony', fields=[
1499.                 ('id', models.CharField(primary_key=True, max_length=100)),
1500.                 ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE, to_field='slug')),
1501.                 ('slug', models.CharField(unique=True, max_length=100)),
1502.             ]),
1503.             migrations.CreateModel('PonyRider', fields=[
1504.                 ('id', models.AutoField(primary_key=True)),
1505.                 ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE, to_field='slug')),
1506.             ]),
1507.         ])
1508.         project_state = self.apply_operations(app_label, project_state, operations=[
1509.             migrations.AlterField('Rider', 'slug', models.CharField(unique=True, max_length=99)),
1510.             migrations.AlterField('Pony', 'slug', models.CharField(unique=True, max_length=99)),
1511.         ])
1512. 
1513.     def test_rename_field_reloads_state_on_fk_target_changes(self):
1514.         """
1515.         If RenameField doesn't reload state appropriately, the AlterField
1516.         crashes on MySQL due to not dropping the PonyRider.pony foreign key
1517.         constraint before modifying the column.
1518.         """
1519.         app_label = 'alter_rename_field_reloads_state_on_fk_target_changes'
1520.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
1521.             migrations.CreateModel('Rider', fields=[
1522.                 ('id', models.CharField(primary_key=True, max_length=100)),
1523.             ]),
1524.             migrations.CreateModel('Pony', fields=[
1525.                 ('id', models.CharField(primary_key=True, max_length=100)),
1526.                 ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE)),
1527.             ]),
1528.             migrations.CreateModel('PonyRider', fields=[
1529.                 ('id', models.AutoField(primary_key=True)),
1530.                 ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE)),
1531.             ]),
1532.         ])
1533.         project_state = self.apply_operations(app_label, project_state, operations=[
1534.             migrations.RenameField('Rider', 'id', 'id2'),
1535.             migrations.AlterField('Pony', 'id', models.CharField(primary_key=True, max_length=99)),
1536.         ], atomic=connection.features.supports_atomic_references_rename)
1537. 
1538.     def test_rename_field(self):
1539.         """
1540.         Tests the RenameField operation.
1541.         """
1542.         project_state = self.set_up_test_model("test_rnfl", unique_together=True, index_together=True)
1543.         # Test the state alteration
1544.         operation = migrations.RenameField("Pony", "pink", "blue")
1545.         self.assertEqual(operation.describe(), "Rename field pink on Pony to blue")
1546.         new_state = project_state.clone()
1547.         operation.state_forwards("test_rnfl", new_state)
1548.         self.assertIn("blue", [n for n, f in new_state.models["test_rnfl", "pony"].fields])
1549.         self.assertNotIn("pink", [n for n, f in new_state.models["test_rnfl", "pony"].fields])
1550.         # Make sure the unique_together has the renamed column too
1551.         self.assertIn("blue", new_state.models["test_rnfl", "pony"].options['unique_together'][0])
1552.         self.assertNotIn("pink", new_state.models["test_rnfl", "pony"].options['unique_together'][0])
1553.         # Make sure the index_together has the renamed column too
1554.         self.assertIn("blue", new_state.models["test_rnfl", "pony"].options['index_together'][0])
1555.         self.assertNotIn("pink", new_state.models["test_rnfl", "pony"].options['index_together'][0])
1556.         # Test the database alteration
1557.         self.assertColumnExists("test_rnfl_pony", "pink")
1558.         self.assertColumnNotExists("test_rnfl_pony", "blue")
1559.         with connection.schema_editor() as editor:
1560.             operation.database_forwards("test_rnfl", editor, project_state, new_state)
1561.         self.assertColumnExists("test_rnfl_pony", "blue")
1562.         self.assertColumnNotExists("test_rnfl_pony", "pink")
1563.         # Ensure the unique constraint has been ported over
1564.         with connection.cursor() as cursor:
1565.             cursor.execute("INSERT INTO test_rnfl_pony (blue, weight) VALUES (1, 1)")
1566.             with self.assertRaises(IntegrityError):
1567.                 with atomic():
1568.                     cursor.execute("INSERT INTO test_rnfl_pony (blue, weight) VALUES (1, 1)")
1569.             cursor.execute("DELETE FROM test_rnfl_pony")
1570.         # Ensure the index constraint has been ported over
1571.         self.assertIndexExists("test_rnfl_pony", ["weight", "blue"])
1572.         # And test reversal
1573.         with connection.schema_editor() as editor:
1574.             operation.database_backwards("test_rnfl", editor, new_state, project_state)
1575.         self.assertColumnExists("test_rnfl_pony", "pink")
1576.         self.assertColumnNotExists("test_rnfl_pony", "blue")
1577.         # Ensure the index constraint has been reset
1578.         self.assertIndexExists("test_rnfl_pony", ["weight", "pink"])
1579.         # And deconstruction
1580.         definition = operation.deconstruct()
1581.         self.assertEqual(definition[0], "RenameField")
1582.         self.assertEqual(definition[1], [])
1583.         self.assertEqual(definition[2], {'model_name': "Pony", 'old_name': "pink", 'new_name': "blue"})
1584. 
1585.     def test_rename_missing_field(self):
1586.         state = ProjectState()
1587.         state.add_model(ModelState('app', 'model', []))
1588.         with self.assertRaisesMessage(FieldDoesNotExist, "app.model has no field named 'field'"):
1589.             migrations.RenameField('model', 'field', 'new_field').state_forwards('app', state)
1590. 
1591.     def test_rename_referenced_field_state_forward(self):
1592.         state = ProjectState()
1593.         state.add_model(ModelState('app', 'Model', [
1594.             ('id', models.AutoField(primary_key=True)),
1595.             ('field', models.IntegerField(unique=True)),
1596.         ]))
1597.         state.add_model(ModelState('app', 'OtherModel', [
1598.             ('id', models.AutoField(primary_key=True)),
1599.             ('fk', models.ForeignKey('Model', models.CASCADE, to_field='field')),
1600.             ('fo', models.ForeignObject('Model', models.CASCADE, from_fields=('fk',), to_fields=('field',))),
1601.         ]))
1602.         operation = migrations.RenameField('Model', 'field', 'renamed')
1603.         new_state = state.clone()
1604.         operation.state_forwards('app', new_state)
1605.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].remote_field.field_name, 'renamed')
1606.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].from_fields, ['self'])
1607.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].to_fields, ('renamed',))
1608.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].from_fields, ('fk',))
1609.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].to_fields, ('renamed',))
1610.         operation = migrations.RenameField('OtherModel', 'fk', 'renamed_fk')
1611.         new_state = state.clone()
1612.         operation.state_forwards('app', new_state)
1613.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].remote_field.field_name, 'renamed')
1614.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].from_fields, ('self',))
1615.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].to_fields, ('renamed',))
1616.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].from_fields, ('renamed_fk',))
1617.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].to_fields, ('renamed',))
1618. 
1619.     def test_alter_unique_together(self):
1620.         """
1621.         Tests the AlterUniqueTogether operation.
1622.         """
1623.         project_state = self.set_up_test_model("test_alunto")
1624.         # Test the state alteration
1625.         operation = migrations.AlterUniqueTogether("Pony", [("pink", "weight")])
1626.         self.assertEqual(operation.describe(), "Alter unique_together for Pony (1 constraint(s))")
1627.         new_state = project_state.clone()
1628.         operation.state_forwards("test_alunto", new_state)
1629.         self.assertEqual(len(project_state.models["test_alunto", "pony"].options.get("unique_together", set())), 0)
1630.         self.assertEqual(len(new_state.models["test_alunto", "pony"].options.get("unique_together", set())), 1)
1631.         # Make sure we can insert duplicate rows
1632.         with connection.cursor() as cursor:
1633.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1634.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1635.             cursor.execute("DELETE FROM test_alunto_pony")
1636.             # Test the database alteration
1637.             with connection.schema_editor() as editor:
1638.                 operation.database_forwards("test_alunto", editor, project_state, new_state)
1639.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1640.             with self.assertRaises(IntegrityError):
1641.                 with atomic():
1642.                     cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1643.             cursor.execute("DELETE FROM test_alunto_pony")
1644.             # And test reversal
1645.             with connection.schema_editor() as editor:
1646.                 operation.database_backwards("test_alunto", editor, new_state, project_state)
1647.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1648.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1649.             cursor.execute("DELETE FROM test_alunto_pony")
1650.         # Test flat unique_together
1651.         operation = migrations.AlterUniqueTogether("Pony", ("pink", "weight"))
1652.         operation.state_forwards("test_alunto", new_state)
1653.         self.assertEqual(len(new_state.models["test_alunto", "pony"].options.get("unique_together", set())), 1)
1654.         # And deconstruction
1655.         definition = operation.deconstruct()
1656.         self.assertEqual(definition[0], "AlterUniqueTogether")
1657.         self.assertEqual(definition[1], [])
1658.         self.assertEqual(definition[2], {'name': "Pony", 'unique_together': {("pink", "weight")}})
1659. 
1660.     def test_alter_unique_together_remove(self):
1661.         operation = migrations.AlterUniqueTogether("Pony", None)
1662.         self.assertEqual(operation.describe(), "Alter unique_together for Pony (0 constraint(s))")
1663. 
1664.     def test_add_index(self):
1665.         """
1666.         Test the AddIndex operation.
1667.         """
1668.         project_state = self.set_up_test_model("test_adin")
1669.         msg = (
1670.             "Indexes passed to AddIndex operations require a name argument. "
1671.             "<Index: fields='pink'> doesn't have one."
1672.         )
1673.         with self.assertRaisesMessage(ValueError, msg):
1674.             migrations.AddIndex("Pony", models.Index(fields=["pink"]))
1675.         index = models.Index(fields=["pink"], name="test_adin_pony_pink_idx")
1676.         operation = migrations.AddIndex("Pony", index)
1677.         self.assertEqual(operation.describe(), "Create index test_adin_pony_pink_idx on field(s) pink of model Pony")
1678.         new_state = project_state.clone()
1679.         operation.state_forwards("test_adin", new_state)
1680.         # Test the database alteration
1681.         self.assertEqual(len(new_state.models["test_adin", "pony"].options['indexes']), 1)
1682.         self.assertIndexNotExists("test_adin_pony", ["pink"])
1683.         with connection.schema_editor() as editor:
1684.             operation.database_forwards("test_adin", editor, project_state, new_state)
1685.         self.assertIndexExists("test_adin_pony", ["pink"])
1686.         # And test reversal
1687.         with connection.schema_editor() as editor:
1688.             operation.database_backwards("test_adin", editor, new_state, project_state)
1689.         self.assertIndexNotExists("test_adin_pony", ["pink"])
1690.         # And deconstruction
1691.         definition = operation.deconstruct()
1692.         self.assertEqual(definition[0], "AddIndex")
1693.         self.assertEqual(definition[1], [])
1694.         self.assertEqual(definition[2], {'model_name': "Pony", 'index': index})
1695. 
1696.     def test_remove_index(self):
1697.         """
1698.         Test the RemoveIndex operation.
1699.         """
1700.         project_state = self.set_up_test_model("test_rmin", multicol_index=True)
1701.         self.assertTableExists("test_rmin_pony")
1702.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1703.         operation = migrations.RemoveIndex("Pony", "pony_test_idx")
1704.         self.assertEqual(operation.describe(), "Remove index pony_test_idx from Pony")
1705.         new_state = project_state.clone()
1706.         operation.state_forwards("test_rmin", new_state)
1707.         # Test the state alteration
1708.         self.assertEqual(len(new_state.models["test_rmin", "pony"].options['indexes']), 0)
1709.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1710.         # Test the database alteration
1711.         with connection.schema_editor() as editor:
1712.             operation.database_forwards("test_rmin", editor, project_state, new_state)
1713.         self.assertIndexNotExists("test_rmin_pony", ["pink", "weight"])
1714.         # And test reversal
1715.         with connection.schema_editor() as editor:
1716.             operation.database_backwards("test_rmin", editor, new_state, project_state)
1717.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1718.         # And deconstruction
1719.         definition = operation.deconstruct()
1720.         self.assertEqual(definition[0], "RemoveIndex")
1721.         self.assertEqual(definition[1], [])
1722.         self.assertEqual(definition[2], {'model_name': "Pony", 'name': "pony_test_idx"})
1723. 
1724.         # Also test a field dropped with index - sqlite remake issue
1725.         operations = [
1726.             migrations.RemoveIndex("Pony", "pony_test_idx"),
1727.             migrations.RemoveField("Pony", "pink"),
1728.         ]
1729.         self.assertColumnExists("test_rmin_pony", "pink")
1730.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1731.         # Test database alteration
1732.         new_state = project_state.clone()
1733.         self.apply_operations('test_rmin', new_state, operations=operations)
1734.         self.assertColumnNotExists("test_rmin_pony", "pink")
1735.         self.assertIndexNotExists("test_rmin_pony", ["pink", "weight"])
1736.         # And test reversal
1737.         self.unapply_operations("test_rmin", project_state, operations=operations)
1738.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1739. 
1740.     def test_add_index_state_forwards(self):
1741.         project_state = self.set_up_test_model('test_adinsf')
1742.         index = models.Index(fields=['pink'], name='test_adinsf_pony_pink_idx')
1743.         old_model = project_state.apps.get_model('test_adinsf', 'Pony')
1744.         new_state = project_state.clone()
1745. 
1746.         operation = migrations.AddIndex('Pony', index)
1747.         operation.state_forwards('test_adinsf', new_state)
1748.         new_model = new_state.apps.get_model('test_adinsf', 'Pony')
1749.         self.assertIsNot(old_model, new_model)
1750. 
1751.     def test_remove_index_state_forwards(self):
1752.         project_state = self.set_up_test_model('test_rminsf')
1753.         index = models.Index(fields=['pink'], name='test_rminsf_pony_pink_idx')
1754.         migrations.AddIndex('Pony', index).state_forwards('test_rminsf', project_state)
1755.         old_model = project_state.apps.get_model('test_rminsf', 'Pony')
1756.         new_state = project_state.clone()
1757. 
1758.         operation = migrations.RemoveIndex('Pony', 'test_rminsf_pony_pink_idx')
1759.         operation.state_forwards('test_rminsf', new_state)
1760.         new_model = new_state.apps.get_model('test_rminsf', 'Pony')
1761.         self.assertIsNot(old_model, new_model)
1762. 
1763.     def test_alter_field_with_index(self):
1764.         """
1765.         Test AlterField operation with an index to ensure indexes created via
1766.         Meta.indexes don't get dropped with sqlite3 remake.
1767.         """
1768.         project_state = self.set_up_test_model("test_alflin", index=True)
1769.         operation = migrations.AlterField("Pony", "pink", models.IntegerField(null=True))
1770.         new_state = project_state.clone()
1771.         operation.state_forwards("test_alflin", new_state)
1772.         # Test the database alteration
1773.         self.assertColumnNotNull("test_alflin_pony", "pink")
1774.         with connection.schema_editor() as editor:
1775.             operation.database_forwards("test_alflin", editor, project_state, new_state)
1776.         # Index hasn't been dropped
1777.         self.assertIndexExists("test_alflin_pony", ["pink"])
1778.         # And test reversal
1779.         with connection.schema_editor() as editor:
1780.             operation.database_backwards("test_alflin", editor, new_state, project_state)
1781.         # Ensure the index is still there
1782.         self.assertIndexExists("test_alflin_pony", ["pink"])
1783. 
1784.     def test_alter_index_together(self):
1785.         """
1786.         Tests the AlterIndexTogether operation.
1787.         """
1788.         project_state = self.set_up_test_model("test_alinto")
1789.         # Test the state alteration
1790.         operation = migrations.AlterIndexTogether("Pony", [("pink", "weight")])
1791.         self.assertEqual(operation.describe(), "Alter index_together for Pony (1 constraint(s))")
1792.         new_state = project_state.clone()
1793.         operation.state_forwards("test_alinto", new_state)
1794.         self.assertEqual(len(project_state.models["test_alinto", "pony"].options.get("index_together", set())), 0)
1795.         self.assertEqual(len(new_state.models["test_alinto", "pony"].options.get("index_together", set())), 1)
1796.         # Make sure there's no matching index
1797.         self.assertIndexNotExists("test_alinto_pony", ["pink", "weight"])
1798.         # Test the database alteration
1799.         with connection.schema_editor() as editor:
1800.             operation.database_forwards("test_alinto", editor, project_state, new_state)
1801.         self.assertIndexExists("test_alinto_pony", ["pink", "weight"])
1802.         # And test reversal
1803.         with connection.schema_editor() as editor:
1804.             operation.database_backwards("test_alinto", editor, new_state, project_state)
1805.         self.assertIndexNotExists("test_alinto_pony", ["pink", "weight"])
1806.         # And deconstruction
1807.         definition = operation.deconstruct()
1808.         self.assertEqual(definition[0], "AlterIndexTogether")
1809.         self.assertEqual(definition[1], [])
1810.         self.assertEqual(definition[2], {'name': "Pony", 'index_together': {("pink", "weight")}})
1811. 
1812.     def test_alter_index_together_remove(self):
1813.         operation = migrations.AlterIndexTogether("Pony", None)
1814.         self.assertEqual(operation.describe(), "Alter index_together for Pony (0 constraint(s))")
1815. 
1816.     @skipUnlessDBFeature('supports_table_check_constraints')
1817.     def test_add_constraint(self):
1818.         project_state = self.set_up_test_model("test_addconstraint")
1819.         gt_check = models.Q(pink__gt=2)
1820.         gt_constraint = models.CheckConstraint(check=gt_check, name="test_add_constraint_pony_pink_gt_2")
1821.         gt_operation = migrations.AddConstraint("Pony", gt_constraint)
1822.         self.assertEqual(
1823.             gt_operation.describe(), "Create constraint test_add_constraint_pony_pink_gt_2 on model Pony"
1824.         )
1825.         # Test the state alteration
1826.         new_state = project_state.clone()
1827.         gt_operation.state_forwards("test_addconstraint", new_state)
1828.         self.assertEqual(len(new_state.models["test_addconstraint", "pony"].options["constraints"]), 1)
1829.         Pony = new_state.apps.get_model("test_addconstraint", "Pony")
1830.         self.assertEqual(len(Pony._meta.constraints), 1)
1831.         # Test the database alteration
1832.         with connection.schema_editor() as editor:
1833.             gt_operation.database_forwards("test_addconstraint", editor, project_state, new_state)
1834.         with self.assertRaises(IntegrityError), transaction.atomic():
1835.             Pony.objects.create(pink=1, weight=1.0)
1836.         # Add another one.
1837.         lt_check = models.Q(pink__lt=100)
1838.         lt_constraint = models.CheckConstraint(check=lt_check, name="test_add_constraint_pony_pink_lt_100")
1839.         lt_operation = migrations.AddConstraint("Pony", lt_constraint)
1840.         lt_operation.state_forwards("test_addconstraint", new_state)
1841.         self.assertEqual(len(new_state.models["test_addconstraint", "pony"].options["constraints"]), 2)
1842.         Pony = new_state.apps.get_model("test_addconstraint", "Pony")
1843.         self.assertEqual(len(Pony._meta.constraints), 2)
1844.         with connection.schema_editor() as editor:
1845.             lt_operation.database_forwards("test_addconstraint", editor, project_state, new_state)
1846.         with self.assertRaises(IntegrityError), transaction.atomic():
1847.             Pony.objects.create(pink=100, weight=1.0)
1848.         # Test reversal
1849.         with connection.schema_editor() as editor:
1850.             gt_operation.database_backwards("test_addconstraint", editor, new_state, project_state)
1851.         Pony.objects.create(pink=1, weight=1.0)
1852.         # Test deconstruction
1853.         definition = gt_operation.deconstruct()
1854.         self.assertEqual(definition[0], "AddConstraint")
1855.         self.assertEqual(definition[1], [])
1856.         self.assertEqual(definition[2], {'model_name': "Pony", 'constraint': gt_constraint})
1857. 
1858.     @skipUnlessDBFeature('supports_table_check_constraints')
1859.     def test_add_constraint_percent_escaping(self):
1860.         app_label = 'add_constraint_string_quoting'
1861.         operations = [
1862.             CreateModel(
1863.                 'Author',
1864.                 fields=[
1865.                     ('id', models.AutoField(primary_key=True)),
1866.                     ('name', models.CharField(max_length=100)),
1867.                     ('rebate', models.CharField(max_length=100)),
1868.                 ],
1869.             ),
1870.         ]
1871.         from_state = self.apply_operations(app_label, ProjectState(), operations)
1872.         # "%" generated in startswith lookup should be escaped in a way that is
1873.         # considered a leading wildcard.
1874.         check = models.Q(name__startswith='Albert')
1875.         constraint = models.CheckConstraint(check=check, name='name_constraint')
1876.         operation = migrations.AddConstraint('Author', constraint)
1877.         to_state = from_state.clone()
1878.         operation.state_forwards(app_label, to_state)
1879.         with connection.schema_editor() as editor:
1880.             operation.database_forwards(app_label, editor, from_state, to_state)
1881.         Author = to_state.apps.get_model(app_label, 'Author')
1882.         with self.assertRaises(IntegrityError), transaction.atomic():
1883.             Author.objects.create(name='Artur')
1884.         # Literal "%" should be escaped in a way that is not a considered a
1885.         # wildcard.
1886.         check = models.Q(rebate__endswith='%')
1887.         constraint = models.CheckConstraint(check=check, name='rebate_constraint')
1888.         operation = migrations.AddConstraint('Author', constraint)
1889.         from_state = to_state
1890.         to_state = from_state.clone()
1891.         operation.state_forwards(app_label, to_state)
1892.         Author = to_state.apps.get_model(app_label, 'Author')
1893.         with connection.schema_editor() as editor:
1894.             operation.database_forwards(app_label, editor, from_state, to_state)
1895.         Author = to_state.apps.get_model(app_label, 'Author')
1896.         with self.assertRaises(IntegrityError), transaction.atomic():
1897.             Author.objects.create(name='Albert', rebate='10$')
1898.         author = Author.objects.create(name='Albert', rebate='10%')
1899.         self.assertEqual(Author.objects.get(), author)
1900. 
1901.     @skipUnlessDBFeature('supports_table_check_constraints')
1902.     def test_add_or_constraint(self):
1903.         app_label = 'test_addorconstraint'
1904.         constraint_name = 'add_constraint_or'
1905.         from_state = self.set_up_test_model(app_label)
1906.         check = models.Q(pink__gt=2, weight__gt=2) | models.Q(weight__lt=0)
1907.         constraint = models.CheckConstraint(check=check, name=constraint_name)
1908.         operation = migrations.AddConstraint('Pony', constraint)
1909.         to_state = from_state.clone()
1910.         operation.state_forwards(app_label, to_state)
1911.         with connection.schema_editor() as editor:
1912.             operation.database_forwards(app_label, editor, from_state, to_state)
1913.         Pony = to_state.apps.get_model(app_label, 'Pony')
1914.         with self.assertRaises(IntegrityError), transaction.atomic():
1915.             Pony.objects.create(pink=2, weight=3.0)
1916.         with self.assertRaises(IntegrityError), transaction.atomic():
1917.             Pony.objects.create(pink=3, weight=1.0)
1918.         Pony.objects.bulk_create([
1919.             Pony(pink=3, weight=-1.0),
1920.             Pony(pink=1, weight=-1.0),
1921.             Pony(pink=3, weight=3.0),
1922.         ])
1923. 
1924.     @skipUnlessDBFeature('supports_table_check_constraints')
1925.     def test_remove_constraint(self):
1926.         project_state = self.set_up_test_model("test_removeconstraint", constraints=[
1927.             models.CheckConstraint(check=models.Q(pink__gt=2), name="test_remove_constraint_pony_pink_gt_2"),
1928.             models.CheckConstraint(check=models.Q(pink__lt=100), name="test_remove_constraint_pony_pink_lt_100"),
1929.         ])
1930.         gt_operation = migrations.RemoveConstraint("Pony", "test_remove_constraint_pony_pink_gt_2")
1931.         self.assertEqual(
1932.             gt_operation.describe(), "Remove constraint test_remove_constraint_pony_pink_gt_2 from model Pony"
1933.         )
1934.         # Test state alteration
1935.         new_state = project_state.clone()
1936.         gt_operation.state_forwards("test_removeconstraint", new_state)
1937.         self.assertEqual(len(new_state.models["test_removeconstraint", "pony"].options['constraints']), 1)
1938.         Pony = new_state.apps.get_model("test_removeconstraint", "Pony")
1939.         self.assertEqual(len(Pony._meta.constraints), 1)
1940.         # Test database alteration
1941.         with connection.schema_editor() as editor:
1942.             gt_operation.database_forwards("test_removeconstraint", editor, project_state, new_state)
1943.         Pony.objects.create(pink=1, weight=1.0).delete()
1944.         with self.assertRaises(IntegrityError), transaction.atomic():
1945.             Pony.objects.create(pink=100, weight=1.0)
1946.         # Remove the other one.
1947.         lt_operation = migrations.RemoveConstraint("Pony", "test_remove_constraint_pony_pink_lt_100")
1948.         lt_operation.state_forwards("test_removeconstraint", new_state)
1949.         self.assertEqual(len(new_state.models["test_removeconstraint", "pony"].options['constraints']), 0)
1950.         Pony = new_state.apps.get_model("test_removeconstraint", "Pony")
1951.         self.assertEqual(len(Pony._meta.constraints), 0)
1952.         with connection.schema_editor() as editor:
1953.             lt_operation.database_forwards("test_removeconstraint", editor, project_state, new_state)
1954.         Pony.objects.create(pink=100, weight=1.0).delete()
1955.         # Test reversal
1956.         with connection.schema_editor() as editor:
1957.             gt_operation.database_backwards("test_removeconstraint", editor, new_state, project_state)
1958.         with self.assertRaises(IntegrityError), transaction.atomic():
1959.             Pony.objects.create(pink=1, weight=1.0)
1960.         # Test deconstruction
1961.         definition = gt_operation.deconstruct()
1962.         self.assertEqual(definition[0], "RemoveConstraint")
1963.         self.assertEqual(definition[1], [])
1964.         self.assertEqual(definition[2], {'model_name': "Pony", 'name': "test_remove_constraint_pony_pink_gt_2"})
1965. 
1966.     def test_add_partial_unique_constraint(self):
1967.         project_state = self.set_up_test_model('test_addpartialuniqueconstraint')
1968.         partial_unique_constraint = models.UniqueConstraint(
1969.             fields=['pink'],
1970.             condition=models.Q(weight__gt=5),
1971.             name='test_constraint_pony_pink_for_weight_gt_5_uniq',
1972.         )
1973.         operation = migrations.AddConstraint('Pony', partial_unique_constraint)
1974.         self.assertEqual(
1975.             operation.describe(),
1976.             'Create constraint test_constraint_pony_pink_for_weight_gt_5_uniq '
1977.             'on model Pony'
1978.         )
1979.         # Test the state alteration
1980.         new_state = project_state.clone()
1981.         operation.state_forwards('test_addpartialuniqueconstraint', new_state)
1982.         self.assertEqual(len(new_state.models['test_addpartialuniqueconstraint', 'pony'].options['constraints']), 1)
1983.         Pony = new_state.apps.get_model('test_addpartialuniqueconstraint', 'Pony')
1984.         self.assertEqual(len(Pony._meta.constraints), 1)
1985.         # Test the database alteration
1986.         with connection.schema_editor() as editor:
1987.             operation.database_forwards('test_addpartialuniqueconstraint', editor, project_state, new_state)
1988.         # Test constraint works
1989.         Pony.objects.create(pink=1, weight=4.0)
1990.         Pony.objects.create(pink=1, weight=4.0)
1991.         Pony.objects.create(pink=1, weight=6.0)
1992.         if connection.features.supports_partial_indexes:
1993.             with self.assertRaises(IntegrityError), transaction.atomic():
1994.                 Pony.objects.create(pink=1, weight=7.0)
1995.         else:
1996.             Pony.objects.create(pink=1, weight=7.0)
1997.         # Test reversal
1998.         with connection.schema_editor() as editor:
1999.             operation.database_backwards('test_addpartialuniqueconstraint', editor, new_state, project_state)
2000.         # Test constraint doesn't work
2001.         Pony.objects.create(pink=1, weight=7.0)
2002.         # Test deconstruction
2003.         definition = operation.deconstruct()
2004.         self.assertEqual(definition[0], 'AddConstraint')
2005.         self.assertEqual(definition[1], [])
2006.         self.assertEqual(definition[2], {'model_name': 'Pony', 'constraint': partial_unique_constraint})
2007. 
2008.     def test_remove_partial_unique_constraint(self):
2009.         project_state = self.set_up_test_model('test_removepartialuniqueconstraint', constraints=[
2010.             models.UniqueConstraint(
2011.                 fields=['pink'],
2012.                 condition=models.Q(weight__gt=5),
2013.                 name='test_constraint_pony_pink_for_weight_gt_5_uniq',
2014.             ),
2015.         ])
2016.         gt_operation = migrations.RemoveConstraint('Pony', 'test_constraint_pony_pink_for_weight_gt_5_uniq')
2017.         self.assertEqual(
2018.             gt_operation.describe(), 'Remove constraint test_constraint_pony_pink_for_weight_gt_5_uniq from model Pony'
2019.         )
2020.         # Test state alteration
2021.         new_state = project_state.clone()
2022.         gt_operation.state_forwards('test_removepartialuniqueconstraint', new_state)
2023.         self.assertEqual(len(new_state.models['test_removepartialuniqueconstraint', 'pony'].options['constraints']), 0)
2024.         Pony = new_state.apps.get_model('test_removepartialuniqueconstraint', 'Pony')
2025.         self.assertEqual(len(Pony._meta.constraints), 0)
2026.         # Test database alteration
2027.         with connection.schema_editor() as editor:
2028.             gt_operation.database_forwards('test_removepartialuniqueconstraint', editor, project_state, new_state)
2029.         # Test constraint doesn't work
2030.         Pony.objects.create(pink=1, weight=4.0)
2031.         Pony.objects.create(pink=1, weight=4.0)
2032.         Pony.objects.create(pink=1, weight=6.0)
2033.         Pony.objects.create(pink=1, weight=7.0).delete()
2034.         # Test reversal
2035.         with connection.schema_editor() as editor:
2036.             gt_operation.database_backwards('test_removepartialuniqueconstraint', editor, new_state, project_state)
2037.         # Test constraint works
2038.         if connection.features.supports_partial_indexes:
2039.             with self.assertRaises(IntegrityError), transaction.atomic():
2040.                 Pony.objects.create(pink=1, weight=7.0)
2041.         else:
2042.             Pony.objects.create(pink=1, weight=7.0)
2043.         # Test deconstruction
2044.         definition = gt_operation.deconstruct()
2045.         self.assertEqual(definition[0], 'RemoveConstraint')
2046.         self.assertEqual(definition[1], [])
2047.         self.assertEqual(definition[2], {
2048.             'model_name': 'Pony',
2049.             'name': 'test_constraint_pony_pink_for_weight_gt_5_uniq',
2050.         })
2051. 
2052.     def test_alter_model_options(self):
2053.         """
2054.         Tests the AlterModelOptions operation.
2055.         """
2056.         project_state = self.set_up_test_model("test_almoop")
2057.         # Test the state alteration (no DB alteration to test)
2058.         operation = migrations.AlterModelOptions("Pony", {"permissions": [("can_groom", "Can groom")]})
2059.         self.assertEqual(operation.describe(), "Change Meta options on Pony")
2060.         new_state = project_state.clone()
2061.         operation.state_forwards("test_almoop", new_state)
2062.         self.assertEqual(len(project_state.models["test_almoop", "pony"].options.get("permissions", [])), 0)
2063.         self.assertEqual(len(new_state.models["test_almoop", "pony"].options.get("permissions", [])), 1)
2064.         self.assertEqual(new_state.models["test_almoop", "pony"].options["permissions"][0][0], "can_groom")
2065.         # And deconstruction
2066.         definition = operation.deconstruct()
2067.         self.assertEqual(definition[0], "AlterModelOptions")
2068.         self.assertEqual(definition[1], [])
2069.         self.assertEqual(definition[2], {'name': "Pony", 'options': {"permissions": [("can_groom", "Can groom")]}})
2070. 
2071.     def test_alter_model_options_emptying(self):
2072.         """
2073.         The AlterModelOptions operation removes keys from the dict (#23121)
2074.         """
2075.         project_state = self.set_up_test_model("test_almoop", options=True)
2076.         # Test the state alteration (no DB alteration to test)
2077.         operation = migrations.AlterModelOptions("Pony", {})
2078.         self.assertEqual(operation.describe(), "Change Meta options on Pony")
2079.         new_state = project_state.clone()
2080.         operation.state_forwards("test_almoop", new_state)
2081.         self.assertEqual(len(project_state.models["test_almoop", "pony"].options.get("permissions", [])), 1)
2082.         self.assertEqual(len(new_state.models["test_almoop", "pony"].options.get("permissions", [])), 0)
2083.         # And deconstruction
2084.         definition = operation.deconstruct()
2085.         self.assertEqual(definition[0], "AlterModelOptions")
2086.         self.assertEqual(definition[1], [])
2087.         self.assertEqual(definition[2], {'name': "Pony", 'options': {}})
2088. 
2089.     def test_alter_order_with_respect_to(self):
2090.         """
2091.         Tests the AlterOrderWithRespectTo operation.
2092.         """
2093.         project_state = self.set_up_test_model("test_alorwrtto", related_model=True)
2094.         # Test the state alteration
2095.         operation = migrations.AlterOrderWithRespectTo("Rider", "pony")
2096.         self.assertEqual(operation.describe(), "Set order_with_respect_to on Rider to pony")
2097.         new_state = project_state.clone()
2098.         operation.state_forwards("test_alorwrtto", new_state)
2099.         self.assertIsNone(
2100.             project_state.models["test_alorwrtto", "rider"].options.get("order_with_respect_to", None)
2101.         )
2102.         self.assertEqual(
2103.             new_state.models["test_alorwrtto", "rider"].options.get("order_with_respect_to", None),
2104.             "pony"
2105.         )
2106.         # Make sure there's no matching index
2107.         self.assertColumnNotExists("test_alorwrtto_rider", "_order")
2108.         # Create some rows before alteration
2109.         rendered_state = project_state.apps
2110.         pony = rendered_state.get_model("test_alorwrtto", "Pony").objects.create(weight=50)
2111.         rendered_state.get_model("test_alorwrtto", "Rider").objects.create(pony=pony, friend_id=1)
2112.         rendered_state.get_model("test_alorwrtto", "Rider").objects.create(pony=pony, friend_id=2)
2113.         # Test the database alteration
2114.         with connection.schema_editor() as editor:
2115.             operation.database_forwards("test_alorwrtto", editor, project_state, new_state)
2116.         self.assertColumnExists("test_alorwrtto_rider", "_order")
2117.         # Check for correct value in rows
2118.         updated_riders = new_state.apps.get_model("test_alorwrtto", "Rider").objects.all()
2119.         self.assertEqual(updated_riders[0]._order, 0)
2120.         self.assertEqual(updated_riders[1]._order, 0)
2121.         # And test reversal
2122.         with connection.schema_editor() as editor:
2123.             operation.database_backwards("test_alorwrtto", editor, new_state, project_state)
2124.         self.assertColumnNotExists("test_alorwrtto_rider", "_order")
2125.         # And deconstruction
2126.         definition = operation.deconstruct()
2127.         self.assertEqual(definition[0], "AlterOrderWithRespectTo")
2128.         self.assertEqual(definition[1], [])
2129.         self.assertEqual(definition[2], {'name': "Rider", 'order_with_respect_to': "pony"})
2130. 
2131.     def test_alter_model_managers(self):
2132.         """
2133.         The managers on a model are set.
2134.         """
2135.         project_state = self.set_up_test_model("test_almoma")
2136.         # Test the state alteration
2137.         operation = migrations.AlterModelManagers(
2138.             "Pony",
2139.             managers=[
2140.                 ("food_qs", FoodQuerySet.as_manager()),
2141.                 ("food_mgr", FoodManager("a", "b")),
2142.                 ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
2143.             ]
2144.         )
2145.         self.assertEqual(operation.describe(), "Change managers on Pony")
2146.         managers = project_state.models["test_almoma", "pony"].managers
2147.         self.assertEqual(managers, [])
2148. 
2149.         new_state = project_state.clone()
2150.         operation.state_forwards("test_almoma", new_state)
2151.         self.assertIn(("test_almoma", "pony"), new_state.models)
2152.         managers = new_state.models["test_almoma", "pony"].managers
2153.         self.assertEqual(managers[0][0], "food_qs")
2154.         self.assertIsInstance(managers[0][1], models.Manager)
2155.         self.assertEqual(managers[1][0], "food_mgr")
2156.         self.assertIsInstance(managers[1][1], FoodManager)
2157.         self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
2158.         self.assertEqual(managers[2][0], "food_mgr_kwargs")
2159.         self.assertIsInstance(managers[2][1], FoodManager)
2160.         self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
2161.         rendered_state = new_state.apps
2162.         model = rendered_state.get_model('test_almoma', 'pony')
2163.         self.assertIsInstance(model.food_qs, models.Manager)
2164.         self.assertIsInstance(model.food_mgr, FoodManager)
2165.         self.assertIsInstance(model.food_mgr_kwargs, FoodManager)
2166. 
2167.     def test_alter_model_managers_emptying(self):
2168.         """
2169.         The managers on a model are set.
2170.         """
2171.         project_state = self.set_up_test_model("test_almomae", manager_model=True)
2172.         # Test the state alteration
2173.         operation = migrations.AlterModelManagers("Food", managers=[])
2174.         self.assertEqual(operation.describe(), "Change managers on Food")
2175.         self.assertIn(("test_almomae", "food"), project_state.models)
2176.         managers = project_state.models["test_almomae", "food"].managers
2177.         self.assertEqual(managers[0][0], "food_qs")
2178.         self.assertIsInstance(managers[0][1], models.Manager)
2179.         self.assertEqual(managers[1][0], "food_mgr")
2180.         self.assertIsInstance(managers[1][1], FoodManager)
2181.         self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
2182.         self.assertEqual(managers[2][0], "food_mgr_kwargs")
2183.         self.assertIsInstance(managers[2][1], FoodManager)
2184.         self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
2185. 
2186.         new_state = project_state.clone()
2187.         operation.state_forwards("test_almomae", new_state)
2188.         managers = new_state.models["test_almomae", "food"].managers
2189.         self.assertEqual(managers, [])
2190. 
2191.     def test_alter_fk(self):
2192.         """
2193.         Creating and then altering an FK works correctly
2194.         and deals with the pending SQL (#23091)
2195.         """
2196.         project_state = self.set_up_test_model("test_alfk")
2197.         # Test adding and then altering the FK in one go
2198.         create_operation = migrations.CreateModel(
2199.             name="Rider",
2200.             fields=[
2201.                 ("id", models.AutoField(primary_key=True)),
2202.                 ("pony", models.ForeignKey("Pony", models.CASCADE)),
2203.             ],
2204.         )
2205.         create_state = project_state.clone()
2206.         create_operation.state_forwards("test_alfk", create_state)
2207.         alter_operation = migrations.AlterField(
2208.             model_name='Rider',
2209.             name='pony',
2210.             field=models.ForeignKey("Pony", models.CASCADE, editable=False),
2211.         )
2212.         alter_state = create_state.clone()
2213.         alter_operation.state_forwards("test_alfk", alter_state)
2214.         with connection.schema_editor() as editor:
2215.             create_operation.database_forwards("test_alfk", editor, project_state, create_state)
2216.             alter_operation.database_forwards("test_alfk", editor, create_state, alter_state)
2217. 
2218.     def test_alter_fk_non_fk(self):
2219.         """
2220.         Altering an FK to a non-FK works (#23244)
2221.         """
2222.         # Test the state alteration
2223.         operation = migrations.AlterField(
2224.             model_name="Rider",
2225.             name="pony",
2226.             field=models.FloatField(),
2227.         )
2228.         project_state, new_state = self.make_test_state("test_afknfk", operation, related_model=True)
2229.         # Test the database alteration
2230.         self.assertColumnExists("test_afknfk_rider", "pony_id")
2231.         self.assertColumnNotExists("test_afknfk_rider", "pony")
2232.         with connection.schema_editor() as editor:
2233.             operation.database_forwards("test_afknfk", editor, project_state, new_state)
2234.         self.assertColumnExists("test_afknfk_rider", "pony")
2235.         self.assertColumnNotExists("test_afknfk_rider", "pony_id")
2236.         # And test reversal
2237.         with connection.schema_editor() as editor:
2238.             operation.database_backwards("test_afknfk", editor, new_state, project_state)
2239.         self.assertColumnExists("test_afknfk_rider", "pony_id")
2240.         self.assertColumnNotExists("test_afknfk_rider", "pony")
2241. 
2242.     def test_run_sql(self):
2243.         """
2244.         Tests the RunSQL operation.
2245.         """
2246.         project_state = self.set_up_test_model("test_runsql")
2247.         # Create the operation
2248.         operation = migrations.RunSQL(
2249.             # Use a multi-line string with a comment to test splitting on SQLite and MySQL respectively
2250.             "CREATE TABLE i_love_ponies (id int, special_thing varchar(15));\n"
2251.             "INSERT INTO i_love_ponies (id, special_thing) VALUES (1, 'i love ponies'); -- this is magic!\n"
2252.             "INSERT INTO i_love_ponies (id, special_thing) VALUES (2, 'i love django');\n"
2253.             "UPDATE i_love_ponies SET special_thing = 'Ponies' WHERE special_thing LIKE '%%ponies';"
2254.             "UPDATE i_love_ponies SET special_thing = 'Django' WHERE special_thing LIKE '%django';",
2255. 
2256.             # Run delete queries to test for parameter substitution failure
2257.             # reported in #23426
2258.             "DELETE FROM i_love_ponies WHERE special_thing LIKE '%Django%';"
2259.             "DELETE FROM i_love_ponies WHERE special_thing LIKE '%%Ponies%%';"
2260.             "DROP TABLE i_love_ponies",
2261. 
2262.             state_operations=[migrations.CreateModel("SomethingElse", [("id", models.AutoField(primary_key=True))])],
2263.         )
2264.         self.assertEqual(operation.describe(), "Raw SQL operation")
2265.         # Test the state alteration
2266.         new_state = project_state.clone()
2267.         operation.state_forwards("test_runsql", new_state)
2268.         self.assertEqual(len(new_state.models["test_runsql", "somethingelse"].fields), 1)
2269.         # Make sure there's no table
2270.         self.assertTableNotExists("i_love_ponies")
2271.         # Test SQL collection
2272.         with connection.schema_editor(collect_sql=True) as editor:
2273.             operation.database_forwards("test_runsql", editor, project_state, new_state)
2274.             self.assertIn("LIKE '%%ponies';", "\n".join(editor.collected_sql))
2275.             operation.database_backwards("test_runsql", editor, project_state, new_state)
2276.             self.assertIn("LIKE '%%Ponies%%';", "\n".join(editor.collected_sql))
2277.         # Test the database alteration
2278.         with connection.schema_editor() as editor:
2279.             operation.database_forwards("test_runsql", editor, project_state, new_state)
2280.         self.assertTableExists("i_love_ponies")
2281.         # Make sure all the SQL was processed
2282.         with connection.cursor() as cursor:
2283.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
2284.             self.assertEqual(cursor.fetchall()[0][0], 2)
2285.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies WHERE special_thing = 'Django'")
2286.             self.assertEqual(cursor.fetchall()[0][0], 1)
2287.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies WHERE special_thing = 'Ponies'")
2288.             self.assertEqual(cursor.fetchall()[0][0], 1)
2289.         # And test reversal
2290.         self.assertTrue(operation.reversible)
2291.         with connection.schema_editor() as editor:
2292.             operation.database_backwards("test_runsql", editor, new_state, project_state)
2293.         self.assertTableNotExists("i_love_ponies")
2294.         # And deconstruction
2295.         definition = operation.deconstruct()
2296.         self.assertEqual(definition[0], "RunSQL")
2297.         self.assertEqual(definition[1], [])
2298.         self.assertEqual(sorted(definition[2]), ["reverse_sql", "sql", "state_operations"])
2299.         # And elidable reduction
2300.         self.assertIs(False, operation.reduce(operation, []))
2301.         elidable_operation = migrations.RunSQL('SELECT 1 FROM void;', elidable=True)
2302.         self.assertEqual(elidable_operation.reduce(operation, []), [operation])
2303. 
2304.     def test_run_sql_params(self):
2305.         """
2306.         #23426 - RunSQL should accept parameters.
2307.         """
2308.         project_state = self.set_up_test_model("test_runsql")
2309.         # Create the operation
2310.         operation = migrations.RunSQL(
2311.             ["CREATE TABLE i_love_ponies (id int, special_thing varchar(15));"],
2312.             ["DROP TABLE i_love_ponies"],
2313.         )
2314.         param_operation = migrations.RunSQL(
2315.             # forwards
2316.             (
2317.                 "INSERT INTO i_love_ponies (id, special_thing) VALUES (1, 'Django');",
2318.                 ["INSERT INTO i_love_ponies (id, special_thing) VALUES (2, %s);", ['Ponies']],
2319.                 ("INSERT INTO i_love_ponies (id, special_thing) VALUES (%s, %s);", (3, 'Python',)),
2320.             ),
2321.             # backwards
2322.             [
2323.                 "DELETE FROM i_love_ponies WHERE special_thing = 'Django';",
2324.                 ["DELETE FROM i_love_ponies WHERE special_thing = 'Ponies';", None],
2325.                 ("DELETE FROM i_love_ponies WHERE id = %s OR special_thing = %s;", [3, 'Python']),
2326.             ]
2327.         )
2328. 
2329.         # Make sure there's no table
2330.         self.assertTableNotExists("i_love_ponies")
2331.         new_state = project_state.clone()
2332.         # Test the database alteration
2333.         with connection.schema_editor() as editor:
2334.             operation.database_forwards("test_runsql", editor, project_state, new_state)
2335. 
2336.         # Test parameter passing
2337.         with connection.schema_editor() as editor:
2338.             param_operation.database_forwards("test_runsql", editor, project_state, new_state)
2339.         # Make sure all the SQL was processed
2340.         with connection.cursor() as cursor:
2341.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
2342.             self.assertEqual(cursor.fetchall()[0][0], 3)
2343. 
2344.         with connection.schema_editor() as editor:
2345.             param_operation.database_backwards("test_runsql", editor, new_state, project_state)
2346.         with connection.cursor() as cursor:
2347.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
2348.             self.assertEqual(cursor.fetchall()[0][0], 0)
2349. 
2350.         # And test reversal
2351.         with connection.schema_editor() as editor:
2352.             operation.database_backwards("test_runsql", editor, new_state, project_state)
2353.         self.assertTableNotExists("i_love_ponies")
2354. 
2355.     def test_run_sql_params_invalid(self):
2356.         """
2357.         #23426 - RunSQL should fail when a list of statements with an incorrect
2358.         number of tuples is given.
2359.         """
2360.         project_state = self.set_up_test_model("test_runsql")
2361.         new_state = project_state.clone()
2362.         operation = migrations.RunSQL(
2363.             # forwards
2364.             [
2365.                 ["INSERT INTO foo (bar) VALUES ('buz');"]
2366.             ],
2367.             # backwards
2368.             (
2369.                 ("DELETE FROM foo WHERE bar = 'buz';", 'invalid', 'parameter count'),
2370.             ),
2371.         )
2372. 
2373.         with connection.schema_editor() as editor:
2374.             with self.assertRaisesMessage(ValueError, "Expected a 2-tuple but got 1"):
2375.                 operation.database_forwards("test_runsql", editor, project_state, new_state)
2376. 
2377.         with connection.schema_editor() as editor:
2378.             with self.assertRaisesMessage(ValueError, "Expected a 2-tuple but got 3"):
2379.                 operation.database_backwards("test_runsql", editor, new_state, project_state)
2380. 
2381.     def test_run_sql_noop(self):
2382.         """
2383.         #24098 - Tests no-op RunSQL operations.
2384.         """
2385.         operation = migrations.RunSQL(migrations.RunSQL.noop, migrations.RunSQL.noop)
2386.         with connection.schema_editor() as editor:
2387.             operation.database_forwards("test_runsql", editor, None, None)
2388.             operation.database_backwards("test_runsql", editor, None, None)
2389. 
2390.     def test_run_python(self):
2391.         """
2392.         Tests the RunPython operation
2393.         """
2394. 
2395.         project_state = self.set_up_test_model("test_runpython", mti_model=True)
2396. 
2397.         # Create the operation
2398.         def inner_method(models, schema_editor):
2399.             Pony = models.get_model("test_runpython", "Pony")
2400.             Pony.objects.create(pink=1, weight=3.55)
2401.             Pony.objects.create(weight=5)
2402. 
2403.         def inner_method_reverse(models, schema_editor):
2404.             Pony = models.get_model("test_runpython", "Pony")
2405.             Pony.objects.filter(pink=1, weight=3.55).delete()
2406.             Pony.objects.filter(weight=5).delete()
2407.         operation = migrations.RunPython(inner_method, reverse_code=inner_method_reverse)
2408.         self.assertEqual(operation.describe(), "Raw Python operation")
2409.         # Test the state alteration does nothing
2410.         new_state = project_state.clone()
2411.         operation.state_forwards("test_runpython", new_state)
2412.         self.assertEqual(new_state, project_state)
2413.         # Test the database alteration
2414.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 0)
2415.         with connection.schema_editor() as editor:
2416.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2417.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 2)
2418.         # Now test reversal
2419.         self.assertTrue(operation.reversible)
2420.         with connection.schema_editor() as editor:
2421.             operation.database_backwards("test_runpython", editor, project_state, new_state)
2422.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 0)
2423.         # Now test we can't use a string
2424.         with self.assertRaisesMessage(ValueError, 'RunPython must be supplied with a callable'):
2425.             migrations.RunPython("print 'ahahaha'")
2426.         # And deconstruction
2427.         definition = operation.deconstruct()
2428.         self.assertEqual(definition[0], "RunPython")
2429.         self.assertEqual(definition[1], [])
2430.         self.assertEqual(sorted(definition[2]), ["code", "reverse_code"])
2431. 
2432.         # Also test reversal fails, with an operation identical to above but without reverse_code set
2433.         no_reverse_operation = migrations.RunPython(inner_method)
2434.         self.assertFalse(no_reverse_operation.reversible)
2435.         with connection.schema_editor() as editor:
2436.             no_reverse_operation.database_forwards("test_runpython", editor, project_state, new_state)
2437.             with self.assertRaises(NotImplementedError):
2438.                 no_reverse_operation.database_backwards("test_runpython", editor, new_state, project_state)
2439.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 2)
2440. 
2441.         def create_ponies(models, schema_editor):
2442.             Pony = models.get_model("test_runpython", "Pony")
2443.             pony1 = Pony.objects.create(pink=1, weight=3.55)
2444.             self.assertIsNot(pony1.pk, None)
2445.             pony2 = Pony.objects.create(weight=5)
2446.             self.assertIsNot(pony2.pk, None)
2447.             self.assertNotEqual(pony1.pk, pony2.pk)
2448. 
2449.         operation = migrations.RunPython(create_ponies)
2450.         with connection.schema_editor() as editor:
2451.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2452.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 4)
2453.         # And deconstruction
2454.         definition = operation.deconstruct()
2455.         self.assertEqual(definition[0], "RunPython")
2456.         self.assertEqual(definition[1], [])
2457.         self.assertEqual(sorted(definition[2]), ["code"])
2458. 
2459.         def create_shetlandponies(models, schema_editor):
2460.             ShetlandPony = models.get_model("test_runpython", "ShetlandPony")
2461.             pony1 = ShetlandPony.objects.create(weight=4.0)
2462.             self.assertIsNot(pony1.pk, None)
2463.             pony2 = ShetlandPony.objects.create(weight=5.0)
2464.             self.assertIsNot(pony2.pk, None)
2465.             self.assertNotEqual(pony1.pk, pony2.pk)
2466. 
2467.         operation = migrations.RunPython(create_shetlandponies)
2468.         with connection.schema_editor() as editor:
2469.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2470.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 6)
2471.         self.assertEqual(project_state.apps.get_model("test_runpython", "ShetlandPony").objects.count(), 2)
2472.         # And elidable reduction
2473.         self.assertIs(False, operation.reduce(operation, []))
2474.         elidable_operation = migrations.RunPython(inner_method, elidable=True)
2475.         self.assertEqual(elidable_operation.reduce(operation, []), [operation])
2476. 
2477.     def test_run_python_atomic(self):
2478.         """
2479.         Tests the RunPython operation correctly handles the "atomic" keyword
2480.         """
2481.         project_state = self.set_up_test_model("test_runpythonatomic", mti_model=True)
2482. 
2483.         def inner_method(models, schema_editor):
2484.             Pony = models.get_model("test_runpythonatomic", "Pony")
2485.             Pony.objects.create(pink=1, weight=3.55)
2486.             raise ValueError("Adrian hates ponies.")
2487. 
2488.         # Verify atomicity when applying.
2489.         atomic_migration = Migration("test", "test_runpythonatomic")
2490.         atomic_migration.operations = [migrations.RunPython(inner_method, reverse_code=inner_method)]
2491.         non_atomic_migration = Migration("test", "test_runpythonatomic")
2492.         non_atomic_migration.operations = [migrations.RunPython(inner_method, reverse_code=inner_method, atomic=False)]
2493.         # If we're a fully-transactional database, both versions should rollback
2494.         if connection.features.can_rollback_ddl:
2495.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2496.             with self.assertRaises(ValueError):
2497.                 with connection.schema_editor() as editor:
2498.                     atomic_migration.apply(project_state, editor)
2499.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2500.             with self.assertRaises(ValueError):
2501.                 with connection.schema_editor() as editor:
2502.                     non_atomic_migration.apply(project_state, editor)
2503.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2504.         # Otherwise, the non-atomic operation should leave a row there
2505.         else:
2506.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2507.             with self.assertRaises(ValueError):
2508.                 with connection.schema_editor() as editor:
2509.                     atomic_migration.apply(project_state, editor)
2510.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2511.             with self.assertRaises(ValueError):
2512.                 with connection.schema_editor() as editor:
2513.                     non_atomic_migration.apply(project_state, editor)
2514.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 1)
2515.         # Reset object count to zero and verify atomicity when unapplying.
2516.         project_state.apps.get_model("test_runpythonatomic", "Pony").objects.all().delete()
2517.         # On a fully-transactional database, both versions rollback.
2518.         if connection.features.can_rollback_ddl:
2519.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2520.             with self.assertRaises(ValueError):
2521.                 with connection.schema_editor() as editor:
2522.                     atomic_migration.unapply(project_state, editor)
2523.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2524.             with self.assertRaises(ValueError):
2525.                 with connection.schema_editor() as editor:
2526.                     non_atomic_migration.unapply(project_state, editor)
2527.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2528.         # Otherwise, the non-atomic operation leaves a row there.
2529.         else:
2530.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2531.             with self.assertRaises(ValueError):
2532.                 with connection.schema_editor() as editor:
2533.                     atomic_migration.unapply(project_state, editor)
2534.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2535.             with self.assertRaises(ValueError):
2536.                 with connection.schema_editor() as editor:
2537.                     non_atomic_migration.unapply(project_state, editor)
2538.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 1)
2539.         # Verify deconstruction.
2540.         definition = non_atomic_migration.operations[0].deconstruct()
2541.         self.assertEqual(definition[0], "RunPython")
2542.         self.assertEqual(definition[1], [])
2543.         self.assertEqual(sorted(definition[2]), ["atomic", "code", "reverse_code"])
2544. 
2545.     def test_run_python_related_assignment(self):
2546.         """
2547.         #24282 - Model changes to a FK reverse side update the model
2548.         on the FK side as well.
2549.         """
2550. 
2551.         def inner_method(models, schema_editor):
2552.             Author = models.get_model("test_authors", "Author")
2553.             Book = models.get_model("test_books", "Book")
2554.             author = Author.objects.create(name="Hemingway")
2555.             Book.objects.create(title="Old Man and The Sea", author=author)
2556. 
2557.         create_author = migrations.CreateModel(
2558.             "Author",
2559.             [
2560.                 ("id", models.AutoField(primary_key=True)),
2561.                 ("name", models.CharField(max_length=100)),
2562.             ],
2563.             options={},
2564.         )
2565.         create_book = migrations.CreateModel(
2566.             "Book",
2567.             [
2568.                 ("id", models.AutoField(primary_key=True)),
2569.                 ("title", models.CharField(max_length=100)),
2570.                 ("author", models.ForeignKey("test_authors.Author", models.CASCADE))
2571.             ],
2572.             options={},
2573.         )
2574.         add_hometown = migrations.AddField(
2575.             "Author",
2576.             "hometown",
2577.             models.CharField(max_length=100),
2578.         )
2579.         create_old_man = migrations.RunPython(inner_method, inner_method)
2580. 
2581.         project_state = ProjectState()
2582.         new_state = project_state.clone()
2583.         with connection.schema_editor() as editor:
2584.             create_author.state_forwards("test_authors", new_state)
2585.             create_author.database_forwards("test_authors", editor, project_state, new_state)
2586.         project_state = new_state
2587.         new_state = new_state.clone()
2588.         with connection.schema_editor() as editor:
2589.             create_book.state_forwards("test_books", new_state)
2590.             create_book.database_forwards("test_books", editor, project_state, new_state)
2591.         project_state = new_state
2592.         new_state = new_state.clone()
2593.         with connection.schema_editor() as editor:
2594.             add_hometown.state_forwards("test_authors", new_state)
2595.             add_hometown.database_forwards("test_authors", editor, project_state, new_state)
2596.         project_state = new_state
2597.         new_state = new_state.clone()
2598.         with connection.schema_editor() as editor:
2599.             create_old_man.state_forwards("test_books", new_state)
2600.             create_old_man.database_forwards("test_books", editor, project_state, new_state)
2601. 
2602.     def test_model_with_bigautofield(self):
2603.         """
2604.         A model with BigAutoField can be created.
2605.         """
2606.         def create_data(models, schema_editor):
2607.             Author = models.get_model("test_author", "Author")
2608.             Book = models.get_model("test_book", "Book")
2609.             author1 = Author.objects.create(name="Hemingway")
2610.             Book.objects.create(title="Old Man and The Sea", author=author1)
2611.             Book.objects.create(id=2 ** 33, title="A farewell to arms", author=author1)
2612. 
2613.             author2 = Author.objects.create(id=2 ** 33, name="Remarque")
2614.             Book.objects.create(title="All quiet on the western front", author=author2)
2615.             Book.objects.create(title="Arc de Triomphe", author=author2)
2616. 
2617.         create_author = migrations.CreateModel(
2618.             "Author",
2619.             [
2620.                 ("id", models.BigAutoField(primary_key=True)),
2621.                 ("name", models.CharField(max_length=100)),
2622.             ],
2623.             options={},
2624.         )
2625.         create_book = migrations.CreateModel(
2626.             "Book",
2627.             [
2628.                 ("id", models.BigAutoField(primary_key=True)),
2629.                 ("title", models.CharField(max_length=100)),
2630.                 ("author", models.ForeignKey(to="test_author.Author", on_delete=models.CASCADE))
2631.             ],
2632.             options={},
2633.         )
2634.         fill_data = migrations.RunPython(create_data)
2635. 
2636.         project_state = ProjectState()
2637.         new_state = project_state.clone()
2638.         with connection.schema_editor() as editor:
2639.             create_author.state_forwards("test_author", new_state)
2640.             create_author.database_forwards("test_author", editor, project_state, new_state)
2641. 
2642.         project_state = new_state
2643.         new_state = new_state.clone()
2644.         with connection.schema_editor() as editor:
2645.             create_book.state_forwards("test_book", new_state)
2646.             create_book.database_forwards("test_book", editor, project_state, new_state)
2647. 
2648.         project_state = new_state
2649.         new_state = new_state.clone()
2650.         with connection.schema_editor() as editor:
2651.             fill_data.state_forwards("fill_data", new_state)
2652.             fill_data.database_forwards("fill_data", editor, project_state, new_state)
2653. 
2654.     def test_autofield_foreignfield_growth(self):
2655.         """
2656.         A field may be migrated from AutoField to BigAutoField.
2657.         """
2658.         def create_initial_data(models, schema_editor):
2659.             Article = models.get_model("test_article", "Article")
2660.             Blog = models.get_model("test_blog", "Blog")
2661.             blog = Blog.objects.create(name="web development done right")
2662.             Article.objects.create(name="Frameworks", blog=blog)
2663.             Article.objects.create(name="Programming Languages", blog=blog)
2664. 
2665.         def create_big_data(models, schema_editor):
2666.             Article = models.get_model("test_article", "Article")
2667.             Blog = models.get_model("test_blog", "Blog")
2668.             blog2 = Blog.objects.create(name="Frameworks", id=2 ** 33)
2669.             Article.objects.create(name="Django", blog=blog2)
2670.             Article.objects.create(id=2 ** 33, name="Django2", blog=blog2)
2671. 
2672.         create_blog = migrations.CreateModel(
2673.             "Blog",
2674.             [
2675.                 ("id", models.AutoField(primary_key=True)),
2676.                 ("name", models.CharField(max_length=100)),
2677.             ],
2678.             options={},
2679.         )
2680.         create_article = migrations.CreateModel(
2681.             "Article",
2682.             [
2683.                 ("id", models.AutoField(primary_key=True)),
2684.                 ("blog", models.ForeignKey(to="test_blog.Blog", on_delete=models.CASCADE)),
2685.                 ("name", models.CharField(max_length=100)),
2686.                 ("data", models.TextField(default="")),
2687.             ],
2688.             options={},
2689.         )
2690.         fill_initial_data = migrations.RunPython(create_initial_data, create_initial_data)
2691.         fill_big_data = migrations.RunPython(create_big_data, create_big_data)
2692. 
2693.         grow_article_id = migrations.AlterField("Article", "id", models.BigAutoField(primary_key=True))
2694.         grow_blog_id = migrations.AlterField("Blog", "id", models.BigAutoField(primary_key=True))
2695. 
2696.         project_state = ProjectState()
2697.         new_state = project_state.clone()
2698.         with connection.schema_editor() as editor:
2699.             create_blog.state_forwards("test_blog", new_state)
2700.             create_blog.database_forwards("test_blog", editor, project_state, new_state)
2701. 
2702.         project_state = new_state
2703.         new_state = new_state.clone()
2704.         with connection.schema_editor() as editor:
2705.             create_article.state_forwards("test_article", new_state)
2706.             create_article.database_forwards("test_article", editor, project_state, new_state)
2707. 
2708.         project_state = new_state
2709.         new_state = new_state.clone()
2710.         with connection.schema_editor() as editor:
2711.             fill_initial_data.state_forwards("fill_initial_data", new_state)
2712.             fill_initial_data.database_forwards("fill_initial_data", editor, project_state, new_state)
2713. 
2714.         project_state = new_state
2715.         new_state = new_state.clone()
2716.         with connection.schema_editor() as editor:
2717.             grow_article_id.state_forwards("test_article", new_state)
2718.             grow_article_id.database_forwards("test_article", editor, project_state, new_state)
2719. 
2720.         state = new_state.clone()
2721.         article = state.apps.get_model("test_article.Article")
2722.         self.assertIsInstance(article._meta.pk, models.BigAutoField)
2723. 
2724.         project_state = new_state
2725.         new_state = new_state.clone()
2726.         with connection.schema_editor() as editor:
2727.             grow_blog_id.state_forwards("test_blog", new_state)
2728.             grow_blog_id.database_forwards("test_blog", editor, project_state, new_state)
2729. 
2730.         state = new_state.clone()
2731.         blog = state.apps.get_model("test_blog.Blog")
2732.         self.assertIsInstance(blog._meta.pk, models.BigAutoField)
2733. 
2734.         project_state = new_state
2735.         new_state = new_state.clone()
2736.         with connection.schema_editor() as editor:
2737.             fill_big_data.state_forwards("fill_big_data", new_state)
2738.             fill_big_data.database_forwards("fill_big_data", editor, project_state, new_state)
2739. 
2740.     def test_run_python_noop(self):
2741.         """
2742.         #24098 - Tests no-op RunPython operations.
2743.         """
2744.         project_state = ProjectState()
2745.         new_state = project_state.clone()
2746.         operation = migrations.RunPython(migrations.RunPython.noop, migrations.RunPython.noop)
2747.         with connection.schema_editor() as editor:
2748.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2749.             operation.database_backwards("test_runpython", editor, new_state, project_state)
2750. 
2751.     def test_separate_database_and_state(self):
2752.         """
2753.         Tests the SeparateDatabaseAndState operation.
2754.         """
2755.         project_state = self.set_up_test_model("test_separatedatabaseandstate")
2756.         # Create the operation
2757.         database_operation = migrations.RunSQL(
2758.             "CREATE TABLE i_love_ponies (id int, special_thing int);",
2759.             "DROP TABLE i_love_ponies;"
2760.         )
2761.         state_operation = migrations.CreateModel("SomethingElse", [("id", models.AutoField(primary_key=True))])
2762.         operation = migrations.SeparateDatabaseAndState(
2763.             state_operations=[state_operation],
2764.             database_operations=[database_operation]
2765.         )
2766.         self.assertEqual(operation.describe(), "Custom state/database change combination")
2767.         # Test the state alteration
2768.         new_state = project_state.clone()
2769.         operation.state_forwards("test_separatedatabaseandstate", new_state)
2770.         self.assertEqual(len(new_state.models["test_separatedatabaseandstate", "somethingelse"].fields), 1)
2771.         # Make sure there's no table
2772.         self.assertTableNotExists("i_love_ponies")
2773.         # Test the database alteration
2774.         with connection.schema_editor() as editor:
2775.             operation.database_forwards("test_separatedatabaseandstate", editor, project_state, new_state)
2776.         self.assertTableExists("i_love_ponies")
2777.         # And test reversal
2778.         self.assertTrue(operation.reversible)
2779.         with connection.schema_editor() as editor:
2780.             operation.database_backwards("test_separatedatabaseandstate", editor, new_state, project_state)
2781.         self.assertTableNotExists("i_love_ponies")
2782.         # And deconstruction
2783.         definition = operation.deconstruct()
2784.         self.assertEqual(definition[0], "SeparateDatabaseAndState")
2785.         self.assertEqual(definition[1], [])
2786.         self.assertEqual(sorted(definition[2]), ["database_operations", "state_operations"])
2787. 
2788.     def test_separate_database_and_state2(self):
2789.         """
2790.         A complex SeparateDatabaseAndState operation: Multiple operations both
2791.         for state and database. Verify the state dependencies within each list
2792.         and that state ops don't affect the database.
2793.         """
2794.         app_label = "test_separatedatabaseandstate2"
2795.         project_state = self.set_up_test_model(app_label)
2796.         # Create the operation
2797.         database_operations = [
2798.             migrations.CreateModel(
2799.                 "ILovePonies",
2800.                 [("id", models.AutoField(primary_key=True))],
2801.                 options={"db_table": "iloveponies"},
2802.             ),
2803.             migrations.CreateModel(
2804.                 "ILoveMorePonies",
2805.                 # We use IntegerField and not AutoField because
2806.                 # the model is going to be deleted immediately
2807.                 # and with an AutoField this fails on Oracle
2808.                 [("id", models.IntegerField(primary_key=True))],
2809.                 options={"db_table": "ilovemoreponies"},
2810.             ),
2811.             migrations.DeleteModel("ILoveMorePonies"),
2812.             migrations.CreateModel(
2813.                 "ILoveEvenMorePonies",
2814.                 [("id", models.AutoField(primary_key=True))],
2815.                 options={"db_table": "iloveevenmoreponies"},
2816.             ),
2817.         ]
2818.         state_operations = [
2819.             migrations.CreateModel(
2820.                 "SomethingElse",
2821.                 [("id", models.AutoField(primary_key=True))],
2822.                 options={"db_table": "somethingelse"},
2823.             ),
2824.             migrations.DeleteModel("SomethingElse"),
2825.             migrations.CreateModel(
2826.                 "SomethingCompletelyDifferent",
2827.                 [("id", models.AutoField(primary_key=True))],
2828.                 options={"db_table": "somethingcompletelydifferent"},
2829.             ),
2830.         ]
2831.         operation = migrations.SeparateDatabaseAndState(
2832.             state_operations=state_operations,
2833.             database_operations=database_operations,
2834.         )
2835.         # Test the state alteration
2836.         new_state = project_state.clone()
2837.         operation.state_forwards(app_label, new_state)
2838. 
2839.         def assertModelsAndTables(after_db):
2840.             # Tables and models exist, or don't, as they should:
2841.             self.assertNotIn((app_label, "somethingelse"), new_state.models)
2842.             self.assertEqual(len(new_state.models[app_label, "somethingcompletelydifferent"].fields), 1)
2843.             self.assertNotIn((app_label, "iloveponiesonies"), new_state.models)
2844.             self.assertNotIn((app_label, "ilovemoreponies"), new_state.models)
2845.             self.assertNotIn((app_label, "iloveevenmoreponies"), new_state.models)
2846.             self.assertTableNotExists("somethingelse")
2847.             self.assertTableNotExists("somethingcompletelydifferent")
2848.             self.assertTableNotExists("ilovemoreponies")
2849.             if after_db:
2850.                 self.assertTableExists("iloveponies")
2851.                 self.assertTableExists("iloveevenmoreponies")
2852.             else:
2853.                 self.assertTableNotExists("iloveponies")
2854.                 self.assertTableNotExists("iloveevenmoreponies")
2855. 
2856.         assertModelsAndTables(after_db=False)
2857.         # Test the database alteration
2858.         with connection.schema_editor() as editor:
2859.             operation.database_forwards(app_label, editor, project_state, new_state)
2860.         assertModelsAndTables(after_db=True)
2861.         # And test reversal
2862.         self.assertTrue(operation.reversible)
2863.         with connection.schema_editor() as editor:
2864.             operation.database_backwards(app_label, editor, new_state, project_state)
2865.         assertModelsAndTables(after_db=False)

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 22:18:13,112 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The provided context is a good starting point, containing tests for multi-database operations (`test_multidb.py`) and for `RenameModel`/`RenameContentType` (`test_operations.py` and `contenttypes_tests/test_operations.py`). However, no single test combines these two aspects, which is the core of the bug. The bug occurs when a `RenameModel` migration is run on a non-default database. To find a relevant test, I need to see how Django tests the `migrate` command when targeting a specific, non-default database and how it asserts that model `save()` calls within migrations are correctly routed.' query='Please provide the full content of the files `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`.' extra_requirements='' purpose='These files are essential for finding test cases that demonstrate running migrations on a non-default database and verifying that ORM operations within those migrations are correctly routed, which is the exact scenario described in the bug report.'
2025-12-23 22:18:13,113 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of the files `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`.
2025-12-23 22:18:13,113 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 22:18:13,113 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 22:18:13,114 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 22:18:13,114 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of the files `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`.
Purpose: These files are essential for finding test cases that demonstrate running migrations on a non-default database and verifying that ORM operations within those migrations are correctly routed, which is the exact scenario described in the bug report.
2025-12-23 22:18:15,471 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I will read the full content of the two requested files, `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`, to find test cases related to running migrations on a non-default database. This will help verify that ORM operations within those migrations are correctly routed as described in the bug report.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/migrations/test_commands.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2123, 'candidates_token_count': 117, 'total_token_count': 2313, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2123}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 117}], 'thoughts_token_count': 73, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.03006531845810067, 'model_name': 'gemini-2.5-pro'} id='run--d4e3374d-ab2c-4957-8968-989eaed091fe-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/multiple_database/tests.py'}, 'id': '46b5bb1e-364a-4f7f-865f-545005c0dc43', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/migrations/test_commands.py'}, 'id': '854dad2c-6836-437b-9256-114f5caa782d', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2123, 'output_tokens': 117, 'total_tokens': 2313, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 73}}
2025-12-23 22:18:20,858 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the contents of `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`. I will now proceed to analyze these files to identify the specific test cases that are relevant to running migrations on a non-default database and ensuring correct ORM routing within those migrations. This analysis will help in understanding how to address the bug report.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"relative_path": "tests/migrations/test_commands.py", "text": "migrate"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 19430, 'candidates_token_count': 112, 'total_token_count': 19939, 'cached_content_token_count': 1899, 'prompt_tokens_details': [{'modality': 1, 'token_count': 19430}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1899}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 112}], 'thoughts_token_count': 397}, 'finish_reason': 'STOP', 'avg_logprobs': -0.43009778431483675, 'model_name': 'gemini-2.5-pro'} id='run--c484dda8-5210-4077-aa83-474bf0330492-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'relative_path': 'tests/migrations/test_commands.py', 'text': 'migrate'}, 'id': '927ff291-ec85-4599-881a-adfb7c7f4515', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19430, 'output_tokens': 112, 'total_tokens': 19939, 'input_token_details': {'cache_read': 1899}, 'output_token_details': {'reasoning': 397}}
2025-12-23 22:18:25,424 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I have analyzed the content of `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`. The former focuses on multi-database model operations, while the latter contains tests for the `migrate` command. Within `tests/migrations/test_commands.py`, I've identified the `MigrateTests` class as the most relevant area for finding test cases related to database migrations. I will now search for usages of the `--database` option within this class to pinpoint tests that demonstrate running migrations on a non-default database." additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"relative_path": "tests/migrations/test_commands.py", "text": "database="}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 40330, 'candidates_token_count': 151, 'total_token_count': 40714, 'cached_content_token_count': 19122, 'prompt_tokens_details': [{'modality': 1, 'token_count': 40330}], 'cache_tokens_details': [{'modality': 1, 'token_count': 19122}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 151}], 'thoughts_token_count': 233}, 'finish_reason': 'STOP', 'avg_logprobs': -0.2139258732069407, 'model_name': 'gemini-2.5-pro'} id='run--605127a9-dfe2-47cf-ae45-511ef357d804-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'relative_path': 'tests/migrations/test_commands.py', 'text': 'database='}, 'id': '0bd344bf-af71-4e3d-842a-7a361b7bd18e', 'type': 'tool_call'}] usage_metadata={'input_tokens': 40330, 'output_tokens': 151, 'total_tokens': 40714, 'input_token_details': {'cache_read': 19122}, 'output_token_details': {'reasoning': 233}}
2025-12-23 22:18:29,230 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have located the `test_migrate_fake_initial` test within the `MigrateTests` class in `tests/migrations/test_commands.py`. This test is significant because it explicitly uses the `--database` option to run migrations on a non-default database named "other". I will now examine the implementation of this test to understand how it verifies the correct behavior of migrations in a multi-database setup, which will provide the context needed to address the bug report.' additional_kwargs={'function_call': {'name': 'read_code_with_relative_path', 'arguments': '{"end_line": 199.0, "relative_path": "tests/migrations/test_commands.py", "start_line": 125.0}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 50970, 'candidates_token_count': 127, 'total_token_count': 51245, 'cached_content_token_count': 40178, 'prompt_tokens_details': [{'modality': 1, 'token_count': 50970}], 'cache_tokens_details': [{'modality': 1, 'token_count': 40178}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 127}], 'thoughts_token_count': 148}, 'finish_reason': 'STOP', 'avg_logprobs': -0.15503393758939008, 'model_name': 'gemini-2.5-pro'} id='run--2c55f3f4-7cce-4138-9244-417867ce4b93-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'end_line': 199.0, 'relative_path': 'tests/migrations/test_commands.py', 'start_line': 125.0}, 'id': '727174b2-c0a0-440e-a238-06b904e15766', 'type': 'tool_call'}] usage_metadata={'input_tokens': 50970, 'output_tokens': 127, 'total_tokens': 51245, 'input_token_details': {'cache_read': 40178}, 'output_token_details': {'reasoning': 148}}
2025-12-23 22:18:32,595 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I have successfully gathered the necessary context to address the user's query. I began by reading the full content of both `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`. My analysis of these files led me to focus on the `MigrateTests` class within `tests/migrations/test_commands.py`, where I identified the `test_migrate_fake_initial` test as being particularly relevant. This test demonstrates the use of the `--database` option to run migrations on a non-default database, which is central to the user's problem. I then examined the implementation of this test to understand how it verifies the correct behavior of migrations in a multi-database environment." additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 52570, 'candidates_token_count': 151, 'total_token_count': 52839, 'cached_content_token_count': 49753, 'prompt_tokens_details': [{'modality': 1, 'token_count': 52570}], 'cache_tokens_details': [{'modality': 1, 'token_count': 49753}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 151}], 'thoughts_token_count': 118}, 'finish_reason': 'STOP', 'avg_logprobs': -0.1300700737151089, 'model_name': 'gemini-2.5-pro'} id='run--f5be5035-0c01-4006-9a36-3cd69677bbcb-0' usage_metadata={'input_tokens': 52570, 'output_tokens': 151, 'total_tokens': 52839, 'input_token_details': {'cache_read': 49753}, 'output_token_details': {'reasoning': 118}}
2025-12-23 22:18:32,598 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of the files `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
These files are essential for finding test cases that demonstrate running migrations on a non-default database and verifying that ORM operations within those migrations are correctly routed, which is the exact scenario described in the bug report.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: tests/migrations/test_commands.py
Line number range: 1 - 500
Content:
1. import datetime
2. import importlib
3. import io
4. import os
5. import sys
6. from unittest import mock
7. 
8. from django.apps import apps
9. from django.core.management import CommandError, call_command
10. from django.db import (
11.     ConnectionHandler, DatabaseError, connection, connections, models,
12. )
13. from django.db.backends.base.schema import BaseDatabaseSchemaEditor
14. from django.db.backends.utils import truncate_name
15. from django.db.migrations.exceptions import InconsistentMigrationHistory
16. from django.db.migrations.recorder import MigrationRecorder
17. from django.test import TestCase, override_settings
18. 
19. from .models import UnicodeModel, UnserializableModel
20. from .routers import TestRouter
21. from .test_base import MigrationTestBase
22. 
23. 
24. class MigrateTests(MigrationTestBase):
25.     """
26.     Tests running the migrate command.
27.     """
28.     databases = {'default', 'other'}
29. 
30.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
31.     def test_migrate(self):
32.         """
33.         Tests basic usage of the migrate command.
34.         """
35.         # No tables are created
36.         self.assertTableNotExists("migrations_author")
37.         self.assertTableNotExists("migrations_tribble")
38.         self.assertTableNotExists("migrations_book")
39.         # Run the migrations to 0001 only
40.         stdout = io.StringIO()
41.         call_command('migrate', 'migrations', '0001', verbosity=1, stdout=stdout, no_color=True)
42.         stdout = stdout.getvalue()
43.         self.assertIn('Target specific migration: 0001_initial, from migrations', stdout)
44.         self.assertIn('Applying migrations.0001_initial... OK', stdout)
45.         # The correct tables exist
46.         self.assertTableExists("migrations_author")
47.         self.assertTableExists("migrations_tribble")
48.         self.assertTableNotExists("migrations_book")
49.         # Run migrations all the way
50.         call_command("migrate", verbosity=0)
51.         # The correct tables exist
52.         self.assertTableExists("migrations_author")
53.         self.assertTableNotExists("migrations_tribble")
54.         self.assertTableExists("migrations_book")
55.         # Unmigrate everything
56.         stdout = io.StringIO()
57.         call_command('migrate', 'migrations', 'zero', verbosity=1, stdout=stdout, no_color=True)
58.         stdout = stdout.getvalue()
59.         self.assertIn('Unapply all migrations: migrations', stdout)
60.         self.assertIn('Unapplying migrations.0002_second... OK', stdout)
61.         # Tables are gone
62.         self.assertTableNotExists("migrations_author")
63.         self.assertTableNotExists("migrations_tribble")
64.         self.assertTableNotExists("migrations_book")
65. 
66.     @override_settings(INSTALLED_APPS=[
67.         'django.contrib.auth',
68.         'django.contrib.contenttypes',
69.         'migrations.migrations_test_apps.migrated_app',
70.     ])
71.     def test_migrate_with_system_checks(self):
72.         out = io.StringIO()
73.         call_command('migrate', skip_checks=False, no_color=True, stdout=out)
74.         self.assertIn('Apply all migrations: migrated_app', out.getvalue())
75. 
76.     @override_settings(INSTALLED_APPS=['migrations', 'migrations.migrations_test_apps.unmigrated_app_syncdb'])
77.     def test_app_without_migrations(self):
78.         msg = "App 'unmigrated_app_syncdb' does not have migrations."
79.         with self.assertRaisesMessage(CommandError, msg):
80.             call_command('migrate', app_label='unmigrated_app_syncdb')
81. 
82.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_clashing_prefix'})
83.     def test_ambigious_prefix(self):
84.         msg = (
85.             "More than one migration matches 'a' in app 'migrations'. Please "
86.             "be more specific."
87.         )
88.         with self.assertRaisesMessage(CommandError, msg):
89.             call_command('migrate', app_label='migrations', migration_name='a')
90. 
91.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
92.     def test_unknown_prefix(self):
93.         msg = "Cannot find a migration matching 'nonexistent' from app 'migrations'."
94.         with self.assertRaisesMessage(CommandError, msg):
95.             call_command('migrate', app_label='migrations', migration_name='nonexistent')
96. 
97.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_initial_false"})
98.     def test_migrate_initial_false(self):
99.         """
100.         `Migration.initial = False` skips fake-initial detection.
101.         """
102.         # Make sure no tables are created
103.         self.assertTableNotExists("migrations_author")
104.         self.assertTableNotExists("migrations_tribble")
105.         # Run the migrations to 0001 only
106.         call_command("migrate", "migrations", "0001", verbosity=0)
107.         # Fake rollback
108.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
109.         # Make sure fake-initial detection does not run
110.         with self.assertRaises(DatabaseError):
111.             call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0)
112. 
113.         call_command("migrate", "migrations", "0001", fake=True, verbosity=0)
114.         # Real rollback
115.         call_command("migrate", "migrations", "zero", verbosity=0)
116.         # Make sure it's all gone
117.         self.assertTableNotExists("migrations_author")
118.         self.assertTableNotExists("migrations_tribble")
119.         self.assertTableNotExists("migrations_book")
120. 
121.     @override_settings(
122.         MIGRATION_MODULES={"migrations": "migrations.test_migrations"},
123.         DATABASE_ROUTERS=['migrations.routers.TestRouter'],
124.     )
125.     def test_migrate_fake_initial(self):
126.         """
127.         --fake-initial only works if all tables created in the initial
128.         migration of an app exists. Database routers must be obeyed when doing
129.         that check.
130.         """
131.         # Make sure no tables are created
132.         for db in connections:
133.             self.assertTableNotExists("migrations_author", using=db)
134.             self.assertTableNotExists("migrations_tribble", using=db)
135.         # Run the migrations to 0001 only
136.         call_command("migrate", "migrations", "0001", verbosity=0)
137.         call_command("migrate", "migrations", "0001", verbosity=0, database="other")
138.         # Make sure the right tables exist
139.         self.assertTableExists("migrations_author")
140.         self.assertTableNotExists("migrations_tribble")
141.         # Also check the "other" database
142.         self.assertTableNotExists("migrations_author", using="other")
143.         self.assertTableExists("migrations_tribble", using="other")
144. 
145.         # Fake a roll-back
146.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
147.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
148.         # Make sure the tables still exist
149.         self.assertTableExists("migrations_author")
150.         self.assertTableExists("migrations_tribble", using="other")
151.         # Try to run initial migration
152.         with self.assertRaises(DatabaseError):
153.             call_command("migrate", "migrations", "0001", verbosity=0)
154.         # Run initial migration with an explicit --fake-initial
155.         out = io.StringIO()
156.         with mock.patch('django.core.management.color.supports_color', lambda *args: False):
157.             call_command("migrate", "migrations", "0001", fake_initial=True, stdout=out, verbosity=1)
158.             call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0, database="other")
159.         self.assertIn(
160.             "migrations.0001_initial... faked",
161.             out.getvalue().lower()
162.         )
163.         # Run migrations all the way
164.         call_command("migrate", verbosity=0)
165.         call_command("migrate", verbosity=0, database="other")
166.         # Make sure the right tables exist
167.         self.assertTableExists("migrations_author")
168.         self.assertTableNotExists("migrations_tribble")
169.         self.assertTableExists("migrations_book")
170.         self.assertTableNotExists("migrations_author", using="other")
171.         self.assertTableNotExists("migrations_tribble", using="other")
172.         self.assertTableNotExists("migrations_book", using="other")
173.         # Fake a roll-back
174.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
175.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
176.         # Make sure the tables still exist
177.         self.assertTableExists("migrations_author")
178.         self.assertTableNotExists("migrations_tribble")
179.         self.assertTableExists("migrations_book")
180.         # Try to run initial migration
181.         with self.assertRaises(DatabaseError):
182.             call_command("migrate", "migrations", verbosity=0)
183.         # Run initial migration with an explicit --fake-initial
184.         with self.assertRaises(DatabaseError):
185.             # Fails because "migrations_tribble" does not exist but needs to in
186.             # order to make --fake-initial work.
187.             call_command("migrate", "migrations", fake_initial=True, verbosity=0)
188.         # Fake an apply
189.         call_command("migrate", "migrations", fake=True, verbosity=0)
190.         call_command("migrate", "migrations", fake=True, verbosity=0, database="other")
191.         # Unmigrate everything
192.         call_command("migrate", "migrations", "zero", verbosity=0)
193.         call_command("migrate", "migrations", "zero", verbosity=0, database="other")
194.         # Make sure it's all gone
195.         for db in connections:
196.             self.assertTableNotExists("migrations_author", using=db)
197.             self.assertTableNotExists("migrations_tribble", using=db)
198.             self.assertTableNotExists("migrations_book", using=db)
199. 
200.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_fake_split_initial"})
201.     def test_migrate_fake_split_initial(self):
202.         """
203.         Split initial migrations can be faked with --fake-initial.
204.         """
205.         call_command("migrate", "migrations", "0002", verbosity=0)
206.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
207.         out = io.StringIO()
208.         with mock.patch('django.core.management.color.supports_color', lambda *args: False):
209.             call_command("migrate", "migrations", "0002", fake_initial=True, stdout=out, verbosity=1)
210.         value = out.getvalue().lower()
211.         self.assertIn("migrations.0001_initial... faked", value)
212.         self.assertIn("migrations.0002_second... faked", value)
213.         # Fake an apply
214.         call_command("migrate", "migrations", fake=True, verbosity=0)
215.         # Unmigrate everything
216.         call_command("migrate", "migrations", "zero", verbosity=0)
217. 
218.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_conflict"})
219.     def test_migrate_conflict_exit(self):
220.         """
221.         migrate exits if it detects a conflict.
222.         """
223.         with self.assertRaisesMessage(CommandError, "Conflicting migrations detected"):
224.             call_command("migrate", "migrations")
225. 
226.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
227.     def test_showmigrations_list(self):
228.         """
229.         showmigrations --list  displays migrations and whether or not they're
230.         applied.
231.         """
232.         out = io.StringIO()
233.         with mock.patch('django.core.management.color.supports_color', lambda *args: True):
234.             call_command("showmigrations", format='list', stdout=out, verbosity=0, no_color=False)
235.         self.assertEqual(
236.             '\x1b[1mmigrations\n\x1b[0m'
237.             ' [ ] 0001_initial\n'
238.             ' [ ] 0002_second\n',
239.             out.getvalue().lower()
240.         )
241. 
242.         call_command("migrate", "migrations", "0001", verbosity=0)
243. 
244.         out = io.StringIO()
245.         # Giving the explicit app_label tests for selective `show_list` in the command
246.         call_command("showmigrations", "migrations", format='list', stdout=out, verbosity=0, no_color=True)
247.         self.assertEqual(
248.             'migrations\n'
249.             ' [x] 0001_initial\n'
250.             ' [ ] 0002_second\n',
251.             out.getvalue().lower()
252.         )
253.         out = io.StringIO()
254.         # Applied datetimes are displayed at verbosity 2+.
255.         call_command('showmigrations', 'migrations', stdout=out, verbosity=2, no_color=True)
256.         migration1 = MigrationRecorder(connection).migration_qs.get(app='migrations', name='0001_initial')
257.         self.assertEqual(
258.             'migrations\n'
259.             ' [x] 0001_initial (applied at %s)\n'
260.             ' [ ] 0002_second\n' % migration1.applied.strftime('%Y-%m-%d %H:%M:%S'),
261.             out.getvalue().lower()
262.         )
263.         # Cleanup by unmigrating everything
264.         call_command("migrate", "migrations", "zero", verbosity=0)
265. 
266.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_run_before"})
267.     def test_showmigrations_plan(self):
268.         """
269.         Tests --plan output of showmigrations command
270.         """
271.         out = io.StringIO()
272.         call_command("showmigrations", format='plan', stdout=out)
273.         self.assertEqual(
274.             "[ ]  migrations.0001_initial\n"
275.             "[ ]  migrations.0003_third\n"
276.             "[ ]  migrations.0002_second\n",
277.             out.getvalue().lower()
278.         )
279. 
280.         out = io.StringIO()
281.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
282.         self.assertEqual(
283.             "[ ]  migrations.0001_initial\n"
284.             "[ ]  migrations.0003_third ... (migrations.0001_initial)\n"
285.             "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
286.             out.getvalue().lower()
287.         )
288.         call_command("migrate", "migrations", "0003", verbosity=0)
289. 
290.         out = io.StringIO()
291.         call_command("showmigrations", format='plan', stdout=out)
292.         self.assertEqual(
293.             "[x]  migrations.0001_initial\n"
294.             "[x]  migrations.0003_third\n"
295.             "[ ]  migrations.0002_second\n",
296.             out.getvalue().lower()
297.         )
298. 
299.         out = io.StringIO()
300.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
301.         self.assertEqual(
302.             "[x]  migrations.0001_initial\n"
303.             "[x]  migrations.0003_third ... (migrations.0001_initial)\n"
304.             "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
305.             out.getvalue().lower()
306.         )
307. 
308.         # Cleanup by unmigrating everything
309.         call_command("migrate", "migrations", "zero", verbosity=0)
310. 
311.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_plan'})
312.     def test_migrate_plan(self):
313.         """Tests migrate --plan output."""
314.         out = io.StringIO()
315.         # Show the plan up to the third migration.
316.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
317.         self.assertEqual(
318.             'Planned operations:\n'
319.             'migrations.0001_initial\n'
320.             '    Create model Salamander\n'
321.             '    Raw Python operation -> Grow salamander tail.\n'
322.             'migrations.0002_second\n'
323.             '    Create model Book\n'
324.             "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
325.             'migrations.0003_third\n'
326.             '    Create model Author\n'
327.             "    Raw SQL operation -> ['SELECT * FROM migrations_author']\n",
328.             out.getvalue()
329.         )
330.         # Migrate to the third migration.
331.         call_command('migrate', 'migrations', '0003', verbosity=0)
332.         out = io.StringIO()
333.         # Show the plan for when there is nothing to apply.
334.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
335.         self.assertEqual(
336.             'Planned operations:\n'
337.             '  No planned migration operations.\n',
338.             out.getvalue()
339.         )
340.         out = io.StringIO()
341.         # Show the plan for reverse migration back to 0001.
342.         call_command('migrate', 'migrations', '0001', plan=True, stdout=out, no_color=True)
343.         self.assertEqual(
344.             'Planned operations:\n'
345.             'migrations.0003_third\n'
346.             '    Undo Create model Author\n'
347.             "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
348.             'migrations.0002_second\n'
349.             '    Undo Create model Book\n'
350.             "    Raw SQL operation -> ['SELECT * FROM migrations_salamand…\n",
351.             out.getvalue()
352.         )
353.         out = io.StringIO()
354.         # Show the migration plan to fourth, with truncated details.
355.         call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
356.         self.assertEqual(
357.             'Planned operations:\n'
358.             'migrations.0004_fourth\n'
359.             '    Raw SQL operation -> SELECT * FROM migrations_author WHE…\n',
360.             out.getvalue()
361.         )
362.         # Show the plan when an operation is irreversible.
363.         # Migrate to the fourth migration.
364.         call_command('migrate', 'migrations', '0004', verbosity=0)
365.         out = io.StringIO()
366.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
367.         self.assertEqual(
368.             'Planned operations:\n'
369.             'migrations.0004_fourth\n'
370.             '    Raw SQL operation -> IRREVERSIBLE\n',
371.             out.getvalue()
372.         )
373.         # Cleanup by unmigrating everything: fake the irreversible, then
374.         # migrate all to zero.
375.         call_command('migrate', 'migrations', '0003', fake=True, verbosity=0)
376.         call_command('migrate', 'migrations', 'zero', verbosity=0)
377. 
378.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_empty'})
379.     def test_showmigrations_no_migrations(self):
380.         out = io.StringIO()
381.         call_command('showmigrations', stdout=out, no_color=True)
382.         self.assertEqual('migrations\n (no migrations)\n', out.getvalue().lower())
383. 
384.     @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app'])
385.     def test_showmigrations_unmigrated_app(self):
386.         out = io.StringIO()
387.         call_command('showmigrations', 'unmigrated_app', stdout=out, no_color=True)
388.         self.assertEqual('unmigrated_app\n (no migrations)\n', out.getvalue().lower())
389. 
390.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_empty"})
391.     def test_showmigrations_plan_no_migrations(self):
392.         """
393.         Tests --plan output of showmigrations command without migrations
394.         """
395.         out = io.StringIO()
396.         call_command('showmigrations', format='plan', stdout=out, no_color=True)
397.         self.assertEqual('(no migrations)\n', out.getvalue().lower())
398. 
399.         out = io.StringIO()
400.         call_command('showmigrations', format='plan', stdout=out, verbosity=2, no_color=True)
401.         self.assertEqual('(no migrations)\n', out.getvalue().lower())
402. 
403.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed_complex"})
404.     def test_showmigrations_plan_squashed(self):
405.         """
406.         Tests --plan output of showmigrations command with squashed migrations.
407.         """
408.         out = io.StringIO()
409.         call_command("showmigrations", format='plan', stdout=out)
410.         self.assertEqual(
411.             "[ ]  migrations.1_auto\n"
412.             "[ ]  migrations.2_auto\n"
413.             "[ ]  migrations.3_squashed_5\n"
414.             "[ ]  migrations.6_auto\n"
415.             "[ ]  migrations.7_auto\n",
416.             out.getvalue().lower()
417.         )
418. 
419.         out = io.StringIO()
420.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
421.         self.assertEqual(
422.             "[ ]  migrations.1_auto\n"
423.             "[ ]  migrations.2_auto ... (migrations.1_auto)\n"
424.             "[ ]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
425.             "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
426.             "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
427.             out.getvalue().lower()
428.         )
429. 
430.         call_command("migrate", "migrations", "3_squashed_5", verbosity=0)
431. 
432.         out = io.StringIO()
433.         call_command("showmigrations", format='plan', stdout=out)
434.         self.assertEqual(
435.             "[x]  migrations.1_auto\n"
436.             "[x]  migrations.2_auto\n"
437.             "[x]  migrations.3_squashed_5\n"
438.             "[ ]  migrations.6_auto\n"
439.             "[ ]  migrations.7_auto\n",
440.             out.getvalue().lower()
441.         )
442. 
443.         out = io.StringIO()
444.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
445.         self.assertEqual(
446.             "[x]  migrations.1_auto\n"
447.             "[x]  migrations.2_auto ... (migrations.1_auto)\n"
448.             "[x]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
449.             "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
450.             "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
451.             out.getvalue().lower()
452.         )
453. 
454.     @override_settings(INSTALLED_APPS=[
455.         'migrations.migrations_test_apps.mutate_state_b',
456.         'migrations.migrations_test_apps.alter_fk.author_app',
457.         'migrations.migrations_test_apps.alter_fk.book_app',
458.     ])
459.     def test_showmigrations_plan_single_app_label(self):
460.         """
461.         `showmigrations --plan app_label` output with a single app_label.
462.         """
463.         # Single app with no dependencies on other apps.
464.         out = io.StringIO()
465.         call_command('showmigrations', 'mutate_state_b', format='plan', stdout=out)
466.         self.assertEqual(
467.             '[ ]  mutate_state_b.0001_initial\n'
468.             '[ ]  mutate_state_b.0002_add_field\n',
469.             out.getvalue()
470.         )
471.         # Single app with dependencies.
472.         out = io.StringIO()
473.         call_command('showmigrations', 'author_app', format='plan', stdout=out)
474.         self.assertEqual(
475.             '[ ]  author_app.0001_initial\n'
476.             '[ ]  book_app.0001_initial\n'
477.             '[ ]  author_app.0002_alter_id\n',
478.             out.getvalue()
479.         )
480.         # Some migrations already applied.
481.         call_command('migrate', 'author_app', '0001', verbosity=0)
482.         out = io.StringIO()
483.         call_command('showmigrations', 'author_app', format='plan', stdout=out)
484.         self.assertEqual(
485.             '[X]  author_app.0001_initial\n'
486.             '[ ]  book_app.0001_initial\n'
487.             '[ ]  author_app.0002_alter_id\n',
488.             out.getvalue()
489.         )
490.         # Cleanup by unmigrating author_app.
491.         call_command('migrate', 'author_app', 'zero', verbosity=0)
492. 
493.     @override_settings(INSTALLED_APPS=[
494.         'migrations.migrations_test_apps.mutate_state_b',
495.         'migrations.migrations_test_apps.alter_fk.author_app',
496.         'migrations.migrations_test_apps.alter_fk.book_app',
497.     ])
498.     def test_showmigrations_plan_multiple_app_labels(self):
499.         """
500.         `showmigrations --plan app_label` output with multiple app_labels.


File: tests/migrations/test_commands.py
Line number range: 24 - 775
Content:
class MigrateTests(MigrationTestBase):
    """
    Tests running the migrate command.
    """
    databases = {'default', 'other'}

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
    def test_migrate(self):
        """
        Tests basic usage of the migrate command.
        """
        # No tables are created
        self.assertTableNotExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        self.assertTableNotExists("migrations_book")
        # Run the migrations to 0001 only
        stdout = io.StringIO()
        call_command('migrate', 'migrations', '0001', verbosity=1, stdout=stdout, no_color=True)
        stdout = stdout.getvalue()
        self.assertIn('Target specific migration: 0001_initial, from migrations', stdout)
        self.assertIn('Applying migrations.0001_initial... OK', stdout)
        # The correct tables exist
        self.assertTableExists("migrations_author")
        self.assertTableExists("migrations_tribble")
        self.assertTableNotExists("migrations_book")
        # Run migrations all the way
        call_command("migrate", verbosity=0)
        # The correct tables exist
        self.assertTableExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        self.assertTableExists("migrations_book")
        # Unmigrate everything
        stdout = io.StringIO()
        call_command('migrate', 'migrations', 'zero', verbosity=1, stdout=stdout, no_color=True)
        stdout = stdout.getvalue()
        self.assertIn('Unapply all migrations: migrations', stdout)
        self.assertIn('Unapplying migrations.0002_second... OK', stdout)
        # Tables are gone
        self.assertTableNotExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        self.assertTableNotExists("migrations_book")

    @override_settings(INSTALLED_APPS=[
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'migrations.migrations_test_apps.migrated_app',
    ])
    def test_migrate_with_system_checks(self):
        out = io.StringIO()
        call_command('migrate', skip_checks=False, no_color=True, stdout=out)
        self.assertIn('Apply all migrations: migrated_app', out.getvalue())

    @override_settings(INSTALLED_APPS=['migrations', 'migrations.migrations_test_apps.unmigrated_app_syncdb'])
    def test_app_without_migrations(self):
        msg = "App 'unmigrated_app_syncdb' does not have migrations."
        with self.assertRaisesMessage(CommandError, msg):
            call_command('migrate', app_label='unmigrated_app_syncdb')

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_clashing_prefix'})
    def test_ambigious_prefix(self):
        msg = (
            "More than one migration matches 'a' in app 'migrations'. Please "
            "be more specific."
        )
        with self.assertRaisesMessage(CommandError, msg):
            call_command('migrate', app_label='migrations', migration_name='a')

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
    def test_unknown_prefix(self):
        msg = "Cannot find a migration matching 'nonexistent' from app 'migrations'."
        with self.assertRaisesMessage(CommandError, msg):
            call_command('migrate', app_label='migrations', migration_name='nonexistent')

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_initial_false"})
    def test_migrate_initial_false(self):
        """
        `Migration.initial = False` skips fake-initial detection.
        """
        # Make sure no tables are created
        self.assertTableNotExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        # Run the migrations to 0001 only
        call_command("migrate", "migrations", "0001", verbosity=0)
        # Fake rollback
        call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
        # Make sure fake-initial detection does not run
        with self.assertRaises(DatabaseError):
            call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0)

        call_command("migrate", "migrations", "0001", fake=True, verbosity=0)
        # Real rollback
        call_command("migrate", "migrations", "zero", verbosity=0)
        # Make sure it's all gone
        self.assertTableNotExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        self.assertTableNotExists("migrations_book")

    @override_settings(
        MIGRATION_MODULES={"migrations": "migrations.test_migrations"},
        DATABASE_ROUTERS=['migrations.routers.TestRouter'],
    )
    def test_migrate_fake_initial(self):
        """
        --fake-initial only works if all tables created in the initial
        migration of an app exists. Database routers must be obeyed when doing
        that check.
        """
        # Make sure no tables are created
        for db in connections:
            self.assertTableNotExists("migrations_author", using=db)
            self.assertTableNotExists("migrations_tribble", using=db)
        # Run the migrations to 0001 only
        call_command("migrate", "migrations", "0001", verbosity=0)
        call_command("migrate", "migrations", "0001", verbosity=0, database="other")
        # Make sure the right tables exist
        self.assertTableExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        # Also check the "other" database
        self.assertTableNotExists("migrations_author", using="other")
        self.assertTableExists("migrations_tribble", using="other")

        # Fake a roll-back
        call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
        call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
        # Make sure the tables still exist
        self.assertTableExists("migrations_author")
        self.assertTableExists("migrations_tribble", using="other")
        # Try to run initial migration
        with self.assertRaises(DatabaseError):
            call_command("migrate", "migrations", "0001", verbosity=0)
        # Run initial migration with an explicit --fake-initial
        out = io.StringIO()
        with mock.patch('django.core.management.color.supports_color', lambda *args: False):
            call_command("migrate", "migrations", "0001", fake_initial=True, stdout=out, verbosity=1)
            call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0, database="other")
        self.assertIn(
            "migrations.0001_initial... faked",
            out.getvalue().lower()
        )
        # Run migrations all the way
        call_command("migrate", verbosity=0)
        call_command("migrate", verbosity=0, database="other")
        # Make sure the right tables exist
        self.assertTableExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        self.assertTableExists("migrations_book")
        self.assertTableNotExists("migrations_author", using="other")
        self.assertTableNotExists("migrations_tribble", using="other")
        self.assertTableNotExists("migrations_book", using="other")
        # Fake a roll-back
        call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
        call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
        # Make sure the tables still exist
        self.assertTableExists("migrations_author")
        self.assertTableNotExists("migrations_tribble")
        self.assertTableExists("migrations_book")
        # Try to run initial migration
        with self.assertRaises(DatabaseError):
            call_command("migrate", "migrations", verbosity=0)
        # Run initial migration with an explicit --fake-initial
        with self.assertRaises(DatabaseError):
            # Fails because "migrations_tribble" does not exist but needs to in
            # order to make --fake-initial work.
            call_command("migrate", "migrations", fake_initial=True, verbosity=0)
        # Fake an apply
        call_command("migrate", "migrations", fake=True, verbosity=0)
        call_command("migrate", "migrations", fake=True, verbosity=0, database="other")
        # Unmigrate everything
        call_command("migrate", "migrations", "zero", verbosity=0)
        call_command("migrate", "migrations", "zero", verbosity=0, database="other")
        # Make sure it's all gone
        for db in connections:
            self.assertTableNotExists("migrations_author", using=db)
            self.assertTableNotExists("migrations_tribble", using=db)
            self.assertTableNotExists("migrations_book", using=db)

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_fake_split_initial"})
    def test_migrate_fake_split_initial(self):
        """
        Split initial migrations can be faked with --fake-initial.
        """
        call_command("migrate", "migrations", "0002", verbosity=0)
        call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
        out = io.StringIO()
        with mock.patch('django.core.management.color.supports_color', lambda *args: False):
            call_command("migrate", "migrations", "0002", fake_initial=True, stdout=out, verbosity=1)
        value = out.getvalue().lower()
        self.assertIn("migrations.0001_initial... faked", value)
        self.assertIn("migrations.0002_second... faked", value)
        # Fake an apply
        call_command("migrate", "migrations", fake=True, verbosity=0)
        # Unmigrate everything
        call_command("migrate", "migrations", "zero", verbosity=0)

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_conflict"})
    def test_migrate_conflict_exit(self):
        """
        migrate exits if it detects a conflict.
        """
        with self.assertRaisesMessage(CommandError, "Conflicting migrations detected"):
            call_command("migrate", "migrations")

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
    def test_showmigrations_list(self):
        """
        showmigrations --list  displays migrations and whether or not they're
        applied.
        """
        out = io.StringIO()
        with mock.patch('django.core.management.color.supports_color', lambda *args: True):
            call_command("showmigrations", format='list', stdout=out, verbosity=0, no_color=False)
        self.assertEqual(
            '\x1b[1mmigrations\n\x1b[0m'
            ' [ ] 0001_initial\n'
            ' [ ] 0002_second\n',
            out.getvalue().lower()
        )

        call_command("migrate", "migrations", "0001", verbosity=0)

        out = io.StringIO()
        # Giving the explicit app_label tests for selective `show_list` in the command
        call_command("showmigrations", "migrations", format='list', stdout=out, verbosity=0, no_color=True)
        self.assertEqual(
            'migrations\n'
            ' [x] 0001_initial\n'
            ' [ ] 0002_second\n',
            out.getvalue().lower()
        )
        out = io.StringIO()
        # Applied datetimes are displayed at verbosity 2+.
        call_command('showmigrations', 'migrations', stdout=out, verbosity=2, no_color=True)
        migration1 = MigrationRecorder(connection).migration_qs.get(app='migrations', name='0001_initial')
        self.assertEqual(
            'migrations\n'
            ' [x] 0001_initial (applied at %s)\n'
            ' [ ] 0002_second\n' % migration1.applied.strftime('%Y-%m-%d %H:%M:%S'),
            out.getvalue().lower()
        )
        # Cleanup by unmigrating everything
        call_command("migrate", "migrations", "zero", verbosity=0)

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_run_before"})
    def test_showmigrations_plan(self):
        """
        Tests --plan output of showmigrations command
        """
        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out)
        self.assertEqual(
            "[ ]  migrations.0001_initial\n"
            "[ ]  migrations.0003_third\n"
            "[ ]  migrations.0002_second\n",
            out.getvalue().lower()
        )

        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out, verbosity=2)
        self.assertEqual(
            "[ ]  migrations.0001_initial\n"
            "[ ]  migrations.0003_third ... (migrations.0001_initial)\n"
            "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
            out.getvalue().lower()
        )
        call_command("migrate", "migrations", "0003", verbosity=0)

        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out)
        self.assertEqual(
            "[x]  migrations.0001_initial\n"
            "[x]  migrations.0003_third\n"
            "[ ]  migrations.0002_second\n",
            out.getvalue().lower()
        )

        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out, verbosity=2)
        self.assertEqual(
            "[x]  migrations.0001_initial\n"
            "[x]  migrations.0003_third ... (migrations.0001_initial)\n"
            "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
            out.getvalue().lower()
        )

        # Cleanup by unmigrating everything
        call_command("migrate", "migrations", "zero", verbosity=0)

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_plan'})
    def test_migrate_plan(self):
        """Tests migrate --plan output."""
        out = io.StringIO()
        # Show the plan up to the third migration.
        call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
        self.assertEqual(
            'Planned operations:\n'
            'migrations.0001_initial\n'
            '    Create model Salamander\n'
            '    Raw Python operation -> Grow salamander tail.\n'
            'migrations.0002_second\n'
            '    Create model Book\n'
            "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
            'migrations.0003_third\n'
            '    Create model Author\n'
            "    Raw SQL operation -> ['SELECT * FROM migrations_author']\n",
            out.getvalue()
        )
        # Migrate to the third migration.
        call_command('migrate', 'migrations', '0003', verbosity=0)
        out = io.StringIO()
        # Show the plan for when there is nothing to apply.
        call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
        self.assertEqual(
            'Planned operations:\n'
            '  No planned migration operations.\n',
            out.getvalue()
        )
        out = io.StringIO()
        # Show the plan for reverse migration back to 0001.
        call_command('migrate', 'migrations', '0001', plan=True, stdout=out, no_color=True)
        self.assertEqual(
            'Planned operations:\n'
            'migrations.0003_third\n'
            '    Undo Create model Author\n'
            "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
            'migrations.0002_second\n'
            '    Undo Create model Book\n'
            "    Raw SQL operation -> ['SELECT * FROM migrations_salamand…\n",
            out.getvalue()
        )
        out = io.StringIO()
        # Show the migration plan to fourth, with truncated details.
        call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
        self.assertEqual(
            'Planned operations:\n'
            'migrations.0004_fourth\n'
            '    Raw SQL operation -> SELECT * FROM migrations_author WHE…\n',
            out.getvalue()
        )
        # Show the plan when an operation is irreversible.
        # Migrate to the fourth migration.
        call_command('migrate', 'migrations', '0004', verbosity=0)
        out = io.StringIO()
        call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
        self.assertEqual(
            'Planned operations:\n'
            'migrations.0004_fourth\n'
            '    Raw SQL operation -> IRREVERSIBLE\n',
            out.getvalue()
        )
        # Cleanup by unmigrating everything: fake the irreversible, then
        # migrate all to zero.
        call_command('migrate', 'migrations', '0003', fake=True, verbosity=0)
        call_command('migrate', 'migrations', 'zero', verbosity=0)

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_empty'})
    def test_showmigrations_no_migrations(self):
        out = io.StringIO()
        call_command('showmigrations', stdout=out, no_color=True)
        self.assertEqual('migrations\n (no migrations)\n', out.getvalue().lower())

    @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app'])
    def test_showmigrations_unmigrated_app(self):
        out = io.StringIO()
        call_command('showmigrations', 'unmigrated_app', stdout=out, no_color=True)
        self.assertEqual('unmigrated_app\n (no migrations)\n', out.getvalue().lower())

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_empty"})
    def test_showmigrations_plan_no_migrations(self):
        """
        Tests --plan output of showmigrations command without migrations
        """
        out = io.StringIO()
        call_command('showmigrations', format='plan', stdout=out, no_color=True)
        self.assertEqual('(no migrations)\n', out.getvalue().lower())

        out = io.StringIO()
        call_command('showmigrations', format='plan', stdout=out, verbosity=2, no_color=True)
        self.assertEqual('(no migrations)\n', out.getvalue().lower())

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed_complex"})
    def test_showmigrations_plan_squashed(self):
        """
        Tests --plan output of showmigrations command with squashed migrations.
        """
        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out)
        self.assertEqual(
            "[ ]  migrations.1_auto\n"
            "[ ]  migrations.2_auto\n"
            "[ ]  migrations.3_squashed_5\n"
            "[ ]  migrations.6_auto\n"
            "[ ]  migrations.7_auto\n",
            out.getvalue().lower()
        )

        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out, verbosity=2)
        self.assertEqual(
            "[ ]  migrations.1_auto\n"
            "[ ]  migrations.2_auto ... (migrations.1_auto)\n"
            "[ ]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
            "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
            "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
            out.getvalue().lower()
        )

        call_command("migrate", "migrations", "3_squashed_5", verbosity=0)

        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out)
        self.assertEqual(
            "[x]  migrations.1_auto\n"
            "[x]  migrations.2_auto\n"
            "[x]  migrations.3_squashed_5\n"
            "[ ]  migrations.6_auto\n"
            "[ ]  migrations.7_auto\n",
            out.getvalue().lower()
        )

        out = io.StringIO()
        call_command("showmigrations", format='plan', stdout=out, verbosity=2)
        self.assertEqual(
            "[x]  migrations.1_auto\n"
            "[x]  migrations.2_auto ... (migrations.1_auto)\n"
            "[x]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
            "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
            "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
            out.getvalue().lower()
        )

    @override_settings(INSTALLED_APPS=[
        'migrations.migrations_test_apps.mutate_state_b',
        'migrations.migrations_test_apps.alter_fk.author_app',
        'migrations.migrations_test_apps.alter_fk.book_app',
    ])
    def test_showmigrations_plan_single_app_label(self):
        """
        `showmigrations --plan app_label` output with a single app_label.
        """
        # Single app with no dependencies on other apps.
        out = io.StringIO()
        call_command('showmigrations', 'mutate_state_b', format='plan', stdout=out)
        self.assertEqual(
            '[ ]  mutate_state_b.0001_initial\n'
            '[ ]  mutate_state_b.0002_add_field\n',
            out.getvalue()
        )
        # Single app with dependencies.
        out = io.StringIO()
        call_command('showmigrations', 'author_app', format='plan', stdout=out)
        self.assertEqual(
            '[ ]  author_app.0001_initial\n'
            '[ ]  book_app.0001_initial\n'
            '[ ]  author_app.0002_alter_id\n',
            out.getvalue()
        )
        # Some migrations already applied.
        call_command('migrate', 'author_app', '0001', verbosity=0)
        out = io.StringIO()
        call_command('showmigrations', 'author_app', format='plan', stdout=out)
        self.assertEqual(
            '[X]  author_app.0001_initial\n'
            '[ ]  book_app.0001_initial\n'
            '[ ]  author_app.0002_alter_id\n',
            out.getvalue()
        )
        # Cleanup by unmigrating author_app.
        call_command('migrate', 'author_app', 'zero', verbosity=0)

    @override_settings(INSTALLED_APPS=[
        'migrations.migrations_test_apps.mutate_state_b',
        'migrations.migrations_test_apps.alter_fk.author_app',
        'migrations.migrations_test_apps.alter_fk.book_app',
    ])
    def test_showmigrations_plan_multiple_app_labels(self):
        """
        `showmigrations --plan app_label` output with multiple app_labels.
        """
        # Multiple apps: author_app depends on book_app; mutate_state_b doesn't
        # depend on other apps.
        out = io.StringIO()
        call_command('showmigrations', 'mutate_state_b', 'author_app', format='plan', stdout=out)
        self.assertEqual(
            '[ ]  author_app.0001_initial\n'
            '[ ]  book_app.0001_initial\n'
            '[ ]  author_app.0002_alter_id\n'
            '[ ]  mutate_state_b.0001_initial\n'
            '[ ]  mutate_state_b.0002_add_field\n',
            out.getvalue()
        )
        # Multiple apps: args order shouldn't matter (the same result is
        # expected as above).
        out = io.StringIO()
        call_command('showmigrations', 'author_app', 'mutate_state_b', format='plan', stdout=out)
        self.assertEqual(
            '[ ]  author_app.0001_initial\n'
            '[ ]  book_app.0001_initial\n'
            '[ ]  author_app.0002_alter_id\n'
            '[ ]  mutate_state_b.0001_initial\n'
            '[ ]  mutate_state_b.0002_add_field\n',
            out.getvalue()
        )

    @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app'])
    def test_showmigrations_plan_app_label_no_migrations(self):
        out = io.StringIO()
        call_command('showmigrations', 'unmigrated_app', format='plan', stdout=out, no_color=True)
        self.assertEqual('(no migrations)\n', out.getvalue())

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
    def test_sqlmigrate_forwards(self):
        """
        sqlmigrate outputs forward looking SQL.
        """
        out = io.StringIO()
        call_command("sqlmigrate", "migrations", "0001", stdout=out)
        output = out.getvalue().lower()

        index_tx_start = output.find(connection.ops.start_transaction_sql().lower())
        index_op_desc_author = output.find('-- create model author')
        index_create_table = output.find('create table')
        index_op_desc_tribble = output.find('-- create model tribble')
        index_op_desc_unique_together = output.find('-- alter unique_together')
        index_tx_end = output.find(connection.ops.end_transaction_sql().lower())

        if connection.features.can_rollback_ddl:
            self.assertGreater(index_tx_start, -1, "Transaction start not found")
            self.assertGreater(
                index_tx_end, index_op_desc_unique_together,
                "Transaction end not found or found before operation description (unique_together)"
            )

        self.assertGreater(
            index_op_desc_author, index_tx_start,
            "Operation description (author) not found or found before transaction start"
        )
        self.assertGreater(
            index_create_table, index_op_desc_author,
            "CREATE TABLE not found or found before operation description (author)"
        )
        self.assertGreater(
            index_op_desc_tribble, index_create_table,
            "Operation description (tribble) not found or found before CREATE TABLE (author)"
        )
        self.assertGreater(
            index_op_desc_unique_together, index_op_desc_tribble,
            "Operation description (unique_together) not found or found before operation description (tribble)"
        )

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
    def test_sqlmigrate_backwards(self):
        """
        sqlmigrate outputs reverse looking SQL.
        """
        # Cannot generate the reverse SQL unless we've applied the migration.
        call_command("migrate", "migrations", verbosity=0)

        out = io.StringIO()
        call_command("sqlmigrate", "migrations", "0001", stdout=out, backwards=True)
        output = out.getvalue().lower()

        index_tx_start = output.find(connection.ops.start_transaction_sql().lower())
        index_op_desc_unique_together = output.find('-- alter unique_together')
        index_op_desc_tribble = output.find('-- create model tribble')
        index_op_desc_author = output.find('-- create model author')
        index_drop_table = output.rfind('drop table')
        index_tx_end = output.find(connection.ops.end_transaction_sql().lower())

        if connection.features.can_rollback_ddl:
            self.assertGreater(index_tx_start, -1, "Transaction start not found")
            self.assertGreater(
                index_tx_end, index_op_desc_unique_together,
                "Transaction end not found or found before DROP TABLE"
            )
        self.assertGreater(
            index_op_desc_unique_together, index_tx_start,
            "Operation description (unique_together) not found or found before transaction start"
        )
        self.assertGreater(
            index_op_desc_tribble, index_op_desc_unique_together,
            "Operation description (tribble) not found or found before operation description (unique_together)"
        )
        self.assertGreater(
            index_op_desc_author, index_op_desc_tribble,
            "Operation description (author) not found or found before operation description (tribble)"
        )

        self.assertGreater(
            index_drop_table, index_op_desc_author,
            "DROP TABLE not found or found before operation description (author)"
        )

        # Cleanup by unmigrating everything
        call_command("migrate", "migrations", "zero", verbosity=0)

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_non_atomic"})
    def test_sqlmigrate_for_non_atomic_migration(self):
        """
        Transaction wrappers aren't shown for non-atomic migrations.
        """
        out = io.StringIO()
        call_command("sqlmigrate", "migrations", "0001", stdout=out)
        output = out.getvalue().lower()
        queries = [q.strip() for q in output.splitlines()]
        if connection.ops.start_transaction_sql():
            self.assertNotIn(connection.ops.start_transaction_sql().lower(), queries)
        self.assertNotIn(connection.ops.end_transaction_sql().lower(), queries)

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
    def test_sqlmigrate_for_non_transactional_databases(self):
        """
        Transaction wrappers aren't shown for databases that don't support
        transactional DDL.
        """
        out = io.StringIO()
        with mock.patch.object(connection.features, 'can_rollback_ddl', False):
            call_command('sqlmigrate', 'migrations', '0001', stdout=out)
        output = out.getvalue().lower()
        queries = [q.strip() for q in output.splitlines()]
        start_transaction_sql = connection.ops.start_transaction_sql()
        if start_transaction_sql:
            self.assertNotIn(start_transaction_sql.lower(), queries)
        self.assertNotIn(connection.ops.end_transaction_sql().lower(), queries)

    @override_settings(
        INSTALLED_APPS=[
            "migrations.migrations_test_apps.migrated_app",
            "migrations.migrations_test_apps.migrated_unapplied_app",
            "migrations.migrations_test_apps.unmigrated_app",
        ],
    )
    def test_regression_22823_unmigrated_fk_to_migrated_model(self):
        """
        Assuming you have 3 apps, `A`, `B`, and `C`, such that:

        * `A` has migrations
        * `B` has a migration we want to apply
        * `C` has no migrations, but has an FK to `A`

        When we try to migrate "B", an exception occurs because the
        "B" was not included in the ProjectState that is used to detect
        soft-applied migrations (#22823).
        """
        call_command("migrate", "migrated_unapplied_app", stdout=io.StringIO())

        # unmigrated_app.SillyModel has a foreign key to 'migrations.Tribble',
        # but that model is only defined in a migration, so the global app
        # registry never sees it and the reference is left dangling. Remove it
        # to avoid problems in subsequent tests.
        del apps._pending_operations[('migrations', 'tribble')]

    @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app_syncdb'])
    def test_migrate_syncdb_deferred_sql_executed_with_schemaeditor(self):
        """
        For an app without migrations, editor.execute() is used for executing
        the syncdb deferred SQL.
        """
        stdout = io.StringIO()
        with mock.patch.object(BaseDatabaseSchemaEditor, 'execute') as execute:
            call_command('migrate', run_syncdb=True, verbosity=1, stdout=stdout, no_color=True)
            create_table_count = len([call for call in execute.mock_calls if 'CREATE TABLE' in str(call)])
            self.assertEqual(create_table_count, 2)
            # There's at least one deferred SQL for creating the foreign key
            # index.
            self.assertGreater(len(execute.mock_calls), 2)
        stdout = stdout.getvalue()
        self.assertIn('Synchronize unmigrated apps: unmigrated_app_syncdb', stdout)
        self.assertIn('Creating tables...', stdout)
        table_name = truncate_name('unmigrated_app_syncdb_classroom', connection.ops.max_name_length())
        self.assertIn('Creating table %s' % table_name, stdout)

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
    def test_migrate_syncdb_app_with_migrations(self):
        msg = "Can't use run_syncdb with app 'migrations' as it has migrations."
        with self.assertRaisesMessage(CommandError, msg):
            call_command('migrate', 'migrations', run_syncdb=True, verbosity=0)

    @override_settings(INSTALLED_APPS=[
        'migrations.migrations_test_apps.unmigrated_app_syncdb',
        'migrations.migrations_test_apps.unmigrated_app_simple',
    ])
    def test_migrate_syncdb_app_label(self):
        """
        Running migrate --run-syncdb with an app_label only creates tables for
        the specified app.
        """
        stdout = io.StringIO()
        with mock.patch.object(BaseDatabaseSchemaEditor, 'execute') as execute:
            call_command('migrate', 'unmigrated_app_syncdb', run_syncdb=True, stdout=stdout)
            create_table_count = len([call for call in execute.mock_calls if 'CREATE TABLE' in str(call)])
            self.assertEqual(create_table_count, 2)
            self.assertGreater(len(execute.mock_calls), 2)
            self.assertIn('Synchronize unmigrated app: unmigrated_app_syncdb', stdout.getvalue())

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed"})
    def test_migrate_record_replaced(self):
        """
        Running a single squashed migration should record all of the original
        replaced migrations as run.
        """
        recorder = MigrationRecorder(connection)
        out = io.StringIO()
        call_command("migrate", "migrations", verbosity=0)
        call_command("showmigrations", "migrations", stdout=out, no_color=True)
        self.assertEqual(
            'migrations\n'
            ' [x] 0001_squashed_0002 (2 squashed migrations)\n',
            out.getvalue().lower()
        )
        applied_migrations = recorder.applied_migrations()
        self.assertIn(("migrations", "0001_initial"), applied_migrations)
        self.assertIn(("migrations", "0002_second"), applied_migrations)
        self.assertIn(("migrations", "0001_squashed_0002"), applied_migrations)
        # Rollback changes
        call_command("migrate", "migrations", "zero", verbosity=0)

    @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed"})
    def test_migrate_record_squashed(self):
        """
        Running migrate for a squashed migration should record as run
        if all of the replaced migrations have been run (#25231).
        """
        recorder = MigrationRecorder(connection)
        recorder.record_applied("migrations", "0001_initial")
        recorder.record_applied("migrations", "0002_second")
        out = io.StringIO()
        call_command("migrate", "migrations", verbosity=0)
        call_command("showmigrations", "migrations", stdout=out, no_color=True)
        self.assertEqual(
            'migrations\n'
            ' [x] 0001_squashed_0002 (2 squashed migrations)\n',
            out.getvalue().lower()
        )
        self.assertIn(
            ("migrations", "0001_squashed_0002"),
            recorder.applied_migrations()
        )
        # No changes were actually applied so there is nothing to rollback

    @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
    def test_migrate_inconsistent_history(self):
        """
        Running migrate with some migrations applied before their dependencies
        should not be allowed.
        """
        recorder = MigrationRecorder(connection)
        recorder.record_applied("migrations", "0002_second")
        msg = "Migration migrations.0002_second is applied before its dependency migrations.0001_initial"
        with self.assertRaisesMessage(InconsistentMigrationHistory, msg):
            call_command("migrate")
        applied_migrations = recorder.applied_migrations()
        self.assertNotIn(("migrations", "0001_initial"), applied_migrations)


File: tests/migrations/test_commands.py
Line number range: 778 - 1464
Content:
class MakeMigrationsTests(MigrationTestBase):
    """
    Tests running the makemigrations command.
    """

    def setUp(self):
        super().setUp()
        self._old_models = apps.app_configs['migrations'].models.copy()

    def tearDown(self):
        apps.app_configs['migrations'].models = self._old_models
        apps.all_models['migrations'] = self._old_models
        apps.clear_cache()
        super().tearDown()

    def test_files_content(self):
        self.assertTableNotExists("migrations_unicodemodel")
        apps.register_model('migrations', UnicodeModel)
        with self.temporary_migration_module() as migration_dir:
            call_command("makemigrations", "migrations", verbosity=0)

            # Check for empty __init__.py file in migrations folder
            init_file = os.path.join(migration_dir, "__init__.py")
            self.assertTrue(os.path.exists(init_file))

            with open(init_file) as fp:
                content = fp.read()
            self.assertEqual(content, '')

            # Check for existing 0001_initial.py file in migration folder
            initial_file = os.path.join(migration_dir, "0001_initial.py")
            self.assertTrue(os.path.exists(initial_file))

            with open(initial_file, encoding='utf-8') as fp:
                content = fp.read()
                self.assertIn('migrations.CreateModel', content)
                self.assertIn('initial = True', content)

                self.assertIn('úñí©óðé µóðéø', content)  # Meta.verbose_name
                self.assertIn('úñí©óðé µóðéøß', content)  # Meta.verbose_name_plural
                self.assertIn('ÚÑÍ¢ÓÐÉ', content)  # title.verbose_name
                self.assertIn('“Ðjáñgó”', content)  # title.default

    def test_makemigrations_order(self):
        """
        makemigrations should recognize number-only migrations (0001.py).
        """
        module = 'migrations.test_migrations_order'
        with self.temporary_migration_module(module=module) as migration_dir:
            if hasattr(importlib, 'invalidate_caches'):
                # importlib caches os.listdir() on some platforms like macOS
                # (#23850).
                importlib.invalidate_caches()
            call_command('makemigrations', 'migrations', '--empty', '-n', 'a', '-v', '0')
            self.assertTrue(os.path.exists(os.path.join(migration_dir, '0002_a.py')))

    def test_makemigrations_empty_connections(self):
        empty_connections = ConnectionHandler({'default': {}})
        with mock.patch('django.core.management.commands.makemigrations.connections', new=empty_connections):
            # with no apps
            out = io.StringIO()
            call_command('makemigrations', stdout=out)
            self.assertIn('No changes detected', out.getvalue())
            # with an app
            with self.temporary_migration_module() as migration_dir:
                call_command('makemigrations', 'migrations', verbosity=0)
                init_file = os.path.join(migration_dir, '__init__.py')
                self.assertTrue(os.path.exists(init_file))

    @override_settings(INSTALLED_APPS=['migrations', 'migrations2'])
    def test_makemigrations_consistency_checks_respect_routers(self):
        """
        The history consistency checks in makemigrations respect
        settings.DATABASE_ROUTERS.
        """
        def patched_has_table(migration_recorder):
            if migration_recorder.connection is connections['other']:
                raise Exception('Other connection')
            else:
                return mock.DEFAULT

        self.assertTableNotExists('migrations_unicodemodel')
        apps.register_model('migrations', UnicodeModel)
        with mock.patch.object(
                MigrationRecorder, 'has_table',
                autospec=True, side_effect=patched_has_table) as has_table:
            with self.temporary_migration_module() as migration_dir:
                call_command("makemigrations", "migrations", verbosity=0)
                initial_file = os.path.join(migration_dir, "0001_initial.py")
                self.assertTrue(os.path.exists(initial_file))
                self.assertEqual(has_table.call_count, 1)  # 'default' is checked

                # Router says not to migrate 'other' so consistency shouldn't
                # be checked.
                with self.settings(DATABASE_ROUTERS=['migrations.routers.TestRouter']):
                    call_command('makemigrations', 'migrations', verbosity=0)
                self.assertEqual(has_table.call_count, 2)  # 'default' again

                # With a router that doesn't prohibit migrating 'other',
                # consistency is checked.
                with self.settings(DATABASE_ROUTERS=['migrations.routers.EmptyRouter']):
                    with self.assertRaisesMessage(Exception, 'Other connection'):
                        call_command('makemigrations', 'migrations', verbosity=0)
                self.assertEqual(has_table.call_count, 4)  # 'default' and 'other'

                # With a router that doesn't allow migrating on any database,
                # no consistency checks are made.
                with self.settings(DATABASE_ROUTERS=['migrations.routers.TestRouter']):
                    with mock.patch.object(TestRouter, 'allow_migrate', return_value=False) as allow_migrate:
                        call_command('makemigrations', 'migrations', verbosity=0)
                allow_migrate.assert_any_call('other', 'migrations', model_name='UnicodeModel')
                # allow_migrate() is called with the correct arguments.
                self.assertGreater(len(allow_migrate.mock_calls), 0)
                for mock_call in allow_migrate.mock_calls:
                    _, call_args, call_kwargs = mock_call
                    connection_alias, app_name = call_args
                    self.assertIn(connection_alias, ['default', 'other'])
                    # Raises an error if invalid app_name/model_name occurs.
                    apps.get_app_config(app_name).get_model(call_kwargs['model_name'])
                self.assertEqual(has_table.call_count, 4)

    def test_failing_migration(self):
        # If a migration fails to serialize, it shouldn't generate an empty file. #21280
        apps.register_model('migrations', UnserializableModel)

        with self.temporary_migration_module() as migration_dir:
            with self.assertRaisesMessage(ValueError, 'Cannot serialize'):
                call_command("makemigrations", "migrations", verbosity=0)

            initial_file = os.path.join(migration_dir, "0001_initial.py")
            self.assertFalse(os.path.exists(initial_file))

    def test_makemigrations_conflict_exit(self):
        """
        makemigrations exits if it detects a conflict.
        """
        with self.temporary_migration_module(module="migrations.test_migrations_conflict"):
            with self.assertRaises(CommandError) as context:
                call_command("makemigrations")
        exception_message = str(context.exception)
        self.assertIn(
            'Conflicting migrations detected; multiple leaf nodes '
            'in the migration graph:',
            exception_message
        )
        self.assertIn('0002_second', exception_message)
        self.assertIn('0002_conflicting_second', exception_message)
        self.assertIn('in migrations', exception_message)
        self.assertIn("To fix them run 'python manage.py makemigrations --merge'", exception_message)

    def test_makemigrations_merge_no_conflict(self):
        """
        makemigrations exits if in merge mode with no conflicts.
        """
        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations"):
            call_command("makemigrations", merge=True, stdout=out)
        self.assertIn("No conflicts detected to merge.", out.getvalue())

    def test_makemigrations_empty_no_app_specified(self):
        """
        makemigrations exits if no app is specified with 'empty' mode.
        """
        msg = 'You must supply at least one app label when using --empty.'
        with self.assertRaisesMessage(CommandError, msg):
            call_command("makemigrations", empty=True)

    def test_makemigrations_empty_migration(self):
        """
        makemigrations properly constructs an empty migration.
        """
        with self.temporary_migration_module() as migration_dir:
            call_command("makemigrations", "migrations", empty=True, verbosity=0)

            # Check for existing 0001_initial.py file in migration folder
            initial_file = os.path.join(migration_dir, "0001_initial.py")
            self.assertTrue(os.path.exists(initial_file))

            with open(initial_file, encoding='utf-8') as fp:
                content = fp.read()

                # Remove all whitespace to check for empty dependencies and operations
                content = content.replace(' ', '')
                self.assertIn('dependencies=[\n]', content)
                self.assertIn('operations=[\n]', content)

    @override_settings(MIGRATION_MODULES={"migrations": None})
    def test_makemigrations_disabled_migrations_for_app(self):
        """
        makemigrations raises a nice error when migrations are disabled for an
        app.
        """
        msg = (
            "Django can't create migrations for app 'migrations' because migrations "
            "have been disabled via the MIGRATION_MODULES setting."
        )
        with self.assertRaisesMessage(ValueError, msg):
            call_command("makemigrations", "migrations", empty=True, verbosity=0)

    def test_makemigrations_no_changes_no_apps(self):
        """
        makemigrations exits when there are no changes and no apps are specified.
        """
        out = io.StringIO()
        call_command("makemigrations", stdout=out)
        self.assertIn("No changes detected", out.getvalue())

    def test_makemigrations_no_changes(self):
        """
        makemigrations exits when there are no changes to an app.
        """
        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_no_changes"):
            call_command("makemigrations", "migrations", stdout=out)
        self.assertIn("No changes detected in app 'migrations'", out.getvalue())

    def test_makemigrations_no_apps_initial(self):
        """
        makemigrations should detect initial is needed on empty migration
        modules if no app provided.
        """
        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_empty"):
            call_command("makemigrations", stdout=out)
        self.assertIn("0001_initial.py", out.getvalue())

    def test_makemigrations_no_init(self):
        """Migration directories without an __init__.py file are allowed."""
        out = io.StringIO()
        with self.temporary_migration_module(module='migrations.test_migrations_no_init'):
            call_command('makemigrations', stdout=out)
        self.assertIn('0001_initial.py', out.getvalue())

    def test_makemigrations_migrations_announce(self):
        """
        makemigrations announces the migration at the default verbosity level.
        """
        out = io.StringIO()
        with self.temporary_migration_module():
            call_command("makemigrations", "migrations", stdout=out)
        self.assertIn("Migrations for 'migrations'", out.getvalue())

    def test_makemigrations_no_common_ancestor(self):
        """
        makemigrations fails to merge migrations with no common ancestor.
        """
        with self.assertRaises(ValueError) as context:
            with self.temporary_migration_module(module="migrations.test_migrations_no_ancestor"):
                call_command("makemigrations", "migrations", merge=True)
        exception_message = str(context.exception)
        self.assertIn("Could not find common ancestor of", exception_message)
        self.assertIn("0002_second", exception_message)
        self.assertIn("0002_conflicting_second", exception_message)

    def test_makemigrations_interactive_reject(self):
        """
        makemigrations enters and exits interactive mode properly.
        """
        # Monkeypatch interactive questioner to auto reject
        with mock.patch('builtins.input', mock.Mock(return_value='N')):
            with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
                call_command("makemigrations", "migrations", name="merge", merge=True, interactive=True, verbosity=0)
                merge_file = os.path.join(migration_dir, '0003_merge.py')
                self.assertFalse(os.path.exists(merge_file))

    def test_makemigrations_interactive_accept(self):
        """
        makemigrations enters interactive mode and merges properly.
        """
        # Monkeypatch interactive questioner to auto accept
        with mock.patch('builtins.input', mock.Mock(return_value='y')):
            out = io.StringIO()
            with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
                call_command("makemigrations", "migrations", name="merge", merge=True, interactive=True, stdout=out)
                merge_file = os.path.join(migration_dir, '0003_merge.py')
                self.assertTrue(os.path.exists(merge_file))
            self.assertIn("Created new merge migration", out.getvalue())

    @mock.patch('django.db.migrations.utils.datetime')
    def test_makemigrations_default_merge_name(self, mock_datetime):
        mock_datetime.datetime.now.return_value = datetime.datetime(2016, 1, 2, 3, 4)
        with mock.patch('builtins.input', mock.Mock(return_value='y')):
            out = io.StringIO()
            with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
                call_command("makemigrations", "migrations", merge=True, interactive=True, stdout=out)
                merge_file = os.path.join(migration_dir, '0003_merge_20160102_0304.py')
                self.assertTrue(os.path.exists(merge_file))
            self.assertIn("Created new merge migration", out.getvalue())

    def test_makemigrations_non_interactive_not_null_addition(self):
        """
        Non-interactive makemigrations fails when a default is missing on a
        new not-null field.
        """
        class SillyModel(models.Model):
            silly_field = models.BooleanField(default=False)
            silly_int = models.IntegerField()

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        with self.assertRaises(SystemExit):
            with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
                call_command("makemigrations", "migrations", interactive=False, stdout=out)

    def test_makemigrations_non_interactive_not_null_alteration(self):
        """
        Non-interactive makemigrations fails when a default is missing on a
        field changed to not-null.
        """
        class Author(models.Model):
            name = models.CharField(max_length=255)
            slug = models.SlugField()
            age = models.IntegerField(default=0)

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations"):
            call_command("makemigrations", "migrations", interactive=False, stdout=out)
        self.assertIn("Alter field slug on author", out.getvalue())

    def test_makemigrations_non_interactive_no_model_rename(self):
        """
        makemigrations adds and removes a possible model rename in
        non-interactive mode.
        """
        class RenamedModel(models.Model):
            silly_field = models.BooleanField(default=False)

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
            call_command("makemigrations", "migrations", interactive=False, stdout=out)
        self.assertIn("Delete model SillyModel", out.getvalue())
        self.assertIn("Create model RenamedModel", out.getvalue())

    def test_makemigrations_non_interactive_no_field_rename(self):
        """
        makemigrations adds and removes a possible field rename in
        non-interactive mode.
        """
        class SillyModel(models.Model):
            silly_rename = models.BooleanField(default=False)

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
            call_command("makemigrations", "migrations", interactive=False, stdout=out)
        self.assertIn("Remove field silly_field from sillymodel", out.getvalue())
        self.assertIn("Add field silly_rename to sillymodel", out.getvalue())

    def test_makemigrations_handle_merge(self):
        """
        makemigrations properly merges the conflicting migrations with --noinput.
        """
        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
            call_command("makemigrations", "migrations", name="merge", merge=True, interactive=False, stdout=out)
            merge_file = os.path.join(migration_dir, '0003_merge.py')
            self.assertTrue(os.path.exists(merge_file))
        output = out.getvalue()
        self.assertIn("Merging migrations", output)
        self.assertIn("Branch 0002_second", output)
        self.assertIn("Branch 0002_conflicting_second", output)
        self.assertIn("Created new merge migration", output)

    def test_makemigration_merge_dry_run(self):
        """
        makemigrations respects --dry-run option when fixing migration
        conflicts (#24427).
        """
        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
            call_command(
                "makemigrations", "migrations", name="merge", dry_run=True,
                merge=True, interactive=False, stdout=out,
            )
            merge_file = os.path.join(migration_dir, '0003_merge.py')
            self.assertFalse(os.path.exists(merge_file))
        output = out.getvalue()
        self.assertIn("Merging migrations", output)
        self.assertIn("Branch 0002_second", output)
        self.assertIn("Branch 0002_conflicting_second", output)
        self.assertNotIn("Created new merge migration", output)

    def test_makemigration_merge_dry_run_verbosity_3(self):
        """
        `makemigrations --merge --dry-run` writes the merge migration file to
        stdout with `verbosity == 3` (#24427).
        """
        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
            call_command(
                "makemigrations", "migrations", name="merge", dry_run=True,
                merge=True, interactive=False, stdout=out, verbosity=3,
            )
            merge_file = os.path.join(migration_dir, '0003_merge.py')
            self.assertFalse(os.path.exists(merge_file))
        output = out.getvalue()
        self.assertIn("Merging migrations", output)
        self.assertIn("Branch 0002_second", output)
        self.assertIn("Branch 0002_conflicting_second", output)
        self.assertNotIn("Created new merge migration", output)

        # Additional output caused by verbosity 3
        # The complete merge migration file that would be written
        self.assertIn("class Migration(migrations.Migration):", output)
        self.assertIn("dependencies = [", output)
        self.assertIn("('migrations', '0002_second')", output)
        self.assertIn("('migrations', '0002_conflicting_second')", output)
        self.assertIn("operations = [", output)
        self.assertIn("]", output)

    def test_makemigrations_dry_run(self):
        """
        `makemigrations --dry-run` should not ask for defaults.
        """
        class SillyModel(models.Model):
            silly_field = models.BooleanField(default=False)
            silly_date = models.DateField()  # Added field without a default

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
            call_command("makemigrations", "migrations", dry_run=True, stdout=out)
        # Output the expected changes directly, without asking for defaults
        self.assertIn("Add field silly_date to sillymodel", out.getvalue())

    def test_makemigrations_dry_run_verbosity_3(self):
        """
        Allow `makemigrations --dry-run` to output the migrations file to
        stdout (with verbosity == 3).
        """
        class SillyModel(models.Model):
            silly_field = models.BooleanField(default=False)
            silly_char = models.CharField(default="")

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
            call_command("makemigrations", "migrations", dry_run=True, stdout=out, verbosity=3)

        # Normal --dry-run output
        self.assertIn("- Add field silly_char to sillymodel", out.getvalue())

        # Additional output caused by verbosity 3
        # The complete migrations file that would be written
        self.assertIn("class Migration(migrations.Migration):", out.getvalue())
        self.assertIn("dependencies = [", out.getvalue())
        self.assertIn("('migrations', '0001_initial'),", out.getvalue())
        self.assertIn("migrations.AddField(", out.getvalue())
        self.assertIn("model_name='sillymodel',", out.getvalue())
        self.assertIn("name='silly_char',", out.getvalue())

    def test_makemigrations_migrations_modules_path_not_exist(self):
        """
        makemigrations creates migrations when specifying a custom location
        for migration files using MIGRATION_MODULES if the custom path
        doesn't already exist.
        """
        class SillyModel(models.Model):
            silly_field = models.BooleanField(default=False)

            class Meta:
                app_label = "migrations"

        out = io.StringIO()
        migration_module = "migrations.test_migrations_path_doesnt_exist.foo.bar"
        with self.temporary_migration_module(module=migration_module) as migration_dir:
            call_command("makemigrations", "migrations", stdout=out)

            # Migrations file is actually created in the expected path.
            initial_file = os.path.join(migration_dir, "0001_initial.py")
            self.assertTrue(os.path.exists(initial_file))

        # Command output indicates the migration is created.
        self.assertIn(" - Create model SillyModel", out.getvalue())

    @override_settings(MIGRATION_MODULES={'migrations': 'some.nonexistent.path'})
    def test_makemigrations_migrations_modules_nonexistent_toplevel_package(self):
        msg = (
            'Could not locate an appropriate location to create migrations '
            'package some.nonexistent.path. Make sure the toplevel package '
            'exists and can be imported.'
        )
        with self.assertRaisesMessage(ValueError, msg):
            call_command('makemigrations', 'migrations', empty=True, verbosity=0)

    def test_makemigrations_interactive_by_default(self):
        """
        The user is prompted to merge by default if there are conflicts and
        merge is True. Answer negative to differentiate it from behavior when
        --noinput is specified.
        """
        # Monkeypatch interactive questioner to auto reject
        out = io.StringIO()
        with mock.patch('builtins.input', mock.Mock(return_value='N')):
            with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
                call_command("makemigrations", "migrations", name="merge", merge=True, stdout=out)
                merge_file = os.path.join(migration_dir, '0003_merge.py')
                # This will fail if interactive is False by default
                self.assertFalse(os.path.exists(merge_file))
            self.assertNotIn("Created new merge migration", out.getvalue())

    @override_settings(
        INSTALLED_APPS=[
            "migrations",
            "migrations.migrations_test_apps.unspecified_app_with_conflict"])
    def test_makemigrations_unspecified_app_with_conflict_no_merge(self):
        """
        makemigrations does not raise a CommandError when an unspecified app
        has conflicting migrations.
        """
        with self.temporary_migration_module(module="migrations.test_migrations_no_changes"):
            call_command("makemigrations", "migrations", merge=False, verbosity=0)

    @override_settings(
        INSTALLED_APPS=[
            "migrations.migrations_test_apps.migrated_app",
            "migrations.migrations_test_apps.unspecified_app_with_conflict"])
    def test_makemigrations_unspecified_app_with_conflict_merge(self):
        """
        makemigrations does not create a merge for an unspecified app even if
        it has conflicting migrations.
        """
        # Monkeypatch interactive questioner to auto accept
        with mock.patch('builtins.input', mock.Mock(return_value='y')):
            out = io.StringIO()
            with self.temporary_migration_module(app_label="migrated_app") as migration_dir:
                call_command("makemigrations", "migrated_app", name="merge", merge=True, interactive=True, stdout=out)
                merge_file = os.path.join(migration_dir, '0003_merge.py')
                self.assertFalse(os.path.exists(merge_file))
            self.assertIn("No conflicts detected to merge.", out.getvalue())

    @override_settings(
        INSTALLED_APPS=[
            "migrations.migrations_test_apps.migrated_app",
            "migrations.migrations_test_apps.conflicting_app_with_dependencies"])
    def test_makemigrations_merge_dont_output_dependency_operations(self):
        """
        makemigrations --merge does not output any operations from apps that
        don't belong to a given app.
        """
        # Monkeypatch interactive questioner to auto accept
        with mock.patch('builtins.input', mock.Mock(return_value='N')):
            out = io.StringIO()
            with mock.patch('django.core.management.color.supports_color', lambda *args: False):
                call_command(
                    "makemigrations", "conflicting_app_with_dependencies",
                    merge=True, interactive=True, stdout=out
                )
            val = out.getvalue().lower()
            self.assertIn('merging conflicting_app_with_dependencies\n', val)
            self.assertIn(
                '  branch 0002_conflicting_second\n'
                '    - create model something\n',
                val
            )
            self.assertIn(
                '  branch 0002_second\n'
                '    - delete model tribble\n'
                '    - remove field silly_field from author\n'
                '    - add field rating to author\n'
                '    - create model book\n',
                val
            )

    def test_makemigrations_with_custom_name(self):
        """
        makemigrations --name generate a custom migration name.
        """
        with self.temporary_migration_module() as migration_dir:

            def cmd(migration_count, migration_name, *args):
                call_command("makemigrations", "migrations", "--verbosity", "0", "--name", migration_name, *args)
                migration_file = os.path.join(migration_dir, "%s_%s.py" % (migration_count, migration_name))
                # Check for existing migration file in migration folder
                self.assertTrue(os.path.exists(migration_file))
                with open(migration_file, encoding='utf-8') as fp:
                    content = fp.read()
                    content = content.replace(" ", "")
                return content

            # generate an initial migration
            migration_name_0001 = "my_initial_migration"
            content = cmd("0001", migration_name_0001)
            self.assertIn("dependencies=[\n]", content)

            # importlib caches os.listdir() on some platforms like macOS
            # (#23850).
            if hasattr(importlib, 'invalidate_caches'):
                importlib.invalidate_caches()

            # generate an empty migration
            migration_name_0002 = "my_custom_migration"
            content = cmd("0002", migration_name_0002, "--empty")
            self.assertIn("dependencies=[\n('migrations','0001_%s'),\n]" % migration_name_0001, content)
            self.assertIn("operations=[\n]", content)

    def test_makemigrations_with_invalid_custom_name(self):
        msg = 'The migration name must be a valid Python identifier.'
        with self.assertRaisesMessage(CommandError, msg):
            call_command('makemigrations', 'migrations', '--name', 'invalid name', '--empty')

    def test_makemigrations_check(self):
        """
        makemigrations --check should exit with a non-zero status when
        there are changes to an app requiring migrations.
        """
        with self.temporary_migration_module():
            with self.assertRaises(SystemExit):
                call_command("makemigrations", "--check", "migrations", verbosity=0)

        with self.temporary_migration_module(module="migrations.test_migrations_no_changes"):
            call_command("makemigrations", "--check", "migrations", verbosity=0)

    def test_makemigrations_migration_path_output(self):
        """
        makemigrations should print the relative paths to the migrations unless
        they are outside of the current tree, in which case the absolute path
        should be shown.
        """
        out = io.StringIO()
        apps.register_model('migrations', UnicodeModel)
        with self.temporary_migration_module() as migration_dir:
            call_command("makemigrations", "migrations", stdout=out)
            self.assertIn(os.path.join(migration_dir, '0001_initial.py'), out.getvalue())

    def test_makemigrations_migration_path_output_valueerror(self):
        """
        makemigrations prints the absolute path if os.path.relpath() raises a
        ValueError when it's impossible to obtain a relative path, e.g. on
        Windows if Django is installed on a different drive than where the
        migration files are created.
        """
        out = io.StringIO()
        with self.temporary_migration_module() as migration_dir:
            with mock.patch('os.path.relpath', side_effect=ValueError):
                call_command('makemigrations', 'migrations', stdout=out)
        self.assertIn(os.path.join(migration_dir, '0001_initial.py'), out.getvalue())

    def test_makemigrations_inconsistent_history(self):
        """
        makemigrations should raise InconsistentMigrationHistory exception if
        there are some migrations applied before their dependencies.
        """
        recorder = MigrationRecorder(connection)
        recorder.record_applied('migrations', '0002_second')
        msg = "Migration migrations.0002_second is applied before its dependency migrations.0001_initial"
        with self.temporary_migration_module(module="migrations.test_migrations"):
            with self.assertRaisesMessage(InconsistentMigrationHistory, msg):
                call_command("makemigrations")

    @mock.patch('builtins.input', return_value='1')
    @mock.patch('django.db.migrations.questioner.sys.stdin', mock.MagicMock(encoding=sys.getdefaultencoding()))
    def test_makemigrations_auto_now_add_interactive(self, *args):
        """
        makemigrations prompts the user when adding auto_now_add to an existing
        model.
        """
        class Entry(models.Model):
            title = models.CharField(max_length=255)
            creation_date = models.DateTimeField(auto_now_add=True)

            class Meta:
                app_label = 'migrations'

        # Monkeypatch interactive questioner to auto accept
        with mock.patch('django.db.migrations.questioner.sys.stdout', new_callable=io.StringIO) as prompt_stdout:
            out = io.StringIO()
            with self.temporary_migration_module(module='migrations.test_auto_now_add'):
                call_command('makemigrations', 'migrations', interactive=True, stdout=out)
            output = out.getvalue()
            prompt_output = prompt_stdout.getvalue()
            self.assertIn("You can accept the default 'timezone.now' by pressing 'Enter'", prompt_output)
            self.assertIn("Add field creation_date to entry", output)


File: tests/migrations/test_commands.py
Line number range: 1564 - 1623
Content:
class AppLabelErrorTests(TestCase):
    """
    This class inherits TestCase because MigrationTestBase uses
    `available_apps = ['migrations']` which means that it's the only installed
    app. 'django.contrib.auth' must be in INSTALLED_APPS for some of these
    tests.
    """
    nonexistent_app_error = "No installed app with label 'nonexistent_app'."
    did_you_mean_auth_error = (
        "No installed app with label 'django.contrib.auth'. Did you mean "
        "'auth'?"
    )

    def test_makemigrations_nonexistent_app_label(self):
        err = io.StringIO()
        with self.assertRaises(SystemExit):
            call_command('makemigrations', 'nonexistent_app', stderr=err)
        self.assertIn(self.nonexistent_app_error, err.getvalue())

    def test_makemigrations_app_name_specified_as_label(self):
        err = io.StringIO()
        with self.assertRaises(SystemExit):
            call_command('makemigrations', 'django.contrib.auth', stderr=err)
        self.assertIn(self.did_you_mean_auth_error, err.getvalue())

    def test_migrate_nonexistent_app_label(self):
        with self.assertRaisesMessage(CommandError, self.nonexistent_app_error):
            call_command('migrate', 'nonexistent_app')

    def test_migrate_app_name_specified_as_label(self):
        with self.assertRaisesMessage(CommandError, self.did_you_mean_auth_error):
            call_command('migrate', 'django.contrib.auth')

    def test_showmigrations_nonexistent_app_label(self):
        err = io.StringIO()
        with self.assertRaises(SystemExit):
            call_command('showmigrations', 'nonexistent_app', stderr=err)
        self.assertIn(self.nonexistent_app_error, err.getvalue())

    def test_showmigrations_app_name_specified_as_label(self):
        err = io.StringIO()
        with self.assertRaises(SystemExit):
            call_command('showmigrations', 'django.contrib.auth', stderr=err)
        self.assertIn(self.did_you_mean_auth_error, err.getvalue())

    def test_sqlmigrate_nonexistent_app_label(self):
        with self.assertRaisesMessage(CommandError, self.nonexistent_app_error):
            call_command('sqlmigrate', 'nonexistent_app', '0002')

    def test_sqlmigrate_app_name_specified_as_label(self):
        with self.assertRaisesMessage(CommandError, self.did_you_mean_auth_error):
            call_command('sqlmigrate', 'django.contrib.auth', '0002')

    def test_squashmigrations_nonexistent_app_label(self):
        with self.assertRaisesMessage(CommandError, self.nonexistent_app_error):
            call_command('squashmigrations', 'nonexistent_app', '0002')

    def test_squashmigrations_app_name_specified_as_label(self):
        with self.assertRaisesMessage(CommandError, self.did_you_mean_auth_error):
            call_command('squashmigrations', 'django.contrib.auth', '0002')


File: tests/multiple_database/tests.py
Line number range: 1 - 500
Content:
1. import datetime
2. import pickle
3. from io import StringIO
4. from operator import attrgetter
5. from unittest.mock import Mock
6. 
7. from django.contrib.auth.models import User
8. from django.contrib.contenttypes.models import ContentType
9. from django.core import management
10. from django.db import DEFAULT_DB_ALIAS, connections, router, transaction
11. from django.db.models import signals
12. from django.db.utils import ConnectionRouter
13. from django.test import SimpleTestCase, TestCase, override_settings
14. 
15. from .models import Book, Person, Pet, Review, UserProfile
16. from .routers import AuthRouter, TestRouter, WriteRouter
17. 
18. 
19. class QueryTestCase(TestCase):
20.     databases = {'default', 'other'}
21. 
22.     def test_db_selection(self):
23.         "Querysets will use the default database by default"
24.         self.assertEqual(Book.objects.db, DEFAULT_DB_ALIAS)
25.         self.assertEqual(Book.objects.all().db, DEFAULT_DB_ALIAS)
26. 
27.         self.assertEqual(Book.objects.using('other').db, 'other')
28. 
29.         self.assertEqual(Book.objects.db_manager('other').db, 'other')
30.         self.assertEqual(Book.objects.db_manager('other').all().db, 'other')
31. 
32.     def test_default_creation(self):
33.         "Objects created on the default database don't leak onto other databases"
34.         # Create a book on the default database using create()
35.         Book.objects.create(title="Pro Django", published=datetime.date(2008, 12, 16))
36. 
37.         # Create a book on the default database using a save
38.         dive = Book()
39.         dive.title = "Dive into Python"
40.         dive.published = datetime.date(2009, 5, 4)
41.         dive.save()
42. 
43.         # Book exists on the default database, but not on other database
44.         try:
45.             Book.objects.get(title="Pro Django")
46.             Book.objects.using('default').get(title="Pro Django")
47.         except Book.DoesNotExist:
48.             self.fail('"Pro Django" should exist on default database')
49. 
50.         with self.assertRaises(Book.DoesNotExist):
51.             Book.objects.using('other').get(title="Pro Django")
52. 
53.         try:
54.             Book.objects.get(title="Dive into Python")
55.             Book.objects.using('default').get(title="Dive into Python")
56.         except Book.DoesNotExist:
57.             self.fail('"Dive into Python" should exist on default database')
58. 
59.         with self.assertRaises(Book.DoesNotExist):
60.             Book.objects.using('other').get(title="Dive into Python")
61. 
62.     def test_other_creation(self):
63.         "Objects created on another database don't leak onto the default database"
64.         # Create a book on the second database
65.         Book.objects.using('other').create(title="Pro Django",
66.                                            published=datetime.date(2008, 12, 16))
67. 
68.         # Create a book on the default database using a save
69.         dive = Book()
70.         dive.title = "Dive into Python"
71.         dive.published = datetime.date(2009, 5, 4)
72.         dive.save(using='other')
73. 
74.         # Book exists on the default database, but not on other database
75.         try:
76.             Book.objects.using('other').get(title="Pro Django")
77.         except Book.DoesNotExist:
78.             self.fail('"Pro Django" should exist on other database')
79. 
80.         with self.assertRaises(Book.DoesNotExist):
81.             Book.objects.get(title="Pro Django")
82.         with self.assertRaises(Book.DoesNotExist):
83.             Book.objects.using('default').get(title="Pro Django")
84. 
85.         try:
86.             Book.objects.using('other').get(title="Dive into Python")
87.         except Book.DoesNotExist:
88.             self.fail('"Dive into Python" should exist on other database')
89. 
90.         with self.assertRaises(Book.DoesNotExist):
91.             Book.objects.get(title="Dive into Python")
92.         with self.assertRaises(Book.DoesNotExist):
93.             Book.objects.using('default').get(title="Dive into Python")
94. 
95.     def test_refresh(self):
96.         dive = Book(title="Dive into Python", published=datetime.date(2009, 5, 4))
97.         dive.save(using='other')
98.         dive2 = Book.objects.using('other').get()
99.         dive2.title = "Dive into Python (on default)"
100.         dive2.save(using='default')
101.         dive.refresh_from_db()
102.         self.assertEqual(dive.title, "Dive into Python")
103.         dive.refresh_from_db(using='default')
104.         self.assertEqual(dive.title, "Dive into Python (on default)")
105.         self.assertEqual(dive._state.db, "default")
106. 
107.     def test_refresh_router_instance_hint(self):
108.         router = Mock()
109.         router.db_for_read.return_value = None
110.         book = Book.objects.create(title='Dive Into Python', published=datetime.date(1957, 10, 12))
111.         with self.settings(DATABASE_ROUTERS=[router]):
112.             book.refresh_from_db()
113.         router.db_for_read.assert_called_once_with(Book, instance=book)
114. 
115.     def test_basic_queries(self):
116.         "Queries are constrained to a single database"
117.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
118. 
119.         dive = Book.objects.using('other').get(published=datetime.date(2009, 5, 4))
120.         self.assertEqual(dive.title, "Dive into Python")
121.         with self.assertRaises(Book.DoesNotExist):
122.             Book.objects.using('default').get(published=datetime.date(2009, 5, 4))
123. 
124.         dive = Book.objects.using('other').get(title__icontains="dive")
125.         self.assertEqual(dive.title, "Dive into Python")
126.         with self.assertRaises(Book.DoesNotExist):
127.             Book.objects.using('default').get(title__icontains="dive")
128. 
129.         dive = Book.objects.using('other').get(title__iexact="dive INTO python")
130.         self.assertEqual(dive.title, "Dive into Python")
131.         with self.assertRaises(Book.DoesNotExist):
132.             Book.objects.using('default').get(title__iexact="dive INTO python")
133. 
134.         dive = Book.objects.using('other').get(published__year=2009)
135.         self.assertEqual(dive.title, "Dive into Python")
136.         self.assertEqual(dive.published, datetime.date(2009, 5, 4))
137.         with self.assertRaises(Book.DoesNotExist):
138.             Book.objects.using('default').get(published__year=2009)
139. 
140.         years = Book.objects.using('other').dates('published', 'year')
141.         self.assertEqual([o.year for o in years], [2009])
142.         years = Book.objects.using('default').dates('published', 'year')
143.         self.assertEqual([o.year for o in years], [])
144. 
145.         months = Book.objects.using('other').dates('published', 'month')
146.         self.assertEqual([o.month for o in months], [5])
147.         months = Book.objects.using('default').dates('published', 'month')
148.         self.assertEqual([o.month for o in months], [])
149. 
150.     def test_m2m_separation(self):
151.         "M2M fields are constrained to a single database"
152.         # Create a book and author on the default database
153.         pro = Book.objects.create(title="Pro Django",
154.                                   published=datetime.date(2008, 12, 16))
155. 
156.         marty = Person.objects.create(name="Marty Alchin")
157. 
158.         # Create a book and author on the other database
159.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
160. 
161.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
162. 
163.         # Save the author relations
164.         pro.authors.set([marty])
165.         dive.authors.set([mark])
166. 
167.         # Inspect the m2m tables directly.
168.         # There should be 1 entry in each database
169.         self.assertEqual(Book.authors.through.objects.using('default').count(), 1)
170.         self.assertEqual(Book.authors.through.objects.using('other').count(), 1)
171. 
172.         # Queries work across m2m joins
173.         self.assertEqual(
174.             list(Book.objects.using('default').filter(authors__name='Marty Alchin').values_list('title', flat=True)),
175.             ['Pro Django']
176.         )
177.         self.assertEqual(
178.             list(Book.objects.using('other').filter(authors__name='Marty Alchin').values_list('title', flat=True)),
179.             []
180.         )
181. 
182.         self.assertEqual(
183.             list(Book.objects.using('default').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
184.             []
185.         )
186.         self.assertEqual(
187.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
188.             ['Dive into Python']
189.         )
190. 
191.         # Reget the objects to clear caches
192.         dive = Book.objects.using('other').get(title="Dive into Python")
193.         mark = Person.objects.using('other').get(name="Mark Pilgrim")
194. 
195.         # Retrieve related object by descriptor. Related objects should be database-bound
196.         self.assertEqual(list(dive.authors.all().values_list('name', flat=True)), ['Mark Pilgrim'])
197. 
198.         self.assertEqual(list(mark.book_set.all().values_list('title', flat=True)), ['Dive into Python'])
199. 
200.     def test_m2m_forward_operations(self):
201.         "M2M forward manipulations are all constrained to a single DB"
202.         # Create a book and author on the other database
203.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
204.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
205. 
206.         # Save the author relations
207.         dive.authors.set([mark])
208. 
209.         # Add a second author
210.         john = Person.objects.using('other').create(name="John Smith")
211.         self.assertEqual(
212.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
213.             []
214.         )
215. 
216.         dive.authors.add(john)
217.         self.assertEqual(
218.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
219.             ['Dive into Python']
220.         )
221.         self.assertEqual(
222.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
223.             ['Dive into Python']
224.         )
225. 
226.         # Remove the second author
227.         dive.authors.remove(john)
228.         self.assertEqual(
229.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
230.             ['Dive into Python']
231.         )
232.         self.assertEqual(
233.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
234.             []
235.         )
236. 
237.         # Clear all authors
238.         dive.authors.clear()
239.         self.assertEqual(
240.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
241.             []
242.         )
243.         self.assertEqual(
244.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
245.             []
246.         )
247. 
248.         # Create an author through the m2m interface
249.         dive.authors.create(name='Jane Brown')
250.         self.assertEqual(
251.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
252.             []
253.         )
254.         self.assertEqual(
255.             list(Book.objects.using('other').filter(authors__name='Jane Brown').values_list('title', flat=True)),
256.             ['Dive into Python']
257.         )
258. 
259.     def test_m2m_reverse_operations(self):
260.         "M2M reverse manipulations are all constrained to a single DB"
261.         # Create a book and author on the other database
262.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
263.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
264. 
265.         # Save the author relations
266.         dive.authors.set([mark])
267. 
268.         # Create a second book on the other database
269.         grease = Book.objects.using('other').create(title="Greasemonkey Hacks", published=datetime.date(2005, 11, 1))
270. 
271.         # Add a books to the m2m
272.         mark.book_set.add(grease)
273.         self.assertEqual(
274.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
275.             ['Mark Pilgrim']
276.         )
277.         self.assertEqual(
278.             list(
279.                 Person.objects.using('other').filter(book__title='Greasemonkey Hacks').values_list('name', flat=True)
280.             ),
281.             ['Mark Pilgrim']
282.         )
283. 
284.         # Remove a book from the m2m
285.         mark.book_set.remove(grease)
286.         self.assertEqual(
287.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
288.             ['Mark Pilgrim']
289.         )
290.         self.assertEqual(
291.             list(
292.                 Person.objects.using('other').filter(book__title='Greasemonkey Hacks').values_list('name', flat=True)
293.             ),
294.             []
295.         )
296. 
297.         # Clear the books associated with mark
298.         mark.book_set.clear()
299.         self.assertEqual(
300.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
301.             []
302.         )
303.         self.assertEqual(
304.             list(
305.                 Person.objects.using('other').filter(book__title='Greasemonkey Hacks').values_list('name', flat=True)
306.             ),
307.             []
308.         )
309. 
310.         # Create a book through the m2m interface
311.         mark.book_set.create(title="Dive into HTML5", published=datetime.date(2020, 1, 1))
312.         self.assertEqual(
313.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
314.             []
315.         )
316.         self.assertEqual(
317.             list(Person.objects.using('other').filter(book__title='Dive into HTML5').values_list('name', flat=True)),
318.             ['Mark Pilgrim']
319.         )
320. 
321.     def test_m2m_cross_database_protection(self):
322.         "Operations that involve sharing M2M objects across databases raise an error"
323.         # Create a book and author on the default database
324.         pro = Book.objects.create(title="Pro Django", published=datetime.date(2008, 12, 16))
325. 
326.         marty = Person.objects.create(name="Marty Alchin")
327. 
328.         # Create a book and author on the other database
329.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
330. 
331.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
332.         # Set a foreign key set with an object from a different database
333.         msg = (
334.             'Cannot assign "<Person: Marty Alchin>": the current database '
335.             'router prevents this relation.'
336.         )
337.         with self.assertRaisesMessage(ValueError, msg):
338.             with transaction.atomic(using='default'):
339.                 marty.edited.set([pro, dive])
340. 
341.         # Add to an m2m with an object from a different database
342.         msg = (
343.             'Cannot add "<Book: Dive into Python>": instance is on '
344.             'database "default", value is on database "other"'
345.         )
346.         with self.assertRaisesMessage(ValueError, msg):
347.             with transaction.atomic(using='default'):
348.                 marty.book_set.add(dive)
349. 
350.         # Set a m2m with an object from a different database
351.         with self.assertRaisesMessage(ValueError, msg):
352.             with transaction.atomic(using='default'):
353.                 marty.book_set.set([pro, dive])
354. 
355.         # Add to a reverse m2m with an object from a different database
356.         msg = (
357.             'Cannot add "<Person: Marty Alchin>": instance is on '
358.             'database "other", value is on database "default"'
359.         )
360.         with self.assertRaisesMessage(ValueError, msg):
361.             with transaction.atomic(using='other'):
362.                 dive.authors.add(marty)
363. 
364.         # Set a reverse m2m with an object from a different database
365.         with self.assertRaisesMessage(ValueError, msg):
366.             with transaction.atomic(using='other'):
367.                 dive.authors.set([mark, marty])
368. 
369.     def test_m2m_deletion(self):
370.         "Cascaded deletions of m2m relations issue queries on the right database"
371.         # Create a book and author on the other database
372.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
373.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
374.         dive.authors.set([mark])
375. 
376.         # Check the initial state
377.         self.assertEqual(Person.objects.using('default').count(), 0)
378.         self.assertEqual(Book.objects.using('default').count(), 0)
379.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
380. 
381.         self.assertEqual(Person.objects.using('other').count(), 1)
382.         self.assertEqual(Book.objects.using('other').count(), 1)
383.         self.assertEqual(Book.authors.through.objects.using('other').count(), 1)
384. 
385.         # Delete the object on the other database
386.         dive.delete(using='other')
387. 
388.         self.assertEqual(Person.objects.using('default').count(), 0)
389.         self.assertEqual(Book.objects.using('default').count(), 0)
390.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
391. 
392.         # The person still exists ...
393.         self.assertEqual(Person.objects.using('other').count(), 1)
394.         # ... but the book has been deleted
395.         self.assertEqual(Book.objects.using('other').count(), 0)
396.         # ... and the relationship object has also been deleted.
397.         self.assertEqual(Book.authors.through.objects.using('other').count(), 0)
398. 
399.         # Now try deletion in the reverse direction. Set up the relation again
400.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
401.         dive.authors.set([mark])
402. 
403.         # Check the initial state
404.         self.assertEqual(Person.objects.using('default').count(), 0)
405.         self.assertEqual(Book.objects.using('default').count(), 0)
406.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
407. 
408.         self.assertEqual(Person.objects.using('other').count(), 1)
409.         self.assertEqual(Book.objects.using('other').count(), 1)
410.         self.assertEqual(Book.authors.through.objects.using('other').count(), 1)
411. 
412.         # Delete the object on the other database
413.         mark.delete(using='other')
414. 
415.         self.assertEqual(Person.objects.using('default').count(), 0)
416.         self.assertEqual(Book.objects.using('default').count(), 0)
417.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
418. 
419.         # The person has been deleted ...
420.         self.assertEqual(Person.objects.using('other').count(), 0)
421.         # ... but the book still exists
422.         self.assertEqual(Book.objects.using('other').count(), 1)
423.         # ... and the relationship object has been deleted.
424.         self.assertEqual(Book.authors.through.objects.using('other').count(), 0)
425. 
426.     def test_foreign_key_separation(self):
427.         "FK fields are constrained to a single database"
428.         # Create a book and author on the default database
429.         pro = Book.objects.create(title="Pro Django", published=datetime.date(2008, 12, 16))
430. 
431.         george = Person.objects.create(name="George Vilches")
432. 
433.         # Create a book and author on the other database
434.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
435.         chris = Person.objects.using('other').create(name="Chris Mills")
436. 
437.         # Save the author's favorite books
438.         pro.editor = george
439.         pro.save()
440. 
441.         dive.editor = chris
442.         dive.save()
443. 
444.         pro = Book.objects.using('default').get(title="Pro Django")
445.         self.assertEqual(pro.editor.name, "George Vilches")
446. 
447.         dive = Book.objects.using('other').get(title="Dive into Python")
448.         self.assertEqual(dive.editor.name, "Chris Mills")
449. 
450.         # Queries work across foreign key joins
451.         self.assertEqual(
452.             list(Person.objects.using('default').filter(edited__title='Pro Django').values_list('name', flat=True)),
453.             ['George Vilches']
454.         )
455.         self.assertEqual(
456.             list(Person.objects.using('other').filter(edited__title='Pro Django').values_list('name', flat=True)),
457.             []
458.         )
459. 
460.         self.assertEqual(
461.             list(
462.                 Person.objects.using('default').filter(edited__title='Dive into Python').values_list('name', flat=True)
463.             ),
464.             []
465.         )
466.         self.assertEqual(
467.             list(
468.                 Person.objects.using('other').filter(edited__title='Dive into Python').values_list('name', flat=True)
469.             ),
470.             ['Chris Mills']
471.         )
472. 
473.         # Reget the objects to clear caches
474.         chris = Person.objects.using('other').get(name="Chris Mills")
475.         dive = Book.objects.using('other').get(title="Dive into Python")
476. 
477.         # Retrieve related object by descriptor. Related objects should be database-bound
478.         self.assertEqual(list(chris.edited.values_list('title', flat=True)), ['Dive into Python'])
479. 
480.     def test_foreign_key_reverse_operations(self):
481.         "FK reverse manipulations are all constrained to a single DB"
482.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
483.         chris = Person.objects.using('other').create(name="Chris Mills")
484. 
485.         # Save the author relations
486.         dive.editor = chris
487.         dive.save()
488. 
489.         # Add a second book edited by chris
490.         html5 = Book.objects.using('other').create(title="Dive into HTML5", published=datetime.date(2010, 3, 15))
491.         self.assertEqual(
492.             list(Person.objects.using('other').filter(edited__title='Dive into HTML5').values_list('name', flat=True)),
493.             []
494.         )
495. 
496.         chris.edited.add(html5)
497.         self.assertEqual(
498.             list(Person.objects.using('other').filter(edited__title='Dive into HTML5').values_list('name', flat=True)),
499.             ['Chris Mills']
500.         )

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 22:18:52,514 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `tests/migrations/test_commands.py`.\n   - This context block contains the first 500 lines of that file.\n2. Extended relevance:\n   - Providing the full file content is necessary to directly answer the user's query.", relative_path='tests/migrations/test_commands.py', start_line=1, end_line=500), ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `tests/migrations/test_commands.py`.\n   - This context block contains lines 24-775 of that file, which is a subsequent part of the file requested.\n2. Extended relevance:\n   - Providing the full file content is necessary to directly answer the user's query.", relative_path='tests/migrations/test_commands.py', start_line=24, end_line=775), ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `tests/migrations/test_commands.py`.\n   - This context block contains lines 778-1464 of that file, which is a subsequent part of the file requested.\n2. Extended relevance:\n   - Providing the full file content is necessary to directly answer the user's query.", relative_path='tests/migrations/test_commands.py', start_line=778, end_line=1464), ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `tests/migrations/test_commands.py`.\n   - This context block contains lines 1564-1623 of that file, which is a subsequent part of the file requested.\n2. Extended relevance:\n   - Providing the full file content is necessary to directly answer the user's query.", relative_path='tests/migrations/test_commands.py', start_line=1564, end_line=1623), ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `tests/multiple_database/tests.py`.\n   - This context block contains the first 500 lines of that file.\n2. Extended relevance:\n   - Providing the full file content is necessary to directly answer the user's query.", relative_path='tests/multiple_database/tests.py', start_line=1, end_line=500)]
2025-12-23 22:18:52,519 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 5 contexts to memory for query: Please provide the full content of the files `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`.
2025-12-23 22:18:52,519 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 22:18:52,519 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 22:18:52,520 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 5 new contexts to 4 existing contexts
2025-12-23 22:18:52,521 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 9 total contexts (removed 0 duplicates)
2025-12-23 22:18:52,522 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
django
├── .tx
├── CONTRIBUTING.rst
├── Gruntfile.js
├── README.rst
├── django
|   ├── __init__.py
|   ├── __main__.py
|   ├── apps
|   |   ├── __init__.py
|   |   ├── config.py
|   |   └── registry.py
|   ├── bin
|   |   └── django-admin.py
|   ├── conf
|   |   ├── __init__.py
|   |   ├── app_template
|   |   |   └── migrations
|   |   ├── global_settings.py
|   |   ├── locale
|   |   |   ├── __init__.py
|   |   |   ├── af
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ar
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ast
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── az
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── be
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── bg
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── bn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── br
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── bs
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ca
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── cs
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── cy
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── da
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── de
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── de_CH
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── dsb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── el
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en_AU
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── en_GB
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── eo
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_AR
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_CO
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_MX
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_NI
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_PR
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── es_VE
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── et
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── eu
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fa
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── fy
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ga
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── gd
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── gl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── he
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hsb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── hu
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── hy
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ia
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── id
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── io
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── is
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── it
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ja
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ka
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── kab
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── kk
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── km
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── kn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ko
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── lb
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── lt
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── lv
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ml
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── mr
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── my
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── nb
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ne
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── nl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── nn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── os
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── pa
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── pl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── pt
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── pt_BR
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ro
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ru
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sl
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sq
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sr_Latn
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sv
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── sw
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── ta
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── te
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── th
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── tr
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── tt
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── udm
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── uk
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── ur
|   |   |   |   └── LC_MESSAGES
|   |   |   ├── vi
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   ├── zh_Hans
|   |   |   |   ├── LC_MESSAGES
|   |   |   |   ├── __init__.py
|   |   |   |   └── formats.py
|   |   |   └── zh_Hant
|   |   |       ├── LC_MESSAGES
|   |   |       ├── __init__.py
|   |   |       └── formats.py
|   |   ├── project_template
|   |   |   └── project_name
|   |   └── urls
|   |       ├── __init__.py
|   |       ├── i18n.py
|   |       └── static.py
|   ├── contrib
|   |   ├── __init__.py
|   |   ├── admin
|   |   |   ├── __init__.py
|   |   |   ├── actions.py
|   |   |   ├── apps.py
|   |   |   ├── bin
|   |   |   |   └── compress.py
|   |   |   ├── checks.py
|   |   |   ├── decorators.py
|   |   |   ├── exceptions.py
|   |   |   ├── filters.py
|   |   |   ├── forms.py
|   |   |   ├── helpers.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── am
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_logentry_remove_auto_add.py
|   |   |   |   ├── 0003_logentry_add_action_flag_choices.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── options.py
|   |   |   ├── sites.py
|   |   |   ├── static
|   |   |   |   └── admin
|   |   |   ├── templates
|   |   |   |   ├── admin
|   |   |   |   └── registration
|   |   |   ├── templatetags
|   |   |   |   ├── __init__.py
|   |   |   |   ├── admin_list.py
|   |   |   |   ├── admin_modify.py
|   |   |   |   ├── admin_urls.py
|   |   |   |   ├── base.py
|   |   |   |   └── log.py
|   |   |   ├── tests.py
|   |   |   ├── utils.py
|   |   |   ├── views
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autocomplete.py
|   |   |   |   ├── decorators.py
|   |   |   |   └── main.py
|   |   |   └── widgets.py
|   |   ├── admindocs
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── templates
|   |   |   |   └── admin_doc
|   |   |   ├── urls.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   ├── auth
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── backends.py
|   |   |   ├── base_user.py
|   |   |   ├── checks.py
|   |   |   ├── context_processors.py
|   |   |   ├── decorators.py
|   |   |   ├── forms.py
|   |   |   ├── handlers
|   |   |   |   ├── __init__.py
|   |   |   |   └── modwsgi.py
|   |   |   ├── hashers.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   ├── __init__.py
|   |   |   |   └── commands
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_alter_permission_name_max_length.py
|   |   |   |   ├── 0003_alter_user_email_max_length.py
|   |   |   |   ├── 0004_alter_user_username_opts.py
|   |   |   |   ├── 0005_alter_user_last_login_null.py
|   |   |   |   ├── 0006_require_contenttypes_0002.py
|   |   |   |   ├── 0007_alter_validators_add_error_messages.py
|   |   |   |   ├── 0008_alter_user_username_max_length.py
|   |   |   |   ├── 0009_alter_user_last_name_max_length.py
|   |   |   |   ├── 0010_alter_group_name_max_length.py
|   |   |   |   ├── 0011_update_proxy_permissions.py
|   |   |   |   └── __init__.py
|   |   |   ├── mixins.py
|   |   |   ├── models.py
|   |   |   ├── password_validation.py
|   |   |   ├── signals.py
|   |   |   ├── templates
|   |   |   |   ├── auth
|   |   |   |   └── registration
|   |   |   ├── tokens.py
|   |   |   ├── urls.py
|   |   |   ├── validators.py
|   |   |   └── views.py
|   |   ├── contenttypes
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── checks.py
|   |   |   ├── fields.py
|   |   |   ├── forms.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   ├── __init__.py
|   |   |   |   └── commands
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_remove_content_type_name.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   └── views.py
|   |   ├── flatpages
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── forms.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── sitemaps.py
|   |   |   ├── templatetags
|   |   |   |   ├── __init__.py
|   |   |   |   └── flatpages.py
|   |   |   ├── urls.py
|   |   |   └── views.py
|   |   ├── gis
|   |   |   ├── __init__.py
|   |   |   ├── admin
|   |   |   |   ├── __init__.py
|   |   |   |   ├── options.py
|   |   |   |   └── widgets.py
|   |   |   ├── apps.py
|   |   |   ├── db
|   |   |   |   ├── __init__.py
|   |   |   |   ├── backends
|   |   |   |   └── models
|   |   |   ├── feeds.py
|   |   |   ├── forms
|   |   |   |   ├── __init__.py
|   |   |   |   ├── fields.py
|   |   |   |   └── widgets.py
|   |   |   ├── gdal
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── datasource.py
|   |   |   |   ├── driver.py
|   |   |   |   ├── envelope.py
|   |   |   |   ├── error.py
|   |   |   |   ├── feature.py
|   |   |   |   ├── field.py
|   |   |   |   ├── geometries.py
|   |   |   |   ├── geomtype.py
|   |   |   |   ├── layer.py
|   |   |   |   ├── libgdal.py
|   |   |   |   ├── prototypes
|   |   |   |   ├── raster
|   |   |   |   └── srs.py
|   |   |   ├── geoip2
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   └── resources.py
|   |   |   ├── geometry.py
|   |   |   ├── geos
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── collections.py
|   |   |   |   ├── coordseq.py
|   |   |   |   ├── error.py
|   |   |   |   ├── factory.py
|   |   |   |   ├── geometry.py
|   |   |   |   ├── io.py
|   |   |   |   ├── libgeos.py
|   |   |   |   ├── linestring.py
|   |   |   |   ├── mutable_list.py
|   |   |   |   ├── point.py
|   |   |   |   ├── polygon.py
|   |   |   |   ├── prepared.py
|   |   |   |   └── prototypes
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── measure.py
|   |   |   ├── ptr.py
|   |   |   ├── serializers
|   |   |   |   ├── __init__.py
|   |   |   |   └── geojson.py
|   |   |   ├── shortcuts.py
|   |   |   ├── sitemaps
|   |   |   |   ├── __init__.py
|   |   |   |   ├── kml.py
|   |   |   |   └── views.py
|   |   |   ├── static
|   |   |   |   └── gis
|   |   |   ├── templates
|   |   |   |   └── gis
|   |   |   ├── utils
|   |   |   |   ├── __init__.py
|   |   |   |   ├── layermapping.py
|   |   |   |   ├── ogrinfo.py
|   |   |   |   ├── ogrinspect.py
|   |   |   |   └── srs.py
|   |   |   └── views.py
|   |   ├── humanize
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   └── templatetags
|   |   |       ├── __init__.py
|   |   |       └── humanize.py
|   |   ├── messages
|   |   |   ├── __init__.py
|   |   |   ├── api.py
|   |   |   ├── apps.py
|   |   |   ├── constants.py
|   |   |   ├── context_processors.py
|   |   |   ├── middleware.py
|   |   |   ├── storage
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── cookie.py
|   |   |   |   ├── fallback.py
|   |   |   |   └── session.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   ├── postgres
|   |   |   ├── __init__.py
|   |   |   ├── aggregates
|   |   |   |   ├── __init__.py
|   |   |   |   ├── general.py
|   |   |   |   ├── mixins.py
|   |   |   |   └── statistics.py
|   |   |   ├── apps.py
|   |   |   ├── fields
|   |   |   |   ├── __init__.py
|   |   |   |   ├── array.py
|   |   |   |   ├── citext.py
|   |   |   |   ├── hstore.py
|   |   |   |   ├── jsonb.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── ranges.py
|   |   |   |   └── utils.py
|   |   |   ├── forms
|   |   |   |   ├── __init__.py
|   |   |   |   ├── array.py
|   |   |   |   ├── hstore.py
|   |   |   |   ├── jsonb.py
|   |   |   |   └── ranges.py
|   |   |   ├── functions.py
|   |   |   ├── indexes.py
|   |   |   ├── jinja2
|   |   |   |   └── postgres
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kk
|   |   |   |   ├── ko
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── mn
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sv
|   |   |   |   ├── tr
|   |   |   |   ├── uk
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── lookups.py
|   |   |   ├── operations.py
|   |   |   ├── search.py
|   |   |   ├── serializers.py
|   |   |   ├── signals.py
|   |   |   ├── templates
|   |   |   |   └── postgres
|   |   |   ├── utils.py
|   |   |   └── validators.py
|   |   ├── redirects
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   └── models.py
|   |   ├── sessions
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── cache.py
|   |   |   |   ├── cached_db.py
|   |   |   |   ├── db.py
|   |   |   |   ├── file.py
|   |   |   |   └── signed_cookies.py
|   |   |   ├── base_session.py
|   |   |   ├── exceptions.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   └── serializers.py
|   |   ├── sitemaps
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── templates
|   |   |   |   ├── sitemap.xml
|   |   |   |   └── sitemap_index.xml
|   |   |   └── views.py
|   |   ├── sites
|   |   |   ├── __init__.py
|   |   |   ├── admin.py
|   |   |   ├── apps.py
|   |   |   ├── locale
|   |   |   |   ├── af
|   |   |   |   ├── ar
|   |   |   |   ├── ast
|   |   |   |   ├── az
|   |   |   |   ├── be
|   |   |   |   ├── bg
|   |   |   |   ├── bn
|   |   |   |   ├── br
|   |   |   |   ├── bs
|   |   |   |   ├── ca
|   |   |   |   ├── cs
|   |   |   |   ├── cy
|   |   |   |   ├── da
|   |   |   |   ├── de
|   |   |   |   ├── dsb
|   |   |   |   ├── el
|   |   |   |   ├── en
|   |   |   |   ├── en_AU
|   |   |   |   ├── en_GB
|   |   |   |   ├── eo
|   |   |   |   ├── es
|   |   |   |   ├── es_AR
|   |   |   |   ├── es_CO
|   |   |   |   ├── es_MX
|   |   |   |   ├── es_VE
|   |   |   |   ├── et
|   |   |   |   ├── eu
|   |   |   |   ├── fa
|   |   |   |   ├── fi
|   |   |   |   ├── fr
|   |   |   |   ├── fy
|   |   |   |   ├── ga
|   |   |   |   ├── gd
|   |   |   |   ├── gl
|   |   |   |   ├── he
|   |   |   |   ├── hi
|   |   |   |   ├── hr
|   |   |   |   ├── hsb
|   |   |   |   ├── hu
|   |   |   |   ├── hy
|   |   |   |   ├── ia
|   |   |   |   ├── id
|   |   |   |   ├── io
|   |   |   |   ├── is
|   |   |   |   ├── it
|   |   |   |   ├── ja
|   |   |   |   ├── ka
|   |   |   |   ├── kab
|   |   |   |   ├── kk
|   |   |   |   ├── km
|   |   |   |   ├── kn
|   |   |   |   ├── ko
|   |   |   |   ├── lb
|   |   |   |   ├── lt
|   |   |   |   ├── lv
|   |   |   |   ├── mk
|   |   |   |   ├── ml
|   |   |   |   ├── mn
|   |   |   |   ├── mr
|   |   |   |   ├── my
|   |   |   |   ├── nb
|   |   |   |   ├── ne
|   |   |   |   ├── nl
|   |   |   |   ├── nn
|   |   |   |   ├── os
|   |   |   |   ├── pa
|   |   |   |   ├── pl
|   |   |   |   ├── pt
|   |   |   |   ├── pt_BR
|   |   |   |   ├── ro
|   |   |   |   ├── ru
|   |   |   |   ├── sk
|   |   |   |   ├── sl
|   |   |   |   ├── sq
|   |   |   |   ├── sr
|   |   |   |   ├── sr_Latn
|   |   |   |   ├── sv
|   |   |   |   ├── sw
|   |   |   |   ├── ta
|   |   |   |   ├── te
|   |   |   |   ├── th
|   |   |   |   ├── tr
|   |   |   |   ├── tt
|   |   |   |   ├── udm
|   |   |   |   ├── uk
|   |   |   |   ├── ur
|   |   |   |   ├── uz
|   |   |   |   ├── vi
|   |   |   |   ├── zh_Hans
|   |   |   |   └── zh_Hant
|   |   |   ├── management.py
|   |   |   ├── managers.py
|   |   |   ├── middleware.py
|   |   |   ├── migrations
|   |   |   |   ├── 0001_initial.py
|   |   |   |   ├── 0002_alter_domain_unique.py
|   |   |   |   └── __init__.py
|   |   |   ├── models.py
|   |   |   ├── requests.py
|   |   |   └── shortcuts.py
|   |   ├── staticfiles
|   |   |   ├── __init__.py
|   |   |   ├── apps.py
|   |   |   ├── checks.py
|   |   |   ├── finders.py
|   |   |   ├── handlers.py
|   |   |   ├── management
|   |   |   |   └── commands
|   |   |   ├── storage.py
|   |   |   ├── testing.py
|   |   |   ├── urls.py
|   |   |   ├── utils.py
|   |   |   └── views.py
|   |   └── syndication
|   |       ├── __init__.py
|   |       ├── apps.py
|   |       └── views.py
|   ├── core
|   |   ├── __init__.py
|   |   ├── cache
|   |   |   ├── __init__.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── db.py
|   |   |   |   ├── dummy.py
|   |   |   |   ├── filebased.py
|   |   |   |   ├── locmem.py
|   |   |   |   └── memcached.py
|   |   |   └── utils.py
|   |   ├── checks
|   |   |   ├── __init__.py
|   |   |   ├── caches.py
|   |   |   ├── compatibility
|   |   |   |   └── __init__.py
|   |   |   ├── database.py
|   |   |   ├── messages.py
|   |   |   ├── model_checks.py
|   |   |   ├── registry.py
|   |   |   ├── security
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── csrf.py
|   |   |   |   └── sessions.py
|   |   |   ├── templates.py
|   |   |   ├── translation.py
|   |   |   └── urls.py
|   |   ├── exceptions.py
|   |   ├── files
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── images.py
|   |   |   ├── locks.py
|   |   |   ├── move.py
|   |   |   ├── storage.py
|   |   |   ├── temp.py
|   |   |   ├── uploadedfile.py
|   |   |   ├── uploadhandler.py
|   |   |   └── utils.py
|   |   ├── handlers
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── exception.py
|   |   |   └── wsgi.py
|   |   ├── mail
|   |   |   ├── __init__.py
|   |   |   ├── backends
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── console.py
|   |   |   |   ├── dummy.py
|   |   |   |   ├── filebased.py
|   |   |   |   ├── locmem.py
|   |   |   |   └── smtp.py
|   |   |   ├── message.py
|   |   |   └── utils.py
|   |   ├── management
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── color.py
|   |   |   ├── commands
|   |   |   |   ├── check.py
|   |   |   |   ├── compilemessages.py
|   |   |   |   ├── createcachetable.py
|   |   |   |   ├── dbshell.py
|   |   |   |   ├── diffsettings.py
|   |   |   |   ├── dumpdata.py
|   |   |   |   ├── flush.py
|   |   |   |   ├── inspectdb.py
|   |   |   |   ├── loaddata.py
|   |   |   |   ├── makemessages.py
|   |   |   |   ├── makemigrations.py
|   |   |   |   ├── migrate.py
|   |   |   |   ├── runserver.py
|   |   |   |   ├── sendtestemail.py
|   |   |   |   ├── shell.py
|   |   |   |   ├── showmigrations.py
|   |   |   |   ├── sqlflush.py
|   |   |   |   ├── sqlmigrate.py
|   |   |   |   ├── sqlsequencereset.py
|   |   |   |   ├── squashmigrations.py
|   |   |   |   ├── startapp.py
|   |   |   |   ├── startproject.py
|   |   |   |   ├── test.py
|   |   |   |   └── testserver.py
|   |   |   ├── sql.py
|   |   |   ├── templates.py
|   |   |   └── utils.py
|   |   ├── paginator.py
|   |   ├── serializers
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── json.py
|   |   |   ├── python.py
|   |   |   ├── pyyaml.py
|   |   |   └── xml_serializer.py
|   |   ├── servers
|   |   |   ├── __init__.py
|   |   |   └── basehttp.py
|   |   ├── signals.py
|   |   ├── signing.py
|   |   ├── validators.py
|   |   └── wsgi.py
|   ├── db
|   |   ├── __init__.py
|   |   ├── backends
|   |   |   ├── __init__.py
|   |   |   ├── base
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── validation.py
|   |   |   ├── ddl_references.py
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   └── features.py
|   |   |   ├── mysql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── compiler.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── validation.py
|   |   |   ├── oracle
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── functions.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   ├── utils.py
|   |   |   |   └── validation.py
|   |   |   ├── postgresql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   ├── schema.py
|   |   |   |   └── utils.py
|   |   |   ├── signals.py
|   |   |   ├── sqlite3
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── client.py
|   |   |   |   ├── creation.py
|   |   |   |   ├── features.py
|   |   |   |   ├── introspection.py
|   |   |   |   ├── operations.py
|   |   |   |   └── schema.py
|   |   |   └── utils.py
|   |   ├── migrations
|   |   |   ├── __init__.py
|   |   |   ├── autodetector.py
|   |   |   ├── exceptions.py
|   |   |   ├── executor.py
|   |   |   ├── graph.py
|   |   |   ├── loader.py
|   |   |   ├── migration.py
|   |   |   ├── operations
|   |   |   |   ├── __init__.py
|   |   |   |   ├── base.py
|   |   |   |   ├── fields.py
|   |   |   |   ├── models.py
|   |   |   |   ├── special.py
|   |   |   |   └── utils.py
|   |   |   ├── optimizer.py
|   |   |   ├── questioner.py
|   |   |   ├── recorder.py
|   |   |   ├── serializer.py
|   |   |   ├── state.py
|   |   |   ├── utils.py
|   |   |   └── writer.py
|   |   ├── models
|   |   |   ├── __init__.py
|   |   |   ├── aggregates.py
|   |   |   ├── base.py
|   |   |   ├── constants.py
|   |   |   ├── constraints.py
|   |   |   ├── deletion.py
|   |   |   ├── expressions.py
|   |   |   ├── fields
|   |   |   |   ├── __init__.py
|   |   |   |   ├── files.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── proxy.py
|   |   |   |   ├── related.py
|   |   |   |   ├── related_descriptors.py
|   |   |   |   ├── related_lookups.py
|   |   |   |   └── reverse_related.py
|   |   |   ├── functions
|   |   |   |   ├── __init__.py
|   |   |   |   ├── comparison.py
|   |   |   |   ├── datetime.py
|   |   |   |   ├── math.py
|   |   |   |   ├── mixins.py
|   |   |   |   ├── text.py
|   |   |   |   └── window.py
|   |   |   ├── indexes.py
|   |   |   ├── lookups.py
|   |   |   ├── manager.py
|   |   |   ├── options.py
|   |   |   ├── query.py
|   |   |   ├── query_utils.py
|   |   |   ├── signals.py
|   |   |   ├── sql
|   |   |   |   ├── __init__.py
|   |   |   |   ├── compiler.py
|   |   |   |   ├── constants.py
|   |   |   |   ├── datastructures.py
|   |   |   |   ├── query.py
|   |   |   |   ├── subqueries.py
|   |   |   |   └── where.py
|   |   |   └── utils.py
|   |   ├── transaction.py
|   |   └── utils.py
|   ├── dispatch
|   |   ├── __init__.py
|   |   ├── dispatcher.py
|   |   └── license.txt
|   ├── forms
|   |   ├── __init__.py
|   |   ├── boundfield.py
|   |   ├── fields.py
|   |   ├── forms.py
|   |   ├── formsets.py
|   |   ├── jinja2
|   |   |   └── django
|   |   |       └── forms
|   |   ├── models.py
|   |   ├── renderers.py
|   |   ├── templates
|   |   |   └── django
|   |   |       └── forms
|   |   ├── utils.py
|   |   └── widgets.py
|   ├── http
|   |   ├── __init__.py
|   |   ├── cookie.py
|   |   ├── multipartparser.py
|   |   ├── request.py
|   |   └── response.py
|   ├── middleware
|   |   ├── __init__.py
|   |   ├── cache.py
|   |   ├── clickjacking.py
|   |   ├── common.py
|   |   ├── csrf.py
|   |   ├── gzip.py
|   |   ├── http.py
|   |   ├── locale.py
|   |   └── security.py
|   ├── shortcuts.py
|   ├── template
|   |   ├── __init__.py
|   |   ├── backends
|   |   |   ├── __init__.py
|   |   |   ├── base.py
|   |   |   ├── django.py
|   |   |   ├── dummy.py
|   |   |   ├── jinja2.py
|   |   |   └── utils.py
|   |   ├── base.py
|   |   ├── context.py
|   |   ├── context_processors.py
|   |   ├── defaultfilters.py
|   |   ├── defaulttags.py
|   |   ├── engine.py
|   |   ├── exceptions.py
|   |   ├── library.py
|   |   ├── loader.py
|   |   ├── loader_tags.py
|   |   ├── loaders
|   |   |   ├── __init__.py
|   |   |   ├── app_directories.py
|   |   |   ├── base.py
|   |   |   ├── cached.py
|   |   |   ├── filesystem.py
|   |   |   └── locmem.py
|   |   ├── response.py
|   |   ├── smartif.py
|   |   └── utils.py
|   ├── templatetags
|   |   ├── __init__.py
|   |   ├── cache.py
|   |   ├── i18n.py
|   |   ├── l10n.py
|   |   ├── static.py
|   |   └── tz.py
|   ├── test
|   |   ├── __init__.py
|   |   ├── client.py
|   |   ├── html.py
|   |   ├── runner.py
|   |   ├── selenium.py
|   |   ├── signals.py
|   |   ├── testcases.py
|   |   └── utils.py
|   ├── urls
|   |   ├── __init__.py
|   |   ├── base.py
|   |   ├── conf.py
|   |   ├── converters.py
|   |   ├── exceptions.py
|   |   ├── resolvers.py
|   |   └── utils.py
|   ├── utils
|   |   ├── __init__.py
|   |   ├── _os.py
|   |   ├── archive.py
|   |   ├── autoreload.py
|   |   ├── baseconv.py
|   |   ├── cache.py
|   |   ├── crypto.py
|   |   ├── datastructures.py
|   |   ├── dateformat.py
|   |   ├── dateparse.py
|   |   ├── dates.py
|   |   ├── datetime_safe.py
|   |   ├── deconstruct.py
|   |   ├── decorators.py
|   |   ├── deprecation.py
|   |   ├── duration.py
|   |   ├── encoding.py
|   |   ├── feedgenerator.py
|   |   ├── formats.py
|   |   ├── functional.py
|   |   ├── hashable.py
|   |   ├── html.py
|   |   ├── http.py
|   |   ├── inspect.py
|   |   ├── ipv6.py
|   |   ├── itercompat.py
|   |   ├── jslex.py
|   |   ├── log.py
|   |   ├── lorem_ipsum.py
|   |   ├── module_loading.py
|   |   ├── numberformat.py
|   |   ├── regex_helper.py
|   |   ├── safestring.py
|   |   ├── termcolors.py
|   |   ├── text.py
|   |   ├── timesince.py
|   |   ├── timezone.py
|   |   ├── topological_sort.py
|   |   ├── translation
|   |   |   ├── __init__.py
|   |   |   ├── reloader.py
|   |   |   ├── template.py
|   |   |   ├── trans_null.py
|   |   |   └── trans_real.py
|   |   ├── tree.py
|   |   ├── version.py
|   |   └── xmlutils.py
|   └── views
|       ├── __init__.py
|       ├── csrf.py
|       ├── debug.py
|       ├── decorators
|       |   ├── __init__.py
|       |   ├── cache.py
|       |   ├── clickjacking.py
|       |   ├── csrf.py
|       |   ├── debug.py
|       |   ├── gzip.py
|       |   ├── http.py
|       |   └── vary.py
|       ├── defaults.py
|       ├── generic
|       |   ├── __init__.py
|       |   ├── base.py
|       |   ├── dates.py
|       |   ├── detail.py
|       |   ├── edit.py
|       |   └── list.py
|       ├── i18n.py
|       ├── static.py
|       └── templates
|           ├── default_urlconf.html
|           ├── technical_404.html
|           ├── technical_500.html
|           └── technical_500.txt
├── docs
|   ├── _ext
|   |   └── djangodocs.py
|   ├── _theme
|   |   ├── djangodocs
|   |   |   ├── genindex.html
|   |   |   ├── layout.html
|   |   |   ├── modindex.html
|   |   |   ├── search.html
|   |   |   └── static
|   |   |       ├── console-tabs.css
|   |   |       ├── default.css
|   |   |       ├── djangodocs.css
|   |   |       ├── fontawesome
|   |   |       ├── homepage.css
|   |   |       └── reset-fonts-grids.css
|   |   └── djangodocs-epub
|   |       ├── epub-cover.html
|   |       └── static
|   |           └── epub.css
|   ├── conf.py
|   ├── contents.txt
|   ├── faq
|   |   ├── admin.txt
|   |   ├── contributing.txt
|   |   ├── general.txt
|   |   ├── help.txt
|   |   ├── index.txt
|   |   ├── install.txt
|   |   ├── models.txt
|   |   ├── troubleshooting.txt
|   |   └── usage.txt
|   ├── glossary.txt
|   ├── howto
|   |   ├── auth-remote-user.txt
|   |   ├── custom-file-storage.txt
|   |   ├── custom-lookups.txt
|   |   ├── custom-management-commands.txt
|   |   ├── custom-model-fields.txt
|   |   ├── custom-template-tags.txt
|   |   ├── deployment
|   |   |   ├── checklist.txt
|   |   |   ├── index.txt
|   |   |   └── wsgi
|   |   |       ├── apache-auth.txt
|   |   |       ├── gunicorn.txt
|   |   |       ├── index.txt
|   |   |       ├── modwsgi.txt
|   |   |       └── uwsgi.txt
|   |   ├── error-reporting.txt
|   |   ├── index.txt
|   |   ├── initial-data.txt
|   |   ├── jython.txt
|   |   ├── legacy-databases.txt
|   |   ├── outputting-csv.txt
|   |   ├── outputting-pdf.txt
|   |   ├── overriding-templates.txt
|   |   ├── static-files
|   |   |   ├── deployment.txt
|   |   |   └── index.txt
|   |   ├── upgrade-version.txt
|   |   ├── windows.txt
|   |   └── writing-migrations.txt
|   ├── index.txt
|   ├── internals
|   |   ├── _images
|   |   ├── contributing
|   |   |   ├── bugs-and-features.txt
|   |   |   ├── committing-code.txt
|   |   |   ├── index.txt
|   |   |   ├── localizing.txt
|   |   |   ├── new-contributors.txt
|   |   |   ├── triaging-tickets.txt
|   |   |   ├── writing-code
|   |   |   |   ├── coding-style.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── javascript.txt
|   |   |   |   ├── submitting-patches.txt
|   |   |   |   ├── unit-tests.txt
|   |   |   |   └── working-with-git.txt
|   |   |   └── writing-documentation.txt
|   |   ├── deprecation.txt
|   |   ├── git.txt
|   |   ├── howto-release-django.txt
|   |   ├── index.txt
|   |   ├── mailing-lists.txt
|   |   ├── organization.txt
|   |   ├── release-process.txt
|   |   └── security.txt
|   ├── intro
|   |   ├── _images
|   |   ├── contributing.txt
|   |   ├── index.txt
|   |   ├── install.txt
|   |   ├── overview.txt
|   |   ├── reusable-apps.txt
|   |   ├── tutorial01.txt
|   |   ├── tutorial02.txt
|   |   ├── tutorial03.txt
|   |   ├── tutorial04.txt
|   |   ├── tutorial05.txt
|   |   ├── tutorial06.txt
|   |   ├── tutorial07.txt
|   |   └── whatsnext.txt
|   ├── man
|   ├── misc
|   |   ├── api-stability.txt
|   |   ├── design-philosophies.txt
|   |   ├── distributions.txt
|   |   └── index.txt
|   ├── ref
|   |   ├── applications.txt
|   |   ├── checks.txt
|   |   ├── class-based-views
|   |   |   ├── base.txt
|   |   |   ├── flattened-index.txt
|   |   |   ├── generic-date-based.txt
|   |   |   ├── generic-display.txt
|   |   |   ├── generic-editing.txt
|   |   |   ├── index.txt
|   |   |   ├── mixins-date-based.txt
|   |   |   ├── mixins-editing.txt
|   |   |   ├── mixins-multiple-object.txt
|   |   |   ├── mixins-simple.txt
|   |   |   ├── mixins-single-object.txt
|   |   |   └── mixins.txt
|   |   ├── clickjacking.txt
|   |   ├── contrib
|   |   |   ├── admin
|   |   |   |   ├── _images
|   |   |   |   ├── actions.txt
|   |   |   |   ├── admindocs.txt
|   |   |   |   ├── index.txt
|   |   |   |   └── javascript.txt
|   |   |   ├── auth.txt
|   |   |   ├── contenttypes.txt
|   |   |   ├── flatpages.txt
|   |   |   ├── gis
|   |   |   |   ├── admin.txt
|   |   |   |   ├── commands.txt
|   |   |   |   ├── db-api.txt
|   |   |   |   ├── deployment.txt
|   |   |   |   ├── feeds.txt
|   |   |   |   ├── forms-api.txt
|   |   |   |   ├── functions.txt
|   |   |   |   ├── gdal.txt
|   |   |   |   ├── geoip2.txt
|   |   |   |   ├── geoquerysets.txt
|   |   |   |   ├── geos.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── install
|   |   |   |   ├── layermapping.txt
|   |   |   |   ├── measure.txt
|   |   |   |   ├── model-api.txt
|   |   |   |   ├── ogrinspect.txt
|   |   |   |   ├── serializers.txt
|   |   |   |   ├── sitemaps.txt
|   |   |   |   ├── testing.txt
|   |   |   |   ├── tutorial.txt
|   |   |   |   └── utils.txt
|   |   |   ├── humanize.txt
|   |   |   ├── index.txt
|   |   |   ├── messages.txt
|   |   |   ├── postgres
|   |   |   |   ├── aggregates.txt
|   |   |   |   ├── fields.txt
|   |   |   |   ├── forms.txt
|   |   |   |   ├── functions.txt
|   |   |   |   ├── index.txt
|   |   |   |   ├── indexes.txt
|   |   |   |   ├── lookups.txt
|   |   |   |   ├── operations.txt
|   |   |   |   ├── search.txt
|   |   |   |   └── validators.txt
|   |   |   ├── redirects.txt
|   |   |   ├── sitemaps.txt
|   |   |   ├── sites.txt
|   |   |   ├── staticfiles.txt
|   |   |   └── syndication.txt
|   |   ├── csrf.txt
|   |   ├── databases.txt
|   |   ├── django-admin.txt
|   |   ├── exceptions.txt
|   |   ├── files
|   |   |   ├── file.txt
|   |   |   ├── index.txt
|   |   |   ├── storage.txt
|   |   |   └── uploads.txt
|   |   ├── forms
|   |   |   ├── api.txt
|   |   |   ├── fields.txt
|   |   |   ├── formsets.txt
|   |   |   ├── index.txt
|   |   |   ├── models.txt
|   |   |   ├── renderers.txt
|   |   |   ├── validation.txt
|   |   |   └── widgets.txt
|   |   ├── index.txt
|   |   ├── middleware.txt
|   |   ├── migration-operations.txt
|   |   ├── models
|   |   |   ├── class.txt
|   |   |   ├── conditional-expressions.txt
|   |   |   ├── constraints.txt
|   |   |   ├── database-functions.txt
|   |   |   ├── expressions.txt
|   |   |   ├── fields.txt
|   |   |   ├── index.txt
|   |   |   ├── indexes.txt
|   |   |   ├── instances.txt
|   |   |   ├── lookups.txt
|   |   |   ├── meta.txt
|   |   |   ├── options.txt
|   |   |   ├── querysets.txt
|   |   |   └── relations.txt
|   |   ├── request-response.txt
|   |   ├── schema-editor.txt
|   |   ├── settings.txt
|   |   ├── signals.txt
|   |   ├── template-response.txt
|   |   ├── templates
|   |   |   ├── api.txt
|   |   |   ├── builtins.txt
|   |   |   ├── index.txt
|   |   |   └── language.txt
|   |   ├── unicode.txt
|   |   ├── urlresolvers.txt
|   |   ├── urls.txt
|   |   ├── utils.txt
|   |   ├── validators.txt
|   |   └── views.txt
|   ├── releases
|   |   ├── 0.95.txt
|   |   ├── 0.96.txt
|   |   ├── 1.0-porting-guide.txt
|   |   ├── 1.0.1.txt
|   |   ├── 1.0.2.txt
|   |   ├── 1.0.txt
|   |   ├── 1.1.2.txt
|   |   ├── 1.1.3.txt
|   |   ├── 1.1.4.txt
|   |   ├── 1.1.txt
|   |   ├── 1.10.1.txt
|   |   ├── 1.10.2.txt
|   |   ├── 1.10.3.txt
|   |   ├── 1.10.4.txt
|   |   ├── 1.10.5.txt
|   |   ├── 1.10.6.txt
|   |   ├── 1.10.7.txt
|   |   ├── 1.10.8.txt
|   |   ├── 1.10.txt
|   |   ├── 1.11.1.txt
|   |   ├── 1.11.10.txt
|   |   ├── 1.11.11.txt
|   |   ├── 1.11.12.txt
|   |   ├── 1.11.13.txt
|   |   ├── 1.11.14.txt
|   |   ├── 1.11.15.txt
|   |   ├── 1.11.16.txt
|   |   ├── 1.11.17.txt
|   |   ├── 1.11.18.txt
|   |   ├── 1.11.19.txt
|   |   ├── 1.11.2.txt
|   |   ├── 1.11.20.txt
|   |   ├── 1.11.21.txt
|   |   ├── 1.11.3.txt
|   |   ├── 1.11.4.txt
|   |   ├── 1.11.5.txt
|   |   ├── 1.11.6.txt
|   |   ├── 1.11.7.txt
|   |   ├── 1.11.8.txt
|   |   ├── 1.11.9.txt
|   |   ├── 1.11.txt
|   |   ├── 1.2.1.txt
|   |   ├── 1.2.2.txt
|   |   ├── 1.2.3.txt
|   |   ├── 1.2.4.txt
|   |   ├── 1.2.5.txt
|   |   ├── 1.2.6.txt
|   |   ├── 1.2.7.txt
|   |   ├── 1.2.txt
|   |   ├── 1.3.1.txt
|   |   ├── 1.3.2.txt
|   |   ├── 1.3.3.txt
|   |   ├── 1.3.4.txt
|   |   ├── 1.3.5.txt
|   |   ├── 1.3.6.txt
|   |   ├── 1.3.7.txt
|   |   ├── 1.3.txt
|   |   ├── 1.4.1.txt
|   |   ├── 1.4.10.txt
|   |   ├── 1.4.11.txt
|   |   ├── 1.4.12.txt
|   |   ├── 1.4.13.txt
|   |   ├── 1.4.14.txt
|   |   ├── 1.4.15.txt
|   |   ├── 1.4.16.txt
|   |   ├── 1.4.17.txt
|   |   ├── 1.4.18.txt
|   |   ├── 1.4.19.txt
|   |   ├── 1.4.2.txt
|   |   ├── 1.4.20.txt
|   |   ├── 1.4.21.txt
|   |   ├── 1.4.22.txt
|   |   ├── 1.4.3.txt
|   |   ├── 1.4.4.txt
|   |   ├── 1.4.5.txt
|   |   ├── 1.4.6.txt
|   |   ├── 1.4.7.txt
|   |   ├── 1.4.8.txt
|   |   ├── 1.4.9.txt
|   |   ├── 1.4.txt
|   |   ├── 1.5.1.txt
|   |   ├── 1.5.10.txt
|   |   ├── 1.5.11.txt
|   |   ├── 1.5.12.txt
|   |   ├── 1.5.2.txt
|   |   ├── 1.5.3.txt
|   |   ├── 1.5.4.txt
|   |   ├── 1.5.5.txt
|   |   ├── 1.5.6.txt
|   |   ├── 1.5.7.txt
|   |   ├── 1.5.8.txt
|   |   ├── 1.5.9.txt
|   |   ├── 1.5.txt
|   |   ├── 1.6.1.txt
|   |   ├── 1.6.10.txt
|   |   ├── 1.6.11.txt
|   |   ├── 1.6.2.txt
|   |   ├── 1.6.3.txt
|   |   ├── 1.6.4.txt
|   |   ├── 1.6.5.txt
|   |   ├── 1.6.6.txt
|   |   ├── 1.6.7.txt
|   |   ├── 1.6.8.txt
|   |   ├── 1.6.9.txt
|   |   ├── 1.6.txt
|   |   ├── 1.7.1.txt
|   |   ├── 1.7.10.txt
|   |   ├── 1.7.11.txt
|   |   ├── 1.7.2.txt
|   |   ├── 1.7.3.txt
|   |   ├── 1.7.4.txt
|   |   ├── 1.7.5.txt
|   |   ├── 1.7.6.txt
|   |   ├── 1.7.7.txt
|   |   ├── 1.7.8.txt
|   |   ├── 1.7.9.txt
|   |   ├── 1.7.txt
|   |   ├── 1.8.1.txt
|   |   ├── 1.8.10.txt
|   |   ├── 1.8.11.txt
|   |   ├── 1.8.12.txt
|   |   ├── 1.8.13.txt
|   |   ├── 1.8.14.txt
|   |   ├── 1.8.15.txt
|   |   ├── 1.8.16.txt
|   |   ├── 1.8.17.txt
|   |   ├── 1.8.18.txt
|   |   ├── 1.8.19.txt
|   |   ├── 1.8.2.txt
|   |   ├── 1.8.3.txt
|   |   ├── 1.8.4.txt
|   |   ├── 1.8.5.txt
|   |   ├── 1.8.6.txt
|   |   ├── 1.8.7.txt
|   |   ├── 1.8.8.txt
|   |   ├── 1.8.9.txt
|   |   ├── 1.8.txt
|   |   ├── 1.9.1.txt
|   |   ├── 1.9.10.txt
|   |   ├── 1.9.11.txt
|   |   ├── 1.9.12.txt
|   |   ├── 1.9.13.txt
|   |   ├── 1.9.2.txt
|   |   ├── 1.9.3.txt
|   |   ├── 1.9.4.txt
|   |   ├── 1.9.5.txt
|   |   ├── 1.9.6.txt
|   |   ├── 1.9.7.txt
|   |   ├── 1.9.8.txt
|   |   ├── 1.9.9.txt
|   |   ├── 1.9.txt
|   |   ├── 2.0.1.txt
|   |   ├── 2.0.10.txt
|   |   ├── 2.0.11.txt
|   |   ├── 2.0.12.txt
|   |   ├── 2.0.13.txt
|   |   ├── 2.0.2.txt
|   |   ├── 2.0.3.txt
|   |   ├── 2.0.4.txt
|   |   ├── 2.0.5.txt
|   |   ├── 2.0.6.txt
|   |   ├── 2.0.7.txt
|   |   ├── 2.0.8.txt
|   |   ├── 2.0.9.txt
|   |   ├── 2.0.txt
|   |   ├── 2.1.1.txt
|   |   ├── 2.1.2.txt
|   |   ├── 2.1.3.txt
|   |   ├── 2.1.4.txt
|   |   ├── 2.1.5.txt
|   |   ├── 2.1.6.txt
|   |   ├── 2.1.7.txt
|   |   ├── 2.1.8.txt
|   |   ├── 2.1.9.txt
|   |   ├── 2.1.txt
|   |   ├── 2.2.1.txt
|   |   ├── 2.2.2.txt
|   |   ├── 2.2.3.txt
|   |   ├── 2.2.txt
|   |   ├── 3.0.txt
|   |   ├── index.txt
|   |   └── security.txt
|   └── topics
|       ├── _images
|       ├── auth
|       |   ├── customizing.txt
|       |   ├── default.txt
|       |   ├── index.txt
|       |   └── passwords.txt
|       ├── cache.txt
|       ├── checks.txt
|       ├── class-based-views
|       |   ├── generic-display.txt
|       |   ├── generic-editing.txt
|       |   ├── index.txt
|       |   ├── intro.txt
|       |   └── mixins.txt
|       ├── conditional-view-processing.txt
|       ├── db
|       |   ├── aggregation.txt
|       |   ├── examples
|       |   |   ├── index.txt
|       |   |   ├── many_to_many.txt
|       |   |   ├── many_to_one.txt
|       |   |   └── one_to_one.txt
|       |   ├── index.txt
|       |   ├── instrumentation.txt
|       |   ├── managers.txt
|       |   ├── models.txt
|       |   ├── multi-db.txt
|       |   ├── optimization.txt
|       |   ├── queries.txt
|       |   ├── search.txt
|       |   ├── sql.txt
|       |   ├── tablespaces.txt
|       |   └── transactions.txt
|       ├── email.txt
|       ├── external-packages.txt
|       ├── files.txt
|       ├── forms
|       |   ├── formsets.txt
|       |   ├── index.txt
|       |   ├── media.txt
|       |   └── modelforms.txt
|       ├── http
|       |   ├── _images
|       |   ├── decorators.txt
|       |   ├── file-uploads.txt
|       |   ├── generic-views.txt
|       |   ├── index.txt
|       |   ├── middleware.txt
|       |   ├── sessions.txt
|       |   ├── shortcuts.txt
|       |   ├── urls.txt
|       |   └── views.txt
|       ├── i18n
|       |   ├── formatting.txt
|       |   ├── index.txt
|       |   ├── timezones.txt
|       |   └── translation.txt
|       ├── index.txt
|       ├── install.txt
|       ├── logging.txt
|       ├── migrations.txt
|       ├── pagination.txt
|       ├── performance.txt
|       ├── security.txt
|       ├── serialization.txt
|       ├── settings.txt
|       ├── signals.txt
|       ├── signing.txt
|       ├── templates.txt
|       └── testing
|           ├── _images
|           ├── advanced.txt
|           ├── index.txt
|           ├── overview.txt
|           └── tools.txt
├── extras
├── js_tests
|   ├── admin
|   |   ├── DateTimeShortcuts.test.js
|   |   ├── RelatedObjectLookups.test.js
|   |   ├── SelectBox.test.js
|   |   ├── SelectFilter2.test.js
|   |   ├── URLify.test.js
|   |   ├── actions.test.js
|   |   ├── core.test.js
|   |   ├── inlines.test.js
|   |   └── jsi18n-mocks.test.js
|   ├── gis
|   |   └── mapwidget.test.js
|   ├── qunit
|   |   ├── qunit.css
|   |   └── qunit.js
|   └── tests.html
├── scripts
|   ├── manage_translations.py
|   └── rpm-install.sh
├── setup.py
└── tests
    ├── README.rst
    ├── absolute_url_overrides
    |   ├── __init__.py
    |   └── tests.py
    ├── admin_autodiscover
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_changelist
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_date_hierarchy.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_checks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_custom_urls
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_default_site
    |   ├── __init__.py
    |   ├── apps.py
    |   ├── sites.py
    |   └── tests.py
    ├── admin_docs
    |   ├── __init__.py
    |   ├── evilfile.txt
    |   ├── models.py
    |   ├── namespace_urls.py
    |   ├── test_middleware.py
    |   ├── test_utils.py
    |   ├── test_views.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── admin_filters
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_inlines
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_templates.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_registration
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── admin_scripts
    |   ├── __init__.py
    |   ├── another_app_waiting_migration
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   └── models.py
    |   ├── app_raising_messages
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app_raising_warning
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app_waiting_migration
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   └── models.py
    |   ├── app_with_import
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── broken_app
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── complex_app
    |   |   ├── __init__.py
    |   |   ├── admin
    |   |   |   ├── __init__.py
    |   |   |   └── foo.py
    |   |   ├── management
    |   |   |   └── commands
    |   |   └── models
    |   |       ├── __init__.py
    |   |       ├── bar.py
    |   |       └── foo.py
    |   ├── configured_dynamic_settings_manage.py
    |   ├── configured_settings_manage.py
    |   ├── custom_templates
    |   |   ├── app_template
    |   |   |   ├── __init__.py
    |   |   |   └── api.py
    |   |   └── project_template
    |   |       ├── additional_dir
    |   |       ├── project_name
    |   |       └── ticket-18091-non-ascii-template.txt
    |   ├── management
    |   |   └── commands
    |   |       ├── app_command.py
    |   |       ├── base_command.py
    |   |       ├── custom_startproject.py
    |   |       ├── label_command.py
    |   |       └── noargs_command.py
    |   ├── simple_app
    |   |   ├── __init__.py
    |   |   ├── management
    |   |   |   └── commands
    |   |   └── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_utils
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── test_logentry.py
    |   ├── tests.py
    |   └── urls.py
    ├── admin_views
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── custom_has_permission_admin.py
    |   ├── customadmin.py
    |   ├── forms.py
    |   ├── models.py
    |   ├── templates
    |   |   ├── admin
    |   |   |   ├── admin_views
    |   |   |   └── base_site.html
    |   |   └── custom_filter_template.html
    |   ├── test_actions.py
    |   ├── test_adminsite.py
    |   ├── test_autocomplete_view.py
    |   ├── test_forms.py
    |   ├── test_multidb.py
    |   ├── test_templatetags.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── admin_widgets
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_autocomplete_widget.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── widgetadmin.py
    ├── aggregation
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_filter_argument.py
    |   └── tests.py
    ├── aggregation_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── annotations
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── app_loading
    |   ├── __init__.py
    |   ├── eggs
    |   ├── not_installed
    |   |   ├── __init__.py
    |   |   └── models.py
    |   └── tests.py
    ├── apps
    |   ├── __init__.py
    |   ├── apps.py
    |   ├── default_config_app
    |   |   ├── __init__.py
    |   |   └── apps.py
    |   ├── models.py
    |   ├── namespace_package_base
    |   |   └── nsapp
    |   |       └── apps.py
    |   ├── namespace_package_other_base
    |   |   └── nsapp
    |   └── tests.py
    ├── auth_tests
    |   ├── __init__.py
    |   ├── backend_alias.py
    |   ├── client.py
    |   ├── common-passwords-custom.txt
    |   ├── fixtures
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── custom_permissions.py
    |   |   ├── custom_user.py
    |   |   ├── invalid_models.py
    |   |   ├── is_active.py
    |   |   ├── minimal.py
    |   |   ├── no_password.py
    |   |   ├── proxy.py
    |   |   ├── uuid_pk.py
    |   |   ├── with_custom_email_field.py
    |   |   ├── with_foreign_key.py
    |   |   ├── with_integer_username.py
    |   |   └── with_last_login_attr.py
    |   ├── settings.py
    |   ├── templates
    |   |   ├── context_processors
    |   |   |   ├── auth_attrs_access.html
    |   |   |   ├── auth_attrs_messages.html
    |   |   |   ├── auth_attrs_no_access.html
    |   |   |   ├── auth_attrs_perm_in_perms.html
    |   |   |   ├── auth_attrs_perms.html
    |   |   |   ├── auth_attrs_test_access.html
    |   |   |   └── auth_attrs_user.html
    |   |   └── registration
    |   |       ├── html_password_reset_email.html
    |   |       ├── logged_out.html
    |   |       ├── login.html
    |   |       ├── password_change_form.html
    |   |       ├── password_reset_complete.html
    |   |       ├── password_reset_confirm.html
    |   |       ├── password_reset_done.html
    |   |       ├── password_reset_email.html
    |   |       ├── password_reset_form.html
    |   |       └── password_reset_subject.txt
    |   ├── test_admin_multidb.py
    |   ├── test_auth_backends.py
    |   ├── test_basic.py
    |   ├── test_checks.py
    |   ├── test_context_processors.py
    |   ├── test_decorators.py
    |   ├── test_forms.py
    |   ├── test_handlers.py
    |   ├── test_hashers.py
    |   ├── test_management.py
    |   ├── test_middleware.py
    |   ├── test_migrations.py
    |   ├── test_mixins.py
    |   ├── test_models.py
    |   ├── test_remote_user.py
    |   ├── test_remote_user_deprecation.py
    |   ├── test_signals.py
    |   ├── test_templates.py
    |   ├── test_tokens.py
    |   ├── test_validators.py
    |   ├── test_views.py
    |   ├── urls.py
    |   ├── urls_admin.py
    |   └── urls_custom_user_admin.py
    ├── backends
    |   ├── __init__.py
    |   ├── base
    |   |   ├── __init__.py
    |   |   ├── test_base.py
    |   |   ├── test_creation.py
    |   |   ├── test_features.py
    |   |   ├── test_operations.py
    |   |   └── test_schema.py
    |   ├── models.py
    |   ├── mysql
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_features.py
    |   |   ├── test_schema.py
    |   |   └── tests.py
    |   ├── oracle
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_introspection.py
    |   |   ├── test_operations.py
    |   |   └── tests.py
    |   ├── postgresql
    |   |   ├── __init__.py
    |   |   ├── test_creation.py
    |   |   ├── test_introspection.py
    |   |   ├── test_server_side_cursors.py
    |   |   └── tests.py
    |   ├── sqlite
    |   |   ├── __init__.py
    |   |   ├── test_introspection.py
    |   |   └── tests.py
    |   ├── test_ddl_references.py
    |   ├── test_utils.py
    |   └── tests.py
    ├── base
    |   ├── __init__.py
    |   └── models.py
    ├── bash_completion
    |   ├── __init__.py
    |   ├── management
    |   |   └── commands
    |   |       └── test_command.py
    |   └── tests.py
    ├── basic
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── builtin_server
    |   ├── __init__.py
    |   └── tests.py
    ├── bulk_create
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── cache
    |   ├── __init__.py
    |   ├── closeable_cache.py
    |   ├── liberal_backend.py
    |   ├── models.py
    |   └── tests.py
    ├── check_framework
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_caches.py
    |   ├── test_database.py
    |   ├── test_model_checks.py
    |   ├── test_model_field_deprecation.py
    |   ├── test_multi_db.py
    |   ├── test_security.py
    |   ├── test_templates.py
    |   ├── test_translation.py
    |   ├── test_urls.py
    |   ├── tests.py
    |   └── urls
    |       ├── __init__.py
    |       ├── bad_error_handlers.py
    |       ├── bad_error_handlers_invalid_path.py
    |       ├── beginning_with_slash.py
    |       ├── contains_tuple.py
    |       ├── good_error_handlers.py
    |       ├── include_contains_tuple.py
    |       ├── include_with_dollar.py
    |       ├── name_with_colon.py
    |       ├── no_warnings.py
    |       ├── no_warnings_i18n.py
    |       ├── non_unique_namespaces.py
    |       ├── path_compatibility
    |       |   ├── __init__.py
    |       |   ├── beginning_with_caret.py
    |       |   ├── contains_re_named_group.py
    |       |   └── ending_with_dollar.py
    |       ├── unique_namespaces.py
    |       └── warning_in_include.py
    ├── conditional_processing
    |   ├── __init__.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── constraints
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── contenttypes_tests
    |   ├── __init__.py
    |   ├── models.py
    |   ├── operations_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_rename_foo.py
    |   |   └── __init__.py
    |   ├── test_checks.py
    |   ├── test_fields.py
    |   ├── test_management.py
    |   ├── test_models.py
    |   ├── test_operations.py
    |   ├── test_order_with_respect_to.py
    |   ├── test_views.py
    |   └── urls.py
    ├── context_processors
    |   ├── __init__.py
    |   ├── models.py
    |   ├── templates
    |   |   └── context_processors
    |   |       ├── debug.html
    |   |       └── request_attrs.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── csrf_tests
    |   ├── __init__.py
    |   ├── csrf_token_error_handler_urls.py
    |   ├── test_context_processor.py
    |   ├── tests.py
    |   └── views.py
    ├── custom_columns
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_lookups
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_managers
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_methods
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── custom_migration_operations
    |   ├── __init__.py
    |   ├── more_operations.py
    |   └── operations.py
    ├── custom_pk
    |   ├── __init__.py
    |   ├── fields.py
    |   ├── models.py
    |   └── tests.py
    ├── datatypes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── dates
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── datetimes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── db_functions
    |   ├── __init__.py
    |   ├── comparison
    |   |   ├── __init__.py
    |   |   ├── test_cast.py
    |   |   ├── test_coalesce.py
    |   |   ├── test_greatest.py
    |   |   ├── test_least.py
    |   |   └── test_nullif.py
    |   ├── datetime
    |   |   ├── __init__.py
    |   |   ├── test_extract_trunc.py
    |   |   └── test_now.py
    |   ├── math
    |   |   ├── __init__.py
    |   |   ├── test_abs.py
    |   |   ├── test_acos.py
    |   |   ├── test_asin.py
    |   |   ├── test_atan.py
    |   |   ├── test_atan2.py
    |   |   ├── test_ceil.py
    |   |   ├── test_cos.py
    |   |   ├── test_cot.py
    |   |   ├── test_degrees.py
    |   |   ├── test_exp.py
    |   |   ├── test_floor.py
    |   |   ├── test_ln.py
    |   |   ├── test_log.py
    |   |   ├── test_mod.py
    |   |   ├── test_pi.py
    |   |   ├── test_power.py
    |   |   ├── test_radians.py
    |   |   ├── test_round.py
    |   |   ├── test_sign.py
    |   |   ├── test_sin.py
    |   |   ├── test_sqrt.py
    |   |   └── test_tan.py
    |   ├── migrations
    |   |   ├── 0001_setup_extensions.py
    |   |   ├── 0002_create_test_models.py
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   ├── text
    |   |   ├── __init__.py
    |   |   ├── test_chr.py
    |   |   ├── test_concat.py
    |   |   ├── test_left.py
    |   |   ├── test_length.py
    |   |   ├── test_lower.py
    |   |   ├── test_md5.py
    |   |   ├── test_ord.py
    |   |   ├── test_pad.py
    |   |   ├── test_repeat.py
    |   |   ├── test_replace.py
    |   |   ├── test_reverse.py
    |   |   ├── test_right.py
    |   |   ├── test_sha1.py
    |   |   ├── test_sha224.py
    |   |   ├── test_sha256.py
    |   |   ├── test_sha384.py
    |   |   ├── test_sha512.py
    |   |   ├── test_strindex.py
    |   |   ├── test_substr.py
    |   |   ├── test_trim.py
    |   |   └── test_upper.py
    |   └── window
    |       ├── __init__.py
    |       └── test_validation.py
    ├── db_typecasts
    |   ├── __init__.py
    |   └── tests.py
    ├── db_utils
    |   ├── __init__.py
    |   └── tests.py
    ├── dbshell
    |   ├── __init__.py
    |   ├── test_mysql.py
    |   ├── test_oracle.py
    |   └── test_postgresql.py
    ├── decorators
    |   ├── __init__.py
    |   └── tests.py
    ├── defer
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── defer_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── delete
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── delete_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── deprecation
    |   ├── __init__.py
    |   └── tests.py
    ├── dispatch
    |   ├── __init__.py
    |   └── tests.py
    ├── distinct_on_fields
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── empty
    |   ├── __init__.py
    |   ├── models.py
    |   ├── no_models
    |   |   └── __init__.py
    |   └── tests.py
    ├── expressions
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_deprecation.py
    |   ├── test_queryset_values.py
    |   └── tests.py
    ├── expressions_case
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── expressions_window
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── extra_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── field_deconstruction
    |   ├── __init__.py
    |   └── tests.py
    ├── field_defaults
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── field_subclassing
    |   ├── __init__.py
    |   ├── fields.py
    |   └── tests.py
    ├── file_storage
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_generate_filename.py
    |   ├── tests.py
    |   └── urls.py
    ├── file_uploads
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   ├── uploadhandler.py
    |   ├── urls.py
    |   └── views.py
    ├── files
    |   ├── __init__.py
    |   └── tests.py
    ├── filtered_relation
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── fixtures
    |   ├── __init__.py
    |   ├── fixtures
    |   |   ├── fixture2.xml
    |   |   ├── fixture3.xml
    |   |   ├── fixture7.xml
    |   |   └── fixture9.xml
    |   ├── models.py
    |   └── tests.py
    ├── fixtures_model_package
    |   ├── __init__.py
    |   ├── fixtures
    |   |   └── fixture2.xml
    |   ├── models
    |   |   └── __init__.py
    |   └── tests.py
    ├── fixtures_regress
    |   ├── __init__.py
    |   ├── fixtures
    |   |   ├── animal.xml
    |   |   ├── bad_fixture2.xml
    |   |   ├── nk-inheritance2.xml
    |   |   ├── non_natural_2.xml
    |   |   ├── pretty.xml
    |   |   └── sequence_extra_xml.xml
    |   ├── fixtures_1
    |   |   └── inner
    |   ├── fixtures_2
    |   ├── models.py
    |   └── tests.py
    ├── flatpages_tests
    |   ├── __init__.py
    |   ├── settings.py
    |   ├── templates
    |   |   ├── flatpages
    |   |   |   └── default.html
    |   |   └── registration
    |   |       └── login.html
    |   ├── test_csrf.py
    |   ├── test_forms.py
    |   ├── test_middleware.py
    |   ├── test_models.py
    |   ├── test_sitemaps.py
    |   ├── test_templatetags.py
    |   ├── test_views.py
    |   └── urls.py
    ├── force_insert_update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── foreign_object
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── article.py
    |   |   ├── customers.py
    |   |   ├── empty_join.py
    |   |   └── person.py
    |   ├── test_agnostic_order_trimjoin.py
    |   ├── test_empty_join.py
    |   ├── test_forms.py
    |   └── tests.py
    ├── forms_tests
    |   ├── __init__.py
    |   ├── field_tests
    |   |   ├── __init__.py
    |   |   ├── filepathfield_test_dir
    |   |   |   ├── __init__.py
    |   |   |   ├── a.py
    |   |   |   ├── ab.py
    |   |   |   ├── b.py
    |   |   |   ├── c
    |   |   |   ├── h
    |   |   |   └── j
    |   |   ├── test_base.py
    |   |   ├── test_booleanfield.py
    |   |   ├── test_charfield.py
    |   |   ├── test_choicefield.py
    |   |   ├── test_combofield.py
    |   |   ├── test_datefield.py
    |   |   ├── test_datetimefield.py
    |   |   ├── test_decimalfield.py
    |   |   ├── test_durationfield.py
    |   |   ├── test_emailfield.py
    |   |   ├── test_filefield.py
    |   |   ├── test_filepathfield.py
    |   |   ├── test_floatfield.py
    |   |   ├── test_genericipaddressfield.py
    |   |   ├── test_imagefield.py
    |   |   ├── test_integerfield.py
    |   |   ├── test_multiplechoicefield.py
    |   |   ├── test_multivaluefield.py
    |   |   ├── test_nullbooleanfield.py
    |   |   ├── test_regexfield.py
    |   |   ├── test_slugfield.py
    |   |   ├── test_splitdatetimefield.py
    |   |   ├── test_timefield.py
    |   |   ├── test_typedchoicefield.py
    |   |   ├── test_typedmultiplechoicefield.py
    |   |   ├── test_urlfield.py
    |   |   └── test_uuidfield.py
    |   ├── jinja2
    |   |   └── forms_tests
    |   |       └── custom_widget.html
    |   ├── models.py
    |   ├── templates
    |   |   └── forms_tests
    |   |       ├── article_form.html
    |   |       └── custom_widget.html
    |   ├── tests
    |   |   ├── __init__.py
    |   |   ├── filepath_test_files
    |   |   |   ├── directory
    |   |   |   └── real-text-file.txt
    |   |   ├── test_error_messages.py
    |   |   ├── test_forms.py
    |   |   ├── test_formsets.py
    |   |   ├── test_i18n.py
    |   |   ├── test_input_formats.py
    |   |   ├── test_media.py
    |   |   ├── test_renderers.py
    |   |   ├── test_utils.py
    |   |   ├── test_validators.py
    |   |   ├── test_widgets.py
    |   |   └── tests.py
    |   ├── urls.py
    |   ├── views.py
    |   └── widget_tests
    |       ├── __init__.py
    |       ├── base.py
    |       ├── test_checkboxinput.py
    |       ├── test_checkboxselectmultiple.py
    |       ├── test_clearablefileinput.py
    |       ├── test_dateinput.py
    |       ├── test_datetimeinput.py
    |       ├── test_fileinput.py
    |       ├── test_hiddeninput.py
    |       ├── test_input.py
    |       ├── test_multiplehiddeninput.py
    |       ├── test_multiwidget.py
    |       ├── test_nullbooleanselect.py
    |       ├── test_numberinput.py
    |       ├── test_passwordinput.py
    |       ├── test_radioselect.py
    |       ├── test_select.py
    |       ├── test_selectdatewidget.py
    |       ├── test_selectmultiple.py
    |       ├── test_splitdatetimewidget.py
    |       ├── test_splithiddendatetimewidget.py
    |       ├── test_textarea.py
    |       ├── test_textinput.py
    |       ├── test_timeinput.py
    |       └── test_widget.py
    ├── from_db_value
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── generic_inline_admin
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── generic_relations
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_forms.py
    |   └── tests.py
    ├── generic_relations_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── generic_views
    |   ├── __init__.py
    |   ├── forms.py
    |   ├── jinja2
    |   |   └── generic_views
    |   |       └── using.html
    |   ├── models.py
    |   ├── templates
    |   |   ├── generic_views
    |   |   |   ├── about.html
    |   |   |   ├── apple_detail.html
    |   |   |   ├── artist_detail.html
    |   |   |   ├── artist_form.html
    |   |   |   ├── author_confirm_delete.html
    |   |   |   ├── author_detail.html
    |   |   |   ├── author_form.html
    |   |   |   ├── author_list.html
    |   |   |   ├── author_objects.html
    |   |   |   ├── author_view.html
    |   |   |   ├── book_archive.html
    |   |   |   ├── book_archive_day.html
    |   |   |   ├── book_archive_month.html
    |   |   |   ├── book_archive_week.html
    |   |   |   ├── book_archive_year.html
    |   |   |   ├── book_detail.html
    |   |   |   ├── book_list.html
    |   |   |   ├── confirm_delete.html
    |   |   |   ├── detail.html
    |   |   |   ├── form.html
    |   |   |   ├── list.html
    |   |   |   ├── page_template.html
    |   |   |   ├── robots.txt
    |   |   |   └── using.html
    |   |   └── registration
    |   |       └── login.html
    |   ├── test_base.py
    |   ├── test_dates.py
    |   ├── test_detail.py
    |   ├── test_edit.py
    |   ├── test_list.py
    |   ├── urls.py
    |   └── views.py
    ├── get_earliest_or_latest
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── get_object_or_404
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── get_or_create
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── gis_tests
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── data
    |   |   ├── __init__.py
    |   |   ├── ch-city
    |   |   ├── cities
    |   |   ├── counties
    |   |   ├── gas_lines
    |   |   ├── has_nulls
    |   |   ├── interstates
    |   |   ├── invalid
    |   |   ├── rasters
    |   |   |   ├── __init__.py
    |   |   |   ├── raster.numpy.txt
    |   |   |   └── textrasters.py
    |   |   ├── test_point
    |   |   ├── test_poly
    |   |   └── test_vrt
    |   ├── distapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── gdal_tests
    |   |   ├── __init__.py
    |   |   ├── test_driver.py
    |   |   ├── test_ds.py
    |   |   ├── test_envelope.py
    |   |   ├── test_geom.py
    |   |   ├── test_raster.py
    |   |   └── test_srs.py
    |   ├── geo3d
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   ├── tests.py
    |   |   └── views.py
    |   ├── geoadmin
    |   |   ├── __init__.py
    |   |   ├── admin.py
    |   |   ├── models.py
    |   |   ├── tests.py
    |   |   └── urls.py
    |   ├── geoapp
    |   |   ├── __init__.py
    |   |   ├── feeds.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   ├── sitemaps.py
    |   |   ├── test_expressions.py
    |   |   ├── test_feeds.py
    |   |   ├── test_functions.py
    |   |   ├── test_regress.py
    |   |   ├── test_serializers.py
    |   |   ├── test_sitemaps.py
    |   |   ├── tests.py
    |   |   └── urls.py
    |   ├── geogapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── geos_tests
    |   |   ├── __init__.py
    |   |   ├── test_coordseq.py
    |   |   ├── test_geos.py
    |   |   ├── test_geos_mutation.py
    |   |   ├── test_io.py
    |   |   └── test_mutable_list.py
    |   ├── gis_migrations
    |   |   ├── __init__.py
    |   |   ├── migrations
    |   |   |   ├── 0001_initial.py
    |   |   |   └── __init__.py
    |   |   ├── test_commands.py
    |   |   └── test_operations.py
    |   ├── inspectapp
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── layermap
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── maps
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── rasterapp
    |   |   ├── __init__.py
    |   |   ├── models.py
    |   |   └── test_rasterfield.py
    |   ├── relatedapp
    |   |   ├── __init__.py
    |   |   ├── fixtures
    |   |   ├── models.py
    |   |   └── tests.py
    |   ├── test_data.py
    |   ├── test_fields.py
    |   ├── test_geoforms.py
    |   ├── test_geoip2.py
    |   ├── test_gis_tests_utils.py
    |   ├── test_measure.py
    |   ├── test_ptr.py
    |   ├── test_spatialrefsys.py
    |   ├── tests.py
    |   └── utils.py
    ├── handlers
    |   ├── __init__.py
    |   ├── templates
    |   |   └── test_handler.html
    |   ├── test_exception.py
    |   ├── tests.py
    |   ├── tests_custom_error_handlers.py
    |   ├── urls.py
    |   └── views.py
    ├── httpwrappers
    |   ├── __init__.py
    |   ├── abc.txt
    |   └── tests.py
    ├── humanize_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── i18n
    |   ├── __init__.py
    |   ├── commands
    |   |   ├── __init__.py
    |   |   ├── app_with_locale
    |   |   |   └── locale
    |   |   ├── ignore_dir
    |   |   |   └── ignored.html
    |   |   ├── javascript.js
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   ├── es_AR
    |   |   |   ├── fr
    |   |   |   ├── hr
    |   |   |   ├── ja
    |   |   |   ├── ko
    |   |   |   ├── pt_BR
    |   |   |   ├── ru
    |   |   |   └── xxx
    |   |   ├── media_root
    |   |   |   └── media_ignored.html
    |   |   ├── someapp
    |   |   |   └── static
    |   |   ├── static
    |   |   |   ├── javascript_ignored.js
    |   |   |   └── static_ignored.html
    |   |   └── templates
    |   |       ├── empty.html
    |   |       ├── subdir
    |   |       ├── test.html
    |   |       └── xxx_ignored.html
    |   ├── contenttypes
    |   |   ├── __init__.py
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   └── fr
    |   |   └── tests.py
    |   ├── exclude
    |   |   ├── __init__.py
    |   |   └── canned_locale
    |   |       ├── en
    |   |       ├── fr
    |   |       └── it
    |   ├── forms.py
    |   ├── models.py
    |   ├── other
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       ├── de
    |   |       └── fr
    |   ├── other2
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       └── de
    |   ├── patterns
    |   |   ├── __init__.py
    |   |   ├── locale
    |   |   |   ├── en
    |   |   |   ├── nl
    |   |   |   └── pt_BR
    |   |   ├── templates
    |   |   |   ├── 404.html
    |   |   |   └── dummy.html
    |   |   ├── tests.py
    |   |   └── urls
    |   |       ├── __init__.py
    |   |       ├── default.py
    |   |       ├── disabled.py
    |   |       ├── included.py
    |   |       ├── namespace.py
    |   |       ├── path_unused.py
    |   |       ├── wrong.py
    |   |       └── wrong_namespace.py
    |   ├── project_dir
    |   |   ├── __init__.py
    |   |   ├── app_no_locale
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── app_with_locale
    |   |   |   ├── __init__.py
    |   |   |   ├── locale
    |   |   |   └── models.py
    |   |   └── project_locale
    |   ├── resolution
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── de
    |   ├── sampleproject
    |   |   ├── locale
    |   |   |   └── fr
    |   |   ├── manage.py
    |   |   ├── sampleproject
    |   |   |   ├── __init__.py
    |   |   |   └── settings.py
    |   |   ├── templates
    |   |   |   └── percents.html
    |   |   └── update_catalogs.py
    |   ├── territorial_fallback
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── de
    |   |       └── de_DE
    |   ├── test_compilation.py
    |   ├── test_extraction.py
    |   ├── test_management.py
    |   ├── test_percents.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── urls_default_unprefixed.py
    |   └── utils.py
    ├── import_error_package
    |   └── __init__.py
    ├── indexes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── inline_formsets
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── inspectdb
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── introspection
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── invalid_models_tests
    |   ├── __init__.py
    |   ├── test_backend_specific.py
    |   ├── test_custom_fields.py
    |   ├── test_deprecated_fields.py
    |   ├── test_models.py
    |   ├── test_ordinary_fields.py
    |   └── test_relative_fields.py
    ├── known_related_objects
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── logging_tests
    |   ├── __init__.py
    |   ├── logconfig.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── urls_i18n.py
    |   └── views.py
    ├── lookup
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_decimalfield.py
    |   ├── test_lookups.py
    |   ├── test_timefield.py
    |   └── tests.py
    ├── m2m_and_m2o
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_intermediary
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_multiple
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_recursive
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_signals
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_through
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── m2m_through_regress
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── test_multitable.py
    |   └── tests.py
    ├── m2o_recursive
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── mail
    |   ├── __init__.py
    |   ├── attachments
    |   |   ├── file.txt
    |   |   └── file_png.txt
    |   ├── custombackend.py
    |   ├── test_sendtestemail.py
    |   └── tests.py
    ├── managers_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_many
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_one
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── many_to_one_null
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── max_lengths
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── messages_tests
    |   ├── __init__.py
    |   ├── base.py
    |   ├── test_api.py
    |   ├── test_cookie.py
    |   ├── test_fallback.py
    |   ├── test_middleware.py
    |   ├── test_mixins.py
    |   ├── test_session.py
    |   └── urls.py
    ├── middleware
    |   ├── __init__.py
    |   ├── cond_get_urls.py
    |   ├── extra_urls.py
    |   ├── test_security.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── middleware_exceptions
    |   ├── __init__.py
    |   ├── middleware.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── migrate_signals
    |   ├── __init__.py
    |   ├── custom_migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── migration_test_data_persistence
    |   ├── __init__.py
    |   ├── migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_add_book.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── migrations
    |   ├── __init__.py
    |   ├── deprecated_field_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_remove_ipaddressfield_ip.py
    |   |   └── __init__.py
    |   ├── faulty_migrations
    |   |   ├── __init__.py
    |   |   ├── file.py
    |   |   └── namespace
    |   |       └── foo
    |   ├── migrations_test_apps
    |   |   ├── __init__.py
    |   |   ├── alter_fk
    |   |   |   ├── __init__.py
    |   |   |   ├── author_app
    |   |   |   └── book_app
    |   |   ├── conflicting_app_with_dependencies
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── lookuperror_a
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── lookuperror_b
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── lookuperror_c
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── migrated_app
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── migrated_unapplied_app
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── mutate_state_a
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── mutate_state_b
    |   |   |   ├── __init__.py
    |   |   |   └── migrations
    |   |   ├── normal
    |   |   |   └── __init__.py
    |   |   ├── unmigrated_app
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unmigrated_app_simple
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unmigrated_app_syncdb
    |   |   |   ├── __init__.py
    |   |   |   └── models.py
    |   |   ├── unspecified_app_with_conflict
    |   |   |   ├── __init__.py
    |   |   |   ├── migrations
    |   |   |   └── models.py
    |   |   ├── with_package_model
    |   |   |   ├── __init__.py
    |   |   |   └── models
    |   |   └── without_init_file
    |   |       ├── __init__.py
    |   |       └── migrations
    |   ├── models.py
    |   ├── related_models_app
    |   |   └── __init__.py
    |   ├── routers.py
    |   ├── test_add_many_to_many_field_initial
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_initial.py
    |   |   └── __init__.py
    |   ├── test_auto_now_add
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_autodetector.py
    |   ├── test_base.py
    |   ├── test_commands.py
    |   ├── test_deprecated_fields.py
    |   ├── test_exceptions.py
    |   ├── test_executor.py
    |   ├── test_graph.py
    |   ├── test_loader.py
    |   ├── test_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_atomic_operation
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_backwards_deps_1
    |   |   ├── 0001_initial.py
    |   |   └── 0002_second.py
    |   ├── test_migrations_bad_pyc
    |   |   └── __init__.py
    |   ├── test_migrations_clashing_prefix
    |   |   ├── __init__.py
    |   |   ├── a.py
    |   |   └── ab.py
    |   ├── test_migrations_conflict
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_conflicting_second.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_custom_user
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_empty
    |   |   └── __init__.py
    |   ├── test_migrations_fake_split_initial
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_first
    |   |   ├── __init__.py
    |   |   ├── second.py
    |   |   └── thefirst.py
    |   ├── test_migrations_initial_false
    |   |   ├── 0001_not_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_ancestor
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_conflicting_second.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_changes
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_default
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_no_init
    |   ├── test_migrations_non_atomic
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_order
    |   |   ├── 0001.py
    |   |   └── __init__.py
    |   ├── test_migrations_plan
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   ├── 0004_fourth.py
    |   |   └── __init__.py
    |   ├── test_migrations_private
    |   |   ├── .util.py
    |   |   ├── 0001_initial.py
    |   |   ├── __init__.py
    |   |   ├── _util.py
    |   |   └── ~util.py
    |   ├── test_migrations_run_before
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed
    |   |   ├── 0001_initial.py
    |   |   ├── 0001_squashed_0002.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_complex
    |   |   ├── 1_auto.py
    |   |   ├── 2_auto.py
    |   |   ├── 3_auto.py
    |   |   ├── 3_squashed_5.py
    |   |   ├── 4_auto.py
    |   |   ├── 5_auto.py
    |   |   ├── 6_auto.py
    |   |   ├── 7_auto.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_complex_multi_apps
    |   |   ├── __init__.py
    |   |   ├── app1
    |   |   |   ├── 1_auto.py
    |   |   |   ├── 2_auto.py
    |   |   |   ├── 2_squashed_3.py
    |   |   |   ├── 3_auto.py
    |   |   |   ├── 4_auto.py
    |   |   |   └── __init__.py
    |   |   └── app2
    |   |       ├── 1_auto.py
    |   |       ├── 1_squashed_2.py
    |   |       ├── 2_auto.py
    |   |       └── __init__.py
    |   ├── test_migrations_squashed_erroneous
    |   |   ├── 1_auto.py
    |   |   ├── 2_auto.py
    |   |   ├── 3_squashed_5.py
    |   |   ├── 6_auto.py
    |   |   ├── 7_auto.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_extra
    |   |   ├── 0001_initial.py
    |   |   ├── 0001_squashed_0002.py
    |   |   ├── 0002_second.py
    |   |   ├── 0003_third.py
    |   |   └── __init__.py
    |   ├── test_migrations_squashed_ref_squashed
    |   |   ├── __init__.py
    |   |   ├── app1
    |   |   |   ├── 1_auto.py
    |   |   |   ├── 2_auto.py
    |   |   |   ├── 2_squashed_3.py
    |   |   |   ├── 3_auto.py
    |   |   |   ├── 4_auto.py
    |   |   |   └── __init__.py
    |   |   └── app2
    |   |       ├── 1_auto.py
    |   |       ├── 1_squashed_2.py
    |   |       ├── 2_auto.py
    |   |       └── __init__.py
    |   ├── test_migrations_unmigdep
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_multidb.py
    |   ├── test_operations.py
    |   ├── test_optimizer.py
    |   ├── test_questioner.py
    |   ├── test_state.py
    |   └── test_writer.py
    ├── migrations2
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_migrations_2
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── test_migrations_2_first
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_second.py
    |   |   └── __init__.py
    |   └── test_migrations_2_no_deps
    |       ├── 0001_initial.py
    |       └── __init__.py
    ├── model_fields
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_binaryfield.py
    |   ├── test_booleanfield.py
    |   ├── test_charfield.py
    |   ├── test_datetimefield.py
    |   ├── test_decimalfield.py
    |   ├── test_durationfield.py
    |   ├── test_field_flags.py
    |   ├── test_filefield.py
    |   ├── test_filepathfield.py
    |   ├── test_floatfield.py
    |   ├── test_foreignkey.py
    |   ├── test_genericipaddressfield.py
    |   ├── test_imagefield.py
    |   ├── test_integerfield.py
    |   ├── test_manytomanyfield.py
    |   ├── test_promises.py
    |   ├── test_slugfield.py
    |   ├── test_textfield.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_forms
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_modelchoicefield.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_formsets
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── model_formsets_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_indexes
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_inheritance
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_abstract_inheritance.py
    |   └── tests.py
    ├── model_inheritance_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── model_meta
    |   ├── __init__.py
    |   ├── models.py
    |   ├── results.py
    |   └── tests.py
    ├── model_options
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── default_related_name.py
    |   |   └── tablespaces.py
    |   ├── test_default_related_name.py
    |   └── test_tablespaces.py
    ├── model_package
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── article.py
    |   |   └── publication.py
    |   └── tests.py
    ├── model_regress
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_pickle.py
    |   ├── test_state.py
    |   └── tests.py
    ├── modeladmin
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_actions.py
    |   ├── test_checks.py
    |   └── tests.py
    ├── multiple_database
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── routers.py
    |   └── tests.py
    ├── mutually_referential
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── nested_foreign_keys
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── no_models
    |   ├── __init__.py
    |   └── tests.py
    ├── null_fk
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── null_fk_ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── null_queries
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── one_to_one
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── or_lookups
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── order_with_respect_to
    |   ├── __init__.py
    |   ├── base_tests.py
    |   ├── models.py
    |   └── tests.py
    ├── ordering
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── pagination
    |   ├── __init__.py
    |   ├── custom.py
    |   ├── models.py
    |   └── tests.py
    ├── postgres_tests
    |   ├── __init__.py
    |   ├── array_default_migrations
    |   |   ├── 0001_initial.py
    |   |   ├── 0002_integerarraymodel_field_2.py
    |   |   └── __init__.py
    |   ├── array_index_migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── fields.py
    |   ├── integration_settings.py
    |   ├── migrations
    |   |   ├── 0001_setup_extensions.py
    |   |   ├── 0002_create_test_models.py
    |   |   └── __init__.py
    |   ├── models.py
    |   ├── test_aggregates.py
    |   ├── test_apps.py
    |   ├── test_array.py
    |   ├── test_bulk_update.py
    |   ├── test_citext.py
    |   ├── test_constraints.py
    |   ├── test_functions.py
    |   ├── test_hstore.py
    |   ├── test_indexes.py
    |   ├── test_integration.py
    |   ├── test_introspection.py
    |   ├── test_json.py
    |   ├── test_ranges.py
    |   ├── test_search.py
    |   ├── test_signals.py
    |   ├── test_trigram.py
    |   └── test_unaccent.py
    ├── prefetch_related
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_prefetch_related_objects.py
    |   ├── test_uuid.py
    |   └── tests.py
    ├── project_template
    |   ├── __init__.py
    |   ├── test_settings.py
    |   ├── urls.py
    |   └── views.py
    ├── properties
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── proxy_model_inheritance
    |   ├── __init__.py
    |   ├── app1
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── app2
    |   |   ├── __init__.py
    |   |   └── models.py
    |   ├── models.py
    |   └── tests.py
    ├── proxy_models
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── queries
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_bulk_update.py
    |   ├── test_explain.py
    |   ├── test_iterator.py
    |   ├── test_q.py
    |   ├── test_qs_combinators.py
    |   ├── test_query.py
    |   └── tests.py
    ├── queryset_pickle
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── raw_query
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── redirects_tests
    |   ├── __init__.py
    |   ├── tests.py
    |   └── urls.py
    ├── requests
    |   ├── __init__.py
    |   ├── test_data_upload_settings.py
    |   └── tests.py
    ├── requirements
    |   ├── mysql.txt
    |   ├── oracle.txt
    |   ├── postgres.txt
    |   └── py3.txt
    ├── reserved_names
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── resolve_url
    |   ├── __init__.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── responses
    |   ├── __init__.py
    |   ├── test_cookie.py
    |   ├── test_fileresponse.py
    |   └── tests.py
    ├── reverse_lookup
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── runtests.py
    ├── save_delete_hooks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── schema
    |   ├── __init__.py
    |   ├── fields.py
    |   ├── models.py
    |   ├── test_logging.py
    |   └── tests.py
    ├── select_for_update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related_onetoone
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── select_related_regress
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── serializers
    |   ├── __init__.py
    |   ├── models
    |   |   ├── __init__.py
    |   |   ├── base.py
    |   |   ├── data.py
    |   |   ├── multi_table.py
    |   |   └── natural.py
    |   ├── test_data.py
    |   ├── test_deserializedobject.py
    |   ├── test_json.py
    |   ├── test_natural.py
    |   ├── test_xml.py
    |   ├── test_yaml.py
    |   └── tests.py
    ├── servers
    |   ├── __init__.py
    |   ├── another_app
    |   |   ├── __init__.py
    |   |   └── static
    |   |       └── another_app
    |   ├── fixtures
    |   ├── media
    |   |   └── example_media_file.txt
    |   ├── models.py
    |   ├── static
    |   |   └── example_static_file.txt
    |   ├── test_basehttp.py
    |   ├── test_liveserverthread.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── sessions_tests
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── settings_tests
    |   ├── __init__.py
    |   ├── test_file_charset.py
    |   └── tests.py
    ├── shell
    |   ├── __init__.py
    |   └── tests.py
    ├── shortcuts
    |   ├── __init__.py
    |   ├── jinja2
    |   |   └── shortcuts
    |   |       └── using.html
    |   ├── templates
    |   |   └── shortcuts
    |   |       ├── render_test.html
    |   |       └── using.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── signals
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── signed_cookies_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── signing
    |   ├── __init__.py
    |   └── tests.py
    ├── sitemaps_tests
    |   ├── __init__.py
    |   ├── base.py
    |   ├── models.py
    |   ├── templates
    |   |   ├── custom_sitemap.xml
    |   |   └── custom_sitemap_index.xml
    |   ├── test_generic.py
    |   ├── test_http.py
    |   ├── test_https.py
    |   ├── test_management.py
    |   ├── test_utils.py
    |   └── urls
    |       ├── __init__.py
    |       ├── empty.py
    |       ├── http.py
    |       ├── https.py
    |       └── index_only.py
    ├── sites_framework
    |   ├── __init__.py
    |   ├── migrations
    |   |   ├── 0001_initial.py
    |   |   └── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── sites_tests
    |   ├── __init__.py
    |   └── tests.py
    ├── staticfiles_tests
    |   ├── __init__.py
    |   ├── apps
    |   |   ├── __init__.py
    |   |   ├── no_label
    |   |   |   ├── __init__.py
    |   |   |   └── static
    |   |   ├── staticfiles_config.py
    |   |   └── test
    |   |       ├── __init__.py
    |   |       ├── otherdir
    |   |       └── static
    |   ├── cases.py
    |   ├── project
    |   |   ├── documents
    |   |   |   ├── absolute_root.css
    |   |   |   ├── cached
    |   |   |   ├── styles_root.css
    |   |   |   ├── subdir
    |   |   |   ├── test
    |   |   |   └── test.txt
    |   |   ├── faulty
    |   |   |   └── faulty.css
    |   |   ├── loop
    |   |   |   ├── bar.css
    |   |   |   └── foo.css
    |   |   ├── prefixed
    |   |   |   └── test.txt
    |   |   └── site_media
    |   |       ├── media
    |   |       └── static
    |   ├── settings.py
    |   ├── storage.py
    |   ├── test_checks.py
    |   ├── test_finders.py
    |   ├── test_forms.py
    |   ├── test_liveserver.py
    |   ├── test_management.py
    |   ├── test_storage.py
    |   ├── test_templatetags.py
    |   ├── test_utils.py
    |   ├── test_views.py
    |   └── urls
    |       ├── __init__.py
    |       ├── default.py
    |       └── helper.py
    ├── str
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── string_lookup
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── swappable_models
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── syndication_tests
    |   ├── __init__.py
    |   ├── feeds.py
    |   ├── models.py
    |   ├── templates
    |   |   └── syndication
    |   |       ├── description.html
    |   |       ├── description_context.html
    |   |       ├── title.html
    |   |       └── title_context.html
    |   ├── tests.py
    |   └── urls.py
    ├── template_backends
    |   ├── __init__.py
    |   ├── apps
    |   |   ├── __init__.py
    |   |   ├── good
    |   |   |   ├── __init__.py
    |   |   |   └── templatetags
    |   |   └── importerror
    |   |       ├── __init__.py
    |   |       └── templatetags
    |   ├── forbidden
    |   |   └── template_backends
    |   |       └── hello.html
    |   ├── jinja2
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       ├── django_escaping.html
    |   |       ├── hello.html
    |   |       ├── syntax_error.html
    |   |       └── syntax_error2.html
    |   ├── template_strings
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       └── hello.html
    |   ├── templates
    |   |   └── template_backends
    |   |       ├── csrf.html
    |   |       ├── django_escaping.html
    |   |       ├── hello.html
    |   |       └── syntax_error.html
    |   ├── test_django.py
    |   ├── test_dummy.py
    |   ├── test_jinja2.py
    |   └── test_utils.py
    ├── template_loader
    |   ├── __init__.py
    |   ├── template_strings
    |   |   └── template_loader
    |   |       └── hello.html
    |   ├── templates
    |   |   └── template_loader
    |   |       ├── goodbye.html
    |   |       ├── hello.html
    |   |       └── request.html
    |   └── tests.py
    ├── template_tests
    |   ├── __init__.py
    |   ├── alternate_urls.py
    |   ├── annotated_tag_function.py
    |   ├── broken_tag.py
    |   ├── eggs
    |   ├── filter_tests
    |   |   ├── __init__.py
    |   |   ├── test_add.py
    |   |   ├── test_addslashes.py
    |   |   ├── test_autoescape.py
    |   |   ├── test_capfirst.py
    |   |   ├── test_center.py
    |   |   ├── test_chaining.py
    |   |   ├── test_cut.py
    |   |   ├── test_date.py
    |   |   ├── test_default.py
    |   |   ├── test_default_if_none.py
    |   |   ├── test_dictsort.py
    |   |   ├── test_dictsortreversed.py
    |   |   ├── test_divisibleby.py
    |   |   ├── test_escape.py
    |   |   ├── test_escapejs.py
    |   |   ├── test_filesizeformat.py
    |   |   ├── test_first.py
    |   |   ├── test_floatformat.py
    |   |   ├── test_force_escape.py
    |   |   ├── test_get_digit.py
    |   |   ├── test_iriencode.py
    |   |   ├── test_join.py
    |   |   ├── test_json_script.py
    |   |   ├── test_last.py
    |   |   ├── test_length.py
    |   |   ├── test_length_is.py
    |   |   ├── test_linebreaks.py
    |   |   ├── test_linebreaksbr.py
    |   |   ├── test_linenumbers.py
    |   |   ├── test_ljust.py
    |   |   ├── test_lower.py
    |   |   ├── test_make_list.py
    |   |   ├── test_phone2numeric.py
    |   |   ├── test_pluralize.py
    |   |   ├── test_random.py
    |   |   ├── test_rjust.py
    |   |   ├── test_safe.py
    |   |   ├── test_safeseq.py
    |   |   ├── test_slice.py
    |   |   ├── test_slugify.py
    |   |   ├── test_stringformat.py
    |   |   ├── test_striptags.py
    |   |   ├── test_time.py
    |   |   ├── test_timesince.py
    |   |   ├── test_timeuntil.py
    |   |   ├── test_title.py
    |   |   ├── test_truncatechars.py
    |   |   ├── test_truncatechars_html.py
    |   |   ├── test_truncatewords.py
    |   |   ├── test_truncatewords_html.py
    |   |   ├── test_unordered_list.py
    |   |   ├── test_upper.py
    |   |   ├── test_urlencode.py
    |   |   ├── test_urlize.py
    |   |   ├── test_urlizetrunc.py
    |   |   ├── test_wordcount.py
    |   |   ├── test_wordwrap.py
    |   |   ├── test_yesno.py
    |   |   └── timezone_utils.py
    |   ├── jinja2
    |   |   └── template_tests
    |   |       └── using.html
    |   ├── other_templates
    |   |   ├── priority
    |   |   |   └── foo.html
    |   |   └── test_dirs.html
    |   ├── recursive_templates
    |   |   ├── fs
    |   |   |   ├── extend-missing.html
    |   |   |   ├── one.html
    |   |   |   ├── other-recursive.html
    |   |   |   ├── recursive.html
    |   |   |   ├── self.html
    |   |   |   ├── three.html
    |   |   |   └── two.html
    |   |   ├── fs2
    |   |   |   └── recursive.html
    |   |   └── fs3
    |   |       └── recursive.html
    |   ├── relative_templates
    |   |   ├── dir1
    |   |   |   ├── dir2
    |   |   |   ├── looped.html
    |   |   |   ├── one.html
    |   |   |   ├── one1.html
    |   |   |   ├── one2.html
    |   |   |   ├── one3.html
    |   |   |   ├── three.html
    |   |   |   └── two.html
    |   |   ├── error_extends.html
    |   |   ├── error_include.html
    |   |   ├── one.html
    |   |   ├── three.html
    |   |   └── two.html
    |   ├── syntax_tests
    |   |   ├── __init__.py
    |   |   ├── i18n
    |   |   |   ├── __init__.py
    |   |   |   ├── base.py
    |   |   |   ├── test_blocktrans.py
    |   |   |   ├── test_filters.py
    |   |   |   ├── test_get_available_languages.py
    |   |   |   ├── test_get_current_language.py
    |   |   |   ├── test_get_current_language_bidi.py
    |   |   |   ├── test_get_language_info.py
    |   |   |   ├── test_get_language_info_list.py
    |   |   |   ├── test_language.py
    |   |   |   ├── test_trans.py
    |   |   |   └── test_underscore_syntax.py
    |   |   ├── test_autoescape.py
    |   |   ├── test_basic.py
    |   |   ├── test_builtins.py
    |   |   ├── test_cache.py
    |   |   ├── test_comment.py
    |   |   ├── test_cycle.py
    |   |   ├── test_exceptions.py
    |   |   ├── test_extends.py
    |   |   ├── test_filter_syntax.py
    |   |   ├── test_filter_tag.py
    |   |   ├── test_firstof.py
    |   |   ├── test_for.py
    |   |   ├── test_if.py
    |   |   ├── test_if_changed.py
    |   |   ├── test_if_equal.py
    |   |   ├── test_include.py
    |   |   ├── test_invalid_string.py
    |   |   ├── test_list_index.py
    |   |   ├── test_load.py
    |   |   ├── test_lorem.py
    |   |   ├── test_multiline.py
    |   |   ├── test_named_endblock.py
    |   |   ├── test_now.py
    |   |   ├── test_numpy.py
    |   |   ├── test_regroup.py
    |   |   ├── test_resetcycle.py
    |   |   ├── test_setup.py
    |   |   ├── test_simple_tag.py
    |   |   ├── test_spaceless.py
    |   |   ├── test_static.py
    |   |   ├── test_template_tag.py
    |   |   ├── test_url.py
    |   |   ├── test_verbatim.py
    |   |   ├── test_width_ratio.py
    |   |   └── test_with.py
    |   ├── templates
    |   |   ├── 27584_child.html
    |   |   ├── 27584_parent.html
    |   |   ├── 27956_child.html
    |   |   ├── 27956_parent.html
    |   |   ├── broken_base.html
    |   |   ├── first
    |   |   |   └── test.html
    |   |   ├── include_tpl.html
    |   |   ├── included_base.html
    |   |   ├── included_content.html
    |   |   ├── inclusion.html
    |   |   ├── inclusion_base.html
    |   |   ├── inclusion_extends1.html
    |   |   ├── inclusion_extends2.html
    |   |   ├── index.html
    |   |   ├── priority
    |   |   |   └── foo.html
    |   |   ├── recursive_include.html
    |   |   ├── response.html
    |   |   ├── second
    |   |   |   └── test.html
    |   |   ├── ssi include with spaces.html
    |   |   ├── ssi_include.html
    |   |   ├── template_tests
    |   |   |   └── using.html
    |   |   ├── test_context.html
    |   |   ├── test_context_stack.html
    |   |   ├── test_extends_error.html
    |   |   ├── test_incl_tag_use_l10n.html
    |   |   └── test_include_error.html
    |   ├── templatetags
    |   |   ├── __init__.py
    |   |   ├── bad_tag.py
    |   |   ├── custom.py
    |   |   ├── inclusion.py
    |   |   ├── subpackage
    |   |   |   ├── __init__.py
    |   |   |   └── echo.py
    |   |   ├── tag_27584.py
    |   |   └── testtags.py
    |   ├── test_base.py
    |   ├── test_callables.py
    |   ├── test_context.py
    |   ├── test_custom.py
    |   ├── test_engine.py
    |   ├── test_extends.py
    |   ├── test_extends_relative.py
    |   ├── test_library.py
    |   ├── test_loaders.py
    |   ├── test_logging.py
    |   ├── test_nodelist.py
    |   ├── test_origin.py
    |   ├── test_parser.py
    |   ├── test_response.py
    |   ├── test_smartif.py
    |   ├── tests.py
    |   ├── urls.py
    |   ├── utils.py
    |   └── views.py
    ├── templates
    |   ├── base.html
    |   ├── comments
    |   |   └── comment_notification_email.txt
    |   ├── custom_admin
    |   |   ├── add_form.html
    |   |   ├── app_index.html
    |   |   ├── change_form.html
    |   |   ├── change_list.html
    |   |   ├── delete_confirmation.html
    |   |   ├── delete_selected_confirmation.html
    |   |   ├── index.html
    |   |   ├── login.html
    |   |   ├── logout.html
    |   |   ├── object_history.html
    |   |   ├── password_change_done.html
    |   |   ├── password_change_form.html
    |   |   └── popup_response.html
    |   ├── extended.html
    |   ├── form_view.html
    |   ├── login.html
    |   └── views
    |       ├── article_archive_day.html
    |       ├── article_archive_month.html
    |       ├── article_confirm_delete.html
    |       ├── article_detail.html
    |       ├── article_form.html
    |       ├── article_list.html
    |       ├── datearticle_archive_month.html
    |       ├── urlarticle_detail.html
    |       └── urlarticle_form.html
    ├── test_client
    |   ├── __init__.py
    |   ├── auth_backends.py
    |   ├── test_conditional_content_removal.py
    |   ├── test_fakepayload.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── test_client_regress
    |   ├── __init__.py
    |   ├── auth_backends.py
    |   ├── bad_templates
    |   |   └── 404.html
    |   ├── context_processors.py
    |   ├── models.py
    |   ├── session.py
    |   ├── templates
    |   |   ├── request_context.html
    |   |   └── unicode.html
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── test_exceptions
    |   ├── __init__.py
    |   └── test_validation_error.py
    ├── test_runner
    |   ├── __init__.py
    |   ├── models.py
    |   ├── runner.py
    |   ├── test_debug_sql.py
    |   ├── test_discover_runner.py
    |   ├── test_parallel.py
    |   └── tests.py
    ├── test_runner_apps
    |   ├── __init__.py
    |   ├── databases
    |   |   ├── __init__.py
    |   |   └── tests.py
    |   ├── sample
    |   |   ├── __init__.py
    |   |   ├── doctests.py
    |   |   ├── empty.py
    |   |   ├── pattern_tests.py
    |   |   ├── tests
    |   |   |   ├── __init__.py
    |   |   |   └── tests.py
    |   |   └── tests_sample.py
    |   ├── simple
    |   |   ├── __init__.py
    |   |   └── tests.py
    |   └── tagged
    |       ├── __init__.py
    |       ├── tests.py
    |       └── tests_inheritance.py
    ├── test_sqlite.py
    ├── test_utils
    |   ├── __init__.py
    |   ├── fixtures
    |   ├── models.py
    |   ├── templates
    |   |   └── template_used
    |   |       ├── alternative.html
    |   |       ├── base.html
    |   |       ├── extends.html
    |   |       └── include.html
    |   ├── test_deprecated_features.py
    |   ├── test_testcase.py
    |   ├── test_transactiontestcase.py
    |   ├── tests.py
    |   ├── urls.py
    |   └── views.py
    ├── timezones
    |   ├── __init__.py
    |   ├── admin.py
    |   ├── forms.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── transaction_hooks
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── transactions
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── unmanaged_models
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── update
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── update_only_fields
    |   ├── __init__.py
    |   ├── models.py
    |   └── tests.py
    ├── urlpatterns
    |   ├── __init__.py
    |   ├── converter_urls.py
    |   ├── converters.py
    |   ├── included_urls.py
    |   ├── more_urls.py
    |   ├── path_base64_urls.py
    |   ├── path_dynamic_urls.py
    |   ├── path_urls.py
    |   ├── test_resolvers.py
    |   ├── tests.py
    |   └── views.py
    ├── urlpatterns_reverse
    |   ├── __init__.py
    |   ├── erroneous_urls.py
    |   ├── extra_urls.py
    |   ├── included_app_urls.py
    |   ├── included_named_urls.py
    |   ├── included_named_urls2.py
    |   ├── included_namespace_urls.py
    |   ├── included_no_kwargs_urls.py
    |   ├── included_urls.py
    |   ├── included_urls2.py
    |   ├── method_view_urls.py
    |   ├── middleware.py
    |   ├── named_urls.py
    |   ├── named_urls_conflict.py
    |   ├── namespace_urls.py
    |   ├── nested_urls.py
    |   ├── no_urls.py
    |   ├── nonimported_module.py
    |   ├── reverse_lazy_urls.py
    |   ├── test_localeregexdescriptor.py
    |   ├── tests.py
    |   ├── translations
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       ├── __init__.py
    |   |       ├── de
    |   |       └── fr
    |   ├── urlconf_inner.py
    |   ├── urlconf_outer.py
    |   ├── urls.py
    |   ├── urls_error_handlers.py
    |   ├── urls_error_handlers_callables.py
    |   ├── urls_without_handlers.py
    |   ├── utils.py
    |   ├── views.py
    |   └── views_broken.py
    ├── urls.py
    ├── user_commands
    |   ├── __init__.py
    |   ├── eggs
    |   ├── management
    |   |   └── commands
    |   |       ├── common_args.py
    |   |       ├── dance.py
    |   |       ├── hal.py
    |   |       ├── no_translations.py
    |   |       ├── required_option.py
    |   |       ├── reverse_url.py
    |   |       ├── set_option.py
    |   |       ├── subparser.py
    |   |       └── transaction.py
    |   ├── models.py
    |   ├── tests.py
    |   └── urls.py
    ├── utils_tests
    |   ├── __init__.py
    |   ├── archives
    |   ├── eggs
    |   ├── files
    |   |   ├── strip_tags1.html
    |   |   └── strip_tags2.txt
    |   ├── models.py
    |   ├── test_archive.py
    |   ├── test_autoreload.py
    |   ├── test_baseconv.py
    |   ├── test_crypto.py
    |   ├── test_datastructures.py
    |   ├── test_dateformat.py
    |   ├── test_dateparse.py
    |   ├── test_datetime_safe.py
    |   ├── test_decorators.py
    |   ├── test_duration.py
    |   ├── test_encoding.py
    |   ├── test_encoding_deprecations.py
    |   ├── test_feedgenerator.py
    |   ├── test_functional.py
    |   ├── test_hashable.py
    |   ├── test_html.py
    |   ├── test_http.py
    |   ├── test_inspect.py
    |   ├── test_ipv6.py
    |   ├── test_jslex.py
    |   ├── test_lazyobject.py
    |   ├── test_lorem_ipsum.py
    |   ├── test_module
    |   |   ├── __init__.py
    |   |   ├── another_bad_module.py
    |   |   ├── another_good_module.py
    |   |   ├── bad_module.py
    |   |   ├── child_module
    |   |   |   ├── __init__.py
    |   |   |   └── grandchild_module.py
    |   |   └── good_module.py
    |   ├── test_module_loading.py
    |   ├── test_no_submodule.py
    |   ├── test_numberformat.py
    |   ├── test_os_utils.py
    |   ├── test_regex_helper.py
    |   ├── test_safestring.py
    |   ├── test_simplelazyobject.py
    |   ├── test_termcolors.py
    |   ├── test_text.py
    |   ├── test_timesince.py
    |   ├── test_timezone.py
    |   ├── test_topological_sort.py
    |   ├── test_tree.py
    |   └── utils.py
    ├── validation
    |   ├── __init__.py
    |   ├── models.py
    |   ├── test_custom_messages.py
    |   ├── test_error_messages.py
    |   ├── test_picklable.py
    |   ├── test_unique.py
    |   ├── test_validators.py
    |   └── tests.py
    ├── validators
    |   ├── __init__.py
    |   ├── invalid_urls.txt
    |   ├── tests.py
    |   └── valid_urls.txt
    ├── version
    |   ├── __init__.py
    |   └── tests.py
    ├── view_tests
    |   ├── __init__.py
    |   ├── app0
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── en
    |   ├── app1
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── app2
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── app3
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── es_AR
    |   ├── app4
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── es_AR
    |   ├── app5
    |   |   ├── __init__.py
    |   |   └── locale
    |   |       └── fr
    |   ├── default_urls.py
    |   ├── generic_urls.py
    |   ├── locale
    |   |   ├── de
    |   |   |   └── LC_MESSAGES
    |   |   ├── en_GB
    |   |   |   └── LC_MESSAGES
    |   |   ├── es
    |   |   |   └── LC_MESSAGES
    |   |   ├── fr
    |   |   |   └── LC_MESSAGES
    |   |   ├── nl
    |   |   |   └── LC_MESSAGES
    |   |   ├── pt
    |   |   |   └── LC_MESSAGES
    |   |   └── ru
    |   |       └── LC_MESSAGES
    |   ├── media
    |   |   ├── %2F.txt
    |   |   ├── file.txt
    |   |   ├── long-line.txt
    |   |   └── subdir
    |   ├── models.py
    |   ├── regression_21530_urls.py
    |   ├── templates
    |   |   ├── debug
    |   |   |   ├── template_error.html
    |   |   |   └── template_exception.html
    |   |   ├── jsi18n-multi-catalogs.html
    |   |   └── jsi18n.html
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: RenameContentType._rename() doesn't save the content type on the correct database

Description: Description
	
The commit in question:
​https://github.com/django/django/commit/f179113e6cbc8ba0a8d4e87e1d4410fb61d63e75
The specific lines in question:
​https://github.com/django/django/blob/586a9dc4295357de1f5ad0590ad34bf2bc008f79/django/contrib/contenttypes/management/__init__.py#L27
with transaction.atomic(using=db): 
	content_type.save(update_fields={'model'})
The issue:
For some background, we run a dynamic database router and have no "real" databases configured in the settings file, just a default sqlite3 backend which is never actually generated or used. We forked the migrate.py management command and modified it to accept a dictionary containing database connection parameters as the --database argument. 
The dynamic database router is based on, and very similar to this: ​https://github.com/ambitioninc/django-dynamic-db-router/blob/master/dynamic_db_router/router.py
This has worked beautifully for all migrations up until this point.
The issue we're running into is that when attempting to run a migration which contains a call to migrations.RenameModel, and while specifying the database parameters to the migrate command, the migration fails with an OperationalError, stating that no such table: django_content_types exists.
After having exhaustively stepped through the traceback, it appears that even though the content_type.save call is wrapped in the with transaction.atomic(using=db) context manager, the actual database operation is being attempted on the default database (which in our case does not exist) rather than the database specified via schema_editor.connection.alias (on line 15 of the same file) and thus fails loudly.
So, I believe that:
content_type.save(update_fields={'model'})
should be
content_type.save(using=db, update_fields={'model'})

Patch information:
diff --git a/django/contrib/contenttypes/management/__init__.py b/django/contrib/contenttypes/management/__init__.py
index 2b5f688136..563cba2fdf 100644
--- a/django/contrib/contenttypes/management/__init__.py
+++ b/django/contrib/contenttypes/management/__init__.py
@@ -24,7 +24,7 @@ class RenameContentType(migrations.RunPython):
             content_type.model = new_model
             try:
                 with transaction.atomic(using=db):
-                    content_type.save(update_fields={'model'})
+                    content_type.save(using=db, update_fields={'model'})
             except IntegrityError:
                 # Gracefully fallback if a stale content type causes a
                 # conflict as remove_stale_contenttypes will take care of


OBJECTIVE: Find 3 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 3 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 3 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of the following files: `tests/migrations/test_multidb.py`, `tests/contenttypes_tests/test_operations.py`, and `tests/migrations/test_operations.py`.
Extra Requirements: 
Purpose: These files are essential to identify test cases that cover multi-database migrations, the `RenameModel` operation, and specific `contenttypes` operations, which are all directly related to the bug report.

Previous refined query 2:
Essential Query: Please provide the full content of the files `tests/multiple_database/tests.py` and `tests/migrations/test_commands.py`.
Extra Requirements: 
Purpose: These files are essential for finding test cases that demonstrate running migrations on a non-default database and verifying that ORM operations within those migrations are correctly routed, which is the exact scenario described in the bug report.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: tests/contenttypes_tests/test_operations.py
Line number range: 1 - 66
Content:
1. from django.apps.registry import apps
2. from django.conf import settings
3. from django.contrib.contenttypes import management as contenttypes_management
4. from django.contrib.contenttypes.models import ContentType
5. from django.core.management import call_command
6. from django.db import migrations, models
7. from django.test import TransactionTestCase, override_settings
8. 
9. 
10. @override_settings(
11.     MIGRATION_MODULES=dict(
12.         settings.MIGRATION_MODULES,
13.         contenttypes_tests='contenttypes_tests.operations_migrations',
14.     ),
15. )
16. class ContentTypeOperationsTests(TransactionTestCase):
17.     available_apps = [
18.         'contenttypes_tests',
19.         'django.contrib.contenttypes',
20.     ]
21. 
22.     def setUp(self):
23.         app_config = apps.get_app_config('contenttypes_tests')
24.         models.signals.post_migrate.connect(self.assertOperationsInjected, sender=app_config)
25. 
26.     def tearDown(self):
27.         app_config = apps.get_app_config('contenttypes_tests')
28.         models.signals.post_migrate.disconnect(self.assertOperationsInjected, sender=app_config)
29. 
30.     def assertOperationsInjected(self, plan, **kwargs):
31.         for migration, _backward in plan:
32.             operations = iter(migration.operations)
33.             for operation in operations:
34.                 if isinstance(operation, migrations.RenameModel):
35.                     next_operation = next(operations)
36.                     self.assertIsInstance(next_operation, contenttypes_management.RenameContentType)
37.                     self.assertEqual(next_operation.app_label, migration.app_label)
38.                     self.assertEqual(next_operation.old_model, operation.old_name_lower)
39.                     self.assertEqual(next_operation.new_model, operation.new_name_lower)
40. 
41.     def test_existing_content_type_rename(self):
42.         ContentType.objects.create(app_label='contenttypes_tests', model='foo')
43.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0,)
44.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
45.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
46.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
47.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
48.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
49. 
50.     def test_missing_content_type_rename_ignore(self):
51.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0,)
52.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
53.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
54.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
55.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
56.         self.assertFalse(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
57. 
58.     def test_content_type_rename_conflict(self):
59.         ContentType.objects.create(app_label='contenttypes_tests', model='foo')
60.         ContentType.objects.create(app_label='contenttypes_tests', model='renamedfoo')
61.         call_command('migrate', 'contenttypes_tests', database='default', interactive=False, verbosity=0)
62.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
63.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())
64.         call_command('migrate', 'contenttypes_tests', 'zero', database='default', interactive=False, verbosity=0)
65.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='foo').exists())
66.         self.assertTrue(ContentType.objects.filter(app_label='contenttypes_tests', model='renamedfoo').exists())


File: tests/migrations/test_commands.py
Line number range: 1 - 500
Content:
1. import datetime
2. import importlib
3. import io
4. import os
5. import sys
6. from unittest import mock
7. 
8. from django.apps import apps
9. from django.core.management import CommandError, call_command
10. from django.db import (
11.     ConnectionHandler, DatabaseError, connection, connections, models,
12. )
13. from django.db.backends.base.schema import BaseDatabaseSchemaEditor
14. from django.db.backends.utils import truncate_name
15. from django.db.migrations.exceptions import InconsistentMigrationHistory
16. from django.db.migrations.recorder import MigrationRecorder
17. from django.test import TestCase, override_settings
18. 
19. from .models import UnicodeModel, UnserializableModel
20. from .routers import TestRouter
21. from .test_base import MigrationTestBase
22. 
23. 
24. class MigrateTests(MigrationTestBase):
25.     """
26.     Tests running the migrate command.
27.     """
28.     databases = {'default', 'other'}
29. 
30.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
31.     def test_migrate(self):
32.         """
33.         Tests basic usage of the migrate command.
34.         """
35.         # No tables are created
36.         self.assertTableNotExists("migrations_author")
37.         self.assertTableNotExists("migrations_tribble")
38.         self.assertTableNotExists("migrations_book")
39.         # Run the migrations to 0001 only
40.         stdout = io.StringIO()
41.         call_command('migrate', 'migrations', '0001', verbosity=1, stdout=stdout, no_color=True)
42.         stdout = stdout.getvalue()
43.         self.assertIn('Target specific migration: 0001_initial, from migrations', stdout)
44.         self.assertIn('Applying migrations.0001_initial... OK', stdout)
45.         # The correct tables exist
46.         self.assertTableExists("migrations_author")
47.         self.assertTableExists("migrations_tribble")
48.         self.assertTableNotExists("migrations_book")
49.         # Run migrations all the way
50.         call_command("migrate", verbosity=0)
51.         # The correct tables exist
52.         self.assertTableExists("migrations_author")
53.         self.assertTableNotExists("migrations_tribble")
54.         self.assertTableExists("migrations_book")
55.         # Unmigrate everything
56.         stdout = io.StringIO()
57.         call_command('migrate', 'migrations', 'zero', verbosity=1, stdout=stdout, no_color=True)
58.         stdout = stdout.getvalue()
59.         self.assertIn('Unapply all migrations: migrations', stdout)
60.         self.assertIn('Unapplying migrations.0002_second... OK', stdout)
61.         # Tables are gone
62.         self.assertTableNotExists("migrations_author")
63.         self.assertTableNotExists("migrations_tribble")
64.         self.assertTableNotExists("migrations_book")
65. 
66.     @override_settings(INSTALLED_APPS=[
67.         'django.contrib.auth',
68.         'django.contrib.contenttypes',
69.         'migrations.migrations_test_apps.migrated_app',
70.     ])
71.     def test_migrate_with_system_checks(self):
72.         out = io.StringIO()
73.         call_command('migrate', skip_checks=False, no_color=True, stdout=out)
74.         self.assertIn('Apply all migrations: migrated_app', out.getvalue())
75. 
76.     @override_settings(INSTALLED_APPS=['migrations', 'migrations.migrations_test_apps.unmigrated_app_syncdb'])
77.     def test_app_without_migrations(self):
78.         msg = "App 'unmigrated_app_syncdb' does not have migrations."
79.         with self.assertRaisesMessage(CommandError, msg):
80.             call_command('migrate', app_label='unmigrated_app_syncdb')
81. 
82.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_clashing_prefix'})
83.     def test_ambigious_prefix(self):
84.         msg = (
85.             "More than one migration matches 'a' in app 'migrations'. Please "
86.             "be more specific."
87.         )
88.         with self.assertRaisesMessage(CommandError, msg):
89.             call_command('migrate', app_label='migrations', migration_name='a')
90. 
91.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
92.     def test_unknown_prefix(self):
93.         msg = "Cannot find a migration matching 'nonexistent' from app 'migrations'."
94.         with self.assertRaisesMessage(CommandError, msg):
95.             call_command('migrate', app_label='migrations', migration_name='nonexistent')
96. 
97.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_initial_false"})
98.     def test_migrate_initial_false(self):
99.         """
100.         `Migration.initial = False` skips fake-initial detection.
101.         """
102.         # Make sure no tables are created
103.         self.assertTableNotExists("migrations_author")
104.         self.assertTableNotExists("migrations_tribble")
105.         # Run the migrations to 0001 only
106.         call_command("migrate", "migrations", "0001", verbosity=0)
107.         # Fake rollback
108.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
109.         # Make sure fake-initial detection does not run
110.         with self.assertRaises(DatabaseError):
111.             call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0)
112. 
113.         call_command("migrate", "migrations", "0001", fake=True, verbosity=0)
114.         # Real rollback
115.         call_command("migrate", "migrations", "zero", verbosity=0)
116.         # Make sure it's all gone
117.         self.assertTableNotExists("migrations_author")
118.         self.assertTableNotExists("migrations_tribble")
119.         self.assertTableNotExists("migrations_book")
120. 
121.     @override_settings(
122.         MIGRATION_MODULES={"migrations": "migrations.test_migrations"},
123.         DATABASE_ROUTERS=['migrations.routers.TestRouter'],
124.     )
125.     def test_migrate_fake_initial(self):
126.         """
127.         --fake-initial only works if all tables created in the initial
128.         migration of an app exists. Database routers must be obeyed when doing
129.         that check.
130.         """
131.         # Make sure no tables are created
132.         for db in connections:
133.             self.assertTableNotExists("migrations_author", using=db)
134.             self.assertTableNotExists("migrations_tribble", using=db)
135.         # Run the migrations to 0001 only
136.         call_command("migrate", "migrations", "0001", verbosity=0)
137.         call_command("migrate", "migrations", "0001", verbosity=0, database="other")
138.         # Make sure the right tables exist
139.         self.assertTableExists("migrations_author")
140.         self.assertTableNotExists("migrations_tribble")
141.         # Also check the "other" database
142.         self.assertTableNotExists("migrations_author", using="other")
143.         self.assertTableExists("migrations_tribble", using="other")
144. 
145.         # Fake a roll-back
146.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
147.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
148.         # Make sure the tables still exist
149.         self.assertTableExists("migrations_author")
150.         self.assertTableExists("migrations_tribble", using="other")
151.         # Try to run initial migration
152.         with self.assertRaises(DatabaseError):
153.             call_command("migrate", "migrations", "0001", verbosity=0)
154.         # Run initial migration with an explicit --fake-initial
155.         out = io.StringIO()
156.         with mock.patch('django.core.management.color.supports_color', lambda *args: False):
157.             call_command("migrate", "migrations", "0001", fake_initial=True, stdout=out, verbosity=1)
158.             call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0, database="other")
159.         self.assertIn(
160.             "migrations.0001_initial... faked",
161.             out.getvalue().lower()
162.         )
163.         # Run migrations all the way
164.         call_command("migrate", verbosity=0)
165.         call_command("migrate", verbosity=0, database="other")
166.         # Make sure the right tables exist
167.         self.assertTableExists("migrations_author")
168.         self.assertTableNotExists("migrations_tribble")
169.         self.assertTableExists("migrations_book")
170.         self.assertTableNotExists("migrations_author", using="other")
171.         self.assertTableNotExists("migrations_tribble", using="other")
172.         self.assertTableNotExists("migrations_book", using="other")
173.         # Fake a roll-back
174.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
175.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
176.         # Make sure the tables still exist
177.         self.assertTableExists("migrations_author")
178.         self.assertTableNotExists("migrations_tribble")
179.         self.assertTableExists("migrations_book")
180.         # Try to run initial migration
181.         with self.assertRaises(DatabaseError):
182.             call_command("migrate", "migrations", verbosity=0)
183.         # Run initial migration with an explicit --fake-initial
184.         with self.assertRaises(DatabaseError):
185.             # Fails because "migrations_tribble" does not exist but needs to in
186.             # order to make --fake-initial work.
187.             call_command("migrate", "migrations", fake_initial=True, verbosity=0)
188.         # Fake an apply
189.         call_command("migrate", "migrations", fake=True, verbosity=0)
190.         call_command("migrate", "migrations", fake=True, verbosity=0, database="other")
191.         # Unmigrate everything
192.         call_command("migrate", "migrations", "zero", verbosity=0)
193.         call_command("migrate", "migrations", "zero", verbosity=0, database="other")
194.         # Make sure it's all gone
195.         for db in connections:
196.             self.assertTableNotExists("migrations_author", using=db)
197.             self.assertTableNotExists("migrations_tribble", using=db)
198.             self.assertTableNotExists("migrations_book", using=db)
199. 
200.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_fake_split_initial"})
201.     def test_migrate_fake_split_initial(self):
202.         """
203.         Split initial migrations can be faked with --fake-initial.
204.         """
205.         call_command("migrate", "migrations", "0002", verbosity=0)
206.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
207.         out = io.StringIO()
208.         with mock.patch('django.core.management.color.supports_color', lambda *args: False):
209.             call_command("migrate", "migrations", "0002", fake_initial=True, stdout=out, verbosity=1)
210.         value = out.getvalue().lower()
211.         self.assertIn("migrations.0001_initial... faked", value)
212.         self.assertIn("migrations.0002_second... faked", value)
213.         # Fake an apply
214.         call_command("migrate", "migrations", fake=True, verbosity=0)
215.         # Unmigrate everything
216.         call_command("migrate", "migrations", "zero", verbosity=0)
217. 
218.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_conflict"})
219.     def test_migrate_conflict_exit(self):
220.         """
221.         migrate exits if it detects a conflict.
222.         """
223.         with self.assertRaisesMessage(CommandError, "Conflicting migrations detected"):
224.             call_command("migrate", "migrations")
225. 
226.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
227.     def test_showmigrations_list(self):
228.         """
229.         showmigrations --list  displays migrations and whether or not they're
230.         applied.
231.         """
232.         out = io.StringIO()
233.         with mock.patch('django.core.management.color.supports_color', lambda *args: True):
234.             call_command("showmigrations", format='list', stdout=out, verbosity=0, no_color=False)
235.         self.assertEqual(
236.             '\x1b[1mmigrations\n\x1b[0m'
237.             ' [ ] 0001_initial\n'
238.             ' [ ] 0002_second\n',
239.             out.getvalue().lower()
240.         )
241. 
242.         call_command("migrate", "migrations", "0001", verbosity=0)
243. 
244.         out = io.StringIO()
245.         # Giving the explicit app_label tests for selective `show_list` in the command
246.         call_command("showmigrations", "migrations", format='list', stdout=out, verbosity=0, no_color=True)
247.         self.assertEqual(
248.             'migrations\n'
249.             ' [x] 0001_initial\n'
250.             ' [ ] 0002_second\n',
251.             out.getvalue().lower()
252.         )
253.         out = io.StringIO()
254.         # Applied datetimes are displayed at verbosity 2+.
255.         call_command('showmigrations', 'migrations', stdout=out, verbosity=2, no_color=True)
256.         migration1 = MigrationRecorder(connection).migration_qs.get(app='migrations', name='0001_initial')
257.         self.assertEqual(
258.             'migrations\n'
259.             ' [x] 0001_initial (applied at %s)\n'
260.             ' [ ] 0002_second\n' % migration1.applied.strftime('%Y-%m-%d %H:%M:%S'),
261.             out.getvalue().lower()
262.         )
263.         # Cleanup by unmigrating everything
264.         call_command("migrate", "migrations", "zero", verbosity=0)
265. 
266.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_run_before"})
267.     def test_showmigrations_plan(self):
268.         """
269.         Tests --plan output of showmigrations command
270.         """
271.         out = io.StringIO()
272.         call_command("showmigrations", format='plan', stdout=out)
273.         self.assertEqual(
274.             "[ ]  migrations.0001_initial\n"
275.             "[ ]  migrations.0003_third\n"
276.             "[ ]  migrations.0002_second\n",
277.             out.getvalue().lower()
278.         )
279. 
280.         out = io.StringIO()
281.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
282.         self.assertEqual(
283.             "[ ]  migrations.0001_initial\n"
284.             "[ ]  migrations.0003_third ... (migrations.0001_initial)\n"
285.             "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
286.             out.getvalue().lower()
287.         )
288.         call_command("migrate", "migrations", "0003", verbosity=0)
289. 
290.         out = io.StringIO()
291.         call_command("showmigrations", format='plan', stdout=out)
292.         self.assertEqual(
293.             "[x]  migrations.0001_initial\n"
294.             "[x]  migrations.0003_third\n"
295.             "[ ]  migrations.0002_second\n",
296.             out.getvalue().lower()
297.         )
298. 
299.         out = io.StringIO()
300.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
301.         self.assertEqual(
302.             "[x]  migrations.0001_initial\n"
303.             "[x]  migrations.0003_third ... (migrations.0001_initial)\n"
304.             "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
305.             out.getvalue().lower()
306.         )
307. 
308.         # Cleanup by unmigrating everything
309.         call_command("migrate", "migrations", "zero", verbosity=0)
310. 
311.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_plan'})
312.     def test_migrate_plan(self):
313.         """Tests migrate --plan output."""
314.         out = io.StringIO()
315.         # Show the plan up to the third migration.
316.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
317.         self.assertEqual(
318.             'Planned operations:\n'
319.             'migrations.0001_initial\n'
320.             '    Create model Salamander\n'
321.             '    Raw Python operation -> Grow salamander tail.\n'
322.             'migrations.0002_second\n'
323.             '    Create model Book\n'
324.             "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
325.             'migrations.0003_third\n'
326.             '    Create model Author\n'
327.             "    Raw SQL operation -> ['SELECT * FROM migrations_author']\n",
328.             out.getvalue()
329.         )
330.         # Migrate to the third migration.
331.         call_command('migrate', 'migrations', '0003', verbosity=0)
332.         out = io.StringIO()
333.         # Show the plan for when there is nothing to apply.
334.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
335.         self.assertEqual(
336.             'Planned operations:\n'
337.             '  No planned migration operations.\n',
338.             out.getvalue()
339.         )
340.         out = io.StringIO()
341.         # Show the plan for reverse migration back to 0001.
342.         call_command('migrate', 'migrations', '0001', plan=True, stdout=out, no_color=True)
343.         self.assertEqual(
344.             'Planned operations:\n'
345.             'migrations.0003_third\n'
346.             '    Undo Create model Author\n'
347.             "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
348.             'migrations.0002_second\n'
349.             '    Undo Create model Book\n'
350.             "    Raw SQL operation -> ['SELECT * FROM migrations_salamand…\n",
351.             out.getvalue()
352.         )
353.         out = io.StringIO()
354.         # Show the migration plan to fourth, with truncated details.
355.         call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
356.         self.assertEqual(
357.             'Planned operations:\n'
358.             'migrations.0004_fourth\n'
359.             '    Raw SQL operation -> SELECT * FROM migrations_author WHE…\n',
360.             out.getvalue()
361.         )
362.         # Show the plan when an operation is irreversible.
363.         # Migrate to the fourth migration.
364.         call_command('migrate', 'migrations', '0004', verbosity=0)
365.         out = io.StringIO()
366.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
367.         self.assertEqual(
368.             'Planned operations:\n'
369.             'migrations.0004_fourth\n'
370.             '    Raw SQL operation -> IRREVERSIBLE\n',
371.             out.getvalue()
372.         )
373.         # Cleanup by unmigrating everything: fake the irreversible, then
374.         # migrate all to zero.
375.         call_command('migrate', 'migrations', '0003', fake=True, verbosity=0)
376.         call_command('migrate', 'migrations', 'zero', verbosity=0)
377. 
378.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_empty'})
379.     def test_showmigrations_no_migrations(self):
380.         out = io.StringIO()
381.         call_command('showmigrations', stdout=out, no_color=True)
382.         self.assertEqual('migrations\n (no migrations)\n', out.getvalue().lower())
383. 
384.     @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app'])
385.     def test_showmigrations_unmigrated_app(self):
386.         out = io.StringIO()
387.         call_command('showmigrations', 'unmigrated_app', stdout=out, no_color=True)
388.         self.assertEqual('unmigrated_app\n (no migrations)\n', out.getvalue().lower())
389. 
390.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_empty"})
391.     def test_showmigrations_plan_no_migrations(self):
392.         """
393.         Tests --plan output of showmigrations command without migrations
394.         """
395.         out = io.StringIO()
396.         call_command('showmigrations', format='plan', stdout=out, no_color=True)
397.         self.assertEqual('(no migrations)\n', out.getvalue().lower())
398. 
399.         out = io.StringIO()
400.         call_command('showmigrations', format='plan', stdout=out, verbosity=2, no_color=True)
401.         self.assertEqual('(no migrations)\n', out.getvalue().lower())
402. 
403.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed_complex"})
404.     def test_showmigrations_plan_squashed(self):
405.         """
406.         Tests --plan output of showmigrations command with squashed migrations.
407.         """
408.         out = io.StringIO()
409.         call_command("showmigrations", format='plan', stdout=out)
410.         self.assertEqual(
411.             "[ ]  migrations.1_auto\n"
412.             "[ ]  migrations.2_auto\n"
413.             "[ ]  migrations.3_squashed_5\n"
414.             "[ ]  migrations.6_auto\n"
415.             "[ ]  migrations.7_auto\n",
416.             out.getvalue().lower()
417.         )
418. 
419.         out = io.StringIO()
420.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
421.         self.assertEqual(
422.             "[ ]  migrations.1_auto\n"
423.             "[ ]  migrations.2_auto ... (migrations.1_auto)\n"
424.             "[ ]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
425.             "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
426.             "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
427.             out.getvalue().lower()
428.         )
429. 
430.         call_command("migrate", "migrations", "3_squashed_5", verbosity=0)
431. 
432.         out = io.StringIO()
433.         call_command("showmigrations", format='plan', stdout=out)
434.         self.assertEqual(
435.             "[x]  migrations.1_auto\n"
436.             "[x]  migrations.2_auto\n"
437.             "[x]  migrations.3_squashed_5\n"
438.             "[ ]  migrations.6_auto\n"
439.             "[ ]  migrations.7_auto\n",
440.             out.getvalue().lower()
441.         )
442. 
443.         out = io.StringIO()
444.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
445.         self.assertEqual(
446.             "[x]  migrations.1_auto\n"
447.             "[x]  migrations.2_auto ... (migrations.1_auto)\n"
448.             "[x]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
449.             "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
450.             "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
451.             out.getvalue().lower()
452.         )
453. 
454.     @override_settings(INSTALLED_APPS=[
455.         'migrations.migrations_test_apps.mutate_state_b',
456.         'migrations.migrations_test_apps.alter_fk.author_app',
457.         'migrations.migrations_test_apps.alter_fk.book_app',
458.     ])
459.     def test_showmigrations_plan_single_app_label(self):
460.         """
461.         `showmigrations --plan app_label` output with a single app_label.
462.         """
463.         # Single app with no dependencies on other apps.
464.         out = io.StringIO()
465.         call_command('showmigrations', 'mutate_state_b', format='plan', stdout=out)
466.         self.assertEqual(
467.             '[ ]  mutate_state_b.0001_initial\n'
468.             '[ ]  mutate_state_b.0002_add_field\n',
469.             out.getvalue()
470.         )
471.         # Single app with dependencies.
472.         out = io.StringIO()
473.         call_command('showmigrations', 'author_app', format='plan', stdout=out)
474.         self.assertEqual(
475.             '[ ]  author_app.0001_initial\n'
476.             '[ ]  book_app.0001_initial\n'
477.             '[ ]  author_app.0002_alter_id\n',
478.             out.getvalue()
479.         )
480.         # Some migrations already applied.
481.         call_command('migrate', 'author_app', '0001', verbosity=0)
482.         out = io.StringIO()
483.         call_command('showmigrations', 'author_app', format='plan', stdout=out)
484.         self.assertEqual(
485.             '[X]  author_app.0001_initial\n'
486.             '[ ]  book_app.0001_initial\n'
487.             '[ ]  author_app.0002_alter_id\n',
488.             out.getvalue()
489.         )
490.         # Cleanup by unmigrating author_app.
491.         call_command('migrate', 'author_app', 'zero', verbosity=0)
492. 
493.     @override_settings(INSTALLED_APPS=[
494.         'migrations.migrations_test_apps.mutate_state_b',
495.         'migrations.migrations_test_apps.alter_fk.author_app',
496.         'migrations.migrations_test_apps.alter_fk.book_app',
497.     ])
498.     def test_showmigrations_plan_multiple_app_labels(self):
499.         """
500.         `showmigrations --plan app_label` output with multiple app_labels.


File: tests/migrations/test_commands.py
Line number range: 24 - 775
Content:
24. class MigrateTests(MigrationTestBase):
25.     """
26.     Tests running the migrate command.
27.     """
28.     databases = {'default', 'other'}
29. 
30.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
31.     def test_migrate(self):
32.         """
33.         Tests basic usage of the migrate command.
34.         """
35.         # No tables are created
36.         self.assertTableNotExists("migrations_author")
37.         self.assertTableNotExists("migrations_tribble")
38.         self.assertTableNotExists("migrations_book")
39.         # Run the migrations to 0001 only
40.         stdout = io.StringIO()
41.         call_command('migrate', 'migrations', '0001', verbosity=1, stdout=stdout, no_color=True)
42.         stdout = stdout.getvalue()
43.         self.assertIn('Target specific migration: 0001_initial, from migrations', stdout)
44.         self.assertIn('Applying migrations.0001_initial... OK', stdout)
45.         # The correct tables exist
46.         self.assertTableExists("migrations_author")
47.         self.assertTableExists("migrations_tribble")
48.         self.assertTableNotExists("migrations_book")
49.         # Run migrations all the way
50.         call_command("migrate", verbosity=0)
51.         # The correct tables exist
52.         self.assertTableExists("migrations_author")
53.         self.assertTableNotExists("migrations_tribble")
54.         self.assertTableExists("migrations_book")
55.         # Unmigrate everything
56.         stdout = io.StringIO()
57.         call_command('migrate', 'migrations', 'zero', verbosity=1, stdout=stdout, no_color=True)
58.         stdout = stdout.getvalue()
59.         self.assertIn('Unapply all migrations: migrations', stdout)
60.         self.assertIn('Unapplying migrations.0002_second... OK', stdout)
61.         # Tables are gone
62.         self.assertTableNotExists("migrations_author")
63.         self.assertTableNotExists("migrations_tribble")
64.         self.assertTableNotExists("migrations_book")
65. 
66.     @override_settings(INSTALLED_APPS=[
67.         'django.contrib.auth',
68.         'django.contrib.contenttypes',
69.         'migrations.migrations_test_apps.migrated_app',
70.     ])
71.     def test_migrate_with_system_checks(self):
72.         out = io.StringIO()
73.         call_command('migrate', skip_checks=False, no_color=True, stdout=out)
74.         self.assertIn('Apply all migrations: migrated_app', out.getvalue())
75. 
76.     @override_settings(INSTALLED_APPS=['migrations', 'migrations.migrations_test_apps.unmigrated_app_syncdb'])
77.     def test_app_without_migrations(self):
78.         msg = "App 'unmigrated_app_syncdb' does not have migrations."
79.         with self.assertRaisesMessage(CommandError, msg):
80.             call_command('migrate', app_label='unmigrated_app_syncdb')
81. 
82.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_clashing_prefix'})
83.     def test_ambigious_prefix(self):
84.         msg = (
85.             "More than one migration matches 'a' in app 'migrations'. Please "
86.             "be more specific."
87.         )
88.         with self.assertRaisesMessage(CommandError, msg):
89.             call_command('migrate', app_label='migrations', migration_name='a')
90. 
91.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
92.     def test_unknown_prefix(self):
93.         msg = "Cannot find a migration matching 'nonexistent' from app 'migrations'."
94.         with self.assertRaisesMessage(CommandError, msg):
95.             call_command('migrate', app_label='migrations', migration_name='nonexistent')
96. 
97.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_initial_false"})
98.     def test_migrate_initial_false(self):
99.         """
100.         `Migration.initial = False` skips fake-initial detection.
101.         """
102.         # Make sure no tables are created
103.         self.assertTableNotExists("migrations_author")
104.         self.assertTableNotExists("migrations_tribble")
105.         # Run the migrations to 0001 only
106.         call_command("migrate", "migrations", "0001", verbosity=0)
107.         # Fake rollback
108.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
109.         # Make sure fake-initial detection does not run
110.         with self.assertRaises(DatabaseError):
111.             call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0)
112. 
113.         call_command("migrate", "migrations", "0001", fake=True, verbosity=0)
114.         # Real rollback
115.         call_command("migrate", "migrations", "zero", verbosity=0)
116.         # Make sure it's all gone
117.         self.assertTableNotExists("migrations_author")
118.         self.assertTableNotExists("migrations_tribble")
119.         self.assertTableNotExists("migrations_book")
120. 
121.     @override_settings(
122.         MIGRATION_MODULES={"migrations": "migrations.test_migrations"},
123.         DATABASE_ROUTERS=['migrations.routers.TestRouter'],
124.     )
125.     def test_migrate_fake_initial(self):
126.         """
127.         --fake-initial only works if all tables created in the initial
128.         migration of an app exists. Database routers must be obeyed when doing
129.         that check.
130.         """
131.         # Make sure no tables are created
132.         for db in connections:
133.             self.assertTableNotExists("migrations_author", using=db)
134.             self.assertTableNotExists("migrations_tribble", using=db)
135.         # Run the migrations to 0001 only
136.         call_command("migrate", "migrations", "0001", verbosity=0)
137.         call_command("migrate", "migrations", "0001", verbosity=0, database="other")
138.         # Make sure the right tables exist
139.         self.assertTableExists("migrations_author")
140.         self.assertTableNotExists("migrations_tribble")
141.         # Also check the "other" database
142.         self.assertTableNotExists("migrations_author", using="other")
143.         self.assertTableExists("migrations_tribble", using="other")
144. 
145.         # Fake a roll-back
146.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
147.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
148.         # Make sure the tables still exist
149.         self.assertTableExists("migrations_author")
150.         self.assertTableExists("migrations_tribble", using="other")
151.         # Try to run initial migration
152.         with self.assertRaises(DatabaseError):
153.             call_command("migrate", "migrations", "0001", verbosity=0)
154.         # Run initial migration with an explicit --fake-initial
155.         out = io.StringIO()
156.         with mock.patch('django.core.management.color.supports_color', lambda *args: False):
157.             call_command("migrate", "migrations", "0001", fake_initial=True, stdout=out, verbosity=1)
158.             call_command("migrate", "migrations", "0001", fake_initial=True, verbosity=0, database="other")
159.         self.assertIn(
160.             "migrations.0001_initial... faked",
161.             out.getvalue().lower()
162.         )
163.         # Run migrations all the way
164.         call_command("migrate", verbosity=0)
165.         call_command("migrate", verbosity=0, database="other")
166.         # Make sure the right tables exist
167.         self.assertTableExists("migrations_author")
168.         self.assertTableNotExists("migrations_tribble")
169.         self.assertTableExists("migrations_book")
170.         self.assertTableNotExists("migrations_author", using="other")
171.         self.assertTableNotExists("migrations_tribble", using="other")
172.         self.assertTableNotExists("migrations_book", using="other")
173.         # Fake a roll-back
174.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
175.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0, database="other")
176.         # Make sure the tables still exist
177.         self.assertTableExists("migrations_author")
178.         self.assertTableNotExists("migrations_tribble")
179.         self.assertTableExists("migrations_book")
180.         # Try to run initial migration
181.         with self.assertRaises(DatabaseError):
182.             call_command("migrate", "migrations", verbosity=0)
183.         # Run initial migration with an explicit --fake-initial
184.         with self.assertRaises(DatabaseError):
185.             # Fails because "migrations_tribble" does not exist but needs to in
186.             # order to make --fake-initial work.
187.             call_command("migrate", "migrations", fake_initial=True, verbosity=0)
188.         # Fake an apply
189.         call_command("migrate", "migrations", fake=True, verbosity=0)
190.         call_command("migrate", "migrations", fake=True, verbosity=0, database="other")
191.         # Unmigrate everything
192.         call_command("migrate", "migrations", "zero", verbosity=0)
193.         call_command("migrate", "migrations", "zero", verbosity=0, database="other")
194.         # Make sure it's all gone
195.         for db in connections:
196.             self.assertTableNotExists("migrations_author", using=db)
197.             self.assertTableNotExists("migrations_tribble", using=db)
198.             self.assertTableNotExists("migrations_book", using=db)
199. 
200.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_fake_split_initial"})
201.     def test_migrate_fake_split_initial(self):
202.         """
203.         Split initial migrations can be faked with --fake-initial.
204.         """
205.         call_command("migrate", "migrations", "0002", verbosity=0)
206.         call_command("migrate", "migrations", "zero", fake=True, verbosity=0)
207.         out = io.StringIO()
208.         with mock.patch('django.core.management.color.supports_color', lambda *args: False):
209.             call_command("migrate", "migrations", "0002", fake_initial=True, stdout=out, verbosity=1)
210.         value = out.getvalue().lower()
211.         self.assertIn("migrations.0001_initial... faked", value)
212.         self.assertIn("migrations.0002_second... faked", value)
213.         # Fake an apply
214.         call_command("migrate", "migrations", fake=True, verbosity=0)
215.         # Unmigrate everything
216.         call_command("migrate", "migrations", "zero", verbosity=0)
217. 
218.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_conflict"})
219.     def test_migrate_conflict_exit(self):
220.         """
221.         migrate exits if it detects a conflict.
222.         """
223.         with self.assertRaisesMessage(CommandError, "Conflicting migrations detected"):
224.             call_command("migrate", "migrations")
225. 
226.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
227.     def test_showmigrations_list(self):
228.         """
229.         showmigrations --list  displays migrations and whether or not they're
230.         applied.
231.         """
232.         out = io.StringIO()
233.         with mock.patch('django.core.management.color.supports_color', lambda *args: True):
234.             call_command("showmigrations", format='list', stdout=out, verbosity=0, no_color=False)
235.         self.assertEqual(
236.             '\x1b[1mmigrations\n\x1b[0m'
237.             ' [ ] 0001_initial\n'
238.             ' [ ] 0002_second\n',
239.             out.getvalue().lower()
240.         )
241. 
242.         call_command("migrate", "migrations", "0001", verbosity=0)
243. 
244.         out = io.StringIO()
245.         # Giving the explicit app_label tests for selective `show_list` in the command
246.         call_command("showmigrations", "migrations", format='list', stdout=out, verbosity=0, no_color=True)
247.         self.assertEqual(
248.             'migrations\n'
249.             ' [x] 0001_initial\n'
250.             ' [ ] 0002_second\n',
251.             out.getvalue().lower()
252.         )
253.         out = io.StringIO()
254.         # Applied datetimes are displayed at verbosity 2+.
255.         call_command('showmigrations', 'migrations', stdout=out, verbosity=2, no_color=True)
256.         migration1 = MigrationRecorder(connection).migration_qs.get(app='migrations', name='0001_initial')
257.         self.assertEqual(
258.             'migrations\n'
259.             ' [x] 0001_initial (applied at %s)\n'
260.             ' [ ] 0002_second\n' % migration1.applied.strftime('%Y-%m-%d %H:%M:%S'),
261.             out.getvalue().lower()
262.         )
263.         # Cleanup by unmigrating everything
264.         call_command("migrate", "migrations", "zero", verbosity=0)
265. 
266.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_run_before"})
267.     def test_showmigrations_plan(self):
268.         """
269.         Tests --plan output of showmigrations command
270.         """
271.         out = io.StringIO()
272.         call_command("showmigrations", format='plan', stdout=out)
273.         self.assertEqual(
274.             "[ ]  migrations.0001_initial\n"
275.             "[ ]  migrations.0003_third\n"
276.             "[ ]  migrations.0002_second\n",
277.             out.getvalue().lower()
278.         )
279. 
280.         out = io.StringIO()
281.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
282.         self.assertEqual(
283.             "[ ]  migrations.0001_initial\n"
284.             "[ ]  migrations.0003_third ... (migrations.0001_initial)\n"
285.             "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
286.             out.getvalue().lower()
287.         )
288.         call_command("migrate", "migrations", "0003", verbosity=0)
289. 
290.         out = io.StringIO()
291.         call_command("showmigrations", format='plan', stdout=out)
292.         self.assertEqual(
293.             "[x]  migrations.0001_initial\n"
294.             "[x]  migrations.0003_third\n"
295.             "[ ]  migrations.0002_second\n",
296.             out.getvalue().lower()
297.         )
298. 
299.         out = io.StringIO()
300.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
301.         self.assertEqual(
302.             "[x]  migrations.0001_initial\n"
303.             "[x]  migrations.0003_third ... (migrations.0001_initial)\n"
304.             "[ ]  migrations.0002_second ... (migrations.0001_initial, migrations.0003_third)\n",
305.             out.getvalue().lower()
306.         )
307. 
308.         # Cleanup by unmigrating everything
309.         call_command("migrate", "migrations", "zero", verbosity=0)
310. 
311.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_plan'})
312.     def test_migrate_plan(self):
313.         """Tests migrate --plan output."""
314.         out = io.StringIO()
315.         # Show the plan up to the third migration.
316.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
317.         self.assertEqual(
318.             'Planned operations:\n'
319.             'migrations.0001_initial\n'
320.             '    Create model Salamander\n'
321.             '    Raw Python operation -> Grow salamander tail.\n'
322.             'migrations.0002_second\n'
323.             '    Create model Book\n'
324.             "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
325.             'migrations.0003_third\n'
326.             '    Create model Author\n'
327.             "    Raw SQL operation -> ['SELECT * FROM migrations_author']\n",
328.             out.getvalue()
329.         )
330.         # Migrate to the third migration.
331.         call_command('migrate', 'migrations', '0003', verbosity=0)
332.         out = io.StringIO()
333.         # Show the plan for when there is nothing to apply.
334.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
335.         self.assertEqual(
336.             'Planned operations:\n'
337.             '  No planned migration operations.\n',
338.             out.getvalue()
339.         )
340.         out = io.StringIO()
341.         # Show the plan for reverse migration back to 0001.
342.         call_command('migrate', 'migrations', '0001', plan=True, stdout=out, no_color=True)
343.         self.assertEqual(
344.             'Planned operations:\n'
345.             'migrations.0003_third\n'
346.             '    Undo Create model Author\n'
347.             "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
348.             'migrations.0002_second\n'
349.             '    Undo Create model Book\n'
350.             "    Raw SQL operation -> ['SELECT * FROM migrations_salamand…\n",
351.             out.getvalue()
352.         )
353.         out = io.StringIO()
354.         # Show the migration plan to fourth, with truncated details.
355.         call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
356.         self.assertEqual(
357.             'Planned operations:\n'
358.             'migrations.0004_fourth\n'
359.             '    Raw SQL operation -> SELECT * FROM migrations_author WHE…\n',
360.             out.getvalue()
361.         )
362.         # Show the plan when an operation is irreversible.
363.         # Migrate to the fourth migration.
364.         call_command('migrate', 'migrations', '0004', verbosity=0)
365.         out = io.StringIO()
366.         call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
367.         self.assertEqual(
368.             'Planned operations:\n'
369.             'migrations.0004_fourth\n'
370.             '    Raw SQL operation -> IRREVERSIBLE\n',
371.             out.getvalue()
372.         )
373.         # Cleanup by unmigrating everything: fake the irreversible, then
374.         # migrate all to zero.
375.         call_command('migrate', 'migrations', '0003', fake=True, verbosity=0)
376.         call_command('migrate', 'migrations', 'zero', verbosity=0)
377. 
378.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_empty'})
379.     def test_showmigrations_no_migrations(self):
380.         out = io.StringIO()
381.         call_command('showmigrations', stdout=out, no_color=True)
382.         self.assertEqual('migrations\n (no migrations)\n', out.getvalue().lower())
383. 
384.     @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app'])
385.     def test_showmigrations_unmigrated_app(self):
386.         out = io.StringIO()
387.         call_command('showmigrations', 'unmigrated_app', stdout=out, no_color=True)
388.         self.assertEqual('unmigrated_app\n (no migrations)\n', out.getvalue().lower())
389. 
390.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_empty"})
391.     def test_showmigrations_plan_no_migrations(self):
392.         """
393.         Tests --plan output of showmigrations command without migrations
394.         """
395.         out = io.StringIO()
396.         call_command('showmigrations', format='plan', stdout=out, no_color=True)
397.         self.assertEqual('(no migrations)\n', out.getvalue().lower())
398. 
399.         out = io.StringIO()
400.         call_command('showmigrations', format='plan', stdout=out, verbosity=2, no_color=True)
401.         self.assertEqual('(no migrations)\n', out.getvalue().lower())
402. 
403.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed_complex"})
404.     def test_showmigrations_plan_squashed(self):
405.         """
406.         Tests --plan output of showmigrations command with squashed migrations.
407.         """
408.         out = io.StringIO()
409.         call_command("showmigrations", format='plan', stdout=out)
410.         self.assertEqual(
411.             "[ ]  migrations.1_auto\n"
412.             "[ ]  migrations.2_auto\n"
413.             "[ ]  migrations.3_squashed_5\n"
414.             "[ ]  migrations.6_auto\n"
415.             "[ ]  migrations.7_auto\n",
416.             out.getvalue().lower()
417.         )
418. 
419.         out = io.StringIO()
420.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
421.         self.assertEqual(
422.             "[ ]  migrations.1_auto\n"
423.             "[ ]  migrations.2_auto ... (migrations.1_auto)\n"
424.             "[ ]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
425.             "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
426.             "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
427.             out.getvalue().lower()
428.         )
429. 
430.         call_command("migrate", "migrations", "3_squashed_5", verbosity=0)
431. 
432.         out = io.StringIO()
433.         call_command("showmigrations", format='plan', stdout=out)
434.         self.assertEqual(
435.             "[x]  migrations.1_auto\n"
436.             "[x]  migrations.2_auto\n"
437.             "[x]  migrations.3_squashed_5\n"
438.             "[ ]  migrations.6_auto\n"
439.             "[ ]  migrations.7_auto\n",
440.             out.getvalue().lower()
441.         )
442. 
443.         out = io.StringIO()
444.         call_command("showmigrations", format='plan', stdout=out, verbosity=2)
445.         self.assertEqual(
446.             "[x]  migrations.1_auto\n"
447.             "[x]  migrations.2_auto ... (migrations.1_auto)\n"
448.             "[x]  migrations.3_squashed_5 ... (migrations.2_auto)\n"
449.             "[ ]  migrations.6_auto ... (migrations.3_squashed_5)\n"
450.             "[ ]  migrations.7_auto ... (migrations.6_auto)\n",
451.             out.getvalue().lower()
452.         )
453. 
454.     @override_settings(INSTALLED_APPS=[
455.         'migrations.migrations_test_apps.mutate_state_b',
456.         'migrations.migrations_test_apps.alter_fk.author_app',
457.         'migrations.migrations_test_apps.alter_fk.book_app',
458.     ])
459.     def test_showmigrations_plan_single_app_label(self):
460.         """
461.         `showmigrations --plan app_label` output with a single app_label.
462.         """
463.         # Single app with no dependencies on other apps.
464.         out = io.StringIO()
465.         call_command('showmigrations', 'mutate_state_b', format='plan', stdout=out)
466.         self.assertEqual(
467.             '[ ]  mutate_state_b.0001_initial\n'
468.             '[ ]  mutate_state_b.0002_add_field\n',
469.             out.getvalue()
470.         )
471.         # Single app with dependencies.
472.         out = io.StringIO()
473.         call_command('showmigrations', 'author_app', format='plan', stdout=out)
474.         self.assertEqual(
475.             '[ ]  author_app.0001_initial\n'
476.             '[ ]  book_app.0001_initial\n'
477.             '[ ]  author_app.0002_alter_id\n',
478.             out.getvalue()
479.         )
480.         # Some migrations already applied.
481.         call_command('migrate', 'author_app', '0001', verbosity=0)
482.         out = io.StringIO()
483.         call_command('showmigrations', 'author_app', format='plan', stdout=out)
484.         self.assertEqual(
485.             '[X]  author_app.0001_initial\n'
486.             '[ ]  book_app.0001_initial\n'
487.             '[ ]  author_app.0002_alter_id\n',
488.             out.getvalue()
489.         )
490.         # Cleanup by unmigrating author_app.
491.         call_command('migrate', 'author_app', 'zero', verbosity=0)
492. 
493.     @override_settings(INSTALLED_APPS=[
494.         'migrations.migrations_test_apps.mutate_state_b',
495.         'migrations.migrations_test_apps.alter_fk.author_app',
496.         'migrations.migrations_test_apps.alter_fk.book_app',
497.     ])
498.     def test_showmigrations_plan_multiple_app_labels(self):
499.         """
500.         `showmigrations --plan app_label` output with multiple app_labels.
501.         """
502.         # Multiple apps: author_app depends on book_app; mutate_state_b doesn't
503.         # depend on other apps.
504.         out = io.StringIO()
505.         call_command('showmigrations', 'mutate_state_b', 'author_app', format='plan', stdout=out)
506.         self.assertEqual(
507.             '[ ]  author_app.0001_initial\n'
508.             '[ ]  book_app.0001_initial\n'
509.             '[ ]  author_app.0002_alter_id\n'
510.             '[ ]  mutate_state_b.0001_initial\n'
511.             '[ ]  mutate_state_b.0002_add_field\n',
512.             out.getvalue()
513.         )
514.         # Multiple apps: args order shouldn't matter (the same result is
515.         # expected as above).
516.         out = io.StringIO()
517.         call_command('showmigrations', 'author_app', 'mutate_state_b', format='plan', stdout=out)
518.         self.assertEqual(
519.             '[ ]  author_app.0001_initial\n'
520.             '[ ]  book_app.0001_initial\n'
521.             '[ ]  author_app.0002_alter_id\n'
522.             '[ ]  mutate_state_b.0001_initial\n'
523.             '[ ]  mutate_state_b.0002_add_field\n',
524.             out.getvalue()
525.         )
526. 
527.     @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app'])
528.     def test_showmigrations_plan_app_label_no_migrations(self):
529.         out = io.StringIO()
530.         call_command('showmigrations', 'unmigrated_app', format='plan', stdout=out, no_color=True)
531.         self.assertEqual('(no migrations)\n', out.getvalue())
532. 
533.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
534.     def test_sqlmigrate_forwards(self):
535.         """
536.         sqlmigrate outputs forward looking SQL.
537.         """
538.         out = io.StringIO()
539.         call_command("sqlmigrate", "migrations", "0001", stdout=out)
540.         output = out.getvalue().lower()
541. 
542.         index_tx_start = output.find(connection.ops.start_transaction_sql().lower())
543.         index_op_desc_author = output.find('-- create model author')
544.         index_create_table = output.find('create table')
545.         index_op_desc_tribble = output.find('-- create model tribble')
546.         index_op_desc_unique_together = output.find('-- alter unique_together')
547.         index_tx_end = output.find(connection.ops.end_transaction_sql().lower())
548. 
549.         if connection.features.can_rollback_ddl:
550.             self.assertGreater(index_tx_start, -1, "Transaction start not found")
551.             self.assertGreater(
552.                 index_tx_end, index_op_desc_unique_together,
553.                 "Transaction end not found or found before operation description (unique_together)"
554.             )
555. 
556.         self.assertGreater(
557.             index_op_desc_author, index_tx_start,
558.             "Operation description (author) not found or found before transaction start"
559.         )
560.         self.assertGreater(
561.             index_create_table, index_op_desc_author,
562.             "CREATE TABLE not found or found before operation description (author)"
563.         )
564.         self.assertGreater(
565.             index_op_desc_tribble, index_create_table,
566.             "Operation description (tribble) not found or found before CREATE TABLE (author)"
567.         )
568.         self.assertGreater(
569.             index_op_desc_unique_together, index_op_desc_tribble,
570.             "Operation description (unique_together) not found or found before operation description (tribble)"
571.         )
572. 
573.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations"})
574.     def test_sqlmigrate_backwards(self):
575.         """
576.         sqlmigrate outputs reverse looking SQL.
577.         """
578.         # Cannot generate the reverse SQL unless we've applied the migration.
579.         call_command("migrate", "migrations", verbosity=0)
580. 
581.         out = io.StringIO()
582.         call_command("sqlmigrate", "migrations", "0001", stdout=out, backwards=True)
583.         output = out.getvalue().lower()
584. 
585.         index_tx_start = output.find(connection.ops.start_transaction_sql().lower())
586.         index_op_desc_unique_together = output.find('-- alter unique_together')
587.         index_op_desc_tribble = output.find('-- create model tribble')
588.         index_op_desc_author = output.find('-- create model author')
589.         index_drop_table = output.rfind('drop table')
590.         index_tx_end = output.find(connection.ops.end_transaction_sql().lower())
591. 
592.         if connection.features.can_rollback_ddl:
593.             self.assertGreater(index_tx_start, -1, "Transaction start not found")
594.             self.assertGreater(
595.                 index_tx_end, index_op_desc_unique_together,
596.                 "Transaction end not found or found before DROP TABLE"
597.             )
598.         self.assertGreater(
599.             index_op_desc_unique_together, index_tx_start,
600.             "Operation description (unique_together) not found or found before transaction start"
601.         )
602.         self.assertGreater(
603.             index_op_desc_tribble, index_op_desc_unique_together,
604.             "Operation description (tribble) not found or found before operation description (unique_together)"
605.         )
606.         self.assertGreater(
607.             index_op_desc_author, index_op_desc_tribble,
608.             "Operation description (author) not found or found before operation description (tribble)"
609.         )
610. 
611.         self.assertGreater(
612.             index_drop_table, index_op_desc_author,
613.             "DROP TABLE not found or found before operation description (author)"
614.         )
615. 
616.         # Cleanup by unmigrating everything
617.         call_command("migrate", "migrations", "zero", verbosity=0)
618. 
619.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_non_atomic"})
620.     def test_sqlmigrate_for_non_atomic_migration(self):
621.         """
622.         Transaction wrappers aren't shown for non-atomic migrations.
623.         """
624.         out = io.StringIO()
625.         call_command("sqlmigrate", "migrations", "0001", stdout=out)
626.         output = out.getvalue().lower()
627.         queries = [q.strip() for q in output.splitlines()]
628.         if connection.ops.start_transaction_sql():
629.             self.assertNotIn(connection.ops.start_transaction_sql().lower(), queries)
630.         self.assertNotIn(connection.ops.end_transaction_sql().lower(), queries)
631. 
632.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
633.     def test_sqlmigrate_for_non_transactional_databases(self):
634.         """
635.         Transaction wrappers aren't shown for databases that don't support
636.         transactional DDL.
637.         """
638.         out = io.StringIO()
639.         with mock.patch.object(connection.features, 'can_rollback_ddl', False):
640.             call_command('sqlmigrate', 'migrations', '0001', stdout=out)
641.         output = out.getvalue().lower()
642.         queries = [q.strip() for q in output.splitlines()]
643.         start_transaction_sql = connection.ops.start_transaction_sql()
644.         if start_transaction_sql:
645.             self.assertNotIn(start_transaction_sql.lower(), queries)
646.         self.assertNotIn(connection.ops.end_transaction_sql().lower(), queries)
647. 
648.     @override_settings(
649.         INSTALLED_APPS=[
650.             "migrations.migrations_test_apps.migrated_app",
651.             "migrations.migrations_test_apps.migrated_unapplied_app",
652.             "migrations.migrations_test_apps.unmigrated_app",
653.         ],
654.     )
655.     def test_regression_22823_unmigrated_fk_to_migrated_model(self):
656.         """
657.         Assuming you have 3 apps, `A`, `B`, and `C`, such that:
658. 
659.         * `A` has migrations
660.         * `B` has a migration we want to apply
661.         * `C` has no migrations, but has an FK to `A`
662. 
663.         When we try to migrate "B", an exception occurs because the
664.         "B" was not included in the ProjectState that is used to detect
665.         soft-applied migrations (#22823).
666.         """
667.         call_command("migrate", "migrated_unapplied_app", stdout=io.StringIO())
668. 
669.         # unmigrated_app.SillyModel has a foreign key to 'migrations.Tribble',
670.         # but that model is only defined in a migration, so the global app
671.         # registry never sees it and the reference is left dangling. Remove it
672.         # to avoid problems in subsequent tests.
673.         del apps._pending_operations[('migrations', 'tribble')]
674. 
675.     @override_settings(INSTALLED_APPS=['migrations.migrations_test_apps.unmigrated_app_syncdb'])
676.     def test_migrate_syncdb_deferred_sql_executed_with_schemaeditor(self):
677.         """
678.         For an app without migrations, editor.execute() is used for executing
679.         the syncdb deferred SQL.
680.         """
681.         stdout = io.StringIO()
682.         with mock.patch.object(BaseDatabaseSchemaEditor, 'execute') as execute:
683.             call_command('migrate', run_syncdb=True, verbosity=1, stdout=stdout, no_color=True)
684.             create_table_count = len([call for call in execute.mock_calls if 'CREATE TABLE' in str(call)])
685.             self.assertEqual(create_table_count, 2)
686.             # There's at least one deferred SQL for creating the foreign key
687.             # index.
688.             self.assertGreater(len(execute.mock_calls), 2)
689.         stdout = stdout.getvalue()
690.         self.assertIn('Synchronize unmigrated apps: unmigrated_app_syncdb', stdout)
691.         self.assertIn('Creating tables...', stdout)
692.         table_name = truncate_name('unmigrated_app_syncdb_classroom', connection.ops.max_name_length())
693.         self.assertIn('Creating table %s' % table_name, stdout)
694. 
695.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
696.     def test_migrate_syncdb_app_with_migrations(self):
697.         msg = "Can't use run_syncdb with app 'migrations' as it has migrations."
698.         with self.assertRaisesMessage(CommandError, msg):
699.             call_command('migrate', 'migrations', run_syncdb=True, verbosity=0)
700. 
701.     @override_settings(INSTALLED_APPS=[
702.         'migrations.migrations_test_apps.unmigrated_app_syncdb',
703.         'migrations.migrations_test_apps.unmigrated_app_simple',
704.     ])
705.     def test_migrate_syncdb_app_label(self):
706.         """
707.         Running migrate --run-syncdb with an app_label only creates tables for
708.         the specified app.
709.         """
710.         stdout = io.StringIO()
711.         with mock.patch.object(BaseDatabaseSchemaEditor, 'execute') as execute:
712.             call_command('migrate', 'unmigrated_app_syncdb', run_syncdb=True, stdout=stdout)
713.             create_table_count = len([call for call in execute.mock_calls if 'CREATE TABLE' in str(call)])
714.             self.assertEqual(create_table_count, 2)
715.             self.assertGreater(len(execute.mock_calls), 2)
716.             self.assertIn('Synchronize unmigrated app: unmigrated_app_syncdb', stdout.getvalue())
717. 
718.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed"})
719.     def test_migrate_record_replaced(self):
720.         """
721.         Running a single squashed migration should record all of the original
722.         replaced migrations as run.
723.         """
724.         recorder = MigrationRecorder(connection)
725.         out = io.StringIO()
726.         call_command("migrate", "migrations", verbosity=0)
727.         call_command("showmigrations", "migrations", stdout=out, no_color=True)
728.         self.assertEqual(
729.             'migrations\n'
730.             ' [x] 0001_squashed_0002 (2 squashed migrations)\n',
731.             out.getvalue().lower()
732.         )
733.         applied_migrations = recorder.applied_migrations()
734.         self.assertIn(("migrations", "0001_initial"), applied_migrations)
735.         self.assertIn(("migrations", "0002_second"), applied_migrations)
736.         self.assertIn(("migrations", "0001_squashed_0002"), applied_migrations)
737.         # Rollback changes
738.         call_command("migrate", "migrations", "zero", verbosity=0)
739. 
740.     @override_settings(MIGRATION_MODULES={"migrations": "migrations.test_migrations_squashed"})
741.     def test_migrate_record_squashed(self):
742.         """
743.         Running migrate for a squashed migration should record as run
744.         if all of the replaced migrations have been run (#25231).
745.         """
746.         recorder = MigrationRecorder(connection)
747.         recorder.record_applied("migrations", "0001_initial")
748.         recorder.record_applied("migrations", "0002_second")
749.         out = io.StringIO()
750.         call_command("migrate", "migrations", verbosity=0)
751.         call_command("showmigrations", "migrations", stdout=out, no_color=True)
752.         self.assertEqual(
753.             'migrations\n'
754.             ' [x] 0001_squashed_0002 (2 squashed migrations)\n',
755.             out.getvalue().lower()
756.         )
757.         self.assertIn(
758.             ("migrations", "0001_squashed_0002"),
759.             recorder.applied_migrations()
760.         )
761.         # No changes were actually applied so there is nothing to rollback
762. 
763.     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})
764.     def test_migrate_inconsistent_history(self):
765.         """
766.         Running migrate with some migrations applied before their dependencies
767.         should not be allowed.
768.         """
769.         recorder = MigrationRecorder(connection)
770.         recorder.record_applied("migrations", "0002_second")
771.         msg = "Migration migrations.0002_second is applied before its dependency migrations.0001_initial"
772.         with self.assertRaisesMessage(InconsistentMigrationHistory, msg):
773.             call_command("migrate")
774.         applied_migrations = recorder.applied_migrations()
775.         self.assertNotIn(("migrations", "0001_initial"), applied_migrations)


File: tests/migrations/test_commands.py
Line number range: 778 - 1464
Content:
778. class MakeMigrationsTests(MigrationTestBase):
779.     """
780.     Tests running the makemigrations command.
781.     """
782. 
783.     def setUp(self):
784.         super().setUp()
785.         self._old_models = apps.app_configs['migrations'].models.copy()
786. 
787.     def tearDown(self):
788.         apps.app_configs['migrations'].models = self._old_models
789.         apps.all_models['migrations'] = self._old_models
790.         apps.clear_cache()
791.         super().tearDown()
792. 
793.     def test_files_content(self):
794.         self.assertTableNotExists("migrations_unicodemodel")
795.         apps.register_model('migrations', UnicodeModel)
796.         with self.temporary_migration_module() as migration_dir:
797.             call_command("makemigrations", "migrations", verbosity=0)
798. 
799.             # Check for empty __init__.py file in migrations folder
800.             init_file = os.path.join(migration_dir, "__init__.py")
801.             self.assertTrue(os.path.exists(init_file))
802. 
803.             with open(init_file) as fp:
804.                 content = fp.read()
805.             self.assertEqual(content, '')
806. 
807.             # Check for existing 0001_initial.py file in migration folder
808.             initial_file = os.path.join(migration_dir, "0001_initial.py")
809.             self.assertTrue(os.path.exists(initial_file))
810. 
811.             with open(initial_file, encoding='utf-8') as fp:
812.                 content = fp.read()
813.                 self.assertIn('migrations.CreateModel', content)
814.                 self.assertIn('initial = True', content)
815. 
816.                 self.assertIn('úñí©óðé µóðéø', content)  # Meta.verbose_name
817.                 self.assertIn('úñí©óðé µóðéøß', content)  # Meta.verbose_name_plural
818.                 self.assertIn('ÚÑÍ¢ÓÐÉ', content)  # title.verbose_name
819.                 self.assertIn('“Ðjáñgó”', content)  # title.default
820. 
821.     def test_makemigrations_order(self):
822.         """
823.         makemigrations should recognize number-only migrations (0001.py).
824.         """
825.         module = 'migrations.test_migrations_order'
826.         with self.temporary_migration_module(module=module) as migration_dir:
827.             if hasattr(importlib, 'invalidate_caches'):
828.                 # importlib caches os.listdir() on some platforms like macOS
829.                 # (#23850).
830.                 importlib.invalidate_caches()
831.             call_command('makemigrations', 'migrations', '--empty', '-n', 'a', '-v', '0')
832.             self.assertTrue(os.path.exists(os.path.join(migration_dir, '0002_a.py')))
833. 
834.     def test_makemigrations_empty_connections(self):
835.         empty_connections = ConnectionHandler({'default': {}})
836.         with mock.patch('django.core.management.commands.makemigrations.connections', new=empty_connections):
837.             # with no apps
838.             out = io.StringIO()
839.             call_command('makemigrations', stdout=out)
840.             self.assertIn('No changes detected', out.getvalue())
841.             # with an app
842.             with self.temporary_migration_module() as migration_dir:
843.                 call_command('makemigrations', 'migrations', verbosity=0)
844.                 init_file = os.path.join(migration_dir, '__init__.py')
845.                 self.assertTrue(os.path.exists(init_file))
846. 
847.     @override_settings(INSTALLED_APPS=['migrations', 'migrations2'])
848.     def test_makemigrations_consistency_checks_respect_routers(self):
849.         """
850.         The history consistency checks in makemigrations respect
851.         settings.DATABASE_ROUTERS.
852.         """
853.         def patched_has_table(migration_recorder):
854.             if migration_recorder.connection is connections['other']:
855.                 raise Exception('Other connection')
856.             else:
857.                 return mock.DEFAULT
858. 
859.         self.assertTableNotExists('migrations_unicodemodel')
860.         apps.register_model('migrations', UnicodeModel)
861.         with mock.patch.object(
862.                 MigrationRecorder, 'has_table',
863.                 autospec=True, side_effect=patched_has_table) as has_table:
864.             with self.temporary_migration_module() as migration_dir:
865.                 call_command("makemigrations", "migrations", verbosity=0)
866.                 initial_file = os.path.join(migration_dir, "0001_initial.py")
867.                 self.assertTrue(os.path.exists(initial_file))
868.                 self.assertEqual(has_table.call_count, 1)  # 'default' is checked
869. 
870.                 # Router says not to migrate 'other' so consistency shouldn't
871.                 # be checked.
872.                 with self.settings(DATABASE_ROUTERS=['migrations.routers.TestRouter']):
873.                     call_command('makemigrations', 'migrations', verbosity=0)
874.                 self.assertEqual(has_table.call_count, 2)  # 'default' again
875. 
876.                 # With a router that doesn't prohibit migrating 'other',
877.                 # consistency is checked.
878.                 with self.settings(DATABASE_ROUTERS=['migrations.routers.EmptyRouter']):
879.                     with self.assertRaisesMessage(Exception, 'Other connection'):
880.                         call_command('makemigrations', 'migrations', verbosity=0)
881.                 self.assertEqual(has_table.call_count, 4)  # 'default' and 'other'
882. 
883.                 # With a router that doesn't allow migrating on any database,
884.                 # no consistency checks are made.
885.                 with self.settings(DATABASE_ROUTERS=['migrations.routers.TestRouter']):
886.                     with mock.patch.object(TestRouter, 'allow_migrate', return_value=False) as allow_migrate:
887.                         call_command('makemigrations', 'migrations', verbosity=0)
888.                 allow_migrate.assert_any_call('other', 'migrations', model_name='UnicodeModel')
889.                 # allow_migrate() is called with the correct arguments.
890.                 self.assertGreater(len(allow_migrate.mock_calls), 0)
891.                 for mock_call in allow_migrate.mock_calls:
892.                     _, call_args, call_kwargs = mock_call
893.                     connection_alias, app_name = call_args
894.                     self.assertIn(connection_alias, ['default', 'other'])
895.                     # Raises an error if invalid app_name/model_name occurs.
896.                     apps.get_app_config(app_name).get_model(call_kwargs['model_name'])
897.                 self.assertEqual(has_table.call_count, 4)
898. 
899.     def test_failing_migration(self):
900.         # If a migration fails to serialize, it shouldn't generate an empty file. #21280
901.         apps.register_model('migrations', UnserializableModel)
902. 
903.         with self.temporary_migration_module() as migration_dir:
904.             with self.assertRaisesMessage(ValueError, 'Cannot serialize'):
905.                 call_command("makemigrations", "migrations", verbosity=0)
906. 
907.             initial_file = os.path.join(migration_dir, "0001_initial.py")
908.             self.assertFalse(os.path.exists(initial_file))
909. 
910.     def test_makemigrations_conflict_exit(self):
911.         """
912.         makemigrations exits if it detects a conflict.
913.         """
914.         with self.temporary_migration_module(module="migrations.test_migrations_conflict"):
915.             with self.assertRaises(CommandError) as context:
916.                 call_command("makemigrations")
917.         exception_message = str(context.exception)
918.         self.assertIn(
919.             'Conflicting migrations detected; multiple leaf nodes '
920.             'in the migration graph:',
921.             exception_message
922.         )
923.         self.assertIn('0002_second', exception_message)
924.         self.assertIn('0002_conflicting_second', exception_message)
925.         self.assertIn('in migrations', exception_message)
926.         self.assertIn("To fix them run 'python manage.py makemigrations --merge'", exception_message)
927. 
928.     def test_makemigrations_merge_no_conflict(self):
929.         """
930.         makemigrations exits if in merge mode with no conflicts.
931.         """
932.         out = io.StringIO()
933.         with self.temporary_migration_module(module="migrations.test_migrations"):
934.             call_command("makemigrations", merge=True, stdout=out)
935.         self.assertIn("No conflicts detected to merge.", out.getvalue())
936. 
937.     def test_makemigrations_empty_no_app_specified(self):
938.         """
939.         makemigrations exits if no app is specified with 'empty' mode.
940.         """
941.         msg = 'You must supply at least one app label when using --empty.'
942.         with self.assertRaisesMessage(CommandError, msg):
943.             call_command("makemigrations", empty=True)
944. 
945.     def test_makemigrations_empty_migration(self):
946.         """
947.         makemigrations properly constructs an empty migration.
948.         """
949.         with self.temporary_migration_module() as migration_dir:
950.             call_command("makemigrations", "migrations", empty=True, verbosity=0)
951. 
952.             # Check for existing 0001_initial.py file in migration folder
953.             initial_file = os.path.join(migration_dir, "0001_initial.py")
954.             self.assertTrue(os.path.exists(initial_file))
955. 
956.             with open(initial_file, encoding='utf-8') as fp:
957.                 content = fp.read()
958. 
959.                 # Remove all whitespace to check for empty dependencies and operations
960.                 content = content.replace(' ', '')
961.                 self.assertIn('dependencies=[\n]', content)
962.                 self.assertIn('operations=[\n]', content)
963. 
964.     @override_settings(MIGRATION_MODULES={"migrations": None})
965.     def test_makemigrations_disabled_migrations_for_app(self):
966.         """
967.         makemigrations raises a nice error when migrations are disabled for an
968.         app.
969.         """
970.         msg = (
971.             "Django can't create migrations for app 'migrations' because migrations "
972.             "have been disabled via the MIGRATION_MODULES setting."
973.         )
974.         with self.assertRaisesMessage(ValueError, msg):
975.             call_command("makemigrations", "migrations", empty=True, verbosity=0)
976. 
977.     def test_makemigrations_no_changes_no_apps(self):
978.         """
979.         makemigrations exits when there are no changes and no apps are specified.
980.         """
981.         out = io.StringIO()
982.         call_command("makemigrations", stdout=out)
983.         self.assertIn("No changes detected", out.getvalue())
984. 
985.     def test_makemigrations_no_changes(self):
986.         """
987.         makemigrations exits when there are no changes to an app.
988.         """
989.         out = io.StringIO()
990.         with self.temporary_migration_module(module="migrations.test_migrations_no_changes"):
991.             call_command("makemigrations", "migrations", stdout=out)
992.         self.assertIn("No changes detected in app 'migrations'", out.getvalue())
993. 
994.     def test_makemigrations_no_apps_initial(self):
995.         """
996.         makemigrations should detect initial is needed on empty migration
997.         modules if no app provided.
998.         """
999.         out = io.StringIO()
1000.         with self.temporary_migration_module(module="migrations.test_migrations_empty"):
1001.             call_command("makemigrations", stdout=out)
1002.         self.assertIn("0001_initial.py", out.getvalue())
1003. 
1004.     def test_makemigrations_no_init(self):
1005.         """Migration directories without an __init__.py file are allowed."""
1006.         out = io.StringIO()
1007.         with self.temporary_migration_module(module='migrations.test_migrations_no_init'):
1008.             call_command('makemigrations', stdout=out)
1009.         self.assertIn('0001_initial.py', out.getvalue())
1010. 
1011.     def test_makemigrations_migrations_announce(self):
1012.         """
1013.         makemigrations announces the migration at the default verbosity level.
1014.         """
1015.         out = io.StringIO()
1016.         with self.temporary_migration_module():
1017.             call_command("makemigrations", "migrations", stdout=out)
1018.         self.assertIn("Migrations for 'migrations'", out.getvalue())
1019. 
1020.     def test_makemigrations_no_common_ancestor(self):
1021.         """
1022.         makemigrations fails to merge migrations with no common ancestor.
1023.         """
1024.         with self.assertRaises(ValueError) as context:
1025.             with self.temporary_migration_module(module="migrations.test_migrations_no_ancestor"):
1026.                 call_command("makemigrations", "migrations", merge=True)
1027.         exception_message = str(context.exception)
1028.         self.assertIn("Could not find common ancestor of", exception_message)
1029.         self.assertIn("0002_second", exception_message)
1030.         self.assertIn("0002_conflicting_second", exception_message)
1031. 
1032.     def test_makemigrations_interactive_reject(self):
1033.         """
1034.         makemigrations enters and exits interactive mode properly.
1035.         """
1036.         # Monkeypatch interactive questioner to auto reject
1037.         with mock.patch('builtins.input', mock.Mock(return_value='N')):
1038.             with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1039.                 call_command("makemigrations", "migrations", name="merge", merge=True, interactive=True, verbosity=0)
1040.                 merge_file = os.path.join(migration_dir, '0003_merge.py')
1041.                 self.assertFalse(os.path.exists(merge_file))
1042. 
1043.     def test_makemigrations_interactive_accept(self):
1044.         """
1045.         makemigrations enters interactive mode and merges properly.
1046.         """
1047.         # Monkeypatch interactive questioner to auto accept
1048.         with mock.patch('builtins.input', mock.Mock(return_value='y')):
1049.             out = io.StringIO()
1050.             with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1051.                 call_command("makemigrations", "migrations", name="merge", merge=True, interactive=True, stdout=out)
1052.                 merge_file = os.path.join(migration_dir, '0003_merge.py')
1053.                 self.assertTrue(os.path.exists(merge_file))
1054.             self.assertIn("Created new merge migration", out.getvalue())
1055. 
1056.     @mock.patch('django.db.migrations.utils.datetime')
1057.     def test_makemigrations_default_merge_name(self, mock_datetime):
1058.         mock_datetime.datetime.now.return_value = datetime.datetime(2016, 1, 2, 3, 4)
1059.         with mock.patch('builtins.input', mock.Mock(return_value='y')):
1060.             out = io.StringIO()
1061.             with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1062.                 call_command("makemigrations", "migrations", merge=True, interactive=True, stdout=out)
1063.                 merge_file = os.path.join(migration_dir, '0003_merge_20160102_0304.py')
1064.                 self.assertTrue(os.path.exists(merge_file))
1065.             self.assertIn("Created new merge migration", out.getvalue())
1066. 
1067.     def test_makemigrations_non_interactive_not_null_addition(self):
1068.         """
1069.         Non-interactive makemigrations fails when a default is missing on a
1070.         new not-null field.
1071.         """
1072.         class SillyModel(models.Model):
1073.             silly_field = models.BooleanField(default=False)
1074.             silly_int = models.IntegerField()
1075. 
1076.             class Meta:
1077.                 app_label = "migrations"
1078. 
1079.         out = io.StringIO()
1080.         with self.assertRaises(SystemExit):
1081.             with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
1082.                 call_command("makemigrations", "migrations", interactive=False, stdout=out)
1083. 
1084.     def test_makemigrations_non_interactive_not_null_alteration(self):
1085.         """
1086.         Non-interactive makemigrations fails when a default is missing on a
1087.         field changed to not-null.
1088.         """
1089.         class Author(models.Model):
1090.             name = models.CharField(max_length=255)
1091.             slug = models.SlugField()
1092.             age = models.IntegerField(default=0)
1093. 
1094.             class Meta:
1095.                 app_label = "migrations"
1096. 
1097.         out = io.StringIO()
1098.         with self.temporary_migration_module(module="migrations.test_migrations"):
1099.             call_command("makemigrations", "migrations", interactive=False, stdout=out)
1100.         self.assertIn("Alter field slug on author", out.getvalue())
1101. 
1102.     def test_makemigrations_non_interactive_no_model_rename(self):
1103.         """
1104.         makemigrations adds and removes a possible model rename in
1105.         non-interactive mode.
1106.         """
1107.         class RenamedModel(models.Model):
1108.             silly_field = models.BooleanField(default=False)
1109. 
1110.             class Meta:
1111.                 app_label = "migrations"
1112. 
1113.         out = io.StringIO()
1114.         with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
1115.             call_command("makemigrations", "migrations", interactive=False, stdout=out)
1116.         self.assertIn("Delete model SillyModel", out.getvalue())
1117.         self.assertIn("Create model RenamedModel", out.getvalue())
1118. 
1119.     def test_makemigrations_non_interactive_no_field_rename(self):
1120.         """
1121.         makemigrations adds and removes a possible field rename in
1122.         non-interactive mode.
1123.         """
1124.         class SillyModel(models.Model):
1125.             silly_rename = models.BooleanField(default=False)
1126. 
1127.             class Meta:
1128.                 app_label = "migrations"
1129. 
1130.         out = io.StringIO()
1131.         with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
1132.             call_command("makemigrations", "migrations", interactive=False, stdout=out)
1133.         self.assertIn("Remove field silly_field from sillymodel", out.getvalue())
1134.         self.assertIn("Add field silly_rename to sillymodel", out.getvalue())
1135. 
1136.     def test_makemigrations_handle_merge(self):
1137.         """
1138.         makemigrations properly merges the conflicting migrations with --noinput.
1139.         """
1140.         out = io.StringIO()
1141.         with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1142.             call_command("makemigrations", "migrations", name="merge", merge=True, interactive=False, stdout=out)
1143.             merge_file = os.path.join(migration_dir, '0003_merge.py')
1144.             self.assertTrue(os.path.exists(merge_file))
1145.         output = out.getvalue()
1146.         self.assertIn("Merging migrations", output)
1147.         self.assertIn("Branch 0002_second", output)
1148.         self.assertIn("Branch 0002_conflicting_second", output)
1149.         self.assertIn("Created new merge migration", output)
1150. 
1151.     def test_makemigration_merge_dry_run(self):
1152.         """
1153.         makemigrations respects --dry-run option when fixing migration
1154.         conflicts (#24427).
1155.         """
1156.         out = io.StringIO()
1157.         with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1158.             call_command(
1159.                 "makemigrations", "migrations", name="merge", dry_run=True,
1160.                 merge=True, interactive=False, stdout=out,
1161.             )
1162.             merge_file = os.path.join(migration_dir, '0003_merge.py')
1163.             self.assertFalse(os.path.exists(merge_file))
1164.         output = out.getvalue()
1165.         self.assertIn("Merging migrations", output)
1166.         self.assertIn("Branch 0002_second", output)
1167.         self.assertIn("Branch 0002_conflicting_second", output)
1168.         self.assertNotIn("Created new merge migration", output)
1169. 
1170.     def test_makemigration_merge_dry_run_verbosity_3(self):
1171.         """
1172.         `makemigrations --merge --dry-run` writes the merge migration file to
1173.         stdout with `verbosity == 3` (#24427).
1174.         """
1175.         out = io.StringIO()
1176.         with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1177.             call_command(
1178.                 "makemigrations", "migrations", name="merge", dry_run=True,
1179.                 merge=True, interactive=False, stdout=out, verbosity=3,
1180.             )
1181.             merge_file = os.path.join(migration_dir, '0003_merge.py')
1182.             self.assertFalse(os.path.exists(merge_file))
1183.         output = out.getvalue()
1184.         self.assertIn("Merging migrations", output)
1185.         self.assertIn("Branch 0002_second", output)
1186.         self.assertIn("Branch 0002_conflicting_second", output)
1187.         self.assertNotIn("Created new merge migration", output)
1188. 
1189.         # Additional output caused by verbosity 3
1190.         # The complete merge migration file that would be written
1191.         self.assertIn("class Migration(migrations.Migration):", output)
1192.         self.assertIn("dependencies = [", output)
1193.         self.assertIn("('migrations', '0002_second')", output)
1194.         self.assertIn("('migrations', '0002_conflicting_second')", output)
1195.         self.assertIn("operations = [", output)
1196.         self.assertIn("]", output)
1197. 
1198.     def test_makemigrations_dry_run(self):
1199.         """
1200.         `makemigrations --dry-run` should not ask for defaults.
1201.         """
1202.         class SillyModel(models.Model):
1203.             silly_field = models.BooleanField(default=False)
1204.             silly_date = models.DateField()  # Added field without a default
1205. 
1206.             class Meta:
1207.                 app_label = "migrations"
1208. 
1209.         out = io.StringIO()
1210.         with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
1211.             call_command("makemigrations", "migrations", dry_run=True, stdout=out)
1212.         # Output the expected changes directly, without asking for defaults
1213.         self.assertIn("Add field silly_date to sillymodel", out.getvalue())
1214. 
1215.     def test_makemigrations_dry_run_verbosity_3(self):
1216.         """
1217.         Allow `makemigrations --dry-run` to output the migrations file to
1218.         stdout (with verbosity == 3).
1219.         """
1220.         class SillyModel(models.Model):
1221.             silly_field = models.BooleanField(default=False)
1222.             silly_char = models.CharField(default="")
1223. 
1224.             class Meta:
1225.                 app_label = "migrations"
1226. 
1227.         out = io.StringIO()
1228.         with self.temporary_migration_module(module="migrations.test_migrations_no_default"):
1229.             call_command("makemigrations", "migrations", dry_run=True, stdout=out, verbosity=3)
1230. 
1231.         # Normal --dry-run output
1232.         self.assertIn("- Add field silly_char to sillymodel", out.getvalue())
1233. 
1234.         # Additional output caused by verbosity 3
1235.         # The complete migrations file that would be written
1236.         self.assertIn("class Migration(migrations.Migration):", out.getvalue())
1237.         self.assertIn("dependencies = [", out.getvalue())
1238.         self.assertIn("('migrations', '0001_initial'),", out.getvalue())
1239.         self.assertIn("migrations.AddField(", out.getvalue())
1240.         self.assertIn("model_name='sillymodel',", out.getvalue())
1241.         self.assertIn("name='silly_char',", out.getvalue())
1242. 
1243.     def test_makemigrations_migrations_modules_path_not_exist(self):
1244.         """
1245.         makemigrations creates migrations when specifying a custom location
1246.         for migration files using MIGRATION_MODULES if the custom path
1247.         doesn't already exist.
1248.         """
1249.         class SillyModel(models.Model):
1250.             silly_field = models.BooleanField(default=False)
1251. 
1252.             class Meta:
1253.                 app_label = "migrations"
1254. 
1255.         out = io.StringIO()
1256.         migration_module = "migrations.test_migrations_path_doesnt_exist.foo.bar"
1257.         with self.temporary_migration_module(module=migration_module) as migration_dir:
1258.             call_command("makemigrations", "migrations", stdout=out)
1259. 
1260.             # Migrations file is actually created in the expected path.
1261.             initial_file = os.path.join(migration_dir, "0001_initial.py")
1262.             self.assertTrue(os.path.exists(initial_file))
1263. 
1264.         # Command output indicates the migration is created.
1265.         self.assertIn(" - Create model SillyModel", out.getvalue())
1266. 
1267.     @override_settings(MIGRATION_MODULES={'migrations': 'some.nonexistent.path'})
1268.     def test_makemigrations_migrations_modules_nonexistent_toplevel_package(self):
1269.         msg = (
1270.             'Could not locate an appropriate location to create migrations '
1271.             'package some.nonexistent.path. Make sure the toplevel package '
1272.             'exists and can be imported.'
1273.         )
1274.         with self.assertRaisesMessage(ValueError, msg):
1275.             call_command('makemigrations', 'migrations', empty=True, verbosity=0)
1276. 
1277.     def test_makemigrations_interactive_by_default(self):
1278.         """
1279.         The user is prompted to merge by default if there are conflicts and
1280.         merge is True. Answer negative to differentiate it from behavior when
1281.         --noinput is specified.
1282.         """
1283.         # Monkeypatch interactive questioner to auto reject
1284.         out = io.StringIO()
1285.         with mock.patch('builtins.input', mock.Mock(return_value='N')):
1286.             with self.temporary_migration_module(module="migrations.test_migrations_conflict") as migration_dir:
1287.                 call_command("makemigrations", "migrations", name="merge", merge=True, stdout=out)
1288.                 merge_file = os.path.join(migration_dir, '0003_merge.py')
1289.                 # This will fail if interactive is False by default
1290.                 self.assertFalse(os.path.exists(merge_file))
1291.             self.assertNotIn("Created new merge migration", out.getvalue())
1292. 
1293.     @override_settings(
1294.         INSTALLED_APPS=[
1295.             "migrations",
1296.             "migrations.migrations_test_apps.unspecified_app_with_conflict"])
1297.     def test_makemigrations_unspecified_app_with_conflict_no_merge(self):
1298.         """
1299.         makemigrations does not raise a CommandError when an unspecified app
1300.         has conflicting migrations.
1301.         """
1302.         with self.temporary_migration_module(module="migrations.test_migrations_no_changes"):
1303.             call_command("makemigrations", "migrations", merge=False, verbosity=0)
1304. 
1305.     @override_settings(
1306.         INSTALLED_APPS=[
1307.             "migrations.migrations_test_apps.migrated_app",
1308.             "migrations.migrations_test_apps.unspecified_app_with_conflict"])
1309.     def test_makemigrations_unspecified_app_with_conflict_merge(self):
1310.         """
1311.         makemigrations does not create a merge for an unspecified app even if
1312.         it has conflicting migrations.
1313.         """
1314.         # Monkeypatch interactive questioner to auto accept
1315.         with mock.patch('builtins.input', mock.Mock(return_value='y')):
1316.             out = io.StringIO()
1317.             with self.temporary_migration_module(app_label="migrated_app") as migration_dir:
1318.                 call_command("makemigrations", "migrated_app", name="merge", merge=True, interactive=True, stdout=out)
1319.                 merge_file = os.path.join(migration_dir, '0003_merge.py')
1320.                 self.assertFalse(os.path.exists(merge_file))
1321.             self.assertIn("No conflicts detected to merge.", out.getvalue())
1322. 
1323.     @override_settings(
1324.         INSTALLED_APPS=[
1325.             "migrations.migrations_test_apps.migrated_app",
1326.             "migrations.migrations_test_apps.conflicting_app_with_dependencies"])
1327.     def test_makemigrations_merge_dont_output_dependency_operations(self):
1328.         """
1329.         makemigrations --merge does not output any operations from apps that
1330.         don't belong to a given app.
1331.         """
1332.         # Monkeypatch interactive questioner to auto accept
1333.         with mock.patch('builtins.input', mock.Mock(return_value='N')):
1334.             out = io.StringIO()
1335.             with mock.patch('django.core.management.color.supports_color', lambda *args: False):
1336.                 call_command(
1337.                     "makemigrations", "conflicting_app_with_dependencies",
1338.                     merge=True, interactive=True, stdout=out
1339.                 )
1340.             val = out.getvalue().lower()
1341.             self.assertIn('merging conflicting_app_with_dependencies\n', val)
1342.             self.assertIn(
1343.                 '  branch 0002_conflicting_second\n'
1344.                 '    - create model something\n',
1345.                 val
1346.             )
1347.             self.assertIn(
1348.                 '  branch 0002_second\n'
1349.                 '    - delete model tribble\n'
1350.                 '    - remove field silly_field from author\n'
1351.                 '    - add field rating to author\n'
1352.                 '    - create model book\n',
1353.                 val
1354.             )
1355. 
1356.     def test_makemigrations_with_custom_name(self):
1357.         """
1358.         makemigrations --name generate a custom migration name.
1359.         """
1360.         with self.temporary_migration_module() as migration_dir:
1361. 
1362.             def cmd(migration_count, migration_name, *args):
1363.                 call_command("makemigrations", "migrations", "--verbosity", "0", "--name", migration_name, *args)
1364.                 migration_file = os.path.join(migration_dir, "%s_%s.py" % (migration_count, migration_name))
1365.                 # Check for existing migration file in migration folder
1366.                 self.assertTrue(os.path.exists(migration_file))
1367.                 with open(migration_file, encoding='utf-8') as fp:
1368.                     content = fp.read()
1369.                     content = content.replace(" ", "")
1370.                 return content
1371. 
1372.             # generate an initial migration
1373.             migration_name_0001 = "my_initial_migration"
1374.             content = cmd("0001", migration_name_0001)
1375.             self.assertIn("dependencies=[\n]", content)
1376. 
1377.             # importlib caches os.listdir() on some platforms like macOS
1378.             # (#23850).
1379.             if hasattr(importlib, 'invalidate_caches'):
1380.                 importlib.invalidate_caches()
1381. 
1382.             # generate an empty migration
1383.             migration_name_0002 = "my_custom_migration"
1384.             content = cmd("0002", migration_name_0002, "--empty")
1385.             self.assertIn("dependencies=[\n('migrations','0001_%s'),\n]" % migration_name_0001, content)
1386.             self.assertIn("operations=[\n]", content)
1387. 
1388.     def test_makemigrations_with_invalid_custom_name(self):
1389.         msg = 'The migration name must be a valid Python identifier.'
1390.         with self.assertRaisesMessage(CommandError, msg):
1391.             call_command('makemigrations', 'migrations', '--name', 'invalid name', '--empty')
1392. 
1393.     def test_makemigrations_check(self):
1394.         """
1395.         makemigrations --check should exit with a non-zero status when
1396.         there are changes to an app requiring migrations.
1397.         """
1398.         with self.temporary_migration_module():
1399.             with self.assertRaises(SystemExit):
1400.                 call_command("makemigrations", "--check", "migrations", verbosity=0)
1401. 
1402.         with self.temporary_migration_module(module="migrations.test_migrations_no_changes"):
1403.             call_command("makemigrations", "--check", "migrations", verbosity=0)
1404. 
1405.     def test_makemigrations_migration_path_output(self):
1406.         """
1407.         makemigrations should print the relative paths to the migrations unless
1408.         they are outside of the current tree, in which case the absolute path
1409.         should be shown.
1410.         """
1411.         out = io.StringIO()
1412.         apps.register_model('migrations', UnicodeModel)
1413.         with self.temporary_migration_module() as migration_dir:
1414.             call_command("makemigrations", "migrations", stdout=out)
1415.             self.assertIn(os.path.join(migration_dir, '0001_initial.py'), out.getvalue())
1416. 
1417.     def test_makemigrations_migration_path_output_valueerror(self):
1418.         """
1419.         makemigrations prints the absolute path if os.path.relpath() raises a
1420.         ValueError when it's impossible to obtain a relative path, e.g. on
1421.         Windows if Django is installed on a different drive than where the
1422.         migration files are created.
1423.         """
1424.         out = io.StringIO()
1425.         with self.temporary_migration_module() as migration_dir:
1426.             with mock.patch('os.path.relpath', side_effect=ValueError):
1427.                 call_command('makemigrations', 'migrations', stdout=out)
1428.         self.assertIn(os.path.join(migration_dir, '0001_initial.py'), out.getvalue())
1429. 
1430.     def test_makemigrations_inconsistent_history(self):
1431.         """
1432.         makemigrations should raise InconsistentMigrationHistory exception if
1433.         there are some migrations applied before their dependencies.
1434.         """
1435.         recorder = MigrationRecorder(connection)
1436.         recorder.record_applied('migrations', '0002_second')
1437.         msg = "Migration migrations.0002_second is applied before its dependency migrations.0001_initial"
1438.         with self.temporary_migration_module(module="migrations.test_migrations"):
1439.             with self.assertRaisesMessage(InconsistentMigrationHistory, msg):
1440.                 call_command("makemigrations")
1441. 
1442.     @mock.patch('builtins.input', return_value='1')
1443.     @mock.patch('django.db.migrations.questioner.sys.stdin', mock.MagicMock(encoding=sys.getdefaultencoding()))
1444.     def test_makemigrations_auto_now_add_interactive(self, *args):
1445.         """
1446.         makemigrations prompts the user when adding auto_now_add to an existing
1447.         model.
1448.         """
1449.         class Entry(models.Model):
1450.             title = models.CharField(max_length=255)
1451.             creation_date = models.DateTimeField(auto_now_add=True)
1452. 
1453.             class Meta:
1454.                 app_label = 'migrations'
1455. 
1456.         # Monkeypatch interactive questioner to auto accept
1457.         with mock.patch('django.db.migrations.questioner.sys.stdout', new_callable=io.StringIO) as prompt_stdout:
1458.             out = io.StringIO()
1459.             with self.temporary_migration_module(module='migrations.test_auto_now_add'):
1460.                 call_command('makemigrations', 'migrations', interactive=True, stdout=out)
1461.             output = out.getvalue()
1462.             prompt_output = prompt_stdout.getvalue()
1463.             self.assertIn("You can accept the default 'timezone.now' by pressing 'Enter'", prompt_output)
1464.             self.assertIn("Add field creation_date to entry", output)


File: tests/migrations/test_commands.py
Line number range: 1564 - 1623
Content:
1564. class AppLabelErrorTests(TestCase):
1565.     """
1566.     This class inherits TestCase because MigrationTestBase uses
1567.     `available_apps = ['migrations']` which means that it's the only installed
1568.     app. 'django.contrib.auth' must be in INSTALLED_APPS for some of these
1569.     tests.
1570.     """
1571.     nonexistent_app_error = "No installed app with label 'nonexistent_app'."
1572.     did_you_mean_auth_error = (
1573.         "No installed app with label 'django.contrib.auth'. Did you mean "
1574.         "'auth'?"
1575.     )
1576. 
1577.     def test_makemigrations_nonexistent_app_label(self):
1578.         err = io.StringIO()
1579.         with self.assertRaises(SystemExit):
1580.             call_command('makemigrations', 'nonexistent_app', stderr=err)
1581.         self.assertIn(self.nonexistent_app_error, err.getvalue())
1582. 
1583.     def test_makemigrations_app_name_specified_as_label(self):
1584.         err = io.StringIO()
1585.         with self.assertRaises(SystemExit):
1586.             call_command('makemigrations', 'django.contrib.auth', stderr=err)
1587.         self.assertIn(self.did_you_mean_auth_error, err.getvalue())
1588. 
1589.     def test_migrate_nonexistent_app_label(self):
1590.         with self.assertRaisesMessage(CommandError, self.nonexistent_app_error):
1591.             call_command('migrate', 'nonexistent_app')
1592. 
1593.     def test_migrate_app_name_specified_as_label(self):
1594.         with self.assertRaisesMessage(CommandError, self.did_you_mean_auth_error):
1595.             call_command('migrate', 'django.contrib.auth')
1596. 
1597.     def test_showmigrations_nonexistent_app_label(self):
1598.         err = io.StringIO()
1599.         with self.assertRaises(SystemExit):
1600.             call_command('showmigrations', 'nonexistent_app', stderr=err)
1601.         self.assertIn(self.nonexistent_app_error, err.getvalue())
1602. 
1603.     def test_showmigrations_app_name_specified_as_label(self):
1604.         err = io.StringIO()
1605.         with self.assertRaises(SystemExit):
1606.             call_command('showmigrations', 'django.contrib.auth', stderr=err)
1607.         self.assertIn(self.did_you_mean_auth_error, err.getvalue())
1608. 
1609.     def test_sqlmigrate_nonexistent_app_label(self):
1610.         with self.assertRaisesMessage(CommandError, self.nonexistent_app_error):
1611.             call_command('sqlmigrate', 'nonexistent_app', '0002')
1612. 
1613.     def test_sqlmigrate_app_name_specified_as_label(self):
1614.         with self.assertRaisesMessage(CommandError, self.did_you_mean_auth_error):
1615.             call_command('sqlmigrate', 'django.contrib.auth', '0002')
1616. 
1617.     def test_squashmigrations_nonexistent_app_label(self):
1618.         with self.assertRaisesMessage(CommandError, self.nonexistent_app_error):
1619.             call_command('squashmigrations', 'nonexistent_app', '0002')
1620. 
1621.     def test_squashmigrations_app_name_specified_as_label(self):
1622.         with self.assertRaisesMessage(CommandError, self.did_you_mean_auth_error):
1623.             call_command('squashmigrations', 'django.contrib.auth', '0002')


File: tests/migrations/test_multidb.py
Line number range: 1 - 171
Content:
1. from django.db import connection, migrations, models
2. from django.db.migrations.state import ProjectState
3. from django.test import override_settings
4. 
5. from .test_operations import OperationTestBase
6. 
7. 
8. class AgnosticRouter:
9.     """
10.     A router that doesn't have an opinion regarding migrating.
11.     """
12.     def allow_migrate(self, db, app_label, **hints):
13.         return None
14. 
15. 
16. class MigrateNothingRouter:
17.     """
18.     A router that doesn't allow migrating.
19.     """
20.     def allow_migrate(self, db, app_label, **hints):
21.         return False
22. 
23. 
24. class MigrateEverythingRouter:
25.     """
26.     A router that always allows migrating.
27.     """
28.     def allow_migrate(self, db, app_label, **hints):
29.         return True
30. 
31. 
32. class MigrateWhenFooRouter:
33.     """
34.     A router that allows migrating depending on a hint.
35.     """
36.     def allow_migrate(self, db, app_label, **hints):
37.         return hints.get('foo', False)
38. 
39. 
40. class MultiDBOperationTests(OperationTestBase):
41.     databases = {'default', 'other'}
42. 
43.     def _test_create_model(self, app_label, should_run):
44.         """
45.         CreateModel honors multi-db settings.
46.         """
47.         operation = migrations.CreateModel(
48.             "Pony",
49.             [("id", models.AutoField(primary_key=True))],
50.         )
51.         # Test the state alteration
52.         project_state = ProjectState()
53.         new_state = project_state.clone()
54.         operation.state_forwards(app_label, new_state)
55.         # Test the database alteration
56.         self.assertTableNotExists("%s_pony" % app_label)
57.         with connection.schema_editor() as editor:
58.             operation.database_forwards(app_label, editor, project_state, new_state)
59.         if should_run:
60.             self.assertTableExists("%s_pony" % app_label)
61.         else:
62.             self.assertTableNotExists("%s_pony" % app_label)
63.         # And test reversal
64.         with connection.schema_editor() as editor:
65.             operation.database_backwards(app_label, editor, new_state, project_state)
66.         self.assertTableNotExists("%s_pony" % app_label)
67. 
68.     @override_settings(DATABASE_ROUTERS=[AgnosticRouter()])
69.     def test_create_model(self):
70.         """
71.         Test when router doesn't have an opinion (i.e. CreateModel should run).
72.         """
73.         self._test_create_model("test_mltdb_crmo", should_run=True)
74. 
75.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
76.     def test_create_model2(self):
77.         """
78.         Test when router returns False (i.e. CreateModel shouldn't run).
79.         """
80.         self._test_create_model("test_mltdb_crmo2", should_run=False)
81. 
82.     @override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()])
83.     def test_create_model3(self):
84.         """
85.         Test when router returns True (i.e. CreateModel should run).
86.         """
87.         self._test_create_model("test_mltdb_crmo3", should_run=True)
88. 
89.     def test_create_model4(self):
90.         """
91.         Test multiple routers.
92.         """
93.         with override_settings(DATABASE_ROUTERS=[AgnosticRouter(), AgnosticRouter()]):
94.             self._test_create_model("test_mltdb_crmo4", should_run=True)
95.         with override_settings(DATABASE_ROUTERS=[MigrateNothingRouter(), MigrateEverythingRouter()]):
96.             self._test_create_model("test_mltdb_crmo4", should_run=False)
97.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter(), MigrateNothingRouter()]):
98.             self._test_create_model("test_mltdb_crmo4", should_run=True)
99. 
100.     def _test_run_sql(self, app_label, should_run, hints=None):
101.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):
102.             project_state = self.set_up_test_model(app_label)
103. 
104.         sql = """
105.         INSERT INTO {0}_pony (pink, weight) VALUES (1, 3.55);
106.         INSERT INTO {0}_pony (pink, weight) VALUES (3, 5.0);
107.         """.format(app_label)
108. 
109.         operation = migrations.RunSQL(sql, hints=hints or {})
110.         # Test the state alteration does nothing
111.         new_state = project_state.clone()
112.         operation.state_forwards(app_label, new_state)
113.         self.assertEqual(new_state, project_state)
114.         # Test the database alteration
115.         self.assertEqual(project_state.apps.get_model(app_label, "Pony").objects.count(), 0)
116.         with connection.schema_editor() as editor:
117.             operation.database_forwards(app_label, editor, project_state, new_state)
118.         Pony = project_state.apps.get_model(app_label, "Pony")
119.         if should_run:
120.             self.assertEqual(Pony.objects.count(), 2)
121.         else:
122.             self.assertEqual(Pony.objects.count(), 0)
123. 
124.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
125.     def test_run_sql_migrate_nothing_router(self):
126.         self._test_run_sql("test_mltdb_runsql", should_run=False)
127. 
128.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
129.     def test_run_sql_migrate_foo_router_without_hints(self):
130.         self._test_run_sql("test_mltdb_runsql2", should_run=False)
131. 
132.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
133.     def test_run_sql_migrate_foo_router_with_hints(self):
134.         self._test_run_sql('test_mltdb_runsql3', should_run=True, hints={'foo': True})
135. 
136.     def _test_run_python(self, app_label, should_run, hints=None):
137.         with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):
138.             project_state = self.set_up_test_model(app_label)
139. 
140.         # Create the operation
141.         def inner_method(models, schema_editor):
142.             Pony = models.get_model(app_label, "Pony")
143.             Pony.objects.create(pink=1, weight=3.55)
144.             Pony.objects.create(weight=5)
145. 
146.         operation = migrations.RunPython(inner_method, hints=hints or {})
147.         # Test the state alteration does nothing
148.         new_state = project_state.clone()
149.         operation.state_forwards(app_label, new_state)
150.         self.assertEqual(new_state, project_state)
151.         # Test the database alteration
152.         self.assertEqual(project_state.apps.get_model(app_label, "Pony").objects.count(), 0)
153.         with connection.schema_editor() as editor:
154.             operation.database_forwards(app_label, editor, project_state, new_state)
155.         Pony = project_state.apps.get_model(app_label, "Pony")
156.         if should_run:
157.             self.assertEqual(Pony.objects.count(), 2)
158.         else:
159.             self.assertEqual(Pony.objects.count(), 0)
160. 
161.     @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])
162.     def test_run_python_migrate_nothing_router(self):
163.         self._test_run_python("test_mltdb_runpython", should_run=False)
164. 
165.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
166.     def test_run_python_migrate_foo_router_without_hints(self):
167.         self._test_run_python("test_mltdb_runpython2", should_run=False)
168. 
169.     @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])
170.     def test_run_python_migrate_foo_router_with_hints(self):
171.         self._test_run_python('test_mltdb_runpython3', should_run=True, hints={'foo': True})


File: tests/migrations/test_operations.py
Line number range: 1 - 500
Content:
1. from django.core.exceptions import FieldDoesNotExist
2. from django.db import connection, migrations, models, transaction
3. from django.db.migrations.migration import Migration
4. from django.db.migrations.operations import CreateModel
5. from django.db.migrations.operations.fields import FieldOperation
6. from django.db.migrations.state import ModelState, ProjectState
7. from django.db.models.fields import NOT_PROVIDED
8. from django.db.transaction import atomic
9. from django.db.utils import IntegrityError
10. from django.test import SimpleTestCase, override_settings, skipUnlessDBFeature
11. 
12. from .models import FoodManager, FoodQuerySet, UnicodeModel
13. from .test_base import MigrationTestBase
14. 
15. 
16. class Mixin:
17.     pass
18. 
19. 
20. class OperationTestBase(MigrationTestBase):
21.     """
22.     Common functions to help test operations.
23.     """
24. 
25.     @classmethod
26.     def setUpClass(cls):
27.         super().setUpClass()
28.         cls._initial_table_names = frozenset(connection.introspection.table_names())
29. 
30.     def tearDown(self):
31.         self.cleanup_test_tables()
32.         super().tearDown()
33. 
34.     def cleanup_test_tables(self):
35.         table_names = frozenset(connection.introspection.table_names()) - self._initial_table_names
36.         with connection.schema_editor() as editor:
37.             with connection.constraint_checks_disabled():
38.                 for table_name in table_names:
39.                     editor.execute(editor.sql_delete_table % {
40.                         'table': editor.quote_name(table_name),
41.                     })
42. 
43.     def apply_operations(self, app_label, project_state, operations, atomic=True):
44.         migration = Migration('name', app_label)
45.         migration.operations = operations
46.         with connection.schema_editor(atomic=atomic) as editor:
47.             return migration.apply(project_state, editor)
48. 
49.     def unapply_operations(self, app_label, project_state, operations, atomic=True):
50.         migration = Migration('name', app_label)
51.         migration.operations = operations
52.         with connection.schema_editor(atomic=atomic) as editor:
53.             return migration.unapply(project_state, editor)
54. 
55.     def make_test_state(self, app_label, operation, **kwargs):
56.         """
57.         Makes a test state using set_up_test_model and returns the
58.         original state and the state after the migration is applied.
59.         """
60.         project_state = self.set_up_test_model(app_label, **kwargs)
61.         new_state = project_state.clone()
62.         operation.state_forwards(app_label, new_state)
63.         return project_state, new_state
64. 
65.     def set_up_test_model(
66.             self, app_label, second_model=False, third_model=False, index=False, multicol_index=False,
67.             related_model=False, mti_model=False, proxy_model=False, manager_model=False,
68.             unique_together=False, options=False, db_table=None, index_together=False, constraints=None):
69.         """
70.         Creates a test model state and database table.
71.         """
72.         # Make the "current" state
73.         model_options = {
74.             "swappable": "TEST_SWAP_MODEL",
75.             "index_together": [["weight", "pink"]] if index_together else [],
76.             "unique_together": [["pink", "weight"]] if unique_together else [],
77.         }
78.         if options:
79.             model_options["permissions"] = [("can_groom", "Can groom")]
80.         if db_table:
81.             model_options["db_table"] = db_table
82.         operations = [migrations.CreateModel(
83.             "Pony",
84.             [
85.                 ("id", models.AutoField(primary_key=True)),
86.                 ("pink", models.IntegerField(default=3)),
87.                 ("weight", models.FloatField()),
88.             ],
89.             options=model_options,
90.         )]
91.         if index:
92.             operations.append(migrations.AddIndex(
93.                 "Pony",
94.                 models.Index(fields=["pink"], name="pony_pink_idx")
95.             ))
96.         if multicol_index:
97.             operations.append(migrations.AddIndex(
98.                 "Pony",
99.                 models.Index(fields=["pink", "weight"], name="pony_test_idx")
100.             ))
101.         if constraints:
102.             for constraint in constraints:
103.                 operations.append(migrations.AddConstraint(
104.                     "Pony",
105.                     constraint,
106.                 ))
107.         if second_model:
108.             operations.append(migrations.CreateModel(
109.                 "Stable",
110.                 [
111.                     ("id", models.AutoField(primary_key=True)),
112.                 ]
113.             ))
114.         if third_model:
115.             operations.append(migrations.CreateModel(
116.                 "Van",
117.                 [
118.                     ("id", models.AutoField(primary_key=True)),
119.                 ]
120.             ))
121.         if related_model:
122.             operations.append(migrations.CreateModel(
123.                 "Rider",
124.                 [
125.                     ("id", models.AutoField(primary_key=True)),
126.                     ("pony", models.ForeignKey("Pony", models.CASCADE)),
127.                     ("friend", models.ForeignKey("self", models.CASCADE))
128.                 ],
129.             ))
130.         if mti_model:
131.             operations.append(migrations.CreateModel(
132.                 "ShetlandPony",
133.                 fields=[
134.                     ('pony_ptr', models.OneToOneField(
135.                         'Pony',
136.                         models.CASCADE,
137.                         auto_created=True,
138.                         parent_link=True,
139.                         primary_key=True,
140.                         to_field='id',
141.                         serialize=False,
142.                     )),
143.                     ("cuteness", models.IntegerField(default=1)),
144.                 ],
145.                 bases=['%s.Pony' % app_label],
146.             ))
147.         if proxy_model:
148.             operations.append(migrations.CreateModel(
149.                 "ProxyPony",
150.                 fields=[],
151.                 options={"proxy": True},
152.                 bases=['%s.Pony' % app_label],
153.             ))
154.         if manager_model:
155.             operations.append(migrations.CreateModel(
156.                 "Food",
157.                 fields=[
158.                     ("id", models.AutoField(primary_key=True)),
159.                 ],
160.                 managers=[
161.                     ("food_qs", FoodQuerySet.as_manager()),
162.                     ("food_mgr", FoodManager("a", "b")),
163.                     ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
164.                 ]
165.             ))
166. 
167.         return self.apply_operations(app_label, ProjectState(), operations)
168. 
169. 
170. class OperationTests(OperationTestBase):
171.     """
172.     Tests running the operations and making sure they do what they say they do.
173.     Each test looks at their state changing, and then their database operation -
174.     both forwards and backwards.
175.     """
176. 
177.     def test_create_model(self):
178.         """
179.         Tests the CreateModel operation.
180.         Most other tests use this operation as part of setup, so check failures here first.
181.         """
182.         operation = migrations.CreateModel(
183.             "Pony",
184.             [
185.                 ("id", models.AutoField(primary_key=True)),
186.                 ("pink", models.IntegerField(default=1)),
187.             ],
188.         )
189.         self.assertEqual(operation.describe(), "Create model Pony")
190.         # Test the state alteration
191.         project_state = ProjectState()
192.         new_state = project_state.clone()
193.         operation.state_forwards("test_crmo", new_state)
194.         self.assertEqual(new_state.models["test_crmo", "pony"].name, "Pony")
195.         self.assertEqual(len(new_state.models["test_crmo", "pony"].fields), 2)
196.         # Test the database alteration
197.         self.assertTableNotExists("test_crmo_pony")
198.         with connection.schema_editor() as editor:
199.             operation.database_forwards("test_crmo", editor, project_state, new_state)
200.         self.assertTableExists("test_crmo_pony")
201.         # And test reversal
202.         with connection.schema_editor() as editor:
203.             operation.database_backwards("test_crmo", editor, new_state, project_state)
204.         self.assertTableNotExists("test_crmo_pony")
205.         # And deconstruction
206.         definition = operation.deconstruct()
207.         self.assertEqual(definition[0], "CreateModel")
208.         self.assertEqual(definition[1], [])
209.         self.assertEqual(sorted(definition[2]), ["fields", "name"])
210.         # And default manager not in set
211.         operation = migrations.CreateModel("Foo", fields=[], managers=[("objects", models.Manager())])
212.         definition = operation.deconstruct()
213.         self.assertNotIn('managers', definition[2])
214. 
215.     def test_create_model_with_duplicate_field_name(self):
216.         with self.assertRaisesMessage(ValueError, 'Found duplicate value pink in CreateModel fields argument.'):
217.             migrations.CreateModel(
218.                 "Pony",
219.                 [
220.                     ("id", models.AutoField(primary_key=True)),
221.                     ("pink", models.TextField()),
222.                     ("pink", models.IntegerField(default=1)),
223.                 ],
224.             )
225. 
226.     def test_create_model_with_duplicate_base(self):
227.         message = 'Found duplicate value test_crmo.pony in CreateModel bases argument.'
228.         with self.assertRaisesMessage(ValueError, message):
229.             migrations.CreateModel(
230.                 "Pony",
231.                 fields=[],
232.                 bases=("test_crmo.Pony", "test_crmo.Pony",),
233.             )
234.         with self.assertRaisesMessage(ValueError, message):
235.             migrations.CreateModel(
236.                 "Pony",
237.                 fields=[],
238.                 bases=("test_crmo.Pony", "test_crmo.pony",),
239.             )
240.         message = 'Found duplicate value migrations.unicodemodel in CreateModel bases argument.'
241.         with self.assertRaisesMessage(ValueError, message):
242.             migrations.CreateModel(
243.                 "Pony",
244.                 fields=[],
245.                 bases=(UnicodeModel, UnicodeModel,),
246.             )
247.         with self.assertRaisesMessage(ValueError, message):
248.             migrations.CreateModel(
249.                 "Pony",
250.                 fields=[],
251.                 bases=(UnicodeModel, 'migrations.unicodemodel',),
252.             )
253.         with self.assertRaisesMessage(ValueError, message):
254.             migrations.CreateModel(
255.                 "Pony",
256.                 fields=[],
257.                 bases=(UnicodeModel, 'migrations.UnicodeModel',),
258.             )
259.         message = "Found duplicate value <class 'django.db.models.base.Model'> in CreateModel bases argument."
260.         with self.assertRaisesMessage(ValueError, message):
261.             migrations.CreateModel(
262.                 "Pony",
263.                 fields=[],
264.                 bases=(models.Model, models.Model,),
265.             )
266.         message = "Found duplicate value <class 'migrations.test_operations.Mixin'> in CreateModel bases argument."
267.         with self.assertRaisesMessage(ValueError, message):
268.             migrations.CreateModel(
269.                 "Pony",
270.                 fields=[],
271.                 bases=(Mixin, Mixin,),
272.             )
273. 
274.     def test_create_model_with_duplicate_manager_name(self):
275.         with self.assertRaisesMessage(ValueError, 'Found duplicate value objects in CreateModel managers argument.'):
276.             migrations.CreateModel(
277.                 "Pony",
278.                 fields=[],
279.                 managers=[
280.                     ("objects", models.Manager()),
281.                     ("objects", models.Manager()),
282.                 ],
283.             )
284. 
285.     def test_create_model_with_unique_after(self):
286.         """
287.         Tests the CreateModel operation directly followed by an
288.         AlterUniqueTogether (bug #22844 - sqlite remake issues)
289.         """
290.         operation1 = migrations.CreateModel(
291.             "Pony",
292.             [
293.                 ("id", models.AutoField(primary_key=True)),
294.                 ("pink", models.IntegerField(default=1)),
295.             ],
296.         )
297.         operation2 = migrations.CreateModel(
298.             "Rider",
299.             [
300.                 ("id", models.AutoField(primary_key=True)),
301.                 ("number", models.IntegerField(default=1)),
302.                 ("pony", models.ForeignKey("test_crmoua.Pony", models.CASCADE)),
303.             ],
304.         )
305.         operation3 = migrations.AlterUniqueTogether(
306.             "Rider",
307.             [
308.                 ("number", "pony"),
309.             ],
310.         )
311.         # Test the database alteration
312.         project_state = ProjectState()
313.         self.assertTableNotExists("test_crmoua_pony")
314.         self.assertTableNotExists("test_crmoua_rider")
315.         with connection.schema_editor() as editor:
316.             new_state = project_state.clone()
317.             operation1.state_forwards("test_crmoua", new_state)
318.             operation1.database_forwards("test_crmoua", editor, project_state, new_state)
319.             project_state, new_state = new_state, new_state.clone()
320.             operation2.state_forwards("test_crmoua", new_state)
321.             operation2.database_forwards("test_crmoua", editor, project_state, new_state)
322.             project_state, new_state = new_state, new_state.clone()
323.             operation3.state_forwards("test_crmoua", new_state)
324.             operation3.database_forwards("test_crmoua", editor, project_state, new_state)
325.         self.assertTableExists("test_crmoua_pony")
326.         self.assertTableExists("test_crmoua_rider")
327. 
328.     def test_create_model_m2m(self):
329.         """
330.         Test the creation of a model with a ManyToMany field and the
331.         auto-created "through" model.
332.         """
333.         project_state = self.set_up_test_model("test_crmomm")
334.         operation = migrations.CreateModel(
335.             "Stable",
336.             [
337.                 ("id", models.AutoField(primary_key=True)),
338.                 ("ponies", models.ManyToManyField("Pony", related_name="stables"))
339.             ]
340.         )
341.         # Test the state alteration
342.         new_state = project_state.clone()
343.         operation.state_forwards("test_crmomm", new_state)
344.         # Test the database alteration
345.         self.assertTableNotExists("test_crmomm_stable_ponies")
346.         with connection.schema_editor() as editor:
347.             operation.database_forwards("test_crmomm", editor, project_state, new_state)
348.         self.assertTableExists("test_crmomm_stable")
349.         self.assertTableExists("test_crmomm_stable_ponies")
350.         self.assertColumnNotExists("test_crmomm_stable", "ponies")
351.         # Make sure the M2M field actually works
352.         with atomic():
353.             Pony = new_state.apps.get_model("test_crmomm", "Pony")
354.             Stable = new_state.apps.get_model("test_crmomm", "Stable")
355.             stable = Stable.objects.create()
356.             p1 = Pony.objects.create(pink=False, weight=4.55)
357.             p2 = Pony.objects.create(pink=True, weight=5.43)
358.             stable.ponies.add(p1, p2)
359.             self.assertEqual(stable.ponies.count(), 2)
360.             stable.ponies.all().delete()
361.         # And test reversal
362.         with connection.schema_editor() as editor:
363.             operation.database_backwards("test_crmomm", editor, new_state, project_state)
364.         self.assertTableNotExists("test_crmomm_stable")
365.         self.assertTableNotExists("test_crmomm_stable_ponies")
366. 
367.     def test_create_model_inheritance(self):
368.         """
369.         Tests the CreateModel operation on a multi-table inheritance setup.
370.         """
371.         project_state = self.set_up_test_model("test_crmoih")
372.         # Test the state alteration
373.         operation = migrations.CreateModel(
374.             "ShetlandPony",
375.             [
376.                 ('pony_ptr', models.OneToOneField(
377.                     'test_crmoih.Pony',
378.                     models.CASCADE,
379.                     auto_created=True,
380.                     primary_key=True,
381.                     to_field='id',
382.                     serialize=False,
383.                 )),
384.                 ("cuteness", models.IntegerField(default=1)),
385.             ],
386.         )
387.         new_state = project_state.clone()
388.         operation.state_forwards("test_crmoih", new_state)
389.         self.assertIn(("test_crmoih", "shetlandpony"), new_state.models)
390.         # Test the database alteration
391.         self.assertTableNotExists("test_crmoih_shetlandpony")
392.         with connection.schema_editor() as editor:
393.             operation.database_forwards("test_crmoih", editor, project_state, new_state)
394.         self.assertTableExists("test_crmoih_shetlandpony")
395.         # And test reversal
396.         with connection.schema_editor() as editor:
397.             operation.database_backwards("test_crmoih", editor, new_state, project_state)
398.         self.assertTableNotExists("test_crmoih_shetlandpony")
399. 
400.     def test_create_proxy_model(self):
401.         """
402.         CreateModel ignores proxy models.
403.         """
404.         project_state = self.set_up_test_model("test_crprmo")
405.         # Test the state alteration
406.         operation = migrations.CreateModel(
407.             "ProxyPony",
408.             [],
409.             options={"proxy": True},
410.             bases=("test_crprmo.Pony",),
411.         )
412.         self.assertEqual(operation.describe(), "Create proxy model ProxyPony")
413.         new_state = project_state.clone()
414.         operation.state_forwards("test_crprmo", new_state)
415.         self.assertIn(("test_crprmo", "proxypony"), new_state.models)
416.         # Test the database alteration
417.         self.assertTableNotExists("test_crprmo_proxypony")
418.         self.assertTableExists("test_crprmo_pony")
419.         with connection.schema_editor() as editor:
420.             operation.database_forwards("test_crprmo", editor, project_state, new_state)
421.         self.assertTableNotExists("test_crprmo_proxypony")
422.         self.assertTableExists("test_crprmo_pony")
423.         # And test reversal
424.         with connection.schema_editor() as editor:
425.             operation.database_backwards("test_crprmo", editor, new_state, project_state)
426.         self.assertTableNotExists("test_crprmo_proxypony")
427.         self.assertTableExists("test_crprmo_pony")
428.         # And deconstruction
429.         definition = operation.deconstruct()
430.         self.assertEqual(definition[0], "CreateModel")
431.         self.assertEqual(definition[1], [])
432.         self.assertEqual(sorted(definition[2]), ["bases", "fields", "name", "options"])
433. 
434.     def test_create_unmanaged_model(self):
435.         """
436.         CreateModel ignores unmanaged models.
437.         """
438.         project_state = self.set_up_test_model("test_crummo")
439.         # Test the state alteration
440.         operation = migrations.CreateModel(
441.             "UnmanagedPony",
442.             [],
443.             options={"proxy": True},
444.             bases=("test_crummo.Pony",),
445.         )
446.         self.assertEqual(operation.describe(), "Create proxy model UnmanagedPony")
447.         new_state = project_state.clone()
448.         operation.state_forwards("test_crummo", new_state)
449.         self.assertIn(("test_crummo", "unmanagedpony"), new_state.models)
450.         # Test the database alteration
451.         self.assertTableNotExists("test_crummo_unmanagedpony")
452.         self.assertTableExists("test_crummo_pony")
453.         with connection.schema_editor() as editor:
454.             operation.database_forwards("test_crummo", editor, project_state, new_state)
455.         self.assertTableNotExists("test_crummo_unmanagedpony")
456.         self.assertTableExists("test_crummo_pony")
457.         # And test reversal
458.         with connection.schema_editor() as editor:
459.             operation.database_backwards("test_crummo", editor, new_state, project_state)
460.         self.assertTableNotExists("test_crummo_unmanagedpony")
461.         self.assertTableExists("test_crummo_pony")
462. 
463.     @skipUnlessDBFeature('supports_table_check_constraints')
464.     def test_create_model_with_constraint(self):
465.         where = models.Q(pink__gt=2)
466.         check_constraint = models.CheckConstraint(check=where, name='test_constraint_pony_pink_gt_2')
467.         operation = migrations.CreateModel(
468.             "Pony",
469.             [
470.                 ("id", models.AutoField(primary_key=True)),
471.                 ("pink", models.IntegerField(default=3)),
472.             ],
473.             options={'constraints': [check_constraint]},
474.         )
475. 
476.         # Test the state alteration
477.         project_state = ProjectState()
478.         new_state = project_state.clone()
479.         operation.state_forwards("test_crmo", new_state)
480.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
481. 
482.         # Test database alteration
483.         self.assertTableNotExists("test_crmo_pony")
484.         with connection.schema_editor() as editor:
485.             operation.database_forwards("test_crmo", editor, project_state, new_state)
486.         self.assertTableExists("test_crmo_pony")
487.         with connection.cursor() as cursor:
488.             with self.assertRaises(IntegrityError):
489.                 cursor.execute("INSERT INTO test_crmo_pony (id, pink) VALUES (1, 1)")
490. 
491.         # Test reversal
492.         with connection.schema_editor() as editor:
493.             operation.database_backwards("test_crmo", editor, new_state, project_state)
494.         self.assertTableNotExists("test_crmo_pony")
495. 
496.         # Test deconstruction
497.         definition = operation.deconstruct()
498.         self.assertEqual(definition[0], "CreateModel")
499.         self.assertEqual(definition[1], [])
500.         self.assertEqual(definition[2]['options']['constraints'], [check_constraint])


File: tests/migrations/test_operations.py
Line number range: 170 - 2865
Content:
170. class OperationTests(OperationTestBase):
171.     """
172.     Tests running the operations and making sure they do what they say they do.
173.     Each test looks at their state changing, and then their database operation -
174.     both forwards and backwards.
175.     """
176. 
177.     def test_create_model(self):
178.         """
179.         Tests the CreateModel operation.
180.         Most other tests use this operation as part of setup, so check failures here first.
181.         """
182.         operation = migrations.CreateModel(
183.             "Pony",
184.             [
185.                 ("id", models.AutoField(primary_key=True)),
186.                 ("pink", models.IntegerField(default=1)),
187.             ],
188.         )
189.         self.assertEqual(operation.describe(), "Create model Pony")
190.         # Test the state alteration
191.         project_state = ProjectState()
192.         new_state = project_state.clone()
193.         operation.state_forwards("test_crmo", new_state)
194.         self.assertEqual(new_state.models["test_crmo", "pony"].name, "Pony")
195.         self.assertEqual(len(new_state.models["test_crmo", "pony"].fields), 2)
196.         # Test the database alteration
197.         self.assertTableNotExists("test_crmo_pony")
198.         with connection.schema_editor() as editor:
199.             operation.database_forwards("test_crmo", editor, project_state, new_state)
200.         self.assertTableExists("test_crmo_pony")
201.         # And test reversal
202.         with connection.schema_editor() as editor:
203.             operation.database_backwards("test_crmo", editor, new_state, project_state)
204.         self.assertTableNotExists("test_crmo_pony")
205.         # And deconstruction
206.         definition = operation.deconstruct()
207.         self.assertEqual(definition[0], "CreateModel")
208.         self.assertEqual(definition[1], [])
209.         self.assertEqual(sorted(definition[2]), ["fields", "name"])
210.         # And default manager not in set
211.         operation = migrations.CreateModel("Foo", fields=[], managers=[("objects", models.Manager())])
212.         definition = operation.deconstruct()
213.         self.assertNotIn('managers', definition[2])
214. 
215.     def test_create_model_with_duplicate_field_name(self):
216.         with self.assertRaisesMessage(ValueError, 'Found duplicate value pink in CreateModel fields argument.'):
217.             migrations.CreateModel(
218.                 "Pony",
219.                 [
220.                     ("id", models.AutoField(primary_key=True)),
221.                     ("pink", models.TextField()),
222.                     ("pink", models.IntegerField(default=1)),
223.                 ],
224.             )
225. 
226.     def test_create_model_with_duplicate_base(self):
227.         message = 'Found duplicate value test_crmo.pony in CreateModel bases argument.'
228.         with self.assertRaisesMessage(ValueError, message):
229.             migrations.CreateModel(
230.                 "Pony",
231.                 fields=[],
232.                 bases=("test_crmo.Pony", "test_crmo.Pony",),
233.             )
234.         with self.assertRaisesMessage(ValueError, message):
235.             migrations.CreateModel(
236.                 "Pony",
237.                 fields=[],
238.                 bases=("test_crmo.Pony", "test_crmo.pony",),
239.             )
240.         message = 'Found duplicate value migrations.unicodemodel in CreateModel bases argument.'
241.         with self.assertRaisesMessage(ValueError, message):
242.             migrations.CreateModel(
243.                 "Pony",
244.                 fields=[],
245.                 bases=(UnicodeModel, UnicodeModel,),
246.             )
247.         with self.assertRaisesMessage(ValueError, message):
248.             migrations.CreateModel(
249.                 "Pony",
250.                 fields=[],
251.                 bases=(UnicodeModel, 'migrations.unicodemodel',),
252.             )
253.         with self.assertRaisesMessage(ValueError, message):
254.             migrations.CreateModel(
255.                 "Pony",
256.                 fields=[],
257.                 bases=(UnicodeModel, 'migrations.UnicodeModel',),
258.             )
259.         message = "Found duplicate value <class 'django.db.models.base.Model'> in CreateModel bases argument."
260.         with self.assertRaisesMessage(ValueError, message):
261.             migrations.CreateModel(
262.                 "Pony",
263.                 fields=[],
264.                 bases=(models.Model, models.Model,),
265.             )
266.         message = "Found duplicate value <class 'migrations.test_operations.Mixin'> in CreateModel bases argument."
267.         with self.assertRaisesMessage(ValueError, message):
268.             migrations.CreateModel(
269.                 "Pony",
270.                 fields=[],
271.                 bases=(Mixin, Mixin,),
272.             )
273. 
274.     def test_create_model_with_duplicate_manager_name(self):
275.         with self.assertRaisesMessage(ValueError, 'Found duplicate value objects in CreateModel managers argument.'):
276.             migrations.CreateModel(
277.                 "Pony",
278.                 fields=[],
279.                 managers=[
280.                     ("objects", models.Manager()),
281.                     ("objects", models.Manager()),
282.                 ],
283.             )
284. 
285.     def test_create_model_with_unique_after(self):
286.         """
287.         Tests the CreateModel operation directly followed by an
288.         AlterUniqueTogether (bug #22844 - sqlite remake issues)
289.         """
290.         operation1 = migrations.CreateModel(
291.             "Pony",
292.             [
293.                 ("id", models.AutoField(primary_key=True)),
294.                 ("pink", models.IntegerField(default=1)),
295.             ],
296.         )
297.         operation2 = migrations.CreateModel(
298.             "Rider",
299.             [
300.                 ("id", models.AutoField(primary_key=True)),
301.                 ("number", models.IntegerField(default=1)),
302.                 ("pony", models.ForeignKey("test_crmoua.Pony", models.CASCADE)),
303.             ],
304.         )
305.         operation3 = migrations.AlterUniqueTogether(
306.             "Rider",
307.             [
308.                 ("number", "pony"),
309.             ],
310.         )
311.         # Test the database alteration
312.         project_state = ProjectState()
313.         self.assertTableNotExists("test_crmoua_pony")
314.         self.assertTableNotExists("test_crmoua_rider")
315.         with connection.schema_editor() as editor:
316.             new_state = project_state.clone()
317.             operation1.state_forwards("test_crmoua", new_state)
318.             operation1.database_forwards("test_crmoua", editor, project_state, new_state)
319.             project_state, new_state = new_state, new_state.clone()
320.             operation2.state_forwards("test_crmoua", new_state)
321.             operation2.database_forwards("test_crmoua", editor, project_state, new_state)
322.             project_state, new_state = new_state, new_state.clone()
323.             operation3.state_forwards("test_crmoua", new_state)
324.             operation3.database_forwards("test_crmoua", editor, project_state, new_state)
325.         self.assertTableExists("test_crmoua_pony")
326.         self.assertTableExists("test_crmoua_rider")
327. 
328.     def test_create_model_m2m(self):
329.         """
330.         Test the creation of a model with a ManyToMany field and the
331.         auto-created "through" model.
332.         """
333.         project_state = self.set_up_test_model("test_crmomm")
334.         operation = migrations.CreateModel(
335.             "Stable",
336.             [
337.                 ("id", models.AutoField(primary_key=True)),
338.                 ("ponies", models.ManyToManyField("Pony", related_name="stables"))
339.             ]
340.         )
341.         # Test the state alteration
342.         new_state = project_state.clone()
343.         operation.state_forwards("test_crmomm", new_state)
344.         # Test the database alteration
345.         self.assertTableNotExists("test_crmomm_stable_ponies")
346.         with connection.schema_editor() as editor:
347.             operation.database_forwards("test_crmomm", editor, project_state, new_state)
348.         self.assertTableExists("test_crmomm_stable")
349.         self.assertTableExists("test_crmomm_stable_ponies")
350.         self.assertColumnNotExists("test_crmomm_stable", "ponies")
351.         # Make sure the M2M field actually works
352.         with atomic():
353.             Pony = new_state.apps.get_model("test_crmomm", "Pony")
354.             Stable = new_state.apps.get_model("test_crmomm", "Stable")
355.             stable = Stable.objects.create()
356.             p1 = Pony.objects.create(pink=False, weight=4.55)
357.             p2 = Pony.objects.create(pink=True, weight=5.43)
358.             stable.ponies.add(p1, p2)
359.             self.assertEqual(stable.ponies.count(), 2)
360.             stable.ponies.all().delete()
361.         # And test reversal
362.         with connection.schema_editor() as editor:
363.             operation.database_backwards("test_crmomm", editor, new_state, project_state)
364.         self.assertTableNotExists("test_crmomm_stable")
365.         self.assertTableNotExists("test_crmomm_stable_ponies")
366. 
367.     def test_create_model_inheritance(self):
368.         """
369.         Tests the CreateModel operation on a multi-table inheritance setup.
370.         """
371.         project_state = self.set_up_test_model("test_crmoih")
372.         # Test the state alteration
373.         operation = migrations.CreateModel(
374.             "ShetlandPony",
375.             [
376.                 ('pony_ptr', models.OneToOneField(
377.                     'test_crmoih.Pony',
378.                     models.CASCADE,
379.                     auto_created=True,
380.                     primary_key=True,
381.                     to_field='id',
382.                     serialize=False,
383.                 )),
384.                 ("cuteness", models.IntegerField(default=1)),
385.             ],
386.         )
387.         new_state = project_state.clone()
388.         operation.state_forwards("test_crmoih", new_state)
389.         self.assertIn(("test_crmoih", "shetlandpony"), new_state.models)
390.         # Test the database alteration
391.         self.assertTableNotExists("test_crmoih_shetlandpony")
392.         with connection.schema_editor() as editor:
393.             operation.database_forwards("test_crmoih", editor, project_state, new_state)
394.         self.assertTableExists("test_crmoih_shetlandpony")
395.         # And test reversal
396.         with connection.schema_editor() as editor:
397.             operation.database_backwards("test_crmoih", editor, new_state, project_state)
398.         self.assertTableNotExists("test_crmoih_shetlandpony")
399. 
400.     def test_create_proxy_model(self):
401.         """
402.         CreateModel ignores proxy models.
403.         """
404.         project_state = self.set_up_test_model("test_crprmo")
405.         # Test the state alteration
406.         operation = migrations.CreateModel(
407.             "ProxyPony",
408.             [],
409.             options={"proxy": True},
410.             bases=("test_crprmo.Pony",),
411.         )
412.         self.assertEqual(operation.describe(), "Create proxy model ProxyPony")
413.         new_state = project_state.clone()
414.         operation.state_forwards("test_crprmo", new_state)
415.         self.assertIn(("test_crprmo", "proxypony"), new_state.models)
416.         # Test the database alteration
417.         self.assertTableNotExists("test_crprmo_proxypony")
418.         self.assertTableExists("test_crprmo_pony")
419.         with connection.schema_editor() as editor:
420.             operation.database_forwards("test_crprmo", editor, project_state, new_state)
421.         self.assertTableNotExists("test_crprmo_proxypony")
422.         self.assertTableExists("test_crprmo_pony")
423.         # And test reversal
424.         with connection.schema_editor() as editor:
425.             operation.database_backwards("test_crprmo", editor, new_state, project_state)
426.         self.assertTableNotExists("test_crprmo_proxypony")
427.         self.assertTableExists("test_crprmo_pony")
428.         # And deconstruction
429.         definition = operation.deconstruct()
430.         self.assertEqual(definition[0], "CreateModel")
431.         self.assertEqual(definition[1], [])
432.         self.assertEqual(sorted(definition[2]), ["bases", "fields", "name", "options"])
433. 
434.     def test_create_unmanaged_model(self):
435.         """
436.         CreateModel ignores unmanaged models.
437.         """
438.         project_state = self.set_up_test_model("test_crummo")
439.         # Test the state alteration
440.         operation = migrations.CreateModel(
441.             "UnmanagedPony",
442.             [],
443.             options={"proxy": True},
444.             bases=("test_crummo.Pony",),
445.         )
446.         self.assertEqual(operation.describe(), "Create proxy model UnmanagedPony")
447.         new_state = project_state.clone()
448.         operation.state_forwards("test_crummo", new_state)
449.         self.assertIn(("test_crummo", "unmanagedpony"), new_state.models)
450.         # Test the database alteration
451.         self.assertTableNotExists("test_crummo_unmanagedpony")
452.         self.assertTableExists("test_crummo_pony")
453.         with connection.schema_editor() as editor:
454.             operation.database_forwards("test_crummo", editor, project_state, new_state)
455.         self.assertTableNotExists("test_crummo_unmanagedpony")
456.         self.assertTableExists("test_crummo_pony")
457.         # And test reversal
458.         with connection.schema_editor() as editor:
459.             operation.database_backwards("test_crummo", editor, new_state, project_state)
460.         self.assertTableNotExists("test_crummo_unmanagedpony")
461.         self.assertTableExists("test_crummo_pony")
462. 
463.     @skipUnlessDBFeature('supports_table_check_constraints')
464.     def test_create_model_with_constraint(self):
465.         where = models.Q(pink__gt=2)
466.         check_constraint = models.CheckConstraint(check=where, name='test_constraint_pony_pink_gt_2')
467.         operation = migrations.CreateModel(
468.             "Pony",
469.             [
470.                 ("id", models.AutoField(primary_key=True)),
471.                 ("pink", models.IntegerField(default=3)),
472.             ],
473.             options={'constraints': [check_constraint]},
474.         )
475. 
476.         # Test the state alteration
477.         project_state = ProjectState()
478.         new_state = project_state.clone()
479.         operation.state_forwards("test_crmo", new_state)
480.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
481. 
482.         # Test database alteration
483.         self.assertTableNotExists("test_crmo_pony")
484.         with connection.schema_editor() as editor:
485.             operation.database_forwards("test_crmo", editor, project_state, new_state)
486.         self.assertTableExists("test_crmo_pony")
487.         with connection.cursor() as cursor:
488.             with self.assertRaises(IntegrityError):
489.                 cursor.execute("INSERT INTO test_crmo_pony (id, pink) VALUES (1, 1)")
490. 
491.         # Test reversal
492.         with connection.schema_editor() as editor:
493.             operation.database_backwards("test_crmo", editor, new_state, project_state)
494.         self.assertTableNotExists("test_crmo_pony")
495. 
496.         # Test deconstruction
497.         definition = operation.deconstruct()
498.         self.assertEqual(definition[0], "CreateModel")
499.         self.assertEqual(definition[1], [])
500.         self.assertEqual(definition[2]['options']['constraints'], [check_constraint])
501. 
502.     def test_create_model_with_partial_unique_constraint(self):
503.         partial_unique_constraint = models.UniqueConstraint(
504.             fields=['pink'],
505.             condition=models.Q(weight__gt=5),
506.             name='test_constraint_pony_pink_for_weight_gt_5_uniq',
507.         )
508.         operation = migrations.CreateModel(
509.             'Pony',
510.             [
511.                 ('id', models.AutoField(primary_key=True)),
512.                 ('pink', models.IntegerField(default=3)),
513.                 ('weight', models.FloatField()),
514.             ],
515.             options={'constraints': [partial_unique_constraint]},
516.         )
517.         # Test the state alteration
518.         project_state = ProjectState()
519.         new_state = project_state.clone()
520.         operation.state_forwards('test_crmo', new_state)
521.         self.assertEqual(len(new_state.models['test_crmo', 'pony'].options['constraints']), 1)
522.         # Test database alteration
523.         self.assertTableNotExists('test_crmo_pony')
524.         with connection.schema_editor() as editor:
525.             operation.database_forwards('test_crmo', editor, project_state, new_state)
526.         self.assertTableExists('test_crmo_pony')
527.         # Test constraint works
528.         Pony = new_state.apps.get_model('test_crmo', 'Pony')
529.         Pony.objects.create(pink=1, weight=4.0)
530.         Pony.objects.create(pink=1, weight=4.0)
531.         Pony.objects.create(pink=1, weight=6.0)
532.         if connection.features.supports_partial_indexes:
533.             with self.assertRaises(IntegrityError):
534.                 Pony.objects.create(pink=1, weight=7.0)
535.         else:
536.             Pony.objects.create(pink=1, weight=7.0)
537.         # Test reversal
538.         with connection.schema_editor() as editor:
539.             operation.database_backwards('test_crmo', editor, new_state, project_state)
540.         self.assertTableNotExists('test_crmo_pony')
541.         # Test deconstruction
542.         definition = operation.deconstruct()
543.         self.assertEqual(definition[0], 'CreateModel')
544.         self.assertEqual(definition[1], [])
545.         self.assertEqual(definition[2]['options']['constraints'], [partial_unique_constraint])
546. 
547.     def test_create_model_managers(self):
548.         """
549.         The managers on a model are set.
550.         """
551.         project_state = self.set_up_test_model("test_cmoma")
552.         # Test the state alteration
553.         operation = migrations.CreateModel(
554.             "Food",
555.             fields=[
556.                 ("id", models.AutoField(primary_key=True)),
557.             ],
558.             managers=[
559.                 ("food_qs", FoodQuerySet.as_manager()),
560.                 ("food_mgr", FoodManager("a", "b")),
561.                 ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
562.             ]
563.         )
564.         self.assertEqual(operation.describe(), "Create model Food")
565.         new_state = project_state.clone()
566.         operation.state_forwards("test_cmoma", new_state)
567.         self.assertIn(("test_cmoma", "food"), new_state.models)
568.         managers = new_state.models["test_cmoma", "food"].managers
569.         self.assertEqual(managers[0][0], "food_qs")
570.         self.assertIsInstance(managers[0][1], models.Manager)
571.         self.assertEqual(managers[1][0], "food_mgr")
572.         self.assertIsInstance(managers[1][1], FoodManager)
573.         self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
574.         self.assertEqual(managers[2][0], "food_mgr_kwargs")
575.         self.assertIsInstance(managers[2][1], FoodManager)
576.         self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
577. 
578.     def test_delete_model(self):
579.         """
580.         Tests the DeleteModel operation.
581.         """
582.         project_state = self.set_up_test_model("test_dlmo")
583.         # Test the state alteration
584.         operation = migrations.DeleteModel("Pony")
585.         self.assertEqual(operation.describe(), "Delete model Pony")
586.         new_state = project_state.clone()
587.         operation.state_forwards("test_dlmo", new_state)
588.         self.assertNotIn(("test_dlmo", "pony"), new_state.models)
589.         # Test the database alteration
590.         self.assertTableExists("test_dlmo_pony")
591.         with connection.schema_editor() as editor:
592.             operation.database_forwards("test_dlmo", editor, project_state, new_state)
593.         self.assertTableNotExists("test_dlmo_pony")
594.         # And test reversal
595.         with connection.schema_editor() as editor:
596.             operation.database_backwards("test_dlmo", editor, new_state, project_state)
597.         self.assertTableExists("test_dlmo_pony")
598.         # And deconstruction
599.         definition = operation.deconstruct()
600.         self.assertEqual(definition[0], "DeleteModel")
601.         self.assertEqual(definition[1], [])
602.         self.assertEqual(list(definition[2]), ["name"])
603. 
604.     def test_delete_proxy_model(self):
605.         """
606.         Tests the DeleteModel operation ignores proxy models.
607.         """
608.         project_state = self.set_up_test_model("test_dlprmo", proxy_model=True)
609.         # Test the state alteration
610.         operation = migrations.DeleteModel("ProxyPony")
611.         new_state = project_state.clone()
612.         operation.state_forwards("test_dlprmo", new_state)
613.         self.assertIn(("test_dlprmo", "proxypony"), project_state.models)
614.         self.assertNotIn(("test_dlprmo", "proxypony"), new_state.models)
615.         # Test the database alteration
616.         self.assertTableExists("test_dlprmo_pony")
617.         self.assertTableNotExists("test_dlprmo_proxypony")
618.         with connection.schema_editor() as editor:
619.             operation.database_forwards("test_dlprmo", editor, project_state, new_state)
620.         self.assertTableExists("test_dlprmo_pony")
621.         self.assertTableNotExists("test_dlprmo_proxypony")
622.         # And test reversal
623.         with connection.schema_editor() as editor:
624.             operation.database_backwards("test_dlprmo", editor, new_state, project_state)
625.         self.assertTableExists("test_dlprmo_pony")
626.         self.assertTableNotExists("test_dlprmo_proxypony")
627. 
628.     def test_delete_mti_model(self):
629.         project_state = self.set_up_test_model('test_dlmtimo', mti_model=True)
630.         # Test the state alteration
631.         operation = migrations.DeleteModel('ShetlandPony')
632.         new_state = project_state.clone()
633.         operation.state_forwards('test_dlmtimo', new_state)
634.         self.assertIn(('test_dlmtimo', 'shetlandpony'), project_state.models)
635.         self.assertNotIn(('test_dlmtimo', 'shetlandpony'), new_state.models)
636.         # Test the database alteration
637.         self.assertTableExists('test_dlmtimo_pony')
638.         self.assertTableExists('test_dlmtimo_shetlandpony')
639.         self.assertColumnExists('test_dlmtimo_shetlandpony', 'pony_ptr_id')
640.         with connection.schema_editor() as editor:
641.             operation.database_forwards('test_dlmtimo', editor, project_state, new_state)
642.         self.assertTableExists('test_dlmtimo_pony')
643.         self.assertTableNotExists('test_dlmtimo_shetlandpony')
644.         # And test reversal
645.         with connection.schema_editor() as editor:
646.             operation.database_backwards('test_dlmtimo', editor, new_state, project_state)
647.         self.assertTableExists('test_dlmtimo_pony')
648.         self.assertTableExists('test_dlmtimo_shetlandpony')
649.         self.assertColumnExists('test_dlmtimo_shetlandpony', 'pony_ptr_id')
650. 
651.     def test_rename_model(self):
652.         """
653.         Tests the RenameModel operation.
654.         """
655.         project_state = self.set_up_test_model("test_rnmo", related_model=True)
656.         # Test the state alteration
657.         operation = migrations.RenameModel("Pony", "Horse")
658.         self.assertEqual(operation.describe(), "Rename model Pony to Horse")
659.         # Test initial state and database
660.         self.assertIn(("test_rnmo", "pony"), project_state.models)
661.         self.assertNotIn(("test_rnmo", "horse"), project_state.models)
662.         self.assertTableExists("test_rnmo_pony")
663.         self.assertTableNotExists("test_rnmo_horse")
664.         if connection.features.supports_foreign_keys:
665.             self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
666.             self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
667.         # Migrate forwards
668.         new_state = project_state.clone()
669.         atomic_rename = connection.features.supports_atomic_references_rename
670.         new_state = self.apply_operations("test_rnmo", new_state, [operation], atomic=atomic_rename)
671.         # Test new state and database
672.         self.assertNotIn(("test_rnmo", "pony"), new_state.models)
673.         self.assertIn(("test_rnmo", "horse"), new_state.models)
674.         # RenameModel also repoints all incoming FKs and M2Ms
675.         self.assertEqual("test_rnmo.Horse", new_state.models["test_rnmo", "rider"].fields[1][1].remote_field.model)
676.         self.assertTableNotExists("test_rnmo_pony")
677.         self.assertTableExists("test_rnmo_horse")
678.         if connection.features.supports_foreign_keys:
679.             self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
680.             self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
681.         # Migrate backwards
682.         original_state = self.unapply_operations("test_rnmo", project_state, [operation], atomic=atomic_rename)
683.         # Test original state and database
684.         self.assertIn(("test_rnmo", "pony"), original_state.models)
685.         self.assertNotIn(("test_rnmo", "horse"), original_state.models)
686.         self.assertEqual("Pony", original_state.models["test_rnmo", "rider"].fields[1][1].remote_field.model)
687.         self.assertTableExists("test_rnmo_pony")
688.         self.assertTableNotExists("test_rnmo_horse")
689.         if connection.features.supports_foreign_keys:
690.             self.assertFKExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_pony", "id"))
691.             self.assertFKNotExists("test_rnmo_rider", ["pony_id"], ("test_rnmo_horse", "id"))
692.         # And deconstruction
693.         definition = operation.deconstruct()
694.         self.assertEqual(definition[0], "RenameModel")
695.         self.assertEqual(definition[1], [])
696.         self.assertEqual(definition[2], {'old_name': "Pony", 'new_name': "Horse"})
697. 
698.     def test_rename_model_state_forwards(self):
699.         """
700.         RenameModel operations shouldn't trigger the caching of rendered apps
701.         on state without prior apps.
702.         """
703.         state = ProjectState()
704.         state.add_model(ModelState('migrations', 'Foo', []))
705.         operation = migrations.RenameModel('Foo', 'Bar')
706.         operation.state_forwards('migrations', state)
707.         self.assertNotIn('apps', state.__dict__)
708.         self.assertNotIn(('migrations', 'foo'), state.models)
709.         self.assertIn(('migrations', 'bar'), state.models)
710.         # Now with apps cached.
711.         apps = state.apps
712.         operation = migrations.RenameModel('Bar', 'Foo')
713.         operation.state_forwards('migrations', state)
714.         self.assertIs(state.apps, apps)
715.         self.assertNotIn(('migrations', 'bar'), state.models)
716.         self.assertIn(('migrations', 'foo'), state.models)
717. 
718.     def test_rename_model_with_self_referential_fk(self):
719.         """
720.         Tests the RenameModel operation on model with self referential FK.
721.         """
722.         project_state = self.set_up_test_model("test_rmwsrf", related_model=True)
723.         # Test the state alteration
724.         operation = migrations.RenameModel("Rider", "HorseRider")
725.         self.assertEqual(operation.describe(), "Rename model Rider to HorseRider")
726.         new_state = project_state.clone()
727.         operation.state_forwards("test_rmwsrf", new_state)
728.         self.assertNotIn(("test_rmwsrf", "rider"), new_state.models)
729.         self.assertIn(("test_rmwsrf", "horserider"), new_state.models)
730.         # Remember, RenameModel also repoints all incoming FKs and M2Ms
731.         self.assertEqual(
732.             'self',
733.             new_state.models["test_rmwsrf", "horserider"].fields[2][1].remote_field.model
734.         )
735.         HorseRider = new_state.apps.get_model('test_rmwsrf', 'horserider')
736.         self.assertIs(HorseRider._meta.get_field('horserider').remote_field.model, HorseRider)
737.         # Test the database alteration
738.         self.assertTableExists("test_rmwsrf_rider")
739.         self.assertTableNotExists("test_rmwsrf_horserider")
740.         if connection.features.supports_foreign_keys:
741.             self.assertFKExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_rider", "id"))
742.             self.assertFKNotExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
743.         atomic_rename = connection.features.supports_atomic_references_rename
744.         with connection.schema_editor(atomic=atomic_rename) as editor:
745.             operation.database_forwards("test_rmwsrf", editor, project_state, new_state)
746.         self.assertTableNotExists("test_rmwsrf_rider")
747.         self.assertTableExists("test_rmwsrf_horserider")
748.         if connection.features.supports_foreign_keys:
749.             self.assertFKNotExists("test_rmwsrf_horserider", ["friend_id"], ("test_rmwsrf_rider", "id"))
750.             self.assertFKExists("test_rmwsrf_horserider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
751.         # And test reversal
752.         with connection.schema_editor(atomic=atomic_rename) as editor:
753.             operation.database_backwards("test_rmwsrf", editor, new_state, project_state)
754.         self.assertTableExists("test_rmwsrf_rider")
755.         self.assertTableNotExists("test_rmwsrf_horserider")
756.         if connection.features.supports_foreign_keys:
757.             self.assertFKExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_rider", "id"))
758.             self.assertFKNotExists("test_rmwsrf_rider", ["friend_id"], ("test_rmwsrf_horserider", "id"))
759. 
760.     def test_rename_model_with_superclass_fk(self):
761.         """
762.         Tests the RenameModel operation on a model which has a superclass that
763.         has a foreign key.
764.         """
765.         project_state = self.set_up_test_model("test_rmwsc", related_model=True, mti_model=True)
766.         # Test the state alteration
767.         operation = migrations.RenameModel("ShetlandPony", "LittleHorse")
768.         self.assertEqual(operation.describe(), "Rename model ShetlandPony to LittleHorse")
769.         new_state = project_state.clone()
770.         operation.state_forwards("test_rmwsc", new_state)
771.         self.assertNotIn(("test_rmwsc", "shetlandpony"), new_state.models)
772.         self.assertIn(("test_rmwsc", "littlehorse"), new_state.models)
773.         # RenameModel shouldn't repoint the superclass's relations, only local ones
774.         self.assertEqual(
775.             project_state.models["test_rmwsc", "rider"].fields[1][1].remote_field.model,
776.             new_state.models["test_rmwsc", "rider"].fields[1][1].remote_field.model
777.         )
778.         # Before running the migration we have a table for Shetland Pony, not Little Horse
779.         self.assertTableExists("test_rmwsc_shetlandpony")
780.         self.assertTableNotExists("test_rmwsc_littlehorse")
781.         if connection.features.supports_foreign_keys:
782.             # and the foreign key on rider points to pony, not shetland pony
783.             self.assertFKExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_pony", "id"))
784.             self.assertFKNotExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_shetlandpony", "id"))
785.         with connection.schema_editor(atomic=connection.features.supports_atomic_references_rename) as editor:
786.             operation.database_forwards("test_rmwsc", editor, project_state, new_state)
787.         # Now we have a little horse table, not shetland pony
788.         self.assertTableNotExists("test_rmwsc_shetlandpony")
789.         self.assertTableExists("test_rmwsc_littlehorse")
790.         if connection.features.supports_foreign_keys:
791.             # but the Foreign keys still point at pony, not little horse
792.             self.assertFKExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_pony", "id"))
793.             self.assertFKNotExists("test_rmwsc_rider", ["pony_id"], ("test_rmwsc_littlehorse", "id"))
794. 
795.     def test_rename_model_with_self_referential_m2m(self):
796.         app_label = "test_rename_model_with_self_referential_m2m"
797. 
798.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
799.             migrations.CreateModel("ReflexivePony", fields=[
800.                 ("id", models.AutoField(primary_key=True)),
801.                 ("ponies", models.ManyToManyField("self")),
802.             ]),
803.         ])
804.         project_state = self.apply_operations(app_label, project_state, operations=[
805.             migrations.RenameModel("ReflexivePony", "ReflexivePony2"),
806.         ], atomic=connection.features.supports_atomic_references_rename)
807.         Pony = project_state.apps.get_model(app_label, "ReflexivePony2")
808.         pony = Pony.objects.create()
809.         pony.ponies.add(pony)
810. 
811.     def test_rename_model_with_m2m(self):
812.         app_label = "test_rename_model_with_m2m"
813.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
814.             migrations.CreateModel("Rider", fields=[
815.                 ("id", models.AutoField(primary_key=True)),
816.             ]),
817.             migrations.CreateModel("Pony", fields=[
818.                 ("id", models.AutoField(primary_key=True)),
819.                 ("riders", models.ManyToManyField("Rider")),
820.             ]),
821.         ])
822.         Pony = project_state.apps.get_model(app_label, "Pony")
823.         Rider = project_state.apps.get_model(app_label, "Rider")
824.         pony = Pony.objects.create()
825.         rider = Rider.objects.create()
826.         pony.riders.add(rider)
827. 
828.         project_state = self.apply_operations(app_label, project_state, operations=[
829.             migrations.RenameModel("Pony", "Pony2"),
830.         ], atomic=connection.features.supports_atomic_references_rename)
831.         Pony = project_state.apps.get_model(app_label, "Pony2")
832.         Rider = project_state.apps.get_model(app_label, "Rider")
833.         pony = Pony.objects.create()
834.         rider = Rider.objects.create()
835.         pony.riders.add(rider)
836.         self.assertEqual(Pony.objects.count(), 2)
837.         self.assertEqual(Rider.objects.count(), 2)
838.         self.assertEqual(Pony._meta.get_field('riders').remote_field.through.objects.count(), 2)
839. 
840.     def test_rename_m2m_target_model(self):
841.         app_label = "test_rename_m2m_target_model"
842.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
843.             migrations.CreateModel("Rider", fields=[
844.                 ("id", models.AutoField(primary_key=True)),
845.             ]),
846.             migrations.CreateModel("Pony", fields=[
847.                 ("id", models.AutoField(primary_key=True)),
848.                 ("riders", models.ManyToManyField("Rider")),
849.             ]),
850.         ])
851.         Pony = project_state.apps.get_model(app_label, "Pony")
852.         Rider = project_state.apps.get_model(app_label, "Rider")
853.         pony = Pony.objects.create()
854.         rider = Rider.objects.create()
855.         pony.riders.add(rider)
856. 
857.         project_state = self.apply_operations(app_label, project_state, operations=[
858.             migrations.RenameModel("Rider", "Rider2"),
859.         ], atomic=connection.features.supports_atomic_references_rename)
860.         Pony = project_state.apps.get_model(app_label, "Pony")
861.         Rider = project_state.apps.get_model(app_label, "Rider2")
862.         pony = Pony.objects.create()
863.         rider = Rider.objects.create()
864.         pony.riders.add(rider)
865.         self.assertEqual(Pony.objects.count(), 2)
866.         self.assertEqual(Rider.objects.count(), 2)
867.         self.assertEqual(Pony._meta.get_field('riders').remote_field.through.objects.count(), 2)
868. 
869.     def test_rename_m2m_through_model(self):
870.         app_label = "test_rename_through"
871.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
872.             migrations.CreateModel("Rider", fields=[
873.                 ("id", models.AutoField(primary_key=True)),
874.             ]),
875.             migrations.CreateModel("Pony", fields=[
876.                 ("id", models.AutoField(primary_key=True)),
877.             ]),
878.             migrations.CreateModel("PonyRider", fields=[
879.                 ("id", models.AutoField(primary_key=True)),
880.                 ("rider", models.ForeignKey("test_rename_through.Rider", models.CASCADE)),
881.                 ("pony", models.ForeignKey("test_rename_through.Pony", models.CASCADE)),
882.             ]),
883.             migrations.AddField(
884.                 "Pony",
885.                 "riders",
886.                 models.ManyToManyField("test_rename_through.Rider", through="test_rename_through.PonyRider"),
887.             ),
888.         ])
889.         Pony = project_state.apps.get_model(app_label, "Pony")
890.         Rider = project_state.apps.get_model(app_label, "Rider")
891.         PonyRider = project_state.apps.get_model(app_label, "PonyRider")
892.         pony = Pony.objects.create()
893.         rider = Rider.objects.create()
894.         PonyRider.objects.create(pony=pony, rider=rider)
895. 
896.         project_state = self.apply_operations(app_label, project_state, operations=[
897.             migrations.RenameModel("PonyRider", "PonyRider2"),
898.         ])
899.         Pony = project_state.apps.get_model(app_label, "Pony")
900.         Rider = project_state.apps.get_model(app_label, "Rider")
901.         PonyRider = project_state.apps.get_model(app_label, "PonyRider2")
902.         pony = Pony.objects.first()
903.         rider = Rider.objects.create()
904.         PonyRider.objects.create(pony=pony, rider=rider)
905.         self.assertEqual(Pony.objects.count(), 1)
906.         self.assertEqual(Rider.objects.count(), 2)
907.         self.assertEqual(PonyRider.objects.count(), 2)
908.         self.assertEqual(pony.riders.count(), 2)
909. 
910.     def test_rename_m2m_model_after_rename_field(self):
911.         """RenameModel renames a many-to-many column after a RenameField."""
912.         app_label = 'test_rename_multiple'
913.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
914.             migrations.CreateModel('Pony', fields=[
915.                 ('id', models.AutoField(primary_key=True)),
916.                 ('name', models.CharField(max_length=20)),
917.             ]),
918.             migrations.CreateModel('Rider', fields=[
919.                 ('id', models.AutoField(primary_key=True)),
920.                 ('pony', models.ForeignKey('test_rename_multiple.Pony', models.CASCADE)),
921.             ]),
922.             migrations.CreateModel('PonyRider', fields=[
923.                 ('id', models.AutoField(primary_key=True)),
924.                 ('riders', models.ManyToManyField('Rider')),
925.             ]),
926.             migrations.RenameField(model_name='pony', old_name='name', new_name='fancy_name'),
927.             migrations.RenameModel(old_name='Rider', new_name='Jockey'),
928.         ], atomic=connection.features.supports_atomic_references_rename)
929.         Pony = project_state.apps.get_model(app_label, 'Pony')
930.         Jockey = project_state.apps.get_model(app_label, 'Jockey')
931.         PonyRider = project_state.apps.get_model(app_label, 'PonyRider')
932.         # No "no such column" error means the column was renamed correctly.
933.         pony = Pony.objects.create(fancy_name='a good name')
934.         jockey = Jockey.objects.create(pony=pony)
935.         ponyrider = PonyRider.objects.create()
936.         ponyrider.riders.add(jockey)
937. 
938.     def test_add_field(self):
939.         """
940.         Tests the AddField operation.
941.         """
942.         # Test the state alteration
943.         operation = migrations.AddField(
944.             "Pony",
945.             "height",
946.             models.FloatField(null=True, default=5),
947.         )
948.         self.assertEqual(operation.describe(), "Add field height to Pony")
949.         project_state, new_state = self.make_test_state("test_adfl", operation)
950.         self.assertEqual(len(new_state.models["test_adfl", "pony"].fields), 4)
951.         field = [
952.             f for n, f in new_state.models["test_adfl", "pony"].fields
953.             if n == "height"
954.         ][0]
955.         self.assertEqual(field.default, 5)
956.         # Test the database alteration
957.         self.assertColumnNotExists("test_adfl_pony", "height")
958.         with connection.schema_editor() as editor:
959.             operation.database_forwards("test_adfl", editor, project_state, new_state)
960.         self.assertColumnExists("test_adfl_pony", "height")
961.         # And test reversal
962.         with connection.schema_editor() as editor:
963.             operation.database_backwards("test_adfl", editor, new_state, project_state)
964.         self.assertColumnNotExists("test_adfl_pony", "height")
965.         # And deconstruction
966.         definition = operation.deconstruct()
967.         self.assertEqual(definition[0], "AddField")
968.         self.assertEqual(definition[1], [])
969.         self.assertEqual(sorted(definition[2]), ["field", "model_name", "name"])
970. 
971.     def test_add_charfield(self):
972.         """
973.         Tests the AddField operation on TextField.
974.         """
975.         project_state = self.set_up_test_model("test_adchfl")
976. 
977.         Pony = project_state.apps.get_model("test_adchfl", "Pony")
978.         pony = Pony.objects.create(weight=42)
979. 
980.         new_state = self.apply_operations("test_adchfl", project_state, [
981.             migrations.AddField(
982.                 "Pony",
983.                 "text",
984.                 models.CharField(max_length=10, default="some text"),
985.             ),
986.             migrations.AddField(
987.                 "Pony",
988.                 "empty",
989.                 models.CharField(max_length=10, default=""),
990.             ),
991.             # If not properly quoted digits would be interpreted as an int.
992.             migrations.AddField(
993.                 "Pony",
994.                 "digits",
995.                 models.CharField(max_length=10, default="42"),
996.             ),
997.             # Manual quoting is fragile and could trip on quotes. Refs #xyz.
998.             migrations.AddField(
999.                 "Pony",
1000.                 "quotes",
1001.                 models.CharField(max_length=10, default='"\'"'),
1002.             ),
1003.         ])
1004. 
1005.         Pony = new_state.apps.get_model("test_adchfl", "Pony")
1006.         pony = Pony.objects.get(pk=pony.pk)
1007.         self.assertEqual(pony.text, "some text")
1008.         self.assertEqual(pony.empty, "")
1009.         self.assertEqual(pony.digits, "42")
1010.         self.assertEqual(pony.quotes, '"\'"')
1011. 
1012.     def test_add_textfield(self):
1013.         """
1014.         Tests the AddField operation on TextField.
1015.         """
1016.         project_state = self.set_up_test_model("test_adtxtfl")
1017. 
1018.         Pony = project_state.apps.get_model("test_adtxtfl", "Pony")
1019.         pony = Pony.objects.create(weight=42)
1020. 
1021.         new_state = self.apply_operations("test_adtxtfl", project_state, [
1022.             migrations.AddField(
1023.                 "Pony",
1024.                 "text",
1025.                 models.TextField(default="some text"),
1026.             ),
1027.             migrations.AddField(
1028.                 "Pony",
1029.                 "empty",
1030.                 models.TextField(default=""),
1031.             ),
1032.             # If not properly quoted digits would be interpreted as an int.
1033.             migrations.AddField(
1034.                 "Pony",
1035.                 "digits",
1036.                 models.TextField(default="42"),
1037.             ),
1038.             # Manual quoting is fragile and could trip on quotes. Refs #xyz.
1039.             migrations.AddField(
1040.                 "Pony",
1041.                 "quotes",
1042.                 models.TextField(default='"\'"'),
1043.             ),
1044.         ])
1045. 
1046.         Pony = new_state.apps.get_model("test_adtxtfl", "Pony")
1047.         pony = Pony.objects.get(pk=pony.pk)
1048.         self.assertEqual(pony.text, "some text")
1049.         self.assertEqual(pony.empty, "")
1050.         self.assertEqual(pony.digits, "42")
1051.         self.assertEqual(pony.quotes, '"\'"')
1052. 
1053.     def test_add_binaryfield(self):
1054.         """
1055.         Tests the AddField operation on TextField/BinaryField.
1056.         """
1057.         project_state = self.set_up_test_model("test_adbinfl")
1058. 
1059.         Pony = project_state.apps.get_model("test_adbinfl", "Pony")
1060.         pony = Pony.objects.create(weight=42)
1061. 
1062.         new_state = self.apply_operations("test_adbinfl", project_state, [
1063.             migrations.AddField(
1064.                 "Pony",
1065.                 "blob",
1066.                 models.BinaryField(default=b"some text"),
1067.             ),
1068.             migrations.AddField(
1069.                 "Pony",
1070.                 "empty",
1071.                 models.BinaryField(default=b""),
1072.             ),
1073.             # If not properly quoted digits would be interpreted as an int.
1074.             migrations.AddField(
1075.                 "Pony",
1076.                 "digits",
1077.                 models.BinaryField(default=b"42"),
1078.             ),
1079.             # Manual quoting is fragile and could trip on quotes. Refs #xyz.
1080.             migrations.AddField(
1081.                 "Pony",
1082.                 "quotes",
1083.                 models.BinaryField(default=b'"\'"'),
1084.             ),
1085.         ])
1086. 
1087.         Pony = new_state.apps.get_model("test_adbinfl", "Pony")
1088.         pony = Pony.objects.get(pk=pony.pk)
1089.         # SQLite returns buffer/memoryview, cast to bytes for checking.
1090.         self.assertEqual(bytes(pony.blob), b"some text")
1091.         self.assertEqual(bytes(pony.empty), b"")
1092.         self.assertEqual(bytes(pony.digits), b"42")
1093.         self.assertEqual(bytes(pony.quotes), b'"\'"')
1094. 
1095.     def test_column_name_quoting(self):
1096.         """
1097.         Column names that are SQL keywords shouldn't cause problems when used
1098.         in migrations (#22168).
1099.         """
1100.         project_state = self.set_up_test_model("test_regr22168")
1101.         operation = migrations.AddField(
1102.             "Pony",
1103.             "order",
1104.             models.IntegerField(default=0),
1105.         )
1106.         new_state = project_state.clone()
1107.         operation.state_forwards("test_regr22168", new_state)
1108.         with connection.schema_editor() as editor:
1109.             operation.database_forwards("test_regr22168", editor, project_state, new_state)
1110.         self.assertColumnExists("test_regr22168_pony", "order")
1111. 
1112.     def test_add_field_preserve_default(self):
1113.         """
1114.         Tests the AddField operation's state alteration
1115.         when preserve_default = False.
1116.         """
1117.         project_state = self.set_up_test_model("test_adflpd")
1118.         # Test the state alteration
1119.         operation = migrations.AddField(
1120.             "Pony",
1121.             "height",
1122.             models.FloatField(null=True, default=4),
1123.             preserve_default=False,
1124.         )
1125.         new_state = project_state.clone()
1126.         operation.state_forwards("test_adflpd", new_state)
1127.         self.assertEqual(len(new_state.models["test_adflpd", "pony"].fields), 4)
1128.         field = [
1129.             f for n, f in new_state.models["test_adflpd", "pony"].fields
1130.             if n == "height"
1131.         ][0]
1132.         self.assertEqual(field.default, NOT_PROVIDED)
1133.         # Test the database alteration
1134.         project_state.apps.get_model("test_adflpd", "pony").objects.create(
1135.             weight=4,
1136.         )
1137.         self.assertColumnNotExists("test_adflpd_pony", "height")
1138.         with connection.schema_editor() as editor:
1139.             operation.database_forwards("test_adflpd", editor, project_state, new_state)
1140.         self.assertColumnExists("test_adflpd_pony", "height")
1141.         # And deconstruction
1142.         definition = operation.deconstruct()
1143.         self.assertEqual(definition[0], "AddField")
1144.         self.assertEqual(definition[1], [])
1145.         self.assertEqual(sorted(definition[2]), ["field", "model_name", "name", "preserve_default"])
1146. 
1147.     def test_add_field_m2m(self):
1148.         """
1149.         Tests the AddField operation with a ManyToManyField.
1150.         """
1151.         project_state = self.set_up_test_model("test_adflmm", second_model=True)
1152.         # Test the state alteration
1153.         operation = migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
1154.         new_state = project_state.clone()
1155.         operation.state_forwards("test_adflmm", new_state)
1156.         self.assertEqual(len(new_state.models["test_adflmm", "pony"].fields), 4)
1157.         # Test the database alteration
1158.         self.assertTableNotExists("test_adflmm_pony_stables")
1159.         with connection.schema_editor() as editor:
1160.             operation.database_forwards("test_adflmm", editor, project_state, new_state)
1161.         self.assertTableExists("test_adflmm_pony_stables")
1162.         self.assertColumnNotExists("test_adflmm_pony", "stables")
1163.         # Make sure the M2M field actually works
1164.         with atomic():
1165.             Pony = new_state.apps.get_model("test_adflmm", "Pony")
1166.             p = Pony.objects.create(pink=False, weight=4.55)
1167.             p.stables.create()
1168.             self.assertEqual(p.stables.count(), 1)
1169.             p.stables.all().delete()
1170.         # And test reversal
1171.         with connection.schema_editor() as editor:
1172.             operation.database_backwards("test_adflmm", editor, new_state, project_state)
1173.         self.assertTableNotExists("test_adflmm_pony_stables")
1174. 
1175.     def test_alter_field_m2m(self):
1176.         project_state = self.set_up_test_model("test_alflmm", second_model=True)
1177. 
1178.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1179.             migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
1180.         ])
1181.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1182.         self.assertFalse(Pony._meta.get_field('stables').blank)
1183. 
1184.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1185.             migrations.AlterField(
1186.                 "Pony", "stables", models.ManyToManyField(to="Stable", related_name="ponies", blank=True)
1187.             )
1188.         ])
1189.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1190.         self.assertTrue(Pony._meta.get_field('stables').blank)
1191. 
1192.     def test_repoint_field_m2m(self):
1193.         project_state = self.set_up_test_model("test_alflmm", second_model=True, third_model=True)
1194. 
1195.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1196.             migrations.AddField("Pony", "places", models.ManyToManyField("Stable", related_name="ponies"))
1197.         ])
1198.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1199. 
1200.         project_state = self.apply_operations("test_alflmm", project_state, operations=[
1201.             migrations.AlterField("Pony", "places", models.ManyToManyField(to="Van", related_name="ponies"))
1202.         ])
1203. 
1204.         # Ensure the new field actually works
1205.         Pony = project_state.apps.get_model("test_alflmm", "Pony")
1206.         p = Pony.objects.create(pink=False, weight=4.55)
1207.         p.places.create()
1208.         self.assertEqual(p.places.count(), 1)
1209.         p.places.all().delete()
1210. 
1211.     def test_remove_field_m2m(self):
1212.         project_state = self.set_up_test_model("test_rmflmm", second_model=True)
1213. 
1214.         project_state = self.apply_operations("test_rmflmm", project_state, operations=[
1215.             migrations.AddField("Pony", "stables", models.ManyToManyField("Stable", related_name="ponies"))
1216.         ])
1217.         self.assertTableExists("test_rmflmm_pony_stables")
1218. 
1219.         with_field_state = project_state.clone()
1220.         operations = [migrations.RemoveField("Pony", "stables")]
1221.         project_state = self.apply_operations("test_rmflmm", project_state, operations=operations)
1222.         self.assertTableNotExists("test_rmflmm_pony_stables")
1223. 
1224.         # And test reversal
1225.         self.unapply_operations("test_rmflmm", with_field_state, operations=operations)
1226.         self.assertTableExists("test_rmflmm_pony_stables")
1227. 
1228.     def test_remove_field_m2m_with_through(self):
1229.         project_state = self.set_up_test_model("test_rmflmmwt", second_model=True)
1230. 
1231.         self.assertTableNotExists("test_rmflmmwt_ponystables")
1232.         project_state = self.apply_operations("test_rmflmmwt", project_state, operations=[
1233.             migrations.CreateModel("PonyStables", fields=[
1234.                 ("pony", models.ForeignKey('test_rmflmmwt.Pony', models.CASCADE)),
1235.                 ("stable", models.ForeignKey('test_rmflmmwt.Stable', models.CASCADE)),
1236.             ]),
1237.             migrations.AddField(
1238.                 "Pony", "stables",
1239.                 models.ManyToManyField("Stable", related_name="ponies", through='test_rmflmmwt.PonyStables')
1240.             )
1241.         ])
1242.         self.assertTableExists("test_rmflmmwt_ponystables")
1243. 
1244.         operations = [migrations.RemoveField("Pony", "stables"), migrations.DeleteModel("PonyStables")]
1245.         self.apply_operations("test_rmflmmwt", project_state, operations=operations)
1246. 
1247.     def test_remove_field(self):
1248.         """
1249.         Tests the RemoveField operation.
1250.         """
1251.         project_state = self.set_up_test_model("test_rmfl")
1252.         # Test the state alteration
1253.         operation = migrations.RemoveField("Pony", "pink")
1254.         self.assertEqual(operation.describe(), "Remove field pink from Pony")
1255.         new_state = project_state.clone()
1256.         operation.state_forwards("test_rmfl", new_state)
1257.         self.assertEqual(len(new_state.models["test_rmfl", "pony"].fields), 2)
1258.         # Test the database alteration
1259.         self.assertColumnExists("test_rmfl_pony", "pink")
1260.         with connection.schema_editor() as editor:
1261.             operation.database_forwards("test_rmfl", editor, project_state, new_state)
1262.         self.assertColumnNotExists("test_rmfl_pony", "pink")
1263.         # And test reversal
1264.         with connection.schema_editor() as editor:
1265.             operation.database_backwards("test_rmfl", editor, new_state, project_state)
1266.         self.assertColumnExists("test_rmfl_pony", "pink")
1267.         # And deconstruction
1268.         definition = operation.deconstruct()
1269.         self.assertEqual(definition[0], "RemoveField")
1270.         self.assertEqual(definition[1], [])
1271.         self.assertEqual(definition[2], {'model_name': "Pony", 'name': 'pink'})
1272. 
1273.     def test_remove_fk(self):
1274.         """
1275.         Tests the RemoveField operation on a foreign key.
1276.         """
1277.         project_state = self.set_up_test_model("test_rfk", related_model=True)
1278.         self.assertColumnExists("test_rfk_rider", "pony_id")
1279.         operation = migrations.RemoveField("Rider", "pony")
1280. 
1281.         new_state = project_state.clone()
1282.         operation.state_forwards("test_rfk", new_state)
1283.         with connection.schema_editor() as editor:
1284.             operation.database_forwards("test_rfk", editor, project_state, new_state)
1285.         self.assertColumnNotExists("test_rfk_rider", "pony_id")
1286.         with connection.schema_editor() as editor:
1287.             operation.database_backwards("test_rfk", editor, new_state, project_state)
1288.         self.assertColumnExists("test_rfk_rider", "pony_id")
1289. 
1290.     def test_alter_model_table(self):
1291.         """
1292.         Tests the AlterModelTable operation.
1293.         """
1294.         project_state = self.set_up_test_model("test_almota")
1295.         # Test the state alteration
1296.         operation = migrations.AlterModelTable("Pony", "test_almota_pony_2")
1297.         self.assertEqual(operation.describe(), "Rename table for Pony to test_almota_pony_2")
1298.         new_state = project_state.clone()
1299.         operation.state_forwards("test_almota", new_state)
1300.         self.assertEqual(new_state.models["test_almota", "pony"].options["db_table"], "test_almota_pony_2")
1301.         # Test the database alteration
1302.         self.assertTableExists("test_almota_pony")
1303.         self.assertTableNotExists("test_almota_pony_2")
1304.         with connection.schema_editor() as editor:
1305.             operation.database_forwards("test_almota", editor, project_state, new_state)
1306.         self.assertTableNotExists("test_almota_pony")
1307.         self.assertTableExists("test_almota_pony_2")
1308.         # And test reversal
1309.         with connection.schema_editor() as editor:
1310.             operation.database_backwards("test_almota", editor, new_state, project_state)
1311.         self.assertTableExists("test_almota_pony")
1312.         self.assertTableNotExists("test_almota_pony_2")
1313.         # And deconstruction
1314.         definition = operation.deconstruct()
1315.         self.assertEqual(definition[0], "AlterModelTable")
1316.         self.assertEqual(definition[1], [])
1317.         self.assertEqual(definition[2], {'name': "Pony", 'table': "test_almota_pony_2"})
1318. 
1319.     def test_alter_model_table_none(self):
1320.         """
1321.         Tests the AlterModelTable operation if the table name is set to None.
1322.         """
1323.         operation = migrations.AlterModelTable("Pony", None)
1324.         self.assertEqual(operation.describe(), "Rename table for Pony to (default)")
1325. 
1326.     def test_alter_model_table_noop(self):
1327.         """
1328.         Tests the AlterModelTable operation if the table name is not changed.
1329.         """
1330.         project_state = self.set_up_test_model("test_almota")
1331.         # Test the state alteration
1332.         operation = migrations.AlterModelTable("Pony", "test_almota_pony")
1333.         new_state = project_state.clone()
1334.         operation.state_forwards("test_almota", new_state)
1335.         self.assertEqual(new_state.models["test_almota", "pony"].options["db_table"], "test_almota_pony")
1336.         # Test the database alteration
1337.         self.assertTableExists("test_almota_pony")
1338.         with connection.schema_editor() as editor:
1339.             operation.database_forwards("test_almota", editor, project_state, new_state)
1340.         self.assertTableExists("test_almota_pony")
1341.         # And test reversal
1342.         with connection.schema_editor() as editor:
1343.             operation.database_backwards("test_almota", editor, new_state, project_state)
1344.         self.assertTableExists("test_almota_pony")
1345. 
1346.     def test_alter_model_table_m2m(self):
1347.         """
1348.         AlterModelTable should rename auto-generated M2M tables.
1349.         """
1350.         app_label = "test_talflmltlm2m"
1351.         pony_db_table = 'pony_foo'
1352.         project_state = self.set_up_test_model(app_label, second_model=True, db_table=pony_db_table)
1353.         # Add the M2M field
1354.         first_state = project_state.clone()
1355.         operation = migrations.AddField("Pony", "stables", models.ManyToManyField("Stable"))
1356.         operation.state_forwards(app_label, first_state)
1357.         with connection.schema_editor() as editor:
1358.             operation.database_forwards(app_label, editor, project_state, first_state)
1359.         original_m2m_table = "%s_%s" % (pony_db_table, "stables")
1360.         new_m2m_table = "%s_%s" % (app_label, "pony_stables")
1361.         self.assertTableExists(original_m2m_table)
1362.         self.assertTableNotExists(new_m2m_table)
1363.         # Rename the Pony db_table which should also rename the m2m table.
1364.         second_state = first_state.clone()
1365.         operation = migrations.AlterModelTable(name='pony', table=None)
1366.         operation.state_forwards(app_label, second_state)
1367.         atomic_rename = connection.features.supports_atomic_references_rename
1368.         with connection.schema_editor(atomic=atomic_rename) as editor:
1369.             operation.database_forwards(app_label, editor, first_state, second_state)
1370.         self.assertTableExists(new_m2m_table)
1371.         self.assertTableNotExists(original_m2m_table)
1372.         # And test reversal
1373.         with connection.schema_editor(atomic=atomic_rename) as editor:
1374.             operation.database_backwards(app_label, editor, second_state, first_state)
1375.         self.assertTableExists(original_m2m_table)
1376.         self.assertTableNotExists(new_m2m_table)
1377. 
1378.     def test_alter_field(self):
1379.         """
1380.         Tests the AlterField operation.
1381.         """
1382.         project_state = self.set_up_test_model("test_alfl")
1383.         # Test the state alteration
1384.         operation = migrations.AlterField("Pony", "pink", models.IntegerField(null=True))
1385.         self.assertEqual(operation.describe(), "Alter field pink on Pony")
1386.         new_state = project_state.clone()
1387.         operation.state_forwards("test_alfl", new_state)
1388.         self.assertIs(project_state.models["test_alfl", "pony"].get_field_by_name("pink").null, False)
1389.         self.assertIs(new_state.models["test_alfl", "pony"].get_field_by_name("pink").null, True)
1390.         # Test the database alteration
1391.         self.assertColumnNotNull("test_alfl_pony", "pink")
1392.         with connection.schema_editor() as editor:
1393.             operation.database_forwards("test_alfl", editor, project_state, new_state)
1394.         self.assertColumnNull("test_alfl_pony", "pink")
1395.         # And test reversal
1396.         with connection.schema_editor() as editor:
1397.             operation.database_backwards("test_alfl", editor, new_state, project_state)
1398.         self.assertColumnNotNull("test_alfl_pony", "pink")
1399.         # And deconstruction
1400.         definition = operation.deconstruct()
1401.         self.assertEqual(definition[0], "AlterField")
1402.         self.assertEqual(definition[1], [])
1403.         self.assertEqual(sorted(definition[2]), ["field", "model_name", "name"])
1404. 
1405.     def test_alter_field_pk(self):
1406.         """
1407.         Tests the AlterField operation on primary keys (for things like PostgreSQL's SERIAL weirdness)
1408.         """
1409.         project_state = self.set_up_test_model("test_alflpk")
1410.         # Test the state alteration
1411.         operation = migrations.AlterField("Pony", "id", models.IntegerField(primary_key=True))
1412.         new_state = project_state.clone()
1413.         operation.state_forwards("test_alflpk", new_state)
1414.         self.assertIsInstance(project_state.models["test_alflpk", "pony"].get_field_by_name("id"), models.AutoField)
1415.         self.assertIsInstance(new_state.models["test_alflpk", "pony"].get_field_by_name("id"), models.IntegerField)
1416.         # Test the database alteration
1417.         with connection.schema_editor() as editor:
1418.             operation.database_forwards("test_alflpk", editor, project_state, new_state)
1419.         # And test reversal
1420.         with connection.schema_editor() as editor:
1421.             operation.database_backwards("test_alflpk", editor, new_state, project_state)
1422. 
1423.     @skipUnlessDBFeature('supports_foreign_keys')
1424.     def test_alter_field_pk_fk(self):
1425.         """
1426.         Tests the AlterField operation on primary keys changes any FKs pointing to it.
1427.         """
1428.         project_state = self.set_up_test_model("test_alflpkfk", related_model=True)
1429.         # Test the state alteration
1430.         operation = migrations.AlterField("Pony", "id", models.FloatField(primary_key=True))
1431.         new_state = project_state.clone()
1432.         operation.state_forwards("test_alflpkfk", new_state)
1433.         self.assertIsInstance(project_state.models["test_alflpkfk", "pony"].get_field_by_name("id"), models.AutoField)
1434.         self.assertIsInstance(new_state.models["test_alflpkfk", "pony"].get_field_by_name("id"), models.FloatField)
1435. 
1436.         def assertIdTypeEqualsFkType():
1437.             with connection.cursor() as cursor:
1438.                 id_type, id_null = [
1439.                     (c.type_code, c.null_ok)
1440.                     for c in connection.introspection.get_table_description(cursor, "test_alflpkfk_pony")
1441.                     if c.name == "id"
1442.                 ][0]
1443.                 fk_type, fk_null = [
1444.                     (c.type_code, c.null_ok)
1445.                     for c in connection.introspection.get_table_description(cursor, "test_alflpkfk_rider")
1446.                     if c.name == "pony_id"
1447.                 ][0]
1448.             self.assertEqual(id_type, fk_type)
1449.             self.assertEqual(id_null, fk_null)
1450. 
1451.         assertIdTypeEqualsFkType()
1452.         # Test the database alteration
1453.         with connection.schema_editor() as editor:
1454.             operation.database_forwards("test_alflpkfk", editor, project_state, new_state)
1455.         assertIdTypeEqualsFkType()
1456.         # And test reversal
1457.         with connection.schema_editor() as editor:
1458.             operation.database_backwards("test_alflpkfk", editor, new_state, project_state)
1459.         assertIdTypeEqualsFkType()
1460. 
1461.     def test_alter_field_reloads_state_on_fk_target_changes(self):
1462.         """
1463.         If AlterField doesn't reload state appropriately, the second AlterField
1464.         crashes on MySQL due to not dropping the PonyRider.pony foreign key
1465.         constraint before modifying the column.
1466.         """
1467.         app_label = 'alter_alter_field_reloads_state_on_fk_target_changes'
1468.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
1469.             migrations.CreateModel('Rider', fields=[
1470.                 ('id', models.CharField(primary_key=True, max_length=100)),
1471.             ]),
1472.             migrations.CreateModel('Pony', fields=[
1473.                 ('id', models.CharField(primary_key=True, max_length=100)),
1474.                 ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE)),
1475.             ]),
1476.             migrations.CreateModel('PonyRider', fields=[
1477.                 ('id', models.AutoField(primary_key=True)),
1478.                 ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE)),
1479.             ]),
1480.         ])
1481.         project_state = self.apply_operations(app_label, project_state, operations=[
1482.             migrations.AlterField('Rider', 'id', models.CharField(primary_key=True, max_length=99)),
1483.             migrations.AlterField('Pony', 'id', models.CharField(primary_key=True, max_length=99)),
1484.         ])
1485. 
1486.     def test_alter_field_reloads_state_on_fk_with_to_field_target_changes(self):
1487.         """
1488.         If AlterField doesn't reload state appropriately, the second AlterField
1489.         crashes on MySQL due to not dropping the PonyRider.pony foreign key
1490.         constraint before modifying the column.
1491.         """
1492.         app_label = 'alter_alter_field_reloads_state_on_fk_with_to_field_target_changes'
1493.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
1494.             migrations.CreateModel('Rider', fields=[
1495.                 ('id', models.CharField(primary_key=True, max_length=100)),
1496.                 ('slug', models.CharField(unique=True, max_length=100)),
1497.             ]),
1498.             migrations.CreateModel('Pony', fields=[
1499.                 ('id', models.CharField(primary_key=True, max_length=100)),
1500.                 ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE, to_field='slug')),
1501.                 ('slug', models.CharField(unique=True, max_length=100)),
1502.             ]),
1503.             migrations.CreateModel('PonyRider', fields=[
1504.                 ('id', models.AutoField(primary_key=True)),
1505.                 ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE, to_field='slug')),
1506.             ]),
1507.         ])
1508.         project_state = self.apply_operations(app_label, project_state, operations=[
1509.             migrations.AlterField('Rider', 'slug', models.CharField(unique=True, max_length=99)),
1510.             migrations.AlterField('Pony', 'slug', models.CharField(unique=True, max_length=99)),
1511.         ])
1512. 
1513.     def test_rename_field_reloads_state_on_fk_target_changes(self):
1514.         """
1515.         If RenameField doesn't reload state appropriately, the AlterField
1516.         crashes on MySQL due to not dropping the PonyRider.pony foreign key
1517.         constraint before modifying the column.
1518.         """
1519.         app_label = 'alter_rename_field_reloads_state_on_fk_target_changes'
1520.         project_state = self.apply_operations(app_label, ProjectState(), operations=[
1521.             migrations.CreateModel('Rider', fields=[
1522.                 ('id', models.CharField(primary_key=True, max_length=100)),
1523.             ]),
1524.             migrations.CreateModel('Pony', fields=[
1525.                 ('id', models.CharField(primary_key=True, max_length=100)),
1526.                 ('rider', models.ForeignKey('%s.Rider' % app_label, models.CASCADE)),
1527.             ]),
1528.             migrations.CreateModel('PonyRider', fields=[
1529.                 ('id', models.AutoField(primary_key=True)),
1530.                 ('pony', models.ForeignKey('%s.Pony' % app_label, models.CASCADE)),
1531.             ]),
1532.         ])
1533.         project_state = self.apply_operations(app_label, project_state, operations=[
1534.             migrations.RenameField('Rider', 'id', 'id2'),
1535.             migrations.AlterField('Pony', 'id', models.CharField(primary_key=True, max_length=99)),
1536.         ], atomic=connection.features.supports_atomic_references_rename)
1537. 
1538.     def test_rename_field(self):
1539.         """
1540.         Tests the RenameField operation.
1541.         """
1542.         project_state = self.set_up_test_model("test_rnfl", unique_together=True, index_together=True)
1543.         # Test the state alteration
1544.         operation = migrations.RenameField("Pony", "pink", "blue")
1545.         self.assertEqual(operation.describe(), "Rename field pink on Pony to blue")
1546.         new_state = project_state.clone()
1547.         operation.state_forwards("test_rnfl", new_state)
1548.         self.assertIn("blue", [n for n, f in new_state.models["test_rnfl", "pony"].fields])
1549.         self.assertNotIn("pink", [n for n, f in new_state.models["test_rnfl", "pony"].fields])
1550.         # Make sure the unique_together has the renamed column too
1551.         self.assertIn("blue", new_state.models["test_rnfl", "pony"].options['unique_together'][0])
1552.         self.assertNotIn("pink", new_state.models["test_rnfl", "pony"].options['unique_together'][0])
1553.         # Make sure the index_together has the renamed column too
1554.         self.assertIn("blue", new_state.models["test_rnfl", "pony"].options['index_together'][0])
1555.         self.assertNotIn("pink", new_state.models["test_rnfl", "pony"].options['index_together'][0])
1556.         # Test the database alteration
1557.         self.assertColumnExists("test_rnfl_pony", "pink")
1558.         self.assertColumnNotExists("test_rnfl_pony", "blue")
1559.         with connection.schema_editor() as editor:
1560.             operation.database_forwards("test_rnfl", editor, project_state, new_state)
1561.         self.assertColumnExists("test_rnfl_pony", "blue")
1562.         self.assertColumnNotExists("test_rnfl_pony", "pink")
1563.         # Ensure the unique constraint has been ported over
1564.         with connection.cursor() as cursor:
1565.             cursor.execute("INSERT INTO test_rnfl_pony (blue, weight) VALUES (1, 1)")
1566.             with self.assertRaises(IntegrityError):
1567.                 with atomic():
1568.                     cursor.execute("INSERT INTO test_rnfl_pony (blue, weight) VALUES (1, 1)")
1569.             cursor.execute("DELETE FROM test_rnfl_pony")
1570.         # Ensure the index constraint has been ported over
1571.         self.assertIndexExists("test_rnfl_pony", ["weight", "blue"])
1572.         # And test reversal
1573.         with connection.schema_editor() as editor:
1574.             operation.database_backwards("test_rnfl", editor, new_state, project_state)
1575.         self.assertColumnExists("test_rnfl_pony", "pink")
1576.         self.assertColumnNotExists("test_rnfl_pony", "blue")
1577.         # Ensure the index constraint has been reset
1578.         self.assertIndexExists("test_rnfl_pony", ["weight", "pink"])
1579.         # And deconstruction
1580.         definition = operation.deconstruct()
1581.         self.assertEqual(definition[0], "RenameField")
1582.         self.assertEqual(definition[1], [])
1583.         self.assertEqual(definition[2], {'model_name': "Pony", 'old_name': "pink", 'new_name': "blue"})
1584. 
1585.     def test_rename_missing_field(self):
1586.         state = ProjectState()
1587.         state.add_model(ModelState('app', 'model', []))
1588.         with self.assertRaisesMessage(FieldDoesNotExist, "app.model has no field named 'field'"):
1589.             migrations.RenameField('model', 'field', 'new_field').state_forwards('app', state)
1590. 
1591.     def test_rename_referenced_field_state_forward(self):
1592.         state = ProjectState()
1593.         state.add_model(ModelState('app', 'Model', [
1594.             ('id', models.AutoField(primary_key=True)),
1595.             ('field', models.IntegerField(unique=True)),
1596.         ]))
1597.         state.add_model(ModelState('app', 'OtherModel', [
1598.             ('id', models.AutoField(primary_key=True)),
1599.             ('fk', models.ForeignKey('Model', models.CASCADE, to_field='field')),
1600.             ('fo', models.ForeignObject('Model', models.CASCADE, from_fields=('fk',), to_fields=('field',))),
1601.         ]))
1602.         operation = migrations.RenameField('Model', 'field', 'renamed')
1603.         new_state = state.clone()
1604.         operation.state_forwards('app', new_state)
1605.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].remote_field.field_name, 'renamed')
1606.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].from_fields, ['self'])
1607.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].to_fields, ('renamed',))
1608.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].from_fields, ('fk',))
1609.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].to_fields, ('renamed',))
1610.         operation = migrations.RenameField('OtherModel', 'fk', 'renamed_fk')
1611.         new_state = state.clone()
1612.         operation.state_forwards('app', new_state)
1613.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].remote_field.field_name, 'renamed')
1614.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].from_fields, ('self',))
1615.         self.assertEqual(new_state.models['app', 'othermodel'].fields[1][1].to_fields, ('renamed',))
1616.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].from_fields, ('renamed_fk',))
1617.         self.assertEqual(new_state.models['app', 'othermodel'].fields[2][1].to_fields, ('renamed',))
1618. 
1619.     def test_alter_unique_together(self):
1620.         """
1621.         Tests the AlterUniqueTogether operation.
1622.         """
1623.         project_state = self.set_up_test_model("test_alunto")
1624.         # Test the state alteration
1625.         operation = migrations.AlterUniqueTogether("Pony", [("pink", "weight")])
1626.         self.assertEqual(operation.describe(), "Alter unique_together for Pony (1 constraint(s))")
1627.         new_state = project_state.clone()
1628.         operation.state_forwards("test_alunto", new_state)
1629.         self.assertEqual(len(project_state.models["test_alunto", "pony"].options.get("unique_together", set())), 0)
1630.         self.assertEqual(len(new_state.models["test_alunto", "pony"].options.get("unique_together", set())), 1)
1631.         # Make sure we can insert duplicate rows
1632.         with connection.cursor() as cursor:
1633.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1634.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1635.             cursor.execute("DELETE FROM test_alunto_pony")
1636.             # Test the database alteration
1637.             with connection.schema_editor() as editor:
1638.                 operation.database_forwards("test_alunto", editor, project_state, new_state)
1639.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1640.             with self.assertRaises(IntegrityError):
1641.                 with atomic():
1642.                     cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1643.             cursor.execute("DELETE FROM test_alunto_pony")
1644.             # And test reversal
1645.             with connection.schema_editor() as editor:
1646.                 operation.database_backwards("test_alunto", editor, new_state, project_state)
1647.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1648.             cursor.execute("INSERT INTO test_alunto_pony (pink, weight) VALUES (1, 1)")
1649.             cursor.execute("DELETE FROM test_alunto_pony")
1650.         # Test flat unique_together
1651.         operation = migrations.AlterUniqueTogether("Pony", ("pink", "weight"))
1652.         operation.state_forwards("test_alunto", new_state)
1653.         self.assertEqual(len(new_state.models["test_alunto", "pony"].options.get("unique_together", set())), 1)
1654.         # And deconstruction
1655.         definition = operation.deconstruct()
1656.         self.assertEqual(definition[0], "AlterUniqueTogether")
1657.         self.assertEqual(definition[1], [])
1658.         self.assertEqual(definition[2], {'name': "Pony", 'unique_together': {("pink", "weight")}})
1659. 
1660.     def test_alter_unique_together_remove(self):
1661.         operation = migrations.AlterUniqueTogether("Pony", None)
1662.         self.assertEqual(operation.describe(), "Alter unique_together for Pony (0 constraint(s))")
1663. 
1664.     def test_add_index(self):
1665.         """
1666.         Test the AddIndex operation.
1667.         """
1668.         project_state = self.set_up_test_model("test_adin")
1669.         msg = (
1670.             "Indexes passed to AddIndex operations require a name argument. "
1671.             "<Index: fields='pink'> doesn't have one."
1672.         )
1673.         with self.assertRaisesMessage(ValueError, msg):
1674.             migrations.AddIndex("Pony", models.Index(fields=["pink"]))
1675.         index = models.Index(fields=["pink"], name="test_adin_pony_pink_idx")
1676.         operation = migrations.AddIndex("Pony", index)
1677.         self.assertEqual(operation.describe(), "Create index test_adin_pony_pink_idx on field(s) pink of model Pony")
1678.         new_state = project_state.clone()
1679.         operation.state_forwards("test_adin", new_state)
1680.         # Test the database alteration
1681.         self.assertEqual(len(new_state.models["test_adin", "pony"].options['indexes']), 1)
1682.         self.assertIndexNotExists("test_adin_pony", ["pink"])
1683.         with connection.schema_editor() as editor:
1684.             operation.database_forwards("test_adin", editor, project_state, new_state)
1685.         self.assertIndexExists("test_adin_pony", ["pink"])
1686.         # And test reversal
1687.         with connection.schema_editor() as editor:
1688.             operation.database_backwards("test_adin", editor, new_state, project_state)
1689.         self.assertIndexNotExists("test_adin_pony", ["pink"])
1690.         # And deconstruction
1691.         definition = operation.deconstruct()
1692.         self.assertEqual(definition[0], "AddIndex")
1693.         self.assertEqual(definition[1], [])
1694.         self.assertEqual(definition[2], {'model_name': "Pony", 'index': index})
1695. 
1696.     def test_remove_index(self):
1697.         """
1698.         Test the RemoveIndex operation.
1699.         """
1700.         project_state = self.set_up_test_model("test_rmin", multicol_index=True)
1701.         self.assertTableExists("test_rmin_pony")
1702.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1703.         operation = migrations.RemoveIndex("Pony", "pony_test_idx")
1704.         self.assertEqual(operation.describe(), "Remove index pony_test_idx from Pony")
1705.         new_state = project_state.clone()
1706.         operation.state_forwards("test_rmin", new_state)
1707.         # Test the state alteration
1708.         self.assertEqual(len(new_state.models["test_rmin", "pony"].options['indexes']), 0)
1709.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1710.         # Test the database alteration
1711.         with connection.schema_editor() as editor:
1712.             operation.database_forwards("test_rmin", editor, project_state, new_state)
1713.         self.assertIndexNotExists("test_rmin_pony", ["pink", "weight"])
1714.         # And test reversal
1715.         with connection.schema_editor() as editor:
1716.             operation.database_backwards("test_rmin", editor, new_state, project_state)
1717.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1718.         # And deconstruction
1719.         definition = operation.deconstruct()
1720.         self.assertEqual(definition[0], "RemoveIndex")
1721.         self.assertEqual(definition[1], [])
1722.         self.assertEqual(definition[2], {'model_name': "Pony", 'name': "pony_test_idx"})
1723. 
1724.         # Also test a field dropped with index - sqlite remake issue
1725.         operations = [
1726.             migrations.RemoveIndex("Pony", "pony_test_idx"),
1727.             migrations.RemoveField("Pony", "pink"),
1728.         ]
1729.         self.assertColumnExists("test_rmin_pony", "pink")
1730.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1731.         # Test database alteration
1732.         new_state = project_state.clone()
1733.         self.apply_operations('test_rmin', new_state, operations=operations)
1734.         self.assertColumnNotExists("test_rmin_pony", "pink")
1735.         self.assertIndexNotExists("test_rmin_pony", ["pink", "weight"])
1736.         # And test reversal
1737.         self.unapply_operations("test_rmin", project_state, operations=operations)
1738.         self.assertIndexExists("test_rmin_pony", ["pink", "weight"])
1739. 
1740.     def test_add_index_state_forwards(self):
1741.         project_state = self.set_up_test_model('test_adinsf')
1742.         index = models.Index(fields=['pink'], name='test_adinsf_pony_pink_idx')
1743.         old_model = project_state.apps.get_model('test_adinsf', 'Pony')
1744.         new_state = project_state.clone()
1745. 
1746.         operation = migrations.AddIndex('Pony', index)
1747.         operation.state_forwards('test_adinsf', new_state)
1748.         new_model = new_state.apps.get_model('test_adinsf', 'Pony')
1749.         self.assertIsNot(old_model, new_model)
1750. 
1751.     def test_remove_index_state_forwards(self):
1752.         project_state = self.set_up_test_model('test_rminsf')
1753.         index = models.Index(fields=['pink'], name='test_rminsf_pony_pink_idx')
1754.         migrations.AddIndex('Pony', index).state_forwards('test_rminsf', project_state)
1755.         old_model = project_state.apps.get_model('test_rminsf', 'Pony')
1756.         new_state = project_state.clone()
1757. 
1758.         operation = migrations.RemoveIndex('Pony', 'test_rminsf_pony_pink_idx')
1759.         operation.state_forwards('test_rminsf', new_state)
1760.         new_model = new_state.apps.get_model('test_rminsf', 'Pony')
1761.         self.assertIsNot(old_model, new_model)
1762. 
1763.     def test_alter_field_with_index(self):
1764.         """
1765.         Test AlterField operation with an index to ensure indexes created via
1766.         Meta.indexes don't get dropped with sqlite3 remake.
1767.         """
1768.         project_state = self.set_up_test_model("test_alflin", index=True)
1769.         operation = migrations.AlterField("Pony", "pink", models.IntegerField(null=True))
1770.         new_state = project_state.clone()
1771.         operation.state_forwards("test_alflin", new_state)
1772.         # Test the database alteration
1773.         self.assertColumnNotNull("test_alflin_pony", "pink")
1774.         with connection.schema_editor() as editor:
1775.             operation.database_forwards("test_alflin", editor, project_state, new_state)
1776.         # Index hasn't been dropped
1777.         self.assertIndexExists("test_alflin_pony", ["pink"])
1778.         # And test reversal
1779.         with connection.schema_editor() as editor:
1780.             operation.database_backwards("test_alflin", editor, new_state, project_state)
1781.         # Ensure the index is still there
1782.         self.assertIndexExists("test_alflin_pony", ["pink"])
1783. 
1784.     def test_alter_index_together(self):
1785.         """
1786.         Tests the AlterIndexTogether operation.
1787.         """
1788.         project_state = self.set_up_test_model("test_alinto")
1789.         # Test the state alteration
1790.         operation = migrations.AlterIndexTogether("Pony", [("pink", "weight")])
1791.         self.assertEqual(operation.describe(), "Alter index_together for Pony (1 constraint(s))")
1792.         new_state = project_state.clone()
1793.         operation.state_forwards("test_alinto", new_state)
1794.         self.assertEqual(len(project_state.models["test_alinto", "pony"].options.get("index_together", set())), 0)
1795.         self.assertEqual(len(new_state.models["test_alinto", "pony"].options.get("index_together", set())), 1)
1796.         # Make sure there's no matching index
1797.         self.assertIndexNotExists("test_alinto_pony", ["pink", "weight"])
1798.         # Test the database alteration
1799.         with connection.schema_editor() as editor:
1800.             operation.database_forwards("test_alinto", editor, project_state, new_state)
1801.         self.assertIndexExists("test_alinto_pony", ["pink", "weight"])
1802.         # And test reversal
1803.         with connection.schema_editor() as editor:
1804.             operation.database_backwards("test_alinto", editor, new_state, project_state)
1805.         self.assertIndexNotExists("test_alinto_pony", ["pink", "weight"])
1806.         # And deconstruction
1807.         definition = operation.deconstruct()
1808.         self.assertEqual(definition[0], "AlterIndexTogether")
1809.         self.assertEqual(definition[1], [])
1810.         self.assertEqual(definition[2], {'name': "Pony", 'index_together': {("pink", "weight")}})
1811. 
1812.     def test_alter_index_together_remove(self):
1813.         operation = migrations.AlterIndexTogether("Pony", None)
1814.         self.assertEqual(operation.describe(), "Alter index_together for Pony (0 constraint(s))")
1815. 
1816.     @skipUnlessDBFeature('supports_table_check_constraints')
1817.     def test_add_constraint(self):
1818.         project_state = self.set_up_test_model("test_addconstraint")
1819.         gt_check = models.Q(pink__gt=2)
1820.         gt_constraint = models.CheckConstraint(check=gt_check, name="test_add_constraint_pony_pink_gt_2")
1821.         gt_operation = migrations.AddConstraint("Pony", gt_constraint)
1822.         self.assertEqual(
1823.             gt_operation.describe(), "Create constraint test_add_constraint_pony_pink_gt_2 on model Pony"
1824.         )
1825.         # Test the state alteration
1826.         new_state = project_state.clone()
1827.         gt_operation.state_forwards("test_addconstraint", new_state)
1828.         self.assertEqual(len(new_state.models["test_addconstraint", "pony"].options["constraints"]), 1)
1829.         Pony = new_state.apps.get_model("test_addconstraint", "Pony")
1830.         self.assertEqual(len(Pony._meta.constraints), 1)
1831.         # Test the database alteration
1832.         with connection.schema_editor() as editor:
1833.             gt_operation.database_forwards("test_addconstraint", editor, project_state, new_state)
1834.         with self.assertRaises(IntegrityError), transaction.atomic():
1835.             Pony.objects.create(pink=1, weight=1.0)
1836.         # Add another one.
1837.         lt_check = models.Q(pink__lt=100)
1838.         lt_constraint = models.CheckConstraint(check=lt_check, name="test_add_constraint_pony_pink_lt_100")
1839.         lt_operation = migrations.AddConstraint("Pony", lt_constraint)
1840.         lt_operation.state_forwards("test_addconstraint", new_state)
1841.         self.assertEqual(len(new_state.models["test_addconstraint", "pony"].options["constraints"]), 2)
1842.         Pony = new_state.apps.get_model("test_addconstraint", "Pony")
1843.         self.assertEqual(len(Pony._meta.constraints), 2)
1844.         with connection.schema_editor() as editor:
1845.             lt_operation.database_forwards("test_addconstraint", editor, project_state, new_state)
1846.         with self.assertRaises(IntegrityError), transaction.atomic():
1847.             Pony.objects.create(pink=100, weight=1.0)
1848.         # Test reversal
1849.         with connection.schema_editor() as editor:
1850.             gt_operation.database_backwards("test_addconstraint", editor, new_state, project_state)
1851.         Pony.objects.create(pink=1, weight=1.0)
1852.         # Test deconstruction
1853.         definition = gt_operation.deconstruct()
1854.         self.assertEqual(definition[0], "AddConstraint")
1855.         self.assertEqual(definition[1], [])
1856.         self.assertEqual(definition[2], {'model_name': "Pony", 'constraint': gt_constraint})
1857. 
1858.     @skipUnlessDBFeature('supports_table_check_constraints')
1859.     def test_add_constraint_percent_escaping(self):
1860.         app_label = 'add_constraint_string_quoting'
1861.         operations = [
1862.             CreateModel(
1863.                 'Author',
1864.                 fields=[
1865.                     ('id', models.AutoField(primary_key=True)),
1866.                     ('name', models.CharField(max_length=100)),
1867.                     ('rebate', models.CharField(max_length=100)),
1868.                 ],
1869.             ),
1870.         ]
1871.         from_state = self.apply_operations(app_label, ProjectState(), operations)
1872.         # "%" generated in startswith lookup should be escaped in a way that is
1873.         # considered a leading wildcard.
1874.         check = models.Q(name__startswith='Albert')
1875.         constraint = models.CheckConstraint(check=check, name='name_constraint')
1876.         operation = migrations.AddConstraint('Author', constraint)
1877.         to_state = from_state.clone()
1878.         operation.state_forwards(app_label, to_state)
1879.         with connection.schema_editor() as editor:
1880.             operation.database_forwards(app_label, editor, from_state, to_state)
1881.         Author = to_state.apps.get_model(app_label, 'Author')
1882.         with self.assertRaises(IntegrityError), transaction.atomic():
1883.             Author.objects.create(name='Artur')
1884.         # Literal "%" should be escaped in a way that is not a considered a
1885.         # wildcard.
1886.         check = models.Q(rebate__endswith='%')
1887.         constraint = models.CheckConstraint(check=check, name='rebate_constraint')
1888.         operation = migrations.AddConstraint('Author', constraint)
1889.         from_state = to_state
1890.         to_state = from_state.clone()
1891.         operation.state_forwards(app_label, to_state)
1892.         Author = to_state.apps.get_model(app_label, 'Author')
1893.         with connection.schema_editor() as editor:
1894.             operation.database_forwards(app_label, editor, from_state, to_state)
1895.         Author = to_state.apps.get_model(app_label, 'Author')
1896.         with self.assertRaises(IntegrityError), transaction.atomic():
1897.             Author.objects.create(name='Albert', rebate='10$')
1898.         author = Author.objects.create(name='Albert', rebate='10%')
1899.         self.assertEqual(Author.objects.get(), author)
1900. 
1901.     @skipUnlessDBFeature('supports_table_check_constraints')
1902.     def test_add_or_constraint(self):
1903.         app_label = 'test_addorconstraint'
1904.         constraint_name = 'add_constraint_or'
1905.         from_state = self.set_up_test_model(app_label)
1906.         check = models.Q(pink__gt=2, weight__gt=2) | models.Q(weight__lt=0)
1907.         constraint = models.CheckConstraint(check=check, name=constraint_name)
1908.         operation = migrations.AddConstraint('Pony', constraint)
1909.         to_state = from_state.clone()
1910.         operation.state_forwards(app_label, to_state)
1911.         with connection.schema_editor() as editor:
1912.             operation.database_forwards(app_label, editor, from_state, to_state)
1913.         Pony = to_state.apps.get_model(app_label, 'Pony')
1914.         with self.assertRaises(IntegrityError), transaction.atomic():
1915.             Pony.objects.create(pink=2, weight=3.0)
1916.         with self.assertRaises(IntegrityError), transaction.atomic():
1917.             Pony.objects.create(pink=3, weight=1.0)
1918.         Pony.objects.bulk_create([
1919.             Pony(pink=3, weight=-1.0),
1920.             Pony(pink=1, weight=-1.0),
1921.             Pony(pink=3, weight=3.0),
1922.         ])
1923. 
1924.     @skipUnlessDBFeature('supports_table_check_constraints')
1925.     def test_remove_constraint(self):
1926.         project_state = self.set_up_test_model("test_removeconstraint", constraints=[
1927.             models.CheckConstraint(check=models.Q(pink__gt=2), name="test_remove_constraint_pony_pink_gt_2"),
1928.             models.CheckConstraint(check=models.Q(pink__lt=100), name="test_remove_constraint_pony_pink_lt_100"),
1929.         ])
1930.         gt_operation = migrations.RemoveConstraint("Pony", "test_remove_constraint_pony_pink_gt_2")
1931.         self.assertEqual(
1932.             gt_operation.describe(), "Remove constraint test_remove_constraint_pony_pink_gt_2 from model Pony"
1933.         )
1934.         # Test state alteration
1935.         new_state = project_state.clone()
1936.         gt_operation.state_forwards("test_removeconstraint", new_state)
1937.         self.assertEqual(len(new_state.models["test_removeconstraint", "pony"].options['constraints']), 1)
1938.         Pony = new_state.apps.get_model("test_removeconstraint", "Pony")
1939.         self.assertEqual(len(Pony._meta.constraints), 1)
1940.         # Test database alteration
1941.         with connection.schema_editor() as editor:
1942.             gt_operation.database_forwards("test_removeconstraint", editor, project_state, new_state)
1943.         Pony.objects.create(pink=1, weight=1.0).delete()
1944.         with self.assertRaises(IntegrityError), transaction.atomic():
1945.             Pony.objects.create(pink=100, weight=1.0)
1946.         # Remove the other one.
1947.         lt_operation = migrations.RemoveConstraint("Pony", "test_remove_constraint_pony_pink_lt_100")
1948.         lt_operation.state_forwards("test_removeconstraint", new_state)
1949.         self.assertEqual(len(new_state.models["test_removeconstraint", "pony"].options['constraints']), 0)
1950.         Pony = new_state.apps.get_model("test_removeconstraint", "Pony")
1951.         self.assertEqual(len(Pony._meta.constraints), 0)
1952.         with connection.schema_editor() as editor:
1953.             lt_operation.database_forwards("test_removeconstraint", editor, project_state, new_state)
1954.         Pony.objects.create(pink=100, weight=1.0).delete()
1955.         # Test reversal
1956.         with connection.schema_editor() as editor:
1957.             gt_operation.database_backwards("test_removeconstraint", editor, new_state, project_state)
1958.         with self.assertRaises(IntegrityError), transaction.atomic():
1959.             Pony.objects.create(pink=1, weight=1.0)
1960.         # Test deconstruction
1961.         definition = gt_operation.deconstruct()
1962.         self.assertEqual(definition[0], "RemoveConstraint")
1963.         self.assertEqual(definition[1], [])
1964.         self.assertEqual(definition[2], {'model_name': "Pony", 'name': "test_remove_constraint_pony_pink_gt_2"})
1965. 
1966.     def test_add_partial_unique_constraint(self):
1967.         project_state = self.set_up_test_model('test_addpartialuniqueconstraint')
1968.         partial_unique_constraint = models.UniqueConstraint(
1969.             fields=['pink'],
1970.             condition=models.Q(weight__gt=5),
1971.             name='test_constraint_pony_pink_for_weight_gt_5_uniq',
1972.         )
1973.         operation = migrations.AddConstraint('Pony', partial_unique_constraint)
1974.         self.assertEqual(
1975.             operation.describe(),
1976.             'Create constraint test_constraint_pony_pink_for_weight_gt_5_uniq '
1977.             'on model Pony'
1978.         )
1979.         # Test the state alteration
1980.         new_state = project_state.clone()
1981.         operation.state_forwards('test_addpartialuniqueconstraint', new_state)
1982.         self.assertEqual(len(new_state.models['test_addpartialuniqueconstraint', 'pony'].options['constraints']), 1)
1983.         Pony = new_state.apps.get_model('test_addpartialuniqueconstraint', 'Pony')
1984.         self.assertEqual(len(Pony._meta.constraints), 1)
1985.         # Test the database alteration
1986.         with connection.schema_editor() as editor:
1987.             operation.database_forwards('test_addpartialuniqueconstraint', editor, project_state, new_state)
1988.         # Test constraint works
1989.         Pony.objects.create(pink=1, weight=4.0)
1990.         Pony.objects.create(pink=1, weight=4.0)
1991.         Pony.objects.create(pink=1, weight=6.0)
1992.         if connection.features.supports_partial_indexes:
1993.             with self.assertRaises(IntegrityError), transaction.atomic():
1994.                 Pony.objects.create(pink=1, weight=7.0)
1995.         else:
1996.             Pony.objects.create(pink=1, weight=7.0)
1997.         # Test reversal
1998.         with connection.schema_editor() as editor:
1999.             operation.database_backwards('test_addpartialuniqueconstraint', editor, new_state, project_state)
2000.         # Test constraint doesn't work
2001.         Pony.objects.create(pink=1, weight=7.0)
2002.         # Test deconstruction
2003.         definition = operation.deconstruct()
2004.         self.assertEqual(definition[0], 'AddConstraint')
2005.         self.assertEqual(definition[1], [])
2006.         self.assertEqual(definition[2], {'model_name': 'Pony', 'constraint': partial_unique_constraint})
2007. 
2008.     def test_remove_partial_unique_constraint(self):
2009.         project_state = self.set_up_test_model('test_removepartialuniqueconstraint', constraints=[
2010.             models.UniqueConstraint(
2011.                 fields=['pink'],
2012.                 condition=models.Q(weight__gt=5),
2013.                 name='test_constraint_pony_pink_for_weight_gt_5_uniq',
2014.             ),
2015.         ])
2016.         gt_operation = migrations.RemoveConstraint('Pony', 'test_constraint_pony_pink_for_weight_gt_5_uniq')
2017.         self.assertEqual(
2018.             gt_operation.describe(), 'Remove constraint test_constraint_pony_pink_for_weight_gt_5_uniq from model Pony'
2019.         )
2020.         # Test state alteration
2021.         new_state = project_state.clone()
2022.         gt_operation.state_forwards('test_removepartialuniqueconstraint', new_state)
2023.         self.assertEqual(len(new_state.models['test_removepartialuniqueconstraint', 'pony'].options['constraints']), 0)
2024.         Pony = new_state.apps.get_model('test_removepartialuniqueconstraint', 'Pony')
2025.         self.assertEqual(len(Pony._meta.constraints), 0)
2026.         # Test database alteration
2027.         with connection.schema_editor() as editor:
2028.             gt_operation.database_forwards('test_removepartialuniqueconstraint', editor, project_state, new_state)
2029.         # Test constraint doesn't work
2030.         Pony.objects.create(pink=1, weight=4.0)
2031.         Pony.objects.create(pink=1, weight=4.0)
2032.         Pony.objects.create(pink=1, weight=6.0)
2033.         Pony.objects.create(pink=1, weight=7.0).delete()
2034.         # Test reversal
2035.         with connection.schema_editor() as editor:
2036.             gt_operation.database_backwards('test_removepartialuniqueconstraint', editor, new_state, project_state)
2037.         # Test constraint works
2038.         if connection.features.supports_partial_indexes:
2039.             with self.assertRaises(IntegrityError), transaction.atomic():
2040.                 Pony.objects.create(pink=1, weight=7.0)
2041.         else:
2042.             Pony.objects.create(pink=1, weight=7.0)
2043.         # Test deconstruction
2044.         definition = gt_operation.deconstruct()
2045.         self.assertEqual(definition[0], 'RemoveConstraint')
2046.         self.assertEqual(definition[1], [])
2047.         self.assertEqual(definition[2], {
2048.             'model_name': 'Pony',
2049.             'name': 'test_constraint_pony_pink_for_weight_gt_5_uniq',
2050.         })
2051. 
2052.     def test_alter_model_options(self):
2053.         """
2054.         Tests the AlterModelOptions operation.
2055.         """
2056.         project_state = self.set_up_test_model("test_almoop")
2057.         # Test the state alteration (no DB alteration to test)
2058.         operation = migrations.AlterModelOptions("Pony", {"permissions": [("can_groom", "Can groom")]})
2059.         self.assertEqual(operation.describe(), "Change Meta options on Pony")
2060.         new_state = project_state.clone()
2061.         operation.state_forwards("test_almoop", new_state)
2062.         self.assertEqual(len(project_state.models["test_almoop", "pony"].options.get("permissions", [])), 0)
2063.         self.assertEqual(len(new_state.models["test_almoop", "pony"].options.get("permissions", [])), 1)
2064.         self.assertEqual(new_state.models["test_almoop", "pony"].options["permissions"][0][0], "can_groom")
2065.         # And deconstruction
2066.         definition = operation.deconstruct()
2067.         self.assertEqual(definition[0], "AlterModelOptions")
2068.         self.assertEqual(definition[1], [])
2069.         self.assertEqual(definition[2], {'name': "Pony", 'options': {"permissions": [("can_groom", "Can groom")]}})
2070. 
2071.     def test_alter_model_options_emptying(self):
2072.         """
2073.         The AlterModelOptions operation removes keys from the dict (#23121)
2074.         """
2075.         project_state = self.set_up_test_model("test_almoop", options=True)
2076.         # Test the state alteration (no DB alteration to test)
2077.         operation = migrations.AlterModelOptions("Pony", {})
2078.         self.assertEqual(operation.describe(), "Change Meta options on Pony")
2079.         new_state = project_state.clone()
2080.         operation.state_forwards("test_almoop", new_state)
2081.         self.assertEqual(len(project_state.models["test_almoop", "pony"].options.get("permissions", [])), 1)
2082.         self.assertEqual(len(new_state.models["test_almoop", "pony"].options.get("permissions", [])), 0)
2083.         # And deconstruction
2084.         definition = operation.deconstruct()
2085.         self.assertEqual(definition[0], "AlterModelOptions")
2086.         self.assertEqual(definition[1], [])
2087.         self.assertEqual(definition[2], {'name': "Pony", 'options': {}})
2088. 
2089.     def test_alter_order_with_respect_to(self):
2090.         """
2091.         Tests the AlterOrderWithRespectTo operation.
2092.         """
2093.         project_state = self.set_up_test_model("test_alorwrtto", related_model=True)
2094.         # Test the state alteration
2095.         operation = migrations.AlterOrderWithRespectTo("Rider", "pony")
2096.         self.assertEqual(operation.describe(), "Set order_with_respect_to on Rider to pony")
2097.         new_state = project_state.clone()
2098.         operation.state_forwards("test_alorwrtto", new_state)
2099.         self.assertIsNone(
2100.             project_state.models["test_alorwrtto", "rider"].options.get("order_with_respect_to", None)
2101.         )
2102.         self.assertEqual(
2103.             new_state.models["test_alorwrtto", "rider"].options.get("order_with_respect_to", None),
2104.             "pony"
2105.         )
2106.         # Make sure there's no matching index
2107.         self.assertColumnNotExists("test_alorwrtto_rider", "_order")
2108.         # Create some rows before alteration
2109.         rendered_state = project_state.apps
2110.         pony = rendered_state.get_model("test_alorwrtto", "Pony").objects.create(weight=50)
2111.         rendered_state.get_model("test_alorwrtto", "Rider").objects.create(pony=pony, friend_id=1)
2112.         rendered_state.get_model("test_alorwrtto", "Rider").objects.create(pony=pony, friend_id=2)
2113.         # Test the database alteration
2114.         with connection.schema_editor() as editor:
2115.             operation.database_forwards("test_alorwrtto", editor, project_state, new_state)
2116.         self.assertColumnExists("test_alorwrtto_rider", "_order")
2117.         # Check for correct value in rows
2118.         updated_riders = new_state.apps.get_model("test_alorwrtto", "Rider").objects.all()
2119.         self.assertEqual(updated_riders[0]._order, 0)
2120.         self.assertEqual(updated_riders[1]._order, 0)
2121.         # And test reversal
2122.         with connection.schema_editor() as editor:
2123.             operation.database_backwards("test_alorwrtto", editor, new_state, project_state)
2124.         self.assertColumnNotExists("test_alorwrtto_rider", "_order")
2125.         # And deconstruction
2126.         definition = operation.deconstruct()
2127.         self.assertEqual(definition[0], "AlterOrderWithRespectTo")
2128.         self.assertEqual(definition[1], [])
2129.         self.assertEqual(definition[2], {'name': "Rider", 'order_with_respect_to': "pony"})
2130. 
2131.     def test_alter_model_managers(self):
2132.         """
2133.         The managers on a model are set.
2134.         """
2135.         project_state = self.set_up_test_model("test_almoma")
2136.         # Test the state alteration
2137.         operation = migrations.AlterModelManagers(
2138.             "Pony",
2139.             managers=[
2140.                 ("food_qs", FoodQuerySet.as_manager()),
2141.                 ("food_mgr", FoodManager("a", "b")),
2142.                 ("food_mgr_kwargs", FoodManager("x", "y", 3, 4)),
2143.             ]
2144.         )
2145.         self.assertEqual(operation.describe(), "Change managers on Pony")
2146.         managers = project_state.models["test_almoma", "pony"].managers
2147.         self.assertEqual(managers, [])
2148. 
2149.         new_state = project_state.clone()
2150.         operation.state_forwards("test_almoma", new_state)
2151.         self.assertIn(("test_almoma", "pony"), new_state.models)
2152.         managers = new_state.models["test_almoma", "pony"].managers
2153.         self.assertEqual(managers[0][0], "food_qs")
2154.         self.assertIsInstance(managers[0][1], models.Manager)
2155.         self.assertEqual(managers[1][0], "food_mgr")
2156.         self.assertIsInstance(managers[1][1], FoodManager)
2157.         self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
2158.         self.assertEqual(managers[2][0], "food_mgr_kwargs")
2159.         self.assertIsInstance(managers[2][1], FoodManager)
2160.         self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
2161.         rendered_state = new_state.apps
2162.         model = rendered_state.get_model('test_almoma', 'pony')
2163.         self.assertIsInstance(model.food_qs, models.Manager)
2164.         self.assertIsInstance(model.food_mgr, FoodManager)
2165.         self.assertIsInstance(model.food_mgr_kwargs, FoodManager)
2166. 
2167.     def test_alter_model_managers_emptying(self):
2168.         """
2169.         The managers on a model are set.
2170.         """
2171.         project_state = self.set_up_test_model("test_almomae", manager_model=True)
2172.         # Test the state alteration
2173.         operation = migrations.AlterModelManagers("Food", managers=[])
2174.         self.assertEqual(operation.describe(), "Change managers on Food")
2175.         self.assertIn(("test_almomae", "food"), project_state.models)
2176.         managers = project_state.models["test_almomae", "food"].managers
2177.         self.assertEqual(managers[0][0], "food_qs")
2178.         self.assertIsInstance(managers[0][1], models.Manager)
2179.         self.assertEqual(managers[1][0], "food_mgr")
2180.         self.assertIsInstance(managers[1][1], FoodManager)
2181.         self.assertEqual(managers[1][1].args, ("a", "b", 1, 2))
2182.         self.assertEqual(managers[2][0], "food_mgr_kwargs")
2183.         self.assertIsInstance(managers[2][1], FoodManager)
2184.         self.assertEqual(managers[2][1].args, ("x", "y", 3, 4))
2185. 
2186.         new_state = project_state.clone()
2187.         operation.state_forwards("test_almomae", new_state)
2188.         managers = new_state.models["test_almomae", "food"].managers
2189.         self.assertEqual(managers, [])
2190. 
2191.     def test_alter_fk(self):
2192.         """
2193.         Creating and then altering an FK works correctly
2194.         and deals with the pending SQL (#23091)
2195.         """
2196.         project_state = self.set_up_test_model("test_alfk")
2197.         # Test adding and then altering the FK in one go
2198.         create_operation = migrations.CreateModel(
2199.             name="Rider",
2200.             fields=[
2201.                 ("id", models.AutoField(primary_key=True)),
2202.                 ("pony", models.ForeignKey("Pony", models.CASCADE)),
2203.             ],
2204.         )
2205.         create_state = project_state.clone()
2206.         create_operation.state_forwards("test_alfk", create_state)
2207.         alter_operation = migrations.AlterField(
2208.             model_name='Rider',
2209.             name='pony',
2210.             field=models.ForeignKey("Pony", models.CASCADE, editable=False),
2211.         )
2212.         alter_state = create_state.clone()
2213.         alter_operation.state_forwards("test_alfk", alter_state)
2214.         with connection.schema_editor() as editor:
2215.             create_operation.database_forwards("test_alfk", editor, project_state, create_state)
2216.             alter_operation.database_forwards("test_alfk", editor, create_state, alter_state)
2217. 
2218.     def test_alter_fk_non_fk(self):
2219.         """
2220.         Altering an FK to a non-FK works (#23244)
2221.         """
2222.         # Test the state alteration
2223.         operation = migrations.AlterField(
2224.             model_name="Rider",
2225.             name="pony",
2226.             field=models.FloatField(),
2227.         )
2228.         project_state, new_state = self.make_test_state("test_afknfk", operation, related_model=True)
2229.         # Test the database alteration
2230.         self.assertColumnExists("test_afknfk_rider", "pony_id")
2231.         self.assertColumnNotExists("test_afknfk_rider", "pony")
2232.         with connection.schema_editor() as editor:
2233.             operation.database_forwards("test_afknfk", editor, project_state, new_state)
2234.         self.assertColumnExists("test_afknfk_rider", "pony")
2235.         self.assertColumnNotExists("test_afknfk_rider", "pony_id")
2236.         # And test reversal
2237.         with connection.schema_editor() as editor:
2238.             operation.database_backwards("test_afknfk", editor, new_state, project_state)
2239.         self.assertColumnExists("test_afknfk_rider", "pony_id")
2240.         self.assertColumnNotExists("test_afknfk_rider", "pony")
2241. 
2242.     def test_run_sql(self):
2243.         """
2244.         Tests the RunSQL operation.
2245.         """
2246.         project_state = self.set_up_test_model("test_runsql")
2247.         # Create the operation
2248.         operation = migrations.RunSQL(
2249.             # Use a multi-line string with a comment to test splitting on SQLite and MySQL respectively
2250.             "CREATE TABLE i_love_ponies (id int, special_thing varchar(15));\n"
2251.             "INSERT INTO i_love_ponies (id, special_thing) VALUES (1, 'i love ponies'); -- this is magic!\n"
2252.             "INSERT INTO i_love_ponies (id, special_thing) VALUES (2, 'i love django');\n"
2253.             "UPDATE i_love_ponies SET special_thing = 'Ponies' WHERE special_thing LIKE '%%ponies';"
2254.             "UPDATE i_love_ponies SET special_thing = 'Django' WHERE special_thing LIKE '%django';",
2255. 
2256.             # Run delete queries to test for parameter substitution failure
2257.             # reported in #23426
2258.             "DELETE FROM i_love_ponies WHERE special_thing LIKE '%Django%';"
2259.             "DELETE FROM i_love_ponies WHERE special_thing LIKE '%%Ponies%%';"
2260.             "DROP TABLE i_love_ponies",
2261. 
2262.             state_operations=[migrations.CreateModel("SomethingElse", [("id", models.AutoField(primary_key=True))])],
2263.         )
2264.         self.assertEqual(operation.describe(), "Raw SQL operation")
2265.         # Test the state alteration
2266.         new_state = project_state.clone()
2267.         operation.state_forwards("test_runsql", new_state)
2268.         self.assertEqual(len(new_state.models["test_runsql", "somethingelse"].fields), 1)
2269.         # Make sure there's no table
2270.         self.assertTableNotExists("i_love_ponies")
2271.         # Test SQL collection
2272.         with connection.schema_editor(collect_sql=True) as editor:
2273.             operation.database_forwards("test_runsql", editor, project_state, new_state)
2274.             self.assertIn("LIKE '%%ponies';", "\n".join(editor.collected_sql))
2275.             operation.database_backwards("test_runsql", editor, project_state, new_state)
2276.             self.assertIn("LIKE '%%Ponies%%';", "\n".join(editor.collected_sql))
2277.         # Test the database alteration
2278.         with connection.schema_editor() as editor:
2279.             operation.database_forwards("test_runsql", editor, project_state, new_state)
2280.         self.assertTableExists("i_love_ponies")
2281.         # Make sure all the SQL was processed
2282.         with connection.cursor() as cursor:
2283.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
2284.             self.assertEqual(cursor.fetchall()[0][0], 2)
2285.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies WHERE special_thing = 'Django'")
2286.             self.assertEqual(cursor.fetchall()[0][0], 1)
2287.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies WHERE special_thing = 'Ponies'")
2288.             self.assertEqual(cursor.fetchall()[0][0], 1)
2289.         # And test reversal
2290.         self.assertTrue(operation.reversible)
2291.         with connection.schema_editor() as editor:
2292.             operation.database_backwards("test_runsql", editor, new_state, project_state)
2293.         self.assertTableNotExists("i_love_ponies")
2294.         # And deconstruction
2295.         definition = operation.deconstruct()
2296.         self.assertEqual(definition[0], "RunSQL")
2297.         self.assertEqual(definition[1], [])
2298.         self.assertEqual(sorted(definition[2]), ["reverse_sql", "sql", "state_operations"])
2299.         # And elidable reduction
2300.         self.assertIs(False, operation.reduce(operation, []))
2301.         elidable_operation = migrations.RunSQL('SELECT 1 FROM void;', elidable=True)
2302.         self.assertEqual(elidable_operation.reduce(operation, []), [operation])
2303. 
2304.     def test_run_sql_params(self):
2305.         """
2306.         #23426 - RunSQL should accept parameters.
2307.         """
2308.         project_state = self.set_up_test_model("test_runsql")
2309.         # Create the operation
2310.         operation = migrations.RunSQL(
2311.             ["CREATE TABLE i_love_ponies (id int, special_thing varchar(15));"],
2312.             ["DROP TABLE i_love_ponies"],
2313.         )
2314.         param_operation = migrations.RunSQL(
2315.             # forwards
2316.             (
2317.                 "INSERT INTO i_love_ponies (id, special_thing) VALUES (1, 'Django');",
2318.                 ["INSERT INTO i_love_ponies (id, special_thing) VALUES (2, %s);", ['Ponies']],
2319.                 ("INSERT INTO i_love_ponies (id, special_thing) VALUES (%s, %s);", (3, 'Python',)),
2320.             ),
2321.             # backwards
2322.             [
2323.                 "DELETE FROM i_love_ponies WHERE special_thing = 'Django';",
2324.                 ["DELETE FROM i_love_ponies WHERE special_thing = 'Ponies';", None],
2325.                 ("DELETE FROM i_love_ponies WHERE id = %s OR special_thing = %s;", [3, 'Python']),
2326.             ]
2327.         )
2328. 
2329.         # Make sure there's no table
2330.         self.assertTableNotExists("i_love_ponies")
2331.         new_state = project_state.clone()
2332.         # Test the database alteration
2333.         with connection.schema_editor() as editor:
2334.             operation.database_forwards("test_runsql", editor, project_state, new_state)
2335. 
2336.         # Test parameter passing
2337.         with connection.schema_editor() as editor:
2338.             param_operation.database_forwards("test_runsql", editor, project_state, new_state)
2339.         # Make sure all the SQL was processed
2340.         with connection.cursor() as cursor:
2341.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
2342.             self.assertEqual(cursor.fetchall()[0][0], 3)
2343. 
2344.         with connection.schema_editor() as editor:
2345.             param_operation.database_backwards("test_runsql", editor, new_state, project_state)
2346.         with connection.cursor() as cursor:
2347.             cursor.execute("SELECT COUNT(*) FROM i_love_ponies")
2348.             self.assertEqual(cursor.fetchall()[0][0], 0)
2349. 
2350.         # And test reversal
2351.         with connection.schema_editor() as editor:
2352.             operation.database_backwards("test_runsql", editor, new_state, project_state)
2353.         self.assertTableNotExists("i_love_ponies")
2354. 
2355.     def test_run_sql_params_invalid(self):
2356.         """
2357.         #23426 - RunSQL should fail when a list of statements with an incorrect
2358.         number of tuples is given.
2359.         """
2360.         project_state = self.set_up_test_model("test_runsql")
2361.         new_state = project_state.clone()
2362.         operation = migrations.RunSQL(
2363.             # forwards
2364.             [
2365.                 ["INSERT INTO foo (bar) VALUES ('buz');"]
2366.             ],
2367.             # backwards
2368.             (
2369.                 ("DELETE FROM foo WHERE bar = 'buz';", 'invalid', 'parameter count'),
2370.             ),
2371.         )
2372. 
2373.         with connection.schema_editor() as editor:
2374.             with self.assertRaisesMessage(ValueError, "Expected a 2-tuple but got 1"):
2375.                 operation.database_forwards("test_runsql", editor, project_state, new_state)
2376. 
2377.         with connection.schema_editor() as editor:
2378.             with self.assertRaisesMessage(ValueError, "Expected a 2-tuple but got 3"):
2379.                 operation.database_backwards("test_runsql", editor, new_state, project_state)
2380. 
2381.     def test_run_sql_noop(self):
2382.         """
2383.         #24098 - Tests no-op RunSQL operations.
2384.         """
2385.         operation = migrations.RunSQL(migrations.RunSQL.noop, migrations.RunSQL.noop)
2386.         with connection.schema_editor() as editor:
2387.             operation.database_forwards("test_runsql", editor, None, None)
2388.             operation.database_backwards("test_runsql", editor, None, None)
2389. 
2390.     def test_run_python(self):
2391.         """
2392.         Tests the RunPython operation
2393.         """
2394. 
2395.         project_state = self.set_up_test_model("test_runpython", mti_model=True)
2396. 
2397.         # Create the operation
2398.         def inner_method(models, schema_editor):
2399.             Pony = models.get_model("test_runpython", "Pony")
2400.             Pony.objects.create(pink=1, weight=3.55)
2401.             Pony.objects.create(weight=5)
2402. 
2403.         def inner_method_reverse(models, schema_editor):
2404.             Pony = models.get_model("test_runpython", "Pony")
2405.             Pony.objects.filter(pink=1, weight=3.55).delete()
2406.             Pony.objects.filter(weight=5).delete()
2407.         operation = migrations.RunPython(inner_method, reverse_code=inner_method_reverse)
2408.         self.assertEqual(operation.describe(), "Raw Python operation")
2409.         # Test the state alteration does nothing
2410.         new_state = project_state.clone()
2411.         operation.state_forwards("test_runpython", new_state)
2412.         self.assertEqual(new_state, project_state)
2413.         # Test the database alteration
2414.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 0)
2415.         with connection.schema_editor() as editor:
2416.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2417.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 2)
2418.         # Now test reversal
2419.         self.assertTrue(operation.reversible)
2420.         with connection.schema_editor() as editor:
2421.             operation.database_backwards("test_runpython", editor, project_state, new_state)
2422.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 0)
2423.         # Now test we can't use a string
2424.         with self.assertRaisesMessage(ValueError, 'RunPython must be supplied with a callable'):
2425.             migrations.RunPython("print 'ahahaha'")
2426.         # And deconstruction
2427.         definition = operation.deconstruct()
2428.         self.assertEqual(definition[0], "RunPython")
2429.         self.assertEqual(definition[1], [])
2430.         self.assertEqual(sorted(definition[2]), ["code", "reverse_code"])
2431. 
2432.         # Also test reversal fails, with an operation identical to above but without reverse_code set
2433.         no_reverse_operation = migrations.RunPython(inner_method)
2434.         self.assertFalse(no_reverse_operation.reversible)
2435.         with connection.schema_editor() as editor:
2436.             no_reverse_operation.database_forwards("test_runpython", editor, project_state, new_state)
2437.             with self.assertRaises(NotImplementedError):
2438.                 no_reverse_operation.database_backwards("test_runpython", editor, new_state, project_state)
2439.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 2)
2440. 
2441.         def create_ponies(models, schema_editor):
2442.             Pony = models.get_model("test_runpython", "Pony")
2443.             pony1 = Pony.objects.create(pink=1, weight=3.55)
2444.             self.assertIsNot(pony1.pk, None)
2445.             pony2 = Pony.objects.create(weight=5)
2446.             self.assertIsNot(pony2.pk, None)
2447.             self.assertNotEqual(pony1.pk, pony2.pk)
2448. 
2449.         operation = migrations.RunPython(create_ponies)
2450.         with connection.schema_editor() as editor:
2451.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2452.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 4)
2453.         # And deconstruction
2454.         definition = operation.deconstruct()
2455.         self.assertEqual(definition[0], "RunPython")
2456.         self.assertEqual(definition[1], [])
2457.         self.assertEqual(sorted(definition[2]), ["code"])
2458. 
2459.         def create_shetlandponies(models, schema_editor):
2460.             ShetlandPony = models.get_model("test_runpython", "ShetlandPony")
2461.             pony1 = ShetlandPony.objects.create(weight=4.0)
2462.             self.assertIsNot(pony1.pk, None)
2463.             pony2 = ShetlandPony.objects.create(weight=5.0)
2464.             self.assertIsNot(pony2.pk, None)
2465.             self.assertNotEqual(pony1.pk, pony2.pk)
2466. 
2467.         operation = migrations.RunPython(create_shetlandponies)
2468.         with connection.schema_editor() as editor:
2469.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2470.         self.assertEqual(project_state.apps.get_model("test_runpython", "Pony").objects.count(), 6)
2471.         self.assertEqual(project_state.apps.get_model("test_runpython", "ShetlandPony").objects.count(), 2)
2472.         # And elidable reduction
2473.         self.assertIs(False, operation.reduce(operation, []))
2474.         elidable_operation = migrations.RunPython(inner_method, elidable=True)
2475.         self.assertEqual(elidable_operation.reduce(operation, []), [operation])
2476. 
2477.     def test_run_python_atomic(self):
2478.         """
2479.         Tests the RunPython operation correctly handles the "atomic" keyword
2480.         """
2481.         project_state = self.set_up_test_model("test_runpythonatomic", mti_model=True)
2482. 
2483.         def inner_method(models, schema_editor):
2484.             Pony = models.get_model("test_runpythonatomic", "Pony")
2485.             Pony.objects.create(pink=1, weight=3.55)
2486.             raise ValueError("Adrian hates ponies.")
2487. 
2488.         # Verify atomicity when applying.
2489.         atomic_migration = Migration("test", "test_runpythonatomic")
2490.         atomic_migration.operations = [migrations.RunPython(inner_method, reverse_code=inner_method)]
2491.         non_atomic_migration = Migration("test", "test_runpythonatomic")
2492.         non_atomic_migration.operations = [migrations.RunPython(inner_method, reverse_code=inner_method, atomic=False)]
2493.         # If we're a fully-transactional database, both versions should rollback
2494.         if connection.features.can_rollback_ddl:
2495.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2496.             with self.assertRaises(ValueError):
2497.                 with connection.schema_editor() as editor:
2498.                     atomic_migration.apply(project_state, editor)
2499.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2500.             with self.assertRaises(ValueError):
2501.                 with connection.schema_editor() as editor:
2502.                     non_atomic_migration.apply(project_state, editor)
2503.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2504.         # Otherwise, the non-atomic operation should leave a row there
2505.         else:
2506.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2507.             with self.assertRaises(ValueError):
2508.                 with connection.schema_editor() as editor:
2509.                     atomic_migration.apply(project_state, editor)
2510.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2511.             with self.assertRaises(ValueError):
2512.                 with connection.schema_editor() as editor:
2513.                     non_atomic_migration.apply(project_state, editor)
2514.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 1)
2515.         # Reset object count to zero and verify atomicity when unapplying.
2516.         project_state.apps.get_model("test_runpythonatomic", "Pony").objects.all().delete()
2517.         # On a fully-transactional database, both versions rollback.
2518.         if connection.features.can_rollback_ddl:
2519.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2520.             with self.assertRaises(ValueError):
2521.                 with connection.schema_editor() as editor:
2522.                     atomic_migration.unapply(project_state, editor)
2523.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2524.             with self.assertRaises(ValueError):
2525.                 with connection.schema_editor() as editor:
2526.                     non_atomic_migration.unapply(project_state, editor)
2527.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2528.         # Otherwise, the non-atomic operation leaves a row there.
2529.         else:
2530.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2531.             with self.assertRaises(ValueError):
2532.                 with connection.schema_editor() as editor:
2533.                     atomic_migration.unapply(project_state, editor)
2534.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 0)
2535.             with self.assertRaises(ValueError):
2536.                 with connection.schema_editor() as editor:
2537.                     non_atomic_migration.unapply(project_state, editor)
2538.             self.assertEqual(project_state.apps.get_model("test_runpythonatomic", "Pony").objects.count(), 1)
2539.         # Verify deconstruction.
2540.         definition = non_atomic_migration.operations[0].deconstruct()
2541.         self.assertEqual(definition[0], "RunPython")
2542.         self.assertEqual(definition[1], [])
2543.         self.assertEqual(sorted(definition[2]), ["atomic", "code", "reverse_code"])
2544. 
2545.     def test_run_python_related_assignment(self):
2546.         """
2547.         #24282 - Model changes to a FK reverse side update the model
2548.         on the FK side as well.
2549.         """
2550. 
2551.         def inner_method(models, schema_editor):
2552.             Author = models.get_model("test_authors", "Author")
2553.             Book = models.get_model("test_books", "Book")
2554.             author = Author.objects.create(name="Hemingway")
2555.             Book.objects.create(title="Old Man and The Sea", author=author)
2556. 
2557.         create_author = migrations.CreateModel(
2558.             "Author",
2559.             [
2560.                 ("id", models.AutoField(primary_key=True)),
2561.                 ("name", models.CharField(max_length=100)),
2562.             ],
2563.             options={},
2564.         )
2565.         create_book = migrations.CreateModel(
2566.             "Book",
2567.             [
2568.                 ("id", models.AutoField(primary_key=True)),
2569.                 ("title", models.CharField(max_length=100)),
2570.                 ("author", models.ForeignKey("test_authors.Author", models.CASCADE))
2571.             ],
2572.             options={},
2573.         )
2574.         add_hometown = migrations.AddField(
2575.             "Author",
2576.             "hometown",
2577.             models.CharField(max_length=100),
2578.         )
2579.         create_old_man = migrations.RunPython(inner_method, inner_method)
2580. 
2581.         project_state = ProjectState()
2582.         new_state = project_state.clone()
2583.         with connection.schema_editor() as editor:
2584.             create_author.state_forwards("test_authors", new_state)
2585.             create_author.database_forwards("test_authors", editor, project_state, new_state)
2586.         project_state = new_state
2587.         new_state = new_state.clone()
2588.         with connection.schema_editor() as editor:
2589.             create_book.state_forwards("test_books", new_state)
2590.             create_book.database_forwards("test_books", editor, project_state, new_state)
2591.         project_state = new_state
2592.         new_state = new_state.clone()
2593.         with connection.schema_editor() as editor:
2594.             add_hometown.state_forwards("test_authors", new_state)
2595.             add_hometown.database_forwards("test_authors", editor, project_state, new_state)
2596.         project_state = new_state
2597.         new_state = new_state.clone()
2598.         with connection.schema_editor() as editor:
2599.             create_old_man.state_forwards("test_books", new_state)
2600.             create_old_man.database_forwards("test_books", editor, project_state, new_state)
2601. 
2602.     def test_model_with_bigautofield(self):
2603.         """
2604.         A model with BigAutoField can be created.
2605.         """
2606.         def create_data(models, schema_editor):
2607.             Author = models.get_model("test_author", "Author")
2608.             Book = models.get_model("test_book", "Book")
2609.             author1 = Author.objects.create(name="Hemingway")
2610.             Book.objects.create(title="Old Man and The Sea", author=author1)
2611.             Book.objects.create(id=2 ** 33, title="A farewell to arms", author=author1)
2612. 
2613.             author2 = Author.objects.create(id=2 ** 33, name="Remarque")
2614.             Book.objects.create(title="All quiet on the western front", author=author2)
2615.             Book.objects.create(title="Arc de Triomphe", author=author2)
2616. 
2617.         create_author = migrations.CreateModel(
2618.             "Author",
2619.             [
2620.                 ("id", models.BigAutoField(primary_key=True)),
2621.                 ("name", models.CharField(max_length=100)),
2622.             ],
2623.             options={},
2624.         )
2625.         create_book = migrations.CreateModel(
2626.             "Book",
2627.             [
2628.                 ("id", models.BigAutoField(primary_key=True)),
2629.                 ("title", models.CharField(max_length=100)),
2630.                 ("author", models.ForeignKey(to="test_author.Author", on_delete=models.CASCADE))
2631.             ],
2632.             options={},
2633.         )
2634.         fill_data = migrations.RunPython(create_data)
2635. 
2636.         project_state = ProjectState()
2637.         new_state = project_state.clone()
2638.         with connection.schema_editor() as editor:
2639.             create_author.state_forwards("test_author", new_state)
2640.             create_author.database_forwards("test_author", editor, project_state, new_state)
2641. 
2642.         project_state = new_state
2643.         new_state = new_state.clone()
2644.         with connection.schema_editor() as editor:
2645.             create_book.state_forwards("test_book", new_state)
2646.             create_book.database_forwards("test_book", editor, project_state, new_state)
2647. 
2648.         project_state = new_state
2649.         new_state = new_state.clone()
2650.         with connection.schema_editor() as editor:
2651.             fill_data.state_forwards("fill_data", new_state)
2652.             fill_data.database_forwards("fill_data", editor, project_state, new_state)
2653. 
2654.     def test_autofield_foreignfield_growth(self):
2655.         """
2656.         A field may be migrated from AutoField to BigAutoField.
2657.         """
2658.         def create_initial_data(models, schema_editor):
2659.             Article = models.get_model("test_article", "Article")
2660.             Blog = models.get_model("test_blog", "Blog")
2661.             blog = Blog.objects.create(name="web development done right")
2662.             Article.objects.create(name="Frameworks", blog=blog)
2663.             Article.objects.create(name="Programming Languages", blog=blog)
2664. 
2665.         def create_big_data(models, schema_editor):
2666.             Article = models.get_model("test_article", "Article")
2667.             Blog = models.get_model("test_blog", "Blog")
2668.             blog2 = Blog.objects.create(name="Frameworks", id=2 ** 33)
2669.             Article.objects.create(name="Django", blog=blog2)
2670.             Article.objects.create(id=2 ** 33, name="Django2", blog=blog2)
2671. 
2672.         create_blog = migrations.CreateModel(
2673.             "Blog",
2674.             [
2675.                 ("id", models.AutoField(primary_key=True)),
2676.                 ("name", models.CharField(max_length=100)),
2677.             ],
2678.             options={},
2679.         )
2680.         create_article = migrations.CreateModel(
2681.             "Article",
2682.             [
2683.                 ("id", models.AutoField(primary_key=True)),
2684.                 ("blog", models.ForeignKey(to="test_blog.Blog", on_delete=models.CASCADE)),
2685.                 ("name", models.CharField(max_length=100)),
2686.                 ("data", models.TextField(default="")),
2687.             ],
2688.             options={},
2689.         )
2690.         fill_initial_data = migrations.RunPython(create_initial_data, create_initial_data)
2691.         fill_big_data = migrations.RunPython(create_big_data, create_big_data)
2692. 
2693.         grow_article_id = migrations.AlterField("Article", "id", models.BigAutoField(primary_key=True))
2694.         grow_blog_id = migrations.AlterField("Blog", "id", models.BigAutoField(primary_key=True))
2695. 
2696.         project_state = ProjectState()
2697.         new_state = project_state.clone()
2698.         with connection.schema_editor() as editor:
2699.             create_blog.state_forwards("test_blog", new_state)
2700.             create_blog.database_forwards("test_blog", editor, project_state, new_state)
2701. 
2702.         project_state = new_state
2703.         new_state = new_state.clone()
2704.         with connection.schema_editor() as editor:
2705.             create_article.state_forwards("test_article", new_state)
2706.             create_article.database_forwards("test_article", editor, project_state, new_state)
2707. 
2708.         project_state = new_state
2709.         new_state = new_state.clone()
2710.         with connection.schema_editor() as editor:
2711.             fill_initial_data.state_forwards("fill_initial_data", new_state)
2712.             fill_initial_data.database_forwards("fill_initial_data", editor, project_state, new_state)
2713. 
2714.         project_state = new_state
2715.         new_state = new_state.clone()
2716.         with connection.schema_editor() as editor:
2717.             grow_article_id.state_forwards("test_article", new_state)
2718.             grow_article_id.database_forwards("test_article", editor, project_state, new_state)
2719. 
2720.         state = new_state.clone()
2721.         article = state.apps.get_model("test_article.Article")
2722.         self.assertIsInstance(article._meta.pk, models.BigAutoField)
2723. 
2724.         project_state = new_state
2725.         new_state = new_state.clone()
2726.         with connection.schema_editor() as editor:
2727.             grow_blog_id.state_forwards("test_blog", new_state)
2728.             grow_blog_id.database_forwards("test_blog", editor, project_state, new_state)
2729. 
2730.         state = new_state.clone()
2731.         blog = state.apps.get_model("test_blog.Blog")
2732.         self.assertIsInstance(blog._meta.pk, models.BigAutoField)
2733. 
2734.         project_state = new_state
2735.         new_state = new_state.clone()
2736.         with connection.schema_editor() as editor:
2737.             fill_big_data.state_forwards("fill_big_data", new_state)
2738.             fill_big_data.database_forwards("fill_big_data", editor, project_state, new_state)
2739. 
2740.     def test_run_python_noop(self):
2741.         """
2742.         #24098 - Tests no-op RunPython operations.
2743.         """
2744.         project_state = ProjectState()
2745.         new_state = project_state.clone()
2746.         operation = migrations.RunPython(migrations.RunPython.noop, migrations.RunPython.noop)
2747.         with connection.schema_editor() as editor:
2748.             operation.database_forwards("test_runpython", editor, project_state, new_state)
2749.             operation.database_backwards("test_runpython", editor, new_state, project_state)
2750. 
2751.     def test_separate_database_and_state(self):
2752.         """
2753.         Tests the SeparateDatabaseAndState operation.
2754.         """
2755.         project_state = self.set_up_test_model("test_separatedatabaseandstate")
2756.         # Create the operation
2757.         database_operation = migrations.RunSQL(
2758.             "CREATE TABLE i_love_ponies (id int, special_thing int);",
2759.             "DROP TABLE i_love_ponies;"
2760.         )
2761.         state_operation = migrations.CreateModel("SomethingElse", [("id", models.AutoField(primary_key=True))])
2762.         operation = migrations.SeparateDatabaseAndState(
2763.             state_operations=[state_operation],
2764.             database_operations=[database_operation]
2765.         )
2766.         self.assertEqual(operation.describe(), "Custom state/database change combination")
2767.         # Test the state alteration
2768.         new_state = project_state.clone()
2769.         operation.state_forwards("test_separatedatabaseandstate", new_state)
2770.         self.assertEqual(len(new_state.models["test_separatedatabaseandstate", "somethingelse"].fields), 1)
2771.         # Make sure there's no table
2772.         self.assertTableNotExists("i_love_ponies")
2773.         # Test the database alteration
2774.         with connection.schema_editor() as editor:
2775.             operation.database_forwards("test_separatedatabaseandstate", editor, project_state, new_state)
2776.         self.assertTableExists("i_love_ponies")
2777.         # And test reversal
2778.         self.assertTrue(operation.reversible)
2779.         with connection.schema_editor() as editor:
2780.             operation.database_backwards("test_separatedatabaseandstate", editor, new_state, project_state)
2781.         self.assertTableNotExists("i_love_ponies")
2782.         # And deconstruction
2783.         definition = operation.deconstruct()
2784.         self.assertEqual(definition[0], "SeparateDatabaseAndState")
2785.         self.assertEqual(definition[1], [])
2786.         self.assertEqual(sorted(definition[2]), ["database_operations", "state_operations"])
2787. 
2788.     def test_separate_database_and_state2(self):
2789.         """
2790.         A complex SeparateDatabaseAndState operation: Multiple operations both
2791.         for state and database. Verify the state dependencies within each list
2792.         and that state ops don't affect the database.
2793.         """
2794.         app_label = "test_separatedatabaseandstate2"
2795.         project_state = self.set_up_test_model(app_label)
2796.         # Create the operation
2797.         database_operations = [
2798.             migrations.CreateModel(
2799.                 "ILovePonies",
2800.                 [("id", models.AutoField(primary_key=True))],
2801.                 options={"db_table": "iloveponies"},
2802.             ),
2803.             migrations.CreateModel(
2804.                 "ILoveMorePonies",
2805.                 # We use IntegerField and not AutoField because
2806.                 # the model is going to be deleted immediately
2807.                 # and with an AutoField this fails on Oracle
2808.                 [("id", models.IntegerField(primary_key=True))],
2809.                 options={"db_table": "ilovemoreponies"},
2810.             ),
2811.             migrations.DeleteModel("ILoveMorePonies"),
2812.             migrations.CreateModel(
2813.                 "ILoveEvenMorePonies",
2814.                 [("id", models.AutoField(primary_key=True))],
2815.                 options={"db_table": "iloveevenmoreponies"},
2816.             ),
2817.         ]
2818.         state_operations = [
2819.             migrations.CreateModel(
2820.                 "SomethingElse",
2821.                 [("id", models.AutoField(primary_key=True))],
2822.                 options={"db_table": "somethingelse"},
2823.             ),
2824.             migrations.DeleteModel("SomethingElse"),
2825.             migrations.CreateModel(
2826.                 "SomethingCompletelyDifferent",
2827.                 [("id", models.AutoField(primary_key=True))],
2828.                 options={"db_table": "somethingcompletelydifferent"},
2829.             ),
2830.         ]
2831.         operation = migrations.SeparateDatabaseAndState(
2832.             state_operations=state_operations,
2833.             database_operations=database_operations,
2834.         )
2835.         # Test the state alteration
2836.         new_state = project_state.clone()
2837.         operation.state_forwards(app_label, new_state)
2838. 
2839.         def assertModelsAndTables(after_db):
2840.             # Tables and models exist, or don't, as they should:
2841.             self.assertNotIn((app_label, "somethingelse"), new_state.models)
2842.             self.assertEqual(len(new_state.models[app_label, "somethingcompletelydifferent"].fields), 1)
2843.             self.assertNotIn((app_label, "iloveponiesonies"), new_state.models)
2844.             self.assertNotIn((app_label, "ilovemoreponies"), new_state.models)
2845.             self.assertNotIn((app_label, "iloveevenmoreponies"), new_state.models)
2846.             self.assertTableNotExists("somethingelse")
2847.             self.assertTableNotExists("somethingcompletelydifferent")
2848.             self.assertTableNotExists("ilovemoreponies")
2849.             if after_db:
2850.                 self.assertTableExists("iloveponies")
2851.                 self.assertTableExists("iloveevenmoreponies")
2852.             else:
2853.                 self.assertTableNotExists("iloveponies")
2854.                 self.assertTableNotExists("iloveevenmoreponies")
2855. 
2856.         assertModelsAndTables(after_db=False)
2857.         # Test the database alteration
2858.         with connection.schema_editor() as editor:
2859.             operation.database_forwards(app_label, editor, project_state, new_state)
2860.         assertModelsAndTables(after_db=True)
2861.         # And test reversal
2862.         self.assertTrue(operation.reversible)
2863.         with connection.schema_editor() as editor:
2864.             operation.database_backwards(app_label, editor, new_state, project_state)
2865.         assertModelsAndTables(after_db=False)


File: tests/multiple_database/tests.py
Line number range: 1 - 500
Content:
1. import datetime
2. import pickle
3. from io import StringIO
4. from operator import attrgetter
5. from unittest.mock import Mock
6. 
7. from django.contrib.auth.models import User
8. from django.contrib.contenttypes.models import ContentType
9. from django.core import management
10. from django.db import DEFAULT_DB_ALIAS, connections, router, transaction
11. from django.db.models import signals
12. from django.db.utils import ConnectionRouter
13. from django.test import SimpleTestCase, TestCase, override_settings
14. 
15. from .models import Book, Person, Pet, Review, UserProfile
16. from .routers import AuthRouter, TestRouter, WriteRouter
17. 
18. 
19. class QueryTestCase(TestCase):
20.     databases = {'default', 'other'}
21. 
22.     def test_db_selection(self):
23.         "Querysets will use the default database by default"
24.         self.assertEqual(Book.objects.db, DEFAULT_DB_ALIAS)
25.         self.assertEqual(Book.objects.all().db, DEFAULT_DB_ALIAS)
26. 
27.         self.assertEqual(Book.objects.using('other').db, 'other')
28. 
29.         self.assertEqual(Book.objects.db_manager('other').db, 'other')
30.         self.assertEqual(Book.objects.db_manager('other').all().db, 'other')
31. 
32.     def test_default_creation(self):
33.         "Objects created on the default database don't leak onto other databases"
34.         # Create a book on the default database using create()
35.         Book.objects.create(title="Pro Django", published=datetime.date(2008, 12, 16))
36. 
37.         # Create a book on the default database using a save
38.         dive = Book()
39.         dive.title = "Dive into Python"
40.         dive.published = datetime.date(2009, 5, 4)
41.         dive.save()
42. 
43.         # Book exists on the default database, but not on other database
44.         try:
45.             Book.objects.get(title="Pro Django")
46.             Book.objects.using('default').get(title="Pro Django")
47.         except Book.DoesNotExist:
48.             self.fail('"Pro Django" should exist on default database')
49. 
50.         with self.assertRaises(Book.DoesNotExist):
51.             Book.objects.using('other').get(title="Pro Django")
52. 
53.         try:
54.             Book.objects.get(title="Dive into Python")
55.             Book.objects.using('default').get(title="Dive into Python")
56.         except Book.DoesNotExist:
57.             self.fail('"Dive into Python" should exist on default database')
58. 
59.         with self.assertRaises(Book.DoesNotExist):
60.             Book.objects.using('other').get(title="Dive into Python")
61. 
62.     def test_other_creation(self):
63.         "Objects created on another database don't leak onto the default database"
64.         # Create a book on the second database
65.         Book.objects.using('other').create(title="Pro Django",
66.                                            published=datetime.date(2008, 12, 16))
67. 
68.         # Create a book on the default database using a save
69.         dive = Book()
70.         dive.title = "Dive into Python"
71.         dive.published = datetime.date(2009, 5, 4)
72.         dive.save(using='other')
73. 
74.         # Book exists on the default database, but not on other database
75.         try:
76.             Book.objects.using('other').get(title="Pro Django")
77.         except Book.DoesNotExist:
78.             self.fail('"Pro Django" should exist on other database')
79. 
80.         with self.assertRaises(Book.DoesNotExist):
81.             Book.objects.get(title="Pro Django")
82.         with self.assertRaises(Book.DoesNotExist):
83.             Book.objects.using('default').get(title="Pro Django")
84. 
85.         try:
86.             Book.objects.using('other').get(title="Dive into Python")
87.         except Book.DoesNotExist:
88.             self.fail('"Dive into Python" should exist on other database')
89. 
90.         with self.assertRaises(Book.DoesNotExist):
91.             Book.objects.get(title="Dive into Python")
92.         with self.assertRaises(Book.DoesNotExist):
93.             Book.objects.using('default').get(title="Dive into Python")
94. 
95.     def test_refresh(self):
96.         dive = Book(title="Dive into Python", published=datetime.date(2009, 5, 4))
97.         dive.save(using='other')
98.         dive2 = Book.objects.using('other').get()
99.         dive2.title = "Dive into Python (on default)"
100.         dive2.save(using='default')
101.         dive.refresh_from_db()
102.         self.assertEqual(dive.title, "Dive into Python")
103.         dive.refresh_from_db(using='default')
104.         self.assertEqual(dive.title, "Dive into Python (on default)")
105.         self.assertEqual(dive._state.db, "default")
106. 
107.     def test_refresh_router_instance_hint(self):
108.         router = Mock()
109.         router.db_for_read.return_value = None
110.         book = Book.objects.create(title='Dive Into Python', published=datetime.date(1957, 10, 12))
111.         with self.settings(DATABASE_ROUTERS=[router]):
112.             book.refresh_from_db()
113.         router.db_for_read.assert_called_once_with(Book, instance=book)
114. 
115.     def test_basic_queries(self):
116.         "Queries are constrained to a single database"
117.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
118. 
119.         dive = Book.objects.using('other').get(published=datetime.date(2009, 5, 4))
120.         self.assertEqual(dive.title, "Dive into Python")
121.         with self.assertRaises(Book.DoesNotExist):
122.             Book.objects.using('default').get(published=datetime.date(2009, 5, 4))
123. 
124.         dive = Book.objects.using('other').get(title__icontains="dive")
125.         self.assertEqual(dive.title, "Dive into Python")
126.         with self.assertRaises(Book.DoesNotExist):
127.             Book.objects.using('default').get(title__icontains="dive")
128. 
129.         dive = Book.objects.using('other').get(title__iexact="dive INTO python")
130.         self.assertEqual(dive.title, "Dive into Python")
131.         with self.assertRaises(Book.DoesNotExist):
132.             Book.objects.using('default').get(title__iexact="dive INTO python")
133. 
134.         dive = Book.objects.using('other').get(published__year=2009)
135.         self.assertEqual(dive.title, "Dive into Python")
136.         self.assertEqual(dive.published, datetime.date(2009, 5, 4))
137.         with self.assertRaises(Book.DoesNotExist):
138.             Book.objects.using('default').get(published__year=2009)
139. 
140.         years = Book.objects.using('other').dates('published', 'year')
141.         self.assertEqual([o.year for o in years], [2009])
142.         years = Book.objects.using('default').dates('published', 'year')
143.         self.assertEqual([o.year for o in years], [])
144. 
145.         months = Book.objects.using('other').dates('published', 'month')
146.         self.assertEqual([o.month for o in months], [5])
147.         months = Book.objects.using('default').dates('published', 'month')
148.         self.assertEqual([o.month for o in months], [])
149. 
150.     def test_m2m_separation(self):
151.         "M2M fields are constrained to a single database"
152.         # Create a book and author on the default database
153.         pro = Book.objects.create(title="Pro Django",
154.                                   published=datetime.date(2008, 12, 16))
155. 
156.         marty = Person.objects.create(name="Marty Alchin")
157. 
158.         # Create a book and author on the other database
159.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
160. 
161.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
162. 
163.         # Save the author relations
164.         pro.authors.set([marty])
165.         dive.authors.set([mark])
166. 
167.         # Inspect the m2m tables directly.
168.         # There should be 1 entry in each database
169.         self.assertEqual(Book.authors.through.objects.using('default').count(), 1)
170.         self.assertEqual(Book.authors.through.objects.using('other').count(), 1)
171. 
172.         # Queries work across m2m joins
173.         self.assertEqual(
174.             list(Book.objects.using('default').filter(authors__name='Marty Alchin').values_list('title', flat=True)),
175.             ['Pro Django']
176.         )
177.         self.assertEqual(
178.             list(Book.objects.using('other').filter(authors__name='Marty Alchin').values_list('title', flat=True)),
179.             []
180.         )
181. 
182.         self.assertEqual(
183.             list(Book.objects.using('default').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
184.             []
185.         )
186.         self.assertEqual(
187.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
188.             ['Dive into Python']
189.         )
190. 
191.         # Reget the objects to clear caches
192.         dive = Book.objects.using('other').get(title="Dive into Python")
193.         mark = Person.objects.using('other').get(name="Mark Pilgrim")
194. 
195.         # Retrieve related object by descriptor. Related objects should be database-bound
196.         self.assertEqual(list(dive.authors.all().values_list('name', flat=True)), ['Mark Pilgrim'])
197. 
198.         self.assertEqual(list(mark.book_set.all().values_list('title', flat=True)), ['Dive into Python'])
199. 
200.     def test_m2m_forward_operations(self):
201.         "M2M forward manipulations are all constrained to a single DB"
202.         # Create a book and author on the other database
203.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
204.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
205. 
206.         # Save the author relations
207.         dive.authors.set([mark])
208. 
209.         # Add a second author
210.         john = Person.objects.using('other').create(name="John Smith")
211.         self.assertEqual(
212.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
213.             []
214.         )
215. 
216.         dive.authors.add(john)
217.         self.assertEqual(
218.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
219.             ['Dive into Python']
220.         )
221.         self.assertEqual(
222.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
223.             ['Dive into Python']
224.         )
225. 
226.         # Remove the second author
227.         dive.authors.remove(john)
228.         self.assertEqual(
229.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
230.             ['Dive into Python']
231.         )
232.         self.assertEqual(
233.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
234.             []
235.         )
236. 
237.         # Clear all authors
238.         dive.authors.clear()
239.         self.assertEqual(
240.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
241.             []
242.         )
243.         self.assertEqual(
244.             list(Book.objects.using('other').filter(authors__name='John Smith').values_list('title', flat=True)),
245.             []
246.         )
247. 
248.         # Create an author through the m2m interface
249.         dive.authors.create(name='Jane Brown')
250.         self.assertEqual(
251.             list(Book.objects.using('other').filter(authors__name='Mark Pilgrim').values_list('title', flat=True)),
252.             []
253.         )
254.         self.assertEqual(
255.             list(Book.objects.using('other').filter(authors__name='Jane Brown').values_list('title', flat=True)),
256.             ['Dive into Python']
257.         )
258. 
259.     def test_m2m_reverse_operations(self):
260.         "M2M reverse manipulations are all constrained to a single DB"
261.         # Create a book and author on the other database
262.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
263.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
264. 
265.         # Save the author relations
266.         dive.authors.set([mark])
267. 
268.         # Create a second book on the other database
269.         grease = Book.objects.using('other').create(title="Greasemonkey Hacks", published=datetime.date(2005, 11, 1))
270. 
271.         # Add a books to the m2m
272.         mark.book_set.add(grease)
273.         self.assertEqual(
274.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
275.             ['Mark Pilgrim']
276.         )
277.         self.assertEqual(
278.             list(
279.                 Person.objects.using('other').filter(book__title='Greasemonkey Hacks').values_list('name', flat=True)
280.             ),
281.             ['Mark Pilgrim']
282.         )
283. 
284.         # Remove a book from the m2m
285.         mark.book_set.remove(grease)
286.         self.assertEqual(
287.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
288.             ['Mark Pilgrim']
289.         )
290.         self.assertEqual(
291.             list(
292.                 Person.objects.using('other').filter(book__title='Greasemonkey Hacks').values_list('name', flat=True)
293.             ),
294.             []
295.         )
296. 
297.         # Clear the books associated with mark
298.         mark.book_set.clear()
299.         self.assertEqual(
300.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
301.             []
302.         )
303.         self.assertEqual(
304.             list(
305.                 Person.objects.using('other').filter(book__title='Greasemonkey Hacks').values_list('name', flat=True)
306.             ),
307.             []
308.         )
309. 
310.         # Create a book through the m2m interface
311.         mark.book_set.create(title="Dive into HTML5", published=datetime.date(2020, 1, 1))
312.         self.assertEqual(
313.             list(Person.objects.using('other').filter(book__title='Dive into Python').values_list('name', flat=True)),
314.             []
315.         )
316.         self.assertEqual(
317.             list(Person.objects.using('other').filter(book__title='Dive into HTML5').values_list('name', flat=True)),
318.             ['Mark Pilgrim']
319.         )
320. 
321.     def test_m2m_cross_database_protection(self):
322.         "Operations that involve sharing M2M objects across databases raise an error"
323.         # Create a book and author on the default database
324.         pro = Book.objects.create(title="Pro Django", published=datetime.date(2008, 12, 16))
325. 
326.         marty = Person.objects.create(name="Marty Alchin")
327. 
328.         # Create a book and author on the other database
329.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
330. 
331.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
332.         # Set a foreign key set with an object from a different database
333.         msg = (
334.             'Cannot assign "<Person: Marty Alchin>": the current database '
335.             'router prevents this relation.'
336.         )
337.         with self.assertRaisesMessage(ValueError, msg):
338.             with transaction.atomic(using='default'):
339.                 marty.edited.set([pro, dive])
340. 
341.         # Add to an m2m with an object from a different database
342.         msg = (
343.             'Cannot add "<Book: Dive into Python>": instance is on '
344.             'database "default", value is on database "other"'
345.         )
346.         with self.assertRaisesMessage(ValueError, msg):
347.             with transaction.atomic(using='default'):
348.                 marty.book_set.add(dive)
349. 
350.         # Set a m2m with an object from a different database
351.         with self.assertRaisesMessage(ValueError, msg):
352.             with transaction.atomic(using='default'):
353.                 marty.book_set.set([pro, dive])
354. 
355.         # Add to a reverse m2m with an object from a different database
356.         msg = (
357.             'Cannot add "<Person: Marty Alchin>": instance is on '
358.             'database "other", value is on database "default"'
359.         )
360.         with self.assertRaisesMessage(ValueError, msg):
361.             with transaction.atomic(using='other'):
362.                 dive.authors.add(marty)
363. 
364.         # Set a reverse m2m with an object from a different database
365.         with self.assertRaisesMessage(ValueError, msg):
366.             with transaction.atomic(using='other'):
367.                 dive.authors.set([mark, marty])
368. 
369.     def test_m2m_deletion(self):
370.         "Cascaded deletions of m2m relations issue queries on the right database"
371.         # Create a book and author on the other database
372.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
373.         mark = Person.objects.using('other').create(name="Mark Pilgrim")
374.         dive.authors.set([mark])
375. 
376.         # Check the initial state
377.         self.assertEqual(Person.objects.using('default').count(), 0)
378.         self.assertEqual(Book.objects.using('default').count(), 0)
379.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
380. 
381.         self.assertEqual(Person.objects.using('other').count(), 1)
382.         self.assertEqual(Book.objects.using('other').count(), 1)
383.         self.assertEqual(Book.authors.through.objects.using('other').count(), 1)
384. 
385.         # Delete the object on the other database
386.         dive.delete(using='other')
387. 
388.         self.assertEqual(Person.objects.using('default').count(), 0)
389.         self.assertEqual(Book.objects.using('default').count(), 0)
390.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
391. 
392.         # The person still exists ...
393.         self.assertEqual(Person.objects.using('other').count(), 1)
394.         # ... but the book has been deleted
395.         self.assertEqual(Book.objects.using('other').count(), 0)
396.         # ... and the relationship object has also been deleted.
397.         self.assertEqual(Book.authors.through.objects.using('other').count(), 0)
398. 
399.         # Now try deletion in the reverse direction. Set up the relation again
400.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
401.         dive.authors.set([mark])
402. 
403.         # Check the initial state
404.         self.assertEqual(Person.objects.using('default').count(), 0)
405.         self.assertEqual(Book.objects.using('default').count(), 0)
406.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
407. 
408.         self.assertEqual(Person.objects.using('other').count(), 1)
409.         self.assertEqual(Book.objects.using('other').count(), 1)
410.         self.assertEqual(Book.authors.through.objects.using('other').count(), 1)
411. 
412.         # Delete the object on the other database
413.         mark.delete(using='other')
414. 
415.         self.assertEqual(Person.objects.using('default').count(), 0)
416.         self.assertEqual(Book.objects.using('default').count(), 0)
417.         self.assertEqual(Book.authors.through.objects.using('default').count(), 0)
418. 
419.         # The person has been deleted ...
420.         self.assertEqual(Person.objects.using('other').count(), 0)
421.         # ... but the book still exists
422.         self.assertEqual(Book.objects.using('other').count(), 1)
423.         # ... and the relationship object has been deleted.
424.         self.assertEqual(Book.authors.through.objects.using('other').count(), 0)
425. 
426.     def test_foreign_key_separation(self):
427.         "FK fields are constrained to a single database"
428.         # Create a book and author on the default database
429.         pro = Book.objects.create(title="Pro Django", published=datetime.date(2008, 12, 16))
430. 
431.         george = Person.objects.create(name="George Vilches")
432. 
433.         # Create a book and author on the other database
434.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
435.         chris = Person.objects.using('other').create(name="Chris Mills")
436. 
437.         # Save the author's favorite books
438.         pro.editor = george
439.         pro.save()
440. 
441.         dive.editor = chris
442.         dive.save()
443. 
444.         pro = Book.objects.using('default').get(title="Pro Django")
445.         self.assertEqual(pro.editor.name, "George Vilches")
446. 
447.         dive = Book.objects.using('other').get(title="Dive into Python")
448.         self.assertEqual(dive.editor.name, "Chris Mills")
449. 
450.         # Queries work across foreign key joins
451.         self.assertEqual(
452.             list(Person.objects.using('default').filter(edited__title='Pro Django').values_list('name', flat=True)),
453.             ['George Vilches']
454.         )
455.         self.assertEqual(
456.             list(Person.objects.using('other').filter(edited__title='Pro Django').values_list('name', flat=True)),
457.             []
458.         )
459. 
460.         self.assertEqual(
461.             list(
462.                 Person.objects.using('default').filter(edited__title='Dive into Python').values_list('name', flat=True)
463.             ),
464.             []
465.         )
466.         self.assertEqual(
467.             list(
468.                 Person.objects.using('other').filter(edited__title='Dive into Python').values_list('name', flat=True)
469.             ),
470.             ['Chris Mills']
471.         )
472. 
473.         # Reget the objects to clear caches
474.         chris = Person.objects.using('other').get(name="Chris Mills")
475.         dive = Book.objects.using('other').get(title="Dive into Python")
476. 
477.         # Retrieve related object by descriptor. Related objects should be database-bound
478.         self.assertEqual(list(chris.edited.values_list('title', flat=True)), ['Dive into Python'])
479. 
480.     def test_foreign_key_reverse_operations(self):
481.         "FK reverse manipulations are all constrained to a single DB"
482.         dive = Book.objects.using('other').create(title="Dive into Python", published=datetime.date(2009, 5, 4))
483.         chris = Person.objects.using('other').create(name="Chris Mills")
484. 
485.         # Save the author relations
486.         dive.editor = chris
487.         dive.save()
488. 
489.         # Add a second book edited by chris
490.         html5 = Book.objects.using('other').create(title="Dive into HTML5", published=datetime.date(2010, 3, 15))
491.         self.assertEqual(
492.             list(Person.objects.using('other').filter(edited__title='Dive into HTML5').values_list('name', flat=True)),
493.             []
494.         )
495. 
496.         chris.edited.add(html5)
497.         self.assertEqual(
498.             list(Person.objects.using('other').filter(edited__title='Dive into HTML5').values_list('name', flat=True)),
499.             ['Chris Mills']
500.         )

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 22:20:19,755 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The user is reporting a bug in `django.contrib.contenttypes.management` where `RenameContentType` fails in a multi-database setup. I have context on testing `RenameModel` in a single database context and other operations in a multi-database context, but no test that combines both. The file `tests/contenttypes_tests/test_management.py` is the most likely place to find tests for the buggy module, and it may contain the specific multi-database test case needed to address the user's issue." query='Please provide the full content of the file `tests/contenttypes_tests/test_management.py`.' extra_requirements='' purpose='This file is needed to find tests for the `contenttypes.management` module, which is where the bug is located, and may contain tests covering multi-database scenarios.'
2025-12-23 22:20:19,756 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of the file `tests/contenttypes_tests/test_management.py`.
2025-12-23 22:20:19,756 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 22:20:19,756 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 22:20:19,757 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 22:20:19,757 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of the file `tests/contenttypes_tests/test_management.py`.
Purpose: This file is needed to find tests for the `contenttypes.management` module, which is where the bug is located, and may contain tests covering multi-database scenarios.
2025-12-23 22:20:21,681 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "tests/contenttypes_tests/test_management.py"}'}, '__gemini_function_call_thought_signatures__': {'c7ea6916-7ad4-473f-b0ec-fc797ad15133': 'CucDAY89a191a1hjbWn/KQC8yoCwNyrpcwrzxA4CF1i0jn+aCm7xg0w3YCnpynzG789see+MraWTDuJVbdUgCt0w8bXmwTTzg1G2YB2FN1VBYpLNvV7DzAMtj66ycfI4XaY1y+lHbF8pHvNiPW6vZH4ppcKG2gdAziZVNxaVtn6HEgZuIr8EMNxL6sdIilYsiVmWMVliGQk7HIuFkr2Qd1S5lmjpfT/O9z+SVEBHyMEGnV1baOfcRZ0nKpB/1NP4AcVjzxNBEU8Qgtvx+nTaXZ7dc+NN+x2aKMhJDv/yxAOGyGBdLowW1S3WC2cPzab0C1Et5TEx9BwWZYsW8xMupAIAon1bT76XlhtbInXF4TravB26wGiMMdcC8nk877ib/QAPuJuddDKQ8E+fL2yl+2FbrMq7snnxpkwsfDJcRe0zN3wjtQqs61ZIw4CiPVV+2RZC2r+l+VKjEsKVq8NlYz7Jch8p7NuIUNHJQspUlTrFY2mhV40ZrV+WnQifH4B7Xvokk/fOkStyqxbfLVLhKPT9WUnKKRArBckpt/4PXQ5ZCfEu1TW3jdFowLlXAwvMTa37KhRgiNu6ZosQ1O3B2YI8R98IiJMLmGhfeAncPjemaVlS1zEc5CFUfviA5zradO81Wydv+oyRiA=='}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2107, 'candidates_token_count': 26, 'total_token_count': 2255, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2107}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 26}], 'thoughts_token_count': 122, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.2227147359114427, 'model_name': 'gemini-2.5-pro'} id='run--61323feb-6773-4c2b-a505-2dfc09a46bff-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/contenttypes_tests/test_management.py'}, 'id': 'c7ea6916-7ad4-473f-b0ec-fc797ad15133', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2107, 'output_tokens': 26, 'total_tokens': 2255, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 122}}
2025-12-23 22:20:23,775 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the entire content of the file `tests/contenttypes_tests/test_management.py` as requested. This file contains tests for the `contenttypes.management` module, which will be useful for understanding the existing test coverage and writing new tests for the multi-database scenario. The file content has been displayed for your review.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 3478, 'candidates_token_count': 71, 'total_token_count': 3582, 'cached_content_token_count': 1627, 'prompt_tokens_details': [{'modality': 1, 'token_count': 3600}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1627}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 71}], 'thoughts_token_count': 33}, 'finish_reason': 'STOP', 'avg_logprobs': -0.12653667826048084, 'model_name': 'gemini-2.5-pro'} id='run--4c28b092-6da3-444c-8294-7c85fed0a811-0' usage_metadata={'input_tokens': 3478, 'output_tokens': 71, 'total_tokens': 3582, 'input_token_details': {'cache_read': 1627}, 'output_token_details': {'reasoning': 33}}
2025-12-23 22:20:23,777 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of the file `tests/contenttypes_tests/test_management.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
This file is needed to find tests for the `contenttypes.management` module, which is where the bug is located, and may contain tests covering multi-database scenarios.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: tests/contenttypes_tests/test_management.py
Line number range: 1 - 73
Content:
1. from unittest import mock
2. 
3. from django.apps.registry import Apps, apps
4. from django.contrib.contenttypes import management as contenttypes_management
5. from django.contrib.contenttypes.models import ContentType
6. from django.core.management import call_command
7. from django.test import TestCase, modify_settings
8. from django.test.utils import captured_stdout
9. 
10. from .models import ModelWithNullFKToSite, Post
11. 
12. 
13. @modify_settings(INSTALLED_APPS={'append': ['no_models']})
14. class RemoveStaleContentTypesTests(TestCase):
15.     # Speed up tests by avoiding retrieving ContentTypes for all test apps.
16.     available_apps = ['contenttypes_tests', 'no_models', 'django.contrib.contenttypes']
17. 
18.     def setUp(self):
19.         self.before_count = ContentType.objects.count()
20.         self.content_type = ContentType.objects.create(app_label='contenttypes_tests', model='Fake')
21.         self.app_config = apps.get_app_config('contenttypes_tests')
22. 
23.     def test_interactive_true_with_dependent_objects(self):
24.         """
25.         interactive mode (the default) deletes stale content types and warns of
26.         dependent objects.
27.         """
28.         post = Post.objects.create(title='post', content_type=self.content_type)
29.         # A related object is needed to show that a custom collector with
30.         # can_fast_delete=False is needed.
31.         ModelWithNullFKToSite.objects.create(post=post)
32.         with mock.patch('builtins.input', return_value='yes'):
33.             with captured_stdout() as stdout:
34.                 call_command('remove_stale_contenttypes', verbosity=2, stdout=stdout)
35.         self.assertEqual(Post.objects.count(), 0)
36.         output = stdout.getvalue()
37.         self.assertIn('- Content type for contenttypes_tests.Fake', output)
38.         self.assertIn('- 1 contenttypes_tests.Post object(s)', output)
39.         self.assertIn('- 1 contenttypes_tests.ModelWithNullFKToSite', output)
40.         self.assertIn('Deleting stale content type', output)
41.         self.assertEqual(ContentType.objects.count(), self.before_count)
42. 
43.     def test_interactive_true_without_dependent_objects(self):
44.         """
45.         interactive mode deletes stale content types even if there aren't any
46.         dependent objects.
47.         """
48.         with mock.patch('builtins.input', return_value='yes'):
49.             with captured_stdout() as stdout:
50.                 call_command('remove_stale_contenttypes', verbosity=2)
51.         self.assertIn("Deleting stale content type", stdout.getvalue())
52.         self.assertEqual(ContentType.objects.count(), self.before_count)
53. 
54.     def test_interactive_false(self):
55.         """non-interactive mode deletes stale content types."""
56.         with captured_stdout() as stdout:
57.             call_command('remove_stale_contenttypes', interactive=False, verbosity=2)
58.         self.assertIn('Deleting stale content type', stdout.getvalue())
59.         self.assertEqual(ContentType.objects.count(), self.before_count)
60. 
61.     def test_unavailable_content_type_model(self):
62.         """A ContentType isn't created if the model isn't available."""
63.         apps = Apps()
64.         with self.assertNumQueries(0):
65.             contenttypes_management.create_contenttypes(self.app_config, interactive=False, verbosity=0, apps=apps)
66.         self.assertEqual(ContentType.objects.count(), self.before_count + 1)
67. 
68.     def test_contenttypes_removed_in_apps_without_models(self):
69.         ContentType.objects.create(app_label='no_models', model='Fake')
70.         with mock.patch('builtins.input', return_value='yes'), captured_stdout() as stdout:
71.             call_command('remove_stale_contenttypes', verbosity=2)
72.         self.assertIn("Deleting stale content type 'no_models | Fake'", stdout.getvalue())
73.         self.assertEqual(ContentType.objects.count(), self.before_count)

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 22:20:27,500 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="The user requested the full content of the file `tests/contenttypes_tests/test_management.py`. The provided context is the exact file content from line 1 to 73, so it directly and completely answers the user's query.", relative_path='tests/contenttypes_tests/test_management.py', start_line=1, end_line=73)]
2025-12-23 22:20:27,501 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 1 contexts to memory for query: Please provide the full content of the file `tests/contenttypes_tests/test_management.py`.
2025-12-23 22:20:27,502 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 22:20:27,502 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 22:20:27,502 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 1 new contexts to 9 existing contexts
2025-12-23 22:20:27,503 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 10 total contexts (removed 0 duplicates)
2025-12-23 22:20:27,504 - thread-140065092138688.prometheus_context_collector.lang_graph.nodes.context_refine_node - INFO - Reached max_refined_query_loop, not asking for more context
2025-12-23 22:20:27,505 - thread-140065092138688.prometheus_context_collector - INFO - Successfully retrieved 10 context snippets
