2025-12-23 00:42:28,561 - thread-125445954578112.prometheus_context_collector - INFO - Starting context retrieval for query: 
Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

2025-12-23 00:42:28,627 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug-report.yml
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── dependabot.yml
|   └── workflows
|       ├── builddoc.yml
|       ├── coverage.yml
|       ├── create-release.yml
|       ├── latex.yml
|       ├── lint.yml
|       ├── lock.yml
|       ├── main.yml
|       ├── nodejs.yml
|       └── transifex.yml
├── .readthedocs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   ├── themes
|   |   |   └── fullsize
|   |   └── tutorial
|   ├── _templates
|   |   └── contents.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── authors.rst
|   ├── changes.rst
|   ├── conf.py
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── templating.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── autodoc_ext.rst
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── autodoc_intenum.py
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── index.rst
|   ├── internals
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── support.rst
|   ├── tutorial
|   |   ├── automatic-doc-generation.rst
|   |   ├── deploying.rst
|   |   ├── describing-code.rst
|   |   ├── end.rst
|   |   ├── first-steps.rst
|   |   ├── getting-started.rst
|   |   ├── index.rst
|   |   ├── more-sphinx-customization.rst
|   |   └── narrative-documentation.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── changes.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── preserve_defaults.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   └── docstring.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_GB
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── is
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── yue
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_TW
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW.Big5
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── searchfield.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── searchtools.js
|   |   |       └── sphinx_highlight.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── console.py
|   |   ├── display.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── exceptions.py
|   |   ├── fileutil.py
|   |   ├── http_date.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   ├── documentation_options.js
|   |   ├── searchtools.js
|   |   └── sphinx_highlight.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-duplicates
|   |   |   └── fish_licence
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-theme-having-multiple-stylesheets
|   |   |   ├── _themes
|   |   |   |   └── mytheme
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-copyright-multiline
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── dedent.rst
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-csv-table
|   |   |   ├── conf.py
|   |   |   └── subdir
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── ns_lookup.rst
|   |   ├── test-domain-c-c_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-cpp-cpp_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-js-javascript_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py
|   |   |   ├── abbr.rst
|   |   |   ├── canonical.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-python_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-python_use_unqualified_type_names
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-environment-record-dependencies
|   |   |   ├── api.rst
|   |   |   ├── conf.py
|   |   |   ├── example_module.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── _functions_to_import.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── autodoc_type_aliases.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── canonical
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── metadata.py
|   |   |       ├── methods.py
|   |   |       ├── module.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── pep604.py
|   |   |       ├── preserve_defaults.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── properties.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       ├── uninitialized_attributes.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_class_module.py
|   |   |   ├── autosummary_dummy_inherited_module.py
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-module_all
|   |   |   ├── autosummary_dummy_package_all
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autosummary_dummy_module.py
|   |   |   |   └── extra_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls-multiple-replacements
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgmockconverter
|   |   |   ├── 1
|   |   |   ├── 2
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── mocksvgconverter.py
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-intersphinx-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   ├── nomath.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-napoleon
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── mypackage
|   |   |   |   ├── __init__.py
|   |   |   |   └── typehints.py
|   |   |   └── typehints.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-highlight_options
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_signaturereturn_icon
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-escape
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── noqa.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-container
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-labels-before-module
|   |   |   ├── automodule1.py
|   |   |   ├── automodule2a.py
|   |   |   ├── automodule2b.py
|   |   |   ├── automodule3.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.rst
|   |   ├── test-linkcheck-anchors-ignore
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-documents_exclude
|   |   |   ├── br0ken_link.rst
|   |   |   ├── broken_link.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-warn-redirects
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-raw-node
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-too-many-retries
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-local-logo
|   |   |   ├── conf.py
|   |   |   ├── images
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   ├── en
|   |   |   |   └── et
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nitpicky-warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-object-description-sections
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-reST-code-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-remote-logo
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── literals.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-domain-objects
|   |   |   ├── conf.py
|   |   |   ├── domains.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-index
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-transforms-post_transforms-keyboard
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-transforms-post_transforms-missing-reference
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_object_description.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_record_dependencies.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_autoproperty.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_preserve_defaults.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_extlinks.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_imgmockconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_extension.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_display.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── babel_runner.py
    ├── bump_docker.sh
    └── bump_version.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 00:43:10,755 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The user's report indicates a bug where a document's title is ignored when it's a domain directive and `rst_prolog` is set. The provided patch points to `sphinx/util/rst.py` and a faulty regex for docinfo fields. To understand the full context, I need to see: 1. How `rst_prolog` is added to the source, which is likely in `sphinx/io.py`. 2. How the document title is extracted, which happens in `sphinx/environment/collectors/title.py`. 3. The utility functions in `sphinx/util/rst.py` that are used for this processing and contain the bug. These three files should cover the entire process from reading the file to extracting its title." query='Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.' extra_requirements='' purpose='These files will help me trace how `rst_prolog` affects title extraction and validate the provided fix in `sphinx/util/rst.py`.'
2025-12-23 00:43:10,757 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.
2025-12-23 00:43:10,757 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 00:43:10,758 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 00:43:10,759 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 00:43:10,759 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.
Purpose: These files will help me trace how `rst_prolog` affects title extraction and validate the provided fix in `sphinx/util/rst.py`.
2025-12-23 00:43:13,721 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have started by reading the file `sphinx/util/rst.py` to understand its contents. Next, I will proceed to read the other two files, `sphinx/io.py` and `sphinx/environment/collectors/title.py`, to gather all the necessary information for your analysis.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/environment/collectors/title.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2104, 'candidates_token_count': 127, 'total_token_count': 2356, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2104}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 127}], 'thoughts_token_count': 125, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.04661609995083546, 'model_name': 'gemini-2.5-pro'} id='run--f2430f5e-9c97-4099-a7b2-c142f8a1d094-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/util/rst.py'}, 'id': '034cb07f-f682-4879-b177-5741ce1cbfad', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/io.py'}, 'id': '31355186-4cf7-4ad1-845e-f77b8afce0dc', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/environment/collectors/title.py'}, 'id': 'e7fbe37c-65c5-41fb-96d0-96167cd9643b', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2104, 'output_tokens': 127, 'total_tokens': 2356, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 125}}
2025-12-23 00:43:20,015 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the full content of the three files you requested: `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`. You can now review their source code to trace how `rst_prolog` is handled and how it impacts the title extraction process. This information should help you validate the fix you mentioned.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 7012, 'candidates_token_count': 81, 'total_token_count': 7617, 'cached_content_token_count': 1772, 'prompt_tokens_details': [{'modality': 1, 'token_count': 7012}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1772}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 81}], 'thoughts_token_count': 524}, 'finish_reason': 'STOP', 'avg_logprobs': -0.5956921047634549, 'model_name': 'gemini-2.5-pro'} id='run--51502426-dcfd-4a2b-92e9-30718961ce85-0' usage_metadata={'input_tokens': 7012, 'output_tokens': 81, 'total_tokens': 7617, 'input_token_details': {'cache_read': 1772}, 'output_token_details': {'reasoning': 524}}
2025-12-23 00:43:20,017 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
These files will help me trace how `rst_prolog` affects title extraction and validate the provided fix in `sphinx/util/rst.py`.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: sphinx/environment/collectors/title.py
Line number range: 1 - 59
Content:
1. """The title collector components for sphinx.environment."""
2. 
3. from __future__ import annotations
4. 
5. from typing import Any
6. 
7. from docutils import nodes
8. 
9. from sphinx.application import Sphinx
10. from sphinx.environment import BuildEnvironment
11. from sphinx.environment.collectors import EnvironmentCollector
12. from sphinx.transforms import SphinxContentsFilter
13. 
14. 
15. class TitleCollector(EnvironmentCollector):
16.     """title collector for sphinx.environment."""
17. 
18.     def clear_doc(self, app: Sphinx, env: BuildEnvironment, docname: str) -> None:
19.         env.titles.pop(docname, None)
20.         env.longtitles.pop(docname, None)
21. 
22.     def merge_other(self, app: Sphinx, env: BuildEnvironment,
23.                     docnames: set[str], other: BuildEnvironment) -> None:
24.         for docname in docnames:
25.             env.titles[docname] = other.titles[docname]
26.             env.longtitles[docname] = other.longtitles[docname]
27. 
28.     def process_doc(self, app: Sphinx, doctree: nodes.document) -> None:
29.         """Add a title node to the document (just copy the first section title),
30.         and store that title in the environment.
31.         """
32.         titlenode = nodes.title()
33.         longtitlenode = titlenode
34.         # explicit title set with title directive; use this only for
35.         # the <title> tag in HTML output
36.         if 'title' in doctree:
37.             longtitlenode = nodes.title()
38.             longtitlenode += nodes.Text(doctree['title'])
39.         # look for first section title and use that as the title
40.         for node in doctree.findall(nodes.section):
41.             visitor = SphinxContentsFilter(doctree)
42.             node[0].walkabout(visitor)
43.             titlenode += visitor.get_entry_text()
44.             break
45.         else:
46.             # document has no title
47.             titlenode += nodes.Text(doctree.get('title', '<no title>'))
48.         app.env.titles[app.env.docname] = titlenode
49.         app.env.longtitles[app.env.docname] = longtitlenode
50. 
51. 
52. def setup(app: Sphinx) -> dict[str, Any]:
53.     app.add_env_collector(TitleCollector)
54. 
55.     return {
56.         'version': 'builtin',
57.         'parallel_read_safe': True,
58.         'parallel_write_safe': True,
59.     }


File: sphinx/io.py
Line number range: 1 - 188
Content:
1. """Input/Output files"""
2. from __future__ import annotations
3. 
4. from typing import TYPE_CHECKING, Any
5. 
6. import docutils
7. from docutils import nodes
8. from docutils.core import Publisher
9. from docutils.frontend import Values
10. from docutils.io import FileInput, Input, NullOutput
11. from docutils.parsers import Parser
12. from docutils.readers import standalone
13. from docutils.transforms import Transform
14. from docutils.transforms.references import DanglingReferences
15. from docutils.writers import UnfilteredWriter
16. 
17. from sphinx import addnodes
18. from sphinx.environment import BuildEnvironment
19. from sphinx.transforms import AutoIndexUpgrader, DoctreeReadEvent, SphinxTransformer
20. from sphinx.transforms.i18n import (
21.     Locale,
22.     PreserveTranslatableMessages,
23.     RemoveTranslatableInline,
24. )
25. from sphinx.transforms.references import SphinxDomains
26. from sphinx.util import logging
27. from sphinx.util.docutils import LoggingReporter
28. from sphinx.versioning import UIDTransform
29. 
30. if TYPE_CHECKING:
31.     from sphinx.application import Sphinx
32. 
33. 
34. logger = logging.getLogger(__name__)
35. 
36. 
37. class SphinxBaseReader(standalone.Reader):
38.     """
39.     A base class of readers for Sphinx.
40. 
41.     This replaces reporter by Sphinx's on generating document.
42.     """
43. 
44.     transforms: list[type[Transform]] = []
45. 
46.     def __init__(self, *args: Any, **kwargs: Any) -> None:
47.         from sphinx.application import Sphinx
48.         if len(args) > 0 and isinstance(args[0], Sphinx):
49.             self._app = args[0]
50.             self._env = self._app.env
51.             args = args[1:]
52. 
53.         super().__init__(*args, **kwargs)
54. 
55.     def setup(self, app: Sphinx) -> None:
56.         self._app = app      # hold application object only for compatibility
57.         self._env = app.env
58. 
59.     def get_transforms(self) -> list[type[Transform]]:
60.         transforms = super().get_transforms() + self.transforms
61. 
62.         # remove transforms which is not needed for Sphinx
63.         unused = [DanglingReferences]
64.         for transform in unused:
65.             if transform in transforms:
66.                 transforms.remove(transform)
67. 
68.         return transforms
69. 
70.     def new_document(self) -> nodes.document:
71.         """
72.         Creates a new document object which has a special reporter object good
73.         for logging.
74.         """
75.         document = super().new_document()
76.         document.__class__ = addnodes.document  # replace the class with patched version
77. 
78.         # substitute transformer
79.         document.transformer = SphinxTransformer(document)
80.         document.transformer.set_environment(self.settings.env)
81. 
82.         # substitute reporter
83.         reporter = document.reporter
84.         document.reporter = LoggingReporter.from_reporter(reporter)
85. 
86.         return document
87. 
88. 
89. class SphinxStandaloneReader(SphinxBaseReader):
90.     """
91.     A basic document reader for Sphinx.
92.     """
93. 
94.     def setup(self, app: Sphinx) -> None:
95.         self.transforms = self.transforms + app.registry.get_transforms()
96.         super().setup(app)
97. 
98.     def read(self, source: Input, parser: Parser, settings: Values) -> nodes.document:
99.         self.source = source
100.         if not self.parser:
101.             self.parser = parser
102.         self.settings = settings
103.         self.input = self.read_source(settings.env)
104.         self.parse()
105.         return self.document
106. 
107.     def read_source(self, env: BuildEnvironment) -> str:
108.         """Read content from source and do post-process."""
109.         content = self.source.read()
110. 
111.         # emit "source-read" event
112.         arg = [content]
113.         env.events.emit('source-read', env.docname, arg)
114.         return arg[0]
115. 
116. 
117. class SphinxI18nReader(SphinxBaseReader):
118.     """
119.     A document reader for i18n.
120. 
121.     This returns the source line number of original text as current source line number
122.     to let users know where the error happened.
123.     Because the translated texts are partial and they don't have correct line numbers.
124.     """
125. 
126.     def setup(self, app: Sphinx) -> None:
127.         super().setup(app)
128. 
129.         self.transforms = self.transforms + app.registry.get_transforms()
130.         unused = [PreserveTranslatableMessages, Locale, RemoveTranslatableInline,
131.                   AutoIndexUpgrader, SphinxDomains, DoctreeReadEvent,
132.                   UIDTransform]
133.         for transform in unused:
134.             if transform in self.transforms:
135.                 self.transforms.remove(transform)
136. 
137. 
138. class SphinxDummyWriter(UnfilteredWriter):
139.     """Dummy writer module used for generating doctree."""
140. 
141.     supported = ('html',)  # needed to keep "meta" nodes
142. 
143.     def translate(self) -> None:
144.         pass
145. 
146. 
147. def SphinxDummySourceClass(source: Any, *args: Any, **kwargs: Any) -> Any:
148.     """Bypass source object as is to cheat Publisher."""
149.     return source
150. 
151. 
152. class SphinxFileInput(FileInput):
153.     """A basic FileInput for Sphinx."""
154.     def __init__(self, *args: Any, **kwargs: Any) -> None:
155.         kwargs['error_handler'] = 'sphinx'
156.         super().__init__(*args, **kwargs)
157. 
158. 
159. def create_publisher(app: Sphinx, filetype: str) -> Publisher:
160.     reader = SphinxStandaloneReader()
161.     reader.setup(app)
162. 
163.     parser = app.registry.create_source_parser(app, filetype)
164.     if parser.__class__.__name__ == 'CommonMarkParser' and parser.settings_spec == ():
165.         # a workaround for recommonmark
166.         #   If recommonmark.AutoStrictify is enabled, the parser invokes reST parser
167.         #   internally.  But recommonmark-0.4.0 does not provide settings_spec for reST
168.         #   parser.  As a workaround, this copies settings_spec for RSTParser to the
169.         #   CommonMarkParser.
170.         from docutils.parsers.rst import Parser as RSTParser
171. 
172.         parser.settings_spec = RSTParser.settings_spec
173. 
174.     pub = Publisher(
175.         reader=reader,
176.         parser=parser,
177.         writer=SphinxDummyWriter(),
178.         source_class=SphinxFileInput,
179.         destination=NullOutput(),
180.     )
181.     # Propagate exceptions by default when used programmatically:
182.     defaults = {"traceback": True, **app.env.settings}
183.     # Set default settings
184.     if docutils.__version_info__[:2] >= (0, 19):
185.         pub.get_settings(**defaults)
186.     else:
187.         pub.settings = pub.setup_option_parser(**defaults).get_default_values()
188.     return pub


File: sphinx/util/rst.py
Line number range: 1 - 110
Content:
1. """reST helper functions."""
2. 
3. from __future__ import annotations
4. 
5. import re
6. from collections import defaultdict
7. from contextlib import contextmanager
8. from typing import Generator
9. from unicodedata import east_asian_width
10. 
11. from docutils.parsers.rst import roles
12. from docutils.parsers.rst.languages import en as english
13. from docutils.statemachine import StringList
14. from docutils.utils import Reporter
15. from jinja2 import Environment
16. 
17. from sphinx.locale import __
18. from sphinx.util import docutils, logging
19. 
20. try:
21.     from jinja2.utils import pass_environment
22. except ImportError:
23.     from jinja2 import environmentfilter as pass_environment
24. 
25. 
26. logger = logging.getLogger(__name__)
27. 
28. docinfo_re = re.compile(':\\w+:.*?')
29. symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
30. SECTIONING_CHARS = ['=', '-', '~']
31. 
32. # width of characters
33. WIDECHARS: dict[str, str] = defaultdict(lambda: "WF")  # WF: Wide + Full-width
34. WIDECHARS["ja"] = "WFA"  # In Japanese, Ambiguous characters also have double width
35. 
36. 
37. def escape(text: str) -> str:
38.     text = symbols_re.sub(r'\\\1', text)
39.     text = re.sub(r'^\.', r'\.', text)  # escape a dot at top
40.     return text
41. 
42. 
43. def textwidth(text: str, widechars: str = 'WF') -> int:
44.     """Get width of text."""
45.     def charwidth(char: str, widechars: str) -> int:
46.         if east_asian_width(char) in widechars:
47.             return 2
48.         else:
49.             return 1
50. 
51.     return sum(charwidth(c, widechars) for c in text)
52. 
53. 
54. @pass_environment
55. def heading(env: Environment, text: str, level: int = 1) -> str:
56.     """Create a heading for *level*."""
57.     assert level <= 3
58.     width = textwidth(text, WIDECHARS[env.language])
59.     sectioning_char = SECTIONING_CHARS[level - 1]
60.     return f'{text}\n{sectioning_char * width}'
61. 
62. 
63. @contextmanager
64. def default_role(docname: str, name: str) -> Generator[None, None, None]:
65.     if name:
66.         dummy_reporter = Reporter('', 4, 4)
67.         role_fn, _ = roles.role(name, english, 0, dummy_reporter)
68.         if role_fn:  # type: ignore[truthy-function]
69.             docutils.register_role('', role_fn)
70.         else:
71.             logger.warning(__('default role %s not found'), name, location=docname)
72. 
73.     yield
74. 
75.     docutils.unregister_role('')
76. 
77. 
78. def prepend_prolog(content: StringList, prolog: str) -> None:
79.     """Prepend a string to content body as prolog."""
80.     if prolog:
81.         pos = 0
82.         for line in content:
83.             if docinfo_re.match(line):
84.                 pos += 1
85.             else:
86.                 break
87. 
88.         if pos > 0:
89.             # insert a blank line after docinfo
90.             content.insert(pos, '', '<generated>', 0)
91.             pos += 1
92. 
93.         # insert prolog (after docinfo if exists)
94.         for lineno, line in enumerate(prolog.splitlines()):
95.             content.insert(pos + lineno, line, '<rst_prolog>', lineno)
96. 
97.         content.insert(pos + lineno + 1, '', '<generated>', 0)
98. 
99. 
100. def append_epilog(content: StringList, epilog: str) -> None:
101.     """Append a string to content body as epilog."""
102.     if epilog:
103.         if len(content) > 0:
104.             source, lineno = content.info(-1)
105.         else:
106.             source = '<generated>'
107.             lineno = 0
108.         content.append('', source, lineno + 1)
109.         for lineno, line in enumerate(epilog.splitlines()):
110.             content.append(line, '<rst_epilog>', lineno)

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 00:43:26,976 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='The user explicitly asked for the full content of `sphinx/environment/collectors/title.py` to understand how titles are extracted. This file contains the `TitleCollector` class, which is responsible for this process.', relative_path='sphinx/environment/collectors/title.py', start_line=1, end_line=59), ContextOutput(reasoning="The user explicitly asked for the full content of `sphinx/io.py`. This file is relevant to understanding the input and reading process of Sphinx documents, which is a part of the user's goal to trace how `rst_prolog` affects title extraction.", relative_path='sphinx/io.py', start_line=1, end_line=188), ContextOutput(reasoning="The user explicitly asked for the full content of `sphinx/util/rst.py`. This file contains the `prepend_prolog` function, which is directly related to the user's goal of tracing how `rst_prolog` affects title extraction.", relative_path='sphinx/util/rst.py', start_line=1, end_line=110)]
2025-12-23 00:43:26,977 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.
2025-12-23 00:43:26,977 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 00:43:26,977 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 00:43:26,978 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 0 existing contexts
2025-12-23 00:43:26,978 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 3 total contexts (removed 0 duplicates)
2025-12-23 00:43:26,979 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug-report.yml
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── dependabot.yml
|   └── workflows
|       ├── builddoc.yml
|       ├── coverage.yml
|       ├── create-release.yml
|       ├── latex.yml
|       ├── lint.yml
|       ├── lock.yml
|       ├── main.yml
|       ├── nodejs.yml
|       └── transifex.yml
├── .readthedocs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   ├── themes
|   |   |   └── fullsize
|   |   └── tutorial
|   ├── _templates
|   |   └── contents.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── authors.rst
|   ├── changes.rst
|   ├── conf.py
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── templating.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── autodoc_ext.rst
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── autodoc_intenum.py
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── index.rst
|   ├── internals
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── support.rst
|   ├── tutorial
|   |   ├── automatic-doc-generation.rst
|   |   ├── deploying.rst
|   |   ├── describing-code.rst
|   |   ├── end.rst
|   |   ├── first-steps.rst
|   |   ├── getting-started.rst
|   |   ├── index.rst
|   |   ├── more-sphinx-customization.rst
|   |   └── narrative-documentation.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── changes.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── preserve_defaults.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   └── docstring.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_GB
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── is
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── yue
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_TW
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW.Big5
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── searchfield.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── searchtools.js
|   |   |       └── sphinx_highlight.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── console.py
|   |   ├── display.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── exceptions.py
|   |   ├── fileutil.py
|   |   ├── http_date.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   ├── documentation_options.js
|   |   ├── searchtools.js
|   |   └── sphinx_highlight.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-duplicates
|   |   |   └── fish_licence
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-theme-having-multiple-stylesheets
|   |   |   ├── _themes
|   |   |   |   └── mytheme
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-copyright-multiline
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── dedent.rst
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-csv-table
|   |   |   ├── conf.py
|   |   |   └── subdir
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── ns_lookup.rst
|   |   ├── test-domain-c-c_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-cpp-cpp_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-js-javascript_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py
|   |   |   ├── abbr.rst
|   |   |   ├── canonical.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-python_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-python_use_unqualified_type_names
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-environment-record-dependencies
|   |   |   ├── api.rst
|   |   |   ├── conf.py
|   |   |   ├── example_module.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── _functions_to_import.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── autodoc_type_aliases.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── canonical
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── metadata.py
|   |   |       ├── methods.py
|   |   |       ├── module.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── pep604.py
|   |   |       ├── preserve_defaults.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── properties.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       ├── uninitialized_attributes.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_class_module.py
|   |   |   ├── autosummary_dummy_inherited_module.py
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-module_all
|   |   |   ├── autosummary_dummy_package_all
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autosummary_dummy_module.py
|   |   |   |   └── extra_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls-multiple-replacements
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgmockconverter
|   |   |   ├── 1
|   |   |   ├── 2
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── mocksvgconverter.py
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-intersphinx-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   ├── nomath.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-napoleon
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── mypackage
|   |   |   |   ├── __init__.py
|   |   |   |   └── typehints.py
|   |   |   └── typehints.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-highlight_options
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_signaturereturn_icon
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-escape
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── noqa.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-container
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-labels-before-module
|   |   |   ├── automodule1.py
|   |   |   ├── automodule2a.py
|   |   |   ├── automodule2b.py
|   |   |   ├── automodule3.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.rst
|   |   ├── test-linkcheck-anchors-ignore
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-documents_exclude
|   |   |   ├── br0ken_link.rst
|   |   |   ├── broken_link.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-warn-redirects
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-raw-node
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-too-many-retries
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-local-logo
|   |   |   ├── conf.py
|   |   |   ├── images
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   ├── en
|   |   |   |   └── et
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nitpicky-warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-object-description-sections
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-reST-code-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-remote-logo
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── literals.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-domain-objects
|   |   |   ├── conf.py
|   |   |   ├── domains.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-index
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-transforms-post_transforms-keyboard
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-transforms-post_transforms-missing-reference
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_object_description.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_record_dependencies.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_autoproperty.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_preserve_defaults.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_extlinks.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_imgmockconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_extension.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_display.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── babel_runner.py
    ├── bump_docker.sh
    └── bump_version.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.
Extra Requirements: 
Purpose: These files will help me trace how `rst_prolog` affects title extraction and validate the provided fix in `sphinx/util/rst.py`.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: sphinx/environment/collectors/title.py
Line number range: 1 - 59
Content:
1. """The title collector components for sphinx.environment."""
2. 
3. from __future__ import annotations
4. 
5. from typing import Any
6. 
7. from docutils import nodes
8. 
9. from sphinx.application import Sphinx
10. from sphinx.environment import BuildEnvironment
11. from sphinx.environment.collectors import EnvironmentCollector
12. from sphinx.transforms import SphinxContentsFilter
13. 
14. 
15. class TitleCollector(EnvironmentCollector):
16.     """title collector for sphinx.environment."""
17. 
18.     def clear_doc(self, app: Sphinx, env: BuildEnvironment, docname: str) -> None:
19.         env.titles.pop(docname, None)
20.         env.longtitles.pop(docname, None)
21. 
22.     def merge_other(self, app: Sphinx, env: BuildEnvironment,
23.                     docnames: set[str], other: BuildEnvironment) -> None:
24.         for docname in docnames:
25.             env.titles[docname] = other.titles[docname]
26.             env.longtitles[docname] = other.longtitles[docname]
27. 
28.     def process_doc(self, app: Sphinx, doctree: nodes.document) -> None:
29.         """Add a title node to the document (just copy the first section title),
30.         and store that title in the environment.
31.         """
32.         titlenode = nodes.title()
33.         longtitlenode = titlenode
34.         # explicit title set with title directive; use this only for
35.         # the <title> tag in HTML output
36.         if 'title' in doctree:
37.             longtitlenode = nodes.title()
38.             longtitlenode += nodes.Text(doctree['title'])
39.         # look for first section title and use that as the title
40.         for node in doctree.findall(nodes.section):
41.             visitor = SphinxContentsFilter(doctree)
42.             node[0].walkabout(visitor)
43.             titlenode += visitor.get_entry_text()
44.             break
45.         else:
46.             # document has no title
47.             titlenode += nodes.Text(doctree.get('title', '<no title>'))
48.         app.env.titles[app.env.docname] = titlenode
49.         app.env.longtitles[app.env.docname] = longtitlenode
50. 
51. 
52. def setup(app: Sphinx) -> dict[str, Any]:
53.     app.add_env_collector(TitleCollector)
54. 
55.     return {
56.         'version': 'builtin',
57.         'parallel_read_safe': True,
58.         'parallel_write_safe': True,
59.     }


File: sphinx/io.py
Line number range: 1 - 188
Content:
1. """Input/Output files"""
2. from __future__ import annotations
3. 
4. from typing import TYPE_CHECKING, Any
5. 
6. import docutils
7. from docutils import nodes
8. from docutils.core import Publisher
9. from docutils.frontend import Values
10. from docutils.io import FileInput, Input, NullOutput
11. from docutils.parsers import Parser
12. from docutils.readers import standalone
13. from docutils.transforms import Transform
14. from docutils.transforms.references import DanglingReferences
15. from docutils.writers import UnfilteredWriter
16. 
17. from sphinx import addnodes
18. from sphinx.environment import BuildEnvironment
19. from sphinx.transforms import AutoIndexUpgrader, DoctreeReadEvent, SphinxTransformer
20. from sphinx.transforms.i18n import (
21.     Locale,
22.     PreserveTranslatableMessages,
23.     RemoveTranslatableInline,
24. )
25. from sphinx.transforms.references import SphinxDomains
26. from sphinx.util import logging
27. from sphinx.util.docutils import LoggingReporter
28. from sphinx.versioning import UIDTransform
29. 
30. if TYPE_CHECKING:
31.     from sphinx.application import Sphinx
32. 
33. 
34. logger = logging.getLogger(__name__)
35. 
36. 
37. class SphinxBaseReader(standalone.Reader):
38.     """
39.     A base class of readers for Sphinx.
40. 
41.     This replaces reporter by Sphinx's on generating document.
42.     """
43. 
44.     transforms: list[type[Transform]] = []
45. 
46.     def __init__(self, *args: Any, **kwargs: Any) -> None:
47.         from sphinx.application import Sphinx
48.         if len(args) > 0 and isinstance(args[0], Sphinx):
49.             self._app = args[0]
50.             self._env = self._app.env
51.             args = args[1:]
52. 
53.         super().__init__(*args, **kwargs)
54. 
55.     def setup(self, app: Sphinx) -> None:
56.         self._app = app      # hold application object only for compatibility
57.         self._env = app.env
58. 
59.     def get_transforms(self) -> list[type[Transform]]:
60.         transforms = super().get_transforms() + self.transforms
61. 
62.         # remove transforms which is not needed for Sphinx
63.         unused = [DanglingReferences]
64.         for transform in unused:
65.             if transform in transforms:
66.                 transforms.remove(transform)
67. 
68.         return transforms
69. 
70.     def new_document(self) -> nodes.document:
71.         """
72.         Creates a new document object which has a special reporter object good
73.         for logging.
74.         """
75.         document = super().new_document()
76.         document.__class__ = addnodes.document  # replace the class with patched version
77. 
78.         # substitute transformer
79.         document.transformer = SphinxTransformer(document)
80.         document.transformer.set_environment(self.settings.env)
81. 
82.         # substitute reporter
83.         reporter = document.reporter
84.         document.reporter = LoggingReporter.from_reporter(reporter)
85. 
86.         return document
87. 
88. 
89. class SphinxStandaloneReader(SphinxBaseReader):
90.     """
91.     A basic document reader for Sphinx.
92.     """
93. 
94.     def setup(self, app: Sphinx) -> None:
95.         self.transforms = self.transforms + app.registry.get_transforms()
96.         super().setup(app)
97. 
98.     def read(self, source: Input, parser: Parser, settings: Values) -> nodes.document:
99.         self.source = source
100.         if not self.parser:
101.             self.parser = parser
102.         self.settings = settings
103.         self.input = self.read_source(settings.env)
104.         self.parse()
105.         return self.document
106. 
107.     def read_source(self, env: BuildEnvironment) -> str:
108.         """Read content from source and do post-process."""
109.         content = self.source.read()
110. 
111.         # emit "source-read" event
112.         arg = [content]
113.         env.events.emit('source-read', env.docname, arg)
114.         return arg[0]
115. 
116. 
117. class SphinxI18nReader(SphinxBaseReader):
118.     """
119.     A document reader for i18n.
120. 
121.     This returns the source line number of original text as current source line number
122.     to let users know where the error happened.
123.     Because the translated texts are partial and they don't have correct line numbers.
124.     """
125. 
126.     def setup(self, app: Sphinx) -> None:
127.         super().setup(app)
128. 
129.         self.transforms = self.transforms + app.registry.get_transforms()
130.         unused = [PreserveTranslatableMessages, Locale, RemoveTranslatableInline,
131.                   AutoIndexUpgrader, SphinxDomains, DoctreeReadEvent,
132.                   UIDTransform]
133.         for transform in unused:
134.             if transform in self.transforms:
135.                 self.transforms.remove(transform)
136. 
137. 
138. class SphinxDummyWriter(UnfilteredWriter):
139.     """Dummy writer module used for generating doctree."""
140. 
141.     supported = ('html',)  # needed to keep "meta" nodes
142. 
143.     def translate(self) -> None:
144.         pass
145. 
146. 
147. def SphinxDummySourceClass(source: Any, *args: Any, **kwargs: Any) -> Any:
148.     """Bypass source object as is to cheat Publisher."""
149.     return source
150. 
151. 
152. class SphinxFileInput(FileInput):
153.     """A basic FileInput for Sphinx."""
154.     def __init__(self, *args: Any, **kwargs: Any) -> None:
155.         kwargs['error_handler'] = 'sphinx'
156.         super().__init__(*args, **kwargs)
157. 
158. 
159. def create_publisher(app: Sphinx, filetype: str) -> Publisher:
160.     reader = SphinxStandaloneReader()
161.     reader.setup(app)
162. 
163.     parser = app.registry.create_source_parser(app, filetype)
164.     if parser.__class__.__name__ == 'CommonMarkParser' and parser.settings_spec == ():
165.         # a workaround for recommonmark
166.         #   If recommonmark.AutoStrictify is enabled, the parser invokes reST parser
167.         #   internally.  But recommonmark-0.4.0 does not provide settings_spec for reST
168.         #   parser.  As a workaround, this copies settings_spec for RSTParser to the
169.         #   CommonMarkParser.
170.         from docutils.parsers.rst import Parser as RSTParser
171. 
172.         parser.settings_spec = RSTParser.settings_spec
173. 
174.     pub = Publisher(
175.         reader=reader,
176.         parser=parser,
177.         writer=SphinxDummyWriter(),
178.         source_class=SphinxFileInput,
179.         destination=NullOutput(),
180.     )
181.     # Propagate exceptions by default when used programmatically:
182.     defaults = {"traceback": True, **app.env.settings}
183.     # Set default settings
184.     if docutils.__version_info__[:2] >= (0, 19):
185.         pub.get_settings(**defaults)
186.     else:
187.         pub.settings = pub.setup_option_parser(**defaults).get_default_values()
188.     return pub


File: sphinx/util/rst.py
Line number range: 1 - 110
Content:
1. """reST helper functions."""
2. 
3. from __future__ import annotations
4. 
5. import re
6. from collections import defaultdict
7. from contextlib import contextmanager
8. from typing import Generator
9. from unicodedata import east_asian_width
10. 
11. from docutils.parsers.rst import roles
12. from docutils.parsers.rst.languages import en as english
13. from docutils.statemachine import StringList
14. from docutils.utils import Reporter
15. from jinja2 import Environment
16. 
17. from sphinx.locale import __
18. from sphinx.util import docutils, logging
19. 
20. try:
21.     from jinja2.utils import pass_environment
22. except ImportError:
23.     from jinja2 import environmentfilter as pass_environment
24. 
25. 
26. logger = logging.getLogger(__name__)
27. 
28. docinfo_re = re.compile(':\\w+:.*?')
29. symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
30. SECTIONING_CHARS = ['=', '-', '~']
31. 
32. # width of characters
33. WIDECHARS: dict[str, str] = defaultdict(lambda: "WF")  # WF: Wide + Full-width
34. WIDECHARS["ja"] = "WFA"  # In Japanese, Ambiguous characters also have double width
35. 
36. 
37. def escape(text: str) -> str:
38.     text = symbols_re.sub(r'\\\1', text)
39.     text = re.sub(r'^\.', r'\.', text)  # escape a dot at top
40.     return text
41. 
42. 
43. def textwidth(text: str, widechars: str = 'WF') -> int:
44.     """Get width of text."""
45.     def charwidth(char: str, widechars: str) -> int:
46.         if east_asian_width(char) in widechars:
47.             return 2
48.         else:
49.             return 1
50. 
51.     return sum(charwidth(c, widechars) for c in text)
52. 
53. 
54. @pass_environment
55. def heading(env: Environment, text: str, level: int = 1) -> str:
56.     """Create a heading for *level*."""
57.     assert level <= 3
58.     width = textwidth(text, WIDECHARS[env.language])
59.     sectioning_char = SECTIONING_CHARS[level - 1]
60.     return f'{text}\n{sectioning_char * width}'
61. 
62. 
63. @contextmanager
64. def default_role(docname: str, name: str) -> Generator[None, None, None]:
65.     if name:
66.         dummy_reporter = Reporter('', 4, 4)
67.         role_fn, _ = roles.role(name, english, 0, dummy_reporter)
68.         if role_fn:  # type: ignore[truthy-function]
69.             docutils.register_role('', role_fn)
70.         else:
71.             logger.warning(__('default role %s not found'), name, location=docname)
72. 
73.     yield
74. 
75.     docutils.unregister_role('')
76. 
77. 
78. def prepend_prolog(content: StringList, prolog: str) -> None:
79.     """Prepend a string to content body as prolog."""
80.     if prolog:
81.         pos = 0
82.         for line in content:
83.             if docinfo_re.match(line):
84.                 pos += 1
85.             else:
86.                 break
87. 
88.         if pos > 0:
89.             # insert a blank line after docinfo
90.             content.insert(pos, '', '<generated>', 0)
91.             pos += 1
92. 
93.         # insert prolog (after docinfo if exists)
94.         for lineno, line in enumerate(prolog.splitlines()):
95.             content.insert(pos + lineno, line, '<rst_prolog>', lineno)
96. 
97.         content.insert(pos + lineno + 1, '', '<generated>', 0)
98. 
99. 
100. def append_epilog(content: StringList, epilog: str) -> None:
101.     """Append a string to content body as epilog."""
102.     if epilog:
103.         if len(content) > 0:
104.             source, lineno = content.info(-1)
105.         else:
106.             source = '<generated>'
107.             lineno = 0
108.         content.append('', source, lineno + 1)
109.         for lineno, line in enumerate(epilog.splitlines()):
110.             content.append(line, '<rst_epilog>', lineno)

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 00:44:12,671 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The current context explains *how* the prolog is prepended incorrectly (`sphinx/util/rst.py`) and what the immediate consequences are for title extraction (`sphinx/environment/collectors/title.py`), but it doesn't show *what* triggers the prepending of `rst_prolog`. The `sphinx/io.py` file suggests a `source-read` event is the mechanism. I need to find the event handler that calls `prepend_prolog`, which is most likely located in `sphinx/environment/__init__.py` within the `BuildEnvironment` class. Additionally, to fully understand the bug's impact on the table of contents as described by the user, I need the code for the `toctree` collector." query='Please provide the full content of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`.' extra_requirements='' purpose='This will reveal how `rst_prolog` is applied to the source content and how the resulting parsing error affects the table of contents generation.'
2025-12-23 00:44:12,672 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`.
2025-12-23 00:44:12,672 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 00:44:12,673 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 00:44:12,673 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 00:44:12,673 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`.
Purpose: This will reveal how `rst_prolog` is applied to the source content and how the resulting parsing error affects the table of contents generation.
2025-12-23 00:44:15,632 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have initiated a search for the full content of the two specified files. The first file I am retrieving is `sphinx/environment/__init__.py` to understand its role in the environment setup. Following that, I will access `sphinx/environment/collectors/toctree.py` to examine its functionality related to the table of contents.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/environment/collectors/toctree.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2093, 'candidates_token_count': 114, 'total_token_count': 2351, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2093}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 114}], 'thoughts_token_count': 144, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.15147455115067332, 'model_name': 'gemini-2.5-pro'} id='run--7945fc7a-aee9-488a-a5d2-5fa8dd708490-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/environment/__init__.py'}, 'id': '271df6b5-0767-46cf-afce-cd86a3e5be9e', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/environment/collectors/toctree.py'}, 'id': '8a2c19d3-30bc-40ab-a7eb-208a7c388b02', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2093, 'output_tokens': 114, 'total_tokens': 2351, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 144}}
2025-12-23 00:45:38,346 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the contents of both `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`. The first file sets up the build environment, and the second one specifically handles the collection and processing of table of contents data. Now, I will proceed to analyze these files to understand how `rst_prolog` is being used and how any parsing errors might be affecting the table of contents generation. My initial focus will be on finding where `rst_prolog` is applied within the environment setup.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "rst_prolog", "relative_path": "sphinx/environment/__init__.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'citation_metadata': {'citations': [{'start_index': 29352, 'end_index': 29769, 'uri': 'https://github.com/jimmymalhan/code_master_platform', 'title': '', 'license_': ''}, {'start_index': 35281, 'end_index': 35540, 'uri': 'https://github.com/siscraping/backend-django', 'title': '', 'license_': ''}]}, 'usage_metadata': {'prompt_token_count': 15542, 'candidates_token_count': 145, 'total_token_count': 24300, 'cached_content_token_count': 1898, 'prompt_tokens_details': [{'modality': 1, 'token_count': 15542}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1898}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 145}], 'thoughts_token_count': 8613}, 'finish_reason': 'STOP', 'avg_logprobs': -5.655704471982759, 'model_name': 'gemini-2.5-pro'} id='run--b8c99443-0f85-4184-8182-d3464606e075-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'rst_prolog', 'relative_path': 'sphinx/environment/__init__.py'}, 'id': 'a1322fb5-a90b-4ec2-8e75-a123296a98e7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15542, 'output_tokens': 145, 'total_tokens': 24300, 'input_token_details': {'cache_read': 1898}, 'output_token_details': {'reasoning': 8613}}
2025-12-23 00:45:50,658 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I've retrieved the contents of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py` as requested. My next step is to analyze these files to understand how `rst_prolog` is applied and how parsing errors might affect the table of contents. I will start by searching for mentions of `rst_prolog` within the project to identify where this configuration is handled. Based on my initial review, it seems `rst_prolog` is not directly referenced in the two files I've already examined. Therefore, I will broaden my search to locate the code responsible for reading and parsing the source documents, as this is the most likely place for `rst_prolog` to be implemented." additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "application.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 15719, 'candidates_token_count': 166, 'total_token_count': 16901, 'cached_content_token_count': 15168, 'prompt_tokens_details': [{'modality': 1, 'token_count': 15719}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15168}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 166}], 'thoughts_token_count': 1016}, 'finish_reason': 'STOP', 'avg_logprobs': -1.2037127391401543, 'model_name': 'gemini-2.5-pro'} id='run--053588cd-292b-4f63-9a4f-b093a18e54d9-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'application.py'}, 'id': '64614736-776a-4232-8c61-2ae2feba4e68', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15719, 'output_tokens': 166, 'total_tokens': 16901, 'input_token_details': {'cache_read': 15168}, 'output_token_details': {'reasoning': 1016}}
2025-12-23 00:45:53,558 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the contents of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`, and a search for "rst_prolog" in the former yielded no results. I then located `application.py` and will now examine it for how `rst_prolog` is handled, as this seems like a more likely location for its implementation.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "rst_prolog", "relative_path": "sphinx/application.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 15936, 'candidates_token_count': 113, 'total_token_count': 16153, 'cached_content_token_count': 15150, 'prompt_tokens_details': [{'modality': 1, 'token_count': 15936}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15150}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 113}], 'thoughts_token_count': 104}, 'finish_reason': 'STOP', 'avg_logprobs': -0.1959841736650045, 'model_name': 'gemini-2.5-pro'} id='run--e74f8568-1bc5-4dc5-a98b-d2735effb24c-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'rst_prolog', 'relative_path': 'sphinx/application.py'}, 'id': 'e7c3142a-c3a4-4db4-accb-6d75e62b7fc7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15936, 'output_tokens': 113, 'total_tokens': 16153, 'input_token_details': {'cache_read': 15150}, 'output_token_details': {'reasoning': 104}}
2025-12-23 00:45:59,224 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the contents of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`, and also searched for "rst_prolog" in `sphinx/application.py`, all with no results. This suggests that `rst_prolog` is likely handled at a different stage of the process, probably during the initial parsing of the reStructuredText files. Therefore, I am now shifting my focus to find the relevant "reader" or "parser" components within the Sphinx codebase to trace how this configuration is applied. I will start by looking for a file with "reader" in its name.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "readers.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 16081, 'candidates_token_count': 144, 'total_token_count': 16601, 'cached_content_token_count': 15129, 'prompt_tokens_details': [{'modality': 1, 'token_count': 16081}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15129}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 144}], 'thoughts_token_count': 376}, 'finish_reason': 'STOP', 'avg_logprobs': -0.4554302957322862, 'model_name': 'gemini-2.5-pro'} id='run--204f8499-3015-44c8-b37a-f67871893acf-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'readers.py'}, 'id': '6ca168a2-3f32-42c9-9297-0a9847dbf111', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16081, 'output_tokens': 144, 'total_tokens': 16601, 'input_token_details': {'cache_read': 15129}, 'output_token_details': {'reasoning': 376}}
2025-12-23 00:46:02,548 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the contents of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`, and my searches for "rst_prolog" in both those files, as well as in `sphinx/application.py`, have come up empty. I also tried to find a `readers.py` file without success. It\'s clear that `rst_prolog` is not being handled in the areas I\'ve looked at so far, so I\'m now turning my attention to the parsing mechanism itself. My next step is to locate a file with "parser" in its name, which should lead me to the code that processes the reStructuredText source and applies the `rst_prolog` configuration.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "parser.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 16247, 'candidates_token_count': 168, 'total_token_count': 16489, 'cached_content_token_count': 15114, 'prompt_tokens_details': [{'modality': 1, 'token_count': 16247}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15114}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 168}], 'thoughts_token_count': 74}, 'finish_reason': 'STOP', 'avg_logprobs': -0.2654432342165992, 'model_name': 'gemini-2.5-pro'} id='run--20e8599b-151a-4938-a593-64dd4524108f-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'parser.py'}, 'id': '72590c2a-510a-4712-b7e8-90c0e512bb8f', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16247, 'output_tokens': 168, 'total_tokens': 16489, 'input_token_details': {'cache_read': 15114}, 'output_token_details': {'reasoning': 74}}
2025-12-23 00:46:05,398 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I\'ve already retrieved the contents of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`, but my search for "rst_prolog" in those files, along with `sphinx/application.py`, proved fruitless. After also failing to locate a `readers.py` file, I\'ve now found `sphinx/pycode/parser.py`. My next step is to examine this file for any references to "rst_prolog" to finally pinpoint where it\'s being handled.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "rst_prolog", "relative_path": "sphinx/pycode/parser.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 16469, 'candidates_token_count': 147, 'total_token_count': 16710, 'cached_content_token_count': 15097, 'prompt_tokens_details': [{'modality': 1, 'token_count': 16469}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15097}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 147}], 'thoughts_token_count': 94}, 'finish_reason': 'STOP', 'avg_logprobs': -0.18670266339568053, 'model_name': 'gemini-2.5-pro'} id='run--c25a5fb6-3095-4db5-8f53-8c9a9179a18b-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'rst_prolog', 'relative_path': 'sphinx/pycode/parser.py'}, 'id': 'a317ba14-f88d-48dc-8732-1207cc62a39e', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16469, 'output_tokens': 147, 'total_tokens': 16710, 'input_token_details': {'cache_read': 15097}, 'output_token_details': {'reasoning': 94}}
2025-12-23 00:46:10,990 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have already examined `sphinx/environment/__init__.py`, `sphinx/environment/collectors/toctree.py`, `sphinx/application.py`, and `sphinx/pycode/parser.py` for "rst_prolog" without success. It seems the logic I\'m looking for is not in these files. I will now investigate the build process itself, starting with a search for a `builder.py` file, as this is a likely place to find the code that reads the source files and applies the `rst_prolog` configuration.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "builder.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 16648, 'candidates_token_count': 129, 'total_token_count': 17159, 'cached_content_token_count': 15081, 'prompt_tokens_details': [{'modality': 1, 'token_count': 16648}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15081}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 129}], 'thoughts_token_count': 382}, 'finish_reason': 'STOP', 'avg_logprobs': -0.7150912617528161, 'model_name': 'gemini-2.5-pro'} id='run--db65137f-b4d9-466a-8f5a-724d08919010-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'builder.py'}, 'id': 'bf5f47ea-7bc9-4b01-b97f-edc300c89b1d', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16648, 'output_tokens': 129, 'total_tokens': 17159, 'input_token_details': {'cache_read': 15081}, 'output_token_details': {'reasoning': 382}}
2025-12-23 00:46:19,184 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have already examined several files, including `sphinx/environment/__init__.py`, `sphinx/environment/collectors/toctree.py`, `sphinx/application.py`, and `sphinx/pycode/parser.py`, without finding any direct references to `rst_prolog`. My attempts to locate `readers.py` and `builder.py` were also unsuccessful. It appears I have been looking in the wrong places, so I am now going to investigate the `get_doctree` method within the `sphinx/environment/__init__.py` file, as this is likely where the document is retrieved and prepared for parsing.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "get_doctree", "relative_path": "sphinx/environment/__init__.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 16799, 'candidates_token_count': 165, 'total_token_count': 17608, 'cached_content_token_count': 15065, 'prompt_tokens_details': [{'modality': 1, 'token_count': 16799}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15065}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 165}], 'thoughts_token_count': 644}, 'finish_reason': 'STOP', 'avg_logprobs': -0.7671905517578125, 'model_name': 'gemini-2.5-pro'} id='run--4a5651f2-a568-47bf-b655-568aec2c43af-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'get_doctree', 'relative_path': 'sphinx/environment/__init__.py'}, 'id': '1a54b705-1a1b-4966-8dbc-a4f25954f215', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16799, 'output_tokens': 165, 'total_tokens': 17608, 'input_token_details': {'cache_read': 15065}, 'output_token_details': {'reasoning': 644}}
2025-12-23 00:46:24,740 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have already examined several files, including `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`, without finding where `rst_prolog` is handled. My investigation into `get_doctree` in `sphinx/environment/__init__.py` revealed that it only loads a pre-existing doctree, so the processing of `rst_prolog` must happen before that. I am now looking for the code responsible for the initial reading and parsing of the document, and will start by searching for a file named `io.py`.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "io.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 23884, 'candidates_token_count': 133, 'total_token_count': 24395, 'cached_content_token_count': 15276, 'prompt_tokens_details': [{'modality': 1, 'token_count': 23884}], 'cache_tokens_details': [{'modality': 1, 'token_count': 15276}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 133}], 'thoughts_token_count': 378}, 'finish_reason': 'STOP', 'avg_logprobs': -0.6565215605542176, 'model_name': 'gemini-2.5-pro'} id='run--1fbbca84-594e-4b21-b85e-d7cc8b3cbe53-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'io.py'}, 'id': 'ba9a0ad1-99db-424c-ae1f-fa6bd16792f2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23884, 'output_tokens': 133, 'total_tokens': 24395, 'input_token_details': {'cache_read': 15276}, 'output_token_details': {'reasoning': 378}}
2025-12-23 00:46:26,769 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I have already examined several files, including `sphinx/environment/__init__.py`, `sphinx/environment/collectors/toctree.py`, and `sphinx/pycode/parser.py`, without finding the logic for `rst_prolog`. I've now located `sphinx/io.py`, which I believe is responsible for reading the source files. My next step is to examine this file for how `rst_prolog` is applied during the file reading process." additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "rst_prolog", "relative_path": "sphinx/io.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 24068, 'candidates_token_count': 130, 'total_token_count': 24198, 'cached_content_token_count': 22893, 'prompt_tokens_details': [{'modality': 1, 'token_count': 24068}], 'cache_tokens_details': [{'modality': 1, 'token_count': 22893}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 130}], 'thoughts_token_count': 0}, 'finish_reason': 'STOP', 'avg_logprobs': -0.15931629767784705, 'model_name': 'gemini-2.5-pro'} id='run--fec94473-85f9-49cf-9e9b-ba22a545eb28-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'rst_prolog', 'relative_path': 'sphinx/io.py'}, 'id': '8466772e-d893-4dd8-8e65-e76c002ca4f8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24068, 'output_tokens': 130, 'total_tokens': 24198, 'input_token_details': {'cache_read': 22893}}
2025-12-23 00:46:29,103 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have already examined `sphinx/environment/__init__.py`, `sphinx/environment/collectors/toctree.py`, `sphinx/application.py`, `sphinx/pycode/parser.py`, and `sphinx/io.py` for "rst_prolog" without success. It seems I\'ve been looking in all the wrong places. I am now going to investigate the `read_doc` method within the `sphinx/io.py` file, as this is likely where the document is read and prepared for parsing.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "read_doc", "relative_path": "sphinx/io.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 24230, 'candidates_token_count': 142, 'total_token_count': 24372, 'cached_content_token_count': 22873, 'prompt_tokens_details': [{'modality': 1, 'token_count': 24230}], 'cache_tokens_details': [{'modality': 1, 'token_count': 22873}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 142}], 'thoughts_token_count': 0}, 'finish_reason': 'STOP', 'avg_logprobs': -0.12963235881966603, 'model_name': 'gemini-2.5-pro'} id='run--d10d76ae-758a-4cf5-ac95-1b73fe1e10bd-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'read_doc', 'relative_path': 'sphinx/io.py'}, 'id': '9e052eb4-926f-4e1e-b1a9-936241961532', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24230, 'output_tokens': 142, 'total_tokens': 24372, 'input_token_details': {'cache_read': 22873}}
2025-12-23 00:46:34,444 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have already examined several files, including `sphinx/environment/__init__.py`, `sphinx/environment/collectors/toctree.py`, `sphinx/application.py`, `sphinx/pycode/parser.py`, and `sphinx/io.py`, without finding any references to `rst_prolog`. It appears I have been looking in the wrong places. I will now search for a file named `rst.py` as it is a likely candidate for handling reStructuredText parsing, which is where `rst_prolog` would be applied.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "rst.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 24404, 'candidates_token_count': 128, 'total_token_count': 24901, 'cached_content_token_count': 22853, 'prompt_tokens_details': [{'modality': 1, 'token_count': 24404}], 'cache_tokens_details': [{'modality': 1, 'token_count': 22853}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 128}], 'thoughts_token_count': 369}, 'finish_reason': 'STOP', 'avg_logprobs': -0.6339601874351501, 'model_name': 'gemini-2.5-pro'} id='run--c9bf89e1-40ef-400d-9db5-1d3a3f235cb2-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'rst.py'}, 'id': '31c86491-7ae6-4d86-8df3-844526ae7286', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24404, 'output_tokens': 128, 'total_tokens': 24901, 'input_token_details': {'cache_read': 22853}, 'output_token_details': {'reasoning': 369}}
2025-12-23 00:46:36,603 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have already examined several files in my search for where `rst_prolog` is handled, without success. I have now located two `rst.py` files, one in `sphinx/util` and another in `sphinx/domains`. I will start by examining `sphinx/util/rst.py` to see if it contains the logic for applying `rst_prolog` to the source content.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "rst_prolog", "relative_path": "sphinx/util/rst.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 24629, 'candidates_token_count': 118, 'total_token_count': 24747, 'cached_content_token_count': 22827, 'prompt_tokens_details': [{'modality': 1, 'token_count': 24629}], 'cache_tokens_details': [{'modality': 1, 'token_count': 22827}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 118}], 'thoughts_token_count': 0}, 'finish_reason': 'STOP', 'avg_logprobs': -0.08730527101936987, 'model_name': 'gemini-2.5-pro'} id='run--ca5fc59a-e2df-45b1-a7b1-7984262c4fb9-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'rst_prolog', 'relative_path': 'sphinx/util/rst.py'}, 'id': 'f54f4b24-d057-463b-ab0e-da9ec3147d5b', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24629, 'output_tokens': 118, 'total_tokens': 24747, 'input_token_details': {'cache_read': 22827}}
2025-12-23 00:46:40,659 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully located the `prepend_prolog` function in `sphinx/util/rst.py`, which is responsible for prepending the `rst_prolog` to the source content. This function inserts the prolog after any docinfo, which is a key part of the process. Now that I have found this, I will continue to investigate how the parsing error is affecting the table of contents generation by examining the call stack of this function.' additional_kwargs={'function_call': {'name': 'read_code_with_relative_path', 'arguments': '{"start_line": 1.0, "relative_path": "sphinx/util/rst.py", "end_line": 98.0}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 25065, 'candidates_token_count': 118, 'total_token_count': 25389, 'cached_content_token_count': 22802, 'prompt_tokens_details': [{'modality': 1, 'token_count': 25065}], 'cache_tokens_details': [{'modality': 1, 'token_count': 22802}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 118}], 'thoughts_token_count': 206}, 'finish_reason': 'STOP', 'avg_logprobs': -0.36512672295004633, 'model_name': 'gemini-2.5-pro'} id='run--29c1c33a-6ec5-4fcf-a0d6-77de480f9cff-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'start_line': 1.0, 'relative_path': 'sphinx/util/rst.py', 'end_line': 98.0}, 'id': '62915d5c-d505-4258-8993-69d571be6394', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25065, 'output_tokens': 118, 'total_tokens': 25389, 'input_token_details': {'cache_read': 22802}, 'output_token_details': {'reasoning': 206}}
2025-12-23 00:46:44,741 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully located the `prepend_prolog` function in `sphinx/util/rst.py` and examined its implementation. My next step is to determine where this function is being called to understand the full context of its execution. To do this, I will now perform a global search for "prepend_prolog" across the entire codebase to identify all call sites. This will allow me to trace the execution flow and pinpoint how a parsing error could impact the table of contents generation.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_basename', 'arguments': '{"text": "prepend_prolog"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 26507, 'candidates_token_count': 121, 'total_token_count': 26840, 'cached_content_token_count': 24714, 'prompt_tokens_details': [{'modality': 1, 'token_count': 26507}], 'cache_tokens_details': [{'modality': 1, 'token_count': 24714}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 121}], 'thoughts_token_count': 212}, 'finish_reason': 'STOP', 'avg_logprobs': -0.4365495413788094, 'model_name': 'gemini-2.5-pro'} id='run--8358cb32-869e-4677-91de-fa855320d59f-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'prepend_prolog'}, 'id': '2bdadd27-f1ef-4601-98cc-2c8433cfa265', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26507, 'output_tokens': 121, 'total_tokens': 26840, 'input_token_details': {'cache_read': 24714}, 'output_token_details': {'reasoning': 212}}
2025-12-23 00:46:49,000 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have located the `prepend_prolog` function in `sphinx/util/rst.py` and examined its implementation. I made an error in my previous attempt to find where this function is called. I will now correct this by specifically searching for calls to `prepend_prolog` within `sphinx/io.py`, as this file is responsible for file I/O and is a likely place for this function to be used.' additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "prepend_prolog", "relative_path": "sphinx/io.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 26688, 'candidates_token_count': 121, 'total_token_count': 27029, 'cached_content_token_count': 24696, 'prompt_tokens_details': [{'modality': 1, 'token_count': 26688}], 'cache_tokens_details': [{'modality': 1, 'token_count': 24696}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 121}], 'thoughts_token_count': 220}, 'finish_reason': 'STOP', 'avg_logprobs': -0.4535065327794099, 'model_name': 'gemini-2.5-pro'} id='run--d73de7a5-5183-4667-9b6a-755376bf7dba-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'prepend_prolog', 'relative_path': 'sphinx/io.py'}, 'id': '63b4dcbe-a199-437c-9f68-6111efbbc86c', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26688, 'output_tokens': 121, 'total_tokens': 27029, 'input_token_details': {'cache_read': 24696}, 'output_token_details': {'reasoning': 220}}
2025-12-23 00:46:52,760 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have located the `prepend_prolog` function in `sphinx/util/rst.py`, but my attempts to find its call sites in `sphinx/io.py` and other files have been unsuccessful. It appears I have been looking in the wrong places. I will now search for a file with "source" in its name, as this is a likely candidate for handling the source input and applying the `rst_prolog` configuration.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "source.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 26841, 'candidates_token_count': 105, 'total_token_count': 27124, 'cached_content_token_count': 26574, 'prompt_tokens_details': [{'modality': 1, 'token_count': 26841}], 'cache_tokens_details': [{'modality': 1, 'token_count': 26574}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 105}], 'thoughts_token_count': 178}, 'finish_reason': 'STOP', 'avg_logprobs': -0.4308045160202753, 'model_name': 'gemini-2.5-pro'} id='run--c9b48139-6f01-4c3f-9f9b-5a9e0de7d373-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'source.py'}, 'id': '46d29465-2dc8-44d5-ba09-96bb6877079d', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26841, 'output_tokens': 105, 'total_tokens': 27124, 'input_token_details': {'cache_read': 26574}, 'output_token_details': {'reasoning': 178}}
2025-12-23 00:46:56,011 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have located the `prepend_prolog` function in `sphinx/util/rst.py`, but my attempts to find where it is called have so far been unsuccessful. I am now looking for a file named `parsers.py`, as this is a likely place to find the code that handles parsing and would, therefore, call the `prepend_prolog` function.' additional_kwargs={'function_call': {'name': 'find_file_node_with_basename', 'arguments': '{"basename": "parsers.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 26968, 'candidates_token_count': 90, 'total_token_count': 27213, 'cached_content_token_count': 26554, 'prompt_tokens_details': [{'modality': 1, 'token_count': 26968}], 'cache_tokens_details': [{'modality': 1, 'token_count': 26554}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 90}], 'thoughts_token_count': 155}, 'finish_reason': 'STOP', 'avg_logprobs': -0.4393145243326823, 'model_name': 'gemini-2.5-pro'} id='run--df8b87a3-7179-4012-a160-a18c46a48343-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'parsers.py'}, 'id': '033a399b-6790-4347-9803-9757a965cd89', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26968, 'output_tokens': 90, 'total_tokens': 27213, 'input_token_details': {'cache_read': 26554}, 'output_token_details': {'reasoning': 155}}
2025-12-23 00:46:58,672 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I have located the `prepend_prolog` function and now, after a few attempts, I've found `sphinx/parsers.py`. I will now examine this file for calls to `prepend_prolog` to understand how the prolog is being added to the source before parsing. This should give me the context I need to understand the parsing error." additional_kwargs={'function_call': {'name': 'find_ast_node_with_text_in_file_with_relative_path', 'arguments': '{"text": "prepend_prolog", "relative_path": "sphinx/parsers.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 27109, 'candidates_token_count': 105, 'total_token_count': 27270, 'cached_content_token_count': 26530, 'prompt_tokens_details': [{'modality': 1, 'token_count': 27109}], 'cache_tokens_details': [{'modality': 1, 'token_count': 26530}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 105}], 'thoughts_token_count': 56}, 'finish_reason': 'STOP', 'avg_logprobs': -0.2016095479329427, 'model_name': 'gemini-2.5-pro'} id='run--19a32014-9d2f-4fda-bba3-809a67ca9ed8-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'prepend_prolog', 'relative_path': 'sphinx/parsers.py'}, 'id': '31a7e759-148f-47a4-888c-6e05e8efc1a1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27109, 'output_tokens': 105, 'total_tokens': 27270, 'input_token_details': {'cache_read': 26530}, 'output_token_details': {'reasoning': 56}}
2025-12-23 00:47:05,182 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully traced the handling of `rst_prolog` to the `RSTParser` class in `sphinx/parsers.py`. I found that the `decorate` method within this class calls the `prepend_prolog` function, which is imported from `sphinx/util/rst.py`. This `prepend_prolog` function is responsible for inserting the `rst_prolog` content at the beginning of the reStructuredText source before it is parsed, which gives me a clear understanding of how it is applied. With this, I have a complete picture of the process and can now analyze how a parsing error would affect the table of contents generation.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 27847, 'candidates_token_count': 136, 'total_token_count': 28522, 'cached_content_token_count': 26505, 'prompt_tokens_details': [{'modality': 1, 'token_count': 27847}], 'cache_tokens_details': [{'modality': 1, 'token_count': 26505}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 136}], 'thoughts_token_count': 539}, 'finish_reason': 'STOP', 'avg_logprobs': -0.5612116420970243, 'model_name': 'gemini-2.5-pro'} id='run--9a2fe25c-2b1f-4303-a5f5-9364535bc248-0' usage_metadata={'input_tokens': 27847, 'output_tokens': 136, 'total_tokens': 28522, 'input_token_details': {'cache_read': 26505}, 'output_token_details': {'reasoning': 539}}
2025-12-23 00:47:05,184 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
This will reveal how `rst_prolog` is applied to the source content and how the resulting parsing error affects the table of contents generation.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: sphinx/environment/__init__.py
Line number range: 1 - 500
Content:
1. """Global creation environment."""
2. 
3. from __future__ import annotations
4. 
5. import functools
6. import os
7. import pickle
8. from collections import defaultdict
9. from copy import copy
10. from datetime import datetime, timezone
11. from os import path
12. from typing import TYPE_CHECKING, Any, Callable, Generator, Iterator
13. 
14. from docutils import nodes
15. from docutils.nodes import Node
16. 
17. from sphinx import addnodes
18. from sphinx.config import Config
19. from sphinx.domains import Domain
20. from sphinx.environment.adapters.toctree import TocTree
21. from sphinx.errors import BuildEnvironmentError, DocumentError, ExtensionError, SphinxError
22. from sphinx.events import EventManager
23. from sphinx.locale import __
24. from sphinx.project import Project
25. from sphinx.transforms import SphinxTransformer
26. from sphinx.util import DownloadFiles, FilenameUniqDict, logging
27. from sphinx.util.docutils import LoggingReporter
28. from sphinx.util.i18n import CatalogRepository, docname_to_domain
29. from sphinx.util.nodes import is_translatable
30. from sphinx.util.osutil import canon_path, os_path
31. 
32. if TYPE_CHECKING:
33.     from sphinx.application import Sphinx
34.     from sphinx.builders import Builder
35. 
36. logger = logging.getLogger(__name__)
37. 
38. default_settings: dict[str, Any] = {
39.     'auto_id_prefix': 'id',
40.     'image_loading': 'link',
41.     'embed_stylesheet': False,
42.     'cloak_email_addresses': True,
43.     'pep_base_url': 'https://peps.python.org/',
44.     'pep_references': None,
45.     'rfc_base_url': 'https://datatracker.ietf.org/doc/html/',
46.     'rfc_references': None,
47.     'input_encoding': 'utf-8-sig',
48.     'doctitle_xform': False,
49.     'sectsubtitle_xform': False,
50.     'section_self_link': False,
51.     'halt_level': 5,
52.     'file_insertion_enabled': True,
53.     'smartquotes_locales': [],
54. }
55. 
56. # This is increased every time an environment attribute is added
57. # or changed to properly invalidate pickle files.
58. ENV_VERSION = 58
59. 
60. # config status
61. CONFIG_OK = 1
62. CONFIG_NEW = 2
63. CONFIG_CHANGED = 3
64. CONFIG_EXTENSIONS_CHANGED = 4
65. 
66. CONFIG_CHANGED_REASON = {
67.     CONFIG_NEW: __('new config'),
68.     CONFIG_CHANGED: __('config changed'),
69.     CONFIG_EXTENSIONS_CHANGED: __('extensions changed'),
70. }
71. 
72. 
73. versioning_conditions: dict[str, bool | Callable] = {
74.     'none': False,
75.     'text': is_translatable,
76. }
77. 
78. if TYPE_CHECKING:
79.     from typing import Literal, MutableMapping
80. 
81.     from typing_extensions import overload
82. 
83.     from sphinx.domains.c import CDomain
84.     from sphinx.domains.changeset import ChangeSetDomain
85.     from sphinx.domains.citation import CitationDomain
86.     from sphinx.domains.cpp import CPPDomain
87.     from sphinx.domains.index import IndexDomain
88.     from sphinx.domains.javascript import JavaScriptDomain
89.     from sphinx.domains.math import MathDomain
90.     from sphinx.domains.python import PythonDomain
91.     from sphinx.domains.rst import ReSTDomain
92.     from sphinx.domains.std import StandardDomain
93.     from sphinx.ext.duration import DurationDomain
94.     from sphinx.ext.todo import TodoDomain
95. 
96.     class _DomainsType(MutableMapping[str, Domain]):
97.         @overload
98.         def __getitem__(self, key: Literal["c"]) -> CDomain: ...  # NoQA: E704
99.         @overload
100.         def __getitem__(self, key: Literal["cpp"]) -> CPPDomain: ...  # NoQA: E704
101.         @overload
102.         def __getitem__(self, key: Literal["changeset"]) -> ChangeSetDomain: ...  # NoQA: E704
103.         @overload
104.         def __getitem__(self, key: Literal["citation"]) -> CitationDomain: ...  # NoQA: E704
105.         @overload
106.         def __getitem__(self, key: Literal["index"]) -> IndexDomain: ...  # NoQA: E704
107.         @overload
108.         def __getitem__(self, key: Literal["js"]) -> JavaScriptDomain: ...  # NoQA: E704
109.         @overload
110.         def __getitem__(self, key: Literal["math"]) -> MathDomain: ...  # NoQA: E704
111.         @overload
112.         def __getitem__(self, key: Literal["py"]) -> PythonDomain: ...  # NoQA: E704
113.         @overload
114.         def __getitem__(self, key: Literal["rst"]) -> ReSTDomain: ...  # NoQA: E704
115.         @overload
116.         def __getitem__(self, key: Literal["std"]) -> StandardDomain: ...  # NoQA: E704
117.         @overload
118.         def __getitem__(self, key: Literal["duration"]) -> DurationDomain: ...  # NoQA: E704
119.         @overload
120.         def __getitem__(self, key: Literal["todo"]) -> TodoDomain: ...  # NoQA: E704
121.         @overload
122.         def __getitem__(self, key: str) -> Domain: ...  # NoQA: E704
123.         def __getitem__(self, key): raise NotImplementedError  # NoQA: E704
124.         def __setitem__(self, key, value): raise NotImplementedError  # NoQA: E704
125.         def __delitem__(self, key): raise NotImplementedError  # NoQA: E704
126.         def __iter__(self): raise NotImplementedError  # NoQA: E704
127.         def __len__(self): raise NotImplementedError  # NoQA: E704
128. 
129. else:
130.     _DomainsType = dict
131. 
132. 
133. class BuildEnvironment:
134.     """
135.     The environment in which the ReST files are translated.
136.     Stores an inventory of cross-file targets and provides doctree
137.     transformations to resolve links to them.
138.     """
139. 
140.     domains: _DomainsType
141. 
142.     # --------- ENVIRONMENT INITIALIZATION -------------------------------------
143. 
144.     def __init__(self, app: Sphinx):
145.         self.app: Sphinx = None
146.         self.doctreedir: str = None
147.         self.srcdir: str = None
148.         self.config: Config = None
149.         self.config_status: int = None
150.         self.config_status_extra: str = None
151.         self.events: EventManager = None
152.         self.project: Project = None
153.         self.version: dict[str, str] = None
154. 
155.         # the method of doctree versioning; see set_versioning_method
156.         self.versioning_condition: bool | Callable = None
157.         self.versioning_compare: bool = None
158. 
159.         # all the registered domains, set by the application
160.         self.domains = _DomainsType()
161. 
162.         # the docutils settings for building
163.         self.settings = default_settings.copy()
164.         self.settings['env'] = self
165. 
166.         # All "docnames" here are /-separated and relative and exclude
167.         # the source suffix.
168. 
169.         # docname -> time of reading (in integer microseconds)
170.         # contains all read docnames
171.         self.all_docs: dict[str, int] = {}
172.         # docname -> set of dependent file
173.         # names, relative to documentation root
174.         self.dependencies: dict[str, set[str]] = defaultdict(set)
175.         # docname -> set of included file
176.         # docnames included from other documents
177.         self.included: dict[str, set[str]] = defaultdict(set)
178.         # docnames to re-read unconditionally on next build
179.         self.reread_always: set[str] = set()
180. 
181.         # docname -> pickled doctree
182.         self._pickled_doctree_cache: dict[str, bytes] = {}
183. 
184.         # docname -> doctree
185.         self._write_doc_doctree_cache: dict[str, nodes.document] = {}
186. 
187.         # File metadata
188.         # docname -> dict of metadata items
189.         self.metadata: dict[str, dict[str, Any]] = defaultdict(dict)
190. 
191.         # TOC inventory
192.         # docname -> title node
193.         self.titles: dict[str, nodes.title] = {}
194.         # docname -> title node; only different if
195.         # set differently with title directive
196.         self.longtitles: dict[str, nodes.title] = {}
197.         # docname -> table of contents nodetree
198.         self.tocs: dict[str, nodes.bullet_list] = {}
199.         # docname -> number of real entries
200.         self.toc_num_entries: dict[str, int] = {}
201. 
202.         # used to determine when to show the TOC
203.         # in a sidebar (don't show if it's only one item)
204.         # docname -> dict of sectionid -> number
205.         self.toc_secnumbers: dict[str, dict[str, tuple[int, ...]]] = {}
206.         # docname -> dict of figtype -> dict of figureid -> number
207.         self.toc_fignumbers: dict[str, dict[str, dict[str, tuple[int, ...]]]] = {}
208. 
209.         # docname -> list of toctree includefiles
210.         self.toctree_includes: dict[str, list[str]] = {}
211.         # docname -> set of files (containing its TOCs) to rebuild too
212.         self.files_to_rebuild: dict[str, set[str]] = {}
213.         # docnames that have :glob: toctrees
214.         self.glob_toctrees: set[str] = set()
215.         # docnames that have :numbered: toctrees
216.         self.numbered_toctrees: set[str] = set()
217. 
218.         # domain-specific inventories, here to be pickled
219.         # domainname -> domain-specific dict
220.         self.domaindata: dict[str, dict] = {}
221. 
222.         # these map absolute path -> (docnames, unique filename)
223.         self.images: FilenameUniqDict = FilenameUniqDict()
224.         # filename -> (set of docnames, destination)
225.         self.dlfiles: DownloadFiles = DownloadFiles()
226. 
227.         # the original URI for images
228.         self.original_image_uri: dict[str, str] = {}
229. 
230.         # temporary data storage while reading a document
231.         self.temp_data: dict[str, Any] = {}
232.         # context for cross-references (e.g. current module or class)
233.         # this is similar to temp_data, but will for example be copied to
234.         # attributes of "any" cross references
235.         self.ref_context: dict[str, Any] = {}
236. 
237.         # search index data
238. 
239.         # docname -> title
240.         self._search_index_titles: dict[str, str] = {}
241.         # docname -> filename
242.         self._search_index_filenames: dict[str, str] = {}
243.         # stemmed words -> set(docname)
244.         self._search_index_mapping: dict[str, set[str]] = {}
245.         # stemmed words in titles -> set(docname)
246.         self._search_index_title_mapping: dict[str, set[str]] = {}
247.         # docname -> all titles in document
248.         self._search_index_all_titles: dict[str, list[tuple[str, str]]] = {}
249.         # docname -> list(index entry)
250.         self._search_index_index_entries: dict[str, list[tuple[str, str, str]]] = {}
251.         # objtype -> index
252.         self._search_index_objtypes: dict[tuple[str, str], int] = {}
253.         # objtype index -> (domain, type, objname (localized))
254.         self._search_index_objnames: dict[int, tuple[str, str, str]] = {}
255. 
256.         # set up environment
257.         self.setup(app)
258. 
259.     def __getstate__(self) -> dict:
260.         """Obtains serializable data for pickling."""
261.         __dict__ = self.__dict__.copy()
262.         __dict__.update(app=None, domains={}, events=None)  # clear unpickable attributes
263.         return __dict__
264. 
265.     def __setstate__(self, state: dict) -> None:
266.         self.__dict__.update(state)
267. 
268.     def setup(self, app: Sphinx) -> None:
269.         """Set up BuildEnvironment object."""
270.         if self.version and self.version != app.registry.get_envversion(app):
271.             raise BuildEnvironmentError(__('build environment version not current'))
272.         if self.srcdir and self.srcdir != app.srcdir:
273.             raise BuildEnvironmentError(__('source directory has changed'))
274. 
275.         if self.project:
276.             app.project.restore(self.project)
277. 
278.         self.app = app
279.         self.doctreedir = app.doctreedir
280.         self.events = app.events
281.         self.srcdir = app.srcdir
282.         self.project = app.project
283.         self.version = app.registry.get_envversion(app)
284. 
285.         # initialize domains
286.         self.domains = _DomainsType()
287.         for domain in app.registry.create_domains(self):
288.             self.domains[domain.name] = domain
289. 
290.         # setup domains (must do after all initialization)
291.         for domain in self.domains.values():
292.             domain.setup()
293. 
294.         # initialize config
295.         self._update_config(app.config)
296. 
297.         # initialie settings
298.         self._update_settings(app.config)
299. 
300.     def _update_config(self, config: Config) -> None:
301.         """Update configurations by new one."""
302.         self.config_status = CONFIG_OK
303.         self.config_status_extra = ''
304.         if self.config is None:
305.             self.config_status = CONFIG_NEW
306.         elif self.config.extensions != config.extensions:
307.             self.config_status = CONFIG_EXTENSIONS_CHANGED
308.             extensions = sorted(
309.                 set(self.config.extensions) ^ set(config.extensions))
310.             if len(extensions) == 1:
311.                 extension = extensions[0]
312.             else:
313.                 extension = '%d' % (len(extensions),)
314.             self.config_status_extra = f' ({extension!r})'
315.         else:
316.             # check if a config value was changed that affects how
317.             # doctrees are read
318.             for item in config.filter('env'):
319.                 if self.config[item.name] != item.value:
320.                     self.config_status = CONFIG_CHANGED
321.                     self.config_status_extra = f' ({item.name!r})'
322.                     break
323. 
324.         self.config = config
325. 
326.     def _update_settings(self, config: Config) -> None:
327.         """Update settings by new config."""
328.         self.settings['input_encoding'] = config.source_encoding
329.         self.settings['trim_footnote_reference_space'] = config.trim_footnote_reference_space
330.         self.settings['language_code'] = config.language
331. 
332.         # Allow to disable by 3rd party extension (workaround)
333.         self.settings.setdefault('smart_quotes', True)
334. 
335.     def set_versioning_method(self, method: str | Callable, compare: bool) -> None:
336.         """This sets the doctree versioning method for this environment.
337. 
338.         Versioning methods are a builder property; only builders with the same
339.         versioning method can share the same doctree directory.  Therefore, we
340.         raise an exception if the user tries to use an environment with an
341.         incompatible versioning method.
342.         """
343.         condition: bool | Callable
344.         if callable(method):
345.             condition = method
346.         else:
347.             if method not in versioning_conditions:
348.                 raise ValueError('invalid versioning method: %r' % method)
349.             condition = versioning_conditions[method]
350. 
351.         if self.versioning_condition not in (None, condition):
352.             raise SphinxError(__('This environment is incompatible with the '
353.                                  'selected builder, please choose another '
354.                                  'doctree directory.'))
355.         self.versioning_condition = condition
356.         self.versioning_compare = compare
357. 
358.     def clear_doc(self, docname: str) -> None:
359.         """Remove all traces of a source file in the inventory."""
360.         if docname in self.all_docs:
361.             self.all_docs.pop(docname, None)
362.             self.included.pop(docname, None)
363.             self.reread_always.discard(docname)
364. 
365.         for domain in self.domains.values():
366.             domain.clear_doc(docname)
367. 
368.     def merge_info_from(self, docnames: list[str], other: BuildEnvironment,
369.                         app: Sphinx) -> None:
370.         """Merge global information gathered about *docnames* while reading them
371.         from the *other* environment.
372. 
373.         This possibly comes from a parallel build process.
374.         """
375.         docnames = set(docnames)  # type: ignore
376.         for docname in docnames:
377.             self.all_docs[docname] = other.all_docs[docname]
378.             self.included[docname] = other.included[docname]
379.             if docname in other.reread_always:
380.                 self.reread_always.add(docname)
381. 
382.         for domainname, domain in self.domains.items():
383.             domain.merge_domaindata(docnames, other.domaindata[domainname])
384.         self.events.emit('env-merge-info', self, docnames, other)
385. 
386.     def path2doc(self, filename: str) -> str | None:
387.         """Return the docname for the filename if the file is document.
388. 
389.         *filename* should be absolute or relative to the source directory.
390.         """
391.         return self.project.path2doc(filename)
392. 
393.     def doc2path(self, docname: str, base: bool = True) -> str:
394.         """Return the filename for the document name.
395. 
396.         If *base* is True, return absolute path under self.srcdir.
397.         If *base* is False, return relative path to self.srcdir.
398.         """
399.         return self.project.doc2path(docname, base)
400. 
401.     def relfn2path(self, filename: str, docname: str | None = None) -> tuple[str, str]:
402.         """Return paths to a file referenced from a document, relative to
403.         documentation root and absolute.
404. 
405.         In the input "filename", absolute filenames are taken as relative to the
406.         source dir, while relative filenames are relative to the dir of the
407.         containing document.
408.         """
409.         filename = os_path(filename)
410.         if filename.startswith(('/', os.sep)):
411.             rel_fn = filename[1:]
412.         else:
413.             docdir = path.dirname(self.doc2path(docname or self.docname,
414.                                                 base=False))
415.             rel_fn = path.join(docdir, filename)
416. 
417.         return (canon_path(path.normpath(rel_fn)),
418.                 path.normpath(path.join(self.srcdir, rel_fn)))
419. 
420.     @property
421.     def found_docs(self) -> set[str]:
422.         """contains all existing docnames."""
423.         return self.project.docnames
424. 
425.     def find_files(self, config: Config, builder: Builder) -> None:
426.         """Find all source files in the source dir and put them in
427.         self.found_docs.
428.         """
429.         try:
430.             exclude_paths = (self.config.exclude_patterns +
431.                              self.config.templates_path +
432.                              builder.get_asset_paths())
433.             self.project.discover(exclude_paths, self.config.include_patterns)
434. 
435.             # Current implementation is applying translated messages in the reading
436.             # phase.Therefore, in order to apply the updated message catalog, it is
437.             # necessary to re-process from the reading phase. Here, if dependency
438.             # is set for the doc source and the mo file, it is processed again from
439.             # the reading phase when mo is updated. In the future, we would like to
440.             # move i18n process into the writing phase, and remove these lines.
441.             if builder.use_message_catalog:
442.                 # add catalog mo file dependency
443.                 repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
444.                                          self.config.language, self.config.source_encoding)
445.                 mo_paths = {c.domain: c.mo_path for c in repo.catalogs}
446.                 for docname in self.found_docs:
447.                     domain = docname_to_domain(docname, self.config.gettext_compact)
448.                     if domain in mo_paths:
449.                         self.dependencies[docname].add(mo_paths[domain])
450.         except OSError as exc:
451.             raise DocumentError(__('Failed to scan documents in %s: %r') %
452.                                 (self.srcdir, exc)) from exc
453. 
454.     def get_outdated_files(self, config_changed: bool) -> tuple[set[str], set[str], set[str]]:
455.         """Return (added, changed, removed) sets."""
456.         # clear all files no longer present
457.         removed = set(self.all_docs) - self.found_docs
458. 
459.         added: set[str] = set()
460.         changed: set[str] = set()
461. 
462.         if config_changed:
463.             # config values affect e.g. substitutions
464.             added = self.found_docs
465.         else:
466.             for docname in self.found_docs:
467.                 if docname not in self.all_docs:
468.                     logger.debug('[build target] added %r', docname)
469.                     added.add(docname)
470.                     continue
471.                 # if the doctree file is not there, rebuild
472.                 filename = path.join(self.doctreedir, docname + '.doctree')
473.                 if not path.isfile(filename):
474.                     logger.debug('[build target] changed %r', docname)
475.                     changed.add(docname)
476.                     continue
477.                 # check the "reread always" list
478.                 if docname in self.reread_always:
479.                     logger.debug('[build target] changed %r', docname)
480.                     changed.add(docname)
481.                     continue
482.                 # check the mtime of the document
483.                 mtime = self.all_docs[docname]
484.                 newmtime = _last_modified_time(self.doc2path(docname))
485.                 if newmtime > mtime:
486.                     # convert integer microseconds to floating-point seconds,
487.                     # and then to timezone-aware datetime objects.
488.                     mtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
489.                     newmtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
490.                     logger.debug('[build target] outdated %r: %s -> %s',
491.                                  docname, mtime_dt, newmtime_dt)
492.                     changed.add(docname)
493.                     continue
494.                 # finally, check the mtime of dependencies
495.                 for dep in self.dependencies[docname]:
496.                     try:
497.                         # this will do the right thing when dep is absolute too
498.                         deppath = path.join(self.srcdir, dep)
499.                         if not path.isfile(deppath):
500.                             changed.add(docname)


File: sphinx/environment/__init__.py
Line number range: 133 - 732
Content:
class BuildEnvironment:
    """
    The environment in which the ReST files are translated.
    Stores an inventory of cross-file targets and provides doctree
    transformations to resolve links to them.
    """

    domains: _DomainsType

    # --------- ENVIRONMENT INITIALIZATION -------------------------------------

    def __init__(self, app: Sphinx):
        self.app: Sphinx = None
        self.doctreedir: str = None
        self.srcdir: str = None
        self.config: Config = None
        self.config_status: int = None
        self.config_status_extra: str = None
        self.events: EventManager = None
        self.project: Project = None
        self.version: dict[str, str] = None

        # the method of doctree versioning; see set_versioning_method
        self.versioning_condition: bool | Callable = None
        self.versioning_compare: bool = None

        # all the registered domains, set by the application
        self.domains = _DomainsType()

        # the docutils settings for building
        self.settings = default_settings.copy()
        self.settings['env'] = self

        # All "docnames" here are /-separated and relative and exclude
        # the source suffix.

        # docname -> time of reading (in integer microseconds)
        # contains all read docnames
        self.all_docs: dict[str, int] = {}
        # docname -> set of dependent file
        # names, relative to documentation root
        self.dependencies: dict[str, set[str]] = defaultdict(set)
        # docname -> set of included file
        # docnames included from other documents
        self.included: dict[str, set[str]] = defaultdict(set)
        # docnames to re-read unconditionally on next build
        self.reread_always: set[str] = set()

        # docname -> pickled doctree
        self._pickled_doctree_cache: dict[str, bytes] = {}

        # docname -> doctree
        self._write_doc_doctree_cache: dict[str, nodes.document] = {}

        # File metadata
        # docname -> dict of metadata items
        self.metadata: dict[str, dict[str, Any]] = defaultdict(dict)

        # TOC inventory
        # docname -> title node
        self.titles: dict[str, nodes.title] = {}
        # docname -> title node; only different if
        # set differently with title directive
        self.longtitles: dict[str, nodes.title] = {}
        # docname -> table of contents nodetree
        self.tocs: dict[str, nodes.bullet_list] = {}
        # docname -> number of real entries
        self.toc_num_entries: dict[str, int] = {}

        # used to determine when to show the TOC
        # in a sidebar (don't show if it's only one item)
        # docname -> dict of sectionid -> number
        self.toc_secnumbers: dict[str, dict[str, tuple[int, ...]]] = {}
        # docname -> dict of figtype -> dict of figureid -> number
        self.toc_fignumbers: dict[str, dict[str, dict[str, tuple[int, ...]]]] = {}

        # docname -> list of toctree includefiles
        self.toctree_includes: dict[str, list[str]] = {}
        # docname -> set of files (containing its TOCs) to rebuild too
        self.files_to_rebuild: dict[str, set[str]] = {}
        # docnames that have :glob: toctrees
        self.glob_toctrees: set[str] = set()
        # docnames that have :numbered: toctrees
        self.numbered_toctrees: set[str] = set()

        # domain-specific inventories, here to be pickled
        # domainname -> domain-specific dict
        self.domaindata: dict[str, dict] = {}

        # these map absolute path -> (docnames, unique filename)
        self.images: FilenameUniqDict = FilenameUniqDict()
        # filename -> (set of docnames, destination)
        self.dlfiles: DownloadFiles = DownloadFiles()

        # the original URI for images
        self.original_image_uri: dict[str, str] = {}

        # temporary data storage while reading a document
        self.temp_data: dict[str, Any] = {}
        # context for cross-references (e.g. current module or class)
        # this is similar to temp_data, but will for example be copied to
        # attributes of "any" cross references
        self.ref_context: dict[str, Any] = {}

        # search index data

        # docname -> title
        self._search_index_titles: dict[str, str] = {}
        # docname -> filename
        self._search_index_filenames: dict[str, str] = {}
        # stemmed words -> set(docname)
        self._search_index_mapping: dict[str, set[str]] = {}
        # stemmed words in titles -> set(docname)
        self._search_index_title_mapping: dict[str, set[str]] = {}
        # docname -> all titles in document
        self._search_index_all_titles: dict[str, list[tuple[str, str]]] = {}
        # docname -> list(index entry)
        self._search_index_index_entries: dict[str, list[tuple[str, str, str]]] = {}
        # objtype -> index
        self._search_index_objtypes: dict[tuple[str, str], int] = {}
        # objtype index -> (domain, type, objname (localized))
        self._search_index_objnames: dict[int, tuple[str, str, str]] = {}

        # set up environment
        self.setup(app)

    def __getstate__(self) -> dict:
        """Obtains serializable data for pickling."""
        __dict__ = self.__dict__.copy()
        __dict__.update(app=None, domains={}, events=None)  # clear unpickable attributes
        return __dict__

    def __setstate__(self, state: dict) -> None:
        self.__dict__.update(state)

    def setup(self, app: Sphinx) -> None:
        """Set up BuildEnvironment object."""
        if self.version and self.version != app.registry.get_envversion(app):
            raise BuildEnvironmentError(__('build environment version not current'))
        if self.srcdir and self.srcdir != app.srcdir:
            raise BuildEnvironmentError(__('source directory has changed'))

        if self.project:
            app.project.restore(self.project)

        self.app = app
        self.doctreedir = app.doctreedir
        self.events = app.events
        self.srcdir = app.srcdir
        self.project = app.project
        self.version = app.registry.get_envversion(app)

        # initialize domains
        self.domains = _DomainsType()
        for domain in app.registry.create_domains(self):
            self.domains[domain.name] = domain

        # setup domains (must do after all initialization)
        for domain in self.domains.values():
            domain.setup()

        # initialize config
        self._update_config(app.config)

        # initialie settings
        self._update_settings(app.config)

    def _update_config(self, config: Config) -> None:
        """Update configurations by new one."""
        self.config_status = CONFIG_OK
        self.config_status_extra = ''
        if self.config is None:
            self.config_status = CONFIG_NEW
        elif self.config.extensions != config.extensions:
            self.config_status = CONFIG_EXTENSIONS_CHANGED
            extensions = sorted(
                set(self.config.extensions) ^ set(config.extensions))
            if len(extensions) == 1:
                extension = extensions[0]
            else:
                extension = '%d' % (len(extensions),)
            self.config_status_extra = f' ({extension!r})'
        else:
            # check if a config value was changed that affects how
            # doctrees are read
            for item in config.filter('env'):
                if self.config[item.name] != item.value:
                    self.config_status = CONFIG_CHANGED
                    self.config_status_extra = f' ({item.name!r})'
                    break

        self.config = config

    def _update_settings(self, config: Config) -> None:
        """Update settings by new config."""
        self.settings['input_encoding'] = config.source_encoding
        self.settings['trim_footnote_reference_space'] = config.trim_footnote_reference_space
        self.settings['language_code'] = config.language

        # Allow to disable by 3rd party extension (workaround)
        self.settings.setdefault('smart_quotes', True)

    def set_versioning_method(self, method: str | Callable, compare: bool) -> None:
        """This sets the doctree versioning method for this environment.

        Versioning methods are a builder property; only builders with the same
        versioning method can share the same doctree directory.  Therefore, we
        raise an exception if the user tries to use an environment with an
        incompatible versioning method.
        """
        condition: bool | Callable
        if callable(method):
            condition = method
        else:
            if method not in versioning_conditions:
                raise ValueError('invalid versioning method: %r' % method)
            condition = versioning_conditions[method]

        if self.versioning_condition not in (None, condition):
            raise SphinxError(__('This environment is incompatible with the '
                                 'selected builder, please choose another '
                                 'doctree directory.'))
        self.versioning_condition = condition
        self.versioning_compare = compare

    def clear_doc(self, docname: str) -> None:
        """Remove all traces of a source file in the inventory."""
        if docname in self.all_docs:
            self.all_docs.pop(docname, None)
            self.included.pop(docname, None)
            self.reread_always.discard(docname)

        for domain in self.domains.values():
            domain.clear_doc(docname)

    def merge_info_from(self, docnames: list[str], other: BuildEnvironment,
                        app: Sphinx) -> None:
        """Merge global information gathered about *docnames* while reading them
        from the *other* environment.

        This possibly comes from a parallel build process.
        """
        docnames = set(docnames)  # type: ignore
        for docname in docnames:
            self.all_docs[docname] = other.all_docs[docname]
            self.included[docname] = other.included[docname]
            if docname in other.reread_always:
                self.reread_always.add(docname)

        for domainname, domain in self.domains.items():
            domain.merge_domaindata(docnames, other.domaindata[domainname])
        self.events.emit('env-merge-info', self, docnames, other)

    def path2doc(self, filename: str) -> str | None:
        """Return the docname for the filename if the file is document.

        *filename* should be absolute or relative to the source directory.
        """
        return self.project.path2doc(filename)

    def doc2path(self, docname: str, base: bool = True) -> str:
        """Return the filename for the document name.

        If *base* is True, return absolute path under self.srcdir.
        If *base* is False, return relative path to self.srcdir.
        """
        return self.project.doc2path(docname, base)

    def relfn2path(self, filename: str, docname: str | None = None) -> tuple[str, str]:
        """Return paths to a file referenced from a document, relative to
        documentation root and absolute.

        In the input "filename", absolute filenames are taken as relative to the
        source dir, while relative filenames are relative to the dir of the
        containing document.
        """
        filename = os_path(filename)
        if filename.startswith(('/', os.sep)):
            rel_fn = filename[1:]
        else:
            docdir = path.dirname(self.doc2path(docname or self.docname,
                                                base=False))
            rel_fn = path.join(docdir, filename)

        return (canon_path(path.normpath(rel_fn)),
                path.normpath(path.join(self.srcdir, rel_fn)))

    @property
    def found_docs(self) -> set[str]:
        """contains all existing docnames."""
        return self.project.docnames

    def find_files(self, config: Config, builder: Builder) -> None:
        """Find all source files in the source dir and put them in
        self.found_docs.
        """
        try:
            exclude_paths = (self.config.exclude_patterns +
                             self.config.templates_path +
                             builder.get_asset_paths())
            self.project.discover(exclude_paths, self.config.include_patterns)

            # Current implementation is applying translated messages in the reading
            # phase.Therefore, in order to apply the updated message catalog, it is
            # necessary to re-process from the reading phase. Here, if dependency
            # is set for the doc source and the mo file, it is processed again from
            # the reading phase when mo is updated. In the future, we would like to
            # move i18n process into the writing phase, and remove these lines.
            if builder.use_message_catalog:
                # add catalog mo file dependency
                repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
                                         self.config.language, self.config.source_encoding)
                mo_paths = {c.domain: c.mo_path for c in repo.catalogs}
                for docname in self.found_docs:
                    domain = docname_to_domain(docname, self.config.gettext_compact)
                    if domain in mo_paths:
                        self.dependencies[docname].add(mo_paths[domain])
        except OSError as exc:
            raise DocumentError(__('Failed to scan documents in %s: %r') %
                                (self.srcdir, exc)) from exc

    def get_outdated_files(self, config_changed: bool) -> tuple[set[str], set[str], set[str]]:
        """Return (added, changed, removed) sets."""
        # clear all files no longer present
        removed = set(self.all_docs) - self.found_docs

        added: set[str] = set()
        changed: set[str] = set()

        if config_changed:
            # config values affect e.g. substitutions
            added = self.found_docs
        else:
            for docname in self.found_docs:
                if docname not in self.all_docs:
                    logger.debug('[build target] added %r', docname)
                    added.add(docname)
                    continue
                # if the doctree file is not there, rebuild
                filename = path.join(self.doctreedir, docname + '.doctree')
                if not path.isfile(filename):
                    logger.debug('[build target] changed %r', docname)
                    changed.add(docname)
                    continue
                # check the "reread always" list
                if docname in self.reread_always:
                    logger.debug('[build target] changed %r', docname)
                    changed.add(docname)
                    continue
                # check the mtime of the document
                mtime = self.all_docs[docname]
                newmtime = _last_modified_time(self.doc2path(docname))
                if newmtime > mtime:
                    # convert integer microseconds to floating-point seconds,
                    # and then to timezone-aware datetime objects.
                    mtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
                    newmtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
                    logger.debug('[build target] outdated %r: %s -> %s',
                                 docname, mtime_dt, newmtime_dt)
                    changed.add(docname)
                    continue
                # finally, check the mtime of dependencies
                for dep in self.dependencies[docname]:
                    try:
                        # this will do the right thing when dep is absolute too
                        deppath = path.join(self.srcdir, dep)
                        if not path.isfile(deppath):
                            changed.add(docname)
                            break
                        depmtime = _last_modified_time(deppath)
                        if depmtime > mtime:
                            changed.add(docname)
                            break
                    except OSError:
                        # give it another chance
                        changed.add(docname)
                        break

        return added, changed, removed

    def check_dependents(self, app: Sphinx, already: set[str]) -> Generator[str, None, None]:
        to_rewrite: list[str] = []
        for docnames in self.events.emit('env-get-updated', self):
            to_rewrite.extend(docnames)
        for docname in set(to_rewrite):
            if docname not in already:
                yield docname

    # --------- SINGLE FILE READING --------------------------------------------

    def prepare_settings(self, docname: str) -> None:
        """Prepare to set up environment for reading."""
        self.temp_data['docname'] = docname
        # defaults to the global default, but can be re-set in a document
        self.temp_data['default_role'] = self.config.default_role
        self.temp_data['default_domain'] = \
            self.domains.get(self.config.primary_domain)

    # utilities to use while reading a document

    @property
    def docname(self) -> str:
        """Returns the docname of the document currently being parsed."""
        return self.temp_data['docname']

    def new_serialno(self, category: str = '') -> int:
        """Return a serial number, e.g. for index entry targets.

        The number is guaranteed to be unique in the current document.
        """
        key = category + 'serialno'
        cur = self.temp_data.get(key, 0)
        self.temp_data[key] = cur + 1
        return cur

    def note_dependency(self, filename: str) -> None:
        """Add *filename* as a dependency of the current document.

        This means that the document will be rebuilt if this file changes.

        *filename* should be absolute or relative to the source directory.
        """
        self.dependencies[self.docname].add(filename)

    def note_included(self, filename: str) -> None:
        """Add *filename* as a included from other document.

        This means the document is not orphaned.

        *filename* should be absolute or relative to the source directory.
        """
        doc = self.path2doc(filename)
        if doc:
            self.included[self.docname].add(doc)

    def note_reread(self) -> None:
        """Add the current document to the list of documents that will
        automatically be re-read at the next build.
        """
        self.reread_always.add(self.docname)

    def get_domain(self, domainname: str) -> Domain:
        """Return the domain instance with the specified name.

        Raises an ExtensionError if the domain is not registered.
        """
        try:
            return self.domains[domainname]
        except KeyError as exc:
            raise ExtensionError(__('Domain %r is not registered') % domainname) from exc

    # --------- RESOLVING REFERENCES AND TOCTREES ------------------------------

    def get_doctree(self, docname: str) -> nodes.document:
        """Read the doctree for a file from the pickle and return it."""
        try:
            serialised = self._pickled_doctree_cache[docname]
        except KeyError:
            filename = path.join(self.doctreedir, docname + '.doctree')
            with open(filename, 'rb') as f:
                serialised = self._pickled_doctree_cache[docname] = f.read()

        doctree = pickle.loads(serialised)
        doctree.settings.env = self
        doctree.reporter = LoggingReporter(self.doc2path(docname))
        return doctree

    @functools.cached_property
    def master_doctree(self) -> nodes.document:
        return self.get_doctree(self.config.root_doc)

    def get_and_resolve_doctree(
        self,
        docname: str,
        builder: Builder,
        doctree: nodes.document | None = None,
        prune_toctrees: bool = True,
        includehidden: bool = False,
    ) -> nodes.document:
        """Read the doctree from the pickle, resolve cross-references and
        toctrees and return it.
        """
        if doctree is None:
            try:
                doctree = self._write_doc_doctree_cache.pop(docname)
                doctree.settings.env = self
                doctree.reporter = LoggingReporter(self.doc2path(docname))
            except KeyError:
                doctree = self.get_doctree(docname)

        # resolve all pending cross-references
        self.apply_post_transforms(doctree, docname)

        # now, resolve all toctree nodes
        for toctreenode in doctree.findall(addnodes.toctree):
            result = TocTree(self).resolve(docname, builder, toctreenode,
                                           prune=prune_toctrees,
                                           includehidden=includehidden)
            if result is None:
                toctreenode.replace_self([])
            else:
                toctreenode.replace_self(result)

        return doctree

    def resolve_toctree(self, docname: str, builder: Builder, toctree: addnodes.toctree,
                        prune: bool = True, maxdepth: int = 0, titles_only: bool = False,
                        collapse: bool = False, includehidden: bool = False) -> Node | None:
        """Resolve a *toctree* node into individual bullet lists with titles
        as items, returning None (if no containing titles are found) or
        a new node.

        If *prune* is True, the tree is pruned to *maxdepth*, or if that is 0,
        to the value of the *maxdepth* option on the *toctree* node.
        If *titles_only* is True, only toplevel document titles will be in the
        resulting tree.
        If *collapse* is True, all branches not containing docname will
        be collapsed.
        """
        return TocTree(self).resolve(docname, builder, toctree, prune,
                                     maxdepth, titles_only, collapse,
                                     includehidden)

    def resolve_references(self, doctree: nodes.document, fromdocname: str,
                           builder: Builder) -> None:
        self.apply_post_transforms(doctree, fromdocname)

    def apply_post_transforms(self, doctree: nodes.document, docname: str) -> None:
        """Apply all post-transforms."""
        try:
            # set env.docname during applying post-transforms
            backup = copy(self.temp_data)
            self.temp_data['docname'] = docname

            transformer = SphinxTransformer(doctree)
            transformer.set_environment(self)
            transformer.add_transforms(self.app.registry.get_post_transforms())
            transformer.apply_transforms()
        finally:
            self.temp_data = backup

        # allow custom references to be resolved
        self.events.emit('doctree-resolved', doctree, docname)

    def collect_relations(self) -> dict[str, list[str | None]]:
        traversed = set()

        def traverse_toctree(
            parent: str | None, docname: str,
        ) -> Iterator[tuple[str | None, str]]:
            if parent == docname:
                logger.warning(__('self referenced toctree found. Ignored.'),
                               location=docname, type='toc',
                               subtype='circular')
                return

            # traverse toctree by pre-order
            yield parent, docname
            traversed.add(docname)

            for child in (self.toctree_includes.get(docname) or []):
                for subparent, subdocname in traverse_toctree(docname, child):
                    if subdocname not in traversed:
                        yield subparent, subdocname
                        traversed.add(subdocname)

        relations = {}
        docnames = traverse_toctree(None, self.config.root_doc)
        prevdoc = None
        parent, docname = next(docnames)
        for nextparent, nextdoc in docnames:
            relations[docname] = [parent, prevdoc, nextdoc]
            prevdoc = docname
            docname = nextdoc
            parent = nextparent

        relations[docname] = [parent, prevdoc, None]

        return relations

    def check_consistency(self) -> None:
        """Do consistency checks."""
        included = set().union(*self.included.values())
        for docname in sorted(self.all_docs):
            if docname not in self.files_to_rebuild:
                if docname == self.config.root_doc:
                    # the master file is not included anywhere ;)
                    continue
                if docname in included:
                    # the document is included from other documents
                    continue
                if 'orphan' in self.metadata[docname]:
                    continue
                logger.warning(__("document isn't included in any toctree"),
                               location=docname)

        # call check-consistency for all extensions
        for domain in self.domains.values():
            domain.check_consistency()
        self.events.emit('env-check-consistency', self)


File: sphinx/environment/collectors/toctree.py
Line number range: 1 - 350
Content:
1. """Toctree collector for sphinx.environment."""
2. 
3. from __future__ import annotations
4. 
5. from typing import Any, Sequence, TypeVar, cast
6. 
7. from docutils import nodes
8. from docutils.nodes import Element, Node
9. 
10. from sphinx import addnodes
11. from sphinx.application import Sphinx
12. from sphinx.environment import BuildEnvironment
13. from sphinx.environment.adapters.toctree import TocTree
14. from sphinx.environment.collectors import EnvironmentCollector
15. from sphinx.locale import __
16. from sphinx.transforms import SphinxContentsFilter
17. from sphinx.util import logging, url_re
18. 
19. N = TypeVar('N')
20. 
21. logger = logging.getLogger(__name__)
22. 
23. 
24. class TocTreeCollector(EnvironmentCollector):
25.     def clear_doc(self, app: Sphinx, env: BuildEnvironment, docname: str) -> None:
26.         env.tocs.pop(docname, None)
27.         env.toc_secnumbers.pop(docname, None)
28.         env.toc_fignumbers.pop(docname, None)
29.         env.toc_num_entries.pop(docname, None)
30.         env.toctree_includes.pop(docname, None)
31.         env.glob_toctrees.discard(docname)
32.         env.numbered_toctrees.discard(docname)
33. 
34.         for subfn, fnset in list(env.files_to_rebuild.items()):
35.             fnset.discard(docname)
36.             if not fnset:
37.                 del env.files_to_rebuild[subfn]
38. 
39.     def merge_other(self, app: Sphinx, env: BuildEnvironment, docnames: set[str],
40.                     other: BuildEnvironment) -> None:
41.         for docname in docnames:
42.             env.tocs[docname] = other.tocs[docname]
43.             env.toc_num_entries[docname] = other.toc_num_entries[docname]
44.             if docname in other.toctree_includes:
45.                 env.toctree_includes[docname] = other.toctree_includes[docname]
46.             if docname in other.glob_toctrees:
47.                 env.glob_toctrees.add(docname)
48.             if docname in other.numbered_toctrees:
49.                 env.numbered_toctrees.add(docname)
50. 
51.         for subfn, fnset in other.files_to_rebuild.items():
52.             env.files_to_rebuild.setdefault(subfn, set()).update(fnset & set(docnames))
53. 
54.     def process_doc(self, app: Sphinx, doctree: nodes.document) -> None:
55.         """Build a TOC from the doctree and store it in the inventory."""
56.         docname = app.env.docname
57.         numentries = [0]  # nonlocal again...
58. 
59.         def build_toc(
60.             node: Element | Sequence[Element],
61.             depth: int = 1,
62.         ) -> nodes.bullet_list | None:
63.             # list of table of contents entries
64.             entries: list[Element] = []
65.             # cache of parents -> list item
66.             memo_parents: dict[tuple[str, ...], nodes.list_item] = {}
67.             for sectionnode in node:
68.                 # find all toctree nodes in this section and add them
69.                 # to the toc (just copying the toctree node which is then
70.                 # resolved in self.get_and_resolve_doctree)
71.                 if isinstance(sectionnode, nodes.section):
72.                     title = sectionnode[0]
73.                     # copy the contents of the section title, but without references
74.                     # and unnecessary stuff
75.                     visitor = SphinxContentsFilter(doctree)
76.                     title.walkabout(visitor)
77.                     nodetext = visitor.get_entry_text()
78.                     anchorname = _make_anchor_name(sectionnode['ids'], numentries)
79.                     # make these nodes:
80.                     # list_item -> compact_paragraph -> reference
81.                     reference = nodes.reference(
82.                         '', '', internal=True, refuri=docname,
83.                         anchorname=anchorname, *nodetext)
84.                     para = addnodes.compact_paragraph('', '', reference)
85.                     item: Element = nodes.list_item('', para)
86.                     sub_item = build_toc(sectionnode, depth + 1)
87.                     if sub_item:
88.                         item += sub_item
89.                     entries.append(item)
90.                 # Wrap items under an ``.. only::`` directive in a node for
91.                 # post-processing
92.                 elif isinstance(sectionnode, addnodes.only):
93.                     onlynode = addnodes.only(expr=sectionnode['expr'])
94.                     blist = build_toc(sectionnode, depth)
95.                     if blist:
96.                         onlynode += blist.children
97.                         entries.append(onlynode)
98.                 # check within the section for other node types
99.                 elif isinstance(sectionnode, nodes.Element):
100.                     toctreenode: nodes.Node
101.                     for toctreenode in sectionnode.findall():
102.                         if isinstance(toctreenode, nodes.section):
103.                             continue
104.                         if isinstance(toctreenode, addnodes.toctree):
105.                             item = toctreenode.copy()
106.                             entries.append(item)
107.                             # important: do the inventory stuff
108.                             TocTree(app.env).note(docname, toctreenode)
109.                         # add object signatures within a section to the ToC
110.                         elif isinstance(toctreenode, addnodes.desc):
111.                             for sig_node in toctreenode:
112.                                 if not isinstance(sig_node, addnodes.desc_signature):
113.                                     continue
114.                                 # Skip if no name set
115.                                 if not sig_node.get('_toc_name', ''):
116.                                     continue
117.                                 # Skip if explicitly disabled
118.                                 if sig_node.parent.get('nocontentsentry'):
119.                                     continue
120.                                 # Skip entries with no ID (e.g. with :noindex: set)
121.                                 ids = sig_node['ids']
122.                                 if not ids:
123.                                     continue
124. 
125.                                 anchorname = _make_anchor_name(ids, numentries)
126. 
127.                                 reference = nodes.reference(
128.                                     '', '', nodes.literal('', sig_node['_toc_name']),
129.                                     internal=True, refuri=docname, anchorname=anchorname)
130.                                 para = addnodes.compact_paragraph('', '', reference,
131.                                                                   skip_section_number=True)
132.                                 entry = nodes.list_item('', para)
133.                                 *parents, _ = sig_node['_toc_parts']
134.                                 parents = tuple(parents)
135. 
136.                                 # Cache parents tuple
137.                                 memo_parents[sig_node['_toc_parts']] = entry
138. 
139.                                 # Nest children within parents
140.                                 if parents and parents in memo_parents:
141.                                     root_entry = memo_parents[parents]
142.                                     if isinstance(root_entry[-1], nodes.bullet_list):
143.                                         root_entry[-1].append(entry)
144.                                     else:
145.                                         root_entry.append(nodes.bullet_list('', entry))
146.                                     continue
147. 
148.                                 entries.append(entry)
149. 
150.             if entries:
151.                 return nodes.bullet_list('', *entries)
152.             return None
153. 
154.         toc = build_toc(doctree)
155.         if toc:
156.             app.env.tocs[docname] = toc
157.         else:
158.             app.env.tocs[docname] = nodes.bullet_list('')
159.         app.env.toc_num_entries[docname] = numentries[0]
160. 
161.     def get_updated_docs(self, app: Sphinx, env: BuildEnvironment) -> list[str]:
162.         return self.assign_section_numbers(env) + self.assign_figure_numbers(env)
163. 
164.     def assign_section_numbers(self, env: BuildEnvironment) -> list[str]:
165.         """Assign a section number to each heading under a numbered toctree."""
166.         # a list of all docnames whose section numbers changed
167.         rewrite_needed = []
168. 
169.         assigned: set[str] = set()
170.         old_secnumbers = env.toc_secnumbers
171.         env.toc_secnumbers = {}
172. 
173.         def _walk_toc(
174.             node: Element, secnums: dict, depth: int, titlenode: nodes.title | None = None,
175.         ) -> None:
176.             # titlenode is the title of the document, it will get assigned a
177.             # secnumber too, so that it shows up in next/prev/parent rellinks
178.             for subnode in node.children:
179.                 if isinstance(subnode, nodes.bullet_list):
180.                     numstack.append(0)
181.                     _walk_toc(subnode, secnums, depth - 1, titlenode)
182.                     numstack.pop()
183.                     titlenode = None
184.                 elif isinstance(subnode, nodes.list_item):  # NoQA: SIM114
185.                     _walk_toc(subnode, secnums, depth, titlenode)
186.                     titlenode = None
187.                 elif isinstance(subnode, addnodes.only):
188.                     # at this stage we don't know yet which sections are going
189.                     # to be included; just include all of them, even if it leads
190.                     # to gaps in the numbering
191.                     _walk_toc(subnode, secnums, depth, titlenode)
192.                     titlenode = None
193.                 elif isinstance(subnode, addnodes.compact_paragraph):
194.                     if 'skip_section_number' in subnode:
195.                         continue
196.                     numstack[-1] += 1
197.                     reference = cast(nodes.reference, subnode[0])
198.                     if depth > 0:
199.                         number = list(numstack)
200.                         secnums[reference['anchorname']] = tuple(numstack)
201.                     else:
202.                         number = None
203.                         secnums[reference['anchorname']] = None
204.                     reference['secnumber'] = number
205.                     if titlenode:
206.                         titlenode['secnumber'] = number
207.                         titlenode = None
208.                 elif isinstance(subnode, addnodes.toctree):
209.                     _walk_toctree(subnode, depth)
210. 
211.         def _walk_toctree(toctreenode: addnodes.toctree, depth: int) -> None:
212.             if depth == 0:
213.                 return
214.             for (_title, ref) in toctreenode['entries']:
215.                 if url_re.match(ref) or ref == 'self':
216.                     # don't mess with those
217.                     continue
218.                 if ref in assigned:
219.                     logger.warning(__('%s is already assigned section numbers '
220.                                       '(nested numbered toctree?)'), ref,
221.                                    location=toctreenode, type='toc', subtype='secnum')
222.                 elif ref in env.tocs:
223.                     secnums: dict[str, tuple[int, ...]] = {}
224.                     env.toc_secnumbers[ref] = secnums
225.                     assigned.add(ref)
226.                     _walk_toc(env.tocs[ref], secnums, depth, env.titles.get(ref))
227.                     if secnums != old_secnumbers.get(ref):
228.                         rewrite_needed.append(ref)
229. 
230.         for docname in env.numbered_toctrees:
231.             assigned.add(docname)
232.             doctree = env.get_doctree(docname)
233.             for toctreenode in doctree.findall(addnodes.toctree):
234.                 depth = toctreenode.get('numbered', 0)
235.                 if depth:
236.                     # every numbered toctree gets new numbering
237.                     numstack = [0]
238.                     _walk_toctree(toctreenode, depth)
239. 
240.         return rewrite_needed
241. 
242.     def assign_figure_numbers(self, env: BuildEnvironment) -> list[str]:
243.         """Assign a figure number to each figure under a numbered toctree."""
244.         generated_docnames = frozenset(env.domains['std']._virtual_doc_names)
245. 
246.         rewrite_needed = []
247. 
248.         assigned: set[str] = set()
249.         old_fignumbers = env.toc_fignumbers
250.         env.toc_fignumbers = {}
251.         fignum_counter: dict[str, dict[tuple[int, ...], int]] = {}
252. 
253.         def get_figtype(node: Node) -> str | None:
254.             for domain in env.domains.values():
255.                 figtype = domain.get_enumerable_node_type(node)
256.                 if (domain.name == 'std'
257.                         and not domain.get_numfig_title(node)):  # type: ignore[attr-defined]  # NoQA: E501
258.                     # Skip if uncaptioned node
259.                     continue
260. 
261.                 if figtype:
262.                     return figtype
263. 
264.             return None
265. 
266.         def get_section_number(docname: str, section: nodes.section) -> tuple[int, ...]:
267.             anchorname = '#' + section['ids'][0]
268.             secnumbers = env.toc_secnumbers.get(docname, {})
269.             if anchorname in secnumbers:
270.                 secnum = secnumbers.get(anchorname)
271.             else:
272.                 secnum = secnumbers.get('')
273. 
274.             return secnum or ()
275. 
276.         def get_next_fignumber(figtype: str, secnum: tuple[int, ...]) -> tuple[int, ...]:
277.             counter = fignum_counter.setdefault(figtype, {})
278. 
279.             secnum = secnum[:env.config.numfig_secnum_depth]
280.             counter[secnum] = counter.get(secnum, 0) + 1
281.             return secnum + (counter[secnum],)
282. 
283.         def register_fignumber(docname: str, secnum: tuple[int, ...],
284.                                figtype: str, fignode: Element) -> None:
285.             env.toc_fignumbers.setdefault(docname, {})
286.             fignumbers = env.toc_fignumbers[docname].setdefault(figtype, {})
287.             figure_id = fignode['ids'][0]
288. 
289.             fignumbers[figure_id] = get_next_fignumber(figtype, secnum)
290. 
291.         def _walk_doctree(docname: str, doctree: Element, secnum: tuple[int, ...]) -> None:
292.             nonlocal generated_docnames
293.             for subnode in doctree.children:
294.                 if isinstance(subnode, nodes.section):
295.                     next_secnum = get_section_number(docname, subnode)
296.                     if next_secnum:
297.                         _walk_doctree(docname, subnode, next_secnum)
298.                     else:
299.                         _walk_doctree(docname, subnode, secnum)
300.                 elif isinstance(subnode, addnodes.toctree):
301.                     for _title, subdocname in subnode['entries']:
302.                         if url_re.match(subdocname) or subdocname == 'self':
303.                             # don't mess with those
304.                             continue
305.                         if subdocname in generated_docnames:
306.                             # or these
307.                             continue
308. 
309.                         _walk_doc(subdocname, secnum)
310.                 elif isinstance(subnode, nodes.Element):
311.                     figtype = get_figtype(subnode)
312.                     if figtype and subnode['ids']:
313.                         register_fignumber(docname, secnum, figtype, subnode)
314. 
315.                     _walk_doctree(docname, subnode, secnum)
316. 
317.         def _walk_doc(docname: str, secnum: tuple[int, ...]) -> None:
318.             if docname not in assigned:
319.                 assigned.add(docname)
320.                 doctree = env.get_doctree(docname)
321.                 _walk_doctree(docname, doctree, secnum)
322. 
323.         if env.config.numfig:
324.             _walk_doc(env.config.root_doc, ())
325.             for docname, fignums in env.toc_fignumbers.items():
326.                 if fignums != old_fignumbers.get(docname):
327.                     rewrite_needed.append(docname)
328. 
329.         return rewrite_needed
330. 
331. 
332. def _make_anchor_name(ids: list[str], num_entries: list[int]) -> str:
333.     if not num_entries[0]:
334.         # for the very first toc entry, don't add an anchor
335.         # as it is the file's title anyway
336.         anchorname = ''
337.     else:
338.         anchorname = '#' + ids[0]
339.     num_entries[0] += 1
340.     return anchorname
341. 
342. 
343. def setup(app: Sphinx) -> dict[str, Any]:
344.     app.add_env_collector(TocTreeCollector)
345. 
346.     return {
347.         'version': 'builtin',
348.         'parallel_read_safe': True,
349.         'parallel_write_safe': True,
350.     }


File: sphinx/parsers.py
Line number range: 17 - 17
Content:
from sphinx.util.rst import append_epilog, prepend_prolog


File: sphinx/parsers.py
Line number range: 48 - 86
Content:
class RSTParser(docutils.parsers.rst.Parser, Parser):
    """A reST parser for Sphinx."""

    def get_transforms(self) -> list[type[Transform]]:
        """
        Sphinx's reST parser replaces a transform class for smart-quotes by its own

        refs: sphinx.io.SphinxStandaloneReader
        """
        transforms = super().get_transforms()
        transforms.remove(SmartQuotes)
        return transforms

    def parse(self, inputstring: str | StringList, document: nodes.document) -> None:
        """Parse text and generate a document tree."""
        self.setup_parse(inputstring, document)  # type: ignore
        self.statemachine = states.RSTStateMachine(
            state_classes=self.state_classes,
            initial_state=self.initial_state,
            debug=document.reporter.debug_flag)

        # preprocess inputstring
        if isinstance(inputstring, str):
            lines = docutils.statemachine.string2lines(
                inputstring, tab_width=document.settings.tab_width,
                convert_whitespace=True)

            inputlines = StringList(lines, document.current_source)
        else:
            inputlines = inputstring

        self.decorate(inputlines)
        self.statemachine.run(inputlines, document, inliner=self.inliner)
        self.finish_parse()

    def decorate(self, content: StringList) -> None:
        """Preprocess reST content before parsing."""
        prepend_prolog(content, self.config.rst_prolog)
        append_epilog(content, self.config.rst_epilog)


File: sphinx/util/rst.py
Line number range: 1 - 98
Content:
1. """reST helper functions."""
2. 
3. from __future__ import annotations
4. 
5. import re
6. from collections import defaultdict
7. from contextlib import contextmanager
8. from typing import Generator
9. from unicodedata import east_asian_width
10. 
11. from docutils.parsers.rst import roles
12. from docutils.parsers.rst.languages import en as english
13. from docutils.statemachine import StringList
14. from docutils.utils import Reporter
15. from jinja2 import Environment
16. 
17. from sphinx.locale import __
18. from sphinx.util import docutils, logging
19. 
20. try:
21.     from jinja2.utils import pass_environment
22. except ImportError:
23.     from jinja2 import environmentfilter as pass_environment
24. 
25. 
26. logger = logging.getLogger(__name__)
27. 
28. docinfo_re = re.compile(':\\w+:.*?')
29. symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
30. SECTIONING_CHARS = ['=', '-', '~']
31. 
32. # width of characters
33. WIDECHARS: dict[str, str] = defaultdict(lambda: "WF")  # WF: Wide + Full-width
34. WIDECHARS["ja"] = "WFA"  # In Japanese, Ambiguous characters also have double width
35. 
36. 
37. def escape(text: str) -> str:
38.     text = symbols_re.sub(r'\\\1', text)
39.     text = re.sub(r'^\.', r'\.', text)  # escape a dot at top
40.     return text
41. 
42. 
43. def textwidth(text: str, widechars: str = 'WF') -> int:
44.     """Get width of text."""
45.     def charwidth(char: str, widechars: str) -> int:
46.         if east_asian_width(char) in widechars:
47.             return 2
48.         else:
49.             return 1
50. 
51.     return sum(charwidth(c, widechars) for c in text)
52. 
53. 
54. @pass_environment
55. def heading(env: Environment, text: str, level: int = 1) -> str:
56.     """Create a heading for *level*."""
57.     assert level <= 3
58.     width = textwidth(text, WIDECHARS[env.language])
59.     sectioning_char = SECTIONING_CHARS[level - 1]
60.     return f'{text}\n{sectioning_char * width}'
61. 
62. 
63. @contextmanager
64. def default_role(docname: str, name: str) -> Generator[None, None, None]:
65.     if name:
66.         dummy_reporter = Reporter('', 4, 4)
67.         role_fn, _ = roles.role(name, english, 0, dummy_reporter)
68.         if role_fn:  # type: ignore[truthy-function]
69.             docutils.register_role('', role_fn)
70.         else:
71.             logger.warning(__('default role %s not found'), name, location=docname)
72. 
73.     yield
74. 
75.     docutils.unregister_role('')
76. 
77. 
78. def prepend_prolog(content: StringList, prolog: str) -> None:
79.     """Prepend a string to content body as prolog."""
80.     if prolog:
81.         pos = 0
82.         for line in content:
83.             if docinfo_re.match(line):
84.                 pos += 1
85.             else:
86.                 break
87. 
88.         if pos > 0:
89.             # insert a blank line after docinfo
90.             content.insert(pos, '', '<generated>', 0)
91.             pos += 1
92. 
93.         # insert prolog (after docinfo if exists)
94.         for lineno, line in enumerate(prolog.splitlines()):
95.             content.insert(pos + lineno, line, '<rst_prolog>', lineno)
96. 
97.         content.insert(pos + lineno + 1, '', '<generated>', 0)

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 00:47:36,387 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The user requested the full content of `sphinx/environment/__init__.py`.\n2. Extended relevance:\n   - This context contains the first part of the file `sphinx/environment/__init__.py` from line 1 to 500. It is necessary to fulfill the user's request for the full file content.", relative_path='sphinx/environment/__init__.py', start_line=1, end_line=500), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user requested the full content of `sphinx/environment/__init__.py`.\n2. Extended relevance:\n   - This context contains the main `BuildEnvironment` class definition and covers lines 133 to 732. Together with the first part of the file, this provides the complete content.', relative_path='sphinx/environment/__init__.py', start_line=133, end_line=732), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user requested the full content of `sphinx/environment/collectors/toctree.py`.\n2. Extended relevance:\n   - This context contains the entire content of the requested file `sphinx/environment/collectors/toctree.py` from line 1 to 350.', relative_path='sphinx/environment/collectors/toctree.py', start_line=1, end_line=350)]
2025-12-23 00:47:36,389 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the full content of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`.
2025-12-23 00:47:36,390 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 00:47:36,390 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 00:47:36,390 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 3 existing contexts
2025-12-23 00:47:36,390 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 6 total contexts (removed 0 duplicates)
2025-12-23 00:47:36,391 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug-report.yml
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── dependabot.yml
|   └── workflows
|       ├── builddoc.yml
|       ├── coverage.yml
|       ├── create-release.yml
|       ├── latex.yml
|       ├── lint.yml
|       ├── lock.yml
|       ├── main.yml
|       ├── nodejs.yml
|       └── transifex.yml
├── .readthedocs.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   ├── themes
|   |   |   └── fullsize
|   |   └── tutorial
|   ├── _templates
|   |   └── contents.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── authors.rst
|   ├── changes.rst
|   ├── conf.py
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── templating.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── autodoc_ext.rst
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── autodoc_intenum.py
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── index.rst
|   ├── internals
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── support.rst
|   ├── tutorial
|   |   ├── automatic-doc-generation.rst
|   |   ├── deploying.rst
|   |   ├── describing-code.rst
|   |   ├── end.rst
|   |   ├── first-steps.rst
|   |   ├── getting-started.rst
|   |   ├── index.rst
|   |   ├── more-sphinx-customization.rst
|   |   └── narrative-documentation.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── changes.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── preserve_defaults.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   └── docstring.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_GB
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── en_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr_FR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── is
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── yue
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_HK
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_TW
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW.Big5
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── base-stemmer.js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── searchfield.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── searchtools.js
|   |   |       └── sphinx_highlight.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── console.py
|   |   ├── display.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── exceptions.py
|   |   ├── fileutil.py
|   |   ├── http_date.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── __init__.py
|   ├── certs
|   ├── conftest.py
|   ├── ext_napoleon_pep526_data_google.py
|   ├── ext_napoleon_pep526_data_numpy.py
|   ├── js
|   |   ├── documentation_options.js
|   |   ├── searchtools.js
|   |   └── sphinx_highlight.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-duplicates
|   |   |   └── fish_licence
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-theme-having-multiple-stylesheets
|   |   |   ├── _themes
|   |   |   |   └── mytheme
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-copyright-multiline
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── dedent.rst
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-csv-table
|   |   |   ├── conf.py
|   |   |   └── subdir
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── function_param_target.rst
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── ns_lookup.rst
|   |   ├── test-domain-c-c_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── field-role.rst
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-cpp-cpp_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-cpp-intersphinx
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-js-javascript_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py
|   |   |   ├── abbr.rst
|   |   |   ├── canonical.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py-python_maximum_signature_line_length
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-python_use_unqualified_type_names
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-py-xref-warning
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-environment-record-dependencies
|   |   |   ├── api.rst
|   |   |   ├── conf.py
|   |   |   ├── example_module.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── _functions_to_import.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── autodoc_type_aliases.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── canonical
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── empty_all.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── hide_value.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── instance_variable.py
|   |   |       ├── metadata.py
|   |   |       ├── methods.py
|   |   |       ├── module.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── overload2.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── pep604.py
|   |   |       ├── preserve_defaults.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── properties.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       ├── uninitialized_attributes.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_class_module.py
|   |   |   ├── autosummary_dummy_inherited_module.py
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-module_all
|   |   |   ├── autosummary_dummy_package_all
|   |   |   |   ├── __init__.py
|   |   |   |   ├── autosummary_dummy_module.py
|   |   |   |   └── extra_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-extlinks-hardcoded-urls-multiple-replacements
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgmockconverter
|   |   |   ├── 1
|   |   |   ├── 2
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── mocksvgconverter.py
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-intersphinx-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   ├── nomath.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-napoleon
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── mypackage
|   |   |   |   ├── __init__.py
|   |   |   |   └── typehints.py
|   |   |   └── typehints.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-highlight_options
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_signaturereturn_icon
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-escape
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── noqa.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-container
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-labels-before-module
|   |   |   ├── automodule1.py
|   |   |   ├── automodule2a.py
|   |   |   ├── automodule2b.py
|   |   |   ├── automodule3.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.rst
|   |   ├── test-linkcheck-anchors-ignore
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-documents_exclude
|   |   |   ├── br0ken_link.rst
|   |   |   ├── broken_link.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-anchor
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-https
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-localserver-warn-redirects
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-raw-node
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck-too-many-retries
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-local-logo
|   |   |   ├── conf.py
|   |   |   ├── images
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   ├── en
|   |   |   |   └── et
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nitpicky-warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-object-description-sections
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-reST-code-role
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-remote-logo
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── literals.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-domain-objects
|   |   |   ├── conf.py
|   |   |   ├── domains.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-index
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-transforms-post_transforms-keyboard
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-transforms-post_transforms-missing-reference
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_object_description.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_record_dependencies.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autoattribute.py
|   ├── test_ext_autodoc_autoclass.py
|   ├── test_ext_autodoc_autodata.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_automodule.py
|   ├── test_ext_autodoc_autoproperty.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_preserve_defaults.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_extlinks.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_imgmockconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_extension.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_display.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   ├── typing_test_data.py
|   └── utils.py
└── utils
    ├── __init__.py
    ├── babel_runner.py
    ├── bump_docker.sh
    └── bump_version.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: Using rst_prolog removes top level headings containing a domain directive

Description: ### Describe the bug

If `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.

In the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.
Similarly, if you do not set `rst_prolog` then the heading will display correctly.

This appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx

### How to Reproduce

```bash
$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs
$ echo -e 'Welcome\n=======\n\n.. toctree::\n\n   mypackage\n' > docs/index.rst
$ echo -e ':mod:`mypackage2`\n=================\n\nContent\n\nSubheading\n----------\n' > docs/mypackage.rst
$ echo -e 'rst_prolog = """\n.. |psf| replace:: Python Software Foundation\n"""\n' >> docs/conf.py
$ sphinx-build -b html . _build
$ grep 'mypackage2' docs/_build/index.html
```

`docs/index.rst`:

```rst
Welcome
=======

.. toctree::

   mypackage
```

`docs/mypackage.rst`:

```rst
:mod:`mypackage2`
=================

Content

Subheading
----------
```

### Environment Information

```text
Platform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)
Python version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])
Python implementation: CPython
Sphinx version:        7.1.0+/d3c91f951
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
[]
```


### Additional context

_No response_

Patch information:
diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py
index 7a1538325..638337fcf 100644
--- a/sphinx/util/rst.py
+++ b/sphinx/util/rst.py
@@ -25,7 +25,7 @@ except ImportError:
 
 logger = logging.getLogger(__name__)
 
-docinfo_re = re.compile(':\\w+:.*?')
+docinfo_re = re.compile(r':\w+:(?:\s|$)')
 symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
 SECTIONING_CHARS = ['=', '-', '~']
 


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of the files `sphinx/util/rst.py`, `sphinx/io.py`, and `sphinx/environment/collectors/title.py`.
Extra Requirements: 
Purpose: These files will help me trace how `rst_prolog` affects title extraction and validate the provided fix in `sphinx/util/rst.py`.

Previous refined query 2:
Essential Query: Please provide the full content of `sphinx/environment/__init__.py` and `sphinx/environment/collectors/toctree.py`.
Extra Requirements: 
Purpose: This will reveal how `rst_prolog` is applied to the source content and how the resulting parsing error affects the table of contents generation.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: sphinx/environment/__init__.py
Line number range: 1 - 500
Content:
1. """Global creation environment."""
2. 
3. from __future__ import annotations
4. 
5. import functools
6. import os
7. import pickle
8. from collections import defaultdict
9. from copy import copy
10. from datetime import datetime, timezone
11. from os import path
12. from typing import TYPE_CHECKING, Any, Callable, Generator, Iterator
13. 
14. from docutils import nodes
15. from docutils.nodes import Node
16. 
17. from sphinx import addnodes
18. from sphinx.config import Config
19. from sphinx.domains import Domain
20. from sphinx.environment.adapters.toctree import TocTree
21. from sphinx.errors import BuildEnvironmentError, DocumentError, ExtensionError, SphinxError
22. from sphinx.events import EventManager
23. from sphinx.locale import __
24. from sphinx.project import Project
25. from sphinx.transforms import SphinxTransformer
26. from sphinx.util import DownloadFiles, FilenameUniqDict, logging
27. from sphinx.util.docutils import LoggingReporter
28. from sphinx.util.i18n import CatalogRepository, docname_to_domain
29. from sphinx.util.nodes import is_translatable
30. from sphinx.util.osutil import canon_path, os_path
31. 
32. if TYPE_CHECKING:
33.     from sphinx.application import Sphinx
34.     from sphinx.builders import Builder
35. 
36. logger = logging.getLogger(__name__)
37. 
38. default_settings: dict[str, Any] = {
39.     'auto_id_prefix': 'id',
40.     'image_loading': 'link',
41.     'embed_stylesheet': False,
42.     'cloak_email_addresses': True,
43.     'pep_base_url': 'https://peps.python.org/',
44.     'pep_references': None,
45.     'rfc_base_url': 'https://datatracker.ietf.org/doc/html/',
46.     'rfc_references': None,
47.     'input_encoding': 'utf-8-sig',
48.     'doctitle_xform': False,
49.     'sectsubtitle_xform': False,
50.     'section_self_link': False,
51.     'halt_level': 5,
52.     'file_insertion_enabled': True,
53.     'smartquotes_locales': [],
54. }
55. 
56. # This is increased every time an environment attribute is added
57. # or changed to properly invalidate pickle files.
58. ENV_VERSION = 58
59. 
60. # config status
61. CONFIG_OK = 1
62. CONFIG_NEW = 2
63. CONFIG_CHANGED = 3
64. CONFIG_EXTENSIONS_CHANGED = 4
65. 
66. CONFIG_CHANGED_REASON = {
67.     CONFIG_NEW: __('new config'),
68.     CONFIG_CHANGED: __('config changed'),
69.     CONFIG_EXTENSIONS_CHANGED: __('extensions changed'),
70. }
71. 
72. 
73. versioning_conditions: dict[str, bool | Callable] = {
74.     'none': False,
75.     'text': is_translatable,
76. }
77. 
78. if TYPE_CHECKING:
79.     from typing import Literal, MutableMapping
80. 
81.     from typing_extensions import overload
82. 
83.     from sphinx.domains.c import CDomain
84.     from sphinx.domains.changeset import ChangeSetDomain
85.     from sphinx.domains.citation import CitationDomain
86.     from sphinx.domains.cpp import CPPDomain
87.     from sphinx.domains.index import IndexDomain
88.     from sphinx.domains.javascript import JavaScriptDomain
89.     from sphinx.domains.math import MathDomain
90.     from sphinx.domains.python import PythonDomain
91.     from sphinx.domains.rst import ReSTDomain
92.     from sphinx.domains.std import StandardDomain
93.     from sphinx.ext.duration import DurationDomain
94.     from sphinx.ext.todo import TodoDomain
95. 
96.     class _DomainsType(MutableMapping[str, Domain]):
97.         @overload
98.         def __getitem__(self, key: Literal["c"]) -> CDomain: ...  # NoQA: E704
99.         @overload
100.         def __getitem__(self, key: Literal["cpp"]) -> CPPDomain: ...  # NoQA: E704
101.         @overload
102.         def __getitem__(self, key: Literal["changeset"]) -> ChangeSetDomain: ...  # NoQA: E704
103.         @overload
104.         def __getitem__(self, key: Literal["citation"]) -> CitationDomain: ...  # NoQA: E704
105.         @overload
106.         def __getitem__(self, key: Literal["index"]) -> IndexDomain: ...  # NoQA: E704
107.         @overload
108.         def __getitem__(self, key: Literal["js"]) -> JavaScriptDomain: ...  # NoQA: E704
109.         @overload
110.         def __getitem__(self, key: Literal["math"]) -> MathDomain: ...  # NoQA: E704
111.         @overload
112.         def __getitem__(self, key: Literal["py"]) -> PythonDomain: ...  # NoQA: E704
113.         @overload
114.         def __getitem__(self, key: Literal["rst"]) -> ReSTDomain: ...  # NoQA: E704
115.         @overload
116.         def __getitem__(self, key: Literal["std"]) -> StandardDomain: ...  # NoQA: E704
117.         @overload
118.         def __getitem__(self, key: Literal["duration"]) -> DurationDomain: ...  # NoQA: E704
119.         @overload
120.         def __getitem__(self, key: Literal["todo"]) -> TodoDomain: ...  # NoQA: E704
121.         @overload
122.         def __getitem__(self, key: str) -> Domain: ...  # NoQA: E704
123.         def __getitem__(self, key): raise NotImplementedError  # NoQA: E704
124.         def __setitem__(self, key, value): raise NotImplementedError  # NoQA: E704
125.         def __delitem__(self, key): raise NotImplementedError  # NoQA: E704
126.         def __iter__(self): raise NotImplementedError  # NoQA: E704
127.         def __len__(self): raise NotImplementedError  # NoQA: E704
128. 
129. else:
130.     _DomainsType = dict
131. 
132. 
133. class BuildEnvironment:
134.     """
135.     The environment in which the ReST files are translated.
136.     Stores an inventory of cross-file targets and provides doctree
137.     transformations to resolve links to them.
138.     """
139. 
140.     domains: _DomainsType
141. 
142.     # --------- ENVIRONMENT INITIALIZATION -------------------------------------
143. 
144.     def __init__(self, app: Sphinx):
145.         self.app: Sphinx = None
146.         self.doctreedir: str = None
147.         self.srcdir: str = None
148.         self.config: Config = None
149.         self.config_status: int = None
150.         self.config_status_extra: str = None
151.         self.events: EventManager = None
152.         self.project: Project = None
153.         self.version: dict[str, str] = None
154. 
155.         # the method of doctree versioning; see set_versioning_method
156.         self.versioning_condition: bool | Callable = None
157.         self.versioning_compare: bool = None
158. 
159.         # all the registered domains, set by the application
160.         self.domains = _DomainsType()
161. 
162.         # the docutils settings for building
163.         self.settings = default_settings.copy()
164.         self.settings['env'] = self
165. 
166.         # All "docnames" here are /-separated and relative and exclude
167.         # the source suffix.
168. 
169.         # docname -> time of reading (in integer microseconds)
170.         # contains all read docnames
171.         self.all_docs: dict[str, int] = {}
172.         # docname -> set of dependent file
173.         # names, relative to documentation root
174.         self.dependencies: dict[str, set[str]] = defaultdict(set)
175.         # docname -> set of included file
176.         # docnames included from other documents
177.         self.included: dict[str, set[str]] = defaultdict(set)
178.         # docnames to re-read unconditionally on next build
179.         self.reread_always: set[str] = set()
180. 
181.         # docname -> pickled doctree
182.         self._pickled_doctree_cache: dict[str, bytes] = {}
183. 
184.         # docname -> doctree
185.         self._write_doc_doctree_cache: dict[str, nodes.document] = {}
186. 
187.         # File metadata
188.         # docname -> dict of metadata items
189.         self.metadata: dict[str, dict[str, Any]] = defaultdict(dict)
190. 
191.         # TOC inventory
192.         # docname -> title node
193.         self.titles: dict[str, nodes.title] = {}
194.         # docname -> title node; only different if
195.         # set differently with title directive
196.         self.longtitles: dict[str, nodes.title] = {}
197.         # docname -> table of contents nodetree
198.         self.tocs: dict[str, nodes.bullet_list] = {}
199.         # docname -> number of real entries
200.         self.toc_num_entries: dict[str, int] = {}
201. 
202.         # used to determine when to show the TOC
203.         # in a sidebar (don't show if it's only one item)
204.         # docname -> dict of sectionid -> number
205.         self.toc_secnumbers: dict[str, dict[str, tuple[int, ...]]] = {}
206.         # docname -> dict of figtype -> dict of figureid -> number
207.         self.toc_fignumbers: dict[str, dict[str, dict[str, tuple[int, ...]]]] = {}
208. 
209.         # docname -> list of toctree includefiles
210.         self.toctree_includes: dict[str, list[str]] = {}
211.         # docname -> set of files (containing its TOCs) to rebuild too
212.         self.files_to_rebuild: dict[str, set[str]] = {}
213.         # docnames that have :glob: toctrees
214.         self.glob_toctrees: set[str] = set()
215.         # docnames that have :numbered: toctrees
216.         self.numbered_toctrees: set[str] = set()
217. 
218.         # domain-specific inventories, here to be pickled
219.         # domainname -> domain-specific dict
220.         self.domaindata: dict[str, dict] = {}
221. 
222.         # these map absolute path -> (docnames, unique filename)
223.         self.images: FilenameUniqDict = FilenameUniqDict()
224.         # filename -> (set of docnames, destination)
225.         self.dlfiles: DownloadFiles = DownloadFiles()
226. 
227.         # the original URI for images
228.         self.original_image_uri: dict[str, str] = {}
229. 
230.         # temporary data storage while reading a document
231.         self.temp_data: dict[str, Any] = {}
232.         # context for cross-references (e.g. current module or class)
233.         # this is similar to temp_data, but will for example be copied to
234.         # attributes of "any" cross references
235.         self.ref_context: dict[str, Any] = {}
236. 
237.         # search index data
238. 
239.         # docname -> title
240.         self._search_index_titles: dict[str, str] = {}
241.         # docname -> filename
242.         self._search_index_filenames: dict[str, str] = {}
243.         # stemmed words -> set(docname)
244.         self._search_index_mapping: dict[str, set[str]] = {}
245.         # stemmed words in titles -> set(docname)
246.         self._search_index_title_mapping: dict[str, set[str]] = {}
247.         # docname -> all titles in document
248.         self._search_index_all_titles: dict[str, list[tuple[str, str]]] = {}
249.         # docname -> list(index entry)
250.         self._search_index_index_entries: dict[str, list[tuple[str, str, str]]] = {}
251.         # objtype -> index
252.         self._search_index_objtypes: dict[tuple[str, str], int] = {}
253.         # objtype index -> (domain, type, objname (localized))
254.         self._search_index_objnames: dict[int, tuple[str, str, str]] = {}
255. 
256.         # set up environment
257.         self.setup(app)
258. 
259.     def __getstate__(self) -> dict:
260.         """Obtains serializable data for pickling."""
261.         __dict__ = self.__dict__.copy()
262.         __dict__.update(app=None, domains={}, events=None)  # clear unpickable attributes
263.         return __dict__
264. 
265.     def __setstate__(self, state: dict) -> None:
266.         self.__dict__.update(state)
267. 
268.     def setup(self, app: Sphinx) -> None:
269.         """Set up BuildEnvironment object."""
270.         if self.version and self.version != app.registry.get_envversion(app):
271.             raise BuildEnvironmentError(__('build environment version not current'))
272.         if self.srcdir and self.srcdir != app.srcdir:
273.             raise BuildEnvironmentError(__('source directory has changed'))
274. 
275.         if self.project:
276.             app.project.restore(self.project)
277. 
278.         self.app = app
279.         self.doctreedir = app.doctreedir
280.         self.events = app.events
281.         self.srcdir = app.srcdir
282.         self.project = app.project
283.         self.version = app.registry.get_envversion(app)
284. 
285.         # initialize domains
286.         self.domains = _DomainsType()
287.         for domain in app.registry.create_domains(self):
288.             self.domains[domain.name] = domain
289. 
290.         # setup domains (must do after all initialization)
291.         for domain in self.domains.values():
292.             domain.setup()
293. 
294.         # initialize config
295.         self._update_config(app.config)
296. 
297.         # initialie settings
298.         self._update_settings(app.config)
299. 
300.     def _update_config(self, config: Config) -> None:
301.         """Update configurations by new one."""
302.         self.config_status = CONFIG_OK
303.         self.config_status_extra = ''
304.         if self.config is None:
305.             self.config_status = CONFIG_NEW
306.         elif self.config.extensions != config.extensions:
307.             self.config_status = CONFIG_EXTENSIONS_CHANGED
308.             extensions = sorted(
309.                 set(self.config.extensions) ^ set(config.extensions))
310.             if len(extensions) == 1:
311.                 extension = extensions[0]
312.             else:
313.                 extension = '%d' % (len(extensions),)
314.             self.config_status_extra = f' ({extension!r})'
315.         else:
316.             # check if a config value was changed that affects how
317.             # doctrees are read
318.             for item in config.filter('env'):
319.                 if self.config[item.name] != item.value:
320.                     self.config_status = CONFIG_CHANGED
321.                     self.config_status_extra = f' ({item.name!r})'
322.                     break
323. 
324.         self.config = config
325. 
326.     def _update_settings(self, config: Config) -> None:
327.         """Update settings by new config."""
328.         self.settings['input_encoding'] = config.source_encoding
329.         self.settings['trim_footnote_reference_space'] = config.trim_footnote_reference_space
330.         self.settings['language_code'] = config.language
331. 
332.         # Allow to disable by 3rd party extension (workaround)
333.         self.settings.setdefault('smart_quotes', True)
334. 
335.     def set_versioning_method(self, method: str | Callable, compare: bool) -> None:
336.         """This sets the doctree versioning method for this environment.
337. 
338.         Versioning methods are a builder property; only builders with the same
339.         versioning method can share the same doctree directory.  Therefore, we
340.         raise an exception if the user tries to use an environment with an
341.         incompatible versioning method.
342.         """
343.         condition: bool | Callable
344.         if callable(method):
345.             condition = method
346.         else:
347.             if method not in versioning_conditions:
348.                 raise ValueError('invalid versioning method: %r' % method)
349.             condition = versioning_conditions[method]
350. 
351.         if self.versioning_condition not in (None, condition):
352.             raise SphinxError(__('This environment is incompatible with the '
353.                                  'selected builder, please choose another '
354.                                  'doctree directory.'))
355.         self.versioning_condition = condition
356.         self.versioning_compare = compare
357. 
358.     def clear_doc(self, docname: str) -> None:
359.         """Remove all traces of a source file in the inventory."""
360.         if docname in self.all_docs:
361.             self.all_docs.pop(docname, None)
362.             self.included.pop(docname, None)
363.             self.reread_always.discard(docname)
364. 
365.         for domain in self.domains.values():
366.             domain.clear_doc(docname)
367. 
368.     def merge_info_from(self, docnames: list[str], other: BuildEnvironment,
369.                         app: Sphinx) -> None:
370.         """Merge global information gathered about *docnames* while reading them
371.         from the *other* environment.
372. 
373.         This possibly comes from a parallel build process.
374.         """
375.         docnames = set(docnames)  # type: ignore
376.         for docname in docnames:
377.             self.all_docs[docname] = other.all_docs[docname]
378.             self.included[docname] = other.included[docname]
379.             if docname in other.reread_always:
380.                 self.reread_always.add(docname)
381. 
382.         for domainname, domain in self.domains.items():
383.             domain.merge_domaindata(docnames, other.domaindata[domainname])
384.         self.events.emit('env-merge-info', self, docnames, other)
385. 
386.     def path2doc(self, filename: str) -> str | None:
387.         """Return the docname for the filename if the file is document.
388. 
389.         *filename* should be absolute or relative to the source directory.
390.         """
391.         return self.project.path2doc(filename)
392. 
393.     def doc2path(self, docname: str, base: bool = True) -> str:
394.         """Return the filename for the document name.
395. 
396.         If *base* is True, return absolute path under self.srcdir.
397.         If *base* is False, return relative path to self.srcdir.
398.         """
399.         return self.project.doc2path(docname, base)
400. 
401.     def relfn2path(self, filename: str, docname: str | None = None) -> tuple[str, str]:
402.         """Return paths to a file referenced from a document, relative to
403.         documentation root and absolute.
404. 
405.         In the input "filename", absolute filenames are taken as relative to the
406.         source dir, while relative filenames are relative to the dir of the
407.         containing document.
408.         """
409.         filename = os_path(filename)
410.         if filename.startswith(('/', os.sep)):
411.             rel_fn = filename[1:]
412.         else:
413.             docdir = path.dirname(self.doc2path(docname or self.docname,
414.                                                 base=False))
415.             rel_fn = path.join(docdir, filename)
416. 
417.         return (canon_path(path.normpath(rel_fn)),
418.                 path.normpath(path.join(self.srcdir, rel_fn)))
419. 
420.     @property
421.     def found_docs(self) -> set[str]:
422.         """contains all existing docnames."""
423.         return self.project.docnames
424. 
425.     def find_files(self, config: Config, builder: Builder) -> None:
426.         """Find all source files in the source dir and put them in
427.         self.found_docs.
428.         """
429.         try:
430.             exclude_paths = (self.config.exclude_patterns +
431.                              self.config.templates_path +
432.                              builder.get_asset_paths())
433.             self.project.discover(exclude_paths, self.config.include_patterns)
434. 
435.             # Current implementation is applying translated messages in the reading
436.             # phase.Therefore, in order to apply the updated message catalog, it is
437.             # necessary to re-process from the reading phase. Here, if dependency
438.             # is set for the doc source and the mo file, it is processed again from
439.             # the reading phase when mo is updated. In the future, we would like to
440.             # move i18n process into the writing phase, and remove these lines.
441.             if builder.use_message_catalog:
442.                 # add catalog mo file dependency
443.                 repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
444.                                          self.config.language, self.config.source_encoding)
445.                 mo_paths = {c.domain: c.mo_path for c in repo.catalogs}
446.                 for docname in self.found_docs:
447.                     domain = docname_to_domain(docname, self.config.gettext_compact)
448.                     if domain in mo_paths:
449.                         self.dependencies[docname].add(mo_paths[domain])
450.         except OSError as exc:
451.             raise DocumentError(__('Failed to scan documents in %s: %r') %
452.                                 (self.srcdir, exc)) from exc
453. 
454.     def get_outdated_files(self, config_changed: bool) -> tuple[set[str], set[str], set[str]]:
455.         """Return (added, changed, removed) sets."""
456.         # clear all files no longer present
457.         removed = set(self.all_docs) - self.found_docs
458. 
459.         added: set[str] = set()
460.         changed: set[str] = set()
461. 
462.         if config_changed:
463.             # config values affect e.g. substitutions
464.             added = self.found_docs
465.         else:
466.             for docname in self.found_docs:
467.                 if docname not in self.all_docs:
468.                     logger.debug('[build target] added %r', docname)
469.                     added.add(docname)
470.                     continue
471.                 # if the doctree file is not there, rebuild
472.                 filename = path.join(self.doctreedir, docname + '.doctree')
473.                 if not path.isfile(filename):
474.                     logger.debug('[build target] changed %r', docname)
475.                     changed.add(docname)
476.                     continue
477.                 # check the "reread always" list
478.                 if docname in self.reread_always:
479.                     logger.debug('[build target] changed %r', docname)
480.                     changed.add(docname)
481.                     continue
482.                 # check the mtime of the document
483.                 mtime = self.all_docs[docname]
484.                 newmtime = _last_modified_time(self.doc2path(docname))
485.                 if newmtime > mtime:
486.                     # convert integer microseconds to floating-point seconds,
487.                     # and then to timezone-aware datetime objects.
488.                     mtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
489.                     newmtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
490.                     logger.debug('[build target] outdated %r: %s -> %s',
491.                                  docname, mtime_dt, newmtime_dt)
492.                     changed.add(docname)
493.                     continue
494.                 # finally, check the mtime of dependencies
495.                 for dep in self.dependencies[docname]:
496.                     try:
497.                         # this will do the right thing when dep is absolute too
498.                         deppath = path.join(self.srcdir, dep)
499.                         if not path.isfile(deppath):
500.                             changed.add(docname)


File: sphinx/environment/__init__.py
Line number range: 133 - 732
Content:
133. class BuildEnvironment:
134.     """
135.     The environment in which the ReST files are translated.
136.     Stores an inventory of cross-file targets and provides doctree
137.     transformations to resolve links to them.
138.     """
139. 
140.     domains: _DomainsType
141. 
142.     # --------- ENVIRONMENT INITIALIZATION -------------------------------------
143. 
144.     def __init__(self, app: Sphinx):
145.         self.app: Sphinx = None
146.         self.doctreedir: str = None
147.         self.srcdir: str = None
148.         self.config: Config = None
149.         self.config_status: int = None
150.         self.config_status_extra: str = None
151.         self.events: EventManager = None
152.         self.project: Project = None
153.         self.version: dict[str, str] = None
154. 
155.         # the method of doctree versioning; see set_versioning_method
156.         self.versioning_condition: bool | Callable = None
157.         self.versioning_compare: bool = None
158. 
159.         # all the registered domains, set by the application
160.         self.domains = _DomainsType()
161. 
162.         # the docutils settings for building
163.         self.settings = default_settings.copy()
164.         self.settings['env'] = self
165. 
166.         # All "docnames" here are /-separated and relative and exclude
167.         # the source suffix.
168. 
169.         # docname -> time of reading (in integer microseconds)
170.         # contains all read docnames
171.         self.all_docs: dict[str, int] = {}
172.         # docname -> set of dependent file
173.         # names, relative to documentation root
174.         self.dependencies: dict[str, set[str]] = defaultdict(set)
175.         # docname -> set of included file
176.         # docnames included from other documents
177.         self.included: dict[str, set[str]] = defaultdict(set)
178.         # docnames to re-read unconditionally on next build
179.         self.reread_always: set[str] = set()
180. 
181.         # docname -> pickled doctree
182.         self._pickled_doctree_cache: dict[str, bytes] = {}
183. 
184.         # docname -> doctree
185.         self._write_doc_doctree_cache: dict[str, nodes.document] = {}
186. 
187.         # File metadata
188.         # docname -> dict of metadata items
189.         self.metadata: dict[str, dict[str, Any]] = defaultdict(dict)
190. 
191.         # TOC inventory
192.         # docname -> title node
193.         self.titles: dict[str, nodes.title] = {}
194.         # docname -> title node; only different if
195.         # set differently with title directive
196.         self.longtitles: dict[str, nodes.title] = {}
197.         # docname -> table of contents nodetree
198.         self.tocs: dict[str, nodes.bullet_list] = {}
199.         # docname -> number of real entries
200.         self.toc_num_entries: dict[str, int] = {}
201. 
202.         # used to determine when to show the TOC
203.         # in a sidebar (don't show if it's only one item)
204.         # docname -> dict of sectionid -> number
205.         self.toc_secnumbers: dict[str, dict[str, tuple[int, ...]]] = {}
206.         # docname -> dict of figtype -> dict of figureid -> number
207.         self.toc_fignumbers: dict[str, dict[str, dict[str, tuple[int, ...]]]] = {}
208. 
209.         # docname -> list of toctree includefiles
210.         self.toctree_includes: dict[str, list[str]] = {}
211.         # docname -> set of files (containing its TOCs) to rebuild too
212.         self.files_to_rebuild: dict[str, set[str]] = {}
213.         # docnames that have :glob: toctrees
214.         self.glob_toctrees: set[str] = set()
215.         # docnames that have :numbered: toctrees
216.         self.numbered_toctrees: set[str] = set()
217. 
218.         # domain-specific inventories, here to be pickled
219.         # domainname -> domain-specific dict
220.         self.domaindata: dict[str, dict] = {}
221. 
222.         # these map absolute path -> (docnames, unique filename)
223.         self.images: FilenameUniqDict = FilenameUniqDict()
224.         # filename -> (set of docnames, destination)
225.         self.dlfiles: DownloadFiles = DownloadFiles()
226. 
227.         # the original URI for images
228.         self.original_image_uri: dict[str, str] = {}
229. 
230.         # temporary data storage while reading a document
231.         self.temp_data: dict[str, Any] = {}
232.         # context for cross-references (e.g. current module or class)
233.         # this is similar to temp_data, but will for example be copied to
234.         # attributes of "any" cross references
235.         self.ref_context: dict[str, Any] = {}
236. 
237.         # search index data
238. 
239.         # docname -> title
240.         self._search_index_titles: dict[str, str] = {}
241.         # docname -> filename
242.         self._search_index_filenames: dict[str, str] = {}
243.         # stemmed words -> set(docname)
244.         self._search_index_mapping: dict[str, set[str]] = {}
245.         # stemmed words in titles -> set(docname)
246.         self._search_index_title_mapping: dict[str, set[str]] = {}
247.         # docname -> all titles in document
248.         self._search_index_all_titles: dict[str, list[tuple[str, str]]] = {}
249.         # docname -> list(index entry)
250.         self._search_index_index_entries: dict[str, list[tuple[str, str, str]]] = {}
251.         # objtype -> index
252.         self._search_index_objtypes: dict[tuple[str, str], int] = {}
253.         # objtype index -> (domain, type, objname (localized))
254.         self._search_index_objnames: dict[int, tuple[str, str, str]] = {}
255. 
256.         # set up environment
257.         self.setup(app)
258. 
259.     def __getstate__(self) -> dict:
260.         """Obtains serializable data for pickling."""
261.         __dict__ = self.__dict__.copy()
262.         __dict__.update(app=None, domains={}, events=None)  # clear unpickable attributes
263.         return __dict__
264. 
265.     def __setstate__(self, state: dict) -> None:
266.         self.__dict__.update(state)
267. 
268.     def setup(self, app: Sphinx) -> None:
269.         """Set up BuildEnvironment object."""
270.         if self.version and self.version != app.registry.get_envversion(app):
271.             raise BuildEnvironmentError(__('build environment version not current'))
272.         if self.srcdir and self.srcdir != app.srcdir:
273.             raise BuildEnvironmentError(__('source directory has changed'))
274. 
275.         if self.project:
276.             app.project.restore(self.project)
277. 
278.         self.app = app
279.         self.doctreedir = app.doctreedir
280.         self.events = app.events
281.         self.srcdir = app.srcdir
282.         self.project = app.project
283.         self.version = app.registry.get_envversion(app)
284. 
285.         # initialize domains
286.         self.domains = _DomainsType()
287.         for domain in app.registry.create_domains(self):
288.             self.domains[domain.name] = domain
289. 
290.         # setup domains (must do after all initialization)
291.         for domain in self.domains.values():
292.             domain.setup()
293. 
294.         # initialize config
295.         self._update_config(app.config)
296. 
297.         # initialie settings
298.         self._update_settings(app.config)
299. 
300.     def _update_config(self, config: Config) -> None:
301.         """Update configurations by new one."""
302.         self.config_status = CONFIG_OK
303.         self.config_status_extra = ''
304.         if self.config is None:
305.             self.config_status = CONFIG_NEW
306.         elif self.config.extensions != config.extensions:
307.             self.config_status = CONFIG_EXTENSIONS_CHANGED
308.             extensions = sorted(
309.                 set(self.config.extensions) ^ set(config.extensions))
310.             if len(extensions) == 1:
311.                 extension = extensions[0]
312.             else:
313.                 extension = '%d' % (len(extensions),)
314.             self.config_status_extra = f' ({extension!r})'
315.         else:
316.             # check if a config value was changed that affects how
317.             # doctrees are read
318.             for item in config.filter('env'):
319.                 if self.config[item.name] != item.value:
320.                     self.config_status = CONFIG_CHANGED
321.                     self.config_status_extra = f' ({item.name!r})'
322.                     break
323. 
324.         self.config = config
325. 
326.     def _update_settings(self, config: Config) -> None:
327.         """Update settings by new config."""
328.         self.settings['input_encoding'] = config.source_encoding
329.         self.settings['trim_footnote_reference_space'] = config.trim_footnote_reference_space
330.         self.settings['language_code'] = config.language
331. 
332.         # Allow to disable by 3rd party extension (workaround)
333.         self.settings.setdefault('smart_quotes', True)
334. 
335.     def set_versioning_method(self, method: str | Callable, compare: bool) -> None:
336.         """This sets the doctree versioning method for this environment.
337. 
338.         Versioning methods are a builder property; only builders with the same
339.         versioning method can share the same doctree directory.  Therefore, we
340.         raise an exception if the user tries to use an environment with an
341.         incompatible versioning method.
342.         """
343.         condition: bool | Callable
344.         if callable(method):
345.             condition = method
346.         else:
347.             if method not in versioning_conditions:
348.                 raise ValueError('invalid versioning method: %r' % method)
349.             condition = versioning_conditions[method]
350. 
351.         if self.versioning_condition not in (None, condition):
352.             raise SphinxError(__('This environment is incompatible with the '
353.                                  'selected builder, please choose another '
354.                                  'doctree directory.'))
355.         self.versioning_condition = condition
356.         self.versioning_compare = compare
357. 
358.     def clear_doc(self, docname: str) -> None:
359.         """Remove all traces of a source file in the inventory."""
360.         if docname in self.all_docs:
361.             self.all_docs.pop(docname, None)
362.             self.included.pop(docname, None)
363.             self.reread_always.discard(docname)
364. 
365.         for domain in self.domains.values():
366.             domain.clear_doc(docname)
367. 
368.     def merge_info_from(self, docnames: list[str], other: BuildEnvironment,
369.                         app: Sphinx) -> None:
370.         """Merge global information gathered about *docnames* while reading them
371.         from the *other* environment.
372. 
373.         This possibly comes from a parallel build process.
374.         """
375.         docnames = set(docnames)  # type: ignore
376.         for docname in docnames:
377.             self.all_docs[docname] = other.all_docs[docname]
378.             self.included[docname] = other.included[docname]
379.             if docname in other.reread_always:
380.                 self.reread_always.add(docname)
381. 
382.         for domainname, domain in self.domains.items():
383.             domain.merge_domaindata(docnames, other.domaindata[domainname])
384.         self.events.emit('env-merge-info', self, docnames, other)
385. 
386.     def path2doc(self, filename: str) -> str | None:
387.         """Return the docname for the filename if the file is document.
388. 
389.         *filename* should be absolute or relative to the source directory.
390.         """
391.         return self.project.path2doc(filename)
392. 
393.     def doc2path(self, docname: str, base: bool = True) -> str:
394.         """Return the filename for the document name.
395. 
396.         If *base* is True, return absolute path under self.srcdir.
397.         If *base* is False, return relative path to self.srcdir.
398.         """
399.         return self.project.doc2path(docname, base)
400. 
401.     def relfn2path(self, filename: str, docname: str | None = None) -> tuple[str, str]:
402.         """Return paths to a file referenced from a document, relative to
403.         documentation root and absolute.
404. 
405.         In the input "filename", absolute filenames are taken as relative to the
406.         source dir, while relative filenames are relative to the dir of the
407.         containing document.
408.         """
409.         filename = os_path(filename)
410.         if filename.startswith(('/', os.sep)):
411.             rel_fn = filename[1:]
412.         else:
413.             docdir = path.dirname(self.doc2path(docname or self.docname,
414.                                                 base=False))
415.             rel_fn = path.join(docdir, filename)
416. 
417.         return (canon_path(path.normpath(rel_fn)),
418.                 path.normpath(path.join(self.srcdir, rel_fn)))
419. 
420.     @property
421.     def found_docs(self) -> set[str]:
422.         """contains all existing docnames."""
423.         return self.project.docnames
424. 
425.     def find_files(self, config: Config, builder: Builder) -> None:
426.         """Find all source files in the source dir and put them in
427.         self.found_docs.
428.         """
429.         try:
430.             exclude_paths = (self.config.exclude_patterns +
431.                              self.config.templates_path +
432.                              builder.get_asset_paths())
433.             self.project.discover(exclude_paths, self.config.include_patterns)
434. 
435.             # Current implementation is applying translated messages in the reading
436.             # phase.Therefore, in order to apply the updated message catalog, it is
437.             # necessary to re-process from the reading phase. Here, if dependency
438.             # is set for the doc source and the mo file, it is processed again from
439.             # the reading phase when mo is updated. In the future, we would like to
440.             # move i18n process into the writing phase, and remove these lines.
441.             if builder.use_message_catalog:
442.                 # add catalog mo file dependency
443.                 repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
444.                                          self.config.language, self.config.source_encoding)
445.                 mo_paths = {c.domain: c.mo_path for c in repo.catalogs}
446.                 for docname in self.found_docs:
447.                     domain = docname_to_domain(docname, self.config.gettext_compact)
448.                     if domain in mo_paths:
449.                         self.dependencies[docname].add(mo_paths[domain])
450.         except OSError as exc:
451.             raise DocumentError(__('Failed to scan documents in %s: %r') %
452.                                 (self.srcdir, exc)) from exc
453. 
454.     def get_outdated_files(self, config_changed: bool) -> tuple[set[str], set[str], set[str]]:
455.         """Return (added, changed, removed) sets."""
456.         # clear all files no longer present
457.         removed = set(self.all_docs) - self.found_docs
458. 
459.         added: set[str] = set()
460.         changed: set[str] = set()
461. 
462.         if config_changed:
463.             # config values affect e.g. substitutions
464.             added = self.found_docs
465.         else:
466.             for docname in self.found_docs:
467.                 if docname not in self.all_docs:
468.                     logger.debug('[build target] added %r', docname)
469.                     added.add(docname)
470.                     continue
471.                 # if the doctree file is not there, rebuild
472.                 filename = path.join(self.doctreedir, docname + '.doctree')
473.                 if not path.isfile(filename):
474.                     logger.debug('[build target] changed %r', docname)
475.                     changed.add(docname)
476.                     continue
477.                 # check the "reread always" list
478.                 if docname in self.reread_always:
479.                     logger.debug('[build target] changed %r', docname)
480.                     changed.add(docname)
481.                     continue
482.                 # check the mtime of the document
483.                 mtime = self.all_docs[docname]
484.                 newmtime = _last_modified_time(self.doc2path(docname))
485.                 if newmtime > mtime:
486.                     # convert integer microseconds to floating-point seconds,
487.                     # and then to timezone-aware datetime objects.
488.                     mtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
489.                     newmtime_dt = datetime.fromtimestamp(mtime / 1_000_000, tz=timezone.utc)
490.                     logger.debug('[build target] outdated %r: %s -> %s',
491.                                  docname, mtime_dt, newmtime_dt)
492.                     changed.add(docname)
493.                     continue
494.                 # finally, check the mtime of dependencies
495.                 for dep in self.dependencies[docname]:
496.                     try:
497.                         # this will do the right thing when dep is absolute too
498.                         deppath = path.join(self.srcdir, dep)
499.                         if not path.isfile(deppath):
500.                             changed.add(docname)
501.                             break
502.                         depmtime = _last_modified_time(deppath)
503.                         if depmtime > mtime:
504.                             changed.add(docname)
505.                             break
506.                     except OSError:
507.                         # give it another chance
508.                         changed.add(docname)
509.                         break
510. 
511.         return added, changed, removed
512. 
513.     def check_dependents(self, app: Sphinx, already: set[str]) -> Generator[str, None, None]:
514.         to_rewrite: list[str] = []
515.         for docnames in self.events.emit('env-get-updated', self):
516.             to_rewrite.extend(docnames)
517.         for docname in set(to_rewrite):
518.             if docname not in already:
519.                 yield docname
520. 
521.     # --------- SINGLE FILE READING --------------------------------------------
522. 
523.     def prepare_settings(self, docname: str) -> None:
524.         """Prepare to set up environment for reading."""
525.         self.temp_data['docname'] = docname
526.         # defaults to the global default, but can be re-set in a document
527.         self.temp_data['default_role'] = self.config.default_role
528.         self.temp_data['default_domain'] = \
529.             self.domains.get(self.config.primary_domain)
530. 
531.     # utilities to use while reading a document
532. 
533.     @property
534.     def docname(self) -> str:
535.         """Returns the docname of the document currently being parsed."""
536.         return self.temp_data['docname']
537. 
538.     def new_serialno(self, category: str = '') -> int:
539.         """Return a serial number, e.g. for index entry targets.
540. 
541.         The number is guaranteed to be unique in the current document.
542.         """
543.         key = category + 'serialno'
544.         cur = self.temp_data.get(key, 0)
545.         self.temp_data[key] = cur + 1
546.         return cur
547. 
548.     def note_dependency(self, filename: str) -> None:
549.         """Add *filename* as a dependency of the current document.
550. 
551.         This means that the document will be rebuilt if this file changes.
552. 
553.         *filename* should be absolute or relative to the source directory.
554.         """
555.         self.dependencies[self.docname].add(filename)
556. 
557.     def note_included(self, filename: str) -> None:
558.         """Add *filename* as a included from other document.
559. 
560.         This means the document is not orphaned.
561. 
562.         *filename* should be absolute or relative to the source directory.
563.         """
564.         doc = self.path2doc(filename)
565.         if doc:
566.             self.included[self.docname].add(doc)
567. 
568.     def note_reread(self) -> None:
569.         """Add the current document to the list of documents that will
570.         automatically be re-read at the next build.
571.         """
572.         self.reread_always.add(self.docname)
573. 
574.     def get_domain(self, domainname: str) -> Domain:
575.         """Return the domain instance with the specified name.
576. 
577.         Raises an ExtensionError if the domain is not registered.
578.         """
579.         try:
580.             return self.domains[domainname]
581.         except KeyError as exc:
582.             raise ExtensionError(__('Domain %r is not registered') % domainname) from exc
583. 
584.     # --------- RESOLVING REFERENCES AND TOCTREES ------------------------------
585. 
586.     def get_doctree(self, docname: str) -> nodes.document:
587.         """Read the doctree for a file from the pickle and return it."""
588.         try:
589.             serialised = self._pickled_doctree_cache[docname]
590.         except KeyError:
591.             filename = path.join(self.doctreedir, docname + '.doctree')
592.             with open(filename, 'rb') as f:
593.                 serialised = self._pickled_doctree_cache[docname] = f.read()
594. 
595.         doctree = pickle.loads(serialised)
596.         doctree.settings.env = self
597.         doctree.reporter = LoggingReporter(self.doc2path(docname))
598.         return doctree
599. 
600.     @functools.cached_property
601.     def master_doctree(self) -> nodes.document:
602.         return self.get_doctree(self.config.root_doc)
603. 
604.     def get_and_resolve_doctree(
605.         self,
606.         docname: str,
607.         builder: Builder,
608.         doctree: nodes.document | None = None,
609.         prune_toctrees: bool = True,
610.         includehidden: bool = False,
611.     ) -> nodes.document:
612.         """Read the doctree from the pickle, resolve cross-references and
613.         toctrees and return it.
614.         """
615.         if doctree is None:
616.             try:
617.                 doctree = self._write_doc_doctree_cache.pop(docname)
618.                 doctree.settings.env = self
619.                 doctree.reporter = LoggingReporter(self.doc2path(docname))
620.             except KeyError:
621.                 doctree = self.get_doctree(docname)
622. 
623.         # resolve all pending cross-references
624.         self.apply_post_transforms(doctree, docname)
625. 
626.         # now, resolve all toctree nodes
627.         for toctreenode in doctree.findall(addnodes.toctree):
628.             result = TocTree(self).resolve(docname, builder, toctreenode,
629.                                            prune=prune_toctrees,
630.                                            includehidden=includehidden)
631.             if result is None:
632.                 toctreenode.replace_self([])
633.             else:
634.                 toctreenode.replace_self(result)
635. 
636.         return doctree
637. 
638.     def resolve_toctree(self, docname: str, builder: Builder, toctree: addnodes.toctree,
639.                         prune: bool = True, maxdepth: int = 0, titles_only: bool = False,
640.                         collapse: bool = False, includehidden: bool = False) -> Node | None:
641.         """Resolve a *toctree* node into individual bullet lists with titles
642.         as items, returning None (if no containing titles are found) or
643.         a new node.
644. 
645.         If *prune* is True, the tree is pruned to *maxdepth*, or if that is 0,
646.         to the value of the *maxdepth* option on the *toctree* node.
647.         If *titles_only* is True, only toplevel document titles will be in the
648.         resulting tree.
649.         If *collapse* is True, all branches not containing docname will
650.         be collapsed.
651.         """
652.         return TocTree(self).resolve(docname, builder, toctree, prune,
653.                                      maxdepth, titles_only, collapse,
654.                                      includehidden)
655. 
656.     def resolve_references(self, doctree: nodes.document, fromdocname: str,
657.                            builder: Builder) -> None:
658.         self.apply_post_transforms(doctree, fromdocname)
659. 
660.     def apply_post_transforms(self, doctree: nodes.document, docname: str) -> None:
661.         """Apply all post-transforms."""
662.         try:
663.             # set env.docname during applying post-transforms
664.             backup = copy(self.temp_data)
665.             self.temp_data['docname'] = docname
666. 
667.             transformer = SphinxTransformer(doctree)
668.             transformer.set_environment(self)
669.             transformer.add_transforms(self.app.registry.get_post_transforms())
670.             transformer.apply_transforms()
671.         finally:
672.             self.temp_data = backup
673. 
674.         # allow custom references to be resolved
675.         self.events.emit('doctree-resolved', doctree, docname)
676. 
677.     def collect_relations(self) -> dict[str, list[str | None]]:
678.         traversed = set()
679. 
680.         def traverse_toctree(
681.             parent: str | None, docname: str,
682.         ) -> Iterator[tuple[str | None, str]]:
683.             if parent == docname:
684.                 logger.warning(__('self referenced toctree found. Ignored.'),
685.                                location=docname, type='toc',
686.                                subtype='circular')
687.                 return
688. 
689.             # traverse toctree by pre-order
690.             yield parent, docname
691.             traversed.add(docname)
692. 
693.             for child in (self.toctree_includes.get(docname) or []):
694.                 for subparent, subdocname in traverse_toctree(docname, child):
695.                     if subdocname not in traversed:
696.                         yield subparent, subdocname
697.                         traversed.add(subdocname)
698. 
699.         relations = {}
700.         docnames = traverse_toctree(None, self.config.root_doc)
701.         prevdoc = None
702.         parent, docname = next(docnames)
703.         for nextparent, nextdoc in docnames:
704.             relations[docname] = [parent, prevdoc, nextdoc]
705.             prevdoc = docname
706.             docname = nextdoc
707.             parent = nextparent
708. 
709.         relations[docname] = [parent, prevdoc, None]
710. 
711.         return relations
712. 
713.     def check_consistency(self) -> None:
714.         """Do consistency checks."""
715.         included = set().union(*self.included.values())
716.         for docname in sorted(self.all_docs):
717.             if docname not in self.files_to_rebuild:
718.                 if docname == self.config.root_doc:
719.                     # the master file is not included anywhere ;)
720.                     continue
721.                 if docname in included:
722.                     # the document is included from other documents
723.                     continue
724.                 if 'orphan' in self.metadata[docname]:
725.                     continue
726.                 logger.warning(__("document isn't included in any toctree"),
727.                                location=docname)
728. 
729.         # call check-consistency for all extensions
730.         for domain in self.domains.values():
731.             domain.check_consistency()
732.         self.events.emit('env-check-consistency', self)


File: sphinx/environment/collectors/title.py
Line number range: 1 - 59
Content:
1. """The title collector components for sphinx.environment."""
2. 
3. from __future__ import annotations
4. 
5. from typing import Any
6. 
7. from docutils import nodes
8. 
9. from sphinx.application import Sphinx
10. from sphinx.environment import BuildEnvironment
11. from sphinx.environment.collectors import EnvironmentCollector
12. from sphinx.transforms import SphinxContentsFilter
13. 
14. 
15. class TitleCollector(EnvironmentCollector):
16.     """title collector for sphinx.environment."""
17. 
18.     def clear_doc(self, app: Sphinx, env: BuildEnvironment, docname: str) -> None:
19.         env.titles.pop(docname, None)
20.         env.longtitles.pop(docname, None)
21. 
22.     def merge_other(self, app: Sphinx, env: BuildEnvironment,
23.                     docnames: set[str], other: BuildEnvironment) -> None:
24.         for docname in docnames:
25.             env.titles[docname] = other.titles[docname]
26.             env.longtitles[docname] = other.longtitles[docname]
27. 
28.     def process_doc(self, app: Sphinx, doctree: nodes.document) -> None:
29.         """Add a title node to the document (just copy the first section title),
30.         and store that title in the environment.
31.         """
32.         titlenode = nodes.title()
33.         longtitlenode = titlenode
34.         # explicit title set with title directive; use this only for
35.         # the <title> tag in HTML output
36.         if 'title' in doctree:
37.             longtitlenode = nodes.title()
38.             longtitlenode += nodes.Text(doctree['title'])
39.         # look for first section title and use that as the title
40.         for node in doctree.findall(nodes.section):
41.             visitor = SphinxContentsFilter(doctree)
42.             node[0].walkabout(visitor)
43.             titlenode += visitor.get_entry_text()
44.             break
45.         else:
46.             # document has no title
47.             titlenode += nodes.Text(doctree.get('title', '<no title>'))
48.         app.env.titles[app.env.docname] = titlenode
49.         app.env.longtitles[app.env.docname] = longtitlenode
50. 
51. 
52. def setup(app: Sphinx) -> dict[str, Any]:
53.     app.add_env_collector(TitleCollector)
54. 
55.     return {
56.         'version': 'builtin',
57.         'parallel_read_safe': True,
58.         'parallel_write_safe': True,
59.     }


File: sphinx/environment/collectors/toctree.py
Line number range: 1 - 350
Content:
1. """Toctree collector for sphinx.environment."""
2. 
3. from __future__ import annotations
4. 
5. from typing import Any, Sequence, TypeVar, cast
6. 
7. from docutils import nodes
8. from docutils.nodes import Element, Node
9. 
10. from sphinx import addnodes
11. from sphinx.application import Sphinx
12. from sphinx.environment import BuildEnvironment
13. from sphinx.environment.adapters.toctree import TocTree
14. from sphinx.environment.collectors import EnvironmentCollector
15. from sphinx.locale import __
16. from sphinx.transforms import SphinxContentsFilter
17. from sphinx.util import logging, url_re
18. 
19. N = TypeVar('N')
20. 
21. logger = logging.getLogger(__name__)
22. 
23. 
24. class TocTreeCollector(EnvironmentCollector):
25.     def clear_doc(self, app: Sphinx, env: BuildEnvironment, docname: str) -> None:
26.         env.tocs.pop(docname, None)
27.         env.toc_secnumbers.pop(docname, None)
28.         env.toc_fignumbers.pop(docname, None)
29.         env.toc_num_entries.pop(docname, None)
30.         env.toctree_includes.pop(docname, None)
31.         env.glob_toctrees.discard(docname)
32.         env.numbered_toctrees.discard(docname)
33. 
34.         for subfn, fnset in list(env.files_to_rebuild.items()):
35.             fnset.discard(docname)
36.             if not fnset:
37.                 del env.files_to_rebuild[subfn]
38. 
39.     def merge_other(self, app: Sphinx, env: BuildEnvironment, docnames: set[str],
40.                     other: BuildEnvironment) -> None:
41.         for docname in docnames:
42.             env.tocs[docname] = other.tocs[docname]
43.             env.toc_num_entries[docname] = other.toc_num_entries[docname]
44.             if docname in other.toctree_includes:
45.                 env.toctree_includes[docname] = other.toctree_includes[docname]
46.             if docname in other.glob_toctrees:
47.                 env.glob_toctrees.add(docname)
48.             if docname in other.numbered_toctrees:
49.                 env.numbered_toctrees.add(docname)
50. 
51.         for subfn, fnset in other.files_to_rebuild.items():
52.             env.files_to_rebuild.setdefault(subfn, set()).update(fnset & set(docnames))
53. 
54.     def process_doc(self, app: Sphinx, doctree: nodes.document) -> None:
55.         """Build a TOC from the doctree and store it in the inventory."""
56.         docname = app.env.docname
57.         numentries = [0]  # nonlocal again...
58. 
59.         def build_toc(
60.             node: Element | Sequence[Element],
61.             depth: int = 1,
62.         ) -> nodes.bullet_list | None:
63.             # list of table of contents entries
64.             entries: list[Element] = []
65.             # cache of parents -> list item
66.             memo_parents: dict[tuple[str, ...], nodes.list_item] = {}
67.             for sectionnode in node:
68.                 # find all toctree nodes in this section and add them
69.                 # to the toc (just copying the toctree node which is then
70.                 # resolved in self.get_and_resolve_doctree)
71.                 if isinstance(sectionnode, nodes.section):
72.                     title = sectionnode[0]
73.                     # copy the contents of the section title, but without references
74.                     # and unnecessary stuff
75.                     visitor = SphinxContentsFilter(doctree)
76.                     title.walkabout(visitor)
77.                     nodetext = visitor.get_entry_text()
78.                     anchorname = _make_anchor_name(sectionnode['ids'], numentries)
79.                     # make these nodes:
80.                     # list_item -> compact_paragraph -> reference
81.                     reference = nodes.reference(
82.                         '', '', internal=True, refuri=docname,
83.                         anchorname=anchorname, *nodetext)
84.                     para = addnodes.compact_paragraph('', '', reference)
85.                     item: Element = nodes.list_item('', para)
86.                     sub_item = build_toc(sectionnode, depth + 1)
87.                     if sub_item:
88.                         item += sub_item
89.                     entries.append(item)
90.                 # Wrap items under an ``.. only::`` directive in a node for
91.                 # post-processing
92.                 elif isinstance(sectionnode, addnodes.only):
93.                     onlynode = addnodes.only(expr=sectionnode['expr'])
94.                     blist = build_toc(sectionnode, depth)
95.                     if blist:
96.                         onlynode += blist.children
97.                         entries.append(onlynode)
98.                 # check within the section for other node types
99.                 elif isinstance(sectionnode, nodes.Element):
100.                     toctreenode: nodes.Node
101.                     for toctreenode in sectionnode.findall():
102.                         if isinstance(toctreenode, nodes.section):
103.                             continue
104.                         if isinstance(toctreenode, addnodes.toctree):
105.                             item = toctreenode.copy()
106.                             entries.append(item)
107.                             # important: do the inventory stuff
108.                             TocTree(app.env).note(docname, toctreenode)
109.                         # add object signatures within a section to the ToC
110.                         elif isinstance(toctreenode, addnodes.desc):
111.                             for sig_node in toctreenode:
112.                                 if not isinstance(sig_node, addnodes.desc_signature):
113.                                     continue
114.                                 # Skip if no name set
115.                                 if not sig_node.get('_toc_name', ''):
116.                                     continue
117.                                 # Skip if explicitly disabled
118.                                 if sig_node.parent.get('nocontentsentry'):
119.                                     continue
120.                                 # Skip entries with no ID (e.g. with :noindex: set)
121.                                 ids = sig_node['ids']
122.                                 if not ids:
123.                                     continue
124. 
125.                                 anchorname = _make_anchor_name(ids, numentries)
126. 
127.                                 reference = nodes.reference(
128.                                     '', '', nodes.literal('', sig_node['_toc_name']),
129.                                     internal=True, refuri=docname, anchorname=anchorname)
130.                                 para = addnodes.compact_paragraph('', '', reference,
131.                                                                   skip_section_number=True)
132.                                 entry = nodes.list_item('', para)
133.                                 *parents, _ = sig_node['_toc_parts']
134.                                 parents = tuple(parents)
135. 
136.                                 # Cache parents tuple
137.                                 memo_parents[sig_node['_toc_parts']] = entry
138. 
139.                                 # Nest children within parents
140.                                 if parents and parents in memo_parents:
141.                                     root_entry = memo_parents[parents]
142.                                     if isinstance(root_entry[-1], nodes.bullet_list):
143.                                         root_entry[-1].append(entry)
144.                                     else:
145.                                         root_entry.append(nodes.bullet_list('', entry))
146.                                     continue
147. 
148.                                 entries.append(entry)
149. 
150.             if entries:
151.                 return nodes.bullet_list('', *entries)
152.             return None
153. 
154.         toc = build_toc(doctree)
155.         if toc:
156.             app.env.tocs[docname] = toc
157.         else:
158.             app.env.tocs[docname] = nodes.bullet_list('')
159.         app.env.toc_num_entries[docname] = numentries[0]
160. 
161.     def get_updated_docs(self, app: Sphinx, env: BuildEnvironment) -> list[str]:
162.         return self.assign_section_numbers(env) + self.assign_figure_numbers(env)
163. 
164.     def assign_section_numbers(self, env: BuildEnvironment) -> list[str]:
165.         """Assign a section number to each heading under a numbered toctree."""
166.         # a list of all docnames whose section numbers changed
167.         rewrite_needed = []
168. 
169.         assigned: set[str] = set()
170.         old_secnumbers = env.toc_secnumbers
171.         env.toc_secnumbers = {}
172. 
173.         def _walk_toc(
174.             node: Element, secnums: dict, depth: int, titlenode: nodes.title | None = None,
175.         ) -> None:
176.             # titlenode is the title of the document, it will get assigned a
177.             # secnumber too, so that it shows up in next/prev/parent rellinks
178.             for subnode in node.children:
179.                 if isinstance(subnode, nodes.bullet_list):
180.                     numstack.append(0)
181.                     _walk_toc(subnode, secnums, depth - 1, titlenode)
182.                     numstack.pop()
183.                     titlenode = None
184.                 elif isinstance(subnode, nodes.list_item):  # NoQA: SIM114
185.                     _walk_toc(subnode, secnums, depth, titlenode)
186.                     titlenode = None
187.                 elif isinstance(subnode, addnodes.only):
188.                     # at this stage we don't know yet which sections are going
189.                     # to be included; just include all of them, even if it leads
190.                     # to gaps in the numbering
191.                     _walk_toc(subnode, secnums, depth, titlenode)
192.                     titlenode = None
193.                 elif isinstance(subnode, addnodes.compact_paragraph):
194.                     if 'skip_section_number' in subnode:
195.                         continue
196.                     numstack[-1] += 1
197.                     reference = cast(nodes.reference, subnode[0])
198.                     if depth > 0:
199.                         number = list(numstack)
200.                         secnums[reference['anchorname']] = tuple(numstack)
201.                     else:
202.                         number = None
203.                         secnums[reference['anchorname']] = None
204.                     reference['secnumber'] = number
205.                     if titlenode:
206.                         titlenode['secnumber'] = number
207.                         titlenode = None
208.                 elif isinstance(subnode, addnodes.toctree):
209.                     _walk_toctree(subnode, depth)
210. 
211.         def _walk_toctree(toctreenode: addnodes.toctree, depth: int) -> None:
212.             if depth == 0:
213.                 return
214.             for (_title, ref) in toctreenode['entries']:
215.                 if url_re.match(ref) or ref == 'self':
216.                     # don't mess with those
217.                     continue
218.                 if ref in assigned:
219.                     logger.warning(__('%s is already assigned section numbers '
220.                                       '(nested numbered toctree?)'), ref,
221.                                    location=toctreenode, type='toc', subtype='secnum')
222.                 elif ref in env.tocs:
223.                     secnums: dict[str, tuple[int, ...]] = {}
224.                     env.toc_secnumbers[ref] = secnums
225.                     assigned.add(ref)
226.                     _walk_toc(env.tocs[ref], secnums, depth, env.titles.get(ref))
227.                     if secnums != old_secnumbers.get(ref):
228.                         rewrite_needed.append(ref)
229. 
230.         for docname in env.numbered_toctrees:
231.             assigned.add(docname)
232.             doctree = env.get_doctree(docname)
233.             for toctreenode in doctree.findall(addnodes.toctree):
234.                 depth = toctreenode.get('numbered', 0)
235.                 if depth:
236.                     # every numbered toctree gets new numbering
237.                     numstack = [0]
238.                     _walk_toctree(toctreenode, depth)
239. 
240.         return rewrite_needed
241. 
242.     def assign_figure_numbers(self, env: BuildEnvironment) -> list[str]:
243.         """Assign a figure number to each figure under a numbered toctree."""
244.         generated_docnames = frozenset(env.domains['std']._virtual_doc_names)
245. 
246.         rewrite_needed = []
247. 
248.         assigned: set[str] = set()
249.         old_fignumbers = env.toc_fignumbers
250.         env.toc_fignumbers = {}
251.         fignum_counter: dict[str, dict[tuple[int, ...], int]] = {}
252. 
253.         def get_figtype(node: Node) -> str | None:
254.             for domain in env.domains.values():
255.                 figtype = domain.get_enumerable_node_type(node)
256.                 if (domain.name == 'std'
257.                         and not domain.get_numfig_title(node)):  # type: ignore[attr-defined]  # NoQA: E501
258.                     # Skip if uncaptioned node
259.                     continue
260. 
261.                 if figtype:
262.                     return figtype
263. 
264.             return None
265. 
266.         def get_section_number(docname: str, section: nodes.section) -> tuple[int, ...]:
267.             anchorname = '#' + section['ids'][0]
268.             secnumbers = env.toc_secnumbers.get(docname, {})
269.             if anchorname in secnumbers:
270.                 secnum = secnumbers.get(anchorname)
271.             else:
272.                 secnum = secnumbers.get('')
273. 
274.             return secnum or ()
275. 
276.         def get_next_fignumber(figtype: str, secnum: tuple[int, ...]) -> tuple[int, ...]:
277.             counter = fignum_counter.setdefault(figtype, {})
278. 
279.             secnum = secnum[:env.config.numfig_secnum_depth]
280.             counter[secnum] = counter.get(secnum, 0) + 1
281.             return secnum + (counter[secnum],)
282. 
283.         def register_fignumber(docname: str, secnum: tuple[int, ...],
284.                                figtype: str, fignode: Element) -> None:
285.             env.toc_fignumbers.setdefault(docname, {})
286.             fignumbers = env.toc_fignumbers[docname].setdefault(figtype, {})
287.             figure_id = fignode['ids'][0]
288. 
289.             fignumbers[figure_id] = get_next_fignumber(figtype, secnum)
290. 
291.         def _walk_doctree(docname: str, doctree: Element, secnum: tuple[int, ...]) -> None:
292.             nonlocal generated_docnames
293.             for subnode in doctree.children:
294.                 if isinstance(subnode, nodes.section):
295.                     next_secnum = get_section_number(docname, subnode)
296.                     if next_secnum:
297.                         _walk_doctree(docname, subnode, next_secnum)
298.                     else:
299.                         _walk_doctree(docname, subnode, secnum)
300.                 elif isinstance(subnode, addnodes.toctree):
301.                     for _title, subdocname in subnode['entries']:
302.                         if url_re.match(subdocname) or subdocname == 'self':
303.                             # don't mess with those
304.                             continue
305.                         if subdocname in generated_docnames:
306.                             # or these
307.                             continue
308. 
309.                         _walk_doc(subdocname, secnum)
310.                 elif isinstance(subnode, nodes.Element):
311.                     figtype = get_figtype(subnode)
312.                     if figtype and subnode['ids']:
313.                         register_fignumber(docname, secnum, figtype, subnode)
314. 
315.                     _walk_doctree(docname, subnode, secnum)
316. 
317.         def _walk_doc(docname: str, secnum: tuple[int, ...]) -> None:
318.             if docname not in assigned:
319.                 assigned.add(docname)
320.                 doctree = env.get_doctree(docname)
321.                 _walk_doctree(docname, doctree, secnum)
322. 
323.         if env.config.numfig:
324.             _walk_doc(env.config.root_doc, ())
325.             for docname, fignums in env.toc_fignumbers.items():
326.                 if fignums != old_fignumbers.get(docname):
327.                     rewrite_needed.append(docname)
328. 
329.         return rewrite_needed
330. 
331. 
332. def _make_anchor_name(ids: list[str], num_entries: list[int]) -> str:
333.     if not num_entries[0]:
334.         # for the very first toc entry, don't add an anchor
335.         # as it is the file's title anyway
336.         anchorname = ''
337.     else:
338.         anchorname = '#' + ids[0]
339.     num_entries[0] += 1
340.     return anchorname
341. 
342. 
343. def setup(app: Sphinx) -> dict[str, Any]:
344.     app.add_env_collector(TocTreeCollector)
345. 
346.     return {
347.         'version': 'builtin',
348.         'parallel_read_safe': True,
349.         'parallel_write_safe': True,
350.     }


File: sphinx/io.py
Line number range: 1 - 188
Content:
1. """Input/Output files"""
2. from __future__ import annotations
3. 
4. from typing import TYPE_CHECKING, Any
5. 
6. import docutils
7. from docutils import nodes
8. from docutils.core import Publisher
9. from docutils.frontend import Values
10. from docutils.io import FileInput, Input, NullOutput
11. from docutils.parsers import Parser
12. from docutils.readers import standalone
13. from docutils.transforms import Transform
14. from docutils.transforms.references import DanglingReferences
15. from docutils.writers import UnfilteredWriter
16. 
17. from sphinx import addnodes
18. from sphinx.environment import BuildEnvironment
19. from sphinx.transforms import AutoIndexUpgrader, DoctreeReadEvent, SphinxTransformer
20. from sphinx.transforms.i18n import (
21.     Locale,
22.     PreserveTranslatableMessages,
23.     RemoveTranslatableInline,
24. )
25. from sphinx.transforms.references import SphinxDomains
26. from sphinx.util import logging
27. from sphinx.util.docutils import LoggingReporter
28. from sphinx.versioning import UIDTransform
29. 
30. if TYPE_CHECKING:
31.     from sphinx.application import Sphinx
32. 
33. 
34. logger = logging.getLogger(__name__)
35. 
36. 
37. class SphinxBaseReader(standalone.Reader):
38.     """
39.     A base class of readers for Sphinx.
40. 
41.     This replaces reporter by Sphinx's on generating document.
42.     """
43. 
44.     transforms: list[type[Transform]] = []
45. 
46.     def __init__(self, *args: Any, **kwargs: Any) -> None:
47.         from sphinx.application import Sphinx
48.         if len(args) > 0 and isinstance(args[0], Sphinx):
49.             self._app = args[0]
50.             self._env = self._app.env
51.             args = args[1:]
52. 
53.         super().__init__(*args, **kwargs)
54. 
55.     def setup(self, app: Sphinx) -> None:
56.         self._app = app      # hold application object only for compatibility
57.         self._env = app.env
58. 
59.     def get_transforms(self) -> list[type[Transform]]:
60.         transforms = super().get_transforms() + self.transforms
61. 
62.         # remove transforms which is not needed for Sphinx
63.         unused = [DanglingReferences]
64.         for transform in unused:
65.             if transform in transforms:
66.                 transforms.remove(transform)
67. 
68.         return transforms
69. 
70.     def new_document(self) -> nodes.document:
71.         """
72.         Creates a new document object which has a special reporter object good
73.         for logging.
74.         """
75.         document = super().new_document()
76.         document.__class__ = addnodes.document  # replace the class with patched version
77. 
78.         # substitute transformer
79.         document.transformer = SphinxTransformer(document)
80.         document.transformer.set_environment(self.settings.env)
81. 
82.         # substitute reporter
83.         reporter = document.reporter
84.         document.reporter = LoggingReporter.from_reporter(reporter)
85. 
86.         return document
87. 
88. 
89. class SphinxStandaloneReader(SphinxBaseReader):
90.     """
91.     A basic document reader for Sphinx.
92.     """
93. 
94.     def setup(self, app: Sphinx) -> None:
95.         self.transforms = self.transforms + app.registry.get_transforms()
96.         super().setup(app)
97. 
98.     def read(self, source: Input, parser: Parser, settings: Values) -> nodes.document:
99.         self.source = source
100.         if not self.parser:
101.             self.parser = parser
102.         self.settings = settings
103.         self.input = self.read_source(settings.env)
104.         self.parse()
105.         return self.document
106. 
107.     def read_source(self, env: BuildEnvironment) -> str:
108.         """Read content from source and do post-process."""
109.         content = self.source.read()
110. 
111.         # emit "source-read" event
112.         arg = [content]
113.         env.events.emit('source-read', env.docname, arg)
114.         return arg[0]
115. 
116. 
117. class SphinxI18nReader(SphinxBaseReader):
118.     """
119.     A document reader for i18n.
120. 
121.     This returns the source line number of original text as current source line number
122.     to let users know where the error happened.
123.     Because the translated texts are partial and they don't have correct line numbers.
124.     """
125. 
126.     def setup(self, app: Sphinx) -> None:
127.         super().setup(app)
128. 
129.         self.transforms = self.transforms + app.registry.get_transforms()
130.         unused = [PreserveTranslatableMessages, Locale, RemoveTranslatableInline,
131.                   AutoIndexUpgrader, SphinxDomains, DoctreeReadEvent,
132.                   UIDTransform]
133.         for transform in unused:
134.             if transform in self.transforms:
135.                 self.transforms.remove(transform)
136. 
137. 
138. class SphinxDummyWriter(UnfilteredWriter):
139.     """Dummy writer module used for generating doctree."""
140. 
141.     supported = ('html',)  # needed to keep "meta" nodes
142. 
143.     def translate(self) -> None:
144.         pass
145. 
146. 
147. def SphinxDummySourceClass(source: Any, *args: Any, **kwargs: Any) -> Any:
148.     """Bypass source object as is to cheat Publisher."""
149.     return source
150. 
151. 
152. class SphinxFileInput(FileInput):
153.     """A basic FileInput for Sphinx."""
154.     def __init__(self, *args: Any, **kwargs: Any) -> None:
155.         kwargs['error_handler'] = 'sphinx'
156.         super().__init__(*args, **kwargs)
157. 
158. 
159. def create_publisher(app: Sphinx, filetype: str) -> Publisher:
160.     reader = SphinxStandaloneReader()
161.     reader.setup(app)
162. 
163.     parser = app.registry.create_source_parser(app, filetype)
164.     if parser.__class__.__name__ == 'CommonMarkParser' and parser.settings_spec == ():
165.         # a workaround for recommonmark
166.         #   If recommonmark.AutoStrictify is enabled, the parser invokes reST parser
167.         #   internally.  But recommonmark-0.4.0 does not provide settings_spec for reST
168.         #   parser.  As a workaround, this copies settings_spec for RSTParser to the
169.         #   CommonMarkParser.
170.         from docutils.parsers.rst import Parser as RSTParser
171. 
172.         parser.settings_spec = RSTParser.settings_spec
173. 
174.     pub = Publisher(
175.         reader=reader,
176.         parser=parser,
177.         writer=SphinxDummyWriter(),
178.         source_class=SphinxFileInput,
179.         destination=NullOutput(),
180.     )
181.     # Propagate exceptions by default when used programmatically:
182.     defaults = {"traceback": True, **app.env.settings}
183.     # Set default settings
184.     if docutils.__version_info__[:2] >= (0, 19):
185.         pub.get_settings(**defaults)
186.     else:
187.         pub.settings = pub.setup_option_parser(**defaults).get_default_values()
188.     return pub


File: sphinx/util/rst.py
Line number range: 1 - 110
Content:
1. """reST helper functions."""
2. 
3. from __future__ import annotations
4. 
5. import re
6. from collections import defaultdict
7. from contextlib import contextmanager
8. from typing import Generator
9. from unicodedata import east_asian_width
10. 
11. from docutils.parsers.rst import roles
12. from docutils.parsers.rst.languages import en as english
13. from docutils.statemachine import StringList
14. from docutils.utils import Reporter
15. from jinja2 import Environment
16. 
17. from sphinx.locale import __
18. from sphinx.util import docutils, logging
19. 
20. try:
21.     from jinja2.utils import pass_environment
22. except ImportError:
23.     from jinja2 import environmentfilter as pass_environment
24. 
25. 
26. logger = logging.getLogger(__name__)
27. 
28. docinfo_re = re.compile(':\\w+:.*?')
29. symbols_re = re.compile(r'([!-\-/:-@\[-`{-~])')  # symbols without dot(0x2e)
30. SECTIONING_CHARS = ['=', '-', '~']
31. 
32. # width of characters
33. WIDECHARS: dict[str, str] = defaultdict(lambda: "WF")  # WF: Wide + Full-width
34. WIDECHARS["ja"] = "WFA"  # In Japanese, Ambiguous characters also have double width
35. 
36. 
37. def escape(text: str) -> str:
38.     text = symbols_re.sub(r'\\\1', text)
39.     text = re.sub(r'^\.', r'\.', text)  # escape a dot at top
40.     return text
41. 
42. 
43. def textwidth(text: str, widechars: str = 'WF') -> int:
44.     """Get width of text."""
45.     def charwidth(char: str, widechars: str) -> int:
46.         if east_asian_width(char) in widechars:
47.             return 2
48.         else:
49.             return 1
50. 
51.     return sum(charwidth(c, widechars) for c in text)
52. 
53. 
54. @pass_environment
55. def heading(env: Environment, text: str, level: int = 1) -> str:
56.     """Create a heading for *level*."""
57.     assert level <= 3
58.     width = textwidth(text, WIDECHARS[env.language])
59.     sectioning_char = SECTIONING_CHARS[level - 1]
60.     return f'{text}\n{sectioning_char * width}'
61. 
62. 
63. @contextmanager
64. def default_role(docname: str, name: str) -> Generator[None, None, None]:
65.     if name:
66.         dummy_reporter = Reporter('', 4, 4)
67.         role_fn, _ = roles.role(name, english, 0, dummy_reporter)
68.         if role_fn:  # type: ignore[truthy-function]
69.             docutils.register_role('', role_fn)
70.         else:
71.             logger.warning(__('default role %s not found'), name, location=docname)
72. 
73.     yield
74. 
75.     docutils.unregister_role('')
76. 
77. 
78. def prepend_prolog(content: StringList, prolog: str) -> None:
79.     """Prepend a string to content body as prolog."""
80.     if prolog:
81.         pos = 0
82.         for line in content:
83.             if docinfo_re.match(line):
84.                 pos += 1
85.             else:
86.                 break
87. 
88.         if pos > 0:
89.             # insert a blank line after docinfo
90.             content.insert(pos, '', '<generated>', 0)
91.             pos += 1
92. 
93.         # insert prolog (after docinfo if exists)
94.         for lineno, line in enumerate(prolog.splitlines()):
95.             content.insert(pos + lineno, line, '<rst_prolog>', lineno)
96. 
97.         content.insert(pos + lineno + 1, '', '<generated>', 0)
98. 
99. 
100. def append_epilog(content: StringList, epilog: str) -> None:
101.     """Append a string to content body as epilog."""
102.     if epilog:
103.         if len(content) > 0:
104.             source, lineno = content.info(-1)
105.         else:
106.             source = '<generated>'
107.             lineno = 0
108.         content.append('', source, lineno + 1)
109.         for lineno, line in enumerate(epilog.splitlines()):
110.             content.append(line, '<rst_epilog>', lineno)

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 00:48:09,256 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user wants to understand a bug related to `rst_prolog` affecting headings. The provided patch is in `sphinx/util/rst.py` inside the `prepend_prolog` function. The current context contains this function and the downstream effects of the bug (incorrect title and toctree). However, the context is missing the code that *calls* `prepend_prolog`, which is crucial for understanding how `rst_prolog` is applied to the source content before parsing. The file `sphinx/parsers.py` likely contains the Sphinx reST parser, which is the most probable place for `rst_prolog` to be handled.' query='Please provide the full content of sphinx/parsers.py.' extra_requirements='' purpose='This file should contain the code that calls `prepend_prolog`, revealing how `rst_prolog` is applied during parsing and confirming why the faulty regex breaks title extraction.'
2025-12-23 00:48:09,257 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of sphinx/parsers.py.
2025-12-23 00:48:09,257 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 00:48:09,258 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 00:48:09,259 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 00:48:09,259 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of sphinx/parsers.py.
Purpose: This file should contain the code that calls `prepend_prolog`, revealing how `rst_prolog` is applied during parsing and confirming why the faulty regex breaks title extraction.
2025-12-23 00:48:12,738 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the full content of `sphinx/parsers.py` to understand how `rst_prolog` is used. This will help determine how the faulty regex affects title extraction during the parsing process.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/parsers.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2084, 'candidates_token_count': 61, 'total_token_count': 2368, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2084}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 61}], 'thoughts_token_count': 223, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.2023292447699875, 'model_name': 'gemini-2.5-pro'} id='run--d2e42e26-3c5b-4700-a11c-ed5fcdc0b9c3-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/parsers.py'}, 'id': '6b4748df-6194-48c1-ad2f-77d553a562e5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2084, 'output_tokens': 61, 'total_tokens': 2368, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 223}}
2025-12-23 00:48:17,255 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have retrieved the content of `sphinx/parsers.py`. The `RSTParser` class within this file has a `decorate` method that is called during the parsing process. This method uses `prepend_prolog` to add the `rst_prolog` from the configuration to the beginning of the reST content before it is parsed, which is the reason the faulty regex breaks title extraction.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 3373, 'candidates_token_count': 82, 'total_token_count': 3812, 'cached_content_token_count': 1608, 'prompt_tokens_details': [{'modality': 1, 'token_count': 3373}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1608}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 82}], 'thoughts_token_count': 357}, 'finish_reason': 'STOP', 'avg_logprobs': -0.4997445083245998, 'model_name': 'gemini-2.5-pro'} id='run--f5264c42-f6b4-4cf0-9486-418eb3a92170-0' usage_metadata={'input_tokens': 3373, 'output_tokens': 82, 'total_tokens': 3812, 'input_token_details': {'cache_read': 1608}, 'output_token_details': {'reasoning': 357}}
2025-12-23 00:48:17,257 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of sphinx/parsers.py.
--- END QUERY ---



--- BEGIN PURPOSE ---
This file should contain the code that calls `prepend_prolog`, revealing how `rst_prolog` is applied during parsing and confirming why the faulty regex breaks title extraction.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: sphinx/parsers.py
Line number range: 1 - 96
Content:
1. """A Base class for additional parsers."""
2. 
3. from __future__ import annotations
4. 
5. from typing import TYPE_CHECKING, Any
6. 
7. import docutils.parsers
8. import docutils.parsers.rst
9. from docutils import nodes
10. from docutils.parsers.rst import states
11. from docutils.statemachine import StringList
12. from docutils.transforms import Transform
13. from docutils.transforms.universal import SmartQuotes
14. 
15. from sphinx.config import Config
16. from sphinx.environment import BuildEnvironment
17. from sphinx.util.rst import append_epilog, prepend_prolog
18. 
19. if TYPE_CHECKING:
20.     from sphinx.application import Sphinx
21. 
22. 
23. class Parser(docutils.parsers.Parser):
24.     """
25.     A base class of source parsers.  The additional parsers should inherit this class instead
26.     of ``docutils.parsers.Parser``.  Compared with ``docutils.parsers.Parser``, this class
27.     improves accessibility to Sphinx APIs.
28. 
29.     The subclasses can access sphinx core runtime objects (app, config and env).
30.     """
31. 
32.     #: The config object
33.     config: Config
34. 
35.     #: The environment object
36.     env: BuildEnvironment
37. 
38.     def set_application(self, app: Sphinx) -> None:
39.         """set_application will be called from Sphinx to set app and other instance variables
40. 
41.         :param sphinx.application.Sphinx app: Sphinx application object
42.         """
43.         self._app = app
44.         self.config = app.config
45.         self.env = app.env
46. 
47. 
48. class RSTParser(docutils.parsers.rst.Parser, Parser):
49.     """A reST parser for Sphinx."""
50. 
51.     def get_transforms(self) -> list[type[Transform]]:
52.         """
53.         Sphinx's reST parser replaces a transform class for smart-quotes by its own
54. 
55.         refs: sphinx.io.SphinxStandaloneReader
56.         """
57.         transforms = super().get_transforms()
58.         transforms.remove(SmartQuotes)
59.         return transforms
60. 
61.     def parse(self, inputstring: str | StringList, document: nodes.document) -> None:
62.         """Parse text and generate a document tree."""
63.         self.setup_parse(inputstring, document)  # type: ignore
64.         self.statemachine = states.RSTStateMachine(
65.             state_classes=self.state_classes,
66.             initial_state=self.initial_state,
67.             debug=document.reporter.debug_flag)
68. 
69.         # preprocess inputstring
70.         if isinstance(inputstring, str):
71.             lines = docutils.statemachine.string2lines(
72.                 inputstring, tab_width=document.settings.tab_width,
73.                 convert_whitespace=True)
74. 
75.             inputlines = StringList(lines, document.current_source)
76.         else:
77.             inputlines = inputstring
78. 
79.         self.decorate(inputlines)
80.         self.statemachine.run(inputlines, document, inliner=self.inliner)
81.         self.finish_parse()
82. 
83.     def decorate(self, content: StringList) -> None:
84.         """Preprocess reST content before parsing."""
85.         prepend_prolog(content, self.config.rst_prolog)
86.         append_epilog(content, self.config.rst_epilog)
87. 
88. 
89. def setup(app: Sphinx) -> dict[str, Any]:
90.     app.add_source_parser(RSTParser)
91. 
92.     return {
93.         'version': 'builtin',
94.         'parallel_read_safe': True,
95.         'parallel_write_safe': True,
96.     }

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 00:48:25,335 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `sphinx/parsers.py`.\n\n2. Extended relevance:\n   - The provided context contains the entire content of `sphinx/parsers.py` from line 1 to 96.\n   - The purpose mentions `prepend_prolog` and `rst_prolog`. The `decorate` method within the `RSTParser` class (lines 83-86) shows the call to `prepend_prolog` with `self.config.rst_prolog`, which is directly relevant to the user's investigation.", relative_path='sphinx/parsers.py', start_line=1, end_line=96)]
2025-12-23 00:48:25,336 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 1 contexts to memory for query: Please provide the full content of sphinx/parsers.py.
2025-12-23 00:48:25,336 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 00:48:25,337 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 00:48:25,337 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 1 new contexts to 6 existing contexts
2025-12-23 00:48:25,337 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 7 total contexts (removed 0 duplicates)
2025-12-23 00:48:25,338 - thread-125445954578112.prometheus_context_collector.lang_graph.nodes.context_refine_node - INFO - Reached max_refined_query_loop, not asking for more context
2025-12-23 00:48:25,338 - thread-125445954578112.prometheus_context_collector - INFO - Successfully retrieved 7 context snippets
