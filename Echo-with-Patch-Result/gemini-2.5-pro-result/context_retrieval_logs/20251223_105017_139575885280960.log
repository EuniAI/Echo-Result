2025-12-23 10:50:17,827 - thread-139575885280960.prometheus_context_collector - INFO - Starting context retrieval for query: 
Issue: locale/<language>/LC_MESSAGES/sphinx.po translation ignored

Description: **Describe the bug**
I read [1] as it should be possible to add a file ``locale/<language>/LC_MESSAGES/sphinx.mo`` to the source dir (same dir as the ``Makefile``) and through that change translations or add additional translation to <language>. 

When I add ``locale/da/LC_MESSAGES/sphinx.po``, with updated entries for ``Fig. %s`` and ``Listing %s``, a ``locale/da/LC_MESSAGES/sphinx.mo`` is created (because of ``gettext_auto_build = True``), but the translations are not used. The translations from the official ``da`` translation [2] is used. Of course ``language = 'da'`` is in ``conf.py``.

[1] http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-locale_dirs
[2] https://github.com/sphinx-doc/sphinx/blob/master/sphinx/locale/da/LC_MESSAGES/sphinx.po

**To Reproduce**
Steps to reproduce the behavior:
```
$ git clone https://github.com/jonascj/sphinx-test-locale-override.git
$ cd sphinx-test-locale-override
$ git checkout 8dea4cd # EDIT: current master showcases workaround, so revert back to see the bug
$ # make python venv however you like
$ pip install sphinx
$ make html
```
Notice that ``locale/da/LC_MESSAGES/sphinx.mo`` has been created. Open ``_build/html/index.html``. 

**Expected behavior**
The caption label for the figure ``figur 1`` should have been ``Foobar 1`` (for the sake of testing) and the caption label for the code block ``Viser 1`` should have been ``Whatever 1`` (again for the sake of testing).

**Your project**
https://github.com/jonascj/sphinx-test-locale-override.git

**Screenshots**
![Screenshot of index.html](https://yapb.in/exUE.png "Screenshot of index.html")

**Environment info**
- OS: Arch Linux 
- Python version: 3.7.3
- Sphinx version: 2.1.2
- Sphinx extensions:  none
- Extra tools: none


Patch information:
diff --git a/sphinx/application.py b/sphinx/application.py
index 385b74d8a..995efedd6 100644
--- a/sphinx/application.py
+++ b/sphinx/application.py
@@ -293,7 +293,8 @@ class Sphinx:
                 if catalog.domain == 'sphinx' and catalog.is_outdated():
                     catalog.write_mo(self.config.language)
 
-            locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
+            # Put user-provided locale directories first to ensure custom translations override official ones
+            locale_dirs = list(repo.locale_dirs) + [None, path.join(package_dir, 'locale')]
             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
             if has_translation or self.config.language == 'en':
                 # "en" never needs to be translated


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

2025-12-23 10:50:17,899 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       └── main.yml
├── .travis.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── conftest.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   └── typing_test_data.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: locale/<language>/LC_MESSAGES/sphinx.po translation ignored

Description: **Describe the bug**
I read [1] as it should be possible to add a file ``locale/<language>/LC_MESSAGES/sphinx.mo`` to the source dir (same dir as the ``Makefile``) and through that change translations or add additional translation to <language>. 

When I add ``locale/da/LC_MESSAGES/sphinx.po``, with updated entries for ``Fig. %s`` and ``Listing %s``, a ``locale/da/LC_MESSAGES/sphinx.mo`` is created (because of ``gettext_auto_build = True``), but the translations are not used. The translations from the official ``da`` translation [2] is used. Of course ``language = 'da'`` is in ``conf.py``.

[1] http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-locale_dirs
[2] https://github.com/sphinx-doc/sphinx/blob/master/sphinx/locale/da/LC_MESSAGES/sphinx.po

**To Reproduce**
Steps to reproduce the behavior:
```
$ git clone https://github.com/jonascj/sphinx-test-locale-override.git
$ cd sphinx-test-locale-override
$ git checkout 8dea4cd # EDIT: current master showcases workaround, so revert back to see the bug
$ # make python venv however you like
$ pip install sphinx
$ make html
```
Notice that ``locale/da/LC_MESSAGES/sphinx.mo`` has been created. Open ``_build/html/index.html``. 

**Expected behavior**
The caption label for the figure ``figur 1`` should have been ``Foobar 1`` (for the sake of testing) and the caption label for the code block ``Viser 1`` should have been ``Whatever 1`` (again for the sake of testing).

**Your project**
https://github.com/jonascj/sphinx-test-locale-override.git

**Screenshots**
![Screenshot of index.html](https://yapb.in/exUE.png "Screenshot of index.html")

**Environment info**
- OS: Arch Linux 
- Python version: 3.7.3
- Sphinx version: 2.1.2
- Sphinx extensions:  none
- Extra tools: none


Patch information:
diff --git a/sphinx/application.py b/sphinx/application.py
index 385b74d8a..995efedd6 100644
--- a/sphinx/application.py
+++ b/sphinx/application.py
@@ -293,7 +293,8 @@ class Sphinx:
                 if catalog.domain == 'sphinx' and catalog.is_outdated():
                     catalog.write_mo(self.config.language)
 
-            locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
+            # Put user-provided locale directories first to ensure custom translations override official ones
+            locale_dirs = list(repo.locale_dirs) + [None, path.join(package_dir, 'locale')]
             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
             if has_translation or self.config.language == 'en':
                 # "en" never needs to be translated


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 10:50:28,132 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user has reported an issue with translation overrides and proposed a patch in `sphinx/application.py`. To understand the context of the patch and how translations are initialized, I need to examine the `Sphinx` class and its `setup_i18n` method within that file.' query='Please provide the full content of sphinx/application.py.' extra_requirements='' purpose='This file contains the core application logic and the code snippet mentioned in the issue, which is essential for understanding the problem.'
2025-12-23 10:50:28,133 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of sphinx/application.py.
2025-12-23 10:50:28,133 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 10:50:28,133 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 10:50:28,134 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 10:50:28,134 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of sphinx/application.py.
Purpose: This file contains the core application logic and the code snippet mentioned in the issue, which is essential for understanding the problem.
2025-12-23 10:50:29,947 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/application.py"}'}, '__gemini_function_call_thought_signatures__': {'4c86a8c1-b824-492d-9493-0f6092675444': 'CrUDAY89a1/uAuvHIEjQPf6T3E0de1wxNEF2fyD56Wg9tW7v+vY1jwAPybrrL0E20L1w6u2/J6AhKsCS4h9AtZ2wzPtM8RMqCI2xY4Pn9KEyteBtWEBXcJhgUG2lkaulo1A0xkC+hvQ4UbzpvWChx5ryaab7Lgq/tPT2Je4v0mQM3O6vLmDgcrI5yMTNC17BJ6xIVmon2f6pgZkYBpmdBB1gwfm+a/f4rC1Om1sTL+MAJqBM6MOGlCVQBmh6mouPmUxFoCsNd5RMXspuE1Lq+uhOX4LRBGCuysptRZL4d8ainYMnQBQHompwYOGnAhxmKTQvRkliyXJ53KPrKpoza4j5ylSo62cWC43uJ9jd5sKknkQbczpbwoA0ydlLDVUa1GEdVcJcVsIZxsdEtcZvdbGp/+3hdZmwT7mXxu7ZqfC8ozlcHWcTbBTru2lMQE+UxUqKNWOJJgLtkJYW1fROOy1cBUYy0oEk9ljuRmHOssjyt5eD2DiwrtYEBEE80Nv28gGzPF+Xf0mW/DegMJ1r9sG9eWuMLtJhKwdZdfHNsXHieOgdgJWgJ0B2X5GYsrZamjNX9n2fXOU='}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2072, 'candidates_token_count': 19, 'total_token_count': 2198, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2072}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 19}], 'thoughts_token_count': 107, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.19753089704011617, 'model_name': 'gemini-2.5-pro'} id='run--bb7d413c-7fa6-427f-be52-ddbf35314574-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/application.py'}, 'id': '4c86a8c1-b824-492d-9493-0f6092675444', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2072, 'output_tokens': 19, 'total_tokens': 2198, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 107}}
2025-12-23 10:50:32,421 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'function_call': {'name': 'read_code_with_relative_path', 'arguments': '{"end_line": 1501.0, "relative_path": "sphinx/application.py", "start_line": 501.0}'}, '__gemini_function_call_thought_signatures__': {'798ceec9-a6c3-46e9-bdf3-785c0e1d9a96': 'CuQDAY89a1/mWVi9Qk2jwlssbbtADZwFU/cDcbWSyjLLXdhURcWy+5sRWzzXs3c+e2VaMT91poyzOZ/m3S3B+hMMydvuphlJdFxgOmyX0gBbN5W8/WSkc3NgL8PtfPXLxqntxRZnAEed/q8TgXT4e2W69gMPMgSteOY2sVECr0xWcCEWxCB3RqgQ7ADuh2V7eYTkneqsDPUAlJLqfYz7KlMmSGzuesVHhODKsqsuLr6c/TRoItTvDq6DKoS2EQzvCgnzgL80SvI8vv9MwsaZJclLsPmB7Xo1ecsUCadmMgSOyTGl5wd4gaX/ux5p3TwAtLBFnIdgiYttBCEsoa9I9JrBJQFKeWTWZBlMeqPmhvkszZKztmIkg+XUJI9jFdbVG8/TW3HtllLNCwlqJxytXX3uAdPp7x78U0u8pwfm/JE49LSm3eI6Q7+3RV5qFkhX056sRGY2SZSVlQPo0WQf6adZpDnwIM/BqAcDyZUwf7Tmx53aaBRbU7XajeqQAwieZwctqQM8u1o4Tc4Ort0zXB2bnL1njDdeGOf3D0Ek0lffJG+SSOfs9koBPv6L+CkmkThCNu3EjgPznY5E0wt57gpEw0bqdhevBr6ZTNT36l0QJLMoJJX4fb11EIovbaK2z7lyckz0yA=='}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 9368, 'candidates_token_count': 25, 'total_token_count': 9522, 'cached_content_token_count': 1829, 'prompt_tokens_details': [{'modality': 1, 'token_count': 9475}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1829}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 25}], 'thoughts_token_count': 129}, 'finish_reason': 'STOP', 'avg_logprobs': -0.8111020660400391, 'model_name': 'gemini-2.5-pro'} id='run--f22d8853-3a33-462c-a26f-c41bca48b8a0-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'end_line': 1501.0, 'relative_path': 'sphinx/application.py', 'start_line': 501.0}, 'id': '798ceec9-a6c3-46e9-bdf3-785c0e1d9a96', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9368, 'output_tokens': 25, 'total_tokens': 9522, 'input_token_details': {'cache_read': 1829}, 'output_token_details': {'reasoning': 129}}
2025-12-23 10:50:35,196 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content="I have successfully retrieved the entire content of the `sphinx/application.py` file. The file's content was fetched in two parts to handle its size, and now I have the complete code for your review." additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 20797, 'candidates_token_count': 44, 'total_token_count': 20908, 'prompt_tokens_details': [{'modality': 1, 'token_count': 21033}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 44}], 'thoughts_token_count': 67, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.18322816762057217, 'model_name': 'gemini-2.5-pro'} id='run--bf209171-b20a-4bfa-88f6-540de6caec32-0' usage_metadata={'input_tokens': 20797, 'output_tokens': 44, 'total_tokens': 20908, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 67}}
2025-12-23 10:50:35,198 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of sphinx/application.py.
--- END QUERY ---



--- BEGIN PURPOSE ---
This file contains the core application logic and the code snippet mentioned in the issue, which is essential for understanding the problem.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: sphinx/application.py
Line number range: 1 - 500
Content:
1. """
2.     sphinx.application
3.     ~~~~~~~~~~~~~~~~~~
4. 
5.     Sphinx application class and extensibility interface.
6. 
7.     Gracefully adapted from the TextPress system by Armin.
8. 
9.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
10.     :license: BSD, see LICENSE for details.
11. """
12. 
13. import os
14. import pickle
15. import platform
16. import sys
17. import warnings
18. from collections import deque
19. from io import StringIO
20. from os import path
21. from typing import Any, Callable, Dict, IO, List, Tuple, Union
22. 
23. from docutils import nodes
24. from docutils.nodes import Element, TextElement
25. from docutils.parsers.rst import Directive, roles
26. from docutils.transforms import Transform
27. from pygments.lexer import Lexer
28. 
29. import sphinx
30. from sphinx import package_dir, locale
31. from sphinx.config import Config
32. from sphinx.deprecation import RemovedInSphinx40Warning
33. from sphinx.domains import Domain, Index
34. from sphinx.environment import BuildEnvironment
35. from sphinx.environment.collectors import EnvironmentCollector
36. from sphinx.errors import ApplicationError, ConfigError, VersionRequirementError
37. from sphinx.events import EventManager
38. from sphinx.extension import Extension
39. from sphinx.highlighting import lexer_classes, lexers
40. from sphinx.locale import __
41. from sphinx.project import Project
42. from sphinx.registry import SphinxComponentRegistry
43. from sphinx.roles import XRefRole
44. from sphinx.theming import Theme
45. from sphinx.util import docutils
46. from sphinx.util import logging
47. from sphinx.util import progress_message
48. from sphinx.util.build_phase import BuildPhase
49. from sphinx.util.console import bold  # type: ignore
50. from sphinx.util.i18n import CatalogRepository
51. from sphinx.util.logging import prefixed_warnings
52. from sphinx.util.osutil import abspath, ensuredir, relpath
53. from sphinx.util.tags import Tags
54. from sphinx.util.typing import RoleFunction, TitleGetter
55. 
56. if False:
57.     # For type annotation
58.     from docutils.nodes import Node  # NOQA
59.     from typing import Type  # for python3.5.1
60.     from sphinx.builders import Builder
61. 
62. 
63. builtin_extensions = (
64.     'sphinx.addnodes',
65.     'sphinx.builders.changes',
66.     'sphinx.builders.epub3',
67.     'sphinx.builders.dirhtml',
68.     'sphinx.builders.dummy',
69.     'sphinx.builders.gettext',
70.     'sphinx.builders.html',
71.     'sphinx.builders.latex',
72.     'sphinx.builders.linkcheck',
73.     'sphinx.builders.manpage',
74.     'sphinx.builders.singlehtml',
75.     'sphinx.builders.texinfo',
76.     'sphinx.builders.text',
77.     'sphinx.builders.xml',
78.     'sphinx.config',
79.     'sphinx.domains.c',
80.     'sphinx.domains.changeset',
81.     'sphinx.domains.citation',
82.     'sphinx.domains.cpp',
83.     'sphinx.domains.index',
84.     'sphinx.domains.javascript',
85.     'sphinx.domains.math',
86.     'sphinx.domains.python',
87.     'sphinx.domains.rst',
88.     'sphinx.domains.std',
89.     'sphinx.directives',
90.     'sphinx.directives.code',
91.     'sphinx.directives.other',
92.     'sphinx.directives.patches',
93.     'sphinx.extension',
94.     'sphinx.parsers',
95.     'sphinx.registry',
96.     'sphinx.roles',
97.     'sphinx.transforms',
98.     'sphinx.transforms.compact_bullet_list',
99.     'sphinx.transforms.i18n',
100.     'sphinx.transforms.references',
101.     'sphinx.transforms.post_transforms',
102.     'sphinx.transforms.post_transforms.code',
103.     'sphinx.transforms.post_transforms.images',
104.     'sphinx.util.compat',
105.     'sphinx.versioning',
106.     # collectors should be loaded by specific order
107.     'sphinx.environment.collectors.dependencies',
108.     'sphinx.environment.collectors.asset',
109.     'sphinx.environment.collectors.metadata',
110.     'sphinx.environment.collectors.title',
111.     'sphinx.environment.collectors.toctree',
112.     # 1st party extensions
113.     'sphinxcontrib.applehelp',
114.     'sphinxcontrib.devhelp',
115.     'sphinxcontrib.htmlhelp',
116.     'sphinxcontrib.serializinghtml',
117.     'sphinxcontrib.qthelp',
118.     # Strictly, alabaster theme is not a builtin extension,
119.     # but it is loaded automatically to use it as default theme.
120.     'alabaster',
121. )
122. 
123. ENV_PICKLE_FILENAME = 'environment.pickle'
124. 
125. logger = logging.getLogger(__name__)
126. 
127. 
128. class Sphinx:
129.     """The main application class and extensibility interface.
130. 
131.     :ivar srcdir: Directory containing source.
132.     :ivar confdir: Directory containing ``conf.py``.
133.     :ivar doctreedir: Directory for storing pickled doctrees.
134.     :ivar outdir: Directory for storing build documents.
135.     """
136. 
137.     def __init__(self, srcdir: str, confdir: str, outdir: str, doctreedir: str,
138.                  buildername: str, confoverrides: Dict = None,
139.                  status: IO = sys.stdout, warning: IO = sys.stderr,
140.                  freshenv: bool = False, warningiserror: bool = False, tags: List[str] = None,
141.                  verbosity: int = 0, parallel: int = 0, keep_going: bool = False) -> None:
142.         self.phase = BuildPhase.INITIALIZATION
143.         self.verbosity = verbosity
144.         self.extensions = {}                    # type: Dict[str, Extension]
145.         self.builder = None                     # type: Builder
146.         self.env = None                         # type: BuildEnvironment
147.         self.project = None                     # type: Project
148.         self.registry = SphinxComponentRegistry()
149.         self.html_themes = {}                   # type: Dict[str, str]
150. 
151.         # validate provided directories
152.         self.srcdir = abspath(srcdir)
153.         self.outdir = abspath(outdir)
154.         self.doctreedir = abspath(doctreedir)
155.         self.confdir = confdir
156.         if self.confdir:  # confdir is optional
157.             self.confdir = abspath(self.confdir)
158.             if not path.isfile(path.join(self.confdir, 'conf.py')):
159.                 raise ApplicationError(__("config directory doesn't contain a "
160.                                           "conf.py file (%s)") % confdir)
161. 
162.         if not path.isdir(self.srcdir):
163.             raise ApplicationError(__('Cannot find source directory (%s)') %
164.                                    self.srcdir)
165. 
166.         if path.exists(self.outdir) and not path.isdir(self.outdir):
167.             raise ApplicationError(__('Output directory (%s) is not a directory') %
168.                                    self.outdir)
169. 
170.         if self.srcdir == self.outdir:
171.             raise ApplicationError(__('Source directory and destination '
172.                                       'directory cannot be identical'))
173. 
174.         self.parallel = parallel
175. 
176.         if status is None:
177.             self._status = StringIO()      # type: IO
178.             self.quiet = True
179.         else:
180.             self._status = status
181.             self.quiet = False
182. 
183.         if warning is None:
184.             self._warning = StringIO()     # type: IO
185.         else:
186.             self._warning = warning
187.         self._warncount = 0
188.         self.keep_going = warningiserror and keep_going
189.         if self.keep_going:
190.             self.warningiserror = False
191.         else:
192.             self.warningiserror = warningiserror
193.         logging.setup(self, self._status, self._warning)
194. 
195.         self.events = EventManager(self)
196. 
197.         # keep last few messages for traceback
198.         # This will be filled by sphinx.util.logging.LastMessagesWriter
199.         self.messagelog = deque(maxlen=10)  # type: deque
200. 
201.         # say hello to the world
202.         logger.info(bold(__('Running Sphinx v%s') % sphinx.__display_version__))
203. 
204.         # notice for parallel build on macOS and py38+
205.         if sys.version_info > (3, 8) and platform.system() == 'Darwin' and parallel > 1:
206.             logger.info(bold(__("For security reason, parallel mode is disabled on macOS and "
207.                                 "python3.8 and above. For more details, please read "
208.                                 "https://github.com/sphinx-doc/sphinx/issues/6803")))
209. 
210.         # status code for command-line application
211.         self.statuscode = 0
212. 
213.         # read config
214.         self.tags = Tags(tags)
215.         if self.confdir is None:
216.             self.config = Config({}, confoverrides or {})
217.         else:
218.             self.config = Config.read(self.confdir, confoverrides or {}, self.tags)
219. 
220.         # initialize some limited config variables before initialize i18n and loading
221.         # extensions
222.         self.config.pre_init_values()
223. 
224.         # set up translation infrastructure
225.         self._init_i18n()
226. 
227.         # check the Sphinx version if requested
228.         if self.config.needs_sphinx and self.config.needs_sphinx > sphinx.__display_version__:
229.             raise VersionRequirementError(
230.                 __('This project needs at least Sphinx v%s and therefore cannot '
231.                    'be built with this version.') % self.config.needs_sphinx)
232. 
233.         # set confdir to srcdir if -C given (!= no confdir); a few pieces
234.         # of code expect a confdir to be set
235.         if self.confdir is None:
236.             self.confdir = self.srcdir
237. 
238.         # load all built-in extension modules
239.         for extension in builtin_extensions:
240.             self.setup_extension(extension)
241. 
242.         # load all user-given extension modules
243.         for extension in self.config.extensions:
244.             self.setup_extension(extension)
245. 
246.         # preload builder module (before init config values)
247.         self.preload_builder(buildername)
248. 
249.         if not path.isdir(outdir):
250.             with progress_message(__('making output directory')):
251.                 ensuredir(outdir)
252. 
253.         # the config file itself can be an extension
254.         if self.config.setup:
255.             prefix = __('while setting up extension %s:') % "conf.py"
256.             with prefixed_warnings(prefix):
257.                 if callable(self.config.setup):
258.                     self.config.setup(self)
259.                 else:
260.                     raise ConfigError(
261.                         __("'setup' as currently defined in conf.py isn't a Python callable. "
262.                            "Please modify its definition to make it a callable function. "
263.                            "This is needed for conf.py to behave as a Sphinx extension.")
264.                     )
265. 
266.         # now that we know all config values, collect them from conf.py
267.         self.config.init_values()
268.         self.events.emit('config-inited', self.config)
269. 
270.         # create the project
271.         self.project = Project(self.srcdir, self.config.source_suffix)
272.         # create the builder
273.         self.builder = self.create_builder(buildername)
274.         # set up the build environment
275.         self._init_env(freshenv)
276.         # set up the builder
277.         self._init_builder()
278. 
279.     def _init_i18n(self) -> None:
280.         """Load translated strings from the configured localedirs if enabled in
281.         the configuration.
282.         """
283.         if self.config.language is None:
284.             self.translator, has_translation = locale.init([], None)
285.         else:
286.             logger.info(bold(__('loading translations [%s]... ') % self.config.language),
287.                         nonl=True)
288. 
289.             # compile mo files if sphinx.po file in user locale directories are updated
290.             repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
291.                                      self.config.language, self.config.source_encoding)
292.             for catalog in repo.catalogs:
293.                 if catalog.domain == 'sphinx' and catalog.is_outdated():
294.                     catalog.write_mo(self.config.language)
295. 
296.             locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
297.             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
298.             if has_translation or self.config.language == 'en':
299.                 # "en" never needs to be translated
300.                 logger.info(__('done'))
301.             else:
302.                 logger.info(__('not available for built-in messages'))
303. 
304.     def _init_env(self, freshenv: bool) -> None:
305.         filename = path.join(self.doctreedir, ENV_PICKLE_FILENAME)
306.         if freshenv or not os.path.exists(filename):
307.             self.env = BuildEnvironment()
308.             self.env.setup(self)
309.             self.env.find_files(self.config, self.builder)
310.         else:
311.             try:
312.                 with progress_message(__('loading pickled environment')):
313.                     with open(filename, 'rb') as f:
314.                         self.env = pickle.load(f)
315.                         self.env.setup(self)
316.             except Exception as err:
317.                 logger.info(__('failed: %s'), err)
318.                 self._init_env(freshenv=True)
319. 
320.     def preload_builder(self, name: str) -> None:
321.         self.registry.preload_builder(self, name)
322. 
323.     def create_builder(self, name: str) -> "Builder":
324.         if name is None:
325.             logger.info(__('No builder selected, using default: html'))
326.             name = 'html'
327. 
328.         return self.registry.create_builder(self, name)
329. 
330.     def _init_builder(self) -> None:
331.         self.builder.set_environment(self.env)
332.         self.builder.init()
333.         self.events.emit('builder-inited')
334. 
335.     # ---- main "build" method -------------------------------------------------
336. 
337.     def build(self, force_all: bool = False, filenames: List[str] = None) -> None:
338.         self.phase = BuildPhase.READING
339.         try:
340.             if force_all:
341.                 self.builder.compile_all_catalogs()
342.                 self.builder.build_all()
343.             elif filenames:
344.                 self.builder.compile_specific_catalogs(filenames)
345.                 self.builder.build_specific(filenames)
346.             else:
347.                 self.builder.compile_update_catalogs()
348.                 self.builder.build_update()
349. 
350.             if self._warncount and self.keep_going:
351.                 self.statuscode = 1
352. 
353.             status = (__('succeeded') if self.statuscode == 0
354.                       else __('finished with problems'))
355.             if self._warncount:
356.                 if self.warningiserror:
357.                     if self._warncount == 1:
358.                         msg = __('build %s, %s warning (with warnings treated as errors).')
359.                     else:
360.                         msg = __('build %s, %s warnings (with warnings treated as errors).')
361.                 else:
362.                     if self._warncount == 1:
363.                         msg = __('build %s, %s warning.')
364.                     else:
365.                         msg = __('build %s, %s warnings.')
366. 
367.                 logger.info(bold(msg % (status, self._warncount)))
368.             else:
369.                 logger.info(bold(__('build %s.') % status))
370. 
371.             if self.statuscode == 0 and self.builder.epilog:
372.                 logger.info('')
373.                 logger.info(self.builder.epilog % {
374.                     'outdir': relpath(self.outdir),
375.                     'project': self.config.project
376.                 })
377.         except Exception as err:
378.             # delete the saved env to force a fresh build next time
379.             envfile = path.join(self.doctreedir, ENV_PICKLE_FILENAME)
380.             if path.isfile(envfile):
381.                 os.unlink(envfile)
382.             self.events.emit('build-finished', err)
383.             raise
384.         else:
385.             self.events.emit('build-finished', None)
386.         self.builder.cleanup()
387. 
388.     # ---- general extensibility interface -------------------------------------
389. 
390.     def setup_extension(self, extname: str) -> None:
391.         """Import and setup a Sphinx extension module.
392. 
393.         Load the extension given by the module *name*.  Use this if your
394.         extension needs the features provided by another extension.  No-op if
395.         called twice.
396.         """
397.         logger.debug('[app] setting up extension: %r', extname)
398.         self.registry.load_extension(self, extname)
399. 
400.     def require_sphinx(self, version: str) -> None:
401.         """Check the Sphinx version if requested.
402. 
403.         Compare *version* (which must be a ``major.minor`` version string, e.g.
404.         ``'1.1'``) with the version of the running Sphinx, and abort the build
405.         when it is too old.
406. 
407.         .. versionadded:: 1.0
408.         """
409.         if version > sphinx.__display_version__[:3]:
410.             raise VersionRequirementError(version)
411. 
412.     # event interface
413.     def connect(self, event: str, callback: Callable, priority: int = 500) -> int:
414.         """Register *callback* to be called when *event* is emitted.
415. 
416.         For details on available core events and the arguments of callback
417.         functions, please see :ref:`events`.
418. 
419.         Registered callbacks will be invoked on event in the order of *priority* and
420.         registration.  The priority is ascending order.
421. 
422.         The method returns a "listener ID" that can be used as an argument to
423.         :meth:`disconnect`.
424. 
425.         .. versionchanged:: 3.0
426. 
427.            Support *priority*
428.         """
429.         listener_id = self.events.connect(event, callback, priority)
430.         logger.debug('[app] connecting event %r (%d): %r [id=%s]',
431.                      event, priority, callback, listener_id)
432.         return listener_id
433. 
434.     def disconnect(self, listener_id: int) -> None:
435.         """Unregister callback by *listener_id*."""
436.         logger.debug('[app] disconnecting event: [id=%s]', listener_id)
437.         self.events.disconnect(listener_id)
438. 
439.     def emit(self, event: str, *args: Any,
440.              allowed_exceptions: Tuple["Type[Exception]", ...] = ()) -> List:
441.         """Emit *event* and pass *arguments* to the callback functions.
442. 
443.         Return the return values of all callbacks as a list.  Do not emit core
444.         Sphinx events in extensions!
445. 
446.         .. versionchanged:: 3.1
447. 
448.            Added *allowed_exceptions* to specify path-through exceptions
449.         """
450.         return self.events.emit(event, *args, allowed_exceptions=allowed_exceptions)
451. 
452.     def emit_firstresult(self, event: str, *args: Any,
453.                          allowed_exceptions: Tuple["Type[Exception]", ...] = ()) -> Any:
454.         """Emit *event* and pass *arguments* to the callback functions.
455. 
456.         Return the result of the first callback that doesn't return ``None``.
457. 
458.         .. versionadded:: 0.5
459.         .. versionchanged:: 3.1
460. 
461.            Added *allowed_exceptions* to specify path-through exceptions
462.         """
463.         return self.events.emit_firstresult(event, *args,
464.                                             allowed_exceptions=allowed_exceptions)
465. 
466.     # registering addon parts
467. 
468.     def add_builder(self, builder: "Type[Builder]", override: bool = False) -> None:
469.         """Register a new builder.
470. 
471.         *builder* must be a class that inherits from
472.         :class:`~sphinx.builders.Builder`.
473. 
474.         .. versionchanged:: 1.8
475.            Add *override* keyword.
476.         """
477.         self.registry.add_builder(builder, override=override)
478. 
479.     # TODO(stephenfin): Describe 'types' parameter
480.     def add_config_value(self, name: str, default: Any, rebuild: Union[bool, str],
481.                          types: Any = ()) -> None:
482.         """Register a configuration value.
483. 
484.         This is necessary for Sphinx to recognize new values and set default
485.         values accordingly.  The *name* should be prefixed with the extension
486.         name, to avoid clashes.  The *default* value can be any Python object.
487.         The string value *rebuild* must be one of those values:
488. 
489.         * ``'env'`` if a change in the setting only takes effect when a
490.           document is parsed -- this means that the whole environment must be
491.           rebuilt.
492.         * ``'html'`` if a change in the setting needs a full rebuild of HTML
493.           documents.
494.         * ``''`` if a change in the setting will not need any special rebuild.
495. 
496.         .. versionchanged:: 0.6
497.            Changed *rebuild* from a simple boolean (equivalent to ``''`` or
498.            ``'env'``) to a string.  However, booleans are still accepted and
499.            converted internally.
500.


File: sphinx/application.py
Line number range: 501 - 1501
Content:
501.         .. versionchanged:: 0.4
502.            If the *default* value is a callable, it will be called with the
503.            config object as its argument in order to get the default value.
504.            This can be used to implement config values whose default depends on
505.            other values.
506.         """
507.         logger.debug('[app] adding config value: %r',
508.                      (name, default, rebuild) + ((types,) if types else ()))
509.         if rebuild in (False, True):
510.             rebuild = 'env' if rebuild else ''
511.         self.config.add(name, default, rebuild, types)
512. 
513.     def add_event(self, name: str) -> None:
514.         """Register an event called *name*.
515. 
516.         This is needed to be able to emit it.
517.         """
518.         logger.debug('[app] adding event: %r', name)
519.         self.events.add(name)
520. 
521.     def set_translator(self, name: str, translator_class: "Type[nodes.NodeVisitor]",
522.                        override: bool = False) -> None:
523.         """Register or override a Docutils translator class.
524. 
525.         This is used to register a custom output translator or to replace a
526.         builtin translator.  This allows extensions to use custom translator
527.         and define custom nodes for the translator (see :meth:`add_node`).
528. 
529.         .. versionadded:: 1.3
530.         .. versionchanged:: 1.8
531.            Add *override* keyword.
532.         """
533.         self.registry.add_translator(name, translator_class, override=override)
534. 
535.     def add_node(self, node: "Type[Element]", override: bool = False,
536.                  **kwargs: Tuple[Callable, Callable]) -> None:
537.         """Register a Docutils node class.
538. 
539.         This is necessary for Docutils internals.  It may also be used in the
540.         future to validate nodes in the parsed documents.
541. 
542.         Node visitor functions for the Sphinx HTML, LaTeX, text and manpage
543.         writers can be given as keyword arguments: the keyword should be one or
544.         more of ``'html'``, ``'latex'``, ``'text'``, ``'man'``, ``'texinfo'``
545.         or any other supported translators, the value a 2-tuple of ``(visit,
546.         depart)`` methods.  ``depart`` can be ``None`` if the ``visit``
547.         function raises :exc:`docutils.nodes.SkipNode`.  Example:
548. 
549.         .. code-block:: python
550. 
551.            class math(docutils.nodes.Element): pass
552. 
553.            def visit_math_html(self, node):
554.                self.body.append(self.starttag(node, 'math'))
555.            def depart_math_html(self, node):
556.                self.body.append('</math>')
557. 
558.            app.add_node(math, html=(visit_math_html, depart_math_html))
559. 
560.         Obviously, translators for which you don't specify visitor methods will
561.         choke on the node when encountered in a document to translate.
562. 
563.         .. versionchanged:: 0.5
564.            Added the support for keyword arguments giving visit functions.
565.         """
566.         logger.debug('[app] adding node: %r', (node, kwargs))
567.         if not override and docutils.is_node_registered(node):
568.             logger.warning(__('node class %r is already registered, '
569.                               'its visitors will be overridden'),
570.                            node.__name__, type='app', subtype='add_node')
571.         docutils.register_node(node)
572.         self.registry.add_translation_handlers(node, **kwargs)
573. 
574.     def add_enumerable_node(self, node: "Type[Element]", figtype: str,
575.                             title_getter: TitleGetter = None, override: bool = False,
576.                             **kwargs: Tuple[Callable, Callable]) -> None:
577.         """Register a Docutils node class as a numfig target.
578. 
579.         Sphinx numbers the node automatically. And then the users can refer it
580.         using :rst:role:`numref`.
581. 
582.         *figtype* is a type of enumerable nodes.  Each figtypes have individual
583.         numbering sequences.  As a system figtypes, ``figure``, ``table`` and
584.         ``code-block`` are defined.  It is able to add custom nodes to these
585.         default figtypes.  It is also able to define new custom figtype if new
586.         figtype is given.
587. 
588.         *title_getter* is a getter function to obtain the title of node.  It
589.         takes an instance of the enumerable node, and it must return its title
590.         as string.  The title is used to the default title of references for
591.         :rst:role:`ref`.  By default, Sphinx searches
592.         ``docutils.nodes.caption`` or ``docutils.nodes.title`` from the node as
593.         a title.
594. 
595.         Other keyword arguments are used for node visitor functions. See the
596.         :meth:`.Sphinx.add_node` for details.
597. 
598.         .. versionadded:: 1.4
599.         """
600.         self.registry.add_enumerable_node(node, figtype, title_getter, override=override)
601.         self.add_node(node, override=override, **kwargs)
602. 
603.     def add_directive(self, name: str, cls: "Type[Directive]", override: bool = False) -> None:
604.         """Register a Docutils directive.
605. 
606.         *name* must be the prospective directive name.  *cls* is a directive
607.         class which inherits ``docutils.parsers.rst.Directive``.  For more
608.         details, see `the Docutils docs
609.         <http://docutils.sourceforge.net/docs/howto/rst-directives.html>`_ .
610. 
611.         For example, the (already existing) :rst:dir:`literalinclude` directive
612.         would be added like this:
613. 
614.         .. code-block:: python
615. 
616.            from docutils.parsers.rst import Directive, directives
617. 
618.            class LiteralIncludeDirective(Directive):
619.                has_content = True
620.                required_arguments = 1
621.                optional_arguments = 0
622.                final_argument_whitespace = True
623.                option_spec = {
624.                    'class': directives.class_option,
625.                    'name': directives.unchanged,
626.                }
627. 
628.                def run(self):
629.                    ...
630. 
631.            add_directive('literalinclude', LiteralIncludeDirective)
632. 
633.         .. versionchanged:: 0.6
634.            Docutils 0.5-style directive classes are now supported.
635.         .. deprecated:: 1.8
636.            Docutils 0.4-style (function based) directives support is deprecated.
637.         .. versionchanged:: 1.8
638.            Add *override* keyword.
639.         """
640.         logger.debug('[app] adding directive: %r', (name, cls))
641.         if not override and docutils.is_directive_registered(name):
642.             logger.warning(__('directive %r is already registered, it will be overridden'),
643.                            name, type='app', subtype='add_directive')
644. 
645.         docutils.register_directive(name, cls)
646. 
647.     def add_role(self, name: str, role: Any, override: bool = False) -> None:
648.         """Register a Docutils role.
649. 
650.         *name* must be the role name that occurs in the source, *role* the role
651.         function. Refer to the `Docutils documentation
652.         <http://docutils.sourceforge.net/docs/howto/rst-roles.html>`_ for
653.         more information.
654. 
655.         .. versionchanged:: 1.8
656.            Add *override* keyword.
657.         """
658.         logger.debug('[app] adding role: %r', (name, role))
659.         if not override and docutils.is_role_registered(name):
660.             logger.warning(__('role %r is already registered, it will be overridden'),
661.                            name, type='app', subtype='add_role')
662.         docutils.register_role(name, role)
663. 
664.     def add_generic_role(self, name: str, nodeclass: Any, override: bool = False) -> None:
665.         """Register a generic Docutils role.
666. 
667.         Register a Docutils role that does nothing but wrap its contents in the
668.         node given by *nodeclass*.
669. 
670.         .. versionadded:: 0.6
671.         .. versionchanged:: 1.8
672.            Add *override* keyword.
673.         """
674.         # Don't use ``roles.register_generic_role`` because it uses
675.         # ``register_canonical_role``.
676.         logger.debug('[app] adding generic role: %r', (name, nodeclass))
677.         if not override and docutils.is_role_registered(name):
678.             logger.warning(__('role %r is already registered, it will be overridden'),
679.                            name, type='app', subtype='add_generic_role')
680.         role = roles.GenericRole(name, nodeclass)
681.         docutils.register_role(name, role)
682. 
683.     def add_domain(self, domain: "Type[Domain]", override: bool = False) -> None:
684.         """Register a domain.
685. 
686.         Make the given *domain* (which must be a class; more precisely, a
687.         subclass of :class:`~sphinx.domains.Domain`) known to Sphinx.
688. 
689.         .. versionadded:: 1.0
690.         .. versionchanged:: 1.8
691.            Add *override* keyword.
692.         """
693.         self.registry.add_domain(domain, override=override)
694. 
695.     def add_directive_to_domain(self, domain: str, name: str,
696.                                 cls: "Type[Directive]", override: bool = False) -> None:
697.         """Register a Docutils directive in a domain.
698. 
699.         Like :meth:`add_directive`, but the directive is added to the domain
700.         named *domain*.
701. 
702.         .. versionadded:: 1.0
703.         .. versionchanged:: 1.8
704.            Add *override* keyword.
705.         """
706.         self.registry.add_directive_to_domain(domain, name, cls, override=override)
707. 
708.     def add_role_to_domain(self, domain: str, name: str, role: Union[RoleFunction, XRefRole],
709.                            override: bool = False) -> None:
710.         """Register a Docutils role in a domain.
711. 
712.         Like :meth:`add_role`, but the role is added to the domain named
713.         *domain*.
714. 
715.         .. versionadded:: 1.0
716.         .. versionchanged:: 1.8
717.            Add *override* keyword.
718.         """
719.         self.registry.add_role_to_domain(domain, name, role, override=override)
720. 
721.     def add_index_to_domain(self, domain: str, index: "Type[Index]", override: bool = False
722.                             ) -> None:
723.         """Register a custom index for a domain.
724. 
725.         Add a custom *index* class to the domain named *domain*.  *index* must
726.         be a subclass of :class:`~sphinx.domains.Index`.
727. 
728.         .. versionadded:: 1.0
729.         .. versionchanged:: 1.8
730.            Add *override* keyword.
731.         """
732.         self.registry.add_index_to_domain(domain, index)
733. 
734.     def add_object_type(self, directivename: str, rolename: str, indextemplate: str = '',
735.                         parse_node: Callable = None, ref_nodeclass: "Type[TextElement]" = None,
736.                         objname: str = '', doc_field_types: List = [], override: bool = False
737.                         ) -> None:
738.         """Register a new object type.
739. 
740.         This method is a very convenient way to add a new :term:`object` type
741.         that can be cross-referenced.  It will do this:
742. 
743.         - Create a new directive (called *directivename*) for documenting an
744.           object.  It will automatically add index entries if *indextemplate*
745.           is nonempty; if given, it must contain exactly one instance of
746.           ``%s``.  See the example below for how the template will be
747.           interpreted.
748.         - Create a new role (called *rolename*) to cross-reference to these
749.           object descriptions.
750.         - If you provide *parse_node*, it must be a function that takes a
751.           string and a docutils node, and it must populate the node with
752.           children parsed from the string.  It must then return the name of the
753.           item to be used in cross-referencing and index entries.  See the
754.           :file:`conf.py` file in the source for this documentation for an
755.           example.
756.         - The *objname* (if not given, will default to *directivename*) names
757.           the type of object.  It is used when listing objects, e.g. in search
758.           results.
759. 
760.         For example, if you have this call in a custom Sphinx extension::
761. 
762.            app.add_object_type('directive', 'dir', 'pair: %s; directive')
763. 
764.         you can use this markup in your documents::
765. 
766.            .. rst:directive:: function
767. 
768.               Document a function.
769. 
770.            <...>
771. 
772.            See also the :rst:dir:`function` directive.
773. 
774.         For the directive, an index entry will be generated as if you had prepended ::
775. 
776.            .. index:: pair: function; directive
777. 
778.         The reference node will be of class ``literal`` (so it will be rendered
779.         in a proportional font, as appropriate for code) unless you give the
780.         *ref_nodeclass* argument, which must be a docutils node class.  Most
781.         useful are ``docutils.nodes.emphasis`` or ``docutils.nodes.strong`` --
782.         you can also use ``docutils.nodes.generated`` if you want no further
783.         text decoration.  If the text should be treated as literal (e.g. no
784.         smart quote replacement), but not have typewriter styling, use
785.         ``sphinx.addnodes.literal_emphasis`` or
786.         ``sphinx.addnodes.literal_strong``.
787. 
788.         For the role content, you have the same syntactical possibilities as
789.         for standard Sphinx roles (see :ref:`xref-syntax`).
790. 
791.         .. versionchanged:: 1.8
792.            Add *override* keyword.
793.         """
794.         self.registry.add_object_type(directivename, rolename, indextemplate, parse_node,
795.                                       ref_nodeclass, objname, doc_field_types,
796.                                       override=override)
797. 
798.     def add_crossref_type(self, directivename: str, rolename: str, indextemplate: str = '',
799.                           ref_nodeclass: "Type[TextElement]" = None, objname: str = '',
800.                           override: bool = False) -> None:
801.         """Register a new crossref object type.
802. 
803.         This method is very similar to :meth:`add_object_type` except that the
804.         directive it generates must be empty, and will produce no output.
805. 
806.         That means that you can add semantic targets to your sources, and refer
807.         to them using custom roles instead of generic ones (like
808.         :rst:role:`ref`).  Example call::
809. 
810.            app.add_crossref_type('topic', 'topic', 'single: %s',
811.                                  docutils.nodes.emphasis)
812. 
813.         Example usage::
814. 
815.            .. topic:: application API
816. 
817.            The application API
818.            -------------------
819. 
820.            Some random text here.
821. 
822.            See also :topic:`this section <application API>`.
823. 
824.         (Of course, the element following the ``topic`` directive needn't be a
825.         section.)
826. 
827.         .. versionchanged:: 1.8
828.            Add *override* keyword.
829.         """
830.         self.registry.add_crossref_type(directivename, rolename,
831.                                         indextemplate, ref_nodeclass, objname,
832.                                         override=override)
833. 
834.     def add_transform(self, transform: "Type[Transform]") -> None:
835.         """Register a Docutils transform to be applied after parsing.
836. 
837.         Add the standard docutils :class:`Transform` subclass *transform* to
838.         the list of transforms that are applied after Sphinx parses a reST
839.         document.
840. 
841.         .. list-table:: priority range categories for Sphinx transforms
842.            :widths: 20,80
843. 
844.            * - Priority
845.              - Main purpose in Sphinx
846.            * - 0-99
847.              - Fix invalid nodes by docutils. Translate a doctree.
848.            * - 100-299
849.              - Preparation
850.            * - 300-399
851.              - early
852.            * - 400-699
853.              - main
854.            * - 700-799
855.              - Post processing. Deadline to modify text and referencing.
856.            * - 800-899
857.              - Collect referencing and referenced nodes. Domain processing.
858.            * - 900-999
859.              - Finalize and clean up.
860. 
861.         refs: `Transform Priority Range Categories`__
862. 
863.         __ http://docutils.sourceforge.net/docs/ref/transforms.html#transform-priority-range-categories
864.         """  # NOQA
865.         self.registry.add_transform(transform)
866. 
867.     def add_post_transform(self, transform: "Type[Transform]") -> None:
868.         """Register a Docutils transform to be applied before writing.
869. 
870.         Add the standard docutils :class:`Transform` subclass *transform* to
871.         the list of transforms that are applied before Sphinx writes a
872.         document.
873.         """
874.         self.registry.add_post_transform(transform)
875. 
876.     def add_javascript(self, filename: str, **kwargs: str) -> None:
877.         """An alias of :meth:`add_js_file`."""
878.         warnings.warn('The app.add_javascript() is deprecated. '
879.                       'Please use app.add_js_file() instead.',
880.                       RemovedInSphinx40Warning, stacklevel=2)
881.         self.add_js_file(filename, **kwargs)
882. 
883.     def add_js_file(self, filename: str, **kwargs: str) -> None:
884.         """Register a JavaScript file to include in the HTML output.
885. 
886.         Add *filename* to the list of JavaScript files that the default HTML
887.         template will include.  The filename must be relative to the HTML
888.         static path , or a full URI with scheme.  If the keyword argument
889.         ``body`` is given, its value will be added between the
890.         ``<script>`` tags. Extra keyword arguments are included as
891.         attributes of the ``<script>`` tag.
892. 
893.         Example::
894. 
895.             app.add_js_file('example.js')
896.             # => <script src="_static/example.js"></script>
897. 
898.             app.add_js_file('example.js', async="async")
899.             # => <script src="_static/example.js" async="async"></script>
900. 
901.             app.add_js_file(None, body="var myVariable = 'foo';")
902.             # => <script>var myVariable = 'foo';</script>
903. 
904.         .. versionadded:: 0.5
905. 
906.         .. versionchanged:: 1.8
907.            Renamed from ``app.add_javascript()``.
908.            And it allows keyword arguments as attributes of script tag.
909.         """
910.         self.registry.add_js_file(filename, **kwargs)
911.         if hasattr(self.builder, 'add_js_file'):
912.             self.builder.add_js_file(filename, **kwargs)  # type: ignore
913. 
914.     def add_css_file(self, filename: str, **kwargs: str) -> None:
915.         """Register a stylesheet to include in the HTML output.
916. 
917.         Add *filename* to the list of CSS files that the default HTML template
918.         will include.  The filename must be relative to the HTML static path,
919.         or a full URI with scheme.  The keyword arguments are also accepted for
920.         attributes of ``<link>`` tag.
921. 
922.         Example::
923. 
924.             app.add_css_file('custom.css')
925.             # => <link rel="stylesheet" href="_static/custom.css" type="text/css" />
926. 
927.             app.add_css_file('print.css', media='print')
928.             # => <link rel="stylesheet" href="_static/print.css"
929.             #          type="text/css" media="print" />
930. 
931.             app.add_css_file('fancy.css', rel='alternate stylesheet', title='fancy')
932.             # => <link rel="alternate stylesheet" href="_static/fancy.css"
933.             #          type="text/css" title="fancy" />
934. 
935.         .. versionadded:: 1.0
936. 
937.         .. versionchanged:: 1.6
938.            Optional ``alternate`` and/or ``title`` attributes can be supplied
939.            with the *alternate* (of boolean type) and *title* (a string)
940.            arguments. The default is no title and *alternate* = ``False``. For
941.            more information, refer to the `documentation
942.            <https://mdn.io/Web/CSS/Alternative_style_sheets>`__.
943. 
944.         .. versionchanged:: 1.8
945.            Renamed from ``app.add_stylesheet()``.
946.            And it allows keyword arguments as attributes of link tag.
947.         """
948.         logger.debug('[app] adding stylesheet: %r', filename)
949.         self.registry.add_css_files(filename, **kwargs)
950.         if hasattr(self.builder, 'add_css_file'):
951.             self.builder.add_css_file(filename, **kwargs)  # type: ignore
952. 
953.     def add_stylesheet(self, filename: str, alternate: bool = False, title: str = None
954.                        ) -> None:
955.         """An alias of :meth:`add_css_file`."""
956.         warnings.warn('The app.add_stylesheet() is deprecated. '
957.                       'Please use app.add_css_file() instead.',
958.                       RemovedInSphinx40Warning, stacklevel=2)
959. 
960.         attributes = {}  # type: Dict[str, str]
961.         if alternate:
962.             attributes['rel'] = 'alternate stylesheet'
963.         else:
964.             attributes['rel'] = 'stylesheet'
965. 
966.         if title:
967.             attributes['title'] = title
968. 
969.         self.add_css_file(filename, **attributes)
970. 
971.     def add_latex_package(self, packagename: str, options: str = None,
972.                           after_hyperref: bool = False) -> None:
973.         r"""Register a package to include in the LaTeX source code.
974. 
975.         Add *packagename* to the list of packages that LaTeX source code will
976.         include.  If you provide *options*, it will be taken to `\usepackage`
977.         declaration.  If you set *after_hyperref* truthy, the package will be
978.         loaded after ``hyperref`` package.
979. 
980.         .. code-block:: python
981. 
982.            app.add_latex_package('mypackage')
983.            # => \usepackage{mypackage}
984.            app.add_latex_package('mypackage', 'foo,bar')
985.            # => \usepackage[foo,bar]{mypackage}
986. 
987.         .. versionadded:: 1.3
988.         .. versionadded:: 3.1
989. 
990.            *after_hyperref* option.
991.         """
992.         self.registry.add_latex_package(packagename, options, after_hyperref)
993. 
994.     def add_lexer(self, alias: str, lexer: Union[Lexer, "Type[Lexer]"]) -> None:
995.         """Register a new lexer for source code.
996. 
997.         Use *lexer* to highlight code blocks with the given language *alias*.
998. 
999.         .. versionadded:: 0.6
1000.         .. versionchanged:: 2.1
1001.            Take a lexer class as an argument.  An instance of lexers are
1002.            still supported until Sphinx-3.x.
1003.         """
1004.         logger.debug('[app] adding lexer: %r', (alias, lexer))
1005.         if isinstance(lexer, Lexer):
1006.             warnings.warn('app.add_lexer() API changed; '
1007.                           'Please give lexer class instead of instance',
1008.                           RemovedInSphinx40Warning, stacklevel=2)
1009.             lexers[alias] = lexer
1010.         else:
1011.             lexer_classes[alias] = lexer
1012. 
1013.     def add_autodocumenter(self, cls: Any, override: bool = False) -> None:
1014.         """Register a new documenter class for the autodoc extension.
1015. 
1016.         Add *cls* as a new documenter class for the :mod:`sphinx.ext.autodoc`
1017.         extension.  It must be a subclass of
1018.         :class:`sphinx.ext.autodoc.Documenter`.  This allows to auto-document
1019.         new types of objects.  See the source of the autodoc module for
1020.         examples on how to subclass :class:`Documenter`.
1021. 
1022.         .. todo:: Add real docs for Documenter and subclassing
1023. 
1024.         .. versionadded:: 0.6
1025.         .. versionchanged:: 2.2
1026.            Add *override* keyword.
1027.         """
1028.         logger.debug('[app] adding autodocumenter: %r', cls)
1029.         from sphinx.ext.autodoc.directive import AutodocDirective
1030.         self.registry.add_documenter(cls.objtype, cls)
1031.         self.add_directive('auto' + cls.objtype, AutodocDirective, override=override)
1032. 
1033.     def add_autodoc_attrgetter(self, typ: "Type", getter: Callable[[Any, str, Any], Any]
1034.                                ) -> None:
1035.         """Register a new ``getattr``-like function for the autodoc extension.
1036. 
1037.         Add *getter*, which must be a function with an interface compatible to
1038.         the :func:`getattr` builtin, as the autodoc attribute getter for
1039.         objects that are instances of *typ*.  All cases where autodoc needs to
1040.         get an attribute of a type are then handled by this function instead of
1041.         :func:`getattr`.
1042. 
1043.         .. versionadded:: 0.6
1044.         """
1045.         logger.debug('[app] adding autodoc attrgetter: %r', (typ, getter))
1046.         self.registry.add_autodoc_attrgetter(typ, getter)
1047. 
1048.     def add_search_language(self, cls: Any) -> None:
1049.         """Register a new language for the HTML search index.
1050. 
1051.         Add *cls*, which must be a subclass of
1052.         :class:`sphinx.search.SearchLanguage`, as a support language for
1053.         building the HTML full-text search index.  The class must have a *lang*
1054.         attribute that indicates the language it should be used for.  See
1055.         :confval:`html_search_language`.
1056. 
1057.         .. versionadded:: 1.1
1058.         """
1059.         logger.debug('[app] adding search language: %r', cls)
1060.         from sphinx.search import languages, SearchLanguage
1061.         assert issubclass(cls, SearchLanguage)
1062.         languages[cls.lang] = cls
1063. 
1064.     def add_source_suffix(self, suffix: str, filetype: str, override: bool = False) -> None:
1065.         """Register a suffix of source files.
1066. 
1067.         Same as :confval:`source_suffix`.  The users can override this
1068.         using the setting.
1069. 
1070.         .. versionadded:: 1.8
1071.         """
1072.         self.registry.add_source_suffix(suffix, filetype, override=override)
1073. 
1074.     def add_source_parser(self, *args: Any, **kwargs: Any) -> None:
1075.         """Register a parser class.
1076. 
1077.         .. versionadded:: 1.4
1078.         .. versionchanged:: 1.8
1079.            *suffix* argument is deprecated.  It only accepts *parser* argument.
1080.            Use :meth:`add_source_suffix` API to register suffix instead.
1081.         .. versionchanged:: 1.8
1082.            Add *override* keyword.
1083.         """
1084.         self.registry.add_source_parser(*args, **kwargs)
1085. 
1086.     def add_env_collector(self, collector: "Type[EnvironmentCollector]") -> None:
1087.         """Register an environment collector class.
1088. 
1089.         Refer to :ref:`collector-api`.
1090. 
1091.         .. versionadded:: 1.6
1092.         """
1093.         logger.debug('[app] adding environment collector: %r', collector)
1094.         collector().enable(self)
1095. 
1096.     def add_html_theme(self, name: str, theme_path: str) -> None:
1097.         """Register a HTML Theme.
1098. 
1099.         The *name* is a name of theme, and *path* is a full path to the theme
1100.         (refs: :ref:`distribute-your-theme`).
1101. 
1102.         .. versionadded:: 1.6
1103.         """
1104.         logger.debug('[app] adding HTML theme: %r, %r', name, theme_path)
1105.         self.html_themes[name] = theme_path
1106. 
1107.     def add_html_math_renderer(self, name: str,
1108.                                inline_renderers: Tuple[Callable, Callable] = None,
1109.                                block_renderers: Tuple[Callable, Callable] = None) -> None:
1110.         """Register a math renderer for HTML.
1111. 
1112.         The *name* is a name of math renderer.  Both *inline_renderers* and
1113.         *block_renderers* are used as visitor functions for the HTML writer:
1114.         the former for inline math node (``nodes.math``), the latter for
1115.         block math node (``nodes.math_block``).  Regarding visitor functions,
1116.         see :meth:`add_node` for details.
1117. 
1118.         .. versionadded:: 1.8
1119. 
1120.         """
1121.         self.registry.add_html_math_renderer(name, inline_renderers, block_renderers)
1122. 
1123.     def add_message_catalog(self, catalog: str, locale_dir: str) -> None:
1124.         """Register a message catalog.
1125. 
1126.         The *catalog* is a name of catalog, and *locale_dir* is a base path
1127.         of message catalog.  For more details, see
1128.         :func:`sphinx.locale.get_translation()`.
1129. 
1130.         .. versionadded:: 1.8
1131.         """
1132.         locale.init([locale_dir], self.config.language, catalog)
1133.         locale.init_console(locale_dir, catalog)
1134. 
1135.     # ---- other methods -------------------------------------------------
1136.     def is_parallel_allowed(self, typ: str) -> bool:
1137.         """Check parallel processing is allowed or not.
1138. 
1139.         ``typ`` is a type of processing; ``'read'`` or ``'write'``.
1140.         """
1141.         if typ == 'read':
1142.             attrname = 'parallel_read_safe'
1143.             message_not_declared = __("the %s extension does not declare if it "
1144.                                       "is safe for parallel reading, assuming "
1145.                                       "it isn't - please ask the extension author "
1146.                                       "to check and make it explicit")
1147.             message_not_safe = __("the %s extension is not safe for parallel reading")
1148.         elif typ == 'write':
1149.             attrname = 'parallel_write_safe'
1150.             message_not_declared = __("the %s extension does not declare if it "
1151.                                       "is safe for parallel writing, assuming "
1152.                                       "it isn't - please ask the extension author "
1153.                                       "to check and make it explicit")
1154.             message_not_safe = __("the %s extension is not safe for parallel writing")
1155.         else:
1156.             raise ValueError('parallel type %s is not supported' % typ)
1157. 
1158.         for ext in self.extensions.values():
1159.             allowed = getattr(ext, attrname, None)
1160.             if allowed is None:
1161.                 logger.warning(message_not_declared, ext.name)
1162.                 logger.warning(__('doing serial %s'), typ)
1163.                 return False
1164.             elif not allowed:
1165.                 logger.warning(message_not_safe, ext.name)
1166.                 logger.warning(__('doing serial %s'), typ)
1167.                 return False
1168. 
1169.         return True
1170. 
1171. 
1172. class TemplateBridge:
1173.     """
1174.     This class defines the interface for a "template bridge", that is, a class
1175.     that renders templates given a template name and a context.
1176.     """
1177. 
1178.     def init(self, builder: "Builder", theme: Theme = None, dirs: List[str] = None) -> None:
1179.         """Called by the builder to initialize the template system.
1180. 
1181.         *builder* is the builder object; you'll probably want to look at the
1182.         value of ``builder.config.templates_path``.
1183. 
1184.         *theme* is a :class:`sphinx.theming.Theme` object or None; in the latter
1185.         case, *dirs* can be list of fixed directories to look for templates.
1186.         """
1187.         raise NotImplementedError('must be implemented in subclasses')
1188. 
1189.     def newest_template_mtime(self) -> float:
1190.         """Called by the builder to determine if output files are outdated
1191.         because of template changes.  Return the mtime of the newest template
1192.         file that was changed.  The default implementation returns ``0``.
1193.         """
1194.         return 0
1195. 
1196.     def render(self, template: str, context: Dict) -> None:
1197.         """Called by the builder to render a template given as a filename with
1198.         a specified context (a Python dictionary).
1199.         """
1200.         raise NotImplementedError('must be implemented in subclasses')
1201. 
1202.     def render_string(self, template: str, context: Dict) -> str:
1203.         """Called by the builder to render a template given as a string with a
1204.         specified context (a Python dictionary).
1205.         """
1206.         raise NotImplementedError('must be implemented in subclasses')

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 10:50:41,930 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The user explicitly requested the full content of the file `sphinx/application.py`.\n\n2. Extended relevance:\n   - The provided context contains the content of the file `sphinx/application.py` from line 1 to 1206. This directly and completely fulfills the user's request.", relative_path='sphinx/application.py', start_line=1, end_line=1206)]
2025-12-23 10:50:41,933 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 1 contexts to memory for query: Please provide the full content of sphinx/application.py.
2025-12-23 10:50:41,934 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 10:50:41,934 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 10:50:41,934 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 1 new contexts to 0 existing contexts
2025-12-23 10:50:41,934 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 1 total contexts (removed 0 duplicates)
2025-12-23 10:50:41,935 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       └── main.yml
├── .travis.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── conftest.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   └── typing_test_data.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: locale/<language>/LC_MESSAGES/sphinx.po translation ignored

Description: **Describe the bug**
I read [1] as it should be possible to add a file ``locale/<language>/LC_MESSAGES/sphinx.mo`` to the source dir (same dir as the ``Makefile``) and through that change translations or add additional translation to <language>. 

When I add ``locale/da/LC_MESSAGES/sphinx.po``, with updated entries for ``Fig. %s`` and ``Listing %s``, a ``locale/da/LC_MESSAGES/sphinx.mo`` is created (because of ``gettext_auto_build = True``), but the translations are not used. The translations from the official ``da`` translation [2] is used. Of course ``language = 'da'`` is in ``conf.py``.

[1] http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-locale_dirs
[2] https://github.com/sphinx-doc/sphinx/blob/master/sphinx/locale/da/LC_MESSAGES/sphinx.po

**To Reproduce**
Steps to reproduce the behavior:
```
$ git clone https://github.com/jonascj/sphinx-test-locale-override.git
$ cd sphinx-test-locale-override
$ git checkout 8dea4cd # EDIT: current master showcases workaround, so revert back to see the bug
$ # make python venv however you like
$ pip install sphinx
$ make html
```
Notice that ``locale/da/LC_MESSAGES/sphinx.mo`` has been created. Open ``_build/html/index.html``. 

**Expected behavior**
The caption label for the figure ``figur 1`` should have been ``Foobar 1`` (for the sake of testing) and the caption label for the code block ``Viser 1`` should have been ``Whatever 1`` (again for the sake of testing).

**Your project**
https://github.com/jonascj/sphinx-test-locale-override.git

**Screenshots**
![Screenshot of index.html](https://yapb.in/exUE.png "Screenshot of index.html")

**Environment info**
- OS: Arch Linux 
- Python version: 3.7.3
- Sphinx version: 2.1.2
- Sphinx extensions:  none
- Extra tools: none


Patch information:
diff --git a/sphinx/application.py b/sphinx/application.py
index 385b74d8a..995efedd6 100644
--- a/sphinx/application.py
+++ b/sphinx/application.py
@@ -293,7 +293,8 @@ class Sphinx:
                 if catalog.domain == 'sphinx' and catalog.is_outdated():
                     catalog.write_mo(self.config.language)
 
-            locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
+            # Put user-provided locale directories first to ensure custom translations override official ones
+            locale_dirs = list(repo.locale_dirs) + [None, path.join(package_dir, 'locale')]
             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
             if has_translation or self.config.language == 'en':
                 # "en" never needs to be translated


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of sphinx/application.py.
Extra Requirements: 
Purpose: This file contains the core application logic and the code snippet mentioned in the issue, which is essential for understanding the problem.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: sphinx/application.py
Line number range: 1 - 1206
Content:
1. """
2.     sphinx.application
3.     ~~~~~~~~~~~~~~~~~~
4. 
5.     Sphinx application class and extensibility interface.
6. 
7.     Gracefully adapted from the TextPress system by Armin.
8. 
9.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
10.     :license: BSD, see LICENSE for details.
11. """
12. 
13. import os
14. import pickle
15. import platform
16. import sys
17. import warnings
18. from collections import deque
19. from io import StringIO
20. from os import path
21. from typing import Any, Callable, Dict, IO, List, Tuple, Union
22. 
23. from docutils import nodes
24. from docutils.nodes import Element, TextElement
25. from docutils.parsers.rst import Directive, roles
26. from docutils.transforms import Transform
27. from pygments.lexer import Lexer
28. 
29. import sphinx
30. from sphinx import package_dir, locale
31. from sphinx.config import Config
32. from sphinx.deprecation import RemovedInSphinx40Warning
33. from sphinx.domains import Domain, Index
34. from sphinx.environment import BuildEnvironment
35. from sphinx.environment.collectors import EnvironmentCollector
36. from sphinx.errors import ApplicationError, ConfigError, VersionRequirementError
37. from sphinx.events import EventManager
38. from sphinx.extension import Extension
39. from sphinx.highlighting import lexer_classes, lexers
40. from sphinx.locale import __
41. from sphinx.project import Project
42. from sphinx.registry import SphinxComponentRegistry
43. from sphinx.roles import XRefRole
44. from sphinx.theming import Theme
45. from sphinx.util import docutils
46. from sphinx.util import logging
47. from sphinx.util import progress_message
48. from sphinx.util.build_phase import BuildPhase
49. from sphinx.util.console import bold  # type: ignore
50. from sphinx.util.i18n import CatalogRepository
51. from sphinx.util.logging import prefixed_warnings
52. from sphinx.util.osutil import abspath, ensuredir, relpath
53. from sphinx.util.tags import Tags
54. from sphinx.util.typing import RoleFunction, TitleGetter
55. 
56. if False:
57.     # For type annotation
58.     from docutils.nodes import Node  # NOQA
59.     from typing import Type  # for python3.5.1
60.     from sphinx.builders import Builder
61. 
62. 
63. builtin_extensions = (
64.     'sphinx.addnodes',
65.     'sphinx.builders.changes',
66.     'sphinx.builders.epub3',
67.     'sphinx.builders.dirhtml',
68.     'sphinx.builders.dummy',
69.     'sphinx.builders.gettext',
70.     'sphinx.builders.html',
71.     'sphinx.builders.latex',
72.     'sphinx.builders.linkcheck',
73.     'sphinx.builders.manpage',
74.     'sphinx.builders.singlehtml',
75.     'sphinx.builders.texinfo',
76.     'sphinx.builders.text',
77.     'sphinx.builders.xml',
78.     'sphinx.config',
79.     'sphinx.domains.c',
80.     'sphinx.domains.changeset',
81.     'sphinx.domains.citation',
82.     'sphinx.domains.cpp',
83.     'sphinx.domains.index',
84.     'sphinx.domains.javascript',
85.     'sphinx.domains.math',
86.     'sphinx.domains.python',
87.     'sphinx.domains.rst',
88.     'sphinx.domains.std',
89.     'sphinx.directives',
90.     'sphinx.directives.code',
91.     'sphinx.directives.other',
92.     'sphinx.directives.patches',
93.     'sphinx.extension',
94.     'sphinx.parsers',
95.     'sphinx.registry',
96.     'sphinx.roles',
97.     'sphinx.transforms',
98.     'sphinx.transforms.compact_bullet_list',
99.     'sphinx.transforms.i18n',
100.     'sphinx.transforms.references',
101.     'sphinx.transforms.post_transforms',
102.     'sphinx.transforms.post_transforms.code',
103.     'sphinx.transforms.post_transforms.images',
104.     'sphinx.util.compat',
105.     'sphinx.versioning',
106.     # collectors should be loaded by specific order
107.     'sphinx.environment.collectors.dependencies',
108.     'sphinx.environment.collectors.asset',
109.     'sphinx.environment.collectors.metadata',
110.     'sphinx.environment.collectors.title',
111.     'sphinx.environment.collectors.toctree',
112.     # 1st party extensions
113.     'sphinxcontrib.applehelp',
114.     'sphinxcontrib.devhelp',
115.     'sphinxcontrib.htmlhelp',
116.     'sphinxcontrib.serializinghtml',
117.     'sphinxcontrib.qthelp',
118.     # Strictly, alabaster theme is not a builtin extension,
119.     # but it is loaded automatically to use it as default theme.
120.     'alabaster',
121. )
122. 
123. ENV_PICKLE_FILENAME = 'environment.pickle'
124. 
125. logger = logging.getLogger(__name__)
126. 
127. 
128. class Sphinx:
129.     """The main application class and extensibility interface.
130. 
131.     :ivar srcdir: Directory containing source.
132.     :ivar confdir: Directory containing ``conf.py``.
133.     :ivar doctreedir: Directory for storing pickled doctrees.
134.     :ivar outdir: Directory for storing build documents.
135.     """
136. 
137.     def __init__(self, srcdir: str, confdir: str, outdir: str, doctreedir: str,
138.                  buildername: str, confoverrides: Dict = None,
139.                  status: IO = sys.stdout, warning: IO = sys.stderr,
140.                  freshenv: bool = False, warningiserror: bool = False, tags: List[str] = None,
141.                  verbosity: int = 0, parallel: int = 0, keep_going: bool = False) -> None:
142.         self.phase = BuildPhase.INITIALIZATION
143.         self.verbosity = verbosity
144.         self.extensions = {}                    # type: Dict[str, Extension]
145.         self.builder = None                     # type: Builder
146.         self.env = None                         # type: BuildEnvironment
147.         self.project = None                     # type: Project
148.         self.registry = SphinxComponentRegistry()
149.         self.html_themes = {}                   # type: Dict[str, str]
150. 
151.         # validate provided directories
152.         self.srcdir = abspath(srcdir)
153.         self.outdir = abspath(outdir)
154.         self.doctreedir = abspath(doctreedir)
155.         self.confdir = confdir
156.         if self.confdir:  # confdir is optional
157.             self.confdir = abspath(self.confdir)
158.             if not path.isfile(path.join(self.confdir, 'conf.py')):
159.                 raise ApplicationError(__("config directory doesn't contain a "
160.                                           "conf.py file (%s)") % confdir)
161. 
162.         if not path.isdir(self.srcdir):
163.             raise ApplicationError(__('Cannot find source directory (%s)') %
164.                                    self.srcdir)
165. 
166.         if path.exists(self.outdir) and not path.isdir(self.outdir):
167.             raise ApplicationError(__('Output directory (%s) is not a directory') %
168.                                    self.outdir)
169. 
170.         if self.srcdir == self.outdir:
171.             raise ApplicationError(__('Source directory and destination '
172.                                       'directory cannot be identical'))
173. 
174.         self.parallel = parallel
175. 
176.         if status is None:
177.             self._status = StringIO()      # type: IO
178.             self.quiet = True
179.         else:
180.             self._status = status
181.             self.quiet = False
182. 
183.         if warning is None:
184.             self._warning = StringIO()     # type: IO
185.         else:
186.             self._warning = warning
187.         self._warncount = 0
188.         self.keep_going = warningiserror and keep_going
189.         if self.keep_going:
190.             self.warningiserror = False
191.         else:
192.             self.warningiserror = warningiserror
193.         logging.setup(self, self._status, self._warning)
194. 
195.         self.events = EventManager(self)
196. 
197.         # keep last few messages for traceback
198.         # This will be filled by sphinx.util.logging.LastMessagesWriter
199.         self.messagelog = deque(maxlen=10)  # type: deque
200. 
201.         # say hello to the world
202.         logger.info(bold(__('Running Sphinx v%s') % sphinx.__display_version__))
203. 
204.         # notice for parallel build on macOS and py38+
205.         if sys.version_info > (3, 8) and platform.system() == 'Darwin' and parallel > 1:
206.             logger.info(bold(__("For security reason, parallel mode is disabled on macOS and "
207.                                 "python3.8 and above. For more details, please read "
208.                                 "https://github.com/sphinx-doc/sphinx/issues/6803")))
209. 
210.         # status code for command-line application
211.         self.statuscode = 0
212. 
213.         # read config
214.         self.tags = Tags(tags)
215.         if self.confdir is None:
216.             self.config = Config({}, confoverrides or {})
217.         else:
218.             self.config = Config.read(self.confdir, confoverrides or {}, self.tags)
219. 
220.         # initialize some limited config variables before initialize i18n and loading
221.         # extensions
222.         self.config.pre_init_values()
223. 
224.         # set up translation infrastructure
225.         self._init_i18n()
226. 
227.         # check the Sphinx version if requested
228.         if self.config.needs_sphinx and self.config.needs_sphinx > sphinx.__display_version__:
229.             raise VersionRequirementError(
230.                 __('This project needs at least Sphinx v%s and therefore cannot '
231.                    'be built with this version.') % self.config.needs_sphinx)
232. 
233.         # set confdir to srcdir if -C given (!= no confdir); a few pieces
234.         # of code expect a confdir to be set
235.         if self.confdir is None:
236.             self.confdir = self.srcdir
237. 
238.         # load all built-in extension modules
239.         for extension in builtin_extensions:
240.             self.setup_extension(extension)
241. 
242.         # load all user-given extension modules
243.         for extension in self.config.extensions:
244.             self.setup_extension(extension)
245. 
246.         # preload builder module (before init config values)
247.         self.preload_builder(buildername)
248. 
249.         if not path.isdir(outdir):
250.             with progress_message(__('making output directory')):
251.                 ensuredir(outdir)
252. 
253.         # the config file itself can be an extension
254.         if self.config.setup:
255.             prefix = __('while setting up extension %s:') % "conf.py"
256.             with prefixed_warnings(prefix):
257.                 if callable(self.config.setup):
258.                     self.config.setup(self)
259.                 else:
260.                     raise ConfigError(
261.                         __("'setup' as currently defined in conf.py isn't a Python callable. "
262.                            "Please modify its definition to make it a callable function. "
263.                            "This is needed for conf.py to behave as a Sphinx extension.")
264.                     )
265. 
266.         # now that we know all config values, collect them from conf.py
267.         self.config.init_values()
268.         self.events.emit('config-inited', self.config)
269. 
270.         # create the project
271.         self.project = Project(self.srcdir, self.config.source_suffix)
272.         # create the builder
273.         self.builder = self.create_builder(buildername)
274.         # set up the build environment
275.         self._init_env(freshenv)
276.         # set up the builder
277.         self._init_builder()
278. 
279.     def _init_i18n(self) -> None:
280.         """Load translated strings from the configured localedirs if enabled in
281.         the configuration.
282.         """
283.         if self.config.language is None:
284.             self.translator, has_translation = locale.init([], None)
285.         else:
286.             logger.info(bold(__('loading translations [%s]... ') % self.config.language),
287.                         nonl=True)
288. 
289.             # compile mo files if sphinx.po file in user locale directories are updated
290.             repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
291.                                      self.config.language, self.config.source_encoding)
292.             for catalog in repo.catalogs:
293.                 if catalog.domain == 'sphinx' and catalog.is_outdated():
294.                     catalog.write_mo(self.config.language)
295. 
296.             locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
297.             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
298.             if has_translation or self.config.language == 'en':
299.                 # "en" never needs to be translated
300.                 logger.info(__('done'))
301.             else:
302.                 logger.info(__('not available for built-in messages'))
303. 
304.     def _init_env(self, freshenv: bool) -> None:
305.         filename = path.join(self.doctreedir, ENV_PICKLE_FILENAME)
306.         if freshenv or not os.path.exists(filename):
307.             self.env = BuildEnvironment()
308.             self.env.setup(self)
309.             self.env.find_files(self.config, self.builder)
310.         else:
311.             try:
312.                 with progress_message(__('loading pickled environment')):
313.                     with open(filename, 'rb') as f:
314.                         self.env = pickle.load(f)
315.                         self.env.setup(self)
316.             except Exception as err:
317.                 logger.info(__('failed: %s'), err)
318.                 self._init_env(freshenv=True)
319. 
320.     def preload_builder(self, name: str) -> None:
321.         self.registry.preload_builder(self, name)
322. 
323.     def create_builder(self, name: str) -> "Builder":
324.         if name is None:
325.             logger.info(__('No builder selected, using default: html'))
326.             name = 'html'
327. 
328.         return self.registry.create_builder(self, name)
329. 
330.     def _init_builder(self) -> None:
331.         self.builder.set_environment(self.env)
332.         self.builder.init()
333.         self.events.emit('builder-inited')
334. 
335.     # ---- main "build" method -------------------------------------------------
336. 
337.     def build(self, force_all: bool = False, filenames: List[str] = None) -> None:
338.         self.phase = BuildPhase.READING
339.         try:
340.             if force_all:
341.                 self.builder.compile_all_catalogs()
342.                 self.builder.build_all()
343.             elif filenames:
344.                 self.builder.compile_specific_catalogs(filenames)
345.                 self.builder.build_specific(filenames)
346.             else:
347.                 self.builder.compile_update_catalogs()
348.                 self.builder.build_update()
349. 
350.             if self._warncount and self.keep_going:
351.                 self.statuscode = 1
352. 
353.             status = (__('succeeded') if self.statuscode == 0
354.                       else __('finished with problems'))
355.             if self._warncount:
356.                 if self.warningiserror:
357.                     if self._warncount == 1:
358.                         msg = __('build %s, %s warning (with warnings treated as errors).')
359.                     else:
360.                         msg = __('build %s, %s warnings (with warnings treated as errors).')
361.                 else:
362.                     if self._warncount == 1:
363.                         msg = __('build %s, %s warning.')
364.                     else:
365.                         msg = __('build %s, %s warnings.')
366. 
367.                 logger.info(bold(msg % (status, self._warncount)))
368.             else:
369.                 logger.info(bold(__('build %s.') % status))
370. 
371.             if self.statuscode == 0 and self.builder.epilog:
372.                 logger.info('')
373.                 logger.info(self.builder.epilog % {
374.                     'outdir': relpath(self.outdir),
375.                     'project': self.config.project
376.                 })
377.         except Exception as err:
378.             # delete the saved env to force a fresh build next time
379.             envfile = path.join(self.doctreedir, ENV_PICKLE_FILENAME)
380.             if path.isfile(envfile):
381.                 os.unlink(envfile)
382.             self.events.emit('build-finished', err)
383.             raise
384.         else:
385.             self.events.emit('build-finished', None)
386.         self.builder.cleanup()
387. 
388.     # ---- general extensibility interface -------------------------------------
389. 
390.     def setup_extension(self, extname: str) -> None:
391.         """Import and setup a Sphinx extension module.
392. 
393.         Load the extension given by the module *name*.  Use this if your
394.         extension needs the features provided by another extension.  No-op if
395.         called twice.
396.         """
397.         logger.debug('[app] setting up extension: %r', extname)
398.         self.registry.load_extension(self, extname)
399. 
400.     def require_sphinx(self, version: str) -> None:
401.         """Check the Sphinx version if requested.
402. 
403.         Compare *version* (which must be a ``major.minor`` version string, e.g.
404.         ``'1.1'``) with the version of the running Sphinx, and abort the build
405.         when it is too old.
406. 
407.         .. versionadded:: 1.0
408.         """
409.         if version > sphinx.__display_version__[:3]:
410.             raise VersionRequirementError(version)
411. 
412.     # event interface
413.     def connect(self, event: str, callback: Callable, priority: int = 500) -> int:
414.         """Register *callback* to be called when *event* is emitted.
415. 
416.         For details on available core events and the arguments of callback
417.         functions, please see :ref:`events`.
418. 
419.         Registered callbacks will be invoked on event in the order of *priority* and
420.         registration.  The priority is ascending order.
421. 
422.         The method returns a "listener ID" that can be used as an argument to
423.         :meth:`disconnect`.
424. 
425.         .. versionchanged:: 3.0
426. 
427.            Support *priority*
428.         """
429.         listener_id = self.events.connect(event, callback, priority)
430.         logger.debug('[app] connecting event %r (%d): %r [id=%s]',
431.                      event, priority, callback, listener_id)
432.         return listener_id
433. 
434.     def disconnect(self, listener_id: int) -> None:
435.         """Unregister callback by *listener_id*."""
436.         logger.debug('[app] disconnecting event: [id=%s]', listener_id)
437.         self.events.disconnect(listener_id)
438. 
439.     def emit(self, event: str, *args: Any,
440.              allowed_exceptions: Tuple["Type[Exception]", ...] = ()) -> List:
441.         """Emit *event* and pass *arguments* to the callback functions.
442. 
443.         Return the return values of all callbacks as a list.  Do not emit core
444.         Sphinx events in extensions!
445. 
446.         .. versionchanged:: 3.1
447. 
448.            Added *allowed_exceptions* to specify path-through exceptions
449.         """
450.         return self.events.emit(event, *args, allowed_exceptions=allowed_exceptions)
451. 
452.     def emit_firstresult(self, event: str, *args: Any,
453.                          allowed_exceptions: Tuple["Type[Exception]", ...] = ()) -> Any:
454.         """Emit *event* and pass *arguments* to the callback functions.
455. 
456.         Return the result of the first callback that doesn't return ``None``.
457. 
458.         .. versionadded:: 0.5
459.         .. versionchanged:: 3.1
460. 
461.            Added *allowed_exceptions* to specify path-through exceptions
462.         """
463.         return self.events.emit_firstresult(event, *args,
464.                                             allowed_exceptions=allowed_exceptions)
465. 
466.     # registering addon parts
467. 
468.     def add_builder(self, builder: "Type[Builder]", override: bool = False) -> None:
469.         """Register a new builder.
470. 
471.         *builder* must be a class that inherits from
472.         :class:`~sphinx.builders.Builder`.
473. 
474.         .. versionchanged:: 1.8
475.            Add *override* keyword.
476.         """
477.         self.registry.add_builder(builder, override=override)
478. 
479.     # TODO(stephenfin): Describe 'types' parameter
480.     def add_config_value(self, name: str, default: Any, rebuild: Union[bool, str],
481.                          types: Any = ()) -> None:
482.         """Register a configuration value.
483. 
484.         This is necessary for Sphinx to recognize new values and set default
485.         values accordingly.  The *name* should be prefixed with the extension
486.         name, to avoid clashes.  The *default* value can be any Python object.
487.         The string value *rebuild* must be one of those values:
488. 
489.         * ``'env'`` if a change in the setting only takes effect when a
490.           document is parsed -- this means that the whole environment must be
491.           rebuilt.
492.         * ``'html'`` if a change in the setting needs a full rebuild of HTML
493.           documents.
494.         * ``''`` if a change in the setting will not need any special rebuild.
495. 
496.         .. versionchanged:: 0.6
497.            Changed *rebuild* from a simple boolean (equivalent to ``''`` or
498.            ``'env'``) to a string.  However, booleans are still accepted and
499.            converted internally.
500. 
501.         .. versionchanged:: 0.4
502.            If the *default* value is a callable, it will be called with the
503.            config object as its argument in order to get the default value.
504.            This can be used to implement config values whose default depends on
505.            other values.
506.         """
507.         logger.debug('[app] adding config value: %r',
508.                      (name, default, rebuild) + ((types,) if types else ()))
509.         if rebuild in (False, True):
510.             rebuild = 'env' if rebuild else ''
511.         self.config.add(name, default, rebuild, types)
512. 
513.     def add_event(self, name: str) -> None:
514.         """Register an event called *name*.
515. 
516.         This is needed to be able to emit it.
517.         """
518.         logger.debug('[app] adding event: %r', name)
519.         self.events.add(name)
520. 
521.     def set_translator(self, name: str, translator_class: "Type[nodes.NodeVisitor]",
522.                        override: bool = False) -> None:
523.         """Register or override a Docutils translator class.
524. 
525.         This is used to register a custom output translator or to replace a
526.         builtin translator.  This allows extensions to use custom translator
527.         and define custom nodes for the translator (see :meth:`add_node`).
528. 
529.         .. versionadded:: 1.3
530.         .. versionchanged:: 1.8
531.            Add *override* keyword.
532.         """
533.         self.registry.add_translator(name, translator_class, override=override)
534. 
535.     def add_node(self, node: "Type[Element]", override: bool = False,
536.                  **kwargs: Tuple[Callable, Callable]) -> None:
537.         """Register a Docutils node class.
538. 
539.         This is necessary for Docutils internals.  It may also be used in the
540.         future to validate nodes in the parsed documents.
541. 
542.         Node visitor functions for the Sphinx HTML, LaTeX, text and manpage
543.         writers can be given as keyword arguments: the keyword should be one or
544.         more of ``'html'``, ``'latex'``, ``'text'``, ``'man'``, ``'texinfo'``
545.         or any other supported translators, the value a 2-tuple of ``(visit,
546.         depart)`` methods.  ``depart`` can be ``None`` if the ``visit``
547.         function raises :exc:`docutils.nodes.SkipNode`.  Example:
548. 
549.         .. code-block:: python
550. 
551.            class math(docutils.nodes.Element): pass
552. 
553.            def visit_math_html(self, node):
554.                self.body.append(self.starttag(node, 'math'))
555.            def depart_math_html(self, node):
556.                self.body.append('</math>')
557. 
558.            app.add_node(math, html=(visit_math_html, depart_math_html))
559. 
560.         Obviously, translators for which you don't specify visitor methods will
561.         choke on the node when encountered in a document to translate.
562. 
563.         .. versionchanged:: 0.5
564.            Added the support for keyword arguments giving visit functions.
565.         """
566.         logger.debug('[app] adding node: %r', (node, kwargs))
567.         if not override and docutils.is_node_registered(node):
568.             logger.warning(__('node class %r is already registered, '
569.                               'its visitors will be overridden'),
570.                            node.__name__, type='app', subtype='add_node')
571.         docutils.register_node(node)
572.         self.registry.add_translation_handlers(node, **kwargs)
573. 
574.     def add_enumerable_node(self, node: "Type[Element]", figtype: str,
575.                             title_getter: TitleGetter = None, override: bool = False,
576.                             **kwargs: Tuple[Callable, Callable]) -> None:
577.         """Register a Docutils node class as a numfig target.
578. 
579.         Sphinx numbers the node automatically. And then the users can refer it
580.         using :rst:role:`numref`.
581. 
582.         *figtype* is a type of enumerable nodes.  Each figtypes have individual
583.         numbering sequences.  As a system figtypes, ``figure``, ``table`` and
584.         ``code-block`` are defined.  It is able to add custom nodes to these
585.         default figtypes.  It is also able to define new custom figtype if new
586.         figtype is given.
587. 
588.         *title_getter* is a getter function to obtain the title of node.  It
589.         takes an instance of the enumerable node, and it must return its title
590.         as string.  The title is used to the default title of references for
591.         :rst:role:`ref`.  By default, Sphinx searches
592.         ``docutils.nodes.caption`` or ``docutils.nodes.title`` from the node as
593.         a title.
594. 
595.         Other keyword arguments are used for node visitor functions. See the
596.         :meth:`.Sphinx.add_node` for details.
597. 
598.         .. versionadded:: 1.4
599.         """
600.         self.registry.add_enumerable_node(node, figtype, title_getter, override=override)
601.         self.add_node(node, override=override, **kwargs)
602. 
603.     def add_directive(self, name: str, cls: "Type[Directive]", override: bool = False) -> None:
604.         """Register a Docutils directive.
605. 
606.         *name* must be the prospective directive name.  *cls* is a directive
607.         class which inherits ``docutils.parsers.rst.Directive``.  For more
608.         details, see `the Docutils docs
609.         <http://docutils.sourceforge.net/docs/howto/rst-directives.html>`_ .
610. 
611.         For example, the (already existing) :rst:dir:`literalinclude` directive
612.         would be added like this:
613. 
614.         .. code-block:: python
615. 
616.            from docutils.parsers.rst import Directive, directives
617. 
618.            class LiteralIncludeDirective(Directive):
619.                has_content = True
620.                required_arguments = 1
621.                optional_arguments = 0
622.                final_argument_whitespace = True
623.                option_spec = {
624.                    'class': directives.class_option,
625.                    'name': directives.unchanged,
626.                }
627. 
628.                def run(self):
629.                    ...
630. 
631.            add_directive('literalinclude', LiteralIncludeDirective)
632. 
633.         .. versionchanged:: 0.6
634.            Docutils 0.5-style directive classes are now supported.
635.         .. deprecated:: 1.8
636.            Docutils 0.4-style (function based) directives support is deprecated.
637.         .. versionchanged:: 1.8
638.            Add *override* keyword.
639.         """
640.         logger.debug('[app] adding directive: %r', (name, cls))
641.         if not override and docutils.is_directive_registered(name):
642.             logger.warning(__('directive %r is already registered, it will be overridden'),
643.                            name, type='app', subtype='add_directive')
644. 
645.         docutils.register_directive(name, cls)
646. 
647.     def add_role(self, name: str, role: Any, override: bool = False) -> None:
648.         """Register a Docutils role.
649. 
650.         *name* must be the role name that occurs in the source, *role* the role
651.         function. Refer to the `Docutils documentation
652.         <http://docutils.sourceforge.net/docs/howto/rst-roles.html>`_ for
653.         more information.
654. 
655.         .. versionchanged:: 1.8
656.            Add *override* keyword.
657.         """
658.         logger.debug('[app] adding role: %r', (name, role))
659.         if not override and docutils.is_role_registered(name):
660.             logger.warning(__('role %r is already registered, it will be overridden'),
661.                            name, type='app', subtype='add_role')
662.         docutils.register_role(name, role)
663. 
664.     def add_generic_role(self, name: str, nodeclass: Any, override: bool = False) -> None:
665.         """Register a generic Docutils role.
666. 
667.         Register a Docutils role that does nothing but wrap its contents in the
668.         node given by *nodeclass*.
669. 
670.         .. versionadded:: 0.6
671.         .. versionchanged:: 1.8
672.            Add *override* keyword.
673.         """
674.         # Don't use ``roles.register_generic_role`` because it uses
675.         # ``register_canonical_role``.
676.         logger.debug('[app] adding generic role: %r', (name, nodeclass))
677.         if not override and docutils.is_role_registered(name):
678.             logger.warning(__('role %r is already registered, it will be overridden'),
679.                            name, type='app', subtype='add_generic_role')
680.         role = roles.GenericRole(name, nodeclass)
681.         docutils.register_role(name, role)
682. 
683.     def add_domain(self, domain: "Type[Domain]", override: bool = False) -> None:
684.         """Register a domain.
685. 
686.         Make the given *domain* (which must be a class; more precisely, a
687.         subclass of :class:`~sphinx.domains.Domain`) known to Sphinx.
688. 
689.         .. versionadded:: 1.0
690.         .. versionchanged:: 1.8
691.            Add *override* keyword.
692.         """
693.         self.registry.add_domain(domain, override=override)
694. 
695.     def add_directive_to_domain(self, domain: str, name: str,
696.                                 cls: "Type[Directive]", override: bool = False) -> None:
697.         """Register a Docutils directive in a domain.
698. 
699.         Like :meth:`add_directive`, but the directive is added to the domain
700.         named *domain*.
701. 
702.         .. versionadded:: 1.0
703.         .. versionchanged:: 1.8
704.            Add *override* keyword.
705.         """
706.         self.registry.add_directive_to_domain(domain, name, cls, override=override)
707. 
708.     def add_role_to_domain(self, domain: str, name: str, role: Union[RoleFunction, XRefRole],
709.                            override: bool = False) -> None:
710.         """Register a Docutils role in a domain.
711. 
712.         Like :meth:`add_role`, but the role is added to the domain named
713.         *domain*.
714. 
715.         .. versionadded:: 1.0
716.         .. versionchanged:: 1.8
717.            Add *override* keyword.
718.         """
719.         self.registry.add_role_to_domain(domain, name, role, override=override)
720. 
721.     def add_index_to_domain(self, domain: str, index: "Type[Index]", override: bool = False
722.                             ) -> None:
723.         """Register a custom index for a domain.
724. 
725.         Add a custom *index* class to the domain named *domain*.  *index* must
726.         be a subclass of :class:`~sphinx.domains.Index`.
727. 
728.         .. versionadded:: 1.0
729.         .. versionchanged:: 1.8
730.            Add *override* keyword.
731.         """
732.         self.registry.add_index_to_domain(domain, index)
733. 
734.     def add_object_type(self, directivename: str, rolename: str, indextemplate: str = '',
735.                         parse_node: Callable = None, ref_nodeclass: "Type[TextElement]" = None,
736.                         objname: str = '', doc_field_types: List = [], override: bool = False
737.                         ) -> None:
738.         """Register a new object type.
739. 
740.         This method is a very convenient way to add a new :term:`object` type
741.         that can be cross-referenced.  It will do this:
742. 
743.         - Create a new directive (called *directivename*) for documenting an
744.           object.  It will automatically add index entries if *indextemplate*
745.           is nonempty; if given, it must contain exactly one instance of
746.           ``%s``.  See the example below for how the template will be
747.           interpreted.
748.         - Create a new role (called *rolename*) to cross-reference to these
749.           object descriptions.
750.         - If you provide *parse_node*, it must be a function that takes a
751.           string and a docutils node, and it must populate the node with
752.           children parsed from the string.  It must then return the name of the
753.           item to be used in cross-referencing and index entries.  See the
754.           :file:`conf.py` file in the source for this documentation for an
755.           example.
756.         - The *objname* (if not given, will default to *directivename*) names
757.           the type of object.  It is used when listing objects, e.g. in search
758.           results.
759. 
760.         For example, if you have this call in a custom Sphinx extension::
761. 
762.            app.add_object_type('directive', 'dir', 'pair: %s; directive')
763. 
764.         you can use this markup in your documents::
765. 
766.            .. rst:directive:: function
767. 
768.               Document a function.
769. 
770.            <...>
771. 
772.            See also the :rst:dir:`function` directive.
773. 
774.         For the directive, an index entry will be generated as if you had prepended ::
775. 
776.            .. index:: pair: function; directive
777. 
778.         The reference node will be of class ``literal`` (so it will be rendered
779.         in a proportional font, as appropriate for code) unless you give the
780.         *ref_nodeclass* argument, which must be a docutils node class.  Most
781.         useful are ``docutils.nodes.emphasis`` or ``docutils.nodes.strong`` --
782.         you can also use ``docutils.nodes.generated`` if you want no further
783.         text decoration.  If the text should be treated as literal (e.g. no
784.         smart quote replacement), but not have typewriter styling, use
785.         ``sphinx.addnodes.literal_emphasis`` or
786.         ``sphinx.addnodes.literal_strong``.
787. 
788.         For the role content, you have the same syntactical possibilities as
789.         for standard Sphinx roles (see :ref:`xref-syntax`).
790. 
791.         .. versionchanged:: 1.8
792.            Add *override* keyword.
793.         """
794.         self.registry.add_object_type(directivename, rolename, indextemplate, parse_node,
795.                                       ref_nodeclass, objname, doc_field_types,
796.                                       override=override)
797. 
798.     def add_crossref_type(self, directivename: str, rolename: str, indextemplate: str = '',
799.                           ref_nodeclass: "Type[TextElement]" = None, objname: str = '',
800.                           override: bool = False) -> None:
801.         """Register a new crossref object type.
802. 
803.         This method is very similar to :meth:`add_object_type` except that the
804.         directive it generates must be empty, and will produce no output.
805. 
806.         That means that you can add semantic targets to your sources, and refer
807.         to them using custom roles instead of generic ones (like
808.         :rst:role:`ref`).  Example call::
809. 
810.            app.add_crossref_type('topic', 'topic', 'single: %s',
811.                                  docutils.nodes.emphasis)
812. 
813.         Example usage::
814. 
815.            .. topic:: application API
816. 
817.            The application API
818.            -------------------
819. 
820.            Some random text here.
821. 
822.            See also :topic:`this section <application API>`.
823. 
824.         (Of course, the element following the ``topic`` directive needn't be a
825.         section.)
826. 
827.         .. versionchanged:: 1.8
828.            Add *override* keyword.
829.         """
830.         self.registry.add_crossref_type(directivename, rolename,
831.                                         indextemplate, ref_nodeclass, objname,
832.                                         override=override)
833. 
834.     def add_transform(self, transform: "Type[Transform]") -> None:
835.         """Register a Docutils transform to be applied after parsing.
836. 
837.         Add the standard docutils :class:`Transform` subclass *transform* to
838.         the list of transforms that are applied after Sphinx parses a reST
839.         document.
840. 
841.         .. list-table:: priority range categories for Sphinx transforms
842.            :widths: 20,80
843. 
844.            * - Priority
845.              - Main purpose in Sphinx
846.            * - 0-99
847.              - Fix invalid nodes by docutils. Translate a doctree.
848.            * - 100-299
849.              - Preparation
850.            * - 300-399
851.              - early
852.            * - 400-699
853.              - main
854.            * - 700-799
855.              - Post processing. Deadline to modify text and referencing.
856.            * - 800-899
857.              - Collect referencing and referenced nodes. Domain processing.
858.            * - 900-999
859.              - Finalize and clean up.
860. 
861.         refs: `Transform Priority Range Categories`__
862. 
863.         __ http://docutils.sourceforge.net/docs/ref/transforms.html#transform-priority-range-categories
864.         """  # NOQA
865.         self.registry.add_transform(transform)
866. 
867.     def add_post_transform(self, transform: "Type[Transform]") -> None:
868.         """Register a Docutils transform to be applied before writing.
869. 
870.         Add the standard docutils :class:`Transform` subclass *transform* to
871.         the list of transforms that are applied before Sphinx writes a
872.         document.
873.         """
874.         self.registry.add_post_transform(transform)
875. 
876.     def add_javascript(self, filename: str, **kwargs: str) -> None:
877.         """An alias of :meth:`add_js_file`."""
878.         warnings.warn('The app.add_javascript() is deprecated. '
879.                       'Please use app.add_js_file() instead.',
880.                       RemovedInSphinx40Warning, stacklevel=2)
881.         self.add_js_file(filename, **kwargs)
882. 
883.     def add_js_file(self, filename: str, **kwargs: str) -> None:
884.         """Register a JavaScript file to include in the HTML output.
885. 
886.         Add *filename* to the list of JavaScript files that the default HTML
887.         template will include.  The filename must be relative to the HTML
888.         static path , or a full URI with scheme.  If the keyword argument
889.         ``body`` is given, its value will be added between the
890.         ``<script>`` tags. Extra keyword arguments are included as
891.         attributes of the ``<script>`` tag.
892. 
893.         Example::
894. 
895.             app.add_js_file('example.js')
896.             # => <script src="_static/example.js"></script>
897. 
898.             app.add_js_file('example.js', async="async")
899.             # => <script src="_static/example.js" async="async"></script>
900. 
901.             app.add_js_file(None, body="var myVariable = 'foo';")
902.             # => <script>var myVariable = 'foo';</script>
903. 
904.         .. versionadded:: 0.5
905. 
906.         .. versionchanged:: 1.8
907.            Renamed from ``app.add_javascript()``.
908.            And it allows keyword arguments as attributes of script tag.
909.         """
910.         self.registry.add_js_file(filename, **kwargs)
911.         if hasattr(self.builder, 'add_js_file'):
912.             self.builder.add_js_file(filename, **kwargs)  # type: ignore
913. 
914.     def add_css_file(self, filename: str, **kwargs: str) -> None:
915.         """Register a stylesheet to include in the HTML output.
916. 
917.         Add *filename* to the list of CSS files that the default HTML template
918.         will include.  The filename must be relative to the HTML static path,
919.         or a full URI with scheme.  The keyword arguments are also accepted for
920.         attributes of ``<link>`` tag.
921. 
922.         Example::
923. 
924.             app.add_css_file('custom.css')
925.             # => <link rel="stylesheet" href="_static/custom.css" type="text/css" />
926. 
927.             app.add_css_file('print.css', media='print')
928.             # => <link rel="stylesheet" href="_static/print.css"
929.             #          type="text/css" media="print" />
930. 
931.             app.add_css_file('fancy.css', rel='alternate stylesheet', title='fancy')
932.             # => <link rel="alternate stylesheet" href="_static/fancy.css"
933.             #          type="text/css" title="fancy" />
934. 
935.         .. versionadded:: 1.0
936. 
937.         .. versionchanged:: 1.6
938.            Optional ``alternate`` and/or ``title`` attributes can be supplied
939.            with the *alternate* (of boolean type) and *title* (a string)
940.            arguments. The default is no title and *alternate* = ``False``. For
941.            more information, refer to the `documentation
942.            <https://mdn.io/Web/CSS/Alternative_style_sheets>`__.
943. 
944.         .. versionchanged:: 1.8
945.            Renamed from ``app.add_stylesheet()``.
946.            And it allows keyword arguments as attributes of link tag.
947.         """
948.         logger.debug('[app] adding stylesheet: %r', filename)
949.         self.registry.add_css_files(filename, **kwargs)
950.         if hasattr(self.builder, 'add_css_file'):
951.             self.builder.add_css_file(filename, **kwargs)  # type: ignore
952. 
953.     def add_stylesheet(self, filename: str, alternate: bool = False, title: str = None
954.                        ) -> None:
955.         """An alias of :meth:`add_css_file`."""
956.         warnings.warn('The app.add_stylesheet() is deprecated. '
957.                       'Please use app.add_css_file() instead.',
958.                       RemovedInSphinx40Warning, stacklevel=2)
959. 
960.         attributes = {}  # type: Dict[str, str]
961.         if alternate:
962.             attributes['rel'] = 'alternate stylesheet'
963.         else:
964.             attributes['rel'] = 'stylesheet'
965. 
966.         if title:
967.             attributes['title'] = title
968. 
969.         self.add_css_file(filename, **attributes)
970. 
971.     def add_latex_package(self, packagename: str, options: str = None,
972.                           after_hyperref: bool = False) -> None:
973.         r"""Register a package to include in the LaTeX source code.
974. 
975.         Add *packagename* to the list of packages that LaTeX source code will
976.         include.  If you provide *options*, it will be taken to `\usepackage`
977.         declaration.  If you set *after_hyperref* truthy, the package will be
978.         loaded after ``hyperref`` package.
979. 
980.         .. code-block:: python
981. 
982.            app.add_latex_package('mypackage')
983.            # => \usepackage{mypackage}
984.            app.add_latex_package('mypackage', 'foo,bar')
985.            # => \usepackage[foo,bar]{mypackage}
986. 
987.         .. versionadded:: 1.3
988.         .. versionadded:: 3.1
989. 
990.            *after_hyperref* option.
991.         """
992.         self.registry.add_latex_package(packagename, options, after_hyperref)
993. 
994.     def add_lexer(self, alias: str, lexer: Union[Lexer, "Type[Lexer]"]) -> None:
995.         """Register a new lexer for source code.
996. 
997.         Use *lexer* to highlight code blocks with the given language *alias*.
998. 
999.         .. versionadded:: 0.6
1000.         .. versionchanged:: 2.1
1001.            Take a lexer class as an argument.  An instance of lexers are
1002.            still supported until Sphinx-3.x.
1003.         """
1004.         logger.debug('[app] adding lexer: %r', (alias, lexer))
1005.         if isinstance(lexer, Lexer):
1006.             warnings.warn('app.add_lexer() API changed; '
1007.                           'Please give lexer class instead of instance',
1008.                           RemovedInSphinx40Warning, stacklevel=2)
1009.             lexers[alias] = lexer
1010.         else:
1011.             lexer_classes[alias] = lexer
1012. 
1013.     def add_autodocumenter(self, cls: Any, override: bool = False) -> None:
1014.         """Register a new documenter class for the autodoc extension.
1015. 
1016.         Add *cls* as a new documenter class for the :mod:`sphinx.ext.autodoc`
1017.         extension.  It must be a subclass of
1018.         :class:`sphinx.ext.autodoc.Documenter`.  This allows to auto-document
1019.         new types of objects.  See the source of the autodoc module for
1020.         examples on how to subclass :class:`Documenter`.
1021. 
1022.         .. todo:: Add real docs for Documenter and subclassing
1023. 
1024.         .. versionadded:: 0.6
1025.         .. versionchanged:: 2.2
1026.            Add *override* keyword.
1027.         """
1028.         logger.debug('[app] adding autodocumenter: %r', cls)
1029.         from sphinx.ext.autodoc.directive import AutodocDirective
1030.         self.registry.add_documenter(cls.objtype, cls)
1031.         self.add_directive('auto' + cls.objtype, AutodocDirective, override=override)
1032. 
1033.     def add_autodoc_attrgetter(self, typ: "Type", getter: Callable[[Any, str, Any], Any]
1034.                                ) -> None:
1035.         """Register a new ``getattr``-like function for the autodoc extension.
1036. 
1037.         Add *getter*, which must be a function with an interface compatible to
1038.         the :func:`getattr` builtin, as the autodoc attribute getter for
1039.         objects that are instances of *typ*.  All cases where autodoc needs to
1040.         get an attribute of a type are then handled by this function instead of
1041.         :func:`getattr`.
1042. 
1043.         .. versionadded:: 0.6
1044.         """
1045.         logger.debug('[app] adding autodoc attrgetter: %r', (typ, getter))
1046.         self.registry.add_autodoc_attrgetter(typ, getter)
1047. 
1048.     def add_search_language(self, cls: Any) -> None:
1049.         """Register a new language for the HTML search index.
1050. 
1051.         Add *cls*, which must be a subclass of
1052.         :class:`sphinx.search.SearchLanguage`, as a support language for
1053.         building the HTML full-text search index.  The class must have a *lang*
1054.         attribute that indicates the language it should be used for.  See
1055.         :confval:`html_search_language`.
1056. 
1057.         .. versionadded:: 1.1
1058.         """
1059.         logger.debug('[app] adding search language: %r', cls)
1060.         from sphinx.search import languages, SearchLanguage
1061.         assert issubclass(cls, SearchLanguage)
1062.         languages[cls.lang] = cls
1063. 
1064.     def add_source_suffix(self, suffix: str, filetype: str, override: bool = False) -> None:
1065.         """Register a suffix of source files.
1066. 
1067.         Same as :confval:`source_suffix`.  The users can override this
1068.         using the setting.
1069. 
1070.         .. versionadded:: 1.8
1071.         """
1072.         self.registry.add_source_suffix(suffix, filetype, override=override)
1073. 
1074.     def add_source_parser(self, *args: Any, **kwargs: Any) -> None:
1075.         """Register a parser class.
1076. 
1077.         .. versionadded:: 1.4
1078.         .. versionchanged:: 1.8
1079.            *suffix* argument is deprecated.  It only accepts *parser* argument.
1080.            Use :meth:`add_source_suffix` API to register suffix instead.
1081.         .. versionchanged:: 1.8
1082.            Add *override* keyword.
1083.         """
1084.         self.registry.add_source_parser(*args, **kwargs)
1085. 
1086.     def add_env_collector(self, collector: "Type[EnvironmentCollector]") -> None:
1087.         """Register an environment collector class.
1088. 
1089.         Refer to :ref:`collector-api`.
1090. 
1091.         .. versionadded:: 1.6
1092.         """
1093.         logger.debug('[app] adding environment collector: %r', collector)
1094.         collector().enable(self)
1095. 
1096.     def add_html_theme(self, name: str, theme_path: str) -> None:
1097.         """Register a HTML Theme.
1098. 
1099.         The *name* is a name of theme, and *path* is a full path to the theme
1100.         (refs: :ref:`distribute-your-theme`).
1101. 
1102.         .. versionadded:: 1.6
1103.         """
1104.         logger.debug('[app] adding HTML theme: %r, %r', name, theme_path)
1105.         self.html_themes[name] = theme_path
1106. 
1107.     def add_html_math_renderer(self, name: str,
1108.                                inline_renderers: Tuple[Callable, Callable] = None,
1109.                                block_renderers: Tuple[Callable, Callable] = None) -> None:
1110.         """Register a math renderer for HTML.
1111. 
1112.         The *name* is a name of math renderer.  Both *inline_renderers* and
1113.         *block_renderers* are used as visitor functions for the HTML writer:
1114.         the former for inline math node (``nodes.math``), the latter for
1115.         block math node (``nodes.math_block``).  Regarding visitor functions,
1116.         see :meth:`add_node` for details.
1117. 
1118.         .. versionadded:: 1.8
1119. 
1120.         """
1121.         self.registry.add_html_math_renderer(name, inline_renderers, block_renderers)
1122. 
1123.     def add_message_catalog(self, catalog: str, locale_dir: str) -> None:
1124.         """Register a message catalog.
1125. 
1126.         The *catalog* is a name of catalog, and *locale_dir* is a base path
1127.         of message catalog.  For more details, see
1128.         :func:`sphinx.locale.get_translation()`.
1129. 
1130.         .. versionadded:: 1.8
1131.         """
1132.         locale.init([locale_dir], self.config.language, catalog)
1133.         locale.init_console(locale_dir, catalog)
1134. 
1135.     # ---- other methods -------------------------------------------------
1136.     def is_parallel_allowed(self, typ: str) -> bool:
1137.         """Check parallel processing is allowed or not.
1138. 
1139.         ``typ`` is a type of processing; ``'read'`` or ``'write'``.
1140.         """
1141.         if typ == 'read':
1142.             attrname = 'parallel_read_safe'
1143.             message_not_declared = __("the %s extension does not declare if it "
1144.                                       "is safe for parallel reading, assuming "
1145.                                       "it isn't - please ask the extension author "
1146.                                       "to check and make it explicit")
1147.             message_not_safe = __("the %s extension is not safe for parallel reading")
1148.         elif typ == 'write':
1149.             attrname = 'parallel_write_safe'
1150.             message_not_declared = __("the %s extension does not declare if it "
1151.                                       "is safe for parallel writing, assuming "
1152.                                       "it isn't - please ask the extension author "
1153.                                       "to check and make it explicit")
1154.             message_not_safe = __("the %s extension is not safe for parallel writing")
1155.         else:
1156.             raise ValueError('parallel type %s is not supported' % typ)
1157. 
1158.         for ext in self.extensions.values():
1159.             allowed = getattr(ext, attrname, None)
1160.             if allowed is None:
1161.                 logger.warning(message_not_declared, ext.name)
1162.                 logger.warning(__('doing serial %s'), typ)
1163.                 return False
1164.             elif not allowed:
1165.                 logger.warning(message_not_safe, ext.name)
1166.                 logger.warning(__('doing serial %s'), typ)
1167.                 return False
1168. 
1169.         return True
1170. 
1171. 
1172. class TemplateBridge:
1173.     """
1174.     This class defines the interface for a "template bridge", that is, a class
1175.     that renders templates given a template name and a context.
1176.     """
1177. 
1178.     def init(self, builder: "Builder", theme: Theme = None, dirs: List[str] = None) -> None:
1179.         """Called by the builder to initialize the template system.
1180. 
1181.         *builder* is the builder object; you'll probably want to look at the
1182.         value of ``builder.config.templates_path``.
1183. 
1184.         *theme* is a :class:`sphinx.theming.Theme` object or None; in the latter
1185.         case, *dirs* can be list of fixed directories to look for templates.
1186.         """
1187.         raise NotImplementedError('must be implemented in subclasses')
1188. 
1189.     def newest_template_mtime(self) -> float:
1190.         """Called by the builder to determine if output files are outdated
1191.         because of template changes.  Return the mtime of the newest template
1192.         file that was changed.  The default implementation returns ``0``.
1193.         """
1194.         return 0
1195. 
1196.     def render(self, template: str, context: Dict) -> None:
1197.         """Called by the builder to render a template given as a filename with
1198.         a specified context (a Python dictionary).
1199.         """
1200.         raise NotImplementedError('must be implemented in subclasses')
1201. 
1202.     def render_string(self, template: str, context: Dict) -> str:
1203.         """Called by the builder to render a template given as a string with a
1204.         specified context (a Python dictionary).
1205.         """
1206.         raise NotImplementedError('must be implemented in subclasses')

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 10:51:14,383 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The user's issue is about custom translations being ignored, and the provided patch suggests the ordering of `locale_dirs` in `sphinx/application.py` is the cause. The `_init_i18n` method in `sphinx/application.py` calls `locale.init()` and uses `CatalogRepository`. To fully understand the problem and validate the fix, I need to see the implementation of `locale.init()` which is in `sphinx/locale/__init__.py`, and the implementation of `CatalogRepository` which is in `sphinx/util/i18n.py`. These files will explain how translation directories are discovered and loaded." query='Please provide the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`.' extra_requirements='' purpose="These files are needed to understand the translation loading mechanism and why the user's translations are being overridden by the default ones."
2025-12-23 10:51:14,389 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`.
2025-12-23 10:51:14,394 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_retrieval_node - ERROR - Failed to retrieve from memory: Athena memory client is not configured.
2025-12-23 10:51:14,395 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-12-23 10:51:14,395 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-12-23 10:51:14,396 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`.
Purpose: These files are needed to understand the translation loading mechanism and why the user's translations are being overridden by the default ones.
2025-12-23 10:51:16,961 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I will read the full content of the two files you requested: `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`. These files should provide insight into how translations are loaded in Sphinx.' additional_kwargs={'function_call': {'name': 'read_file_with_knowledge_graph_data', 'arguments': '{"relative_path": "sphinx/util/i18n.py"}'}} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 2089, 'candidates_token_count': 93, 'total_token_count': 2283, 'prompt_tokens_details': [{'modality': 1, 'token_count': 2089}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 93}], 'thoughts_token_count': 101, 'cached_content_token_count': 0, 'cache_tokens_details': []}, 'finish_reason': 'STOP', 'avg_logprobs': -0.07614208036853422, 'model_name': 'gemini-2.5-pro'} id='run--5e2537a5-93c7-4c2a-97ee-c297d8ab8d6a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/locale/__init__.py'}, 'id': 'd0de4cc6-67f5-463f-b5d5-99e6b4d780f4', 'type': 'tool_call'}, {'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'sphinx/util/i18n.py'}, 'id': 'd01fa116-28fb-45e2-8240-abc29b8faa05', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2089, 'output_tokens': 93, 'total_tokens': 2283, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 101}}
2025-12-23 10:51:22,104 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_provider_node - DEBUG - content='I have successfully retrieved the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`. The first file, `sphinx/locale/__init__.py`, manages the core localization functionality by defining how translation catalogs are initialized and accessed. The `init` function in this file is particularly relevant as it handles the merging of message catalogs. The second file, `sphinx/util/i18n.py`, provides higher-level internationalization utilities, including classes for managing message catalogs and functions for finding and compiling them, as well as utilities for date and image localization.' additional_kwargs={} response_metadata={'is_blocked': False, 'safety_ratings': [], 'usage_metadata': {'prompt_token_count': 11030, 'candidates_token_count': 126, 'total_token_count': 11423, 'cached_content_token_count': 1857, 'prompt_tokens_details': [{'modality': 1, 'token_count': 11030}], 'cache_tokens_details': [{'modality': 1, 'token_count': 1857}], 'candidates_tokens_details': [{'modality': 1, 'token_count': 126}], 'thoughts_token_count': 267}, 'finish_reason': 'STOP', 'avg_logprobs': -0.284382804991707, 'model_name': 'gemini-2.5-pro'} id='run--a1f033d9-1cbd-4aa7-90e6-bb1a276c2411-0' usage_metadata={'input_tokens': 11030, 'output_tokens': 126, 'total_tokens': 11423, 'input_token_details': {'cache_read': 1857}, 'output_token_details': {'reasoning': 267}}
2025-12-23 10:51:22,107 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`.
--- END QUERY ---



--- BEGIN PURPOSE ---
These files are needed to understand the translation loading mechanism and why the user's translations are being overridden by the default ones.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: sphinx/locale/__init__.py
Line number range: 1 - 266
Content:
1. """
2.     sphinx.locale
3.     ~~~~~~~~~~~~~
4. 
5.     Locale utilities.
6. 
7.     :copyright: Copyright 2007-2016 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import gettext
12. import locale
13. from collections import UserString, defaultdict
14. from gettext import NullTranslations
15. from typing import Any, Callable, Dict, Iterable, List, Optional, Tuple, Union
16. 
17. 
18. class _TranslationProxy(UserString):
19.     """
20.     Class for proxy strings from gettext translations. This is a helper for the
21.     lazy_* functions from this module.
22. 
23.     The proxy implementation attempts to be as complete as possible, so that
24.     the lazy objects should mostly work as expected, for example for sorting.
25. 
26.     This inherits from UserString because some docutils versions use UserString
27.     for their Text nodes, which then checks its argument for being either a
28.     basestring or UserString, otherwise calls str() -- not unicode() -- on it.
29.     """
30.     __slots__ = ('_func', '_args')
31. 
32.     def __new__(cls, func: Callable, *args: str) -> object:  # type: ignore
33.         if not args:
34.             # not called with "function" and "arguments", but a plain string
35.             return str(func)
36.         return object.__new__(cls)
37. 
38.     def __getnewargs__(self) -> Tuple[str]:
39.         return (self._func,) + self._args  # type: ignore
40. 
41.     def __init__(self, func: Callable, *args: str) -> None:
42.         self._func = func
43.         self._args = args
44. 
45.     @property
46.     def data(self) -> str:  # type: ignore
47.         return self._func(*self._args)
48. 
49.     # replace function from UserString; it instantiates a self.__class__
50.     # for the encoding result
51. 
52.     def encode(self, encoding: str = None, errors: str = None) -> bytes:  # type: ignore
53.         if encoding:
54.             if errors:
55.                 return self.data.encode(encoding, errors)
56.             else:
57.                 return self.data.encode(encoding)
58.         else:
59.             return self.data.encode()
60. 
61.     def __dir__(self) -> List[str]:
62.         return dir(str)
63. 
64.     def __str__(self) -> str:
65.         return str(self.data)
66. 
67.     def __add__(self, other: str) -> str:  # type: ignore
68.         return self.data + other
69. 
70.     def __radd__(self, other: str) -> str:
71.         return other + self.data
72. 
73.     def __mod__(self, other: str) -> str:  # type: ignore
74.         return self.data % other
75. 
76.     def __rmod__(self, other: str) -> str:
77.         return other % self.data
78. 
79.     def __mul__(self, other: Any) -> str:  # type: ignore
80.         return self.data * other
81. 
82.     def __rmul__(self, other: Any) -> str:
83.         return other * self.data
84. 
85.     def __getattr__(self, name: str) -> Any:
86.         if name == '__members__':
87.             return self.__dir__()
88.         return getattr(self.data, name)
89. 
90.     def __getstate__(self) -> Tuple[Callable, Tuple[str, ...]]:
91.         return self._func, self._args
92. 
93.     def __setstate__(self, tup: Tuple[Callable, Tuple[str]]) -> None:
94.         self._func, self._args = tup
95. 
96.     def __copy__(self) -> "_TranslationProxy":
97.         return self
98. 
99.     def __repr__(self) -> str:
100.         try:
101.             return 'i' + repr(str(self.data))
102.         except Exception:
103.             return '<%s broken>' % self.__class__.__name__
104. 
105. 
106. translators = defaultdict(NullTranslations)  # type: Dict[Tuple[str, str], NullTranslations]
107. 
108. 
109. def init(locale_dirs: List[str], language: str,
110.          catalog: str = 'sphinx', namespace: str = 'general') -> Tuple[NullTranslations, bool]:
111.     """Look for message catalogs in `locale_dirs` and *ensure* that there is at
112.     least a NullTranslations catalog set in `translators`. If called multiple
113.     times or if several ``.mo`` files are found, their contents are merged
114.     together (thus making ``init`` reentrant).
115.     """
116.     global translators
117.     translator = translators.get((namespace, catalog))
118.     # ignore previously failed attempts to find message catalogs
119.     if translator.__class__ is NullTranslations:
120.         translator = None
121.     # the None entry is the system's default locale path
122.     has_translation = True
123. 
124.     if language and '_' in language:
125.         # for language having country code (like "de_AT")
126.         languages = [language, language.split('_')[0]]
127.     else:
128.         languages = [language]
129. 
130.     # loading
131.     for dir_ in locale_dirs:
132.         try:
133.             trans = gettext.translation(catalog, localedir=dir_, languages=languages)
134.             if translator is None:
135.                 translator = trans
136.             else:
137.                 translator.add_fallback(trans)
138.         except Exception:
139.             # Language couldn't be found in the specified path
140.             pass
141.     # guarantee translators[(namespace, catalog)] exists
142.     if translator is None:
143.         translator = NullTranslations()
144.         has_translation = False
145.     translators[(namespace, catalog)] = translator
146.     return translator, has_translation
147. 
148. 
149. def setlocale(category: int, value: Union[str, Iterable[str]] = None) -> None:
150.     """Update locale settings.
151. 
152.     This does not throw any exception even if update fails.
153.     This is workaround for Python's bug.
154. 
155.     For more details:
156. 
157.     * https://github.com/sphinx-doc/sphinx/issues/5724
158.     * https://bugs.python.org/issue18378#msg215215
159. 
160.     .. note:: Only for internal use.  Please don't call this method from extensions.
161.               This will be removed in future.
162.     """
163.     try:
164.         locale.setlocale(category, value)
165.     except locale.Error:
166.         pass
167. 
168. 
169. def init_console(locale_dir: str, catalog: str) -> Tuple[NullTranslations, bool]:
170.     """Initialize locale for console.
171. 
172.     .. versionadded:: 1.8
173.     """
174.     try:
175.         # encoding is ignored
176.         language, _ = locale.getlocale(locale.LC_MESSAGES)  # type: Tuple[Optional[str], Any]
177.     except AttributeError:
178.         # LC_MESSAGES is not always defined. Fallback to the default language
179.         # in case it is not.
180.         language = None
181.     return init([locale_dir], language, catalog, 'console')
182. 
183. 
184. def get_translator(catalog: str = 'sphinx', namespace: str = 'general') -> NullTranslations:
185.     return translators[(namespace, catalog)]
186. 
187. 
188. def is_translator_registered(catalog: str = 'sphinx', namespace: str = 'general') -> bool:
189.     return (namespace, catalog) in translators
190. 
191. 
192. def _lazy_translate(catalog: str, namespace: str, message: str) -> str:
193.     """Used instead of _ when creating TranslationProxy, because _ is
194.     not bound yet at that time.
195.     """
196.     translator = get_translator(catalog, namespace)
197.     return translator.gettext(message)
198. 
199. 
200. def get_translation(catalog: str, namespace: str = 'general') -> Callable:
201.     """Get a translation function based on the *catalog* and *namespace*.
202. 
203.     The extension can use this API to translate the messages on the
204.     extension::
205. 
206.         import os
207.         from sphinx.locale import get_translation
208. 
209.         MESSAGE_CATALOG_NAME = 'myextension'  # name of *.pot, *.po and *.mo files
210.         _ = get_translation(MESSAGE_CATALOG_NAME)
211.         text = _('Hello Sphinx!')
212. 
213. 
214.         def setup(app):
215.             package_dir = path.abspath(path.dirname(__file__))
216.             locale_dir = os.path.join(package_dir, 'locales')
217.             app.add_message_catalog(MESSAGE_CATALOG_NAME, locale_dir)
218. 
219.     With this code, sphinx searches a message catalog from
220.     ``${package_dir}/locales/${language}/LC_MESSAGES/myextension.mo``.
221.     The :confval:`language` is used for the searching.
222. 
223.     .. versionadded:: 1.8
224.     """
225.     def gettext(message: str, *args: Any) -> str:
226.         if not is_translator_registered(catalog, namespace):
227.             # not initialized yet
228.             return _TranslationProxy(_lazy_translate, catalog, namespace, message)  # type: ignore  # NOQA
229.         else:
230.             translator = get_translator(catalog, namespace)
231.             if len(args) <= 1:
232.                 return translator.gettext(message)
233.             else:  # support pluralization
234.                 return translator.ngettext(message, args[0], args[1])
235. 
236.     return gettext
237. 
238. 
239. # A shortcut for sphinx-core
240. #: Translation function for messages on documentation (menu, labels, themes and so on).
241. #: This function follows :confval:`language` setting.
242. _ = get_translation('sphinx')
243. #: Translation function for console messages
244. #: This function follows locale setting (`LC_ALL`, `LC_MESSAGES` and so on).
245. __ = get_translation('sphinx', 'console')
246. 
247. 
248. # labels
249. admonitionlabels = {
250.     'attention': _('Attention'),
251.     'caution':   _('Caution'),
252.     'danger':    _('Danger'),
253.     'error':     _('Error'),
254.     'hint':      _('Hint'),
255.     'important': _('Important'),
256.     'note':      _('Note'),
257.     'seealso':   _('See also'),
258.     'tip':       _('Tip'),
259.     'warning':   _('Warning'),
260. }
261. 
262. # Moved to sphinx.directives.other (will be overriden later)
263. versionlabels = {}  # type: Dict[str, str]
264. 
265. # Moved to sphinx.domains.python (will be overriden later)
266. pairindextypes = {}  # type: Dict[str, str]


File: sphinx/util/i18n.py
Line number range: 1 - 333
Content:
1. """
2.     sphinx.util.i18n
3.     ~~~~~~~~~~~~~~~~
4. 
5.     Builder superclass for all builders.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. import gettext
11. import os
12. import re
13. import warnings
14. from collections import namedtuple
15. from datetime import datetime, timezone
16. from os import path
17. from typing import Callable, Generator, List, Set, Tuple, Union
18. 
19. import babel.dates
20. from babel.messages.mofile import write_mo
21. from babel.messages.pofile import read_po
22. 
23. from sphinx.deprecation import RemovedInSphinx40Warning
24. from sphinx.errors import SphinxError
25. from sphinx.locale import __
26. from sphinx.util import logging
27. from sphinx.util.matching import Matcher
28. from sphinx.util.osutil import SEP, canon_path, relpath
29. 
30. if False:
31.     # For type annotation
32.     from sphinx.environment import BuildEnvironment
33. 
34. 
35. logger = logging.getLogger(__name__)
36. 
37. LocaleFileInfoBase = namedtuple('CatalogInfo', 'base_dir,domain,charset')
38. 
39. 
40. class CatalogInfo(LocaleFileInfoBase):
41. 
42.     @property
43.     def po_file(self) -> str:
44.         return self.domain + '.po'
45. 
46.     @property
47.     def mo_file(self) -> str:
48.         return self.domain + '.mo'
49. 
50.     @property
51.     def po_path(self) -> str:
52.         return path.join(self.base_dir, self.po_file)
53. 
54.     @property
55.     def mo_path(self) -> str:
56.         return path.join(self.base_dir, self.mo_file)
57. 
58.     def is_outdated(self) -> bool:
59.         return (
60.             not path.exists(self.mo_path) or
61.             path.getmtime(self.mo_path) < path.getmtime(self.po_path))
62. 
63.     def write_mo(self, locale: str) -> None:
64.         with open(self.po_path, encoding=self.charset) as file_po:
65.             try:
66.                 po = read_po(file_po, locale)
67.             except Exception as exc:
68.                 logger.warning(__('reading error: %s, %s'), self.po_path, exc)
69.                 return
70. 
71.         with open(self.mo_path, 'wb') as file_mo:
72.             try:
73.                 write_mo(file_mo, po)
74.             except Exception as exc:
75.                 logger.warning(__('writing error: %s, %s'), self.mo_path, exc)
76. 
77. 
78. class CatalogRepository:
79.     """A repository for message catalogs."""
80. 
81.     def __init__(self, basedir: str, locale_dirs: List[str],
82.                  language: str, encoding: str) -> None:
83.         self.basedir = basedir
84.         self._locale_dirs = locale_dirs
85.         self.language = language
86.         self.encoding = encoding
87. 
88.     @property
89.     def locale_dirs(self) -> Generator[str, None, None]:
90.         if not self.language:
91.             return
92. 
93.         for locale_dir in self._locale_dirs:
94.             locale_dir = path.join(self.basedir, locale_dir)
95.             if path.exists(path.join(locale_dir, self.language, 'LC_MESSAGES')):
96.                 yield locale_dir
97. 
98.     @property
99.     def pofiles(self) -> Generator[Tuple[str, str], None, None]:
100.         for locale_dir in self.locale_dirs:
101.             basedir = path.join(locale_dir, self.language, 'LC_MESSAGES')
102.             for root, dirnames, filenames in os.walk(basedir):
103.                 # skip dot-directories
104.                 for dirname in dirnames:
105.                     if dirname.startswith('.'):
106.                         dirnames.remove(dirname)
107. 
108.                 for filename in filenames:
109.                     if filename.endswith('.po'):
110.                         fullpath = path.join(root, filename)
111.                         yield basedir, relpath(fullpath, basedir)
112. 
113.     @property
114.     def catalogs(self) -> Generator[CatalogInfo, None, None]:
115.         for basedir, filename in self.pofiles:
116.             domain = canon_path(path.splitext(filename)[0])
117.             yield CatalogInfo(basedir, domain, self.encoding)
118. 
119. 
120. def find_catalog(docname: str, compaction: bool) -> str:
121.     warnings.warn('find_catalog() is deprecated.',
122.                   RemovedInSphinx40Warning, stacklevel=2)
123.     if compaction:
124.         ret = docname.split(SEP, 1)[0]
125.     else:
126.         ret = docname
127. 
128.     return ret
129. 
130. 
131. def docname_to_domain(docname: str, compation: Union[bool, str]) -> str:
132.     """Convert docname to domain for catalogs."""
133.     if isinstance(compation, str):
134.         return compation
135.     if compation:
136.         return docname.split(SEP, 1)[0]
137.     else:
138.         return docname
139. 
140. 
141. def find_catalog_files(docname: str, srcdir: str, locale_dirs: List[str],
142.                        lang: str, compaction: bool) -> List[str]:
143.     warnings.warn('find_catalog_files() is deprecated.',
144.                   RemovedInSphinx40Warning, stacklevel=2)
145.     if not(lang and locale_dirs):
146.         return []
147. 
148.     domain = find_catalog(docname, compaction)
149.     files = [gettext.find(domain, path.join(srcdir, dir_), [lang])
150.              for dir_ in locale_dirs]
151.     files = [relpath(f, srcdir) for f in files if f]
152.     return files
153. 
154. 
155. def find_catalog_source_files(locale_dirs: List[str], locale: str, domains: List[str] = None,
156.                               charset: str = 'utf-8', force_all: bool = False,
157.                               excluded: Matcher = Matcher([])) -> Set[CatalogInfo]:
158.     """
159.     :param list locale_dirs:
160.        list of path as `['locale_dir1', 'locale_dir2', ...]` to find
161.        translation catalogs. Each path contains a structure such as
162.        `<locale>/LC_MESSAGES/domain.po`.
163.     :param str locale: a language as `'en'`
164.     :param list domains: list of domain names to get. If empty list or None
165.        is specified, get all domain names. default is None.
166.     :param boolean force_all:
167.        Set True if you want to get all catalogs rather than updated catalogs.
168.        default is False.
169.     :return: [CatalogInfo(), ...]
170.     """
171.     warnings.warn('find_catalog_source_files() is deprecated.',
172.                   RemovedInSphinx40Warning, stacklevel=2)
173. 
174.     catalogs = set()  # type: Set[CatalogInfo]
175. 
176.     if not locale:
177.         return catalogs  # locale is not specified
178. 
179.     for locale_dir in locale_dirs:
180.         if not locale_dir:
181.             continue  # skip system locale directory
182. 
183.         base_dir = path.join(locale_dir, locale, 'LC_MESSAGES')
184. 
185.         if not path.exists(base_dir):
186.             continue  # locale path is not found
187. 
188.         for dirpath, dirnames, filenames in os.walk(base_dir, followlinks=True):
189.             filenames = [f for f in filenames if f.endswith('.po')]
190.             for filename in filenames:
191.                 if excluded(path.join(relpath(dirpath, base_dir), filename)):
192.                     continue
193.                 base = path.splitext(filename)[0]
194.                 domain = relpath(path.join(dirpath, base), base_dir).replace(path.sep, SEP)
195.                 if domains and domain not in domains:
196.                     continue
197.                 cat = CatalogInfo(base_dir, domain, charset)
198.                 if force_all or cat.is_outdated():
199.                     catalogs.add(cat)
200. 
201.     return catalogs
202. 
203. 
204. # date_format mappings: ustrftime() to bable.dates.format_datetime()
205. date_format_mappings = {
206.     '%a':  'EEE',     # Weekday as locale’s abbreviated name.
207.     '%A':  'EEEE',    # Weekday as locale’s full name.
208.     '%b':  'MMM',     # Month as locale’s abbreviated name.
209.     '%B':  'MMMM',    # Month as locale’s full name.
210.     '%c':  'medium',  # Locale’s appropriate date and time representation.
211.     '%-d': 'd',       # Day of the month as a decimal number.
212.     '%d':  'dd',      # Day of the month as a zero-padded decimal number.
213.     '%-H': 'H',       # Hour (24-hour clock) as a decimal number [0,23].
214.     '%H':  'HH',      # Hour (24-hour clock) as a zero-padded decimal number [00,23].
215.     '%-I': 'h',       # Hour (12-hour clock) as a decimal number [1,12].
216.     '%I':  'hh',      # Hour (12-hour clock) as a zero-padded decimal number [01,12].
217.     '%-j': 'D',       # Day of the year as a decimal number.
218.     '%j':  'DDD',     # Day of the year as a zero-padded decimal number.
219.     '%-m': 'M',       # Month as a decimal number.
220.     '%m':  'MM',      # Month as a zero-padded decimal number.
221.     '%-M': 'm',       # Minute as a decimal number [0,59].
222.     '%M':  'mm',      # Minute as a zero-padded decimal number [00,59].
223.     '%p':  'a',       # Locale’s equivalent of either AM or PM.
224.     '%-S': 's',       # Second as a decimal number.
225.     '%S':  'ss',      # Second as a zero-padded decimal number.
226.     '%U':  'WW',      # Week number of the year (Sunday as the first day of the week)
227.                       # as a zero padded decimal number. All days in a new year preceding
228.                       # the first Sunday are considered to be in week 0.
229.     '%w':  'e',       # Weekday as a decimal number, where 0 is Sunday and 6 is Saturday.
230.     '%-W': 'W',       # Week number of the year (Monday as the first day of the week)
231.                       # as a decimal number. All days in a new year preceding the first
232.                       # Monday are considered to be in week 0.
233.     '%W':  'WW',      # Week number of the year (Monday as the first day of the week)
234.                       # as a zero-padded decimal number.
235.     '%x':  'medium',  # Locale’s appropriate date representation.
236.     '%X':  'medium',  # Locale’s appropriate time representation.
237.     '%y':  'YY',      # Year without century as a zero-padded decimal number.
238.     '%Y':  'yyyy',    # Year with century as a decimal number.
239.     '%Z':  'zzzz',    # Time zone name (no characters if no time zone exists).
240.     '%%':  '%',
241. }
242. 
243. date_format_re = re.compile('(%s)' % '|'.join(date_format_mappings))
244. 
245. 
246. def babel_format_date(date: datetime, format: str, locale: str,
247.                       formatter: Callable = babel.dates.format_date) -> str:
248.     if locale is None:
249.         locale = 'en'
250. 
251.     # Check if we have the tzinfo attribute. If not we cannot do any time
252.     # related formats.
253.     if not hasattr(date, 'tzinfo'):
254.         formatter = babel.dates.format_date
255. 
256.     try:
257.         return formatter(date, format, locale=locale)
258.     except (ValueError, babel.core.UnknownLocaleError):
259.         # fallback to English
260.         return formatter(date, format, locale='en')
261.     except AttributeError:
262.         logger.warning(__('Invalid date format. Quote the string by single quote '
263.                           'if you want to output it directly: %s'), format)
264.         return format
265. 
266. 
267. def format_date(format: str, date: datetime = None, language: str = None) -> str:
268.     if date is None:
269.         # If time is not specified, try to use $SOURCE_DATE_EPOCH variable
270.         # See https://wiki.debian.org/ReproducibleBuilds/TimestampsProposal
271.         source_date_epoch = os.getenv('SOURCE_DATE_EPOCH')
272.         if source_date_epoch is not None:
273.             date = datetime.utcfromtimestamp(float(source_date_epoch))
274.         else:
275.             date = datetime.now(timezone.utc).astimezone()
276. 
277.     result = []
278.     tokens = date_format_re.split(format)
279.     for token in tokens:
280.         if token in date_format_mappings:
281.             babel_format = date_format_mappings.get(token, '')
282. 
283.             # Check if we have to use a different babel formatter then
284.             # format_datetime, because we only want to format a date
285.             # or a time.
286.             if token == '%x':
287.                 function = babel.dates.format_date
288.             elif token == '%X':
289.                 function = babel.dates.format_time
290.             else:
291.                 function = babel.dates.format_datetime
292. 
293.             result.append(babel_format_date(date, babel_format, locale=language,
294.                                             formatter=function))
295.         else:
296.             result.append(token)
297. 
298.     return "".join(result)
299. 
300. 
301. def get_image_filename_for_language(filename: str, env: "BuildEnvironment") -> str:
302.     if not env.config.language:
303.         return filename
304. 
305.     filename_format = env.config.figure_language_filename
306.     d = dict()
307.     d['root'], d['ext'] = path.splitext(filename)
308.     dirname = path.dirname(d['root'])
309.     if dirname and not dirname.endswith(path.sep):
310.         dirname += path.sep
311.     docpath = path.dirname(env.docname)
312.     if docpath and not docpath.endswith(path.sep):
313.         docpath += path.sep
314.     d['path'] = dirname
315.     d['basename'] = path.basename(d['root'])
316.     d['docpath'] = docpath
317.     d['language'] = env.config.language
318.     try:
319.         return filename_format.format(**d)
320.     except KeyError as exc:
321.         raise SphinxError('Invalid figure_language_filename: %r' % exc) from exc
322. 
323. 
324. def search_image_for_language(filename: str, env: "BuildEnvironment") -> str:
325.     if not env.config.language:
326.         return filename
327. 
328.     translated = get_image_filename_for_language(filename, env)
329.     _, abspath = env.relfn2path(translated)
330.     if path.exists(abspath):
331.         return translated
332.     else:
333.         return filename

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-12-23 10:51:27,223 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='The user requested the full content of the file `sphinx/locale/__init__.py`. This context includes the entire file.', relative_path='sphinx/locale/__init__.py', start_line=1, end_line=266), ContextOutput(reasoning='The user requested the full content of the file `sphinx/util/i18n.py`. This context includes the entire file.', relative_path='sphinx/util/i18n.py', start_line=1, end_line=333)]
2025-12-23 10:51:27,225 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Storing 2 contexts to memory for query: Please provide the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`.
2025-12-23 10:51:27,225 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_storage_node - ERROR - Failed to store to memory: Athena memory client is not configured.
2025-12-23 10:51:27,225 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-12-23 10:51:27,226 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - Adding 2 new contexts to 1 existing contexts
2025-12-23 10:51:27,226 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 3 total contexts (removed 0 duplicates)
2025-12-23 10:51:27,227 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
sphinx
├── .circleci
|   └── config.yml
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       ├── builddoc.yml
|       ├── lint.yml
|       └── main.yml
├── .travis.yml
├── CONTRIBUTING.rst
├── README.rst
├── bindep.txt
├── doc
|   ├── _static
|   |   ├── conf.py.txt
|   |   └── themes
|   |       └── fullsize
|   ├── _templates
|   |   ├── index.html
|   |   └── indexsidebar.html
|   ├── _themes
|   |   └── sphinx13
|   |       ├── layout.html
|   |       └── static
|   |           └── sphinx13.css
|   ├── changes.rst
|   ├── conf.py
|   ├── contents.rst
|   ├── develop.rst
|   ├── development
|   |   ├── builders.rst
|   |   ├── index.rst
|   |   ├── overview.rst
|   |   ├── theming.rst
|   |   └── tutorials
|   |       ├── examples
|   |       |   ├── README.rst
|   |       |   ├── helloworld.py
|   |       |   ├── recipe.py
|   |       |   └── todo.py
|   |       ├── helloworld.rst
|   |       ├── index.rst
|   |       ├── recipe.rst
|   |       └── todo.rst
|   ├── examples.rst
|   ├── extdev
|   |   ├── appapi.rst
|   |   ├── builderapi.rst
|   |   ├── collectorapi.rst
|   |   ├── deprecated.rst
|   |   ├── domainapi.rst
|   |   ├── envapi.rst
|   |   ├── i18n.rst
|   |   ├── index.rst
|   |   ├── logging.rst
|   |   ├── markupapi.rst
|   |   ├── nodes.rst
|   |   ├── parserapi.rst
|   |   ├── projectapi.rst
|   |   └── utils.rst
|   ├── faq.rst
|   ├── glossary.rst
|   ├── internals
|   |   ├── authors.rst
|   |   ├── code-of-conduct.rst
|   |   ├── contributing.rst
|   |   ├── index.rst
|   |   ├── organization.rst
|   |   └── release-process.rst
|   ├── latex.rst
|   ├── man
|   |   ├── index.rst
|   |   ├── sphinx-apidoc.rst
|   |   ├── sphinx-autogen.rst
|   |   ├── sphinx-build.rst
|   |   └── sphinx-quickstart.rst
|   ├── templating.rst
|   └── usage
|       ├── advanced
|       |   ├── intl.rst
|       |   ├── setuptools.rst
|       |   └── websupport
|       |       ├── api.rst
|       |       ├── index.rst
|       |       ├── quickstart.rst
|       |       ├── searchadapters.rst
|       |       └── storagebackends.rst
|       ├── builders
|       |   └── index.rst
|       ├── configuration.rst
|       ├── extensions
|       |   ├── autodoc.rst
|       |   ├── autosectionlabel.rst
|       |   ├── autosummary.rst
|       |   ├── coverage.rst
|       |   ├── doctest.rst
|       |   ├── duration.rst
|       |   ├── example_google.py
|       |   ├── example_google.rst
|       |   ├── example_numpy.py
|       |   ├── example_numpy.rst
|       |   ├── extlinks.rst
|       |   ├── githubpages.rst
|       |   ├── graphviz.rst
|       |   ├── ifconfig.rst
|       |   ├── imgconverter.rst
|       |   ├── index.rst
|       |   ├── inheritance.rst
|       |   ├── intersphinx.rst
|       |   ├── linkcode.rst
|       |   ├── math.rst
|       |   ├── napoleon.rst
|       |   ├── todo.rst
|       |   └── viewcode.rst
|       ├── index.rst
|       ├── installation.rst
|       ├── markdown.rst
|       ├── quickstart.rst
|       ├── restructuredtext
|       |   ├── basics.rst
|       |   ├── directives.rst
|       |   ├── domains.rst
|       |   ├── field-lists.rst
|       |   ├── index.rst
|       |   └── roles.rst
|       └── theming.rst
├── karma.conf.js
├── setup.py
├── sphinx
|   ├── __init__.py
|   ├── __main__.py
|   ├── addnodes.py
|   ├── application.py
|   ├── builders
|   |   ├── __init__.py
|   |   ├── _epub_base.py
|   |   ├── applehelp.py
|   |   ├── changes.py
|   |   ├── devhelp.py
|   |   ├── dirhtml.py
|   |   ├── dummy.py
|   |   ├── epub3.py
|   |   ├── gettext.py
|   |   ├── html
|   |   |   ├── __init__.py
|   |   |   └── transforms.py
|   |   ├── htmlhelp.py
|   |   ├── latex
|   |   |   ├── __init__.py
|   |   |   ├── constants.py
|   |   |   ├── nodes.py
|   |   |   ├── theming.py
|   |   |   ├── transforms.py
|   |   |   └── util.py
|   |   ├── linkcheck.py
|   |   ├── manpage.py
|   |   ├── qthelp.py
|   |   ├── singlehtml.py
|   |   ├── texinfo.py
|   |   ├── text.py
|   |   └── xml.py
|   ├── cmd
|   |   ├── __init__.py
|   |   ├── build.py
|   |   ├── make_mode.py
|   |   └── quickstart.py
|   ├── config.py
|   ├── deprecation.py
|   ├── directives
|   |   ├── __init__.py
|   |   ├── code.py
|   |   ├── other.py
|   |   └── patches.py
|   ├── domains
|   |   ├── __init__.py
|   |   ├── c.py
|   |   ├── changeset.py
|   |   ├── citation.py
|   |   ├── cpp.py
|   |   ├── index.py
|   |   ├── javascript.py
|   |   ├── math.py
|   |   ├── python.py
|   |   ├── rst.py
|   |   └── std.py
|   ├── environment
|   |   ├── __init__.py
|   |   ├── adapters
|   |   |   ├── __init__.py
|   |   |   ├── asset.py
|   |   |   ├── indexentries.py
|   |   |   └── toctree.py
|   |   └── collectors
|   |       ├── __init__.py
|   |       ├── asset.py
|   |       ├── dependencies.py
|   |       ├── indexentries.py
|   |       ├── metadata.py
|   |       ├── title.py
|   |       └── toctree.py
|   ├── errors.py
|   ├── events.py
|   ├── ext
|   |   ├── __init__.py
|   |   ├── apidoc.py
|   |   ├── autodoc
|   |   |   ├── __init__.py
|   |   |   ├── directive.py
|   |   |   ├── importer.py
|   |   |   ├── mock.py
|   |   |   ├── type_comment.py
|   |   |   └── typehints.py
|   |   ├── autosectionlabel.py
|   |   ├── autosummary
|   |   |   ├── __init__.py
|   |   |   ├── generate.py
|   |   |   └── templates
|   |   |       └── autosummary
|   |   ├── coverage.py
|   |   ├── doctest.py
|   |   ├── duration.py
|   |   ├── extlinks.py
|   |   ├── githubpages.py
|   |   ├── graphviz.py
|   |   ├── ifconfig.py
|   |   ├── imgconverter.py
|   |   ├── imgmath.py
|   |   ├── inheritance_diagram.py
|   |   ├── intersphinx.py
|   |   ├── jsmath.py
|   |   ├── linkcode.py
|   |   ├── mathjax.py
|   |   ├── napoleon
|   |   |   ├── __init__.py
|   |   |   ├── docstring.py
|   |   |   └── iterators.py
|   |   ├── todo.py
|   |   └── viewcode.py
|   ├── extension.py
|   ├── highlighting.py
|   ├── io.py
|   ├── jinja2glue.py
|   ├── locale
|   |   ├── __init__.py
|   |   ├── ar
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bg
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── bn
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ca
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cak
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cs
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── cy
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── da
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── de
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── el
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eo
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── es
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── et
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── eu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fa
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── fr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── he
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hi_IN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── hu
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── id
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── it
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ja
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ko
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── lv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── mk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nb_NO
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ne
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── nl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_BR
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── pt_PT
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ro
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ru
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── si
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sk
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sl
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sq
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr@latin
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sr_RS
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── sv
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ta
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── te
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── tr
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── uk_UA
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── ur
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── vi
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   ├── zh_CN
|   |   |   └── LC_MESSAGES
|   |   |       └── sphinx.js
|   |   └── zh_TW
|   |       └── LC_MESSAGES
|   |           └── sphinx.js
|   ├── parsers.py
|   ├── project.py
|   ├── pycode
|   |   ├── __init__.py
|   |   ├── ast.py
|   |   └── parser.py
|   ├── pygments_styles.py
|   ├── registry.py
|   ├── roles.py
|   ├── search
|   |   ├── __init__.py
|   |   ├── da.py
|   |   ├── de.py
|   |   ├── en.py
|   |   ├── es.py
|   |   ├── fi.py
|   |   ├── fr.py
|   |   ├── hu.py
|   |   ├── it.py
|   |   ├── ja.py
|   |   ├── jssplitter.py
|   |   ├── nl.py
|   |   ├── no.py
|   |   ├── non-minified-js
|   |   |   ├── danish-stemmer.js
|   |   |   ├── dutch-stemmer.js
|   |   |   ├── finnish-stemmer.js
|   |   |   ├── french-stemmer.js
|   |   |   ├── german-stemmer.js
|   |   |   ├── hungarian-stemmer.js
|   |   |   ├── italian-stemmer.js
|   |   |   ├── norwegian-stemmer.js
|   |   |   ├── porter-stemmer.js
|   |   |   ├── portuguese-stemmer.js
|   |   |   ├── romanian-stemmer.js
|   |   |   ├── russian-stemmer.js
|   |   |   ├── spanish-stemmer.js
|   |   |   ├── swedish-stemmer.js
|   |   |   └── turkish-stemmer.js
|   |   ├── pt.py
|   |   ├── ro.py
|   |   ├── ru.py
|   |   ├── sv.py
|   |   ├── tr.py
|   |   └── zh.py
|   ├── setup_command.py
|   ├── templates
|   |   ├── apidoc
|   |   ├── epub3
|   |   |   └── container.xml
|   |   ├── gettext
|   |   ├── graphviz
|   |   |   └── graphviz.css
|   |   ├── htmlhelp
|   |   ├── imgmath
|   |   ├── latex
|   |   ├── quickstart
|   |   └── texinfo
|   ├── testing
|   |   ├── __init__.py
|   |   ├── comparer.py
|   |   ├── fixtures.py
|   |   ├── path.py
|   |   ├── restructuredtext.py
|   |   └── util.py
|   ├── texinputs
|   ├── texinputs_win
|   ├── themes
|   |   ├── agogo
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── basic
|   |   |   ├── changes
|   |   |   |   ├── frameset.html
|   |   |   |   ├── rstsource.html
|   |   |   |   └── versionchanges.html
|   |   |   ├── defindex.html
|   |   |   ├── domainindex.html
|   |   |   ├── genindex-single.html
|   |   |   ├── genindex-split.html
|   |   |   ├── genindex.html
|   |   |   ├── globaltoc.html
|   |   |   ├── layout.html
|   |   |   ├── localtoc.html
|   |   |   ├── opensearch.xml
|   |   |   ├── page.html
|   |   |   ├── relations.html
|   |   |   ├── search.html
|   |   |   ├── searchbox.html
|   |   |   ├── sourcelink.html
|   |   |   └── static
|   |   |       ├── doctools.js
|   |   |       ├── jquery-3.5.1.js
|   |   |       ├── jquery.js
|   |   |       ├── searchtools.js
|   |   |       ├── underscore-1.3.1.js
|   |   |       └── underscore.js
|   |   ├── bizstyle
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── css3-mediaqueries.js
|   |   |       └── css3-mediaqueries_src.js
|   |   ├── classic
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── default
|   |   |   └── static
|   |   |       └── default.css
|   |   ├── epub
|   |   |   ├── epub-cover.html
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── haiku
|   |   |   ├── layout.html
|   |   |   └── static
|   |   ├── nature
|   |   |   └── static
|   |   ├── nonav
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       └── nonav.css
|   |   ├── pyramid
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── epub.css
|   |   |       └── ie6.css
|   |   ├── scrolls
|   |   |   ├── artwork
|   |   |   ├── layout.html
|   |   |   └── static
|   |   |       ├── print.css
|   |   |       └── theme_extras.js
|   |   ├── sphinxdoc
|   |   |   └── static
|   |   └── traditional
|   |       └── static
|   ├── theming.py
|   ├── transforms
|   |   ├── __init__.py
|   |   ├── compact_bullet_list.py
|   |   ├── i18n.py
|   |   ├── post_transforms
|   |   |   ├── __init__.py
|   |   |   ├── code.py
|   |   |   └── images.py
|   |   └── references.py
|   ├── util
|   |   ├── __init__.py
|   |   ├── build_phase.py
|   |   ├── cfamily.py
|   |   ├── compat.py
|   |   ├── console.py
|   |   ├── docfields.py
|   |   ├── docstrings.py
|   |   ├── docutils.py
|   |   ├── fileutil.py
|   |   ├── i18n.py
|   |   ├── images.py
|   |   ├── inspect.py
|   |   ├── inventory.py
|   |   ├── jsdump.py
|   |   ├── jsonimpl.py
|   |   ├── logging.py
|   |   ├── matching.py
|   |   ├── math.py
|   |   ├── nodes.py
|   |   ├── osutil.py
|   |   ├── parallel.py
|   |   ├── png.py
|   |   ├── pycompat.py
|   |   ├── requests.py
|   |   ├── rst.py
|   |   ├── smartypants.py
|   |   ├── stemmer
|   |   |   ├── __init__.py
|   |   |   └── porter.py
|   |   ├── tags.py
|   |   ├── template.py
|   |   ├── texescape.py
|   |   └── typing.py
|   ├── versioning.py
|   └── writers
|       ├── __init__.py
|       ├── html.py
|       ├── html5.py
|       ├── latex.py
|       ├── manpage.py
|       ├── texinfo.py
|       ├── text.py
|       └── xml.py
├── tests
|   ├── conftest.py
|   ├── js
|   |   └── doctools.js
|   ├── roots
|   |   ├── test-add_enumerable_node
|   |   |   ├── conf.py
|   |   |   ├── enumerable_node.py
|   |   |   └── index.rst
|   |   ├── test-add_source_parser
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-add_source_parser-conflicts-with-users-setting
|   |   |   ├── conf.py
|   |   |   └── source_parser.py
|   |   ├── test-api-set-translator
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nonext
|   |   |   |   └── conf.py
|   |   |   └── translator.py
|   |   ├── test-apidoc-pep420
|   |   |   └── a
|   |   |       └── b
|   |   ├── test-apidoc-subpackage-in-toc
|   |   |   └── parent
|   |   |       ├── __init__.py
|   |   |       └── child
|   |   ├── test-apidoc-toc
|   |   |   └── mypackage
|   |   |       ├── __init__.py
|   |   |       ├── main.py
|   |   |       ├── no_init
|   |   |       ├── resource
|   |   |       └── something
|   |   ├── test-apidoc-trailing-underscore
|   |   |   └── package_
|   |   |       ├── __init__.py
|   |   |       └── module_.py
|   |   ├── test-autosummary
|   |   |   ├── conf.py
|   |   |   ├── dummy_module.py
|   |   |   ├── index.rst
|   |   |   ├── sphinx.rst
|   |   |   └── underscore_module_.py
|   |   ├── test-basic
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-html-translator
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-build-text
|   |   |   ├── conf.py
|   |   |   ├── doc1.txt
|   |   |   ├── doc2.txt
|   |   |   ├── index.txt
|   |   |   ├── lineblock.txt
|   |   |   ├── listitems.txt
|   |   |   ├── maxwidth.txt
|   |   |   ├── nonascii_maxwidth.txt
|   |   |   ├── nonascii_table.txt
|   |   |   ├── nonascii_title.txt
|   |   |   ├── table.txt
|   |   |   ├── table_colspan.txt
|   |   |   ├── table_colspan_and_rowspan.txt
|   |   |   ├── table_colspan_left.txt
|   |   |   └── table_rowspan.txt
|   |   ├── test-builder-dirhtml
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo
|   |   |   |   ├── foo_1.rst
|   |   |   |   ├── foo_2.rst
|   |   |   |   └── index.rst
|   |   |   └── index.rst
|   |   ├── test-builder-gettext-dont-rebuild-mo
|   |   |   ├── bom.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-changes
|   |   |   ├── base.rst
|   |   |   ├── c-api.rst
|   |   |   ├── conf.py
|   |   |   ├── contents.rst
|   |   |   └── library
|   |   |       └── utils.rst
|   |   ├── test-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-config
|   |   |   └── conf.py
|   |   ├── test-correct-year
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-default_role
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-directive-code
|   |   |   ├── caption.rst
|   |   |   ├── classes.rst
|   |   |   ├── conf.py
|   |   |   ├── emphasize.rst
|   |   |   ├── force.rst
|   |   |   ├── highlight.rst
|   |   |   ├── index.rst
|   |   |   ├── linenos.rst
|   |   |   ├── linenothreshold.rst
|   |   |   ├── namedblocks.rst
|   |   |   ├── py-decorators.rst
|   |   |   ├── python.rst
|   |   |   └── target.py
|   |   ├── test-directive-only
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── only.rst
|   |   ├── test-directives-raw
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-docutilsconf
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-domain-c
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── namespace.rst
|   |   |   └── semicolon.rst
|   |   ├── test-domain-cpp
|   |   |   ├── anon-dup-decl.rst
|   |   |   ├── any-role.rst
|   |   |   ├── backslash.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── lookup-key-overload.rst
|   |   |   ├── multi-decl-lookup.rst
|   |   |   ├── roles-targets-ok.rst
|   |   |   ├── roles-targets-warn.rst
|   |   |   ├── roles.rst
|   |   |   ├── roles2.rst
|   |   |   ├── semicolon.rst
|   |   |   ├── warn-template-param-qualified-name.rst
|   |   |   └── xref_consistency.rst
|   |   ├── test-domain-js
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   └── roles.rst
|   |   ├── test-domain-py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── module.rst
|   |   |   ├── module_option.rst
|   |   |   └── roles.rst
|   |   ├── test-double-inheriting-theme
|   |   |   ├── base_themes_dir
|   |   |   |   ├── base_theme1
|   |   |   |   └── base_theme2
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-epub-anchor-id
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autodoc
|   |   |   ├── autodoc_dummy_bar.py
|   |   |   ├── autodoc_dummy_module.py
|   |   |   ├── bug2437
|   |   |   |   ├── __init__.py
|   |   |   |   └── autodoc_dummy_foo.py
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target
|   |   |       ├── TYPE_CHECKING.py
|   |   |       ├── __init__.py
|   |   |       ├── abstractmethods.py
|   |   |       ├── annotated.py
|   |   |       ├── annotations.py
|   |   |       ├── autoclass_content.py
|   |   |       ├── bound_method.py
|   |   |       ├── cached_property.py
|   |   |       ├── callable.py
|   |   |       ├── classes.py
|   |   |       ├── coroutine.py
|   |   |       ├── decorator.py
|   |   |       ├── descriptor.py
|   |   |       ├── docstring_signature.py
|   |   |       ├── enums.py
|   |   |       ├── final.py
|   |   |       ├── functions.py
|   |   |       ├── generic_class.py
|   |   |       ├── genericalias.py
|   |   |       ├── imported_members.py
|   |   |       ├── inheritance.py
|   |   |       ├── methods.py
|   |   |       ├── name_conflict
|   |   |       ├── name_mangling.py
|   |   |       ├── need_mocks.py
|   |   |       ├── overload.py
|   |   |       ├── partialfunction.py
|   |   |       ├── partialmethod.py
|   |   |       ├── pep570.py
|   |   |       ├── private.py
|   |   |       ├── process_docstring.py
|   |   |       ├── singledispatch.py
|   |   |       ├── singledispatchmethod.py
|   |   |       ├── slots.py
|   |   |       ├── sort_by_all.py
|   |   |       ├── typed_vars.py
|   |   |       ├── typehints.py
|   |   |       ├── typevar.py
|   |   |       └── wrappedfunction.py
|   |   ├── test-ext-autosectionlabel
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosectionlabel-prefix-document
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── autosummary_importfail.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-filename-map
|   |   |   ├── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-imported_members
|   |   |   ├── autosummary_dummy_package
|   |   |   |   ├── __init__.py
|   |   |   |   └── autosummary_dummy_module.py
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-mock_imports
|   |   |   ├── conf.py
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-autosummary-recursive
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── package
|   |   |   |   ├── __init__.py
|   |   |   |   ├── module.py
|   |   |   |   ├── module_importfail.py
|   |   |   |   └── package
|   |   |   └── package2
|   |   |       ├── __init__.py
|   |   |       └── module.py
|   |   ├── test-ext-autosummary-skip-member
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-autosummary-template
|   |   |   ├── _templates
|   |   |   |   └── empty.rst
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── target.py
|   |   ├── test-ext-coverage
|   |   |   ├── conf.py
|   |   |   ├── coverage_ignored.py
|   |   |   ├── coverage_not_ignored.py
|   |   |   └── index.rst
|   |   ├── test-ext-doctest
|   |   |   ├── conf.py
|   |   |   └── doctest.txt
|   |   ├── test-ext-doctest-skipif
|   |   |   ├── conf.py
|   |   |   └── skipif.txt
|   |   ├── test-ext-doctest-with-autodoc
|   |   |   ├── conf.py
|   |   |   ├── dir
|   |   |   |   ├── __init__.py
|   |   |   |   ├── bar.py
|   |   |   |   └── inner.rst
|   |   |   ├── foo.py
|   |   |   └── index.rst
|   |   ├── test-ext-githubpages
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-graphviz
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-ifconfig
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-imgconverter
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-inheritance_diagram
|   |   |   ├── conf.py
|   |   |   ├── example
|   |   |   |   ├── __init__.py
|   |   |   |   └── sphinx.py
|   |   |   ├── index.rst
|   |   |   └── test.py
|   |   ├── test-ext-intersphinx-cppdomain
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── math.rst
|   |   |   └── page.rst
|   |   ├── test-ext-math-compat
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-math-simple
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-ext-todo
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-ext-viewcode
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── objects.rst
|   |   |   └── spam
|   |   |       ├── __init__.py
|   |   |       ├── mod1.py
|   |   |       ├── mod2.py
|   |   |       └── mod3.py
|   |   ├── test-ext-viewcode-find
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── not_a_package
|   |   |       ├── __init__.py
|   |   |       └── submodule.py
|   |   ├── test-extensions
|   |   |   ├── conf.py
|   |   |   ├── read_parallel.py
|   |   |   ├── read_serial.py
|   |   |   ├── write_parallel.py
|   |   |   └── write_serial.py
|   |   ├── test-footnotes
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-gettext-template
|   |   |   ├── _templates
|   |   |   |   ├── template1.html
|   |   |   |   └── template2.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-glossary
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_assets
|   |   |   ├── conf.py
|   |   |   ├── extra
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   └── subdir
|   |   |   ├── index.rst
|   |   |   ├── static
|   |   |   |   ├── css
|   |   |   |   ├── index.rst
|   |   |   |   ├── js
|   |   |   |   └── subdir
|   |   |   └── subdir
|   |   |       └── _build
|   |   ├── test-html_entity
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_scaled_image_link
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-html_style
|   |   |   ├── _static
|   |   |   |   └── default.css
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-parsed-literal
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-image-in-section
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-images
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── subdir
|   |   |       └── index.rst
|   |   ├── test-index_on_title
|   |   |   ├── conf.py
|   |   |   └── contents.rst
|   |   ├── test-inheritance
|   |   |   ├── basic_diagram.rst
|   |   |   ├── conf.py
|   |   |   ├── diagram_module_w_2_top_classes.rst
|   |   |   ├── diagram_w_1_top_class.rst
|   |   |   ├── diagram_w_2_top_classes.rst
|   |   |   ├── diagram_w_nested_classes.rst
|   |   |   ├── diagram_w_parts.rst
|   |   |   ├── dummy
|   |   |   |   ├── __init__.py
|   |   |   |   ├── test.py
|   |   |   |   └── test_nested.py
|   |   |   └── index.rst
|   |   ├── test-intl
|   |   |   ├── _templates
|   |   |   |   └── contents.html
|   |   |   ├── admonitions.txt
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── definition_terms.txt
|   |   |   ├── docfields.txt
|   |   |   ├── external_links.txt
|   |   |   ├── figure.txt
|   |   |   ├── footnote.txt
|   |   |   ├── glossary_terms.txt
|   |   |   ├── glossary_terms_inconsistency.txt
|   |   |   ├── index.txt
|   |   |   ├── index_entries.txt
|   |   |   ├── label_target.txt
|   |   |   ├── literalblock.txt
|   |   |   ├── only.txt
|   |   |   ├── raw.txt
|   |   |   ├── refs.txt
|   |   |   ├── refs_inconsistency.txt
|   |   |   ├── refs_python_domain.txt
|   |   |   ├── role_xref.txt
|   |   |   ├── rubric.txt
|   |   |   ├── section.txt
|   |   |   ├── seealso.txt
|   |   |   ├── subdir
|   |   |   |   └── index.txt
|   |   |   ├── table.txt
|   |   |   ├── toctree.txt
|   |   |   ├── topic.txt
|   |   |   ├── versionchange.txt
|   |   |   ├── warnings.txt
|   |   |   └── xx
|   |   |       └── LC_MESSAGES
|   |   ├── test-keep_warnings
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-babel
|   |   |   ├── bar.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-latex-equations
|   |   |   ├── conf.py
|   |   |   ├── equations.rst
|   |   |   └── expects
|   |   ├── test-latex-figure-in-admonition
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-includegraphics
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-index
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-labels
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── otherdoc.rst
|   |   ├── test-latex-numfig
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── indexhowto.rst
|   |   |   └── indexmanual.rst
|   |   ├── test-latex-table
|   |   |   ├── _mytemplates
|   |   |   |   └── latex
|   |   |   ├── complex.rst
|   |   |   ├── conf.py
|   |   |   ├── expects
|   |   |   ├── index.rst
|   |   |   ├── longtable.rst
|   |   |   └── tabular.rst
|   |   ├── test-latex-theme
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── theme
|   |   |       └── custom
|   |   ├── test-latex-title
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-latex-unicode
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-linkcheck
|   |   |   ├── conf.py
|   |   |   └── links.txt
|   |   ├── test-linkcheck-localserver
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-locale
|   |   |   ├── locale1
|   |   |   |   └── en
|   |   |   └── locale2
|   |   |       └── en
|   |   ├── test-manpage_url
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-citation
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-markup-rubric
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-maxlistdepth
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-metadata
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-need-escaped
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux.rst
|   |   ├── test-nested-enumerated-list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-nested-tables
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-numbered-circular
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── sub.rst
|   |   ├── test-numfig
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-productionlist
|   |   |   ├── Bare.rst
|   |   |   ├── Dup1.rst
|   |   |   ├── Dup2.rst
|   |   |   ├── LineContinuation.rst
|   |   |   ├── P1.rst
|   |   |   ├── P2.rst
|   |   |   ├── conf.py
|   |   |   ├── firstLineRule.rst
|   |   |   └── index.rst
|   |   ├── test-prolog
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── markdown.md
|   |   |   ├── prolog_markdown_parser.py
|   |   |   └── restructuredtext.rst
|   |   ├── test-pycode
|   |   |   └── cp_1251_coded.py
|   |   ├── test-pycode-egg
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   └── src
|   |   |       ├── sample.py
|   |   |       └── setup.py
|   |   ├── test-reST-code-block
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-refonly_bullet_list
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-roles-download
|   |   |   ├── another
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-root
|   |   |   ├── _templates
|   |   |   |   ├── contentssb.html
|   |   |   |   ├── customsb.html
|   |   |   |   └── layout.html
|   |   |   ├── autodoc.txt
|   |   |   ├── autodoc_target.py
|   |   |   ├── bom.txt
|   |   |   ├── conf.py
|   |   |   ├── extapi.txt
|   |   |   ├── extensions.txt
|   |   |   ├── footnote.txt
|   |   |   ├── images.txt
|   |   |   ├── includes.txt
|   |   |   ├── index.txt
|   |   |   ├── lists.txt
|   |   |   ├── markup.txt
|   |   |   ├── math.txt
|   |   |   ├── objects.txt
|   |   |   ├── parsermod.py
|   |   |   ├── special
|   |   |   |   └── code.py
|   |   |   └── subdir
|   |   |       ├── excluded.txt
|   |   |       ├── images.txt
|   |   |       └── includes.txt
|   |   ├── test-search
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── nosearch.rst
|   |   |   └── tocitem.rst
|   |   ├── test-setup
|   |   |   ├── doc
|   |   |   |   ├── conf.py
|   |   |   |   └── index.txt
|   |   |   └── setup.py
|   |   ├── test-smartquotes
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-stylesheets
|   |   |   ├── _templates
|   |   |   |   └── layout.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-templating
|   |   |   ├── _templates
|   |   |   |   ├── autosummary
|   |   |   |   └── layout.html
|   |   |   ├── autosummary_templating.txt
|   |   |   ├── conf.py
|   |   |   └── index.txt
|   |   ├── test-theming
|   |   |   ├── conf.py
|   |   |   ├── index.rst
|   |   |   ├── setup.py
|   |   |   └── test_theme
|   |   |       ├── __init__.py
|   |   |       ├── staticfiles
|   |   |       └── test-theme
|   |   ├── test-tocdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   ├── qux.rst
|   |   |   └── tocdepth.rst
|   |   ├── test-toctree-duplicated
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   └── index.rst
|   |   ├── test-toctree-empty
|   |   |   ├── _templates
|   |   |   |   └── localtoc.html
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-toctree-glob
|   |   |   ├── bar
|   |   |   |   ├── bar_1.rst
|   |   |   |   ├── bar_2.rst
|   |   |   |   ├── bar_3.rst
|   |   |   |   ├── bar_4
|   |   |   |   └── index.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   ├── quux.rst
|   |   |   └── qux
|   |   |       ├── index.rst
|   |   |       ├── qux_1.rst
|   |   |       └── qux_2.rst
|   |   ├── test-toctree-maxdepth
|   |   |   ├── bar.rst
|   |   |   ├── baz.rst
|   |   |   ├── conf.py
|   |   |   ├── foo.rst
|   |   |   ├── index.rst
|   |   |   └── qux.rst
|   |   ├── test-trim_doctest_flags
|   |   |   ├── conf.py
|   |   |   └── index.rst
|   |   ├── test-versioning
|   |   |   ├── added.txt
|   |   |   ├── conf.py
|   |   |   ├── deleted.txt
|   |   |   ├── deleted_end.txt
|   |   |   ├── index.txt
|   |   |   ├── insert.txt
|   |   |   ├── insert_beginning.txt
|   |   |   ├── insert_similar.txt
|   |   |   ├── modified.txt
|   |   |   └── original.txt
|   |   └── test-warnings
|   |       ├── autodoc_fodder.py
|   |       ├── conf.py
|   |       ├── index.rst
|   |       └── undecodable.rst
|   ├── test_api_translator.py
|   ├── test_application.py
|   ├── test_build.py
|   ├── test_build_changes.py
|   ├── test_build_dirhtml.py
|   ├── test_build_epub.py
|   ├── test_build_gettext.py
|   ├── test_build_html.py
|   ├── test_build_latex.py
|   ├── test_build_linkcheck.py
|   ├── test_build_manpage.py
|   ├── test_build_texinfo.py
|   ├── test_build_text.py
|   ├── test_builder.py
|   ├── test_catalogs.py
|   ├── test_config.py
|   ├── test_correct_year.py
|   ├── test_directive_code.py
|   ├── test_directive_only.py
|   ├── test_directive_other.py
|   ├── test_directive_patch.py
|   ├── test_docutilsconf.py
|   ├── test_domain_c.py
|   ├── test_domain_cpp.py
|   ├── test_domain_js.py
|   ├── test_domain_py.py
|   ├── test_domain_rst.py
|   ├── test_domain_std.py
|   ├── test_environment.py
|   ├── test_environment_indexentries.py
|   ├── test_environment_toctree.py
|   ├── test_errors.py
|   ├── test_events.py
|   ├── test_ext_apidoc.py
|   ├── test_ext_autodoc.py
|   ├── test_ext_autodoc_autofunction.py
|   ├── test_ext_autodoc_configs.py
|   ├── test_ext_autodoc_events.py
|   ├── test_ext_autodoc_mock.py
|   ├── test_ext_autodoc_private_members.py
|   ├── test_ext_autosectionlabel.py
|   ├── test_ext_autosummary.py
|   ├── test_ext_coverage.py
|   ├── test_ext_doctest.py
|   ├── test_ext_duration.py
|   ├── test_ext_githubpages.py
|   ├── test_ext_graphviz.py
|   ├── test_ext_ifconfig.py
|   ├── test_ext_imgconverter.py
|   ├── test_ext_inheritance_diagram.py
|   ├── test_ext_intersphinx.py
|   ├── test_ext_math.py
|   ├── test_ext_napoleon.py
|   ├── test_ext_napoleon_docstring.py
|   ├── test_ext_napoleon_iterators.py
|   ├── test_ext_todo.py
|   ├── test_ext_viewcode.py
|   ├── test_highlighting.py
|   ├── test_intl.py
|   ├── test_locale.py
|   ├── test_markup.py
|   ├── test_metadata.py
|   ├── test_parser.py
|   ├── test_project.py
|   ├── test_pycode.py
|   ├── test_pycode_ast.py
|   ├── test_pycode_parser.py
|   ├── test_quickstart.py
|   ├── test_roles.py
|   ├── test_search.py
|   ├── test_setup_command.py
|   ├── test_smartquotes.py
|   ├── test_templating.py
|   ├── test_theming.py
|   ├── test_toctree.py
|   ├── test_transforms_post_transforms_code.py
|   ├── test_util.py
|   ├── test_util_docstrings.py
|   ├── test_util_docutils.py
|   ├── test_util_fileutil.py
|   ├── test_util_i18n.py
|   ├── test_util_images.py
|   ├── test_util_inspect.py
|   ├── test_util_inventory.py
|   ├── test_util_jsdump.py
|   ├── test_util_logging.py
|   ├── test_util_matching.py
|   ├── test_util_nodes.py
|   ├── test_util_pycompat.py
|   ├── test_util_rst.py
|   ├── test_util_template.py
|   ├── test_util_typing.py
|   ├── test_versioning.py
|   ├── test_writer_latex.py
|   └── typing_test_data.py
└── utils
    ├── __init__.py
    ├── bump_docker.sh
    ├── bump_version.py
    ├── checks.py
    ├── doclinter.py
    └── jssplitter_generator.py
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---

Issue: locale/<language>/LC_MESSAGES/sphinx.po translation ignored

Description: **Describe the bug**
I read [1] as it should be possible to add a file ``locale/<language>/LC_MESSAGES/sphinx.mo`` to the source dir (same dir as the ``Makefile``) and through that change translations or add additional translation to <language>. 

When I add ``locale/da/LC_MESSAGES/sphinx.po``, with updated entries for ``Fig. %s`` and ``Listing %s``, a ``locale/da/LC_MESSAGES/sphinx.mo`` is created (because of ``gettext_auto_build = True``), but the translations are not used. The translations from the official ``da`` translation [2] is used. Of course ``language = 'da'`` is in ``conf.py``.

[1] http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-locale_dirs
[2] https://github.com/sphinx-doc/sphinx/blob/master/sphinx/locale/da/LC_MESSAGES/sphinx.po

**To Reproduce**
Steps to reproduce the behavior:
```
$ git clone https://github.com/jonascj/sphinx-test-locale-override.git
$ cd sphinx-test-locale-override
$ git checkout 8dea4cd # EDIT: current master showcases workaround, so revert back to see the bug
$ # make python venv however you like
$ pip install sphinx
$ make html
```
Notice that ``locale/da/LC_MESSAGES/sphinx.mo`` has been created. Open ``_build/html/index.html``. 

**Expected behavior**
The caption label for the figure ``figur 1`` should have been ``Foobar 1`` (for the sake of testing) and the caption label for the code block ``Viser 1`` should have been ``Whatever 1`` (again for the sake of testing).

**Your project**
https://github.com/jonascj/sphinx-test-locale-override.git

**Screenshots**
![Screenshot of index.html](https://yapb.in/exUE.png "Screenshot of index.html")

**Environment info**
- OS: Arch Linux 
- Python version: 3.7.3
- Sphinx version: 2.1.2
- Sphinx extensions:  none
- Extra tools: none


Patch information:
diff --git a/sphinx/application.py b/sphinx/application.py
index 385b74d8a..995efedd6 100644
--- a/sphinx/application.py
+++ b/sphinx/application.py
@@ -293,7 +293,8 @@ class Sphinx:
                 if catalog.domain == 'sphinx' and catalog.is_outdated():
                     catalog.write_mo(self.config.language)
 
-            locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
+            # Put user-provided locale directories first to ensure custom translations override official ones
+            locale_dirs = list(repo.locale_dirs) + [None, path.join(package_dir, 'locale')]
             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
             if has_translation or self.config.language == 'en':
                 # "en" never needs to be translated


Find all relevant source code context needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of sphinx/application.py.
Extra Requirements: 
Purpose: This file contains the core application logic and the code snippet mentioned in the issue, which is essential for understanding the problem.

Previous refined query 2:
Essential Query: Please provide the full content of `sphinx/locale/__init__.py` and `sphinx/util/i18n.py`.
Extra Requirements: 
Purpose: These files are needed to understand the translation loading mechanism and why the user's translations are being overridden by the default ones.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: sphinx/application.py
Line number range: 1 - 1206
Content:
1. """
2.     sphinx.application
3.     ~~~~~~~~~~~~~~~~~~
4. 
5.     Sphinx application class and extensibility interface.
6. 
7.     Gracefully adapted from the TextPress system by Armin.
8. 
9.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
10.     :license: BSD, see LICENSE for details.
11. """
12. 
13. import os
14. import pickle
15. import platform
16. import sys
17. import warnings
18. from collections import deque
19. from io import StringIO
20. from os import path
21. from typing import Any, Callable, Dict, IO, List, Tuple, Union
22. 
23. from docutils import nodes
24. from docutils.nodes import Element, TextElement
25. from docutils.parsers.rst import Directive, roles
26. from docutils.transforms import Transform
27. from pygments.lexer import Lexer
28. 
29. import sphinx
30. from sphinx import package_dir, locale
31. from sphinx.config import Config
32. from sphinx.deprecation import RemovedInSphinx40Warning
33. from sphinx.domains import Domain, Index
34. from sphinx.environment import BuildEnvironment
35. from sphinx.environment.collectors import EnvironmentCollector
36. from sphinx.errors import ApplicationError, ConfigError, VersionRequirementError
37. from sphinx.events import EventManager
38. from sphinx.extension import Extension
39. from sphinx.highlighting import lexer_classes, lexers
40. from sphinx.locale import __
41. from sphinx.project import Project
42. from sphinx.registry import SphinxComponentRegistry
43. from sphinx.roles import XRefRole
44. from sphinx.theming import Theme
45. from sphinx.util import docutils
46. from sphinx.util import logging
47. from sphinx.util import progress_message
48. from sphinx.util.build_phase import BuildPhase
49. from sphinx.util.console import bold  # type: ignore
50. from sphinx.util.i18n import CatalogRepository
51. from sphinx.util.logging import prefixed_warnings
52. from sphinx.util.osutil import abspath, ensuredir, relpath
53. from sphinx.util.tags import Tags
54. from sphinx.util.typing import RoleFunction, TitleGetter
55. 
56. if False:
57.     # For type annotation
58.     from docutils.nodes import Node  # NOQA
59.     from typing import Type  # for python3.5.1
60.     from sphinx.builders import Builder
61. 
62. 
63. builtin_extensions = (
64.     'sphinx.addnodes',
65.     'sphinx.builders.changes',
66.     'sphinx.builders.epub3',
67.     'sphinx.builders.dirhtml',
68.     'sphinx.builders.dummy',
69.     'sphinx.builders.gettext',
70.     'sphinx.builders.html',
71.     'sphinx.builders.latex',
72.     'sphinx.builders.linkcheck',
73.     'sphinx.builders.manpage',
74.     'sphinx.builders.singlehtml',
75.     'sphinx.builders.texinfo',
76.     'sphinx.builders.text',
77.     'sphinx.builders.xml',
78.     'sphinx.config',
79.     'sphinx.domains.c',
80.     'sphinx.domains.changeset',
81.     'sphinx.domains.citation',
82.     'sphinx.domains.cpp',
83.     'sphinx.domains.index',
84.     'sphinx.domains.javascript',
85.     'sphinx.domains.math',
86.     'sphinx.domains.python',
87.     'sphinx.domains.rst',
88.     'sphinx.domains.std',
89.     'sphinx.directives',
90.     'sphinx.directives.code',
91.     'sphinx.directives.other',
92.     'sphinx.directives.patches',
93.     'sphinx.extension',
94.     'sphinx.parsers',
95.     'sphinx.registry',
96.     'sphinx.roles',
97.     'sphinx.transforms',
98.     'sphinx.transforms.compact_bullet_list',
99.     'sphinx.transforms.i18n',
100.     'sphinx.transforms.references',
101.     'sphinx.transforms.post_transforms',
102.     'sphinx.transforms.post_transforms.code',
103.     'sphinx.transforms.post_transforms.images',
104.     'sphinx.util.compat',
105.     'sphinx.versioning',
106.     # collectors should be loaded by specific order
107.     'sphinx.environment.collectors.dependencies',
108.     'sphinx.environment.collectors.asset',
109.     'sphinx.environment.collectors.metadata',
110.     'sphinx.environment.collectors.title',
111.     'sphinx.environment.collectors.toctree',
112.     # 1st party extensions
113.     'sphinxcontrib.applehelp',
114.     'sphinxcontrib.devhelp',
115.     'sphinxcontrib.htmlhelp',
116.     'sphinxcontrib.serializinghtml',
117.     'sphinxcontrib.qthelp',
118.     # Strictly, alabaster theme is not a builtin extension,
119.     # but it is loaded automatically to use it as default theme.
120.     'alabaster',
121. )
122. 
123. ENV_PICKLE_FILENAME = 'environment.pickle'
124. 
125. logger = logging.getLogger(__name__)
126. 
127. 
128. class Sphinx:
129.     """The main application class and extensibility interface.
130. 
131.     :ivar srcdir: Directory containing source.
132.     :ivar confdir: Directory containing ``conf.py``.
133.     :ivar doctreedir: Directory for storing pickled doctrees.
134.     :ivar outdir: Directory for storing build documents.
135.     """
136. 
137.     def __init__(self, srcdir: str, confdir: str, outdir: str, doctreedir: str,
138.                  buildername: str, confoverrides: Dict = None,
139.                  status: IO = sys.stdout, warning: IO = sys.stderr,
140.                  freshenv: bool = False, warningiserror: bool = False, tags: List[str] = None,
141.                  verbosity: int = 0, parallel: int = 0, keep_going: bool = False) -> None:
142.         self.phase = BuildPhase.INITIALIZATION
143.         self.verbosity = verbosity
144.         self.extensions = {}                    # type: Dict[str, Extension]
145.         self.builder = None                     # type: Builder
146.         self.env = None                         # type: BuildEnvironment
147.         self.project = None                     # type: Project
148.         self.registry = SphinxComponentRegistry()
149.         self.html_themes = {}                   # type: Dict[str, str]
150. 
151.         # validate provided directories
152.         self.srcdir = abspath(srcdir)
153.         self.outdir = abspath(outdir)
154.         self.doctreedir = abspath(doctreedir)
155.         self.confdir = confdir
156.         if self.confdir:  # confdir is optional
157.             self.confdir = abspath(self.confdir)
158.             if not path.isfile(path.join(self.confdir, 'conf.py')):
159.                 raise ApplicationError(__("config directory doesn't contain a "
160.                                           "conf.py file (%s)") % confdir)
161. 
162.         if not path.isdir(self.srcdir):
163.             raise ApplicationError(__('Cannot find source directory (%s)') %
164.                                    self.srcdir)
165. 
166.         if path.exists(self.outdir) and not path.isdir(self.outdir):
167.             raise ApplicationError(__('Output directory (%s) is not a directory') %
168.                                    self.outdir)
169. 
170.         if self.srcdir == self.outdir:
171.             raise ApplicationError(__('Source directory and destination '
172.                                       'directory cannot be identical'))
173. 
174.         self.parallel = parallel
175. 
176.         if status is None:
177.             self._status = StringIO()      # type: IO
178.             self.quiet = True
179.         else:
180.             self._status = status
181.             self.quiet = False
182. 
183.         if warning is None:
184.             self._warning = StringIO()     # type: IO
185.         else:
186.             self._warning = warning
187.         self._warncount = 0
188.         self.keep_going = warningiserror and keep_going
189.         if self.keep_going:
190.             self.warningiserror = False
191.         else:
192.             self.warningiserror = warningiserror
193.         logging.setup(self, self._status, self._warning)
194. 
195.         self.events = EventManager(self)
196. 
197.         # keep last few messages for traceback
198.         # This will be filled by sphinx.util.logging.LastMessagesWriter
199.         self.messagelog = deque(maxlen=10)  # type: deque
200. 
201.         # say hello to the world
202.         logger.info(bold(__('Running Sphinx v%s') % sphinx.__display_version__))
203. 
204.         # notice for parallel build on macOS and py38+
205.         if sys.version_info > (3, 8) and platform.system() == 'Darwin' and parallel > 1:
206.             logger.info(bold(__("For security reason, parallel mode is disabled on macOS and "
207.                                 "python3.8 and above. For more details, please read "
208.                                 "https://github.com/sphinx-doc/sphinx/issues/6803")))
209. 
210.         # status code for command-line application
211.         self.statuscode = 0
212. 
213.         # read config
214.         self.tags = Tags(tags)
215.         if self.confdir is None:
216.             self.config = Config({}, confoverrides or {})
217.         else:
218.             self.config = Config.read(self.confdir, confoverrides or {}, self.tags)
219. 
220.         # initialize some limited config variables before initialize i18n and loading
221.         # extensions
222.         self.config.pre_init_values()
223. 
224.         # set up translation infrastructure
225.         self._init_i18n()
226. 
227.         # check the Sphinx version if requested
228.         if self.config.needs_sphinx and self.config.needs_sphinx > sphinx.__display_version__:
229.             raise VersionRequirementError(
230.                 __('This project needs at least Sphinx v%s and therefore cannot '
231.                    'be built with this version.') % self.config.needs_sphinx)
232. 
233.         # set confdir to srcdir if -C given (!= no confdir); a few pieces
234.         # of code expect a confdir to be set
235.         if self.confdir is None:
236.             self.confdir = self.srcdir
237. 
238.         # load all built-in extension modules
239.         for extension in builtin_extensions:
240.             self.setup_extension(extension)
241. 
242.         # load all user-given extension modules
243.         for extension in self.config.extensions:
244.             self.setup_extension(extension)
245. 
246.         # preload builder module (before init config values)
247.         self.preload_builder(buildername)
248. 
249.         if not path.isdir(outdir):
250.             with progress_message(__('making output directory')):
251.                 ensuredir(outdir)
252. 
253.         # the config file itself can be an extension
254.         if self.config.setup:
255.             prefix = __('while setting up extension %s:') % "conf.py"
256.             with prefixed_warnings(prefix):
257.                 if callable(self.config.setup):
258.                     self.config.setup(self)
259.                 else:
260.                     raise ConfigError(
261.                         __("'setup' as currently defined in conf.py isn't a Python callable. "
262.                            "Please modify its definition to make it a callable function. "
263.                            "This is needed for conf.py to behave as a Sphinx extension.")
264.                     )
265. 
266.         # now that we know all config values, collect them from conf.py
267.         self.config.init_values()
268.         self.events.emit('config-inited', self.config)
269. 
270.         # create the project
271.         self.project = Project(self.srcdir, self.config.source_suffix)
272.         # create the builder
273.         self.builder = self.create_builder(buildername)
274.         # set up the build environment
275.         self._init_env(freshenv)
276.         # set up the builder
277.         self._init_builder()
278. 
279.     def _init_i18n(self) -> None:
280.         """Load translated strings from the configured localedirs if enabled in
281.         the configuration.
282.         """
283.         if self.config.language is None:
284.             self.translator, has_translation = locale.init([], None)
285.         else:
286.             logger.info(bold(__('loading translations [%s]... ') % self.config.language),
287.                         nonl=True)
288. 
289.             # compile mo files if sphinx.po file in user locale directories are updated
290.             repo = CatalogRepository(self.srcdir, self.config.locale_dirs,
291.                                      self.config.language, self.config.source_encoding)
292.             for catalog in repo.catalogs:
293.                 if catalog.domain == 'sphinx' and catalog.is_outdated():
294.                     catalog.write_mo(self.config.language)
295. 
296.             locale_dirs = [None, path.join(package_dir, 'locale')] + list(repo.locale_dirs)
297.             self.translator, has_translation = locale.init(locale_dirs, self.config.language)
298.             if has_translation or self.config.language == 'en':
299.                 # "en" never needs to be translated
300.                 logger.info(__('done'))
301.             else:
302.                 logger.info(__('not available for built-in messages'))
303. 
304.     def _init_env(self, freshenv: bool) -> None:
305.         filename = path.join(self.doctreedir, ENV_PICKLE_FILENAME)
306.         if freshenv or not os.path.exists(filename):
307.             self.env = BuildEnvironment()
308.             self.env.setup(self)
309.             self.env.find_files(self.config, self.builder)
310.         else:
311.             try:
312.                 with progress_message(__('loading pickled environment')):
313.                     with open(filename, 'rb') as f:
314.                         self.env = pickle.load(f)
315.                         self.env.setup(self)
316.             except Exception as err:
317.                 logger.info(__('failed: %s'), err)
318.                 self._init_env(freshenv=True)
319. 
320.     def preload_builder(self, name: str) -> None:
321.         self.registry.preload_builder(self, name)
322. 
323.     def create_builder(self, name: str) -> "Builder":
324.         if name is None:
325.             logger.info(__('No builder selected, using default: html'))
326.             name = 'html'
327. 
328.         return self.registry.create_builder(self, name)
329. 
330.     def _init_builder(self) -> None:
331.         self.builder.set_environment(self.env)
332.         self.builder.init()
333.         self.events.emit('builder-inited')
334. 
335.     # ---- main "build" method -------------------------------------------------
336. 
337.     def build(self, force_all: bool = False, filenames: List[str] = None) -> None:
338.         self.phase = BuildPhase.READING
339.         try:
340.             if force_all:
341.                 self.builder.compile_all_catalogs()
342.                 self.builder.build_all()
343.             elif filenames:
344.                 self.builder.compile_specific_catalogs(filenames)
345.                 self.builder.build_specific(filenames)
346.             else:
347.                 self.builder.compile_update_catalogs()
348.                 self.builder.build_update()
349. 
350.             if self._warncount and self.keep_going:
351.                 self.statuscode = 1
352. 
353.             status = (__('succeeded') if self.statuscode == 0
354.                       else __('finished with problems'))
355.             if self._warncount:
356.                 if self.warningiserror:
357.                     if self._warncount == 1:
358.                         msg = __('build %s, %s warning (with warnings treated as errors).')
359.                     else:
360.                         msg = __('build %s, %s warnings (with warnings treated as errors).')
361.                 else:
362.                     if self._warncount == 1:
363.                         msg = __('build %s, %s warning.')
364.                     else:
365.                         msg = __('build %s, %s warnings.')
366. 
367.                 logger.info(bold(msg % (status, self._warncount)))
368.             else:
369.                 logger.info(bold(__('build %s.') % status))
370. 
371.             if self.statuscode == 0 and self.builder.epilog:
372.                 logger.info('')
373.                 logger.info(self.builder.epilog % {
374.                     'outdir': relpath(self.outdir),
375.                     'project': self.config.project
376.                 })
377.         except Exception as err:
378.             # delete the saved env to force a fresh build next time
379.             envfile = path.join(self.doctreedir, ENV_PICKLE_FILENAME)
380.             if path.isfile(envfile):
381.                 os.unlink(envfile)
382.             self.events.emit('build-finished', err)
383.             raise
384.         else:
385.             self.events.emit('build-finished', None)
386.         self.builder.cleanup()
387. 
388.     # ---- general extensibility interface -------------------------------------
389. 
390.     def setup_extension(self, extname: str) -> None:
391.         """Import and setup a Sphinx extension module.
392. 
393.         Load the extension given by the module *name*.  Use this if your
394.         extension needs the features provided by another extension.  No-op if
395.         called twice.
396.         """
397.         logger.debug('[app] setting up extension: %r', extname)
398.         self.registry.load_extension(self, extname)
399. 
400.     def require_sphinx(self, version: str) -> None:
401.         """Check the Sphinx version if requested.
402. 
403.         Compare *version* (which must be a ``major.minor`` version string, e.g.
404.         ``'1.1'``) with the version of the running Sphinx, and abort the build
405.         when it is too old.
406. 
407.         .. versionadded:: 1.0
408.         """
409.         if version > sphinx.__display_version__[:3]:
410.             raise VersionRequirementError(version)
411. 
412.     # event interface
413.     def connect(self, event: str, callback: Callable, priority: int = 500) -> int:
414.         """Register *callback* to be called when *event* is emitted.
415. 
416.         For details on available core events and the arguments of callback
417.         functions, please see :ref:`events`.
418. 
419.         Registered callbacks will be invoked on event in the order of *priority* and
420.         registration.  The priority is ascending order.
421. 
422.         The method returns a "listener ID" that can be used as an argument to
423.         :meth:`disconnect`.
424. 
425.         .. versionchanged:: 3.0
426. 
427.            Support *priority*
428.         """
429.         listener_id = self.events.connect(event, callback, priority)
430.         logger.debug('[app] connecting event %r (%d): %r [id=%s]',
431.                      event, priority, callback, listener_id)
432.         return listener_id
433. 
434.     def disconnect(self, listener_id: int) -> None:
435.         """Unregister callback by *listener_id*."""
436.         logger.debug('[app] disconnecting event: [id=%s]', listener_id)
437.         self.events.disconnect(listener_id)
438. 
439.     def emit(self, event: str, *args: Any,
440.              allowed_exceptions: Tuple["Type[Exception]", ...] = ()) -> List:
441.         """Emit *event* and pass *arguments* to the callback functions.
442. 
443.         Return the return values of all callbacks as a list.  Do not emit core
444.         Sphinx events in extensions!
445. 
446.         .. versionchanged:: 3.1
447. 
448.            Added *allowed_exceptions* to specify path-through exceptions
449.         """
450.         return self.events.emit(event, *args, allowed_exceptions=allowed_exceptions)
451. 
452.     def emit_firstresult(self, event: str, *args: Any,
453.                          allowed_exceptions: Tuple["Type[Exception]", ...] = ()) -> Any:
454.         """Emit *event* and pass *arguments* to the callback functions.
455. 
456.         Return the result of the first callback that doesn't return ``None``.
457. 
458.         .. versionadded:: 0.5
459.         .. versionchanged:: 3.1
460. 
461.            Added *allowed_exceptions* to specify path-through exceptions
462.         """
463.         return self.events.emit_firstresult(event, *args,
464.                                             allowed_exceptions=allowed_exceptions)
465. 
466.     # registering addon parts
467. 
468.     def add_builder(self, builder: "Type[Builder]", override: bool = False) -> None:
469.         """Register a new builder.
470. 
471.         *builder* must be a class that inherits from
472.         :class:`~sphinx.builders.Builder`.
473. 
474.         .. versionchanged:: 1.8
475.            Add *override* keyword.
476.         """
477.         self.registry.add_builder(builder, override=override)
478. 
479.     # TODO(stephenfin): Describe 'types' parameter
480.     def add_config_value(self, name: str, default: Any, rebuild: Union[bool, str],
481.                          types: Any = ()) -> None:
482.         """Register a configuration value.
483. 
484.         This is necessary for Sphinx to recognize new values and set default
485.         values accordingly.  The *name* should be prefixed with the extension
486.         name, to avoid clashes.  The *default* value can be any Python object.
487.         The string value *rebuild* must be one of those values:
488. 
489.         * ``'env'`` if a change in the setting only takes effect when a
490.           document is parsed -- this means that the whole environment must be
491.           rebuilt.
492.         * ``'html'`` if a change in the setting needs a full rebuild of HTML
493.           documents.
494.         * ``''`` if a change in the setting will not need any special rebuild.
495. 
496.         .. versionchanged:: 0.6
497.            Changed *rebuild* from a simple boolean (equivalent to ``''`` or
498.            ``'env'``) to a string.  However, booleans are still accepted and
499.            converted internally.
500. 
501.         .. versionchanged:: 0.4
502.            If the *default* value is a callable, it will be called with the
503.            config object as its argument in order to get the default value.
504.            This can be used to implement config values whose default depends on
505.            other values.
506.         """
507.         logger.debug('[app] adding config value: %r',
508.                      (name, default, rebuild) + ((types,) if types else ()))
509.         if rebuild in (False, True):
510.             rebuild = 'env' if rebuild else ''
511.         self.config.add(name, default, rebuild, types)
512. 
513.     def add_event(self, name: str) -> None:
514.         """Register an event called *name*.
515. 
516.         This is needed to be able to emit it.
517.         """
518.         logger.debug('[app] adding event: %r', name)
519.         self.events.add(name)
520. 
521.     def set_translator(self, name: str, translator_class: "Type[nodes.NodeVisitor]",
522.                        override: bool = False) -> None:
523.         """Register or override a Docutils translator class.
524. 
525.         This is used to register a custom output translator or to replace a
526.         builtin translator.  This allows extensions to use custom translator
527.         and define custom nodes for the translator (see :meth:`add_node`).
528. 
529.         .. versionadded:: 1.3
530.         .. versionchanged:: 1.8
531.            Add *override* keyword.
532.         """
533.         self.registry.add_translator(name, translator_class, override=override)
534. 
535.     def add_node(self, node: "Type[Element]", override: bool = False,
536.                  **kwargs: Tuple[Callable, Callable]) -> None:
537.         """Register a Docutils node class.
538. 
539.         This is necessary for Docutils internals.  It may also be used in the
540.         future to validate nodes in the parsed documents.
541. 
542.         Node visitor functions for the Sphinx HTML, LaTeX, text and manpage
543.         writers can be given as keyword arguments: the keyword should be one or
544.         more of ``'html'``, ``'latex'``, ``'text'``, ``'man'``, ``'texinfo'``
545.         or any other supported translators, the value a 2-tuple of ``(visit,
546.         depart)`` methods.  ``depart`` can be ``None`` if the ``visit``
547.         function raises :exc:`docutils.nodes.SkipNode`.  Example:
548. 
549.         .. code-block:: python
550. 
551.            class math(docutils.nodes.Element): pass
552. 
553.            def visit_math_html(self, node):
554.                self.body.append(self.starttag(node, 'math'))
555.            def depart_math_html(self, node):
556.                self.body.append('</math>')
557. 
558.            app.add_node(math, html=(visit_math_html, depart_math_html))
559. 
560.         Obviously, translators for which you don't specify visitor methods will
561.         choke on the node when encountered in a document to translate.
562. 
563.         .. versionchanged:: 0.5
564.            Added the support for keyword arguments giving visit functions.
565.         """
566.         logger.debug('[app] adding node: %r', (node, kwargs))
567.         if not override and docutils.is_node_registered(node):
568.             logger.warning(__('node class %r is already registered, '
569.                               'its visitors will be overridden'),
570.                            node.__name__, type='app', subtype='add_node')
571.         docutils.register_node(node)
572.         self.registry.add_translation_handlers(node, **kwargs)
573. 
574.     def add_enumerable_node(self, node: "Type[Element]", figtype: str,
575.                             title_getter: TitleGetter = None, override: bool = False,
576.                             **kwargs: Tuple[Callable, Callable]) -> None:
577.         """Register a Docutils node class as a numfig target.
578. 
579.         Sphinx numbers the node automatically. And then the users can refer it
580.         using :rst:role:`numref`.
581. 
582.         *figtype* is a type of enumerable nodes.  Each figtypes have individual
583.         numbering sequences.  As a system figtypes, ``figure``, ``table`` and
584.         ``code-block`` are defined.  It is able to add custom nodes to these
585.         default figtypes.  It is also able to define new custom figtype if new
586.         figtype is given.
587. 
588.         *title_getter* is a getter function to obtain the title of node.  It
589.         takes an instance of the enumerable node, and it must return its title
590.         as string.  The title is used to the default title of references for
591.         :rst:role:`ref`.  By default, Sphinx searches
592.         ``docutils.nodes.caption`` or ``docutils.nodes.title`` from the node as
593.         a title.
594. 
595.         Other keyword arguments are used for node visitor functions. See the
596.         :meth:`.Sphinx.add_node` for details.
597. 
598.         .. versionadded:: 1.4
599.         """
600.         self.registry.add_enumerable_node(node, figtype, title_getter, override=override)
601.         self.add_node(node, override=override, **kwargs)
602. 
603.     def add_directive(self, name: str, cls: "Type[Directive]", override: bool = False) -> None:
604.         """Register a Docutils directive.
605. 
606.         *name* must be the prospective directive name.  *cls* is a directive
607.         class which inherits ``docutils.parsers.rst.Directive``.  For more
608.         details, see `the Docutils docs
609.         <http://docutils.sourceforge.net/docs/howto/rst-directives.html>`_ .
610. 
611.         For example, the (already existing) :rst:dir:`literalinclude` directive
612.         would be added like this:
613. 
614.         .. code-block:: python
615. 
616.            from docutils.parsers.rst import Directive, directives
617. 
618.            class LiteralIncludeDirective(Directive):
619.                has_content = True
620.                required_arguments = 1
621.                optional_arguments = 0
622.                final_argument_whitespace = True
623.                option_spec = {
624.                    'class': directives.class_option,
625.                    'name': directives.unchanged,
626.                }
627. 
628.                def run(self):
629.                    ...
630. 
631.            add_directive('literalinclude', LiteralIncludeDirective)
632. 
633.         .. versionchanged:: 0.6
634.            Docutils 0.5-style directive classes are now supported.
635.         .. deprecated:: 1.8
636.            Docutils 0.4-style (function based) directives support is deprecated.
637.         .. versionchanged:: 1.8
638.            Add *override* keyword.
639.         """
640.         logger.debug('[app] adding directive: %r', (name, cls))
641.         if not override and docutils.is_directive_registered(name):
642.             logger.warning(__('directive %r is already registered, it will be overridden'),
643.                            name, type='app', subtype='add_directive')
644. 
645.         docutils.register_directive(name, cls)
646. 
647.     def add_role(self, name: str, role: Any, override: bool = False) -> None:
648.         """Register a Docutils role.
649. 
650.         *name* must be the role name that occurs in the source, *role* the role
651.         function. Refer to the `Docutils documentation
652.         <http://docutils.sourceforge.net/docs/howto/rst-roles.html>`_ for
653.         more information.
654. 
655.         .. versionchanged:: 1.8
656.            Add *override* keyword.
657.         """
658.         logger.debug('[app] adding role: %r', (name, role))
659.         if not override and docutils.is_role_registered(name):
660.             logger.warning(__('role %r is already registered, it will be overridden'),
661.                            name, type='app', subtype='add_role')
662.         docutils.register_role(name, role)
663. 
664.     def add_generic_role(self, name: str, nodeclass: Any, override: bool = False) -> None:
665.         """Register a generic Docutils role.
666. 
667.         Register a Docutils role that does nothing but wrap its contents in the
668.         node given by *nodeclass*.
669. 
670.         .. versionadded:: 0.6
671.         .. versionchanged:: 1.8
672.            Add *override* keyword.
673.         """
674.         # Don't use ``roles.register_generic_role`` because it uses
675.         # ``register_canonical_role``.
676.         logger.debug('[app] adding generic role: %r', (name, nodeclass))
677.         if not override and docutils.is_role_registered(name):
678.             logger.warning(__('role %r is already registered, it will be overridden'),
679.                            name, type='app', subtype='add_generic_role')
680.         role = roles.GenericRole(name, nodeclass)
681.         docutils.register_role(name, role)
682. 
683.     def add_domain(self, domain: "Type[Domain]", override: bool = False) -> None:
684.         """Register a domain.
685. 
686.         Make the given *domain* (which must be a class; more precisely, a
687.         subclass of :class:`~sphinx.domains.Domain`) known to Sphinx.
688. 
689.         .. versionadded:: 1.0
690.         .. versionchanged:: 1.8
691.            Add *override* keyword.
692.         """
693.         self.registry.add_domain(domain, override=override)
694. 
695.     def add_directive_to_domain(self, domain: str, name: str,
696.                                 cls: "Type[Directive]", override: bool = False) -> None:
697.         """Register a Docutils directive in a domain.
698. 
699.         Like :meth:`add_directive`, but the directive is added to the domain
700.         named *domain*.
701. 
702.         .. versionadded:: 1.0
703.         .. versionchanged:: 1.8
704.            Add *override* keyword.
705.         """
706.         self.registry.add_directive_to_domain(domain, name, cls, override=override)
707. 
708.     def add_role_to_domain(self, domain: str, name: str, role: Union[RoleFunction, XRefRole],
709.                            override: bool = False) -> None:
710.         """Register a Docutils role in a domain.
711. 
712.         Like :meth:`add_role`, but the role is added to the domain named
713.         *domain*.
714. 
715.         .. versionadded:: 1.0
716.         .. versionchanged:: 1.8
717.            Add *override* keyword.
718.         """
719.         self.registry.add_role_to_domain(domain, name, role, override=override)
720. 
721.     def add_index_to_domain(self, domain: str, index: "Type[Index]", override: bool = False
722.                             ) -> None:
723.         """Register a custom index for a domain.
724. 
725.         Add a custom *index* class to the domain named *domain*.  *index* must
726.         be a subclass of :class:`~sphinx.domains.Index`.
727. 
728.         .. versionadded:: 1.0
729.         .. versionchanged:: 1.8
730.            Add *override* keyword.
731.         """
732.         self.registry.add_index_to_domain(domain, index)
733. 
734.     def add_object_type(self, directivename: str, rolename: str, indextemplate: str = '',
735.                         parse_node: Callable = None, ref_nodeclass: "Type[TextElement]" = None,
736.                         objname: str = '', doc_field_types: List = [], override: bool = False
737.                         ) -> None:
738.         """Register a new object type.
739. 
740.         This method is a very convenient way to add a new :term:`object` type
741.         that can be cross-referenced.  It will do this:
742. 
743.         - Create a new directive (called *directivename*) for documenting an
744.           object.  It will automatically add index entries if *indextemplate*
745.           is nonempty; if given, it must contain exactly one instance of
746.           ``%s``.  See the example below for how the template will be
747.           interpreted.
748.         - Create a new role (called *rolename*) to cross-reference to these
749.           object descriptions.
750.         - If you provide *parse_node*, it must be a function that takes a
751.           string and a docutils node, and it must populate the node with
752.           children parsed from the string.  It must then return the name of the
753.           item to be used in cross-referencing and index entries.  See the
754.           :file:`conf.py` file in the source for this documentation for an
755.           example.
756.         - The *objname* (if not given, will default to *directivename*) names
757.           the type of object.  It is used when listing objects, e.g. in search
758.           results.
759. 
760.         For example, if you have this call in a custom Sphinx extension::
761. 
762.            app.add_object_type('directive', 'dir', 'pair: %s; directive')
763. 
764.         you can use this markup in your documents::
765. 
766.            .. rst:directive:: function
767. 
768.               Document a function.
769. 
770.            <...>
771. 
772.            See also the :rst:dir:`function` directive.
773. 
774.         For the directive, an index entry will be generated as if you had prepended ::
775. 
776.            .. index:: pair: function; directive
777. 
778.         The reference node will be of class ``literal`` (so it will be rendered
779.         in a proportional font, as appropriate for code) unless you give the
780.         *ref_nodeclass* argument, which must be a docutils node class.  Most
781.         useful are ``docutils.nodes.emphasis`` or ``docutils.nodes.strong`` --
782.         you can also use ``docutils.nodes.generated`` if you want no further
783.         text decoration.  If the text should be treated as literal (e.g. no
784.         smart quote replacement), but not have typewriter styling, use
785.         ``sphinx.addnodes.literal_emphasis`` or
786.         ``sphinx.addnodes.literal_strong``.
787. 
788.         For the role content, you have the same syntactical possibilities as
789.         for standard Sphinx roles (see :ref:`xref-syntax`).
790. 
791.         .. versionchanged:: 1.8
792.            Add *override* keyword.
793.         """
794.         self.registry.add_object_type(directivename, rolename, indextemplate, parse_node,
795.                                       ref_nodeclass, objname, doc_field_types,
796.                                       override=override)
797. 
798.     def add_crossref_type(self, directivename: str, rolename: str, indextemplate: str = '',
799.                           ref_nodeclass: "Type[TextElement]" = None, objname: str = '',
800.                           override: bool = False) -> None:
801.         """Register a new crossref object type.
802. 
803.         This method is very similar to :meth:`add_object_type` except that the
804.         directive it generates must be empty, and will produce no output.
805. 
806.         That means that you can add semantic targets to your sources, and refer
807.         to them using custom roles instead of generic ones (like
808.         :rst:role:`ref`).  Example call::
809. 
810.            app.add_crossref_type('topic', 'topic', 'single: %s',
811.                                  docutils.nodes.emphasis)
812. 
813.         Example usage::
814. 
815.            .. topic:: application API
816. 
817.            The application API
818.            -------------------
819. 
820.            Some random text here.
821. 
822.            See also :topic:`this section <application API>`.
823. 
824.         (Of course, the element following the ``topic`` directive needn't be a
825.         section.)
826. 
827.         .. versionchanged:: 1.8
828.            Add *override* keyword.
829.         """
830.         self.registry.add_crossref_type(directivename, rolename,
831.                                         indextemplate, ref_nodeclass, objname,
832.                                         override=override)
833. 
834.     def add_transform(self, transform: "Type[Transform]") -> None:
835.         """Register a Docutils transform to be applied after parsing.
836. 
837.         Add the standard docutils :class:`Transform` subclass *transform* to
838.         the list of transforms that are applied after Sphinx parses a reST
839.         document.
840. 
841.         .. list-table:: priority range categories for Sphinx transforms
842.            :widths: 20,80
843. 
844.            * - Priority
845.              - Main purpose in Sphinx
846.            * - 0-99
847.              - Fix invalid nodes by docutils. Translate a doctree.
848.            * - 100-299
849.              - Preparation
850.            * - 300-399
851.              - early
852.            * - 400-699
853.              - main
854.            * - 700-799
855.              - Post processing. Deadline to modify text and referencing.
856.            * - 800-899
857.              - Collect referencing and referenced nodes. Domain processing.
858.            * - 900-999
859.              - Finalize and clean up.
860. 
861.         refs: `Transform Priority Range Categories`__
862. 
863.         __ http://docutils.sourceforge.net/docs/ref/transforms.html#transform-priority-range-categories
864.         """  # NOQA
865.         self.registry.add_transform(transform)
866. 
867.     def add_post_transform(self, transform: "Type[Transform]") -> None:
868.         """Register a Docutils transform to be applied before writing.
869. 
870.         Add the standard docutils :class:`Transform` subclass *transform* to
871.         the list of transforms that are applied before Sphinx writes a
872.         document.
873.         """
874.         self.registry.add_post_transform(transform)
875. 
876.     def add_javascript(self, filename: str, **kwargs: str) -> None:
877.         """An alias of :meth:`add_js_file`."""
878.         warnings.warn('The app.add_javascript() is deprecated. '
879.                       'Please use app.add_js_file() instead.',
880.                       RemovedInSphinx40Warning, stacklevel=2)
881.         self.add_js_file(filename, **kwargs)
882. 
883.     def add_js_file(self, filename: str, **kwargs: str) -> None:
884.         """Register a JavaScript file to include in the HTML output.
885. 
886.         Add *filename* to the list of JavaScript files that the default HTML
887.         template will include.  The filename must be relative to the HTML
888.         static path , or a full URI with scheme.  If the keyword argument
889.         ``body`` is given, its value will be added between the
890.         ``<script>`` tags. Extra keyword arguments are included as
891.         attributes of the ``<script>`` tag.
892. 
893.         Example::
894. 
895.             app.add_js_file('example.js')
896.             # => <script src="_static/example.js"></script>
897. 
898.             app.add_js_file('example.js', async="async")
899.             # => <script src="_static/example.js" async="async"></script>
900. 
901.             app.add_js_file(None, body="var myVariable = 'foo';")
902.             # => <script>var myVariable = 'foo';</script>
903. 
904.         .. versionadded:: 0.5
905. 
906.         .. versionchanged:: 1.8
907.            Renamed from ``app.add_javascript()``.
908.            And it allows keyword arguments as attributes of script tag.
909.         """
910.         self.registry.add_js_file(filename, **kwargs)
911.         if hasattr(self.builder, 'add_js_file'):
912.             self.builder.add_js_file(filename, **kwargs)  # type: ignore
913. 
914.     def add_css_file(self, filename: str, **kwargs: str) -> None:
915.         """Register a stylesheet to include in the HTML output.
916. 
917.         Add *filename* to the list of CSS files that the default HTML template
918.         will include.  The filename must be relative to the HTML static path,
919.         or a full URI with scheme.  The keyword arguments are also accepted for
920.         attributes of ``<link>`` tag.
921. 
922.         Example::
923. 
924.             app.add_css_file('custom.css')
925.             # => <link rel="stylesheet" href="_static/custom.css" type="text/css" />
926. 
927.             app.add_css_file('print.css', media='print')
928.             # => <link rel="stylesheet" href="_static/print.css"
929.             #          type="text/css" media="print" />
930. 
931.             app.add_css_file('fancy.css', rel='alternate stylesheet', title='fancy')
932.             # => <link rel="alternate stylesheet" href="_static/fancy.css"
933.             #          type="text/css" title="fancy" />
934. 
935.         .. versionadded:: 1.0
936. 
937.         .. versionchanged:: 1.6
938.            Optional ``alternate`` and/or ``title`` attributes can be supplied
939.            with the *alternate* (of boolean type) and *title* (a string)
940.            arguments. The default is no title and *alternate* = ``False``. For
941.            more information, refer to the `documentation
942.            <https://mdn.io/Web/CSS/Alternative_style_sheets>`__.
943. 
944.         .. versionchanged:: 1.8
945.            Renamed from ``app.add_stylesheet()``.
946.            And it allows keyword arguments as attributes of link tag.
947.         """
948.         logger.debug('[app] adding stylesheet: %r', filename)
949.         self.registry.add_css_files(filename, **kwargs)
950.         if hasattr(self.builder, 'add_css_file'):
951.             self.builder.add_css_file(filename, **kwargs)  # type: ignore
952. 
953.     def add_stylesheet(self, filename: str, alternate: bool = False, title: str = None
954.                        ) -> None:
955.         """An alias of :meth:`add_css_file`."""
956.         warnings.warn('The app.add_stylesheet() is deprecated. '
957.                       'Please use app.add_css_file() instead.',
958.                       RemovedInSphinx40Warning, stacklevel=2)
959. 
960.         attributes = {}  # type: Dict[str, str]
961.         if alternate:
962.             attributes['rel'] = 'alternate stylesheet'
963.         else:
964.             attributes['rel'] = 'stylesheet'
965. 
966.         if title:
967.             attributes['title'] = title
968. 
969.         self.add_css_file(filename, **attributes)
970. 
971.     def add_latex_package(self, packagename: str, options: str = None,
972.                           after_hyperref: bool = False) -> None:
973.         r"""Register a package to include in the LaTeX source code.
974. 
975.         Add *packagename* to the list of packages that LaTeX source code will
976.         include.  If you provide *options*, it will be taken to `\usepackage`
977.         declaration.  If you set *after_hyperref* truthy, the package will be
978.         loaded after ``hyperref`` package.
979. 
980.         .. code-block:: python
981. 
982.            app.add_latex_package('mypackage')
983.            # => \usepackage{mypackage}
984.            app.add_latex_package('mypackage', 'foo,bar')
985.            # => \usepackage[foo,bar]{mypackage}
986. 
987.         .. versionadded:: 1.3
988.         .. versionadded:: 3.1
989. 
990.            *after_hyperref* option.
991.         """
992.         self.registry.add_latex_package(packagename, options, after_hyperref)
993. 
994.     def add_lexer(self, alias: str, lexer: Union[Lexer, "Type[Lexer]"]) -> None:
995.         """Register a new lexer for source code.
996. 
997.         Use *lexer* to highlight code blocks with the given language *alias*.
998. 
999.         .. versionadded:: 0.6
1000.         .. versionchanged:: 2.1
1001.            Take a lexer class as an argument.  An instance of lexers are
1002.            still supported until Sphinx-3.x.
1003.         """
1004.         logger.debug('[app] adding lexer: %r', (alias, lexer))
1005.         if isinstance(lexer, Lexer):
1006.             warnings.warn('app.add_lexer() API changed; '
1007.                           'Please give lexer class instead of instance',
1008.                           RemovedInSphinx40Warning, stacklevel=2)
1009.             lexers[alias] = lexer
1010.         else:
1011.             lexer_classes[alias] = lexer
1012. 
1013.     def add_autodocumenter(self, cls: Any, override: bool = False) -> None:
1014.         """Register a new documenter class for the autodoc extension.
1015. 
1016.         Add *cls* as a new documenter class for the :mod:`sphinx.ext.autodoc`
1017.         extension.  It must be a subclass of
1018.         :class:`sphinx.ext.autodoc.Documenter`.  This allows to auto-document
1019.         new types of objects.  See the source of the autodoc module for
1020.         examples on how to subclass :class:`Documenter`.
1021. 
1022.         .. todo:: Add real docs for Documenter and subclassing
1023. 
1024.         .. versionadded:: 0.6
1025.         .. versionchanged:: 2.2
1026.            Add *override* keyword.
1027.         """
1028.         logger.debug('[app] adding autodocumenter: %r', cls)
1029.         from sphinx.ext.autodoc.directive import AutodocDirective
1030.         self.registry.add_documenter(cls.objtype, cls)
1031.         self.add_directive('auto' + cls.objtype, AutodocDirective, override=override)
1032. 
1033.     def add_autodoc_attrgetter(self, typ: "Type", getter: Callable[[Any, str, Any], Any]
1034.                                ) -> None:
1035.         """Register a new ``getattr``-like function for the autodoc extension.
1036. 
1037.         Add *getter*, which must be a function with an interface compatible to
1038.         the :func:`getattr` builtin, as the autodoc attribute getter for
1039.         objects that are instances of *typ*.  All cases where autodoc needs to
1040.         get an attribute of a type are then handled by this function instead of
1041.         :func:`getattr`.
1042. 
1043.         .. versionadded:: 0.6
1044.         """
1045.         logger.debug('[app] adding autodoc attrgetter: %r', (typ, getter))
1046.         self.registry.add_autodoc_attrgetter(typ, getter)
1047. 
1048.     def add_search_language(self, cls: Any) -> None:
1049.         """Register a new language for the HTML search index.
1050. 
1051.         Add *cls*, which must be a subclass of
1052.         :class:`sphinx.search.SearchLanguage`, as a support language for
1053.         building the HTML full-text search index.  The class must have a *lang*
1054.         attribute that indicates the language it should be used for.  See
1055.         :confval:`html_search_language`.
1056. 
1057.         .. versionadded:: 1.1
1058.         """
1059.         logger.debug('[app] adding search language: %r', cls)
1060.         from sphinx.search import languages, SearchLanguage
1061.         assert issubclass(cls, SearchLanguage)
1062.         languages[cls.lang] = cls
1063. 
1064.     def add_source_suffix(self, suffix: str, filetype: str, override: bool = False) -> None:
1065.         """Register a suffix of source files.
1066. 
1067.         Same as :confval:`source_suffix`.  The users can override this
1068.         using the setting.
1069. 
1070.         .. versionadded:: 1.8
1071.         """
1072.         self.registry.add_source_suffix(suffix, filetype, override=override)
1073. 
1074.     def add_source_parser(self, *args: Any, **kwargs: Any) -> None:
1075.         """Register a parser class.
1076. 
1077.         .. versionadded:: 1.4
1078.         .. versionchanged:: 1.8
1079.            *suffix* argument is deprecated.  It only accepts *parser* argument.
1080.            Use :meth:`add_source_suffix` API to register suffix instead.
1081.         .. versionchanged:: 1.8
1082.            Add *override* keyword.
1083.         """
1084.         self.registry.add_source_parser(*args, **kwargs)
1085. 
1086.     def add_env_collector(self, collector: "Type[EnvironmentCollector]") -> None:
1087.         """Register an environment collector class.
1088. 
1089.         Refer to :ref:`collector-api`.
1090. 
1091.         .. versionadded:: 1.6
1092.         """
1093.         logger.debug('[app] adding environment collector: %r', collector)
1094.         collector().enable(self)
1095. 
1096.     def add_html_theme(self, name: str, theme_path: str) -> None:
1097.         """Register a HTML Theme.
1098. 
1099.         The *name* is a name of theme, and *path* is a full path to the theme
1100.         (refs: :ref:`distribute-your-theme`).
1101. 
1102.         .. versionadded:: 1.6
1103.         """
1104.         logger.debug('[app] adding HTML theme: %r, %r', name, theme_path)
1105.         self.html_themes[name] = theme_path
1106. 
1107.     def add_html_math_renderer(self, name: str,
1108.                                inline_renderers: Tuple[Callable, Callable] = None,
1109.                                block_renderers: Tuple[Callable, Callable] = None) -> None:
1110.         """Register a math renderer for HTML.
1111. 
1112.         The *name* is a name of math renderer.  Both *inline_renderers* and
1113.         *block_renderers* are used as visitor functions for the HTML writer:
1114.         the former for inline math node (``nodes.math``), the latter for
1115.         block math node (``nodes.math_block``).  Regarding visitor functions,
1116.         see :meth:`add_node` for details.
1117. 
1118.         .. versionadded:: 1.8
1119. 
1120.         """
1121.         self.registry.add_html_math_renderer(name, inline_renderers, block_renderers)
1122. 
1123.     def add_message_catalog(self, catalog: str, locale_dir: str) -> None:
1124.         """Register a message catalog.
1125. 
1126.         The *catalog* is a name of catalog, and *locale_dir* is a base path
1127.         of message catalog.  For more details, see
1128.         :func:`sphinx.locale.get_translation()`.
1129. 
1130.         .. versionadded:: 1.8
1131.         """
1132.         locale.init([locale_dir], self.config.language, catalog)
1133.         locale.init_console(locale_dir, catalog)
1134. 
1135.     # ---- other methods -------------------------------------------------
1136.     def is_parallel_allowed(self, typ: str) -> bool:
1137.         """Check parallel processing is allowed or not.
1138. 
1139.         ``typ`` is a type of processing; ``'read'`` or ``'write'``.
1140.         """
1141.         if typ == 'read':
1142.             attrname = 'parallel_read_safe'
1143.             message_not_declared = __("the %s extension does not declare if it "
1144.                                       "is safe for parallel reading, assuming "
1145.                                       "it isn't - please ask the extension author "
1146.                                       "to check and make it explicit")
1147.             message_not_safe = __("the %s extension is not safe for parallel reading")
1148.         elif typ == 'write':
1149.             attrname = 'parallel_write_safe'
1150.             message_not_declared = __("the %s extension does not declare if it "
1151.                                       "is safe for parallel writing, assuming "
1152.                                       "it isn't - please ask the extension author "
1153.                                       "to check and make it explicit")
1154.             message_not_safe = __("the %s extension is not safe for parallel writing")
1155.         else:
1156.             raise ValueError('parallel type %s is not supported' % typ)
1157. 
1158.         for ext in self.extensions.values():
1159.             allowed = getattr(ext, attrname, None)
1160.             if allowed is None:
1161.                 logger.warning(message_not_declared, ext.name)
1162.                 logger.warning(__('doing serial %s'), typ)
1163.                 return False
1164.             elif not allowed:
1165.                 logger.warning(message_not_safe, ext.name)
1166.                 logger.warning(__('doing serial %s'), typ)
1167.                 return False
1168. 
1169.         return True
1170. 
1171. 
1172. class TemplateBridge:
1173.     """
1174.     This class defines the interface for a "template bridge", that is, a class
1175.     that renders templates given a template name and a context.
1176.     """
1177. 
1178.     def init(self, builder: "Builder", theme: Theme = None, dirs: List[str] = None) -> None:
1179.         """Called by the builder to initialize the template system.
1180. 
1181.         *builder* is the builder object; you'll probably want to look at the
1182.         value of ``builder.config.templates_path``.
1183. 
1184.         *theme* is a :class:`sphinx.theming.Theme` object or None; in the latter
1185.         case, *dirs* can be list of fixed directories to look for templates.
1186.         """
1187.         raise NotImplementedError('must be implemented in subclasses')
1188. 
1189.     def newest_template_mtime(self) -> float:
1190.         """Called by the builder to determine if output files are outdated
1191.         because of template changes.  Return the mtime of the newest template
1192.         file that was changed.  The default implementation returns ``0``.
1193.         """
1194.         return 0
1195. 
1196.     def render(self, template: str, context: Dict) -> None:
1197.         """Called by the builder to render a template given as a filename with
1198.         a specified context (a Python dictionary).
1199.         """
1200.         raise NotImplementedError('must be implemented in subclasses')
1201. 
1202.     def render_string(self, template: str, context: Dict) -> str:
1203.         """Called by the builder to render a template given as a string with a
1204.         specified context (a Python dictionary).
1205.         """
1206.         raise NotImplementedError('must be implemented in subclasses')


File: sphinx/locale/__init__.py
Line number range: 1 - 266
Content:
1. """
2.     sphinx.locale
3.     ~~~~~~~~~~~~~
4. 
5.     Locale utilities.
6. 
7.     :copyright: Copyright 2007-2016 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. 
11. import gettext
12. import locale
13. from collections import UserString, defaultdict
14. from gettext import NullTranslations
15. from typing import Any, Callable, Dict, Iterable, List, Optional, Tuple, Union
16. 
17. 
18. class _TranslationProxy(UserString):
19.     """
20.     Class for proxy strings from gettext translations. This is a helper for the
21.     lazy_* functions from this module.
22. 
23.     The proxy implementation attempts to be as complete as possible, so that
24.     the lazy objects should mostly work as expected, for example for sorting.
25. 
26.     This inherits from UserString because some docutils versions use UserString
27.     for their Text nodes, which then checks its argument for being either a
28.     basestring or UserString, otherwise calls str() -- not unicode() -- on it.
29.     """
30.     __slots__ = ('_func', '_args')
31. 
32.     def __new__(cls, func: Callable, *args: str) -> object:  # type: ignore
33.         if not args:
34.             # not called with "function" and "arguments", but a plain string
35.             return str(func)
36.         return object.__new__(cls)
37. 
38.     def __getnewargs__(self) -> Tuple[str]:
39.         return (self._func,) + self._args  # type: ignore
40. 
41.     def __init__(self, func: Callable, *args: str) -> None:
42.         self._func = func
43.         self._args = args
44. 
45.     @property
46.     def data(self) -> str:  # type: ignore
47.         return self._func(*self._args)
48. 
49.     # replace function from UserString; it instantiates a self.__class__
50.     # for the encoding result
51. 
52.     def encode(self, encoding: str = None, errors: str = None) -> bytes:  # type: ignore
53.         if encoding:
54.             if errors:
55.                 return self.data.encode(encoding, errors)
56.             else:
57.                 return self.data.encode(encoding)
58.         else:
59.             return self.data.encode()
60. 
61.     def __dir__(self) -> List[str]:
62.         return dir(str)
63. 
64.     def __str__(self) -> str:
65.         return str(self.data)
66. 
67.     def __add__(self, other: str) -> str:  # type: ignore
68.         return self.data + other
69. 
70.     def __radd__(self, other: str) -> str:
71.         return other + self.data
72. 
73.     def __mod__(self, other: str) -> str:  # type: ignore
74.         return self.data % other
75. 
76.     def __rmod__(self, other: str) -> str:
77.         return other % self.data
78. 
79.     def __mul__(self, other: Any) -> str:  # type: ignore
80.         return self.data * other
81. 
82.     def __rmul__(self, other: Any) -> str:
83.         return other * self.data
84. 
85.     def __getattr__(self, name: str) -> Any:
86.         if name == '__members__':
87.             return self.__dir__()
88.         return getattr(self.data, name)
89. 
90.     def __getstate__(self) -> Tuple[Callable, Tuple[str, ...]]:
91.         return self._func, self._args
92. 
93.     def __setstate__(self, tup: Tuple[Callable, Tuple[str]]) -> None:
94.         self._func, self._args = tup
95. 
96.     def __copy__(self) -> "_TranslationProxy":
97.         return self
98. 
99.     def __repr__(self) -> str:
100.         try:
101.             return 'i' + repr(str(self.data))
102.         except Exception:
103.             return '<%s broken>' % self.__class__.__name__
104. 
105. 
106. translators = defaultdict(NullTranslations)  # type: Dict[Tuple[str, str], NullTranslations]
107. 
108. 
109. def init(locale_dirs: List[str], language: str,
110.          catalog: str = 'sphinx', namespace: str = 'general') -> Tuple[NullTranslations, bool]:
111.     """Look for message catalogs in `locale_dirs` and *ensure* that there is at
112.     least a NullTranslations catalog set in `translators`. If called multiple
113.     times or if several ``.mo`` files are found, their contents are merged
114.     together (thus making ``init`` reentrant).
115.     """
116.     global translators
117.     translator = translators.get((namespace, catalog))
118.     # ignore previously failed attempts to find message catalogs
119.     if translator.__class__ is NullTranslations:
120.         translator = None
121.     # the None entry is the system's default locale path
122.     has_translation = True
123. 
124.     if language and '_' in language:
125.         # for language having country code (like "de_AT")
126.         languages = [language, language.split('_')[0]]
127.     else:
128.         languages = [language]
129. 
130.     # loading
131.     for dir_ in locale_dirs:
132.         try:
133.             trans = gettext.translation(catalog, localedir=dir_, languages=languages)
134.             if translator is None:
135.                 translator = trans
136.             else:
137.                 translator.add_fallback(trans)
138.         except Exception:
139.             # Language couldn't be found in the specified path
140.             pass
141.     # guarantee translators[(namespace, catalog)] exists
142.     if translator is None:
143.         translator = NullTranslations()
144.         has_translation = False
145.     translators[(namespace, catalog)] = translator
146.     return translator, has_translation
147. 
148. 
149. def setlocale(category: int, value: Union[str, Iterable[str]] = None) -> None:
150.     """Update locale settings.
151. 
152.     This does not throw any exception even if update fails.
153.     This is workaround for Python's bug.
154. 
155.     For more details:
156. 
157.     * https://github.com/sphinx-doc/sphinx/issues/5724
158.     * https://bugs.python.org/issue18378#msg215215
159. 
160.     .. note:: Only for internal use.  Please don't call this method from extensions.
161.               This will be removed in future.
162.     """
163.     try:
164.         locale.setlocale(category, value)
165.     except locale.Error:
166.         pass
167. 
168. 
169. def init_console(locale_dir: str, catalog: str) -> Tuple[NullTranslations, bool]:
170.     """Initialize locale for console.
171. 
172.     .. versionadded:: 1.8
173.     """
174.     try:
175.         # encoding is ignored
176.         language, _ = locale.getlocale(locale.LC_MESSAGES)  # type: Tuple[Optional[str], Any]
177.     except AttributeError:
178.         # LC_MESSAGES is not always defined. Fallback to the default language
179.         # in case it is not.
180.         language = None
181.     return init([locale_dir], language, catalog, 'console')
182. 
183. 
184. def get_translator(catalog: str = 'sphinx', namespace: str = 'general') -> NullTranslations:
185.     return translators[(namespace, catalog)]
186. 
187. 
188. def is_translator_registered(catalog: str = 'sphinx', namespace: str = 'general') -> bool:
189.     return (namespace, catalog) in translators
190. 
191. 
192. def _lazy_translate(catalog: str, namespace: str, message: str) -> str:
193.     """Used instead of _ when creating TranslationProxy, because _ is
194.     not bound yet at that time.
195.     """
196.     translator = get_translator(catalog, namespace)
197.     return translator.gettext(message)
198. 
199. 
200. def get_translation(catalog: str, namespace: str = 'general') -> Callable:
201.     """Get a translation function based on the *catalog* and *namespace*.
202. 
203.     The extension can use this API to translate the messages on the
204.     extension::
205. 
206.         import os
207.         from sphinx.locale import get_translation
208. 
209.         MESSAGE_CATALOG_NAME = 'myextension'  # name of *.pot, *.po and *.mo files
210.         _ = get_translation(MESSAGE_CATALOG_NAME)
211.         text = _('Hello Sphinx!')
212. 
213. 
214.         def setup(app):
215.             package_dir = path.abspath(path.dirname(__file__))
216.             locale_dir = os.path.join(package_dir, 'locales')
217.             app.add_message_catalog(MESSAGE_CATALOG_NAME, locale_dir)
218. 
219.     With this code, sphinx searches a message catalog from
220.     ``${package_dir}/locales/${language}/LC_MESSAGES/myextension.mo``.
221.     The :confval:`language` is used for the searching.
222. 
223.     .. versionadded:: 1.8
224.     """
225.     def gettext(message: str, *args: Any) -> str:
226.         if not is_translator_registered(catalog, namespace):
227.             # not initialized yet
228.             return _TranslationProxy(_lazy_translate, catalog, namespace, message)  # type: ignore  # NOQA
229.         else:
230.             translator = get_translator(catalog, namespace)
231.             if len(args) <= 1:
232.                 return translator.gettext(message)
233.             else:  # support pluralization
234.                 return translator.ngettext(message, args[0], args[1])
235. 
236.     return gettext
237. 
238. 
239. # A shortcut for sphinx-core
240. #: Translation function for messages on documentation (menu, labels, themes and so on).
241. #: This function follows :confval:`language` setting.
242. _ = get_translation('sphinx')
243. #: Translation function for console messages
244. #: This function follows locale setting (`LC_ALL`, `LC_MESSAGES` and so on).
245. __ = get_translation('sphinx', 'console')
246. 
247. 
248. # labels
249. admonitionlabels = {
250.     'attention': _('Attention'),
251.     'caution':   _('Caution'),
252.     'danger':    _('Danger'),
253.     'error':     _('Error'),
254.     'hint':      _('Hint'),
255.     'important': _('Important'),
256.     'note':      _('Note'),
257.     'seealso':   _('See also'),
258.     'tip':       _('Tip'),
259.     'warning':   _('Warning'),
260. }
261. 
262. # Moved to sphinx.directives.other (will be overriden later)
263. versionlabels = {}  # type: Dict[str, str]
264. 
265. # Moved to sphinx.domains.python (will be overriden later)
266. pairindextypes = {}  # type: Dict[str, str]


File: sphinx/util/i18n.py
Line number range: 1 - 333
Content:
1. """
2.     sphinx.util.i18n
3.     ~~~~~~~~~~~~~~~~
4. 
5.     Builder superclass for all builders.
6. 
7.     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.
8.     :license: BSD, see LICENSE for details.
9. """
10. import gettext
11. import os
12. import re
13. import warnings
14. from collections import namedtuple
15. from datetime import datetime, timezone
16. from os import path
17. from typing import Callable, Generator, List, Set, Tuple, Union
18. 
19. import babel.dates
20. from babel.messages.mofile import write_mo
21. from babel.messages.pofile import read_po
22. 
23. from sphinx.deprecation import RemovedInSphinx40Warning
24. from sphinx.errors import SphinxError
25. from sphinx.locale import __
26. from sphinx.util import logging
27. from sphinx.util.matching import Matcher
28. from sphinx.util.osutil import SEP, canon_path, relpath
29. 
30. if False:
31.     # For type annotation
32.     from sphinx.environment import BuildEnvironment
33. 
34. 
35. logger = logging.getLogger(__name__)
36. 
37. LocaleFileInfoBase = namedtuple('CatalogInfo', 'base_dir,domain,charset')
38. 
39. 
40. class CatalogInfo(LocaleFileInfoBase):
41. 
42.     @property
43.     def po_file(self) -> str:
44.         return self.domain + '.po'
45. 
46.     @property
47.     def mo_file(self) -> str:
48.         return self.domain + '.mo'
49. 
50.     @property
51.     def po_path(self) -> str:
52.         return path.join(self.base_dir, self.po_file)
53. 
54.     @property
55.     def mo_path(self) -> str:
56.         return path.join(self.base_dir, self.mo_file)
57. 
58.     def is_outdated(self) -> bool:
59.         return (
60.             not path.exists(self.mo_path) or
61.             path.getmtime(self.mo_path) < path.getmtime(self.po_path))
62. 
63.     def write_mo(self, locale: str) -> None:
64.         with open(self.po_path, encoding=self.charset) as file_po:
65.             try:
66.                 po = read_po(file_po, locale)
67.             except Exception as exc:
68.                 logger.warning(__('reading error: %s, %s'), self.po_path, exc)
69.                 return
70. 
71.         with open(self.mo_path, 'wb') as file_mo:
72.             try:
73.                 write_mo(file_mo, po)
74.             except Exception as exc:
75.                 logger.warning(__('writing error: %s, %s'), self.mo_path, exc)
76. 
77. 
78. class CatalogRepository:
79.     """A repository for message catalogs."""
80. 
81.     def __init__(self, basedir: str, locale_dirs: List[str],
82.                  language: str, encoding: str) -> None:
83.         self.basedir = basedir
84.         self._locale_dirs = locale_dirs
85.         self.language = language
86.         self.encoding = encoding
87. 
88.     @property
89.     def locale_dirs(self) -> Generator[str, None, None]:
90.         if not self.language:
91.             return
92. 
93.         for locale_dir in self._locale_dirs:
94.             locale_dir = path.join(self.basedir, locale_dir)
95.             if path.exists(path.join(locale_dir, self.language, 'LC_MESSAGES')):
96.                 yield locale_dir
97. 
98.     @property
99.     def pofiles(self) -> Generator[Tuple[str, str], None, None]:
100.         for locale_dir in self.locale_dirs:
101.             basedir = path.join(locale_dir, self.language, 'LC_MESSAGES')
102.             for root, dirnames, filenames in os.walk(basedir):
103.                 # skip dot-directories
104.                 for dirname in dirnames:
105.                     if dirname.startswith('.'):
106.                         dirnames.remove(dirname)
107. 
108.                 for filename in filenames:
109.                     if filename.endswith('.po'):
110.                         fullpath = path.join(root, filename)
111.                         yield basedir, relpath(fullpath, basedir)
112. 
113.     @property
114.     def catalogs(self) -> Generator[CatalogInfo, None, None]:
115.         for basedir, filename in self.pofiles:
116.             domain = canon_path(path.splitext(filename)[0])
117.             yield CatalogInfo(basedir, domain, self.encoding)
118. 
119. 
120. def find_catalog(docname: str, compaction: bool) -> str:
121.     warnings.warn('find_catalog() is deprecated.',
122.                   RemovedInSphinx40Warning, stacklevel=2)
123.     if compaction:
124.         ret = docname.split(SEP, 1)[0]
125.     else:
126.         ret = docname
127. 
128.     return ret
129. 
130. 
131. def docname_to_domain(docname: str, compation: Union[bool, str]) -> str:
132.     """Convert docname to domain for catalogs."""
133.     if isinstance(compation, str):
134.         return compation
135.     if compation:
136.         return docname.split(SEP, 1)[0]
137.     else:
138.         return docname
139. 
140. 
141. def find_catalog_files(docname: str, srcdir: str, locale_dirs: List[str],
142.                        lang: str, compaction: bool) -> List[str]:
143.     warnings.warn('find_catalog_files() is deprecated.',
144.                   RemovedInSphinx40Warning, stacklevel=2)
145.     if not(lang and locale_dirs):
146.         return []
147. 
148.     domain = find_catalog(docname, compaction)
149.     files = [gettext.find(domain, path.join(srcdir, dir_), [lang])
150.              for dir_ in locale_dirs]
151.     files = [relpath(f, srcdir) for f in files if f]
152.     return files
153. 
154. 
155. def find_catalog_source_files(locale_dirs: List[str], locale: str, domains: List[str] = None,
156.                               charset: str = 'utf-8', force_all: bool = False,
157.                               excluded: Matcher = Matcher([])) -> Set[CatalogInfo]:
158.     """
159.     :param list locale_dirs:
160.        list of path as `['locale_dir1', 'locale_dir2', ...]` to find
161.        translation catalogs. Each path contains a structure such as
162.        `<locale>/LC_MESSAGES/domain.po`.
163.     :param str locale: a language as `'en'`
164.     :param list domains: list of domain names to get. If empty list or None
165.        is specified, get all domain names. default is None.
166.     :param boolean force_all:
167.        Set True if you want to get all catalogs rather than updated catalogs.
168.        default is False.
169.     :return: [CatalogInfo(), ...]
170.     """
171.     warnings.warn('find_catalog_source_files() is deprecated.',
172.                   RemovedInSphinx40Warning, stacklevel=2)
173. 
174.     catalogs = set()  # type: Set[CatalogInfo]
175. 
176.     if not locale:
177.         return catalogs  # locale is not specified
178. 
179.     for locale_dir in locale_dirs:
180.         if not locale_dir:
181.             continue  # skip system locale directory
182. 
183.         base_dir = path.join(locale_dir, locale, 'LC_MESSAGES')
184. 
185.         if not path.exists(base_dir):
186.             continue  # locale path is not found
187. 
188.         for dirpath, dirnames, filenames in os.walk(base_dir, followlinks=True):
189.             filenames = [f for f in filenames if f.endswith('.po')]
190.             for filename in filenames:
191.                 if excluded(path.join(relpath(dirpath, base_dir), filename)):
192.                     continue
193.                 base = path.splitext(filename)[0]
194.                 domain = relpath(path.join(dirpath, base), base_dir).replace(path.sep, SEP)
195.                 if domains and domain not in domains:
196.                     continue
197.                 cat = CatalogInfo(base_dir, domain, charset)
198.                 if force_all or cat.is_outdated():
199.                     catalogs.add(cat)
200. 
201.     return catalogs
202. 
203. 
204. # date_format mappings: ustrftime() to bable.dates.format_datetime()
205. date_format_mappings = {
206.     '%a':  'EEE',     # Weekday as locale’s abbreviated name.
207.     '%A':  'EEEE',    # Weekday as locale’s full name.
208.     '%b':  'MMM',     # Month as locale’s abbreviated name.
209.     '%B':  'MMMM',    # Month as locale’s full name.
210.     '%c':  'medium',  # Locale’s appropriate date and time representation.
211.     '%-d': 'd',       # Day of the month as a decimal number.
212.     '%d':  'dd',      # Day of the month as a zero-padded decimal number.
213.     '%-H': 'H',       # Hour (24-hour clock) as a decimal number [0,23].
214.     '%H':  'HH',      # Hour (24-hour clock) as a zero-padded decimal number [00,23].
215.     '%-I': 'h',       # Hour (12-hour clock) as a decimal number [1,12].
216.     '%I':  'hh',      # Hour (12-hour clock) as a zero-padded decimal number [01,12].
217.     '%-j': 'D',       # Day of the year as a decimal number.
218.     '%j':  'DDD',     # Day of the year as a zero-padded decimal number.
219.     '%-m': 'M',       # Month as a decimal number.
220.     '%m':  'MM',      # Month as a zero-padded decimal number.
221.     '%-M': 'm',       # Minute as a decimal number [0,59].
222.     '%M':  'mm',      # Minute as a zero-padded decimal number [00,59].
223.     '%p':  'a',       # Locale’s equivalent of either AM or PM.
224.     '%-S': 's',       # Second as a decimal number.
225.     '%S':  'ss',      # Second as a zero-padded decimal number.
226.     '%U':  'WW',      # Week number of the year (Sunday as the first day of the week)
227.                       # as a zero padded decimal number. All days in a new year preceding
228.                       # the first Sunday are considered to be in week 0.
229.     '%w':  'e',       # Weekday as a decimal number, where 0 is Sunday and 6 is Saturday.
230.     '%-W': 'W',       # Week number of the year (Monday as the first day of the week)
231.                       # as a decimal number. All days in a new year preceding the first
232.                       # Monday are considered to be in week 0.
233.     '%W':  'WW',      # Week number of the year (Monday as the first day of the week)
234.                       # as a zero-padded decimal number.
235.     '%x':  'medium',  # Locale’s appropriate date representation.
236.     '%X':  'medium',  # Locale’s appropriate time representation.
237.     '%y':  'YY',      # Year without century as a zero-padded decimal number.
238.     '%Y':  'yyyy',    # Year with century as a decimal number.
239.     '%Z':  'zzzz',    # Time zone name (no characters if no time zone exists).
240.     '%%':  '%',
241. }
242. 
243. date_format_re = re.compile('(%s)' % '|'.join(date_format_mappings))
244. 
245. 
246. def babel_format_date(date: datetime, format: str, locale: str,
247.                       formatter: Callable = babel.dates.format_date) -> str:
248.     if locale is None:
249.         locale = 'en'
250. 
251.     # Check if we have the tzinfo attribute. If not we cannot do any time
252.     # related formats.
253.     if not hasattr(date, 'tzinfo'):
254.         formatter = babel.dates.format_date
255. 
256.     try:
257.         return formatter(date, format, locale=locale)
258.     except (ValueError, babel.core.UnknownLocaleError):
259.         # fallback to English
260.         return formatter(date, format, locale='en')
261.     except AttributeError:
262.         logger.warning(__('Invalid date format. Quote the string by single quote '
263.                           'if you want to output it directly: %s'), format)
264.         return format
265. 
266. 
267. def format_date(format: str, date: datetime = None, language: str = None) -> str:
268.     if date is None:
269.         # If time is not specified, try to use $SOURCE_DATE_EPOCH variable
270.         # See https://wiki.debian.org/ReproducibleBuilds/TimestampsProposal
271.         source_date_epoch = os.getenv('SOURCE_DATE_EPOCH')
272.         if source_date_epoch is not None:
273.             date = datetime.utcfromtimestamp(float(source_date_epoch))
274.         else:
275.             date = datetime.now(timezone.utc).astimezone()
276. 
277.     result = []
278.     tokens = date_format_re.split(format)
279.     for token in tokens:
280.         if token in date_format_mappings:
281.             babel_format = date_format_mappings.get(token, '')
282. 
283.             # Check if we have to use a different babel formatter then
284.             # format_datetime, because we only want to format a date
285.             # or a time.
286.             if token == '%x':
287.                 function = babel.dates.format_date
288.             elif token == '%X':
289.                 function = babel.dates.format_time
290.             else:
291.                 function = babel.dates.format_datetime
292. 
293.             result.append(babel_format_date(date, babel_format, locale=language,
294.                                             formatter=function))
295.         else:
296.             result.append(token)
297. 
298.     return "".join(result)
299. 
300. 
301. def get_image_filename_for_language(filename: str, env: "BuildEnvironment") -> str:
302.     if not env.config.language:
303.         return filename
304. 
305.     filename_format = env.config.figure_language_filename
306.     d = dict()
307.     d['root'], d['ext'] = path.splitext(filename)
308.     dirname = path.dirname(d['root'])
309.     if dirname and not dirname.endswith(path.sep):
310.         dirname += path.sep
311.     docpath = path.dirname(env.docname)
312.     if docpath and not docpath.endswith(path.sep):
313.         docpath += path.sep
314.     d['path'] = dirname
315.     d['basename'] = path.basename(d['root'])
316.     d['docpath'] = docpath
317.     d['language'] = env.config.language
318.     try:
319.         return filename_format.format(**d)
320.     except KeyError as exc:
321.         raise SphinxError('Invalid figure_language_filename: %r' % exc) from exc
322. 
323. 
324. def search_image_for_language(filename: str, env: "BuildEnvironment") -> str:
325.     if not env.config.language:
326.         return filename
327. 
328.     translated = get_image_filename_for_language(filename, env)
329.     _, abspath = env.relfn2path(translated)
330.     if path.exists(abspath):
331.         return translated
332.     else:
333.         return filename

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-12-23 10:51:50,531 - thread-139575885280960.prometheus_context_collector.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The provided context, including `sphinx/application.py`, `sphinx/locale/__init__.py`, and `sphinx/util/i18n.py`, is sufficient to understand the issue. The problem lies in the order of directories passed to the translation initialization function, which is clearly visible in `sphinx/application.py`. The user's patch correctly reorders the directories to prioritize user-provided translations. The behavior of the translation loading mechanism in `sphinx/locale/__init__.py` confirms why this change is necessary. Therefore, no additional context is required to understand and validate the fix." query='' extra_requirements='' purpose=''
2025-12-23 10:51:50,532 - thread-139575885280960.prometheus_context_collector - INFO - Successfully retrieved 3 context snippets
