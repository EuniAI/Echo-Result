{"instance_id": "sympy__sympy-24066", "repo": "sympy/sympy", "version": "1.12", "environment_setup_commit": "c6cb7c5602fa48034ab1bd43c2347a7e8488f12e", "patch_list": ["diff --git a/sympy/physics/units/unitsystem.py b/sympy/physics/units/unitsystem.py\n--- a/sympy/physics/units/unitsystem.py\n+++ b/sympy/physics/units/unitsystem.py\n@@ -190,10 +190,9 @@ def _collect_factor_and_dimension(self, expr):\n                 dim /= idim**count\n             return factor, dim\n         elif isinstance(expr, Function):\n-            fds = [self._collect_factor_and_dimension(\n-                arg) for arg in expr.args]\n-            return (expr.func(*(f[0] for f in fds)),\n-                    *(d[1] for d in fds))\n+            fds = [self._collect_factor_and_dimension(arg) for arg in expr.args]\n+            dims = [Dimension(1) if self.get_dimension_system().is_dimensionless(d[1]) else d[1] for d in fds]\n+            return (expr.func(*(f[0] for f in fds)), *dims)\n         elif isinstance(expr, Dimension):\n             return S.One, expr\n         else:\n", "diff --git a/sympy/physics/units/tests/test_si.py b/sympy/physics/units/tests/test_si.py\nnew file mode 100644\nindex 0000000000..edbcc7490c\n--- /dev/null\n+++ b/sympy/physics/units/tests/test_si.py\n@@ -0,0 +1,39 @@\n+from sympy.core.numbers import Rational\n+from sympy.functions.elementary.exponential import exp\n+from sympy.functions.elementary.miscellaneous import sqrt\n+from sympy.physics.units import second, ohm, farad\n+from sympy.physics.units.definitions import meter\n+from sympy.physics.units.definitions.dimension_definitions import Dimension\n+from sympy.physics.units.quantities import Quantity\n+from sympy.physics.units.systems import SI\n+from sympy.testing.pytest import raises\n+\n+\n+def test_check_unit_consistency():\n+    u = Quantity(\"u\")\n+    v = Quantity(\"v\")\n+    w = Quantity(\"w\")\n+\n+    u.set_global_relative_scale_factor(10, meter)\n+    v.set_global_relative_scale_factor(5, meter)\n+    w.set_global_relative_scale_factor(2, second)\n+\n+    def check_unit_consistency(expr):\n+        SI._collect_factor_and_dimension(expr)\n+\n+    raises(ValueError, lambda: check_unit_consistency(u + w))\n+    raises(ValueError, lambda: check_unit_consistency(u - w))\n+    raises(ValueError, lambda: check_unit_consistency(u + 1))\n+    raises(ValueError, lambda: check_unit_consistency(u - 1))\n+    raises(ValueError, lambda: check_unit_consistency(1 - exp(u / w)))\n+\n+\n+def test_dimensionless_exponent():\n+    \"\"\"\n+    Test from issue that SI._collect_factor_and_dimension() can\n+    properly detect that an exponent is dimensionless.\n+    \"\"\"\n+    expr = second / (ohm * farad)\n+    buggy_expr = 100 + exp(expr)\n+    _factor, dim = SI._collect_factor_and_dimension(buggy_expr)\n+    assert dim == Dimension(1)\n"], "arch": "x86_64", "base_commit": "514579c655bf22e2af14f0743376ae1d7befe345", "test_directives": ["sympy/physics/units/tests/test_si.py"], "coverage_files": ["sympy/physics/units/unitsystem.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "mpmath flake8", "pip_packages": ["mpmath==1.3.0", "flake8-comprehensions"], "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "PYTHONWARNINGS='ignore::UserWarning,ignore::SyntaxWarning' python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(sympy/physics/units/unitsystem\\.py)' bin/test -C --verbose sympy/physics/units/tests/test_si.p", "req_install_commands": ["conda create -n testbed python=3.9 mpmath flake8 -y"]}