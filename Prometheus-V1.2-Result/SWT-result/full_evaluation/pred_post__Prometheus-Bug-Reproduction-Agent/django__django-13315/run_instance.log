2025-12-07 13:37:55,115 - WARNING - Starting evaluation at 1765114675.1150506
2025-12-07 13:37:55,162 - INFO - Creating container for django__django-13315...
2025-12-07 13:37:55,191 - INFO - Container for django__django-13315 created: 3ec08d2204a08924fae2c92126799b1babe2b42318b0e1a6ac869004add1a82e
2025-12-07 13:37:55,366 - INFO - Container for django__django-13315 started: 3ec08d2204a08924fae2c92126799b1babe2b42318b0e1a6ac869004add1a82e
2025-12-07 13:37:56,561 - INFO - Git diff before:

2025-12-07 13:37:56,562 - INFO - Eval script for django__django-13315 written to eval.sh, now applying to container...
2025-12-07 13:38:07,678 - INFO - Test output for django__django-13315 written to run_instance_swt_logs/full_evaluation/pred_post__Prometheus-Bug-Reproduction-Agent/django__django-13315/test_output.txt
2025-12-07 13:38:07,760 - INFO - Git diff after:
diff --git a/django/forms/models.py b/django/forms/models.py
index 5d115458a1..0591cdf338 100644
--- a/django/forms/models.py
+++ b/django/forms/models.py
@@ -97,10 +97,18 @@ def model_to_dict(instance, fields=None, exclude=None):
 
 def apply_limit_choices_to_to_formfield(formfield):
     """Apply limit_choices_to to the formfield's queryset if needed."""
+    from django.db.models import Exists, OuterRef, Q
     if hasattr(formfield, 'queryset') and hasattr(formfield, 'get_limit_choices_to'):
         limit_choices_to = formfield.get_limit_choices_to()
-        if limit_choices_to is not None:
-            formfield.queryset = formfield.queryset.complex_filter(limit_choices_to)
+        if limit_choices_to:
+            complex_filter = limit_choices_to
+            if not isinstance(complex_filter, Q):
+                complex_filter = Q(**limit_choices_to)
+            complex_filter &= Q(pk=OuterRef('pk'))
+            # Use Exists() to avoid potential duplicates.
+            formfield.queryset = formfield.queryset.filter(
+                Exists(formfield.queryset.model._base_manager.filter(complex_filter)),
+            )
 
 
 def fields_for_model(model, fields=None, exclude=None, widgets=None,
2025-12-07 13:38:07,760 - INFO - Git diff changed after running eval script
2025-12-07 13:38:07,760 - INFO - Attempting to stop container exec.eval.x86_64.f904a9d2e0f61fc0d70077.e851bba4ae823c4c788821.124396453763728...
2025-12-07 13:38:22,993 - INFO - Attempting to remove container exec.eval.x86_64.f904a9d2e0f61fc0d70077.e851bba4ae823c4c788821.124396453763728...
2025-12-07 13:38:23,024 - INFO - Container exec.eval.x86_64.f904a9d2e0f61fc0d70077.e851bba4ae823c4c788821.124396453763728 removed.
2025-12-07 13:38:23,025 - WARNING - End of eval at 1765114703.025043
