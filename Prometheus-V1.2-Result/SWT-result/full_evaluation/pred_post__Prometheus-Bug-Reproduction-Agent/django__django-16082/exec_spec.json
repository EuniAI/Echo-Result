{"instance_id": "django__django-16082", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/django/db/models/expressions.py b/django/db/models/expressions.py\n--- a/django/db/models/expressions.py\n+++ b/django/db/models/expressions.py\n@@ -533,6 +533,7 @@ def __hash__(self):\n             Combinable.SUB,\n             Combinable.MUL,\n             Combinable.DIV,\n+            Combinable.MOD,\n         )\n     },\n     # Bitwise operators.\n", "diff --git a/tests/expressions/test_expression_operators.py b/tests/expressions/test_expression_operators.py\nnew file mode 100644\nindex 0000000000..57e1655b68\n--- /dev/null\n+++ b/tests/expressions/test_expression_operators.py\n@@ -0,0 +1,283 @@\n+import datetime\n+import pickle\n+import unittest\n+import uuid\n+from collections import namedtuple\n+from copy import deepcopy\n+from decimal import Decimal\n+from unittest import mock\n+\n+from django.core.exceptions import FieldError\n+from django.db import DatabaseError, NotSupportedError, connection\n+from django.db.models import (\n+    AutoField,\n+    Avg,\n+    BinaryField,\n+    BooleanField,\n+    Case,\n+    CharField,\n+    Count,\n+    DateField,\n+    DateTimeField,\n+    DecimalField,\n+    DurationField,\n+    Exists,\n+    Expression,\n+    ExpressionList,\n+    ExpressionWrapper,\n+    F,\n+    FloatField,\n+    Func,\n+    IntegerField,\n+    Max,\n+    Min,\n+    Model,\n+    OrderBy,\n+    OuterRef,\n+    Q,\n+    StdDev,\n+    Subquery,\n+    Sum,\n+    TimeField,\n+    UUIDField,\n+    Value,\n+    Variance,\n+    When,\n+)\n+from django.db.models.expressions import (\n+    Col,\n+    Combinable,\n+    CombinedExpression,\n+    RawSQL,\n+    Ref,\n+)\n+from django.db.models.functions import (\n+    Coalesce,\n+    Concat,\n+    Left,\n+    Length,\n+    Lower,\n+    Mod,\n+    Substr,\n+    Upper,\n+)\n+from django.db.models.sql import constants\n+from django.db.models.sql.datastructures import Join\n+from django.test import SimpleTestCase, TestCase, skipUnlessDBFeature\n+from django.test.utils import (\n+    Approximate,\n+    CaptureQueriesContext,\n+    isolate_apps,\n+    register_lookup,\n+)\n+from django.utils.deprecation import RemovedInDjango50Warning\n+from django.utils.functional import SimpleLazyObject\n+\n+from .models import (\n+    UUID,\n+    UUIDPK,\n+    Company,\n+    Employee,\n+    Experiment,\n+    Manager,\n+    Number,\n+    RemoteEmployee,\n+    Result,\n+    SimulationRun,\n+    Time,\n+)\n+\n+\n+class ExpressionOperatorTests(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.n = Number.objects.create(integer=42, float=15.5)\n+        cls.n1 = Number.objects.create(integer=-42, float=-15.5)\n+\n+    def test_lefthand_addition(self):\n+        # LH Addition of floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=F(\"integer\") + 15, float=F(\"float\") + 42.7\n+        )\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 57)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(58.200, places=3)\n+        )\n+\n+    def test_lefthand_subtraction(self):\n+        # LH Subtraction of floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=F(\"integer\") - 15, float=F(\"float\") - 42.7\n+        )\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 27)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(-27.200, places=3)\n+        )\n+\n+    def test_lefthand_multiplication(self):\n+        # Multiplication of floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=F(\"integer\") * 15, float=F(\"float\") * 42.7\n+        )\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 630)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(661.850, places=3)\n+        )\n+\n+    def test_lefthand_division(self):\n+        # LH Division of floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=F(\"integer\") / 2, float=F(\"float\") / 42.7\n+        )\n+\n+        selfassertEqual(Number.objects.get(pk=self.n.pk).integer, 21)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(0.363, places=3)\n+        )\n+\n+    def test_lefthand_modulo(self):\n+        # LH Modulo arithmetic on integers\n+        Number.objects.filter(pk=self.n.pk).update(integer=F(\"integer\") % 20)\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 2)\n+\n+    def test_lefthand_modulo_null(self):\n+        # LH Modulo arithmetic on integers.\n+        Employee.objects.create(firstname=\"John\", lastname=\"Doe\", salary=None)\n+        qs = Employee.objects.annotate(modsalary=F(\"salary\") % 20)\n+        self.assertIsNone(qs.get().salary)\n+\n+    def test_lefthand_bitwise_and(self):\n+        # LH Bitwise ands on integers\n+        Number.objects.filter(pk=self.n.pk).update(integer=F(\"integer\").bitand(56))\n+        Number.objects.filter(pk=self.n1.pk).update(integer=F(\"integer\").bitand(-56))\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 40)\n+        self.assertEqual(Number.objects.get(pk=self.n1.pk).integer, -64)\n+\n+    def test_lefthand_bitwise_left_shift_operator(self):\n+        Number.objects.update(integer=F(\"integer\").bitleftshift(2))\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 168)\n+        self.assertEqual(Number.objects.get(pk=self.n1.pk).integer, -168)\n+\n+    def test_lefthand_bitwise_right_shift_operator(self):\n+        Number.objects.update(integer=F(\"integer\").bitrightshift(2))\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 10)\n+        self.assertEqual(Number.objects.get(pk=self.n1.pk).integer, -11)\n+\n+    def test_lefthand_bitwise_or(self):\n+        # LH Bitwise or on integers\n+        Number.objects.update(integer=F(\"integer\").bitor(48))\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 58)\n+        self.assertEqual(Number.objects.get(pk=self.n1.pk).integer, -10)\n+\n+    def test_lefthand_transformed_field_bitwise_or(self):\n+        Employee.objects.create(firstname=\"Max\", lastname=\"Mustermann\")\n+        with register_lookup(CharField, Length):\n+            qs = Employee.objects.annotate(bitor=F(\"lastname__length\").bitor(48))\n+            self.assertEqual(qs.get().bitor, 58)\n+\n+    def test_lefthand_power(self):\n+        # LH Power arithmetic operation on floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=F(\"integer\") ** 2, float=F(\"float\") ** 1.5\n+        )\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 1764)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(61.02, places=2)\n+        )\n+\n+    def test_lefthand_bitwise_xor(self):\n+        Number.objects.update(integer=F(\"integer\").bitxor(48))\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 26)\n+        self.assertEqual(Number.objects.get(pk=self.n1.pk).integer, -26)\n+\n+    def test_lefthand_bitwise_xor_null(self):\n+        employee = Employee.objects.create(firstname=\"John\", lastname=\"Doe\")\n+        Employee.objects.update(salary=F(\"salary\").bitxor(48))\n+        employee.refresh_from_db()\n+        self.assertIsNone(employee.salary)\n+\n+    def test_lefthand_bitwise_xor_right_null(self):\n+        employee = Employee.objects.create(firstname=\"John\", lastname=\"Doe\", salary=48)\n+        Employee.objects.update(salary=F(\"salary\").bitxor(None))\n+        employee.refresh_from_db()\n+        self.assertIsNone(employee.salary)\n+\n+    @unittest.skipUnless(\n+        connection.vendor == \"oracle\", \"Oracle doesn't support bitwise XOR.\"\n+    )\n+    def test_lefthand_bitwise_xor_not_supported(self):\n+        msg = \"Bitwise XOR is not supported in Oracle.\"\n+        with self.assertRaisesMessage(NotSupportedError, msg):\n+            Number.objects.update(integer=F(\"integer\").bitxor(48))\n+\n+    def test_right_hand_addition(self):\n+        # Right hand operators\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=15 + F(\"integer\"), float=42.7 + F(\"float\")\n+        )\n+\n+        # RH Addition of floats and integers\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 57)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(58.200, places=3)\n+        )\n+\n+    def test_right_hand_subtraction(self):\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=15 - F(\"integer\"), float=42.7 - F(\"float\")\n+        )\n+\n+        # RH Subtraction of floats and integers\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, -27)\n+        self.assertEqual(\n+            Number.objects.get(pk=selfn.pk).float, Approximate(27.200, places=3)\n+        )\n+\n+    def test_right_hand_multiplication(self):\n+        # RH Multiplication of floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=15 * F(\"integer\"), float=42.7 * F(\"float\")\n+        )\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 630)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(661.850, places=3)\n+        )\n+\n+    def test_right_hand_division(self):\n+        # RH Division of floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=640 / F(\"integer\"), float=42.7 / F(\"float\")\n+        )\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 15)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(2.755, places=3)\n+        )\n+\n+    def test_right_hand_modulo(self):\n+        # RH Modulo arithmetic on integers\n+        Number.objects.filter(pk=self.n.pk).update(integer=69 % F(\"integer\"))\n+\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 27)\n+\n+    def test_righthand_power(self):\n+        # RH Power arithmetic operation on floats and integers\n+        Number.objects.filter(pk=self.n.pk).update(\n+            integer=2 ** F(\"integer\"), float=1.5 ** F(\"float\")\n+        )\n+        self.assertEqual(Number.objects.get(pk=self.n.pk).integer, 4398046511104)\n+        self.assertEqual(\n+            Number.objects.get(pk=self.n.pk).float, Approximate(536.308, places=3)\n+        )\n+\n+    def test_mod_decimal_field_preserves_decimal_places(self):\n+        qs = Number.objects.annotate(n_mod=Mod(\"decimal_value\", \"integer\"))\n+        resolved_field = qs.query.annotations[\"n_mod\"].output_field\n+        source_field = Number._meta.get_field(\"decimal_value\")\n+        self.assertEqual(resolved_field.decimal_places, source_field.decimal_places)\n"], "arch": "x86_64", "base_commit": "bf47c719719d0e190a99fa2e7f959d5bbb7caf8a", "test_directives": ["expressions.test_expression_operators"], "coverage_files": ["django/db/models/expressions.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/models/expressions\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 expressions.test_expression_operators", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}