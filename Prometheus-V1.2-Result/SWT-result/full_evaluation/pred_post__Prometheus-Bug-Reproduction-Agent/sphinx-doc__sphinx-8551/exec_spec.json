{"instance_id": "sphinx-doc__sphinx-8551", "repo": "sphinx-doc/sphinx", "version": "3.4", "environment_setup_commit": "3f560cd67239f75840cc7a439ab54d8509c855f6", "patch_list": ["diff --git a/sphinx/domains/python.py b/sphinx/domains/python.py\n--- a/sphinx/domains/python.py\n+++ b/sphinx/domains/python.py\n@@ -272,6 +272,8 @@ def make_xref(self, rolename: str, domain: str, target: str,\n         result = super().make_xref(rolename, domain, target,  # type: ignore\n                                    innernode, contnode, env)\n         result['refspecific'] = True\n+        result['py:module'] = env.ref_context.get('py:module')\n+        result['py:class'] = env.ref_context.get('py:class')\n         if target.startswith(('.', '~')):\n             prefix, result['reftarget'] = target[0], target[1:]\n             if prefix == '.':\ndiff --git a/sphinx/util/docfields.py b/sphinx/util/docfields.py\n--- a/sphinx/util/docfields.py\n+++ b/sphinx/util/docfields.py\n@@ -295,6 +295,7 @@ def transform(self, node: nodes.field_list) -> None:\n                         self.directive.domain,\n                         target,\n                         contnode=content[0],\n+                        env=self.directive.state.document.settings.env\n                     )\n                     if _is_single_paragraph(field_body):\n                         paragraph = cast(nodes.paragraph, field_body[0])\n", "diff --git a/tests/test_domain_py_xref_ambiguous.py b/tests/test_domain_py_xref_ambiguous.py\nnew file mode 100644\nindex 000000000..af0bdb7d3\n--- /dev/null\n+++ b/tests/test_domain_py_xref_ambiguous.py\n@@ -0,0 +1,19 @@\n+import pytest\n+\n+@pytest.mark.sphinx('dummy', testroot='domain-py-xref-type-ambiguous')\n+def test_xref_in_type_fields_ambiguous(app, status, warning):\n+    \"\"\"\n+    Tests that :type: and :rtype: resolve cross-references in the correct\n+    namespace context, avoiding ambiguity warnings, as reported in issue #8498.\n+    \"\"\"\n+    app.build()\n+    warnings = warning.getvalue()\n+\n+    # The bug causes sphinx to find multiple targets for the unqualified\n+    # type 'A' in the 'mod.submod' context, where it should only find\n+    # 'mod.submod.A'. A correct implementation should not produce these\n+    # warnings.\n+    #\n+    # We check for the specific warning message to avoid failing on unrelated\n+    # warnings in the log, which was the issue with the previous test.\n+    assert \"WARNING: more than one target found for cross-reference 'A'\" not in warnings\n"], "arch": "x86_64", "base_commit": "57ed10c68057c96491acbd3e62254ccfaf9e3861", "test_directives": ["tests/test_domain_py_xref_ambiguous.py"], "coverage_files": ["sphinx/util/docfields.py", "sphinx/domains/python.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "pip_packages": ["tox==4.16.0", "tox-current-env==0.0.11"], "install": "python -m pip install -e .[test]", "pre_install": ["sed -i 's/pytest/pytest -rA/' tox.ini", "sed -i 's/Jinja2>=2.3/Jinja2<3.0/' setup.py", "sed -i 's/sphinxcontrib-applehelp/sphinxcontrib-applehelp<=1.0.7/' setup.py", "sed -i 's/sphinxcontrib-devhelp/sphinxcontrib-devhelp<=1.0.5/' setup.py", "sed -i 's/sphinxcontrib-qthelp/sphinxcontrib-qthelp<=1.0.6/' setup.py", "sed -i 's/alabaster>=0.7,<0.8/alabaster>=0.7,<0.7.12/' setup.py", "sed -i \"s/'packaging',/'packaging', 'markupsafe<=2.0.1',/\" setup.py", "sed -i 's/sphinxcontrib-htmlhelp/sphinxcontrib-htmlhelp<=2.0.4/' setup.py", "sed -i 's/sphinxcontrib-serializinghtml/sphinxcontrib-serializinghtml<=1.1.9/' setup.py"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(sphinx/util/docfields\\.py|sphinx/domains/python\\.py)' -m tox -epy39 -v -- tests/test_domain_py_xref_ambiguous.py", "req_install_commands": ["conda create -n testbed python=3.9  -y"]}