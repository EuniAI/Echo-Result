{"instance_id": "django__django-11400", "repo": "django/django", "version": "3.0", "environment_setup_commit": "419a78300f7cd27611196e1e464d50fd0385ff27", "patch_list": ["diff --git a/django/contrib/admin/filters.py b/django/contrib/admin/filters.py\n--- a/django/contrib/admin/filters.py\n+++ b/django/contrib/admin/filters.py\n@@ -193,11 +193,17 @@ def has_output(self):\n     def expected_parameters(self):\n         return [self.lookup_kwarg, self.lookup_kwarg_isnull]\n \n-    def field_choices(self, field, request, model_admin):\n-        ordering = ()\n+    def field_admin_ordering(self, field, request, model_admin):\n+        \"\"\"\n+        Return the model admin's ordering for related field, if provided.\n+        \"\"\"\n         related_admin = model_admin.admin_site._registry.get(field.remote_field.model)\n         if related_admin is not None:\n-            ordering = related_admin.get_ordering(request)\n+            return related_admin.get_ordering(request)\n+        return ()\n+\n+    def field_choices(self, field, request, model_admin):\n+        ordering = self.field_admin_ordering(field, request, model_admin)\n         return field.get_choices(include_blank=False, ordering=ordering)\n \n     def choices(self, changelist):\n@@ -419,4 +425,5 @@ def choices(self, changelist):\n class RelatedOnlyFieldListFilter(RelatedFieldListFilter):\n     def field_choices(self, field, request, model_admin):\n         pk_qs = model_admin.get_queryset(request).distinct().values_list('%s__pk' % self.field_path, flat=True)\n-        return field.get_choices(include_blank=False, limit_choices_to={'pk__in': pk_qs})\n+        ordering = self.field_admin_ordering(field, request, model_admin)\n+        return field.get_choices(include_blank=False, limit_choices_to={'pk__in': pk_qs}, ordering=ordering)\ndiff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -825,9 +825,11 @@ def get_choices(self, include_blank=True, blank_choice=BLANK_CHOICE_DASH, limit_\n             if hasattr(self.remote_field, 'get_related_field')\n             else 'pk'\n         )\n+        qs = rel_model._default_manager.complex_filter(limit_choices_to)\n+        if ordering:\n+            qs = qs.order_by(*ordering)\n         return (blank_choice if include_blank else []) + [\n-            (choice_func(x), str(x))\n-            for x in rel_model._default_manager.complex_filter(limit_choices_to).order_by(*ordering)\n+            (choice_func(x), str(x)) for x in qs\n         ]\n \n     def value_to_string(self, obj):\ndiff --git a/django/db/models/fields/reverse_related.py b/django/db/models/fields/reverse_related.py\n--- a/django/db/models/fields/reverse_related.py\n+++ b/django/db/models/fields/reverse_related.py\n@@ -122,8 +122,11 @@ def get_choices(self, include_blank=True, blank_choice=BLANK_CHOICE_DASH, orderi\n         Analog of django.db.models.fields.Field.get_choices(), provided\n         initially for utilization by RelatedFieldListFilter.\n         \"\"\"\n+        qs = self.related_model._default_manager.all()\n+        if ordering:\n+            qs = qs.order_by(*ordering)\n         return (blank_choice if include_blank else []) + [\n-            (x.pk, str(x)) for x in self.related_model._default_manager.order_by(*ordering)\n+            (x.pk, str(x)) for x in qs\n         ]\n \n     def is_hidden(self):\n", "diff --git a/tests/admin_filters/test_related_field_ordering.py b/tests/admin_filters/test_related_field_ordering.py\nnew file mode 100644\nindex 0000000000..fa1db6a81b\n--- /dev/null\n+++ b/tests/admin_filters/test_related_field_ordering.py\n@@ -0,0 +1,103 @@\n+from django.contrib import admin\n+from django.contrib.admin.filters import RelatedOnlyFieldListFilter\n+from django.contrib.admin.sites import AdminSite\n+from django.contrib.auth.models import User\n+from django.db import models\n+from django.test import RequestFactory, TestCase\n+\n+\n+# Models defined locally for a self-contained test case.\n+class Band(models.Model):\n+    name = models.CharField(max_length=100)\n+    rank = models.IntegerField()\n+\n+    class Meta:\n+        ordering = ('name',)\n+        app_label = 'admin_filters'\n+\n+    def __str__(self):\n+        return self.name\n+\n+\n+class Song(models.Model):\n+    name = models.CharField(max_length=100)\n+    band = models.ForeignKey(Band, on_delete=models.CASCADE)\n+\n+    class Meta:\n+        app_label = 'admin_filters'\n+\n+    def __str__(self):\n+        return self.name\n+\n+\n+class RelatedFieldFilterOrderingTest(TestCase):\n+    request_factory = RequestFactory()\n+\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.superuser = User.objects.create_superuser('super', 'super@example.com', 'password')\n+        # Create bands in an order that is different from their alphabetical\n+        # and rank ordering to ensure the test isn't passing by chance.\n+        cls.band_zz = Band.objects.create(name='ZZ Top', rank=2)\n+        cls.band_acdc = Band.objects.create(name='AC/DC', rank=1)\n+        # Songs are needed for RelatedOnlyFieldListFilter to populate choices.\n+        Song.objects.create(name='La Grange', band=cls.band_zz)\n+        Song.objects.create(name='Thunderstruck', band=cls.band_acdc)\n+\n+    def test_relatedfieldlistfilter_fallback_to_meta_ordering(self):\n+        \"\"\"\n+        RelatedFieldListFilter should fall back to the ordering defined in the\n+        related model's Meta.ordering.\n+        \"\"\"\n+        class SongAdmin(admin.ModelAdmin):\n+            list_filter = ['band']\n+\n+        class BandAdmin(admin.ModelAdmin):\n+            # No ordering is specified, so Meta.ordering should be used.\n+            pass\n+\n+        site = AdminSite()\n+        site.register(Band, BandAdmin)\n+        site.register(Song, SongAdmin)\n+\n+        request = self.request_factory.get('/')\n+        request.user = self.superuser\n+        modeladmin = site._registry[Song]\n+        changelist = modeladmin.get_changelist_instance(request)\n+\n+        band_filter = changelist.get_filters(request)[0][0]\n+        choices = list(band_filter.choices(changelist))\n+\n+        # Choices should be ordered by Band.name: 'AC/DC', then 'ZZ Top'.\n+        # The bug would likely order by PK, resulting in 'ZZ Top' first.\n+        # choices[0] is 'All'.\n+        self.assertEqual(choices[1]['display'], 'AC/DC')\n+\n+    def test_relatedonlyfieldlistfilter_uses_admin_ordering(self):\n+        \"\"\"\n+        RelatedOnlyFieldListFilter should use the ordering from the related\n+        model's ModelAdmin.\n+        \"\"\"\n+        class SongAdmin(admin.ModelAdmin):\n+            list_filter = [('band', RelatedOnlyFieldListFilter)]\n+\n+        class BandAdmin(admin.ModelAdmin):\n+            ordering = ['rank']\n+\n+        site = AdminSite()\n+        site.register(Band, BandAdmin)\n+        site.register(Song, SongAdmin)\n+\n+        request = self.request_factory.get('/')\n+        request.user = self.superuser\n+        modeladmin = site._registry[Song]\n+        changelist = modeladmin.get_changelist_instance(request)\n+\n+        band_filter = changelist.get_filters(request)[0][0]\n+        choices = list(band_filter.choices(changelist))\n+\n+        # Choices should be ordered by BandAdmin.ordering ('rank'): 'AC/DC',\n+        # then 'ZZ Top'. The bug means ordering is ignored, likely falling\n+        # back to PK, which would be 'ZZ Top' first.\n+        # choices[0] is 'All'.\n+        self.assertEqual(choices[1]['display'], 'AC/DC')\n"], "arch": "x86_64", "base_commit": "1f8382d34d54061eddc41df6994e20ee38c60907", "test_directives": ["admin_filters.test_related_field_ordering"], "coverage_files": ["django/contrib/admin/filters.py", "django/db/models/fields/__init__.py", "django/db/models/fields/reverse_related.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/admin/filters\\.py|django/db/models/fields/__init__\\.py|django/db/models/fields/reverse_related\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 admin_filters.test_related_field_ordering", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref ~= 3.2\nargon2-cffi >= 16.1.0\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow != 5.4.0\npylibmc; sys.platform != 'win32'\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}