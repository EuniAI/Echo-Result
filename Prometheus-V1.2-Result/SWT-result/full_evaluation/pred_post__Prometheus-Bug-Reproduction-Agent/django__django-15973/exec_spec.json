{"instance_id": "django__django-15973", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ def _get_dependencies_for_foreign_key(app_label, model_name, field, project_stat\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n", "diff --git a/tests/migrations/test_m2m_through_migration.py b/tests/migrations/test_m2m_through_migration.py\nnew file mode 100644\nindex 0000000000..a89f25cd2a\n--- /dev/null\n+++ b/tests/migrations/test_m2m_through_migration.py\n@@ -0,0 +1,67 @@\n+from django.db import migrations, models\n+from django.db.migrations.state import ProjectState\n+\n+from .test_base import OperationTestBase\n+\n+\n+class M2MThroughSeparateAppTest(OperationTestBase):\n+    def test_m2m_through_in_separate_app_migration(self):\n+        \"\"\"\n+        Tests that applying a migration with a CreateModel operation for a model\n+        that has a ManyToManyField with a 'through' model in a separate, not-yet-\n+        migrated app does not cause an AttributeError.\n+        \"\"\"\n+        # Initial state is empty.\n+        project_state = ProjectState()\n+\n+        # 1. Simulate the migration of the 'variavel' app, which contains the\n+        # target model of the M2M relationship.\n+        project_state = self.apply_operations(\n+            \"variavel\",\n+            project_state,\n+            operations=[\n+                migrations.CreateModel(\n+                    \"VariavelModel\",\n+                    fields=[\n+                        (\"id\", models.AutoField(primary_key=True)),\n+                        (\"nome\", models.TextField(unique=True)),\n+                    ],\n+                )\n+            ],\n+        )\n+\n+        # 2. Define the migration for the 'fonte' app. This migration creates\n+        # the FonteModel, which has a ManyToManyField pointing to VariavelModel\n+        # through FonteVariavelModel. The 'through' model is specified as a\n+        # string 'app_label.ModelName' and its app ('fonte_variavel') has not\n+        # been migrated yet.\n+        fonte_operations = [\n+            migrations.CreateModel(\n+                \"FonteModel\",\n+                fields=[\n+                    (\"id\", models.AutoField(primary_key=True)),\n+                    (\"nome\", models.TextField(unique=True)),\n+                    (\n+                        \"variaveis\",\n+                        models.ManyToManyField(\n+                            to=\"variavel.VariavelModel\",\n+                            through=\"fonte_variavel.FonteVariavelModel\",\n+                        ),\n+                    ),\n+                ],\n+            ),\n+        ]\n+\n+        # 3. Apply the 'fonte' migration. This is the step that currently fails\n+        # with \"AttributeError: 'str' object has no attribute '_meta'\" because\n+        # the 'through' model reference is not resolved.\n+        self.apply_operations(\n+            \"fonte\",\n+            project_state,\n+            operations=fonte_operations,\n+        )\n+\n+        # 4. The minimal assertion is to check that the table for FonteModel\n+        # was created. This code will only be reached if the CreateModel\n+        # operation completes successfully, which will happen once the bug is fixed.\n+        self.assertTableExists(\"fonte_fontemodel\")\n"], "arch": "x86_64", "base_commit": "2480554dc4ada4ecf3f6a08e318735a2e50783f3", "test_directives": ["migrations.test_m2m_through_migration"], "coverage_files": ["django/db/migrations/autodetector.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/autodetector\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_m2m_through_migration", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}