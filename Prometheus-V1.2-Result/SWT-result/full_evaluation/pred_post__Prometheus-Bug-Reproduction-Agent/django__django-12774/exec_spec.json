{"instance_id": "django__django-12774", "repo": "django/django", "version": "3.1", "environment_setup_commit": "0668164b4ac93a5be79f5b87fae83c657124d9ab", "patch_list": ["diff --git a/django/db/models/query.py b/django/db/models/query.py\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -689,7 +689,17 @@ def in_bulk(self, id_list=None, *, field_name='pk'):\n         \"\"\"\n         assert not self.query.is_sliced, \\\n             \"Cannot use 'limit' or 'offset' with in_bulk\"\n-        if field_name != 'pk' and not self.model._meta.get_field(field_name).unique:\n+        opts = self.model._meta\n+        unique_fields = [\n+            constraint.fields[0]\n+            for constraint in opts.total_unique_constraints\n+            if len(constraint.fields) == 1\n+        ]\n+        if (\n+            field_name != 'pk' and\n+            not opts.get_field(field_name).unique and\n+            field_name not in unique_fields\n+        ):\n             raise ValueError(\"in_bulk()'s field_name must be a unique field but %r isn't.\" % field_name)\n         if id_list is not None:\n             if not id_list:\n", "diff --git a/tests/lookup/test_in_bulk_unique_constraint.py b/tests/lookup/test_in_bulk_unique_constraint.py\nnew file mode 100644\nindex 0000000000..b5c341695a\n--- /dev/null\n+++ b/tests/lookup/test_in_bulk_unique_constraint.py\n@@ -0,0 +1,30 @@\n+from django.db import models\n+from django.test import TestCase\n+\n+\n+class ArticleWithSlugConstraint(models.Model):\n+    headline = models.CharField(max_length=100)\n+    slug = models.CharField(max_length=255)\n+\n+    class Meta:\n+        app_label = 'lookup'\n+        constraints = [\n+            models.UniqueConstraint(fields=['slug'], name='%(app_label)s_%(class)s_slug_unq')\n+        ]\n+\n+    def __str__(self):\n+        return self.headline\n+\n+\n+class InBulkUniqueConstraintTest(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.a1 = ArticleWithSlugConstraint.objects.create(headline='Article 1', slug='a1')\n+        cls.a2 = ArticleWithSlugConstraint.objects.create(headline='Article 2', slug='a2')\n+\n+    def test_in_bulk_on_field_with_unique_constraint(self):\n+        \"\"\"\n+        in_bulk() should work on a field with a UniqueConstraint.\n+        \"\"\"\n+        articles = ArticleWithSlugConstraint.objects.in_bulk(field_name='slug')\n+        self.assertEqual(articles, {'a1': self.a1, 'a2': self.a2})\n"], "arch": "x86_64", "base_commit": "67f9d076cfc1858b94f9ed6d1a5ce2327dcc8d0d", "test_directives": ["lookup.test_in_bulk_unique_constraint"], "coverage_files": ["django/db/models/query.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/models/query\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 lookup.test_in_bulk_unique_constraint", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.2\nargon2-cffi >= 16.1.0\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}