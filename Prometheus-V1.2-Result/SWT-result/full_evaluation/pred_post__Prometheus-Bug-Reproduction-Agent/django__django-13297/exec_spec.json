{"instance_id": "django__django-13297", "repo": "django/django", "version": "3.2", "environment_setup_commit": "65dfb06a1ab56c238cc80f5e1c31f61210c4577d", "patch_list": ["diff --git a/django/views/generic/base.py b/django/views/generic/base.py\n--- a/django/views/generic/base.py\n+++ b/django/views/generic/base.py\n@@ -11,7 +11,7 @@\n from django.urls import reverse\n from django.utils.decorators import classonlymethod\n from django.utils.deprecation import RemovedInDjango40Warning\n-from django.utils.functional import SimpleLazyObject\n+from django.utils.functional import lazy\n \n logger = logging.getLogger('django.request')\n \n@@ -169,7 +169,6 @@ def _wrap_url_kwargs_with_deprecation_warning(url_kwargs):\n     context_kwargs = {}\n     for key, value in url_kwargs.items():\n         # Bind into function closure.\n-        @SimpleLazyObject\n         def access_value(key=key, value=value):\n             warnings.warn(\n                 'TemplateView passing URL kwargs to the context is '\n@@ -178,7 +177,7 @@ def access_value(key=key, value=value):\n                 RemovedInDjango40Warning, stacklevel=2,\n             )\n             return value\n-        context_kwargs[key] = access_value\n+        context_kwargs[key] = lazy(access_value, type(value))()\n     return context_kwargs\n \n \n", "diff --git a/tests/generic_views/test_lazy_kwarg_resolution.py b/tests/generic_views/test_lazy_kwarg_resolution.py\nnew file mode 100644\nindex 0000000000..97d87a9901\n--- /dev/null\n+++ b/tests/generic_views/test_lazy_kwarg_resolution.py\n@@ -0,0 +1,52 @@\n+from django.shortcuts import get_object_or_404\n+from django.test import TestCase, override_settings\n+from django.urls import path\n+from django.views.generic import TemplateView\n+\n+from .models import Author\n+\n+\n+# This view reproduces the bug where a SimpleLazyObject from URL kwargs\n+# causes a crash in the ORM.\n+class OfferView(TemplateView):\n+    template_name = \"generic_views/author_detail.html\"\n+\n+    def get_context_data(self, **kwargs):\n+        # This implementation follows the bug report exactly. It does not call\n+        # super() and builds the context from scratch. This avoids any\n+        # unrelated code paths that could mask the bug.\n+        offer_slug = kwargs.get(\"offer_slug\", \"\")\n+        offer = get_object_or_404(Author, slug=offer_slug)\n+        return {\"offer\": offer, \"offer_slug\": offer_slug}\n+\n+\n+# Local URLconf for this test case.\n+urlpatterns = [\n+    path(\n+        \"offers/<slug:offer_slug>/\",\n+        OfferView.as_view(),\n+        name=\"offer_view\",\n+    ),\n+]\n+\n+\n+@override_settings(ROOT_URLCONF=__name__)\n+class TemplateViewLazyKwargResolutionTest(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        # Use the Author model as a stand-in for the Account model from the\n+        # bug report, as it has the necessary 'slug' field.\n+        cls.author = Author.objects.create(name=\"Test Offer\", slug=\"test-offer-slug\")\n+\n+    def test_lazy_kwarg_in_get_context_data_orm_lookup(self):\n+        \"\"\"\n+        Tests that a lazy object from a URL kwarg is resolved before being\n+        used in a database query.\n+        \"\"\"\n+        # This request should fail with a database error if the SimpleLazyObject\n+        # from the URL is not resolved to a string before the ORM query.\n+        # In the test environment, this may present as a DeprecationWarning\n+        # being raised as an exception. A 200 response indicates the underlying\n+        # bug has been fixed.\n+        response = self.client.get(\"/offers/test-offer-slug/\")\n+        self.assertEqual(response.status_code, 200)\n"], "arch": "x86_64", "base_commit": "8954f255bbf5f4ee997fd6de62cb50fc9b5dd697", "test_directives": ["generic_views.test_lazy_kwarg_resolution"], "coverage_files": ["django/views/generic/base.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/views/generic/base\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 generic_views.test_lazy_kwarg_resolution", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}