{"instance_id": "matplotlib__matplotlib-24026", "repo": "matplotlib/matplotlib", "version": "3.6", "environment_setup_commit": "73909bcb408886a22e2b84581d6b9e6d9907c813", "patch_list": ["diff --git a/lib/matplotlib/stackplot.py b/lib/matplotlib/stackplot.py\n--- a/lib/matplotlib/stackplot.py\n+++ b/lib/matplotlib/stackplot.py\n@@ -6,6 +6,8 @@\n (https://stackoverflow.com/users/66549/doug)\n \"\"\"\n \n+import itertools\n+\n import numpy as np\n \n from matplotlib import _api\n@@ -70,7 +72,9 @@ def stackplot(axes, x, *args,\n \n     labels = iter(labels)\n     if colors is not None:\n-        axes.set_prop_cycle(color=colors)\n+        colors = itertools.cycle(colors)\n+    else:\n+        colors = (axes._get_lines.get_next_color() for _ in y)\n \n     # Assume data passed has not been 'stacked', so stack it here.\n     # We'll need a float buffer for the upcoming calculations.\n@@ -108,17 +112,16 @@ def stackplot(axes, x, *args,\n         stack += first_line\n \n     # Color between x = 0 and the first array.\n-    color = axes._get_lines.get_next_color()\n     coll = axes.fill_between(x, first_line, stack[0, :],\n-                             facecolor=color, label=next(labels, None),\n+                             facecolor=next(colors), label=next(labels, None),\n                              **kwargs)\n     coll.sticky_edges.y[:] = [0]\n     r = [coll]\n \n     # Color between array i-1 and array i\n     for i in range(len(y) - 1):\n-        color = axes._get_lines.get_next_color()\n         r.append(axes.fill_between(x, stack[i, :], stack[i + 1, :],\n-                                   facecolor=color, label=next(labels, None),\n+                                   facecolor=next(colors),\n+                                   label=next(labels, None),\n                                    **kwargs))\n     return r\n", "diff --git a/lib/matplotlib/tests/test_stackplot.py b/lib/matplotlib/tests/test_stackplot.py\nnew file mode 100644\nindex 0000000000..1c24eaf8a8\n--- /dev/null\n+++ b/lib/matplotlib/tests/test_stackplot.py\n@@ -0,0 +1,24 @@\n+import pytest\n+import numpy as np\n+import matplotlib.pyplot as plt\n+\n+def test_stackplot_cn_color():\n+    \"\"\"\n+    Test that stackplot can accept 'CN' color strings, which should be\n+    resolved against the Axes property cycler.\n+\n+    This test reproduces the bug reported in issue #14221, where passing\n+    'CN' strings to the `colors` argument of `stackplot` raises a ValueError\n+    instead of using the cycler's colors.\n+    \"\"\"\n+    fig, ax = plt.subplots()\n+    x = [1, 2, 3]\n+    y = np.array([[1, 1, 1], [1, 2, 3], [4, 3, 2]])\n+\n+    # This call raises a ValueError on the faulty code but should execute\n+    # without error when fixed.\n+    collections = ax.stackplot(x, y, colors=['C2', 'C3', 'C4'])\n+\n+    # A minimal assertion that will pass when the bug is fixed.\n+    # stackplot should return one PolyCollection for each data series.\n+    assert len(collections) == 3\n"], "arch": "x86_64", "base_commit": "14c96b510ebeba40f573e512299b1976f35b620e", "test_directives": ["lib/matplotlib/tests/test_stackplot.py"], "coverage_files": ["lib/matplotlib/stackplot.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.11", "packages": "environment.yml", "install": "python -m pip install -e .", "pre_install": ["apt-get -y update && apt-get -y upgrade && apt-get install -y imagemagick ffmpeg texlive texlive-latex-extra texlive-fonts-recommended texlive-xetex texlive-luatex cm-super dvipng"], "pip_packages": ["contourpy==1.1.0", "cycler==0.11.0", "fonttools==4.42.1", "ghostscript", "kiwisolver==1.4.5", "numpy==1.25.2", "packaging==23.1", "pillow==10.0.0", "pikepdf", "pyparsing==3.0.9", "python-dateutil==2.8.2", "six==1.16.0", "setuptools==68.1.2", "setuptools-scm==7.1.0", "typing-extensions==4.7.1"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(lib/matplotlib/stackplot\\.py)' -m pytest --no-header -rA  -p no:cacheprovider lib/matplotlib/tests/test_stackplot.py", "req_install_commands": ["cat <<'EOF_59812759871' > environment.yml\n# To set up a development environment using conda run:\n#\n#   conda env create -f environment.yml\n#   conda activate mpl-dev\n#   pip install -e .\n#\nname: testbed\nchannels:\n  - conda-forge\ndependencies:\n  # runtime dependencies\n  - cairocffi\n  - contourpy>=1.0.1\n  - cycler>=0.10.0\n  - fonttools>=4.22.0\n  - importlib-resources>=3.2.0\n  - kiwisolver>=1.0.1\n  - numpy>=1.21\n  - pillow>=6.2\n  - pybind11>=2.6.0\n  - pygobject\n  - pyparsing\n  - pyqt\n  - python-dateutil>=2.1\n  - setuptools\n  - setuptools_scm\n  - wxpython\n  # building documentation\n  - colorspacious\n  - graphviz\n  - ipython\n  - ipywidgets\n  - numpydoc>=0.8\n  - packaging\n  - pydata-sphinx-theme\n  - pyyaml\n  - sphinx>=1.8.1,!=2.0.0\n  - sphinx-copybutton\n  - sphinx-gallery>=0.10\n  - sphinx-design\n  - pip\n  - pip:\n      - mpl-sphinx-theme\n      - sphinxcontrib-svg2pdfconverter\n      - pikepdf\n  # testing\n  - coverage\n  - flake8>=3.8\n  - flake8-docstrings>=1.4.0\n  - gtk4\n  - ipykernel\n  - nbconvert[execute]!=6.0.0,!=6.0.1\n  - nbformat!=5.0.0,!=5.0.1\n  - pandas!=0.25.0\n  - psutil\n  - pre-commit\n  - pydocstyle>=5.1.0\n  - pytest!=4.6.0,!=5.4.0\n  - pytest-cov\n  - pytest-rerunfailures\n  - pytest-timeout\n  - pytest-xdist\n  - tornado\n  - pytz\n\nEOF_59812759871", "conda env create --file environment.yml", "conda activate testbed && conda install python=3.11 -y", "rm environment.yml"]}