{"instance_id": "sphinx-doc__sphinx-8269", "repo": "sphinx-doc/sphinx", "version": "3.3", "environment_setup_commit": "3b85187ffa3401e88582073c23188c147857a8a3", "patch_list": ["diff --git a/sphinx/builders/linkcheck.py b/sphinx/builders/linkcheck.py\n--- a/sphinx/builders/linkcheck.py\n+++ b/sphinx/builders/linkcheck.py\n@@ -166,6 +166,7 @@ def check_uri() -> Tuple[str, str, int]:\n                     # Read the whole document and see if #anchor exists\n                     response = requests.get(req_url, stream=True, config=self.app.config,\n                                             auth=auth_info, **kwargs)\n+                    response.raise_for_status()\n                     found = check_anchor(response, unquote(anchor))\n \n                     if not found:\n", "diff --git a/tests/test_build_linkcheck_http_error.py b/tests/test_build_linkcheck_http_error.py\nnew file mode 100644\nindex 000000000..dc5d6bd3e\n--- /dev/null\n+++ b/tests/test_build_linkcheck_http_error.py\n@@ -0,0 +1,36 @@\n+import pytest\n+from unittest import mock\n+import requests\n+\n+\n+@pytest.mark.sphinx('linkcheck', testroot='linkcheck', freshenv=True)\n+def test_http_error_with_anchor(app, status, warning):\n+    \"\"\"\n+    Test that linkcheck reports HTTP errors before checking for anchors.\n+\n+    A link to a non-existent page with an anchor should report the page's\n+    HTTP error, not a failed anchor lookup.\n+\n+    Regression test for https://github.com/sphinx-doc/sphinx/issues/8191.\n+    \"\"\"\n+    (app.srcdir / 'index.rst').write_text(\n+        '`foo <https://google.com/test.txt#test>`_'\n+    )\n+\n+    # Simulate a 404 Not Found error for the page.\n+    # The linkchecker uses a requests.Session object.\n+    error = requests.HTTPError(\n+        '404 Client Error: Not Found for url: https://google.com/test.txt'\n+    )\n+    with mock.patch('requests.Session.head', side_effect=error), \\\n+            mock.patch('requests.Session.get', side_effect=error):\n+        app.builder.build_all()\n+\n+    content = (app.outdir / 'output.txt').read_text()\n+\n+    # The bug causes an \"Anchor not found\" message. The fix should show the\n+    # underlying HTTP error instead.\n+    expected_error_message = (\n+        '404 Client Error: Not Found for url: https://google.com/test.txt'\n+    )\n+    assert expected_error_message in content\n"], "arch": "x86_64", "base_commit": "1e2ccd8f0eca0870cf6f8fce6934e2da8eba9b72", "test_directives": ["tests/test_build_linkcheck_http_error.py"], "coverage_files": ["sphinx/builders/linkcheck.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "pip_packages": ["tox==4.16.0", "tox-current-env==0.0.11"], "install": "python -m pip install -e .[test]", "pre_install": ["sed -i 's/pytest/pytest -rA/' tox.ini", "sed -i 's/Jinja2>=2.3/Jinja2<3.0/' setup.py", "sed -i 's/sphinxcontrib-applehelp/sphinxcontrib-applehelp<=1.0.7/' setup.py", "sed -i 's/sphinxcontrib-devhelp/sphinxcontrib-devhelp<=1.0.5/' setup.py", "sed -i 's/sphinxcontrib-qthelp/sphinxcontrib-qthelp<=1.0.6/' setup.py", "sed -i 's/alabaster>=0.7,<0.8/alabaster>=0.7,<0.7.12/' setup.py", "sed -i \"s/'packaging',/'packaging', 'markupsafe<=2.0.1',/\" setup.py", "sed -i 's/sphinxcontrib-htmlhelp/sphinxcontrib-htmlhelp<=2.0.4/' setup.py", "sed -i 's/sphinxcontrib-serializinghtml/sphinxcontrib-serializinghtml<=1.1.9/' setup.py"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(sphinx/builders/linkcheck\\.py)' -m tox -epy39 -v -- tests/test_build_linkcheck_http_error.py", "req_install_commands": ["conda create -n testbed python=3.9  -y"]}