{"instance_id": "django__django-16139", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/django/contrib/auth/forms.py b/django/contrib/auth/forms.py\n--- a/django/contrib/auth/forms.py\n+++ b/django/contrib/auth/forms.py\n@@ -163,7 +163,9 @@ def __init__(self, *args, **kwargs):\n         super().__init__(*args, **kwargs)\n         password = self.fields.get(\"password\")\n         if password:\n-            password.help_text = password.help_text.format(\"../password/\")\n+            password.help_text = password.help_text.format(\n+                f\"../../{self.instance.pk}/password/\"\n+            )\n         user_permissions = self.fields.get(\"user_permissions\")\n         if user_permissions:\n             user_permissions.queryset = user_permissions.queryset.select_related(\n", "diff --git a/tests/auth_tests/test_password_change_link.py b/tests/auth_tests/test_password_change_link.py\nnew file mode 100644\nindex 0000000000..0d9cf49162\n--- /dev/null\n+++ b/tests/auth_tests/test_password_change_link.py\n@@ -0,0 +1,59 @@\n+from unittest import mock\n+\n+from django.contrib import admin\n+from django.contrib.admin.options import TO_FIELD_VAR\n+from django.contrib.auth.admin import UserAdmin\n+from django.contrib.auth.models import User\n+from django.db import models\n+from django.test import TestCase\n+from django.urls import reverse\n+\n+\n+# A model that refers to User via a non-PK `to_field` to make the admin\n+# validation pass. It needs to be defined at the module level for the test\n+# runner to create its DB table.\n+class UserReferrer(models.Model):\n+    user = models.ForeignKey(User, on_delete=models.CASCADE, to_field=\"username\")\n+\n+    class Meta:\n+        # Place the model in an app that's part of the test environment.\n+        app_label = \"auth\"\n+\n+\n+class UserReferrerAdmin(admin.ModelAdmin):\n+    pass\n+\n+\n+class UserAdminPasswordLinkTest(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.superuser = User.objects.create_superuser(\n+            \"super\", \"super@example.com\", \"password\"\n+        )\n+        cls.user_to_edit = User.objects.create_user(\n+            \"testuser\", \"test@example.com\", \"password\"\n+        )\n+\n+    def setUp(self):\n+        self.client.login(username=\"super\", password=\"password\")\n+        # Register a dummy model admin that refers to User via `to_field`\n+        # to satisfy the admin's security check.\n+        admin.site.register(UserReferrer, UserReferrerAdmin)\n+        self.addCleanup(admin.site.unregister, UserReferrer)\n+\n+    def test_password_change_link_with_to_field(self):\n+        \"\"\"\n+        The password change link on the user change form is correct when the\n+        user is accessed via a `to_field` URL.\n+        \"\"\"\n+        change_url = reverse(\"admin:auth_user_change\", args=[self.user_to_edit.username])\n+        response = self.client.get(f\"{change_url}?{TO_FIELD_VAR}=username\")\n+\n+        self.assertEqual(response.status_code, 200)\n+\n+        # The password help text contains the link. With the bug, the href is\n+        # \"../password/\", which resolves incorrectly relative to a to_field URL.\n+        # The fix changes it to `../../<pk>/password/`. We assert the correct\n+        # link is present, which will fail until the bug is fixed.\n+        expected_link = f'<a href=\"../../{self.user_to_edit.pk}/password/\">this form</a>'\n+        self.assertContains(response, expected_link)\n"], "arch": "x86_64", "base_commit": "d559cb02da30f74debbb1fc3a46de0df134d2d80", "test_directives": ["auth_tests.test_password_change_link"], "coverage_files": ["django/contrib/auth/forms.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/auth/forms\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 auth_tests.test_password_change_link", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}