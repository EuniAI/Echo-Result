{"instance_id": "psf__requests-1921", "repo": "psf/requests", "version": "2.3", "environment_setup_commit": "3eb69be879063de4803f7f0152b83738a1c95ca4", "patch_list": ["diff --git a/requests/sessions.py b/requests/sessions.py\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -59,6 +59,8 @@ def merge_setting(request_setting, session_setting, dict_class=OrderedDict):\n         if v is None:\n             del merged_setting[k]\n \n+    merged_setting = dict((k, v) for (k, v) in merged_setting.items() if v is not None)\n+\n     return merged_setting\n \n \n", "diff --git a/test_issue_1483.py b/test_issue_1483.py\nnew file mode 100644\nindex 00000000..0112d4de\n--- /dev/null\n+++ b/test_issue_1483.py\n@@ -0,0 +1,65 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+\n+\"\"\"Tests for Requests.\"\"\"\n+\n+from __future__ import division\n+import json\n+import os\n+import pickle\n+import unittest\n+from unittest.mock import patch\n+\n+import requests\n+import pytest\n+from requests.adapters import HTTPAdapter\n+from requests.auth import HTTPDigestAuth\n+from requests.compat import (\n+    Morsel, cookielib, getproxies, str, urljoin, urlparse)\n+from requests.cookies import cookiejar_from_dict, morsel_to_cookie\n+from requests.exceptions import InvalidURL, MissingSchema\n+from requests.structures import CaseInsensitiveDict\n+\n+try:\n+    import StringIO\n+except ImportError:\n+    import io as StringIO\n+\n+HTTPBIN = os.environ.get('HTTPBIN_URL', 'http://httpbin.org/')\n+# Issue #1483: Make sure the URL always has a trailing slash\n+HTTPBIN = HTTPBIN.rstrip('/') + '/'\n+\n+\n+def httpbin(*suffix):\n+    \"\"\"Returns url for HTTPBIN resource.\"\"\"\n+    return urljoin(HTTPBIN, '/'.join(suffix))\n+\n+\n+class RequestsTestCase(unittest.TestCase):\n+\n+    @patch('requests.adapters.HTTPAdapter.send')\n+    def test_setting_session_header_to_none_removes_it(self, mock_send):\n+        \"\"\"\n+        Test for issue #1483.\n+\n+        Verifies that setting a header value to None on a session object\n+        correctly removes that header from the prepared request.\n+        \"\"\"\n+        # Create a dummy Response to return from the mock. This prevents\n+        # requests from crashing during redirect handling.\n+        dummy_response = requests.Response()\n+        dummy_response.status_code = 200\n+        dummy_response.url = httpbin('get')\n+        mock_send.return_value = dummy_response\n+\n+        session = requests.Session()\n+        session.headers['Accept-Encoding'] = None\n+\n+        session.get(httpbin('get'))\n+\n+        # The request that would have been sent is the first argument to the mock.\n+        prepared_request = mock_send.call_args[0][0]\n+\n+        # The bug is that 'Accept-Encoding' is present in the headers\n+        # (with a value of None), when it should have been removed.\n+        assert 'Accept-Encoding' not in prepared_request.headers\n"], "arch": "x86_64", "base_commit": "3c88e520da24ae6f736929a750876e7654accc3d", "test_directives": ["test_issue_1483.py"], "coverage_files": ["requests/sessions.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "pytest", "install": "python -m pip install ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(requests/sessions\\.py)' -m pytest --no-header -rA  -p no:cacheprovider test_issue_1483.py", "req_install_commands": ["conda create -n testbed python=3.9 pytest -y"]}