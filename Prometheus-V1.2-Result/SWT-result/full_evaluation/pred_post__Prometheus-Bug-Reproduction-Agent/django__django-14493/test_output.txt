+ source /opt/miniconda3/bin/activate
++ _CONDA_ROOT=/opt/miniconda3
++ . /opt/miniconda3/etc/profile.d/conda.sh
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ '[' -z '' ']'
+++ export CONDA_SHLVL=0
+++ CONDA_SHLVL=0
+++ '[' -n '' ']'
+++++ dirname /opt/miniconda3/bin/conda
++++ dirname /opt/miniconda3/bin
+++ PATH=/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export PATH
+++ '[' -z '' ']'
+++ PS1=
++ conda activate
++ local cmd=activate
++ case "$cmd" in
++ __conda_activate activate
++ '[' -n '' ']'
++ local ask_conda
+++ PS1=
+++ __conda_exe shell.posix activate
+++ /opt/miniconda3/bin/conda shell.posix activate
++ ask_conda='PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''1'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ eval 'PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''1'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+++ PS1='(base) '
+++ export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export CONDA_PREFIX=/opt/miniconda3
+++ CONDA_PREFIX=/opt/miniconda3
+++ export CONDA_SHLVL=1
+++ CONDA_SHLVL=1
+++ export CONDA_DEFAULT_ENV=base
+++ CONDA_DEFAULT_ENV=base
+++ export 'CONDA_PROMPT_MODIFIER=(base) '
+++ CONDA_PROMPT_MODIFIER='(base) '
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ __conda_hashr
++ '[' -n '' ']'
++ '[' -n '' ']'
++ hash -r
+ conda activate testbed
+ local cmd=activate
+ case "$cmd" in
+ __conda_activate activate testbed
+ '[' -n '' ']'
+ local ask_conda
++ PS1='(base) '
++ __conda_exe shell.posix activate testbed
++ /opt/miniconda3/bin/conda shell.posix activate testbed
+ ask_conda='PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''2'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_1='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+ eval 'PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''2'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_1='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ PS1='(testbed) '
++ export PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ export CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ export CONDA_SHLVL=2
++ CONDA_SHLVL=2
++ export CONDA_DEFAULT_ENV=testbed
++ CONDA_DEFAULT_ENV=testbed
++ export 'CONDA_PROMPT_MODIFIER=(testbed) '
++ CONDA_PROMPT_MODIFIER='(testbed) '
++ export CONDA_PREFIX_1=/opt/miniconda3
++ CONDA_PREFIX_1=/opt/miniconda3
++ export CONDA_EXE=/opt/miniconda3/bin/conda
++ CONDA_EXE=/opt/miniconda3/bin/conda
++ export _CE_M=
++ _CE_M=
++ export _CE_CONDA=
++ _CE_CONDA=
++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+ __conda_hashr
+ '[' -n '' ']'
+ '[' -n '' ']'
+ hash -r
+ cd /testbed
+ git diff HEAD 7272e1963ffdf39c1d4fe225d5425a45dd095d11
+ git config --global --add safe.directory /testbed
+ cd /testbed
+ git status
On branch main
nothing to commit, working tree clean
+ git show
commit 7272e1963ffdf39c1d4fe225d5425a45dd095d11
Author: Chris Jerdonek <chris.jerdonek@gmail.com>
Date:   Sat Jun 5 23:56:34 2021 -0700

    Fixed #32821 -- Updated os.scandir() uses to use a context manager.

diff --git a/django/core/files/storage.py b/django/core/files/storage.py
index 7097dc9585..fcc382b6fc 100644
--- a/django/core/files/storage.py
+++ b/django/core/files/storage.py
@@ -321,11 +321,12 @@ class FileSystemStorage(Storage):
     def listdir(self, path):
         path = self.path(path)
         directories, files = [], []
-        for entry in os.scandir(path):
-            if entry.is_dir():
-                directories.append(entry.name)
-            else:
-                files.append(entry.name)
+        with os.scandir(path) as entries:
+            for entry in entries:
+                if entry.is_dir():
+                    directories.append(entry.name)
+                else:
+                    files.append(entry.name)
         return directories, files
 
     def path(self, name):
diff --git a/django/forms/fields.py b/django/forms/fields.py
index daa65d61eb..57886656de 100644
--- a/django/forms/fields.py
+++ b/django/forms/fields.py
@@ -1111,13 +1111,15 @@ class FilePathField(ChoiceField):
                             self.choices.append((f, f.replace(path, "", 1)))
         else:
             choices = []
-            for f in os.scandir(self.path):
-                if f.name == '__pycache__':
-                    continue
-                if (((self.allow_files and f.is_file()) or
-                        (self.allow_folders and f.is_dir())) and
-                        (self.match is None or self.match_re.search(f.name))):
-                    choices.append((f.path, f.name))
+            with os.scandir(self.path) as entries:
+                for f in entries:
+                    if f.name == '__pycache__':
+                        continue
+                    if ((
+                        (self.allow_files and f.is_file()) or
+                        (self.allow_folders and f.is_dir())
+                    ) and (self.match is None or self.match_re.search(f.name))):
+                        choices.append((f.path, f.name))
             choices.sort(key=operator.itemgetter(1))
             self.choices.extend(choices)
 
diff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py
index bb7506c052..a590ff4398 100644
--- a/tests/migrations/test_writer.py
+++ b/tests/migrations/test_writer.py
@@ -462,7 +462,8 @@ class WriterTests(SimpleTestCase):
         self.assertIn('import pathlib', imports)
 
     def test_serialize_path_like(self):
-        path_like = list(os.scandir(os.path.dirname(__file__)))[0]
+        with os.scandir(os.path.dirname(__file__)) as entries:
+            path_like = list(entries)[0]
         expected = (repr(path_like.path), {})
         self.assertSerializedResultEqual(path_like, expected)
 
diff --git a/tests/runtests.py b/tests/runtests.py
index 375b1c6d45..eef7afa7c1 100755
--- a/tests/runtests.py
+++ b/tests/runtests.py
@@ -127,18 +127,19 @@ def get_test_modules():
     for dirname in discovery_dirs:
         dirpath = os.path.join(RUNTESTS_DIR, dirname)
         subdirs_to_skip = SUBDIRS_TO_SKIP[dirname]
-        for f in os.scandir(dirpath):
-            if (
-                '.' in f.name or
-                os.path.basename(f.name) in subdirs_to_skip or
-                f.is_file() or
-                not os.path.exists(os.path.join(f.path, '__init__.py'))
-            ):
-                continue
-            test_module = f.name
-            if dirname:
-                test_module = dirname + '.' + test_module
-            yield test_module
+        with os.scandir(dirpath) as entries:
+            for f in entries:
+                if (
+                    '.' in f.name or
+                    os.path.basename(f.name) in subdirs_to_skip or
+                    f.is_file() or
+                    not os.path.exists(os.path.join(f.path, '__init__.py'))
+                ):
+                    continue
+                test_module = f.name
+                if dirname:
+                    test_module = dirname + '.' + test_module
+                yield test_module
 
 
 def get_installed():
diff --git a/tests/staticfiles_tests/storage.py b/tests/staticfiles_tests/storage.py
index e94534fff0..79f406ca6c 100644
--- a/tests/staticfiles_tests/storage.py
+++ b/tests/staticfiles_tests/storage.py
@@ -39,11 +39,12 @@ class PathNotImplementedStorage(storage.Storage):
     def listdir(self, path):
         path = self._path(path)
         directories, files = [], []
-        for entry in os.scandir(path):
-            if entry.is_dir():
-                directories.append(entry.name)
-            else:
-                files.append(entry.name)
+        with os.scandir(path) as entries:
+            for entry in entries:
+                if entry.is_dir():
+                    directories.append(entry.name)
+                else:
+                    files.append(entry.name)
         return directories, files
 
     def delete(self, name):
diff --git a/tests/utils_tests/test_archive.py b/tests/utils_tests/test_archive.py
index 4eb47d2fad..10f8e56198 100644
--- a/tests/utils_tests/test_archive.py
+++ b/tests/utils_tests/test_archive.py
@@ -32,20 +32,21 @@ class TestArchive(unittest.TestCase):
         os.chdir(self.old_cwd)
 
     def test_extract_function(self):
-        for entry in os.scandir(self.testdir):
-            with self.subTest(entry.name), tempfile.TemporaryDirectory() as tmpdir:
-                if (
-                    (entry.name.endswith('.bz2') and not HAS_BZ2) or
-                    (entry.name.endswith(('.lzma', '.xz')) and not HAS_LZMA)
-                ):
-                    continue
-                archive.extract(entry.path, tmpdir)
-                self.assertTrue(os.path.isfile(os.path.join(tmpdir, '1')))
-                self.assertTrue(os.path.isfile(os.path.join(tmpdir, '2')))
-                self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', '1')))
-                self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', '2')))
-                self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', 'bar', '1')))
-                self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', 'bar', '2')))
+        with os.scandir(self.testdir) as entries:
+            for entry in entries:
+                with self.subTest(entry.name), tempfile.TemporaryDirectory() as tmpdir:
+                    if (
+                        (entry.name.endswith('.bz2') and not HAS_BZ2) or
+                        (entry.name.endswith(('.lzma', '.xz')) and not HAS_LZMA)
+                    ):
+                        continue
+                    archive.extract(entry.path, tmpdir)
+                    self.assertTrue(os.path.isfile(os.path.join(tmpdir, '1')))
+                    self.assertTrue(os.path.isfile(os.path.join(tmpdir, '2')))
+                    self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', '1')))
+                    self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', '2')))
+                    self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', 'bar', '1')))
+                    self.assertTrue(os.path.isfile(os.path.join(tmpdir, 'foo', 'bar', '2')))
 
     @unittest.skipIf(sys.platform == 'win32', 'Python on Windows has a limited os.chmod().')
     def test_extract_file_permissions(self):
@@ -53,21 +54,23 @@ class TestArchive(unittest.TestCase):
         mask = stat.S_IRWXU | stat.S_IRWXG | stat.S_IRWXO
         umask = os.umask(0)
         os.umask(umask)  # Restore the original umask.
-        for entry in os.scandir(self.testdir):
-            if (
-                entry.name.startswith('leadpath_') or
-                (entry.name.endswith('.bz2') and not HAS_BZ2) or
-                (entry.name.endswith(('.lzma', '.xz')) and not HAS_LZMA)
-            ):
-                continue
-            with self.subTest(entry.name), tempfile.TemporaryDirectory() as tmpdir:
-                archive.extract(entry.path, tmpdir)
-                # An executable file in the archive has executable permissions.
-                filepath = os.path.join(tmpdir, 'executable')
-                self.assertEqual(os.stat(filepath).st_mode & mask, 0o775)
-                # A file is readable even if permission data is missing.
-                filepath = os.path.join(tmpdir, 'no_permissions')
-                self.assertEqual(os.stat(filepath).st_mode & mask, 0o666 & ~umask)
+        with os.scandir(self.testdir) as entries:
+            for entry in entries:
+                if (
+                    entry.name.startswith('leadpath_') or
+                    (entry.name.endswith('.bz2') and not HAS_BZ2) or
+                    (entry.name.endswith(('.lzma', '.xz')) and not HAS_LZMA)
+                ):
+                    continue
+                with self.subTest(entry.name), tempfile.TemporaryDirectory() as tmpdir:
+                    archive.extract(entry.path, tmpdir)
+                    # An executable file in the archive has executable
+                    # permissions.
+                    filepath = os.path.join(tmpdir, 'executable')
+                    self.assertEqual(os.stat(filepath).st_mode & mask, 0o775)
+                    # A file is readable even if permission data is missing.
+                    filepath = os.path.join(tmpdir, 'no_permissions')
+                    self.assertEqual(os.stat(filepath).st_mode & mask, 0o666 & ~umask)
 
 
 class TestArchiveInvalid(SimpleTestCase):
+ git diff 7272e1963ffdf39c1d4fe225d5425a45dd095d11
+ source /opt/miniconda3/bin/activate
++ _CONDA_ROOT=/opt/miniconda3
++ . /opt/miniconda3/etc/profile.d/conda.sh
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ '[' -z x ']'
++ conda activate
++ local cmd=activate
++ case "$cmd" in
++ __conda_activate activate
++ '[' -n '' ']'
++ local ask_conda
+++ PS1='(testbed) '
+++ __conda_exe shell.posix activate
+++ /opt/miniconda3/bin/conda shell.posix activate
++ ask_conda='PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''3'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_PREFIX_2='\''/opt/miniconda3/envs/testbed'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ eval 'PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''3'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_PREFIX_2='\''/opt/miniconda3/envs/testbed'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+++ PS1='(base) '
+++ export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export CONDA_PREFIX=/opt/miniconda3
+++ CONDA_PREFIX=/opt/miniconda3
+++ export CONDA_SHLVL=3
+++ CONDA_SHLVL=3
+++ export CONDA_DEFAULT_ENV=base
+++ CONDA_DEFAULT_ENV=base
+++ export 'CONDA_PROMPT_MODIFIER=(base) '
+++ CONDA_PROMPT_MODIFIER='(base) '
+++ export CONDA_PREFIX_2=/opt/miniconda3/envs/testbed
+++ CONDA_PREFIX_2=/opt/miniconda3/envs/testbed
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ __conda_hashr
++ '[' -n '' ']'
++ '[' -n '' ']'
++ hash -r
+ conda activate testbed
+ local cmd=activate
+ case "$cmd" in
+ __conda_activate activate testbed
+ '[' -n '' ']'
+ local ask_conda
++ PS1='(base) '
++ __conda_exe shell.posix activate testbed
++ /opt/miniconda3/bin/conda shell.posix activate testbed
+ ask_conda='PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''4'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_3='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+ eval 'PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''4'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_3='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ PS1='(testbed) '
++ export PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ export CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ export CONDA_SHLVL=4
++ CONDA_SHLVL=4
++ export CONDA_DEFAULT_ENV=testbed
++ CONDA_DEFAULT_ENV=testbed
++ export 'CONDA_PROMPT_MODIFIER=(testbed) '
++ CONDA_PROMPT_MODIFIER='(testbed) '
++ export CONDA_PREFIX_3=/opt/miniconda3
++ CONDA_PREFIX_3=/opt/miniconda3
++ export CONDA_EXE=/opt/miniconda3/bin/conda
++ CONDA_EXE=/opt/miniconda3/bin/conda
++ export _CE_M=
++ _CE_M=
++ export _CE_CONDA=
++ _CE_CONDA=
++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+ __conda_hashr
+ '[' -n '' ']'
+ '[' -n '' ']'
+ hash -r
+ python -m pip install -e .
Obtaining file:///testbed
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Checking if build backend supports build_editable: started
  Checking if build backend supports build_editable: finished with status 'done'
  Getting requirements to build editable: started
  Getting requirements to build editable: finished with status 'done'
  Preparing editable metadata (pyproject.toml): started
  Preparing editable metadata (pyproject.toml): finished with status 'done'
Requirement already satisfied: asgiref>=3.3.2 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0.dev20210607045242) (3.8.1)
Requirement already satisfied: pytz in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0.dev20210607045242) (2025.2)
Requirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0.dev20210607045242) (0.5.3)
Requirement already satisfied: typing-extensions>=4 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from asgiref>=3.3.2->Django==4.0.dev20210607045242) (4.13.2)
Building wheels for collected packages: Django
  Building editable for Django (pyproject.toml): started
  Building editable for Django (pyproject.toml): finished with status 'done'
  Created wheel for Django: filename=django-4.0.dev20210607045242-0.editable-py3-none-any.whl size=26145 sha256=d33c36161527c49710a20fd945a431ce842cfd4e1a78f3767835681255111a56
  Stored in directory: /tmp/pip-ephem-wheel-cache-2koykxeb/wheels/b2/50/f1/218f2e9962a80d01a4b1297698978f9fb3b60056aa24343f24
Successfully built Django
Installing collected packages: Django
  Attempting uninstall: Django
    Found existing installation: Django 4.0.dev20210607045242
    Uninstalling Django-4.0.dev20210607045242:
      Successfully uninstalled Django-4.0.dev20210607045242
Successfully installed Django-4.0.dev20210607045242
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable.It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.
+ git apply -v -
Checking patch django/contrib/staticfiles/storage.py...
Applied patch django/contrib/staticfiles/storage.py cleanly.
+ git apply -v -
Checking patch tests/staticfiles_tests/test_max_post_process_passes.py...
Applied patch tests/staticfiles_tests/test_max_post_process_passes.py cleanly.
+ python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/staticfiles/storage\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 staticfiles_tests.test_max_post_process_passes
test_max_post_process_passes_zero (staticfiles_tests.test_max_post_process_passes.TestMaxPostProcessPasses)
collectstatic with ManifestStaticFilesStorage shouldn't crash when ... ['--count', '-C', 'coverage.cover', '--include-pattern', '/testbed/(django/contrib/staticfiles/storage\\.py)']
Testing against Django installed in '/testbed/django'
Importing application staticfiles_tests
Found 1 test(s).
Skipping setup of unused database(s): default, other.
System check identified no issues (0 silenced).
ok

----------------------------------------------------------------------
Ran 1 test in 0.110s

OK
+ cat coverage.cover
{"/testbed/django/contrib/staticfiles/storage.py": {"1": 1, "2": 1, "3": 1, "4": 1, "5": 1, "6": 1, "8": 1, "9": 1, "10": 1, "11": 1, "12": 1, "13": 1, "16": 2, "44": 2, "398": 2, "461": 2, "469": 2, "474": 1, "23": 1, "36": 1, "24": 1, "25": 1, "26": 1, "27": 1, "28": 1, "29": 1, "32": 1, "33": 0, "34": 0, "37": 236, "38": 0, "41": 236, "45": 1, "46": 1, "47": 1, "71": 1, "73": 1, "86": 1, "97": 1, "130": 1, "161": 1, "167": 1, "224": 1, "284": 1, "356": 1, "359": 1, "362": 1, "374": 1, "74": 1, "75": 1, "76": 1, "77": 3, "78": 8, "79": 6, "80": 5, "82": 1, "83": 6, "84": 6, "90": 68, "91": 0, "92": 68, "93": 132, "94": 64, "95": 68, "100": 68, "101": 68, "102": 68, "103": 68, "104": 68, "105": 7, "106": 0, "107": 7, "108": 7, "109": 0, "111": 0, "112": 68, "113": 68, "115": 68, "116": 7, "117": 68, "118": 68, "119": 68, "120": 136, "121": 68, "122": 68, "123": 68, "126": 68, "127": 0, "128": 68, "134": 30, "135": 0, "137": 30, "138": 30, "139": 2, "141": 28, "142": 28, "143": 28, "144": 28, "146": 30, "150": 30, "151": 30, "152": 0, "153": 0, "154": 0, "155": 0, "156": 0, "157": 0, "159": 30, "165": 0, "171": 60, "172": 0, "174": 60, "222": 60, "181": 37, "182": 37, "183": 37, "186": 37, "187": 6, "191": 31, "192": 1, "195": 30, "197": 30, "199": 5, "200": 5, "203": 25, "204": 25, "207": 60, "208": 30, "209": 30, "212": 30, "215": 30, "216": 6, "219": 30, "220": 30, "239": 1, "240": 0, "243": 1, "246": 42, "247": 62, "252": 1, "256": 40, "257": 39, "258": 17, "260": 22, "262": 24, "263": 1, "265": 1, "266": 0, "267": 0, "269": 0, "270": 0, "272": 0, "273": 0, "275": 1, "276": 0, "279": 1, "282": 1, "248": 39, "286": 1, "289": 40, "290": 39, "293": 39, "294": 39, "295": 39, "296": 39, "300": 39, "301": 39, "303": 0, "306": 39, "307": 39, "309": 39, "310": 39, "313": 39, "314": 22, "315": 22, "316": 66, "317": 44, "318": 82, "319": 60, "320": 60, "321": 60, "322": 0, "323": 0, "324": 22, "325": 0, "327": 22, "328": 22, "330": 0, "331": 22, "333": 22, "334": 0, "336": 22, "337": 22, "339": 22, "340": 11, "341": 22, "343": 39, "346": 17, "347": 17, "348": 17, "349": 17, "352": 39, "354": 39, "287": 39, "357": 113, "360": 67, "366": 28, "367": 28, "368": 28, "369": 28, "370": 28, "371": 7, "372": 28, "375": 0, "376": 0, "377": 0, "378": 0, "379": 0, "381": 0, "382": 0, "383": 0, "384": 0, "386": 0, "388": 0, "389": 0, "392": 0, "395": 0, "399": 1, "400": 1, "401": 1, "402": 1, "404": 1, "408": 1, "415": 1, "430": 1, "436": 1, "443": 1, "405": 1, "406": 1, "409": 1, "410": 1, "411": 0, "412": 1, "413": 1, "416": 1, "417": 1, "418": 1, "419": 0, "420": 0, "421": 0, "422": 0, "424": 0, "425": 0, "426": 0, "427": 0, "428": 0, "431": 1, "432": 1, "433": 1, "434": 1, "437": 1, "438": 1, "439": 0, "440": 1, "441": 1, "444": 0, "445": 0, "446": 0, "447": 0, "448": 0, "449": 0, "450": 0, "451": 0, "452": 0, "453": 0, "456": 0, "457": 0, "458": 0, "466": 1, "470": 1, "471": 1}}
+ git checkout 7272e1963ffdf39c1d4fe225d5425a45dd095d11
Note: switching to '7272e1963ffdf39c1d4fe225d5425a45dd095d11'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by switching back to a branch.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -c with the switch command. Example:

  git switch -c <new-branch-name>

Or undo this operation with:

  git switch -

Turn off this advice by setting config variable advice.detachedHead to false

HEAD is now at 7272e1963f Fixed #32821 -- Updated os.scandir() uses to use a context manager.
M	django/contrib/staticfiles/storage.py
+ git apply /root/pre_state.patch
error: unrecognized input
