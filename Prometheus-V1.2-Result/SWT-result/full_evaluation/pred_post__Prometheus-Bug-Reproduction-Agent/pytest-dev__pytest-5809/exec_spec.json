{"instance_id": "pytest-dev__pytest-5809", "repo": "pytest-dev/pytest", "version": "4.6", "environment_setup_commit": "d5843f89d3c008ddcb431adbc335b080a79e617e", "patch_list": ["diff --git a/src/_pytest/pastebin.py b/src/_pytest/pastebin.py\n--- a/src/_pytest/pastebin.py\n+++ b/src/_pytest/pastebin.py\n@@ -77,11 +77,7 @@ def create_new_paste(contents):\n         from urllib.request import urlopen\n         from urllib.parse import urlencode\n \n-    params = {\n-        \"code\": contents,\n-        \"lexer\": \"python3\" if sys.version_info[0] >= 3 else \"python\",\n-        \"expiry\": \"1week\",\n-    }\n+    params = {\"code\": contents, \"lexer\": \"text\", \"expiry\": \"1week\"}\n     url = \"https://bpaste.net\"\n     response = urlopen(url, data=urlencode(params).encode(\"ascii\")).read()\n     m = re.search(r'href=\"/raw/(\\w+)\"', response.decode(\"utf-8\"))\n", "diff --git a/testing/test_pastebin_lexer.py b/testing/test_pastebin_lexer.py\nnew file mode 100644\nindex 000000000..5572dac02\n--- /dev/null\n+++ b/testing/test_pastebin_lexer.py\n@@ -0,0 +1,67 @@\n+# -*- coding: utf-8 -*-\n+from __future__ import absolute_import\n+from __future__ import division\n+from __future__ import print_function\n+\n+import sys\n+\n+import pytest\n+\n+\n+class TestPaste(object):\n+    @pytest.fixture\n+    def pastebin(self, request):\n+        return request.config.pluginmanager.getplugin(\"pastebin\")\n+\n+    def test_pastebin_lexer_for_arbitrary_text(self, pastebin, monkeypatch):\n+        \"\"\"\n+        Tests that pastebin uploads use 'text' lexer to avoid HTTP errors.\n+\n+        The bpaste.net service can fail with a HTTP 400 error if the content\n+        of the paste is not valid for the specified lexer. Pytest terminal\n+        output is not Python code, so 'python3' or 'python' lexers are\n+        inappropriate. This test mocks urlopen to simulate this failure, and\n+        will pass when the correct 'text' lexer is used.\n+        \"\"\"\n+\n+        def mock_urlopen_bpaste(url, data):\n+            if sys.version_info >= (3, 0):\n+                from urllib.parse import parse_qs\n+                from urllib.error import HTTPError\n+                from io import BytesIO\n+\n+                params = parse_qs(data.decode(\"ascii\"))\n+                fp = BytesIO(b\"\")\n+            else:\n+                from urlparse import parse_qs\n+                from urllib2 import HTTPError\n+\n+                params = parse_qs(data)\n+                fp = None\n+\n+            lexer = params.get(\"lexer\", [None])[0]\n+            if lexer and lexer != \"text\":\n+                raise HTTPError(url, 400, \"Bad Request\", {}, fp)\n+\n+            class DummyFile:\n+                def read(self):\n+                    return b'View <a href=\"/raw/3c0c6750bd\">raw</a>.'\n+\n+            return DummyFile()\n+\n+        if sys.version_info < (3, 0):\n+            import urllib\n+\n+            monkeypatch.setattr(urllib, \"urlopen\", mock_urlopen_bpaste)\n+        else:\n+            import urllib.request\n+\n+            monkeypatch.setattr(urllib.request, \"urlopen\", mock_urlopen_bpaste)\n+\n+        # Some content that is not valid python.\n+        content = b\"=== 1 failed, 1 passed in 0.12s ===\"\n+\n+        # This call will raise HTTPError with the current buggy code.\n+        # With the fix (lexer='text'), it should pass.\n+        result = pastebin.create_new_paste(content)\n+        assert result == \"https://bpaste.net/show/3c0c6750bd\"\n"], "arch": "x86_64", "base_commit": "8aba863a634f40560e25055d179220f0eefabe9a", "test_directives": ["testing/test_pastebin_lexer.py"], "coverage_files": ["src/_pytest/pastebin.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_post__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "install": "python -m pip install -e .", "pip_packages": ["atomicwrites==1.4.1", "attrs==23.1.0", "more-itertools==10.1.0", "packaging==23.1", "pluggy==0.13.1", "py==1.11.0", "six==1.16.0", "wcwidth==0.2.6"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(src/_pytest/pastebin\\.py)' -m pytest -rA testing/test_pastebin_lexer.py", "req_install_commands": ["conda create -n testbed python=3.9  -y"]}