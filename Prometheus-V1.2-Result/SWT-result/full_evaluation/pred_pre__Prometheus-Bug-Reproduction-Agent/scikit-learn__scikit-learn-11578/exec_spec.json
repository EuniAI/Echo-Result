{"instance_id": "scikit-learn__scikit-learn-11578", "repo": "scikit-learn/scikit-learn", "version": "0.20", "environment_setup_commit": "55bf5d93e5674f13a1134d93a11fd0cd11aabcd1", "patch_list": ["diff --git a/sklearn/linear_model/tests/test_logistic_cv.py b/sklearn/linear_model/tests/test_logistic_cv.py\nnew file mode 100644\nindex 0000000000..7cce9700c9\n--- /dev/null\n+++ b/sklearn/linear_model/tests/test_logistic_cv.py\n@@ -0,0 +1,59 @@\n+import numpy as np\n+import pytest\n+\n+from sklearn import preprocessing, linear_model\n+from sklearn.metrics import log_loss\n+from sklearn.utils import extmath\n+from sklearn.utils.testing import assert_almost_equal\n+\n+\n+def test_logistic_cv_multinomial_scoring():\n+    \"\"\"\n+    Test for bug #8720.\n+\n+    `LogisticRegressionCV(multi_class='multinomial')` with a probabilistic\n+    scorer should use the multinomial (softmax) function, not the OvR\n+    approach to calculate probabilities. This test checks that the score\n+    returned by the internal scoring function `_log_reg_scoring_path`\n+    matches the score calculated manually using the softmax function.\n+    \"\"\"\n+    # Based on the minimal example from the issue description\n+    np.random.seed(seed=1234)\n+    samples = 200\n+    features = 5\n+    scorer = 'neg_log_loss'\n+\n+    X = np.random.random(size=(samples, features))\n+    y = np.random.choice(['a', 'b', 'c'], size=samples)\n+\n+    test_size = int(samples / 10.0)\n+    test = np.random.choice(range(samples), size=test_size, replace=False)\n+    train = [idx for idx in range(samples) if idx not in test]\n+    X_test, y_test = X[test], y[test]\n+\n+    # Get the score from the internal scoring path function, which is\n+    # what LogisticRegressionCV uses.\n+    coefs, _, scores, _ = linear_model.logistic._log_reg_scoring_path(\n+        X, y, train, test, fit_intercept=True, scoring=scorer,\n+        multi_class='multinomial')\n+\n+    # We only care about the first C value for this test\n+    c_index = 0\n+    score_from_path = scores[c_index]\n+    coef_path = coefs[c_index]\n+\n+    # Manually calculate the score that *should* be returned, using the\n+    # multinomial (softmax) approach.\n+    classes = np.unique(y)\n+    log_reg = linear_model.LogisticRegression(multi_class='multinomial')\n+    log_reg.coef_ = coef_path[:, :-1]\n+    log_reg.intercept_ = coef_path[:, -1]\n+    log_reg.classes_ = classes\n+\n+    decision = log_reg.decision_function(X_test)\n+    probas = extmath.softmax(decision)\n+    correct_score = -log_loss(y_test, probas, labels=classes)\n+\n+    # This assertion will fail before the fix because score_from_path is\n+    # calculated using the 'ovr' method instead of 'multinomial'.\n+    assert_almost_equal(score_from_path, correct_score)\n"], "arch": "x86_64", "base_commit": "dd69361a0d9c6ccde0d2353b00b86e0e7541a3e3", "test_directives": ["sklearn/linear_model/tests/test_logistic_cv.py"], "coverage_files": ["sklearn/linear_model/logistic.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "numpy scipy cython pytest pandas matplotlib", "install": "python -m pip install -v --no-use-pep517 --no-build-isolation -e .", "pip_packages": ["cython", "numpy==1.19.2", "setuptools", "scipy==1.5.2"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(sklearn/linear_model/logistic\\.py)' -m pytest --no-header -rA  -p no:cacheprovider sklearn/linear_model/tests/test_logistic_cv.py", "req_install_commands": ["conda create -n testbed python=3.6 numpy scipy cython pytest pandas matplotlib -y"]}