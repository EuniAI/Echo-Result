{"instance_id": "django__django-13820", "repo": "django/django", "version": "3.2", "environment_setup_commit": "65dfb06a1ab56c238cc80f5e1c31f61210c4577d", "patch_list": ["diff --git a/tests/migrations/test_pyc_loader.py b/tests/migrations/test_pyc_loader.py\nnew file mode 100644\nindex 0000000000..be01e7f779\n--- /dev/null\n+++ b/tests/migrations/test_pyc_loader.py\n@@ -0,0 +1,85 @@\n+import compileall\n+import os\n+from importlib import import_module\n+from unittest.mock import MagicMock, patch\n+\n+from django.db import connection, connections\n+from django.db.migrations.exceptions import (\n+    AmbiguityError,\n+    InconsistentMigrationHistory,\n+    NodeNotFoundError,\n+)\n+from django.db.migrations.loader import MigrationLoader\n+from django.db.migrations.recorder import MigrationRecorder\n+from django.test import TestCase, modify_settings, override_settings\n+\n+from .test_base import MigrationTestBase\n+\n+\n+class PycLoaderTests(MigrationTestBase):\n+    def test_valid(self):\n+        \"\"\"\n+        To support frozen environments, MigrationLoader loads .pyc migrations.\n+        \"\"\"\n+        with self.temporary_migration_module(\n+            module=\"migrations.test_migrations\"\n+        ) as migration_dir:\n+            # Compile .py files to .pyc files and delete .py files.\n+            compileall.compile_dir(migration_dir, force=True, quiet=1, legacy=True)\n+            for name in os.listdir(migration_dir):\n+                if name.endswith(\".py\"):\n+                    os.remove(os.path.join(migration_dir, name))\n+            loader = MigrationLoader(connection)\n+            self.assertIn((\"migrations\", \"0001_initial\"), loader.disk_migrations)\n+\n+    def test_invalid(self):\n+        \"\"\"\n+        MigrationLoader reraises ImportErrors caused by \"bad magic number\" pyc\n+        files with a more helpful message.\n+        \"\"\"\n+        with self.temporary_migration_module(\n+            module=\"migrations.test_migrations_bad_pyc\"\n+        ) as migration_dir:\n+            # The -tpl suffix is to avoid the pyc exclusion in MANIFEST.in.\n+            os.rename(\n+                os.path.join(migration_dir, \"0001_initial.pyc-tpl\"),\n+                os.path.join(migration_dir, \"0001_initial.pyc\"),\n+            )\n+            msg = (\n+                r\"Couldn't import '\\w+.migrations.0001_initial' as it appears \"\n+                \"to be a stale .pyc file.\"\n+            )\n+            with self.assertRaisesRegex(ImportError, msg):\n+                MigrationLoader(connection)\n+\n+    @override_settings(INSTALLED_APPS=[\"migrations\"])\n+    def test_package_with_no_file_attribute(self):\n+        \"\"\"\n+        Migrations from a regular package without __file__ are loaded.\n+        \"\"\"\n+        with self.temporary_migration_module(\n+            module=\"migrations.test_migrations\"\n+        ) as migration_dir:\n+            from django.conf import settings\n+\n+            module_name = settings.MIGRATION_MODULES[\"migrations\"]\n+            # This mock simulates a module from a frozen environment.\n+            mock_module = MagicMock(spec=object)\n+            # It's a package, so it has __path__.\n+            mock_module.__path__ = [migration_dir]\n+            # But no __file__.\n+            del mock_module.__file__\n+\n+            original_import = import_module\n+\n+            def import_side_effect(name, package=None):\n+                if name == module_name:\n+                    return mock_module\n+                return original_import(name, package)\n+\n+            with patch(\n+                \"django.db.migrations.loader.import_module\",\n+                side_effect=import_side_effect,\n+            ):\n+                loader = MigrationLoader(connection)\n+                self.assertIn((\"migrations\", \"0001_initial\"), loader.disk_migrations)\n"], "arch": "x86_64", "base_commit": "98ad327864aed8df245fd19ea9d2743279e11643", "test_directives": ["migrations.test_pyc_loader"], "coverage_files": ["django/db/migrations/loader.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.6", "packages": "requirements.txt", "install": "python -m pip install -e .", "eval_commands": ["sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen", "export LANG=en_US.UTF-8", "export LANGUAGE=en_US:en", "export LC_ALL=en_US.UTF-8"]}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/loader\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_pyc_loader", "req_install_commands": ["conda create -n testbed python=3.6 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}