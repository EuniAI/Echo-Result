{"instance_id": "django__django-14351", "repo": "django/django", "version": "4.0", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "patch_list": ["diff --git a/tests/queries/test_or_m2m_subquery.py b/tests/queries/test_or_m2m_subquery.py\nnew file mode 100644\nindex 0000000000..f35819fd55\n--- /dev/null\n+++ b/tests/queries/test_or_m2m_subquery.py\n@@ -0,0 +1,60 @@\n+from operator import attrgetter\n+\n+from django.db import models\n+from django.db.models import Count, Q\n+from django.test import TestCase\n+\n+\n+class PropertyGroup(models.Model):\n+    name = models.CharField(max_length=50)\n+\n+\n+class Agent(models.Model):\n+    name = models.CharField(max_length=50)\n+    property_groups = models.ManyToManyField('queries.PropertyGroup', blank=True)\n+\n+\n+class Ticket(models.Model):\n+    name = models.CharField(max_length=50)\n+    agent = models.ForeignKey('queries.Agent', models.CASCADE)\n+\n+    class Meta:\n+        ordering = ['name']\n+\n+\n+class OrM2MSubqueryTest(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.pg1 = PropertyGroup.objects.create(name='PG1')\n+        cls.pg2 = PropertyGroup.objects.create(name='PG2')\n+\n+        cls.agent1 = Agent.objects.create(name='Agent 1')\n+        cls.agent1.property_groups.add(cls.pg1)\n+\n+        cls.agent2 = Agent.objects.create(name='Agent 2')\n+\n+        cls.agent3 = Agent.objects.create(name='Agent 3')\n+        cls.agent3.property_groups.add(cls.pg2)\n+\n+        cls.ticket1 = Ticket.objects.create(name='Ticket 1', agent=cls.agent1)\n+        cls.ticket2 = Ticket.objects.create(name='Ticket 2', agent=cls.agent2)\n+        Ticket.objects.create(name='Ticket 3', agent=cls.agent3)\n+\n+    def test_or_with_m2m_subquery(self):\n+        \"\"\"\n+        A filter combining a subquery lookup on an M2M with an annotation\n+        count was generating a subquery that selected all columns instead of\n+        just the PK.\n+        \"\"\"\n+        property_groups = PropertyGroup.objects.filter(pk=self.pg1.pk)\n+        qs = Ticket.objects.annotate(\n+            agent__property_groups__count=Count('agent__property_groups')\n+        ).filter(\n+            Q(agent__property_groups__in=property_groups) | Q(agent__property_groups__count=0)\n+        ).distinct()\n+\n+        self.assertQuerysetEqual(\n+            qs,\n+            ['Ticket 1', 'Ticket 2'],\n+            attrgetter('name')\n+        )\n"], "arch": "x86_64", "base_commit": "06fd4df41afb5aa1d681b853c3c08d8c688ca3a5", "test_directives": ["queries.test_or_m2m_subquery"], "coverage_files": ["django/db/models/lookups.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.8", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/models/lookups\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 queries.test_or_m2m_subquery", "req_install_commands": ["conda create -n testbed python=3.8 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}