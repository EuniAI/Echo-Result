{"instance_id": "django__django-14539", "repo": "django/django", "version": "4.0", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "patch_list": ["diff --git a/tests/template_tests/filter_tests/test_urlize_regression.py b/tests/template_tests/filter_tests/test_urlize_regression.py\nnew file mode 100644\nindex 0000000000..91d76f319f\n--- /dev/null\n+++ b/tests/template_tests/filter_tests/test_urlize_regression.py\n@@ -0,0 +1,397 @@\n+from django.template.defaultfilters import urlize\n+from django.test import SimpleTestCase\n+from django.utils.functional import lazy\n+from django.utils.safestring import mark_safe\n+\n+from ..utils import setup\n+\n+\n+class UrlizeTests(SimpleTestCase):\n+\n+    @setup({'urlize01': '{% autoescape off %}{{ a|urlize }} {{ b|urlize }}{% endautoescape %}'})\n+    def test_urlize01(self):\n+        output = self.engine.render_to_string(\n+            'urlize01',\n+            {'a': 'http://example.com/?x=&y=', 'b': mark_safe('http://example.com?x=&amp;y=&lt;2&gt;')},\n+        )\n+        self.assertEqual(\n+            output,\n+            '<a href=\"http://example.com/?x=&amp;y=\" rel=\"nofollow\">http://example.com/?x=&y=</a> '\n+            '<a href=\"http://example.com?x=&amp;y=%3C2%3E\" rel=\"nofollow\">http://example.com?x=&amp;y=&lt;2&gt;</a>'\n+        )\n+\n+    @setup({'urlize02': '{{ a|urlize }} {{ b|urlize }}'})\n+    def test_urlize02(self):\n+        output = self.engine.render_to_string(\n+            'urlize02',\n+            {'a': \"http://example.com/?x=&y=\", 'b': mark_safe(\"http://example.com?x=&amp;y=\")},\n+        )\n+        self.assertEqual(\n+            output,\n+            '<a href=\"http://example.com/?x=&amp;y=\" rel=\"nofollow\">http://example.com/?x=&amp;y=</a> '\n+            '<a href=\"http://example.com?x=&amp;y=\" rel=\"nofollow\">http://example.com?x=&amp;y=</a>'\n+        )\n+\n+    @setup({'urlize03': '{% autoescape off %}{{ a|urlize }}{% endautoescape %}'})\n+    def test_urlize03(self):\n+        output = self.engine.render_to_string('urlize03', {'a': mark_safe(\"a &amp; b\")})\n+        self.assertEqual(output, 'a &amp; b')\n+\n+    @setup({'urlize04': '{{ a|urlize }}'})\n+    def test_urlize04(self):\n+        output = self.engine.render_to_string('urlize04', {'a': mark_safe(\"a &amp; b\")})\n+        self.assertEqual(output, 'a &amp; b')\n+\n+    # This will lead to a nonsense result, but at least it won't be\n+    # exploitable for XSS purposes when auto-escaping is on.\n+    @setup({'urlize05': '{% autoescape off %}{{ a|urlize }}{% endautoescape %}'})\n+    def test_urlize05(self):\n+        output = self.engine.render_to_string('urlize05', {'a': \"<script>alert('foo')</script>\"})\n+        self.assertEqual(output, \"<script>alert('foo')</script>\")\n+\n+    @setup({'urlize06': '{{ a|urlize }}'})\n+    def test_urlize06(self):\n+        output = self.engine.render_to_string('urlize06', {'a': \"<script>alert('foo')</script>\"})\n+        self.assertEqual(output, '&lt;script&gt;alert(&#x27;foo&#x27;)&lt;/script&gt;')\n+\n+    # mailto: testing for urlize\n+    @setup({'urlize07': '{{ a|urlize }}'})\n+    def test_urlize07(self):\n+        output = self.engine.render_to_string('urlize07', {'a': \"Email me at me@example.com\"})\n+        self.assertEqual(\n+            output,\n+            'Email me at <a href=\"mailto:me@example.com\">me@example.com</a>',\n+        )\n+\n+    @setup({'urlize08': '{{ a|urlize }}'})\n+    def test_urlize08(self):\n+        output = self.engine.render_to_string('urlize08', {'a': \"Email me at <me@example.com>\"})\n+        self.assertEqual(\n+            output,\n+            'Email me at &lt;<a href=\"mailto:me@example.com\">me@example.com</a>&gt;',\n+        )\n+\n+    @setup({'urlize09': '{% autoescape off %}{{ a|urlize }}{% endautoescape %}'})\n+    def test_urlize09(self):\n+        output = self.engine.render_to_string('urlize09', {'a': \"http://example.com/?x=&amp;y=&lt;2&gt;\"})\n+        self.assertEqual(\n+            output,\n+            '<a href=\"http://example.com/?x=&amp;y=%3C2%3E\" rel=\"nofollow\">http://example.com/?x=&amp;y=&lt;2&gt;</a>',\n+        )\n+\n+\n+class FunctionTests(SimpleTestCase):\n+\n+    def test_urls(self):\n+        self.assertEqual(\n+            urlize('http://google.com'),\n+            '<a href=\"http://google.com\" rel=\"nofollow\">http://google.com</a>',\n+        )\n+        self.assertEqual(\n+            urlize('http://google.com/'),\n+            '<a href=\"http://google.com/\" rel=\"nofollow\">http://google.com/</a>',\n+        )\n+        self.assertEqual(\n+            urlize('www.google.com'),\n+            '<a href=\"http://www.google.com\" rel=\"nofollow\">www.google.com</a>',\n+        )\n+        self.assertEqual(\n+            urlize('djangoproject.org'),\n+            '<a href=\"http://djangoproject.org\" rel=\"nofollow\">djangoproject.org</a>',\n+        )\n+        self.assertEqual(\n+            urlize('djangoproject.org/'),\n+            '<a href=\"http://djangoproject.org/\" rel=\"nofollow\">djangoproject.org/</a>',\n+        )\n+\n+    def test_url_split_chars(self):\n+        # Quotes (single and double) and angle brackets shouldn't be considered\n+        # part of URLs.\n+        self.assertEqual(\n+            urlize('www.server.com\"abc'),\n+            '<a href=\"http://www.server.com\" rel=\"nofollow\">www.server.com</a>&quot;abc',\n+        )\n+        self.assertEqual(\n+            urlize('www.server.com\\'abc'),\n+            '<a href=\"http://www.server.com\" rel=\"nofollow\">www.server.com</a>&#x27;abc',\n+        )\n+        self.assertEqual(\n+            urlize('www.server.com<abc'),\n+            '<a href=\"http://www.server.com\" rel=\"nofollow\">www.server.com</a>&lt;abc',\n+        )\n+        self.assertEqual(\n+            urlize('www.server.com>abc'),\n+            '<a href=\"http://www.server.com\" rel=\"nofollow\">www.server.com</a>&gt;abc',\n+        )\n+\n+    def test_email(self):\n+        self.assertEqual(\n+            urlize('info@djangoproject.org'),\n+            '<a href=\"mailto:info@djangoproject.org\">info@djangoproject.org</a>',\n+        )\n+\n+    def test_word_with_dot(self):\n+        self.assertEqual(urlize('some.organization'), 'some.organization'),\n+\n+    def test_https(self):\n+        self.assertEqual(\n+            urlize('https://google.com'),\n+            '<a href=\"https://google.com\" rel=\"nofollow\">https://google.com</a>',\n+        )\n+\n+    def test_quoting(self):\n+        \"\"\"\n+        #9655 - Check urlize doesn't overquote already quoted urls. The\n+        teststring is the urlquoted version of 'http://hi.baidu.com/\u91cd\u65b0\u5f00\u59cb'\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('http://hi.baidu.com/%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B'),\n+            '<a href=\"http://hi.baidu.com/%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B\" rel=\"nofollow\">'\n+            'http://hi.baidu.com/%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B</a>',\n+        )\n+\n+    def test_urlencoded(self):\n+        self.assertEqual(\n+            urlize('www.mystore.com/30%OffCoupons!'),\n+            '<a href=\"http://www.mystore.com/30%25OffCoupons\" rel=\"nofollow\">'\n+            'www.mystore.com/30%OffCoupons</a>!',\n+        )\n+        self.assertEqual(\n+            urlize('https://en.wikipedia.org/wiki/Caf%C3%A9'),\n+            '<a href=\"https://en.wikipedia.org/wiki/Caf%C3%A9\" rel=\"nofollow\">'\n+            'https://en.wikipedia.org/wiki/Caf%C3%A9</a>',\n+        )\n+\n+    def test_unicode(self):\n+        self.assertEqual(\n+            urlize('https://en.wikipedia.org/wiki/Caf\u00e9'),\n+            '<a href=\"https://en.wikipedia.org/wiki/Caf%C3%A9\" rel=\"nofollow\">'\n+            'https://en.wikipedia.org/wiki/Caf\u00e9</a>',\n+        )\n+\n+    def test_parenthesis(self):\n+        \"\"\"\n+        #11911 - Check urlize keeps balanced parentheses\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('https://en.wikipedia.org/wiki/Django_(web_framework)'),\n+            '<a href=\"https://en.wikipedia.org/wiki/Django_(web_framework)\" rel=\"nofollow\">'\n+            'https://en.wikipedia.org/wiki/Django_(web_framework)</a>',\n+        )\n+        self.assertEqual(\n+            urlize('(see https://en.wikipedia.org/wiki/Django_(web_framework))'),\n+            '(see <a href=\"https://en.wikipedia.org/wiki/Django_(web_framework)\" rel=\"nofollow\">'\n+            'https://en.wikipedia.org/wiki/Django_(web_framework)</a>)',\n+        )\n+\n+    def test_nofollow(self):\n+        \"\"\"\n+        #12183 - Check urlize adds nofollow properly - see #12183\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('foo@bar.com or www.bar.com'),\n+            '<a href=\"mailto:foo@bar.com\">foo@bar.com</a> or '\n+            '<a href=\"http://www.bar.com\" rel=\"nofollow\">www.bar.com</a>',\n+        )\n+\n+    def test_idn(self):\n+        \"\"\"\n+        #13704 - Check urlize handles IDN correctly\n+        \"\"\"\n+        self.assertEqual(urlize('http://c\u2736.ws'), '<a href=\"http://xn--c-lgq.ws\" rel=\"nofollow\">http://c\u2736.ws</a>')\n+        self.assertEqual(urlize('www.c\u2736.ws'), '<a href=\"http://www.xn--c-lgq.ws\" rel=\"nofollow\">www.c\u2736.ws</a>')\n+        self.assertEqual(urlize('c\u2736.org'), '<a href=\"http://xn--c-lgq.org\" rel=\"nofollow\">c\u2736.org</a>')\n+        self.assertEqual(urlize('info@c\u2736.org'), '<a href=\"mailto:info@xn--c-lgq.org\">info@c\u2736.org</a>')\n+\n+    def test_malformed(self):\n+        \"\"\"\n+        #16395 - Check urlize doesn't highlight malformed URIs\n+        \"\"\"\n+        self.assertEqual(urlize('http:///www.google.com'), 'http:///www.google.com')\n+        self.assertEqual(urlize('http://.google.com'), 'http://.google.com')\n+        self.assertEqual(urlize('http://@foo.com'), 'http://@foo.com')\n+\n+    def test_tlds(self):\n+        \"\"\"\n+        #16656 - Check urlize accepts more TLDs\n+        \"\"\"\n+        self.assertEqual(urlize('usa.gov'), '<a href=\"http://usa.gov\" rel=\"nofollow\">usa.gov</a>')\n+\n+    def test_invalid_email(self):\n+        \"\"\"\n+        #17592 - Check urlize don't crash on invalid email with dot-starting\n+        domain\n+        \"\"\"\n+        self.assertEqual(urlize('email@.stream.ru'), 'email@.stream.ru')\n+\n+    def test_uppercase(self):\n+        \"\"\"\n+        #18071 - Check urlize accepts uppercased URL schemes\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('HTTPS://github.com/'),\n+            '<a href=\"https://github.com/\" rel=\"nofollow\">HTTPS://github.com/</a>',\n+        )\n+\n+    def test_trailing_period(self):\n+        \"\"\"\n+        #18644 - Check urlize trims trailing period when followed by parenthesis\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('(Go to http://www.example.com/foo.)'),\n+            '(Go to <a href=\"http://www.example.com/foo\" rel=\"nofollow\">http://www.example.com/foo</a>.)',\n+        )\n+\n+    def test_trailing_multiple_punctuation(self):\n+        self.assertEqual(\n+            urlize('A test http://testing.com/example..'),\n+            'A test <a href=\"http://testing.com/example\" rel=\"nofollow\">http://testing.com/example</a>..'\n+        )\n+        self.assertEqual(\n+            urlize('A test http://testing.com/example!!'),\n+            'A test <a href=\"http://testing.com/example\" rel=\"nofollow\">http://testing.com/example</a>!!'\n+        )\n+        self.assertEqual(\n+            urlize('A test http://testing.com/example!!!'),\n+            'A test <a href=\"http://testing.com/example\" rel=\"nofollow\">http://testing.com/example</a>!!!'\n+        )\n+        self.assertEqual(\n+            urlize('A test http://testing.com/example.,:;)\"!'),\n+            'A test <a href=\"http://testing.com/example\" rel=\"nofollow\">http://testing.com/example</a>.,:;)&quot;!'\n+        )\n+\n+    def test_brackets(self):\n+        \"\"\"\n+        #19070 - Check urlize handles brackets properly\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('[see www.example.com]'),\n+            '[see <a href=\"http://www.example.com\" rel=\"nofollow\">www.example.com</a>]',\n+        )\n+        self.assertEqual(\n+            urlize('see test[at[example.com'),\n+            'see <a href=\"http://test[at[example.com\" rel=\"nofollow\">test[at[example.com</a>',\n+        )\n+        self.assertEqual(\n+            urlize('[http://168.192.0.1](http://168.192.0.1)'),\n+            '[<a href=\"http://168.192.0.1](http://168.192.0.1)\" rel=\"nofollow\">'\n+            'http://168.192.0.1](http://168.192.0.1)</a>',\n+        )\n+\n+    def test_wrapping_characters(self):\n+        wrapping_chars = (\n+            ('()', ('(', ')')),\n+            ('<>', ('&lt;', '&gt;')),\n+            ('[]', ('[', ']')),\n+            ('\"\"', ('&quot;', '&quot;')),\n+            (\"''\", ('&#x27;', '&#x27;')),\n+        )\n+        for wrapping_in, (start_out, end_out) in wrapping_chars:\n+            with self.subTest(wrapping_in=wrapping_in):\n+                start_in, end_in = wrapping_in\n+                self.assertEqual(\n+                    urlize(start_in + 'https://www.example.org/' + end_in),\n+                    start_out +\n+                    '<a href=\"https://www.example.org/\" rel=\"nofollow\">https://www.example.org/</a>' +\n+                    end_out,\n+                )\n+\n+    def test_ipv4(self):\n+        self.assertEqual(\n+            urlize('http://192.168.0.15/api/9'),\n+            '<a href=\"http://192.168.0.15/api/9\" rel=\"nofollow\">http://192.168.0.15/api/9</a>',\n+        )\n+\n+    def test_ipv6(self):\n+        self.assertEqual(\n+            urlize('http://[2001:db8:cafe::2]/api/9'),\n+            '<a href=\"http://[2001:db8:cafe::2]/api/9\" rel=\"nofollow\">http://[2001:db8:cafe::2]/api/9</a>',\n+        )\n+\n+    def test_quotation_marks(self):\n+        \"\"\"\n+        #20364 - Check urlize correctly include quotation marks in links\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('before \"hi@example.com\" afterwards', autoescape=False),\n+            'before \"<a href=\"mailto:hi@example.com\">hi@example.com</a>\" afterwards',\n+        )\n+        self.assertEqual(\n+            urlize('before hi@example.com\" afterwards', autoescape=False),\n+            'before <a href=\"mailto:hi@example.com\">hi@example.com</a>\" afterwards',\n+        )\n+        self.assertEqual(\n+            urlize('before \"hi@example.com afterwards', autoescape=False),\n+            'before \"<a href=\"mailto:hi@example.com\">hi@example.com</a> afterwards',\n+        )\n+        self.assertEqual(\n+            urlize('before \\'hi@example.com\\' afterwards', autoescape=False),\n+            'before \\'<a href=\"mailto:hi@example.com\">hi@example.com</a>\\' afterwards',\n+        )\n+        self.assertEqual(\n+            urlize('before hi@example.com\\' afterwards', autoescape=False),\n+            'before <a href=\"mailto:hi@example.com\">hi@example.com</a>\\' afterwards',\n+        )\n+        self.assertEqual(\n+            urlize('before \\'hi@example.com afterwards', autoescape=False),\n+            'before \\'<a href=\"mailto:hi@example.com\">hi@example.com</a> afterwards',\n+        )\n+\n+    def test_quote_commas(self):\n+        \"\"\"\n+        #20364 - Check urlize copes with commas following URLs in quotes\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('Email us at \"hi@example.com\", or phone us at +xx.yy', autoescape=False),\n+            'Email us at \"<a href=\"mailto:hi@example.com\">hi@example.com</a>\", or phone us at +xx.yy',\n+        )\n+\n+    def test_exclamation_marks(self):\n+        \"\"\"\n+        #23715 - Check urlize correctly handles exclamation marks after TLDs\n+        or query string\n+        \"\"\"\n+        self.assertEqual(\n+            urlize('Go to djangoproject.com! and enjoy.'),\n+            'Go to <a href=\"http://djangoproject.com\" rel=\"nofollow\">djangoproject.com</a>! and enjoy.',\n+        )\n+        self.assertEqual(\n+            urlize('Search for google.com/?q=! and see.'),\n+            'Search for <a href=\"http://google.com/?q=\" rel=\"nofollow\">google.com/?q=</a>! and see.',\n+        )\n+        self.assertEqual(\n+            urlize('Search for google.com/?q=dj!`? and see.'),\n+            'Search for <a href=\"http://google.com/?q=dj%21%60%3F\" rel=\"nofollow\">google.com/?q=dj!`?</a> and see.',\n+        )\n+        self.assertEqual(\n+            urlize('Search for google.com/?q=dj!`?! and see.'),\n+            'Search for <a href=\"http://google.com/?q=dj%21%60%3F\" rel=\"nofollow\">google.com/?q=dj!`?</a>! and see.',\n+        )\n+\n+    def test_html_escaped_string_and_trailing_punctuation(self):\n+        self.assertEqual(\n+            urlize('Search for google.com/?q=1&lt! and see.', autoescape=False),\n+            'Search for <a href=\"http://google.com/?q=1%3C\" rel=\"nofollow\">google.com/?q=1&lt;</a>! and see.'\n+        )\n+\n+    def test_non_string_input(self):\n+        self.assertEqual(urlize(123), '123')\n+\n+    def test_autoescape(self):\n+        self.assertEqual(\n+            urlize('foo<a href=\" google.com \">bar</a>buz'),\n+            'foo&lt;a href=&quot; <a href=\"http://google.com\" rel=\"nofollow\">google.com</a> &quot;&gt;bar&lt;/a&gt;buz'\n+        )\n+\n+    def test_autoescape_off(self):\n+        self.assertEqual(\n+            urlize('foo<a href=\" google.com \">bar</a>buz', autoescape=False),\n+            'foo<a href=\" <a href=\"http://google.com\" rel=\"nofollow\">google.com</a> \">bar</a>buz',\n+        )\n+\n+    def test_lazystring(self):\n+        prepend_www = lazy(lambda url: 'www.' + url, str)\n+        self.assertEqual(\n+            urlize(prepend_www('google.com')),\n+            '<a href=\"http://www.google.com\" rel=\"nofollow\">www.google.com</a>',\n+        )\n"], "arch": "x86_64", "base_commit": "6a5ef557f80a8eb6a758ebe99c8bb477ca47459e", "test_directives": ["template_tests.filter_tests.test_urlize_regression"], "coverage_files": ["django/utils/html.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.8", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/utils/html\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 template_tests.filter_tests.test_urlize_regression", "req_install_commands": ["conda create -n testbed python=3.8 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}