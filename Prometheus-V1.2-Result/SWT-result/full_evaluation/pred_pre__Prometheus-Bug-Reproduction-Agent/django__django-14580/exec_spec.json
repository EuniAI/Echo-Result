{"instance_id": "django__django-14580", "repo": "django/django", "version": "4.0", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4", "patch_list": ["diff --git a/tests/migrations/test_writer_bug.py b/tests/migrations/test_writer_bug.py\nnew file mode 100644\nindex 0000000000..c36591fe1f\n--- /dev/null\n+++ b/tests/migrations/test_writer_bug.py\n@@ -0,0 +1,256 @@\n+import datetime\n+import decimal\n+import enum\n+import functools\n+import math\n+import os\n+import pathlib\n+import re\n+import sys\n+import uuid\n+from unittest import mock\n+\n+import custom_migration_operations.more_operations\n+import custom_migration_operations.operations\n+\n+from django import get_version\n+from django.conf import SettingsReference, settings\n+from django.core.validators import EmailValidator, RegexValidator\n+from django.db import migrations, models\n+from django.db.migrations.serializer import BaseSerializer\n+from django.db.migrations.writer import MigrationWriter, OperationWriter\n+from django.test import SimpleTestCase\n+from django.utils.deconstruct import deconstructible\n+from django.utils.functional import SimpleLazyObject\n+from django.utils.timezone import get_default_timezone, get_fixed_timezone, utc\n+from django.utils.translation import gettext_lazy as _\n+\n+from .models import FoodManager, FoodQuerySet\n+\n+\n+class DeconstructibleInstances:\n+    def deconstruct(self):\n+        return ('DeconstructibleInstances', [], {})\n+\n+\n+class Money(decimal.Decimal):\n+    def deconstruct(self):\n+        return (\n+            '%s.%s' % (self.__class__.__module__, self.__class__.__name__),\n+            [str(self)],\n+            {}\n+        )\n+\n+\n+class TestModel1:\n+    def upload_to(self):\n+        return '/somewhere/dynamic/'\n+    thing = models.FileField(upload_to=upload_to)\n+\n+\n+class TextEnum(enum.Enum):\n+    A = 'a-value'\n+    B = 'value-b'\n+\n+\n+class TextTranslatedEnum(enum.Enum):\n+    A = _('a-value')\n+    B = _('value-b')\n+\n+\n+class BinaryEnum(enum.Enum):\n+    A = b'a-value'\n+    B = b'value-b'\n+\n+\n+class IntEnum(enum.IntEnum):\n+    A = 1\n+    B = 2\n+\n+\n+# Helper classes for the regression test.\n+class NameErrorMixin:\n+    pass\n+\n+\n+class NameErrorField(models.TextField):\n+    pass\n+\n+\n+class OperationWriterTests(SimpleTestCase):\n+\n+    def test_empty_signature(self):\n+        operation = custom_migration_operations.operations.TestOperation()\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.TestOperation(\\n'\n+            '),'\n+        )\n+\n+    def test_args_signature(self):\n+        operation = custom_migration_operations.operations.ArgsOperation(1, 2)\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.ArgsOperation(\\n'\n+            '    arg1=1,\\n'\n+            '    arg2=2,\\n'\n+            '),'\n+        )\n+\n+    def test_kwargs_signature(self):\n+        operation = custom_migration_operations.operations.KwargsOperation(kwarg1=1)\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.KwargsOperation(\\n'\n+            '    kwarg1=1,\\n'\n+            '),'\n+        )\n+\n+    def test_args_kwargs_signature(self):\n+        operation = custom_migration_operations.operations.ArgsKwargsOperation(1, 2, kwarg2=4)\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.ArgsKwargsOperation(\\n'\n+            '    arg1=1,\\n'\n+            '    arg2=2,\\n'\n+            '    kwarg2=4,\\n'\n+            '),'\n+        )\n+\n+    def test_nested_args_signature(self):\n+        operation = custom_migration_operations.operations.ArgsOperation(\n+            custom_migration_operations.operations.ArgsOperation(1, 2),\n+            custom_migration_operations.operations.KwargsOperation(kwarg1=3, kwarg2=4)\n+        )\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.ArgsOperation(\\n'\n+            '    arg1=custom_migration_operations.operations.ArgsOperation(\\n'\n+            '        arg1=1,\\n'\n+            '        arg2=2,\\n'\n+            '    ),\\n'\n+            '    arg2=custom_migration_operations.operations.KwargsOperation(\\n'\n+            '        kwarg1=3,\\n'\n+            '        kwarg2=4,\\n'\n+            '    ),\\n'\n+            '),'\n+        )\n+\n+    def test_multiline_args_signature(self):\n+        operation = custom_migration_operations.operations.ArgsOperation(\"test\\n    arg1\", \"test\\narg2\")\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            \"custom_migration_operations.operations.ArgsOperation(\\n\"\n+            \"    arg1='test\\\\n    arg1',\\n\"\n+            \"    arg2='test\\\\narg2',\\n\"\n+            \"),\"\n+        )\n+\n+    def test_expand_args_signature(self):\n+        operation = custom_migration_operations.operations.ExpandArgsOperation([1, 2])\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.ExpandArgsOperation(\\n'\n+            '    arg=[\\n'\n+            '        1,\\n'\n+            '        2,\\n'\n+            '    ],\\n'\n+            '),'\n+        )\n+\n+    def test_nested_operation_expand_args_signature(self):\n+        operation = custom_migration_operations.operations.ExpandArgsOperation(\n+            arg=[\n+                custom_migration_operations.operations.KwargsOperation(\n+                    kwarg1=1,\n+                    kwarg2=2,\n+                ),\n+            ]\n+        )\n+        buff, imports = OperationWriter(operation, indentation=0).serialize()\n+        self.assertEqual(imports, {'import custom_migration_operations.operations'})\n+        self.assertEqual(\n+            buff,\n+            'custom_migration_operations.operations.ExpandArgsOperation(\\n'\n+            '    arg=[\\n'\n+            '        custom_migration_operations.operations.KwargsOperation(\\n'\n+            '            kwarg1=1,\\n'\n+            '            kwarg2=2,\\n'\n+            '        ),\\n'\n+            '    ],\\n'\n+            '),'\n+        )\n+\n+\n+class WriterTests(SimpleTestCase):\n+    \"\"\"\n+    Tests the migration writer (makes migration files from Migration instances)\n+    \"\"\"\n+    class NestedEnum(enum.IntEnum):\n+        A = 1\n+        B = 2\n+\n+    class NestedChoices(models.TextChoices):\n+        X = 'X', 'X value'\n+        Y = 'Y', 'Y value'\n+\n+    def safe_exec(self, string, value=None):\n+        d = {}\n+        try:\n+            exec(string, globals(), d)\n+        except Exception as e:\n+            if value:\n+                self.fail(\"Could not exec %r (from value %r): %s\" % (string.strip(), value, e))\n+            else:\n+                self.fail(\"Could not exec %r: %s\" % (string.strip(), e))\n+        return d\n+\n+    def serialize_round_trip(self, value):\n+        string, imports = MigrationWriter.serialize(value)\n+        return self.safe_exec(\"%s\\ntest_value_result = %s\" % (\"\\n\".join(imports), string), value)['test_value_result']\n+\n+    def assertSerializedEqual(self, value):\n+        self.assertEqual(self.serialize_round_trip(value), value)\n+\n+    def assertSerializedResultEqual(self, value, target):\n+        self.assertEqual(MigrationWriter.serialize(value), target)\n+\n+    def assertSerializedFieldEqual(self, value):\n+        new_value = self.serialize_round_trip(value)\n+        self.assertEqual(value.__class__, new_value.__class__)\n+        self.assertEqual(value.max_length, new_value.max_length)\n+        self.assertEqual(value.null, new_value.null)\n+        self.assertEqual(value.unique, new_value.unique)\n+\n+    def test_model_import_for_bases(self):\n+        \"\"\"\n+        `from django.db import models` should be added when `models.Model` is\n+        present in the `bases` of a `CreateModel` operation.\n+        \"\"\"\n+        migration = type('Migration', (migrations.Migration,), {\n+            'operations': [\n+                migrations.CreateModel(\n+                    'MyModel',\n+                    fields=[('name', NameErrorField(primary_key=True, serialize=False))],\n+                    bases=(NameErrorMixin, models.Model),\n+                ),\n+            ],\n+            'dependencies': [],\n+        })\n+        writer = MigrationWriter(migration)\n+        output = writer.as_string()\n+        self.assertIn('from django.db import models', output)\n"], "arch": "x86_64", "base_commit": "36fa071d6ebd18a61c4d7f1b5c9d17106134bd44", "test_directives": ["migrations.test_writer_bug"], "coverage_files": ["django/db/migrations/serializer.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.8", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/serializer\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_writer_bug", "req_install_commands": ["conda create -n testbed python=3.8 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\nasgiref >= 3.3.2\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npython-memcached >= 1.59\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}