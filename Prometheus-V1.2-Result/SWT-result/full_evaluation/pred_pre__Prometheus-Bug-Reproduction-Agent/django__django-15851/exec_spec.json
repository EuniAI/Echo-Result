{"instance_id": "django__django-15851", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/tests/dbshell/test_postgresql_dbshell.py b/tests/dbshell/test_postgresql_dbshell.py\nnew file mode 100644\nindex 0000000000..d78e5cd07d\n--- /dev/null\n+++ b/tests/dbshell/test_postgresql_dbshell.py\n@@ -0,0 +1,197 @@\n+import os\n+import signal\n+import subprocess\n+import sys\n+from pathlib import Path\n+from unittest import mock, skipUnless\n+\n+from django.db import connection\n+from django.db.backends.postgresql.client import DatabaseClient\n+from django.test import SimpleTestCase\n+\n+\n+class PostgreSqlDbshellCommandTestCase(SimpleTestCase):\n+    def settings_to_cmd_args_env(self, settings_dict, parameters=None):\n+        if parameters is None:\n+            parameters = []\n+        return DatabaseClient.settings_to_cmd_args_env(settings_dict, parameters)\n+\n+    def test_basic(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"NAME\": \"dbname\",\n+                    \"USER\": \"someuser\",\n+                    \"PASSWORD\": \"somepassword\",\n+                    \"HOST\": \"somehost\",\n+                    \"PORT\": \"444\",\n+                }\n+            ),\n+            (\n+                [\"psql\", \"-U\", \"someuser\", \"-h\", \"somehost\", \"-p\", \"444\", \"dbname\"],\n+                {\"PGPASSWORD\": \"somepassword\"},\n+            ),\n+        )\n+\n+    def test_nopass(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"NAME\": \"dbname\",\n+                    \"USER\": \"someuser\",\n+                    \"HOST\": \"somehost\",\n+                    \"PORT\": \"444\",\n+                }\n+            ),\n+            (\n+                [\"psql\", \"-U\", \"someuser\", \"-h\", \"somehost\", \"-p\", \"444\", \"dbname\"],\n+                None,\n+            ),\n+        )\n+\n+    def test_ssl_certificate(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"NAME\": \"dbname\",\n+                    \"USER\": \"someuser\",\n+                    \"HOST\": \"somehost\",\n+                    \"PORT\": \"444\",\n+                    \"OPTIONS\": {\n+                        \"sslmode\": \"verify-ca\",\n+                        \"sslrootcert\": \"root.crt\",\n+                        \"sslcert\": \"client.crt\",\n+                        \"sslkey\": \"client.key\",\n+                    },\n+                }\n+            ),\n+            (\n+                [\"psql\", \"-U\", \"someuser\", \"-h\", \"somehost\", \"-p\", \"444\", \"dbname\"],\n+                {\n+                    \"PGSSLCERT\": \"client.crt\",\n+                    \"PGSSLKEY\": \"client.key\",\n+                    \"PGSSLMODE\": \"verify-ca\",\n+                    \"PGSSLROOTCERT\": \"root.crt\",\n+                },\n+            ),\n+        )\n+\n+    def test_service(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env({\"OPTIONS\": {\"service\": \"django_test\"}}),\n+            ([\"psql\"], {\"PGSERVICE\": \"django_test\"}),\n+        )\n+\n+    def test_passfile(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"NAME\": \"dbname\",\n+                    \"USER\": \"someuser\",\n+                    \"HOST\": \"somehost\",\n+                    \"PORT\": \"444\",\n+                    \"OPTIONS\": {\n+                        \"passfile\": \"~/.custompgpass\",\n+                    },\n+                }\n+            ),\n+            (\n+                [\"psql\", \"-U\", \"someuser\", \"-h\", \"somehost\", \"-p\", \"444\", \"dbname\"],\n+                {\"PGPASSFILE\": \"~/.custompgpass\"},\n+            ),\n+        )\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"OPTIONS\": {\n+                        \"service\": \"django_test\",\n+                        \"passfile\": \"~/.custompgpass\",\n+                    },\n+                }\n+            ),\n+            (\n+                [\"psql\"],\n+                {\"PGSERVICE\": \"django_test\", \"PGPASSFILE\": \"~/.custompgpass\"},\n+            ),\n+        )\n+\n+    def test_column(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"NAME\": \"dbname\",\n+                    \"USER\": \"some:user\",\n+                    \"PASSWORD\": \"some:password\",\n+                    \"HOST\": \"::1\",\n+                    \"PORT\": \"444\",\n+                }\n+            ),\n+            (\n+                [\"psql\", \"-U\", \"some:user\", \"-h\", \"::1\", \"-p\", \"444\", \"dbname\"],\n+                {\"PGPASSWORD\": \"some:password\"},\n+            ),\n+        )\n+\n+    def test_accent(self):\n+        username = \"r\u00f4le\"\n+        password = \"s\u00e9same\"\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\n+                    \"NAME\": \"dbname\",\n+                    \"USER\": username,\n+                    \"PASSWORD\": password,\n+                    \"HOST\": \"somehost\",\n+                    \"PORT\": \"444\",\n+                }\n+            ),\n+            (\n+                [\"psql\", \"-U\", username, \"-h\", \"somehost\", \"-p\", \"444\", \"dbname\"],\n+                {\"PGPASSWORD\": password},\n+            ),\n+        )\n+\n+    def test_parameters(self):\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env({\"NAME\": \"dbname\"}, [\"--help\"]),\n+            ([\"psql\", \"dbname\", \"--help\"], None),\n+        )\n+\n+    def test_additional_options_before_dbname(self):\n+        \"\"\"\n+        Additional parameters are passed before the database name.\n+        \"\"\"\n+        self.assertEqual(\n+            self.settings_to_cmd_args_env(\n+                {\"NAME\": \"dbname\"}, [\"-c\", \"select * from some_table;\"]\n+            ),\n+            ([\"psql\", \"-c\", \"select * from some_table;\", \"dbname\"], None),\n+        )\n+\n+    @skipUnless(connection.vendor == \"postgresql\", \"Requires a PostgreSQL connection\")\n+    def test_sigint_handler(self):\n+        \"\"\"SIGINT is ignored in Python and passed to psql to abort queries.\"\"\"\n+\n+        def _mock_subprocess_run(*args, **kwargs):\n+            handler = signal.getsignal(signal.SIGINT)\n+            self.assertEqual(handler, signal.SIG_IGN)\n+\n+        sigint_handler = signal.getsignal(signal.SIGINT)\n+        # The default handler isn't SIG_IGN.\n+        self.assertNotEqual(sigint_handler, signal.SIG_IGN)\n+        with mock.patch(\"subprocess.run\", new=_mock_subprocess_run):\n+            connection.client.runshell([])\n+        # dbshell restores the original handler.\n+        self.assertEqual(sigint_handler, signal.getsignal(signal.SIGINT))\n+\n+    def test_crash_password_does_not_leak(self):\n+        # The password doesn't leak in an exception that results from a client\n+        # crash.\n+        args, env = self.settings_to_cmd_args_env({\"PASSWORD\": \"somepassword\"}, [])\n+        if env:\n+            env = {**os.environ, **env}\n+        fake_client = Path(__file__).with_name(\"fake_client.py\")\n+        args[0:1] = [sys.executable, str(fake_client)]\n+        with self.assertRaises(subprocess.CalledProcessError) as ctx:\n+            subprocess.run(args, check=True, env=env)\n+        self.assertNotIn(\"somepassword\", str(ctx.exception))\n"], "arch": "x86_64", "base_commit": "b4817d20b9e55df30be0b1b2ca8c8bb6d61aab07", "test_directives": ["dbshell.test_postgresql_dbshell"], "coverage_files": ["django/db/backends/postgresql/client.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/backends/postgresql/client\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 dbshell.test_postgresql_dbshell", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}