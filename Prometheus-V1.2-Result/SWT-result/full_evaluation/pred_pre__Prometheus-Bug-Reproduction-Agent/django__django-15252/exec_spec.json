{"instance_id": "django__django-15252", "repo": "django/django", "version": "4.1", "environment_setup_commit": "647480166bfe7532e8c471fef0146e3a17e6c0c9", "patch_list": ["diff --git a/tests/migrations/test_multidb_operations.py b/tests/migrations/test_multidb_operations.py\nnew file mode 100644\nindex 0000000000..173e89f53b\n--- /dev/null\n+++ b/tests/migrations/test_multidb_operations.py\n@@ -0,0 +1,189 @@\n+from django.db import connection, connections, migrations, models\n+from django.db.migrations.recorder import MigrationRecorder\n+from django.db.migrations.state import ProjectState\n+from django.test import override_settings\n+\n+from .test_base import OperationTestBase\n+\n+\n+class AgnosticRouter:\n+    \"\"\"\n+    A router that doesn't have an opinion regarding migrating.\n+    \"\"\"\n+    def allow_migrate(self, db, app_label, **hints):\n+        return None\n+\n+\n+class MigrateNothingRouter:\n+    \"\"\"\n+    A router that doesn't allow migrating.\n+    \"\"\"\n+    def allow_migrate(self, db, app_label, **hints):\n+        return False\n+\n+\n+class MigrateEverythingRouter:\n+    \"\"\"\n+    A router that always allows migrating.\n+    \"\"\"\n+    def allow_migrate(self, db, app_label, **hints):\n+        return True\n+\n+\n+class MigrateWhenFooRouter:\n+    \"\"\"\n+    A router that allows migrating depending on a hint.\n+    \"\"\"\n+    def allow_migrate(self, db, app_label, **hints):\n+        return hints.get('foo', False)\n+\n+\n+class AllowDefaultRouter:\n+    \"\"\"\n+    A router that only allows migrating on the 'default' database.\n+    \"\"\"\n+    def allow_migrate(self, db, app_label, **hints):\n+        return db == 'default'\n+\n+\n+class MultiDBOperationTests(OperationTestBase):\n+    databases = {'default', 'other'}\n+\n+    @override_settings(DATABASE_ROUTERS=[AllowDefaultRouter()])\n+    def test_recorder_honors_router(self):\n+        \"\"\"\n+        MigrationRecorder.ensure_schema() should honor database routers.\n+        \"\"\"\n+        recorder = MigrationRecorder(connections['other'])\n+        recorder.ensure_schema()\n+        self.assertTableNotExists(recorder.Migration._meta.db_table, using='other')\n+\n+    def _test_create_model(self, app_label, should_run):\n+        \"\"\"\n+        CreateModel honors multi-db settings.\n+        \"\"\"\n+        operation = migrations.CreateModel(\n+            \"Pony\",\n+            [(\"id\", models.AutoField(primary_key=True))],\n+        )\n+        # Test the state alteration\n+        project_state = ProjectState()\n+        new_state = project_state.clone()\n+        operation.state_forwards(app_label, new_state)\n+        # Test the database alteration\n+        self.assertTableNotExists(\"%s_pony\" % app_label)\n+        with connection.schema_editor() as editor:\n+            operation.database_forwards(app_label, editor, project_state, new_state)\n+        if should_run:\n+            self.assertTableExists(\"%s_pony\" % app_label)\n+        else:\n+            self.assertTableNotExists(\"%s_pony\" % app_label)\n+        # And test reversal\n+        with connection.schema_editor() as editor:\n+            operation.database_backwards(app_label, editor, new_state, project_state)\n+        self.assertTableNotExists(\"%s_pony\" % app_label)\n+\n+    @override_settings(DATABASE_ROUTERS=[AgnosticRouter()])\n+    def test_create_model(self):\n+        \"\"\"\n+        Test when router doesn't have an opinion (i.e. CreateModel should run).\n+        \"\"\"\n+        self._test_create_model(\"test_mltdb_crmo\", should_run=True)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])\n+    def test_create_model2(self):\n+        \"\"\"\n+        Test when router returns False (i.e. CreateModel shouldn't run).\n+        \"\"\"\n+        self._test_create_model(\"test_mltdb_crmo2\", should_run=False)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()])\n+    def test_create_model3(self):\n+        \"\"\"\n+        Test when router returns True (i.e. CreateModel should run).\n+        \"\"\"\n+        self._test_create_model(\"test_mltdb_crmo3\", should_run=True)\n+\n+    def test_create_model4(self):\n+        \"\"\"\n+        Test multiple routers.\n+        \"\"\"\n+        with override_settings(DATABASE_ROUTERS=[AgnosticRouter(), AgnosticRouter()]):\n+            self._test_create_model(\"test_mltdb_crmo4\", should_run=True)\n+        with override_settings(DATABASE_ROUTERS=[MigrateNothingRouter(), MigrateEverythingRouter()]):\n+            self._test_create_model(\"test_mltdb_crmo4\", should_run=False)\n+        with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter(), MigrateNothingRouter()]):\n+            self._test_create_model(\"test_mltdb_crmo4\", should_run=True)\n+\n+    def _test_run_sql(self, app_label, should_run, hints=None):\n+        with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):\n+            project_state = self.set_up_test_model(app_label)\n+\n+        sql = \"\"\"\n+        INSERT INTO {0}_pony (pink, weight) VALUES (1, 3.55);\n+        INSERT INTO {0}_pony (pink, weight) VALUES (3, 5.0);\n+        \"\"\".format(app_label)\n+\n+        operation = migrations.RunSQL(sql, hints=hints or {})\n+        # Test the state alteration does nothing\n+        new_state = project_state.clone()\n+        operation.state_forwards(app_label, new_state)\n+        self.assertEqual(new_state, project_state)\n+        # Test the database alteration\n+        self.assertEqual(project_state.apps.get_model(app_label, \"Pony\").objects.count(), 0)\n+        with connection.schema_editor() as editor:\n+            operation.database_forwards(app_label, editor, project_state, new_state)\n+        Pony = project_state.apps.get_model(app_label, \"Pony\")\n+        if should_run:\n+            self.assertEqual(Pony.objects.count(), 2)\n+        else:\n+            self.assertEqual(Pony.objects.count(), 0)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])\n+    def test_run_sql_migrate_nothing_router(self):\n+        self._test_run_sql(\"test_mltdb_runsql\", should_run=False)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])\n+    def test_run_sql_migrate_foo_router_without_hints(self):\n+        self._test_run_sql(\"test_mltdb_runsql2\", should_run=False)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])\n+    def test_run_sql_migrate_foo_router_with_hints(self):\n+        self._test_run_sql('test_mltdb_runsql3', should_run=True, hints={'foo': True})\n+\n+    def _test_run_python(self, app_label, should_run, hints=None):\n+        with override_settings(DATABASE_ROUTERS=[MigrateEverythingRouter()]):\n+            project_state = self.set_up_test_model(app_label)\n+\n+        # Create the operation\n+        def inner_method(models, schema_editor):\n+            Pony = models.get_model(app_label, \"Pony\")\n+            Pony.objects.create(pink=1, weight=3.55)\n+            Pony.objects.create(weight=5)\n+\n+        operation = migrations.RunPython(inner_method, hints=hints or {})\n+        # Test the state alteration does nothing\n+        new_state = project_state.clone()\n+        operation.state_forwards(app_label, new_state)\n+        self.assertEqual(new_state, project_state)\n+        # Test the database alteration\n+        self.assertEqual(project_state.apps.get_model(app_label, \"Pony\").objects.count(), 0)\n+        with connection.schema_editor() as editor:\n+            operation.database_forwards(app_label, editor, project_state, new_state)\n+        Pony = project_state.apps.get_model(app_label, \"Pony\")\n+        if should_run:\n+            self.assertEqual(Pony.objects.count(), 2)\n+        else:\n+            self.assertEqual(Pony.objects.count(), 0)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateNothingRouter()])\n+    def test_run_python_migrate_nothing_router(self):\n+        self._test_run_python(\"test_mltdb_runpython\", should_run=False)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])\n+    def test_run_python_migrate_foo_router_without_hints(self):\n+        self._test_run_python(\"test_mltdb_runpython2\", should_run=False)\n+\n+    @override_settings(DATABASE_ROUTERS=[MigrateWhenFooRouter()])\n+    def test_run_python_migrate_foo_router_with_hints(self):\n+        self._test_run_python('test_mltdb_runpython3', should_run=True, hints={'foo': True})\n"], "arch": "x86_64", "base_commit": "361bb8f786f112ee275be136795c0b1ecefff928", "test_directives": ["migrations.test_multidb_operations"], "coverage_files": ["django/db/migrations/executor.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/migrations/executor\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 migrations.test_multidb_operations", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.4.1\nargon2-cffi >= 16.1.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2\njinja2 >= 2.9.2\nnumpy\nPillow >= 6.2.0\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.0.0\nselenium\nsqlparse >= 0.2.2\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}