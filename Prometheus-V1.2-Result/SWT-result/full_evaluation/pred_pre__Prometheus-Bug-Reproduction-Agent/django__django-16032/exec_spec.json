{"instance_id": "django__django-16032", "repo": "django/django", "version": "4.2", "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5", "patch_list": ["diff --git a/tests/annotations/test_annotation_subquery.py b/tests/annotations/test_annotation_subquery.py\nnew file mode 100644\nindex 0000000000..0bfd862bf1\n--- /dev/null\n+++ b/tests/annotations/test_annotation_subquery.py\n@@ -0,0 +1,152 @@\n+import datetime\n+from decimal import Decimal\n+\n+from django.db.models import (\n+    Value,\n+)\n+from django.test import TestCase\n+\n+from .models import (\n+    Author,\n+    Book,\n+    Publisher,\n+    Store,\n+)\n+\n+\n+class AnnotationsTests(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.a1 = Author.objects.create(name=\"Adrian Holovaty\", age=34)\n+        cls.a2 = Author.objects.create(name=\"Jacob Kaplan-Moss\", age=35)\n+        cls.a3 = Author.objects.create(name=\"Brad Dayley\", age=45)\n+        cls.a4 = Author.objects.create(name=\"James Bennett\", age=29)\n+        cls.a5 = Author.objects.create(name=\"Jeffrey Forcier\", age=37)\n+        cls.a6 = Author.objects.create(name=\"Paul Bissex\", age=29)\n+        cls.a7 = Author.objects.create(name=\"Wesley J. Chun\", age=25)\n+        cls.a8 = Author.objects.create(name=\"Peter Norvig\", age=57)\n+        cls.a9 = Author.objects.create(name=\"Stuart Russell\", age=46)\n+        cls.a1.friends.add(cls.a2, cls.a4)\n+        cls.a2.friends.add(cls.a1, cls.a7)\n+        cls.a4.friends.add(cls.a1)\n+        cls.a5.friends.add(cls.a6, cls.a7)\n+        cls.a6.friends.add(cls.a5, cls.a7)\n+        cls.a7.friends.add(cls.a2, cls.a5, cls.a6)\n+        cls.a8.friends.add(cls.a9)\n+        cls.a9.friends.add(cls.a8)\n+\n+        cls.p1 = Publisher.objects.create(name=\"Apress\", num_awards=3)\n+        cls.p2 = Publisher.objects.create(name=\"Sams\", num_awards=1)\n+        cls.p3 = Publisher.objects.create(name=\"Prentice Hall\", num_awards=7)\n+        cls.p4 = Publisher.objects.create(name=\"Morgan Kaufmann\", num_awards=9)\n+        cls.p5 = Publisher.objects.create(name=\"Jonno's House of Books\", num_awards=0)\n+\n+        cls.b1 = Book.objects.create(\n+            isbn=\"159059725\",\n+            name=\"The Definitive Guide to Django: Web Development Done Right\",\n+            pages=447,\n+            rating=4.5,\n+            price=Decimal(\"30.00\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2007, 12, 6),\n+        )\n+        cls.b2 = Book.objects.create(\n+            isbn=\"067232959\",\n+            name=\"Sams Teach Yourself Django in 24 Hours\",\n+            pages=528,\n+            rating=3.0,\n+            price=Decimal(\"23.09\"),\n+            contact=cls.a3,\n+            publisher=cls.p2,\n+            pubdate=datetime.date(2008, 3, 3),\n+        )\n+        cls.b3 = Book.objects.create(\n+            isbn=\"159059996\",\n+            name=\"Practical Django Projects\",\n+            pages=300,\n+            rating=4.0,\n+            price=Decimal(\"29.69\"),\n+            contact=cls.a4,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2008, 6, 23),\n+        )\n+        cls.b4 = Book.objects.create(\n+            isbn=\"013235613\",\n+            name=\"Python Web Development with Django\",\n+            pages=350,\n+            rating=4.0,\n+            price=Decimal(\"29.69\"),\n+            contact=cls.a5,\n+            publisher=cls.p3,\n+            pubdate=datetime.date(2008, 11, 3),\n+        )\n+        cls.b5 = Book.objects.create(\n+            isbn=\"013790395\",\n+            name=\"Artificial Intelligence: A Modern Approach\",\n+            pages=1132,\n+            rating=4.0,\n+            price=Decimal(\"82.80\"),\n+            contact=cls.a8,\n+            publisher=cls.p3,\n+            pubdate=datetime.date(1995, 1, 15),\n+        )\n+        cls.b6 = Book.objects.create(\n+            isbn=\"155860191\",\n+            name=(\n+                \"Paradigms of Artificial Intelligence Programming: Case Studies in \"\n+                \"Common Lisp\"\n+            ),\n+            pages=946,\n+            rating=5.0,\n+            price=Decimal(\"75.00\"),\n+            contact=cls.a8,\n+            publisher=cls.p4,\n+            pubdate=datetime.date(1991, 10, 15),\n+        )\n+        cls.b1.authors.add(cls.a1, cls.a2)\n+        cls.b2.authors.add(cls.a3)\n+        cls.b3.authors.add(cls.a4)\n+        cls.b4.authors.add(cls.a5, cls.a6, cls.a7)\n+        cls.b5.authors.add(cls.a8, cls.a9)\n+        cls.b6.authors.add(cls.a8)\n+\n+        cls.s1 = Store.objects.create(\n+            name=\"Amazon.com\",\n+            original_opening=datetime.datetime(1994, 4, 23, 9, 17, 42),\n+            friday_night_closing=datetime.time(23, 59, 59),\n+        )\n+        cls.s2 = Store.objects.create(\n+            name=\"Books.com\",\n+            original_opening=datetime.datetime(2001, 3, 15, 11, 23, 37),\n+            friday_night_closing=datetime.time(23, 59, 59),\n+        )\n+        cls.s3 = Store.objects.create(\n+            name=\"Mamma and Pappa's Books\",\n+            original_opening=datetime.datetime(1945, 4, 25, 16, 24, 14),\n+            friday_night_closing=datetime.time(21, 30),\n+        )\n+        cls.s1.books.add(cls.b1, cls.b2, cls.b3, cls.b4, cls.b5, cls.b6)\n+        cls.s2.books.add(cls.b1, cls.b3, cls.b5, cls.b6)\n+        cls.s3.books.add(cls.b3, cls.b4, cls.b6)\n+\n+    def test_annotation_and_alias_filter_in_subquery(self):\n+        long_books_qs = (\n+            Book.objects.filter(\n+                pages__gt=400,\n+            )\n+            .annotate(book_annotate=Value(1))\n+            .alias(book_alias=Value(1))\n+        )\n+        publisher_books_qs = Publisher.objects.filter(book__in=long_books_qs).values(\n+            \"name\"\n+        )\n+        self.assertCountEqual(\n+            publisher_books_qs,\n+            [\n+                {\"name\": \"Apress\"},\n+                {\"name\": \"Sams\"},\n+                {\"name\": \"Prentice Hall\"},\n+                {\"name\": \"Morgan Kaufmann\"},\n+            ],\n+        )\n"], "arch": "x86_64", "base_commit": "0c3981eb5094419fe200eb46c71b5376a2266166", "test_directives": ["annotations.test_annotation_subquery"], "coverage_files": ["django/db/models/fields/related_lookups.py", "django/db/models/sql/query.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.9", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/db/models/fields/related_lookups\\.py|django/db/models/sql/query\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 annotations.test_annotation_subquery", "req_install_commands": ["conda create -n testbed python=3.9 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.6.0\nargon2-cffi >= 19.2.0\nbackports.zoneinfo; python_version < '3.9'\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npytz\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}