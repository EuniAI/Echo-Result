{"instance_id": "django__django-16527", "repo": "django/django", "version": "5.0", "environment_setup_commit": "4a72da71001f154ea60906a2f74898d32b7322a7", "patch_list": ["diff --git a/tests/admin_views/test_permissions.py b/tests/admin_views/test_permissions.py\nnew file mode 100644\nindex 0000000000..18438084d1\n--- /dev/null\n+++ b/tests/admin_views/test_permissions.py\n@@ -0,0 +1,65 @@\n+from django.contrib.auth import get_permission_codename\n+from django.contrib.auth.models import Permission, User\n+from django.contrib.contenttypes.models import ContentType\n+from django.test import TestCase, override_settings\n+from django.urls import reverse\n+\n+from .models import Person\n+\n+\n+def get_perm(model, codename):\n+    \"\"\"\n+    Return the Permission object for a given model and codename.\n+    \"\"\"\n+    return Permission.objects.get(\n+        content_type=ContentType.objects.get_for_model(model),\n+        codename=codename,\n+    )\n+\n+\n+@override_settings(\n+    ROOT_URLCONF=\"admin_views.urls\",\n+    TEMPLATES=[\n+        {\n+            \"BACKEND\": \"django.template.backends.django.DjangoTemplates\",\n+            \"APP_DIRS\": True,\n+            \"OPTIONS\": {\n+                \"context_processors\": [\n+                    \"django.template.context_processors.request\",\n+                    \"django.contrib.auth.context_processors.auth\",\n+                    \"django.contrib.messages.context_processors.messages\",\n+                ],\n+            },\n+        }\n+    ],\n+)\n+class AdminViewPermissionsTest(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        \"\"\"\n+        Set up a user with change permission but no add permission.\n+        \"\"\"\n+        cls.changeuser = User.objects.create_user(\n+            username=\"changeuser\", password=\"secret\", is_staff=True\n+        )\n+        # Grant change permission for Person model, which has save_as=True.\n+        cls.changeuser.user_permissions.add(\n+            get_perm(Person, get_permission_codename(\"change\", Person._meta))\n+        )\n+        cls.person = Person.objects.create(name=\"test person\")\n+\n+    def test_save_as_new_requires_add_permission(self):\n+        \"\"\"\n+        The \"Save as new\" button is not displayed if the user doesn't have\n+        add permission.\n+        \"\"\"\n+        self.client.force_login(self.changeuser)\n+        # The PersonAdmin has `save_as = True`, so the button would normally\n+        # be shown if permissions were not an issue.\n+        url = reverse(\"admin:admin_views_person_change\", args=(self.person.pk,))\n+        response = self.client.get(url)\n+\n+        self.assertEqual(response.status_code, 200)\n+        # This assertion fails because of the bug. \"Save as new\" is an add\n+        # operation, so it should not be available without add permission.\n+        self.assertFalse(response.context[\"show_save_as_new\"])\n"], "arch": "x86_64", "base_commit": "bd366ca2aeffa869b7dbc0b0aa01caea75e6dc31", "test_directives": ["admin_views.test_permissions"], "coverage_files": ["django/contrib/admin/templatetags/admin_modify.py"], "env_name": "testbed", "run_id": "full_evaluation", "patch_id": "pred_pre__Prometheus-Bug-Reproduction-Agent", "timeout": 1800, "rm_image": false, "force_rebuild": false, "exec_mode": "unit_test", "reproduction_script_name": null, "compute_coverage": true, "install": {"python": "3.11", "packages": "requirements.txt", "install": "python -m pip install -e ."}, "cache_level": "instance", "test_command": "python3 /root/trace.py --count -C coverage.cover --include-pattern '/testbed/(django/contrib/admin/templatetags/admin_modify\\.py)' ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 admin_views.test_permissions", "req_install_commands": ["conda create -n testbed python=3.11 -y", "cat <<'EOF_59812759871' > $HOME/requirements.txt\naiosmtpd\nasgiref >= 3.7.0\nargon2-cffi >= 19.2.0\nbcrypt\nblack\ndocutils\ngeoip2; python_version < '3.12'\njinja2 >= 2.11.0\nnumpy; python_version < '3.12'\nPillow >= 6.2.1; sys.platform != 'win32' or python_version < '3.12'\npylibmc; sys.platform != 'win32'\npymemcache >= 3.4.0\npywatchman; sys.platform != 'win32'\nPyYAML\nredis >= 3.4.0\nselenium >= 4.8.0\nsqlparse >= 0.3.1\ntblib >= 1.5.0\ntzdata\ncolorama; sys.platform == 'win32'\n\nEOF_59812759871", "conda activate testbed && python -m pip install -r $HOME/requirements.txt", "rm $HOME/requirements.txt"]}